<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¯ºäºšç‰Œå® ç‰©æœº</title>
<style>
    /* --- å…¨å±€å˜é‡ä¸åŸºç¡€æ ·å¼ --- */
    :root {
        --blue-base: #3b4652;    
        --blue-dark: #1e242b;    
        --blue-screen: #5c84a8;  
        --black-main: #0f1214;   
        --black-dark: #060709;   
        --text-color: #b5cadd;
        --highlight: #d1b55a;
        --danger: #d15a5a;
    }

    body {
        margin: 0; padding: 0;
        background-color: #0a0d11;
        background-image: radial-gradient(circle at 50% 50%, #161c23 0%, #000 100%);
        display: flex; justify-content: center; align-items: center;
        min-height: 100vh;
        font-family: 'Courier New', Courier, monospace;
        overflow: hidden; user-select: none;
    }

    /* --- æŒæœºå¤–å£³è®¾è®¡ --- */
    #device {
        width: 380px; height: 740px;
        background: linear-gradient(145deg, var(--blue-base), var(--blue-dark));
        border-radius: 190px 190px 160px 160px;
        box-shadow: 
            inset -15px -15px 30px rgba(0,0,0,0.6),
            inset 10px 10px 25px rgba(255,255,255,0.15),
            0 40px 80px rgba(0,0,0,0.9),
            0 0 25px rgba(92, 132, 168, 0.25);
        position: relative;
        display: flex; flex-direction: column; align-items: center;
        padding-top: 80px; box-sizing: border-box;
        border: 4px solid var(--black-main);
    }

    /* é¡¶éƒ¨è´è¶ç»“è£…é¥° */
    .bow-container {
        position: absolute; top: -15px; z-index: 10;
        width: 160px; height: 80px;
        filter: drop-shadow(0 10px 8px rgba(0,0,0,0.6));
    }

    /* å±å¹•è¾¹æ¡† */
    .screen-bezel {
        width: 310px; height: 320px;
        background: linear-gradient(135deg, #1b1e22 0%, #060709 100%);
        border-radius: 40px 40px 50px 50px;
        display: flex; justify-content: center; align-items: center;
        box-shadow: 
            inset 0 10px 25px rgba(0,0,0,1),
            0 5px 15px rgba(255,255,255,0.08),
            0 0 0 4px var(--black-dark);
        position: relative;
    }

    .brand {
        position: absolute; top: -25px;
        color: #111; font-size: 14px; font-weight: 900;
        letter-spacing: 3px; text-shadow: 1px 1px 0 rgba(255,255,255,0.1);
    }

    /* --- æ ¸å¿ƒå±å¹•åŒºåŸŸ --- */
    .screen {
        width: 260px; height: 260px;
        background-color: var(--black-dark);
        border: 3px solid #000;
        border-radius: 15px;
        position: relative; overflow: hidden;
        color: var(--blue-screen);
        box-shadow: inset 0 0 30px rgba(92, 132, 168, 0.15);
    }

    /* å±å¹•æ‰«æçº¿æ•ˆæœ */
    .screen::after {
        content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(rgba(92,132,168,0) 50%, rgba(92,132,168,0.05) 50%);
        background-size: 100% 4px; z-index: 5; pointer-events: none;
    }

    /* é¡¶éƒ¨çŠ¶æ€æ  */
    .status-bar {
        display: flex; justify-content: space-between;
        padding: 6px 10px; font-size: 11px; font-weight: bold;
        border-bottom: 1px dashed var(--blue-screen);
        background: rgba(92,132,168,0.1);
        position: relative; z-index: 6;
    }
    .status-item { display: flex; flex-direction: column; align-items: center; }
    .status-bar progress { width: 45px; height: 6px; appearance: none; margin-top: 4px; }
    progress::-webkit-progress-bar { background-color: #1a1a1a; border-radius: 3px; }
    progress::-webkit-progress-value { background-color: var(--blue-screen); border-radius: 3px; box-shadow: 0 0 6px var(--blue-screen); }
    .gold-text { color: var(--highlight); text-shadow: 0 0 4px rgba(209, 181, 90, 0.5); }

    /* --- åƒç´ ç”»æ˜¾ç¤ºåŒºåŸŸ --- */
    #canvas-container {
        width: 100%; height: 155px;
        position: relative;
        background-color: #dbe4eb; 
        background-image: 
            radial-gradient(#b8c6d1 20%, transparent 20%),
            radial-gradient(#b8c6d1 20%, transparent 20%);
        background-position: 0 0, 4px 4px;
        background-size: 8px 8px;
        display: flex; justify-content: center; align-items: flex-end; 
        padding-bottom: 2px; box-sizing: border-box;
        overflow: hidden;
        box-shadow: inset 0 0 30px rgba(20, 30, 40, 0.2);
    }

    .pixel-bg {
        position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none; z-index: 1;
        display: flex; justify-content: center; align-items: center;
    }
    .bg-text {
        font-family: 'Arial', sans-serif;
        font-size: 50px; color: rgba(255, 255, 255, 0.5); 
        font-weight: 900; letter-spacing: -2px;
        opacity: 0.6; margin-bottom: 20px;
    }

      /* è¯ºäºšåƒç´ ç”»å¸ƒ */
    #noah-canvas {
        position: relative; z-index: 5;
        width: 120px; height: 156px; 
        image-rendering: pixelated; 
        animation: breathe 2.5s infinite ease-in-out;
        margin-bottom: -5px; 
        filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.2));
    }
    @keyframes breathe {
        0%, 100% { transform: scale(1) translateY(0); }
        50% { transform: scale(1.02) translateY(-2px); }
    }
    
       /* æ¢é™©åŠ¨ç”»è¦†ç›–å±‚ */
    #adventure-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 8; display: none;
        flex-direction: column; justify-content: center; align-items: center;
        color: var(--blue-screen); font-size: 14px; font-weight: bold;
        padding-bottom: 25px; 
        box-sizing: border-box; 
    }
    .adventure-icon { font-size: 40px; margin-bottom: 10px; animation: float 2s infinite ease-in-out; }
    @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
    
    .walking-dots::after { content: '...'; animation: dots 1.5s infinite; }
    @keyframes dots { 0%{content:'.'} 33%{content:'..'} 66%{content:'...'} }

    /* --- å¯¹è¯æ¡†åŒºåŸŸ --- */
    .dialogue-box {
        position: absolute; bottom: 0; width: 100%; height: 70px;
        background: rgba(6, 7, 9, 0.96);
        border-top: 2px solid var(--blue-screen);
        padding: 8px; box-sizing: border-box;
        font-size: 12px; line-height: 1.4; font-weight: bold;
        text-shadow: 1px 1px 0 #000; color: var(--text-color);
        overflow-y: auto; z-index: 6; scrollbar-width: none;
    }
    .cursor { display: inline-block; width: 6px; height: 12px; background: var(--blue-screen); animation: blink 1s infinite; vertical-align: middle; margin-left: 2px;}
    @keyframes blink { 0%, 49% { opacity: 1; } 50%, 100% { opacity: 0; } }

    /* --- å¼¹çª—ä¸èœå• UI --- */
    .modal {
        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(6, 7, 9, 0.98); z-index: 30; padding: 10px; box-sizing: border-box;
    }
    .modal h3 { margin: 5px 0 10px 0; font-size: 14px; text-align: center; border-bottom: 2px solid var(--blue-screen); padding-bottom: 5px; color:#fff;}
    .menu-list { list-style: none; padding: 0; margin: 0; height: 170px; overflow-y: auto; scrollbar-width: none;}
    .menu-list li {
        padding: 8px 10px; border: 1px solid #222; margin-bottom: 6px;
        font-size: 11px; cursor: pointer; border-radius: 5px;
        background: #0a0c0e; transition: 0.2s; font-weight: bold; color: #ccc;
        display: flex; justify-content: space-between;
    }
    .menu-list li:hover { background: var(--blue-screen); color: #000; border-color: var(--blue-screen); transform: translateX(3px);}
    .close-btn { 
        position: absolute; bottom: 10px; left: 10%; width: 80%;
        background: transparent; color: var(--blue-screen); border: 1px dashed var(--blue-screen); 
        padding: 6px; cursor: pointer; border-radius: 8px; font-family: inherit; font-weight: bold; transition: 0.2s;
    }
    .close-btn:hover { background: var(--blue-screen); color: #000; }

    /* å…¨å±äº‹ä»¶å¼¹çª— */
    #event-modal {
        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(6, 7, 9, 0.98); color: var(--blue-screen); z-index: 20;
        padding: 15px; box-sizing: border-box;
        flex-direction: column; justify-content: center; align-items: center; text-align: center;
        border: 2px solid var(--blue-screen);
    }
    #event-text { font-size: 12px; margin-bottom: 20px; font-weight: bold; line-height: 1.6; text-shadow: 0 0 2px var(--blue-screen); color: #fff;}
    .event-btn { 
        background: var(--blue-dark); color: var(--text-color); border: 1px solid var(--blue-screen); 
        padding: 10px 15px; margin: 6px; font-family: inherit; cursor: pointer; 
        border-radius: 6px; font-weight: bold; width: 100%; font-size: 11px; transition: 0.2s;
    }
    .event-btn:hover { background: var(--blue-screen); color: #000; transform: scale(1.02);}
    /* å¤çµé˜ä¸“ç”¨æŒ‰é’® */
    .bank-btn {
        background: #1e242b; color: #d1b55a; border: 1px solid #5c84a8; width: 100%;
        padding: 8px 6px; margin-bottom: 6px; font-family: inherit; font-size: 11px; font-weight: bold;
        cursor: pointer; border-radius: 4px; transition: 0.2s; text-shadow: 1px 1px 0 #000;
    }
    .bank-btn:hover { background: #5c84a8; color: #000; transform: translateX(3px); text-shadow: none;}
    /* å¤å¤è¡£æ©±ç‰©å“æ ·å¼ */
    .wardrobe-item {
        background: #4a2e1b;
        border: 2px solid #8b5a2b;
        border-radius: 4px;
        padding: 8px 10px;
        color: #f5e6c4;
        font-size: 11px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: inset 0 0 8px rgba(0,0,0,0.6), 2px 2px 0 #0a0503;
        transition: 0.1s;
        text-shadow: 1px 1px 0 #000;
    }
    .wardrobe-item:hover {
        background: #5c3922;
        border-color: #a8733f;
        transform: translateX(3px) translateY(-1px);
        box-shadow: inset 0 0 8px rgba(0,0,0,0.6), 1px 3px 0 #0a0503;
    }
    .wardrobe-item.equipped {
        background: #2a3b2c;
        border-color: #4a6b4e;
        color: #a3c9a6;
    }
    /* --- å®ä½“æŒ‰é”®åŒºåŸŸ --- */
    .controls-area {
        margin-top: 45px; width: 320px;
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 15px; box-sizing: border-box;
    }

    /* åå­—æ–¹å‘é”® - ä¿®æ”¹ç‰ˆ (åŠ å¤§å°ºå¯¸) */
    /* å®¹å™¨ä» 110px æ”¹å¤§åˆ° 160px */
    .d-pad { position: relative; width: 160px; height: 160px; } 

    /* å•ä¸ªæŒ‰é”®ä» 35px æ”¹å¤§åˆ° 52pxï¼Œå­—ä½“ä¹Ÿç¨å¾®æ”¹å¤§ä¸€ç‚¹ç‚¹ */
    .d-btn {
        position: absolute; width: 52px; height: 52px;
        background: var(--black-main); border: none;
        box-shadow: inset 1px 1px 3px rgba(255,255,255,0.08), inset -2px -2px 5px rgba(0,0,0,0.8), 0 5px 10px rgba(0,0,0,0.6);
        color: var(--blue-screen); font-size: 12px; font-weight: bold; font-family: inherit;
        cursor: pointer; transition: 0.1s; display: flex; justify-content: center; align-items: center;
        text-align: center;
    }
    .d-btn:active { transform: translateY(2px); box-shadow: inset 2px 2px 5px rgba(0,0,0,0.9); }
    
    /* ä¸‹é¢çš„å®šä½æ•°å€¼å¿…é¡»æ”¹ï¼ä¸ç„¶æŒ‰é”®ä¼šæ­ªï¼(160-52)/2 = 54px */
    
    .d-up { top: 0; left: 54px; border-radius: 8px 8px 3px 3px; }
    
    .d-down { bottom: 0; left: 54px; border-radius: 3px 3px 8px 8px; }

    .d-left { left: 0; top: 54px; border-radius: 8px 3px 3px 8px; }

    .d-right { right: 0; top: 54px; border-radius: 3px 8px 8px 3px; }

    /* ä¸­é—´è£…é¥°å—ä¹Ÿè¦å¯¹åº”æ”¹å¤§å’Œé‡æ–°å®šä½ */
    .d-center {
        position: absolute; top: 54px; left: 54px; width: 52px; height: 52px;
        background: var(--black-main); border-radius: 3px;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.5); pointer-events: none;
    }
    .d-center::after {
        content: ''; width: 30px; height: 30px; background: #000; border-radius: 50%; display:block; margin: 11px; opacity: 0.5;
    }

    /* å³ä¾§åŠ¨ä½œé”® */
    .action-btns { display: flex; gap: 12px; transform: rotate(-15deg); }
    .a-btn {
        width: 50px; height: 50px; border-radius: 50%;
        background: var(--black-main); border: 2px solid #1a1a1a;
        box-shadow: inset 2px 2px 5px rgba(255,255,255,0.08), inset -2px -2px 6px rgba(0,0,0,0.8), 0 5px 10px rgba(0,0,0,0.5);
        color: var(--blue-screen); font-size: 12px; font-weight: bold; font-family: inherit;
        cursor: pointer; transition: 0.1s;
    }
    .a-btn:active { transform: scale(0.92); }
    .a-btn-label { position: absolute; bottom: -22px; font-size: 11px; color: #111; font-weight: bold; text-align: center; width: 100%;}

    .sys-btn {
        margin-top: 35px; width: 140px; height: 28px;
        background: var(--black-main); border-radius: 15px; border: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        color: #444; font-family: inherit; font-size: 10px; font-weight: bold; cursor: pointer;
    }
    .sys-btn:active { transform: translateY(2px); }

    /* æ‰‹æœºé€‚é… */
    @media screen and (max-width: 450px) {
        body { align-items: flex-start; padding-top: 5vh; }
        #device { transform: scale(0.85); transform-origin: top center; }
    }
    @media screen and (max-width: 360px) { #device { transform: scale(0.75); } }
        /* --- ç£å¸¦å¤å¤ UI (è“é»‘ä¸»é¢˜å¼ºåŒ–ç‰ˆ) --- */
    .cassette-tape {
        width: 220px; height: 160px; /* ç¨å¾®æ”¾å¤§å®¹çº³æŒ‰é”® */
        background: linear-gradient(180deg, #1e242b 0%, #0f1214 100%);
        border: 3px solid #3b4652; border-radius: 12px;
        position: relative; margin: 15px 0 20px 0;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.9), inset 0 4px 2px rgba(255,255,255,0.05), 0 10px 20px rgba(0,0,0,0.8);
        display: flex; flex-direction: column; align-items: center;
    }
    /* ç£å¸¦å››ä¸ªè§’çš„èºä¸é’‰ç»†èŠ‚ */
    .cassette-tape::before {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
        background: 
            radial-gradient(circle at 15px 15px, #060709 3px, #3b4652 4px, transparent 5px),
            radial-gradient(circle at 205px 15px, #060709 3px, #3b4652 4px, transparent 5px),
            radial-gradient(circle at 15px 145px, #060709 3px, #3b4652 4px, transparent 5px),
            radial-gradient(circle at 205px 145px, #060709 3px, #3b4652 4px, transparent 5px);
        z-index: 2;
    }
    .tape-top { width: 100%; height: 35px; border-bottom: 2px solid #1e242b; background: repeating-linear-gradient(90deg, #11151a, #11151a 10px, #1a1e24 10px, #1a1e24 20px); border-radius: 8px 8px 0 0; }
    .tape-label {
        width: 200px; height: 75px; background: linear-gradient(135deg, #2b3542 0%, #171d24 100%); margin-top: 10px; border-radius: 6px;
        border: 2px solid #5c84a8; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        box-shadow: inset 0 0 10px rgba(92, 132, 168, 0.3); padding-top: 5px; box-sizing: border-box;
    }
    .tape-window {
        width: 110px; height: 30px; background: #060709; border-radius: 15px; border: 2px solid #3b4652;
        display: flex; justify-content: space-between; align-items: center; padding: 0 15px; box-sizing: border-box; margin-top: 8px;
        box-shadow: inset 0 3px 10px rgba(0,0,0,1);
    }
    .tape-gear { width: 14px; height: 14px; background: #b5cadd; border-radius: 50%; border: 4px dashed #1a1e24; animation: spin 3s linear infinite; animation-play-state: paused;}
    .tape-gear.playing { animation-play-state: running; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    
    /* åº•éƒ¨ç£å¸¦è¯»å–æ§½è¿›åŒ–ä¸ºå†…åµŒæŒ‰é”®åŒº */
    .tape-bottom {
        position: absolute; bottom: 0; width: 160px; height: 35px; background: #0f1214; border: 2px solid #3b4652;
        border-bottom: none; border-radius: 8px 8px 0 0; clip-path: polygon(6% 0, 94% 0, 100% 100%, 0 100%);
        display: flex; justify-content: center; align-items: center; gap: 12px; padding-top: 4px; box-shadow: inset 0 5px 15px rgba(0,0,0,0.8); z-index: 5;
    }

    /* å†…ç½®åœ¨ç£å¸¦ä¸­çš„ç‰©ç†æŒ‰é”® */
    .tape-btn {
        width: 32px; height: 20px; background: #1e242b; border: 1px solid #5c84a8;
        display: flex; justify-content: center; align-items: center; cursor: pointer;
        box-shadow: inset 1px 1px 0 rgba(255,255,255,0.1), inset -1px -1px 0 rgba(0,0,0,0.6);
        border-radius: 3px; transition: 0.1s;
    }
    .tape-btn:active { transform: translateY(2px); box-shadow: inset 1px 1px 0 rgba(0,0,0,0.8); }

    /* é‡å†™åƒç´ å›¾æ ‡å°ºå¯¸ï¼Œå®Œç¾é€‚é…ç£å¸¦å†…ç½®æŒ‰é”® */
    .pixel-play { width: 0; height: 0; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-left: 8px solid #d1b55a; margin-left: 2px; }
    .pixel-pause { width: 8px; height: 10px; border-left: 3px solid #d1b55a; border-right: 3px solid #d1b55a; box-sizing: border-box; }
    .pixel-prev { width: 0; height: 0; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-right: 7px solid #b5cadd; border-left: 3px solid #b5cadd; }
    .pixel-next { width: 0; height: 0; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-left: 7px solid #b5cadd; border-right: 3px solid #b5cadd; }
/* æ‚„æ‚„è¯è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶çš„ç‰¹æ•ˆ */
#chat-input:focus {
    border-color: #5c84a8;
    box-shadow: 0 0 10px rgba(92, 132, 168, 0.4), inset 0 2px 5px rgba(0,0,0,0.8);
    color: #fff;
}
        /* --- ç»ˆæ Metaï¼šçœ¼æ³ªä¸æ“¦æ‹­å±å¹•ç‰¹æ•ˆ --- */
    #tears-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        /* ã€ä¿®æ”¹ç‚¹ã€‘ï¼šå¤§å¹…é™ä½äº†é»‘æš—åº¦å’Œæ¨¡ç³Šåº¦ï¼Œè®©ä½ èƒ½çœ‹æ¸…åº•ä¸‹çš„è¯ºäºš */
        background: rgba(10, 15, 20, 0.15); backdrop-filter: blur(2px); z-index: 9998;
        pointer-events: none; transition: backdrop-filter 2.5s, background 2.5s;
    }
    .tear-drop {
        position: absolute; width: 6px; height: 18px; 
        /* ã€ä¿®æ”¹ç‚¹ã€‘ï¼šç»™çœ¼æ³ªåŠ äº†åŠé€æ˜åå…‰å’Œæ°´æ»´æ‹–å°¾æ•ˆæœ */
        background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(255,255,255,0.8));
        border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
        box-shadow: 0 4px 6px rgba(255,255,255,0.4), inset 0 -2px 4px rgba(255,255,255,0.9); 
        animation: tearFall 2.5s cubic-bezier(0.4, 0, 1, 1) forwards;
    }
    @keyframes tearFall {
        0% { transform: translateY(-20px) scaleY(1); opacity: 0; }
        10% { opacity: 1; transform: translateY(10vh) scaleY(1.2); }
        50% { transform: translateY(50vh) scaleY(1.8); opacity: 0.8; }
        100% { transform: translateY(90vh) scaleY(2.5); opacity: 0; }
    }
    #wipe-hand {
        display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 140px; height: 140px; 
        /* ã€ä¿®æ”¹ç‚¹ã€‘ï¼šå»æ‰äº†é»„åœŸå—ï¼Œæ”¹ä¸ºæ¨¡æ‹Ÿç»ç’ƒå†…éƒ¨è¢«æ‰‹æŒ‡æŠ¹å¼€çš„æ°´æ±½æ„Ÿ */
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
        box-shadow: inset 0 0 20px rgba(255,255,255,0.2), 0 0 40px rgba(255,255,255,0.1);
        z-index: 9999; border-radius: 50%; filter: blur(4px);
        animation: wipeAction 3.5s ease-in-out forwards; pointer-events: none;
    }
    @keyframes wipeAction {
        0% { opacity: 0; transform: translate(-50%, 200px) scale(0.8); }
        15% { opacity: 1; transform: translate(-100px, 50px) scale(1); }
        35% { opacity: 1; transform: translate(100px, 0px) scale(1.1); }
        60% { opacity: 1; transform: translate(-80px, -50px) scale(1.2); }
        85% { opacity: 1; transform: translate(80px, -100px) scale(1); }
        100% { opacity: 0; transform: translate(-50%, 200px) scale(0.8); }
    }
    /* --- æ–°å¢ï¼šç„¦è™‘ç²‰ç¢æœºç‰¹æ•ˆ Meta UI --- */
    
    /* 1. å±å¹•æ•…éšœå¹²æ‰°å±‚ */
    .glitch-overlay {
        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.2); z-index: 50; pointer-events: none;
        animation: glitch-anim 0.2s infinite;
    }
    @keyframes glitch-anim {
        0% { transform: translate(0); }
        20% { transform: translate(-2px, 2px); }
        40% { transform: translate(-2px, -2px); }
        60% { transform: translate(2px, 2px); }
        80% { transform: translate(2px, -2px); }
        100% { transform: translate(0); }
    }

    /* 2. è¯ºäºšçš„â€œç»å¯¹é¢†åŸŸâ€ï¼šå±è”½å¤–ç•Œæ‚éŸ³ */
    #absolute-domain {
        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #060709; z-index: 60;
        flex-direction: column; justify-content: center; align-items: center;
        opacity: 0; transition: opacity 1.5s ease-in-out;
    }
    
    /* 3. æ ¸å¿ƒå¿ƒè·³å…‰ç‚¹ */
    .soul-light {
        width: 4px; height: 4px; background: #fff; border-radius: 50%;
        box-shadow: 0 0 20px 5px rgba(255, 255, 255, 0.8);
        animation: soul-beat 3s infinite ease-in-out;
        margin-bottom: 20px;
    }
    @keyframes soul-beat {
        0%, 100% { transform: scale(1); opacity: 0.5; box-shadow: 0 0 10px 2px rgba(92, 132, 168, 0.3); }
        50% { transform: scale(3); opacity: 1; box-shadow: 0 0 40px 10px rgba(209, 181, 90, 0.6); }
    }

    /* 4. æµ®ç°çš„æ–‡å­— */
    .domain-text {
        font-family: 'Courier New', monospace; font-size: 12px; font-weight: bold;
        color: #b5cadd; text-align: center; line-height: 1.8;
        max-width: 80%; text-shadow: 0 0 5px rgba(181, 202, 221, 0.3);
    }
    /* ================= ğŸ•°ï¸ é™ªä¼´æ‰‹è´¦ç³»ç»Ÿä¸“å± UI (å¤å¤å¯çˆ±é£) ================= */
    #accompany-modal {
        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #fdf6e3; /* å¥¶é»„å¤å¤ä¿¡çº¸åº•è‰² */
        border: 4px solid #d1b55a; border-radius: 8px;
        z-index: 35; padding: 12px; box-sizing: border-box;
        flex-direction: column; align-items: center;
        font-family: 'Courier New', monospace;
        box-shadow: inset 0 0 20px rgba(209, 181, 90, 0.4);
        overflow-y: auto; scrollbar-width: none;
    }
    .acc-title {
        font-size: 14px; font-weight: 900; color: #d15a5a;
        border-bottom: 2px dashed #d15a5a; padding-bottom: 5px; margin-bottom: 10px; 
        width: 100%; text-align: center; text-shadow: 1px 1px 0px rgba(209,90,90,0.2);
    }
    .acc-panel {
        background: #fff; border: 2px solid #5c84a8; border-radius: 6px;
        padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 8px;
        box-shadow: 2px 2px 0 #5c84a8;
    }
    .acc-label { font-size: 11px; color: #5c84a8; font-weight: bold; margin-bottom: 4px; display: block;}
    .acc-select, .acc-input {
        width: 100%; padding: 6px; border: 1px solid #d1b55a; border-radius: 4px;
        background: #fcf9f2; color: #3b4652; font-family: inherit; font-size: 11px; font-weight: bold;
        outline: none; margin-bottom: 8px; box-sizing: border-box;
    }
    .acc-btn {
        background: #d15a5a; color: #fff; border: 2px solid #1a1a1a;
        padding: 8px; font-family: inherit; font-weight: bold; font-size: 11px;
        border-radius: 6px; cursor: pointer; box-shadow: 2px 2px 0 #1a1a1a;
        transition: 0.1s; width: 100%; margin-top: 2px;
    }
    .acc-btn:active { transform: translate(2px, 2px); box-shadow: 0 0 0 #1a1a1a; }
    
    .acc-log-container {
        width: 100%; flex: 1; background: #fff; border: 2px solid #d1b55a; border-radius: 6px;
        padding: 8px; box-sizing: border-box; overflow-y: auto; scrollbar-width: none;
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); text-align: left;
    }
    .acc-log-item {
        border-bottom: 1px dashed #e8d2c3; padding: 6px 0; font-size: 10px; color: #3b4652; line-height: 1.4;
    }
    .acc-log-item:last-child { border-bottom: none; }
    .acc-log-date { color: #d15a5a; font-weight: bold; }
    .acc-log-event { color: #5c84a8; font-weight: bold; background: #eef4f9; padding: 0 4px; border-radius: 3px;}
    
    /* ä¸“æ³¨é™ªä¼´å…¨å±å€’è®¡æ—¶ */
    #focus-overlay {
        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(10, 13, 17, 0.96); z-index: 50; flex-direction: column;
        justify-content: center; align-items: center; backdrop-filter: blur(4px);
    }
    .focus-timer { 
        font-size: 40px; font-weight: bold; color: #d1b55a; 
        text-shadow: 0 0 20px rgba(209,181,90,0.6); margin-bottom: 15px; font-family: 'Courier New', monospace;
    }
    .focus-text { font-size: 12px; color: #b5cadd; font-weight: bold; text-align: center; line-height: 1.6; padding: 0 20px;}
    /* --- ğŸ“– æ–°å¢ï¼šç²¾ç¾æ—¥å†æ‰‹è´¦æœ¬ä¸“å±æ ·å¼ --- */
    #diary-modal {
        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(6, 7, 9, 0.95); z-index: 50;
        flex-direction: column; align-items: center; justify-content: center;
        backdrop-filter: blur(5px);
    }
    
    .diary-book {
        width: 340px; height: 500px;
        background: #fffdf2; /* å¤å¤çº¸å¼ å¥¶é»„è‰² */
        border-radius: 10px;
        box-shadow: 
            inset 0 0 40px rgba(139, 90, 43, 0.2), /* çº¸å¼ é™ˆæ—§æ„Ÿ */
            0 10px 30px rgba(0,0,0,0.8),
            0 0 0 5px #5c4033; /* çš®é©å°çš®è¾¹æ¡† */
        position: relative;
        display: flex; flex-direction: column;
        overflow: hidden;
    }

    /* ç¬”è®°æœ¬çš„è£…è®¢çº¿åœˆè£…é¥° */
    .diary-binder {
        position: absolute; top: 0; left: 20px; width: 4px; height: 100%;
        border-right: 2px dashed #e8d2c3; z-index: 2;
        pointer-events: none;
    }

    .diary-header {
        padding: 20px 0 10px 0; text-align: center;
        border-bottom: 2px solid #d15a5a;
        background-image: radial-gradient(#d15a5a 15%, transparent 16%);
        background-size: 10px 10px;
        margin: 0 15px;
    }
    
    .diary-title {
        background: #fffdf2; padding: 0 10px; font-size: 16px; font-weight: 900; 
        color: #5c4033; letter-spacing: 2px; text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
        border: 2px solid #5c4033; border-radius: 4px; display: inline-block;
    }

    .diary-content {
        flex: 1; overflow-y: auto; scrollbar-width: none;
        padding: 15px 25px 15px 35px; /* å·¦ä¾§ç•™å‡ºè£…è®¢çº¿ä½ç½® */
        /* ä¿¡çº¸æ¨ªçº¿æ•ˆæœ */
        background-image: linear-gradient(#e8d2c3 1px, transparent 1px);
        background-size: 100% 30px; /* è¡Œé«˜ */
        line-height: 30px;
    }

    /* å•æ¡æ—¥è®°ï¼šæ—¥å†å¡ç‰‡æ ·å¼ */
    .diary-entry {
        display: flex; margin-bottom: 25px; position: relative;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 8px; padding: 5px;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
        border: 1px solid #e8d2c3;
    }
    
    /* å·¦ä¾§æ—¥å†å›¾æ ‡ */
    .diary-date-box {
        width: 50px; height: 55px; background: #fff;
        border: 2px solid #3b4652; border-radius: 6px;
        margin-right: 12px; flex-shrink: 0;
        display: flex; flex-direction: column; overflow: hidden;
        box-shadow: 2px 2px 0 #3b4652;
    }
    .diary-month {
        background: #d15a5a; color: #fff; font-size: 9px; font-weight: bold;
        text-align: center; padding: 2px 0;
    }
    .diary-day {
        flex: 1; display: flex; align-items: center; justify-content: center;
        font-size: 20px; font-weight: 900; color: #3b4652;
    }

    /* å³ä¾§æ–‡å­—å†…å®¹ */
    .diary-text {
        font-size: 11px; color: #5c4033; font-weight: bold; line-height: 1.6;
        padding-top: 4px;
    }
    .diary-reply {
        font-size: 10px; color: #5c84a8; margin-top: 5px; 
        font-style: italic; background: rgba(92, 132, 168, 0.1); 
        padding: 2px 5px; border-radius: 4px;
    }

    .diary-close-btn {
        margin: 10px 20px 20px 20px; padding: 10px;
        background: #5c4033; color: #fffdf2; border: 2px dashed #bba58e;
        font-family: inherit; font-weight: bold; cursor: pointer; border-radius: 6px;
        transition: 0.2s; box-shadow: 0 5px 10px rgba(0,0,0,0.2);
    }
    .diary-close-btn:hover { transform: translateY(-2px); background: #3e2b22; }
/* --- ä¸“æ³¨æ¨¡å¼æ–°çš®è‚¤ --- */
#focus-overlay {
    /* ä¿®å¤å±‚çº§é—®é¢˜ï¼Œç¡®ä¿ç‚¹å¾—åŠ¨ */
    z-index: 9999 !important; 
    background: rgba(10, 13, 17, 0.98);
    display: none; /* é»˜è®¤éšè— */
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

/* åƒç´ è¯ºäºšåœºæ™¯ */
.focus-scene {
    position: relative;
    margin-bottom: 20px;
    animation: float 3s infinite ease-in-out;
}

#focus-canvas {
    width: 130px; 
    height: 130px; 
    image-rendering: pixelated;
    filter: drop-shadow(0 0 10px rgba(92, 132, 168, 0.4));
}

/* åƒç´ æ°”æ³¡å¯¹è¯æ¡† */
.focus-bubble {
    position: absolute;
    top: -40px; right: -60px;
    background: #fff;
    color: #000;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: bold;
    font-family: 'Courier New', monospace;
    border: 2px solid #000;
    box-shadow: 4px 4px 0 rgba(0,0,0,0.5);
    max-width: 120px;
    animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.focus-bubble::after {
    content: ''; position: absolute; bottom: -8px; left: 15px;
    border-width: 8px 8px 0; border-style: solid;
    border-color: #000 transparent transparent transparent;
}
.focus-bubble::before {
    content: ''; position: absolute; bottom: -4px; left: 17px;
    border-width: 6px 6px 0; border-style: solid;
    border-color: #fff transparent transparent transparent;
    z-index: 1;
}

/* å¤å¤è®¡æ—¶å¡ç‰‡ */
.focus-card {
    background: #1e242b;
    border: 3px solid #5c84a8;
    border-radius: 10px;
    padding: 20px;
    width: 280px;
    text-align: center;
    box-shadow: 
        inset 0 0 20px rgba(0,0,0,0.5),
        0 0 0 4px #0f1214,
        0 10px 20px rgba(0,0,0,0.8);
}

.focus-label {
    color: #5c84a8; font-size: 12px; font-weight: bold; letter-spacing: 2px; margin-bottom: 5px;
}

.focus-timer {
    font-size: 48px; font-weight: 900; color: #d1b55a;
    text-shadow: 2px 2px 0 #000;
    font-family: 'Courier New', monospace;
    margin: 10px 0;
}

.focus-progress-bg {
    width: 100%; height: 8px; background: #0f1214;
    border: 1px solid #5c84a8; border-radius: 4px; margin-bottom: 15px; overflow: hidden;
}

.focus-progress-fill {
    width: 100%; height: 100%; background: #d1b55a;
    transition: width 1s linear;
}

.focus-tips {
    font-size: 11px; color: #b5cadd; margin-bottom: 20px; line-height: 1.5; min-height: 32px;
}

.focus-btn-quit {
    background: transparent; border: 2px dashed #d15a5a;
    color: #d15a5a; padding: 8px 15px; font-size: 11px; font-weight: bold;
    cursor: pointer; border-radius: 6px; transition: 0.2s; width: 100%;
}
.focus-btn-quit:hover {
    background: #d15a5a; color: #fff; transform: scale(1.02);
}

@keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
/* --- ä¿®å¤è¡¥ä¸ï¼šå¼ºåˆ¶è¦†ç›–ä¸“æ³¨æ¨¡å¼æ ·å¼ --- */
#focus-overlay {
    /* å¼ºåˆ¶æœ€é«˜å±‚çº§ï¼Œç¡®ä¿æŒ‰é’®èƒ½ç‚¹åˆ°ï¼Œä¸”ç›–ä½æ‰€æœ‰å…¶ä»–ç•Œé¢ */
    z-index: 10000 !important; 
    background: rgba(10, 13, 17, 0.98);
    display: none; 
    flex-direction: column;
    justify-content: center;
    align-items: center;
    /* ç¡®ä¿å æ»¡å±å¹• */
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
}

.focus-scene {
    position: relative;
    margin-bottom: 30px; /* å¢åŠ é—´è·ï¼Œé˜²æ­¢æ°”æ³¡è¢«åˆ‡ */
    /* ç§»é™¤å¯èƒ½å¯¼è‡´æ¨¡ç³Šçš„åŠ¨ç”»ï¼Œæ”¹ç”¨ç®€å•çš„æµ®åŠ¨ */
    animation: float 3s infinite ease-in-out;
    /* ç¡®ä¿å±‚çº§æ­£ç¡® */
    z-index: 10001;
}

/* ä¿®å¤æ°”æ³¡ä½ç½® */
.focus-bubble {
    position: absolute;
    /* è°ƒæ•´ä½ç½®ï¼Œç¡®ä¿ä¸è·‘å‡ºå±å¹• */
    top: -30px; 
    right: -70px;
    background: #fff;
    color: #000;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: bold;
    font-family: 'Courier New', monospace;
    border: 2px solid #000;
    box-shadow: 4px 4px 0 rgba(0,0,0,0.5);
    width: 100px; /* å›ºå®šå®½åº¦é˜²æ­¢æŒ¤å‹ */
    text-align: center;
    z-index: 10002;
}

/* ä¿®å¤æŒ‰é’®æ ·å¼ï¼Œç¡®ä¿é†’ç›®å¯è§ */
.focus-btn-quit {
    margin-top: 15px; /* å¢åŠ é¡¶éƒ¨é—´è· */
    background: rgba(209, 90, 90, 0.1); 
    border: 2px solid #d15a5a;
    color: #d15a5a; 
    padding: 12px 20px; 
    font-size: 12px; 
    font-weight: bold;
    cursor: pointer; 
    border-radius: 8px; 
    transition: 0.2s; 
    width: 80%; /* æŒ‰é’®å®½ä¸€ç‚¹ */
    font-family: 'Courier New', monospace;
    z-index: 10002; /* ç¡®ä¿èƒ½ç‚¹åˆ° */
}
.focus-btn-quit:hover {
    background: #d15a5a; 
    color: #fff; 
}
/* ======================================================== */
/* --- ä¿®å¤è¡¥ä¸ï¼šè®©æ—§çš„æ—¥å†æ‰‹è´¦æœ¬ä¹Ÿèƒ½è‡ªé€‚åº”å±å¹•ä¸è¢«åˆ‡æ–­ --- */
/* ======================================================== */
.diary-book {
    width: 90% !important; max-width: 340px; 
    height: 85vh !important; max-height: 500px;
}

/* ======================================================== */
/* --- ç©å®¶æ—¥è®°æœ¬ä¸“å±æ ·å¼ (å¤å¤å¯çˆ±åƒç´ æ–¹æ ¼çº¸ç‰ˆ) --- */
/* ======================================================== */
#player-diary-modal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 10000; /* è°ƒé«˜å±‚çº§é˜²é®æŒ¡ */
    flex-direction: column; align-items: center; justify-content: center;
    backdrop-filter: blur(5px); padding: 20px; box-sizing: border-box;
}

.pixel-diary-book {
    width: 100%; max-width: 340px;
    height: 85vh; max-height: 580px; /* æ ¸å¿ƒä¿®å¤ï¼šæŒ‰å±å¹•æ¯”ä¾‹é«˜åº¦ï¼Œç»ä¸è¶…å± */
    background: #fff9e6; /* æš–ç²‰çº¸å¼ åº•è‰² */
    position: relative; display: flex; flex-direction: column;
    /* åƒç´ é£ç²—è¾¹æ¡†æ²‰é™é˜´å½± */
    box-shadow: inset -4px -4px 0px rgba(0,0,0,0.05), 0 0 0 4px #5c4033, 0 10px 0 #3a251c;
    border-radius: 2px;
}

/* åƒç´ é£çº¢é»‘ç›¸é—´ç¼åˆçº¿ */
.pixel-diary-binder {
    position: absolute; top: 0; left: 15px; width: 6px; height: 100%;
    background: repeating-linear-gradient(to bottom, #d15a5a 0, #d15a5a 8px, transparent 8px, transparent 16px);
    z-index: 2; border-right: 2px solid #5c4033; border-left: 2px solid #5c4033;
}

.pixel-diary-header {
    padding: 15px 10px 10px 30px; text-align: center;
    border-bottom: 4px solid #5c4033; background: #ffd1a4;
}

#player-diary-title {
    font-size: 16px; font-weight: 900; color: #5c4033; letter-spacing: 1px;
    font-family: 'Courier New', monospace; text-shadow: 2px 2px 0 #fff;
}

/* æ—¥è®°åˆ—è¡¨ï¼šè‡ªé€‚åº”æ»šåŠ¨ + å¯çˆ±çº¢æ ¼çº¸åº•çº¹ */
#player-diary-list {
    flex: 1; overflow-y: auto; scrollbar-width: none;
    padding: 15px 15px 15px 35px;
    background-image: 
        linear-gradient(rgba(209, 90, 90, 0.15) 1px, transparent 1px),
        linear-gradient(90deg, rgba(209, 90, 90, 0.15) 1px, transparent 1px);
    background-size: 20px 20px;
}

/* åº•éƒ¨è¾“å…¥åŒºåŸŸ - ä¿®æ­£ç‰ˆ */
.pixel-diary-footer {
    /* å¼ºåˆ¶å®½åº¦ 100%ï¼Œç»ä¸è¶…æ ‡ */
    width: 100%; 
    height: 130px; 
    background: #ffd1a4; 
    border-top: 4px solid #5c4033;
    /* padding-left 30px æ˜¯ä¸ºäº†é¿å¼€å·¦è¾¹çš„è£…è®¢çº¿ */
    padding: 10px 10px 10px 30px; 
    /* æ ¸å¿ƒï¼šæŠŠ padding ç®—åœ¨å®½åº¦å†…ï¼Œé˜²æ­¢æ’‘çˆ† */
    box-sizing: border-box; 
    display: flex; 
    flex-direction: column; 
    gap: 8px;
    /* ç¡®ä¿æ²¡æœ‰é¢å¤–çš„ margin æ£ä¹± */
    margin: 0; 
    position: relative;
    z-index: 5;
}

/* è¾“å…¥æ¡† - ä¿®æ­£ç‰ˆ */
#diary-input {
    flex: 1; 
    width: 100%; 
    border: 2px solid #5c4033;
    padding: 8px; 
    font-family: 'Comic Sans MS', 'å¹¼åœ†', 'Microsoft YaHei', sans-serif; 
    font-size: 12px;
    resize: none; 
    outline: none; 
    background: #fff9e6; 
    color: #5c4033; 
    font-weight: bold;
    box-shadow: inset 2px 2px 0 rgba(0,0,0,0.1); 
    border-radius: 0;
    /* !!! è¿™ä¸€å¥æ˜¯ä¿®å¤æº¢å‡ºçš„å…³é”® !!! */
    box-sizing: border-box; 
}/* åƒç´ æ„Ÿæ“ä½œæŒ‰é’® */
.pixel-btn-save {
    flex: 2; background: #d15a5a; color: #fff; border: 2px solid #5c4033;
    padding: 6px; font-weight: bold; cursor: pointer; font-size: 12px;
    box-shadow: 2px 2px 0 #5c4033; transition: 0.1s;
}
.pixel-btn-save:active { transform: translate(2px, 2px); box-shadow: 0 0 0 #5c4033; }

.pixel-btn-close {
    flex: 1; background: #fff; color: #5c4033; border: 2px solid #5c4033;
    padding: 6px; font-weight: bold; cursor: pointer; font-size: 12px;
    box-shadow: 2px 2px 0 #5c4033; transition: 0.1s;
}
.pixel-btn-close:active { transform: translate(2px, 2px); box-shadow: 0 0 0 #5c4033; }

/* æ¯ä¸€æ¡æ—¥è®°çš„å¡ç‰‡æ•ˆæœ */
.p-diary-entry {
    margin-bottom: 15px; position: relative;
    background: rgba(255,255,255,0.9); border: 2px solid #5c4033;
    padding: 8px; border-radius: 4px; box-shadow: 2px 2px 0 rgba(92, 64, 51, 0.2);
}

.p-diary-date {
    font-size: 10px; color: #fff; background: #5c4033;
    padding: 2px 6px; display: inline-block; margin-bottom: 5px; font-family: 'Courier New', monospace;
}

.p-diary-content {
    font-size: 13px; color: #3a251c; font-weight: bold;
    word-wrap: break-word; white-space: pre-wrap; line-height: 1.6;
    font-family: 'Comic Sans MS', 'å¹¼åœ†', 'Microsoft YaHei', sans-serif;
}

/* è¯ºäºšçº¢ç¬”æ‰¹æ³¨ï¼šå€¾æ–œ+ç‹‚å‚²çš„æ‰‹å†™è´¨æ„Ÿ */
.noah-annotation {
    margin-top: 8px; font-family: 'Times New Roman', serif;
    font-size: 13px; color: #d15a5a; font-weight: bold; font-style: italic;
    background: rgba(209, 90, 90, 0.08); padding: 6px 10px;
    border-left: 4px solid #d15a5a; position: relative;
    transform: rotate(-1.5deg); text-shadow: 0.5px 0.5px 0 rgba(209, 90, 90, 0.15);
}
.noah-annotation::before {
    content: 'â˜… Noah:'; font-size: 10px; opacity: 0.8; display: block; margin-bottom: 3px; font-style: normal; text-transform: uppercase;
}
/* ================= ğŸ¡ æƒŠå–œç›²ç›’è½¬ç›˜ ä¸“å±æ ·å¼ ================= */
#gacha-modal {
    display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #2a1b2e; border: 4px solid #1a0f1a; z-index: 45; 
    padding: 10px; box-sizing: border-box; flex-direction: column; align-items: center; 
    font-family: 'Courier New', monospace; box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
    /* ğŸ‘‡ åŠ ä¸Šè¿™ä¸¤å¥ï¼Œå…è®¸ç•Œé¢å¾€ä¸‹æ»‘åŠ¨ï¼Œå¹¶éšè—ä¸‘é™‹çš„æ»šåŠ¨æ¡ */
    overflow-y: auto; scrollbar-width: none;
}
.gacha-machine {
    width: 90%; height: 120px; background: #e8c37d; border: 3px solid #5c4033;
    border-radius: 8px; margin-top: 15px; position: relative;
    box-shadow: inset -4px -4px 0 rgba(0,0,0,0.2), 0 5px 10px rgba(0,0,0,0.5);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.gacha-screen {
    width: 80%; height: 50px; background: #060709; border: 2px inset #5c4033;
    color: #d1b55a; display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: bold; overflow: hidden; position: relative; text-shadow: 1px 1px 0 #000;
}
.gacha-btn {
    background: #d15a5a; color: #fff; border: 2px solid #5c4033; padding: 10px 20px;
    font-family: inherit; font-size: 12px; font-weight: bold; cursor: pointer; width: 80%;
    box-shadow: 0 4px 0 #5c4033; border-radius: 4px; margin-top: 15px; transition: 0.1s;
}
.gacha-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #5c4033; }
.gacha-result { 
    font-size: 11px; color: #f5e6c4; margin-top: 15px; text-align: left; 
    line-height: 1.5; font-weight: bold; padding: 10px; background: rgba(0,0,0,0.4); 
    border-radius: 6px; width: 90%; box-sizing: border-box; border: 1px dashed #5c4033;
}
/* ================= ğŸ“… è¯ºäºšå¤å¤æ‰‹è´¦æ—¥å†ä¸“å±æ ·å¼ ================= */
#calendar-modal {
    display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(10, 15, 20, 0.95); z-index: 55;
    flex-direction: column; align-items: center; 
    /* ğŸ‘‡å…³é”®ä¿®å¤1ï¼šæ”¹é ä¸Šå¯¹é½ï¼Œå¼€å¯æ»‘åŠ¨ï¼Œéšè—ä¸‘é™‹æ»šåŠ¨æ¡ */
    justify-content: flex-start; overflow-y: auto; scrollbar-width: none;
    backdrop-filter: blur(5px); padding: 25px 15px; box-sizing: border-box;
}.calendar-book {
    width: 100%; max-width: 340px;  height: auto; min-height: 85vh;
    background: #fffdf2; border-radius: 8px;
    box-shadow: inset 0 0 20px rgba(139, 90, 43, 0.15), 0 0 0 4px #5c4033, 0 8px 15px rgba(0,0,0,0.8);
    display: flex; flex-direction: column; padding: 12px; box-sizing: border-box;
}
.cal-header {
    display: flex; justify-content: space-between; align-items: center;
    background: #d15a5a; color: #fff; padding: 8px; border: 2px solid #5c4033;
    font-weight: 900; margin-bottom: 10px; font-family: 'Courier New', monospace; font-size: 14px;
    box-shadow: 2px 2px 0 #5c4033;
}
.cal-btn {
    background: #f5e6c4; color: #5c4033; border: 2px solid #5c4033; 
    cursor: pointer; font-weight: bold; padding: 2px 8px; box-shadow: 1px 1px 0 #5c4033; transition: 0.1s;
}
.cal-btn:active { transform: translate(1px,1px); box-shadow: 0 0 0 #5c4033; }
.cal-grid {
    display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center;
flex-shrink: 0;
}
.cal-day-name {
    background: #e8c37d; color: #5c4033; font-size: 11px; font-weight: bold; padding: 4px 0; border: 1px solid #5c4033;
}
.cal-cell {
    background: #fff; border: 1px solid #e8d2c3; height: 38px; display: flex; flex-direction: column; 
    align-items: center; justify-content: flex-start; cursor: pointer; font-size: 12px; font-weight: bold; 
    color: #5c4033; transition: 0.1s; position: relative; padding-top: 2px;
flex-shrink: 0; min-height: 38px; box-sizing: border-box;
}
.cal-cell:hover { background: #fceceb; border-color: #d15a5a; }
.cal-cell.selected { background: #ffd1a4; border: 2px solid #d15a5a; }
.cal-cell.today { background: #eef4f9; border: 2px solid #5c84a8; color: #5c84a8; }
.cal-cell.has-event::after { content: 'â˜…'; color: #d1b55a; font-size: 10px; position: absolute; bottom: 2px; text-shadow: 0.5px 0.5px 0 #000; }
.cal-cell.is-period::before { content: 'â¤'; color: #d15a5a; font-size: 10px; position: absolute; top: 2px; right: 2px; animation: heartbeat 1.5s infinite; }
@keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }

.cal-details {
    flex: 1; margin-top: 10px; border: 2px dashed #d1b55a; padding: 10px; overflow-y: auto; scrollbar-width: none; background: rgba(255,255,255,0.7); border-radius: 4px;
}
.cal-footer {
    margin-top: 10px; display: flex; flex-direction: column; gap: 6px;
}
.cal-input-row { display: flex; gap: 5px; }
.cal-input { 
    flex: 1; border: 2px solid #5c4033; padding: 6px; font-size: 11px; outline: none; background: #fff9e6; 
    color: #5c4033; font-weight: bold; font-family: inherit;
}
    /* === ğŸŒŸ æ˜Ÿç©ºæ”¶é›†æ¸¸æˆä¸“å±æ ·å¼ === */
    #star-game-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(to bottom, rgba(15, 25, 45, 0.95), rgba(30, 20, 35, 0.85));
        z-index: 14; display: none; overflow: hidden;
    }
    .happy-star {
        position: absolute; font-size: 22px; cursor: pointer; user-select: none;
        animation: fall linear infinite; text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        transition: transform 0.1s ease-out, opacity 0.1s;
        /* å¢åŠ è§¦æ‘¸åŒºåŸŸï¼Œæ›´å®¹æ˜“æˆ³ä¸­ */
        padding: 10px; margin: -10px; 
    }
    .happy-star:active { transform: scale(1.6); }
    @keyframes fall {
        0% { transform: translateY(-40px) rotate(0deg); opacity: 0; }
        10% { opacity: 1; }
        85% { opacity: 1; }
        100% { transform: translateY(180px) rotate(360deg); opacity: 0; }
    }
    .star-score-board {
        position: absolute; top: 8px; right: 10px; color: #fff;
        font-size: 11px; font-weight: bold; text-shadow: 1px 1px 0 #000; z-index: 15;
    }
    .star-exit-btn {
        position: absolute; top: 8px; left: 10px; background: transparent;
        color: #d1b55a; border: 1px dashed #d1b55a; padding: 4px 8px; font-size: 10px;
        border-radius: 4px; cursor: pointer; z-index: 15; font-weight: bold; transition: 0.2s;
    }
    .star-exit-btn:active { background: #d1b55a; color: #000; }
</style>
</head>
<body>

<div id="device">
    <svg class="bow-container" viewBox="0 0 200 100">
        <defs>
            <linearGradient id="bowGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="#2a2a2a" />
                <stop offset="50%" stop-color="#111111" />
                <stop offset="100%" stop-color="#050505" />
            </linearGradient>
            <filter id="shadow">
                <feDropShadow dx="0" dy="5" stdDeviation="3" flood-opacity="0.8"/>
            </filter>
        </defs>
        <path d="M100,50 C60,15 15,5 5,40 C-5,75 30,95 100,50" fill="url(#bowGrad)" filter="url(#shadow)"/>
        <path d="M100,50 C140,15 185,5 195,40 C205,75 170,95 100,50" fill="url(#bowGrad)" filter="url(#shadow)"/>
        <rect x="85" y="35" width="30" height="30" rx="8" fill="url(#bowGrad)" filter="url(#shadow)" stroke="#333" stroke-width="1.5"/>
    </svg>

    <div class="screen-bezel">
        <div class="brand">NOAHÂ·CYDRIAN</div>
        
        <div class="screen">
            <div class="status-bar">
                <div class="status-item" id="lv-text">Lv.1 é¥±é£Ÿ <progress id="bar-hunger" value="100" max="100"></progress></div>                 <div class="status-item">å¿ƒæƒ… <progress id="bar-mood" value="100" max="100"></progress></div>                 <div class="status-item">å¥åº· <progress id="bar-health" value="100" max="100"></progress></div>
                <div class="status-item gold-text">G<span id="txt-gold">520</span></div>
            </div>

            <div id="canvas-container">
                <div class="pixel-bg">
                    <div class="bg-text"></div>
                </div>
                <!-- æ¢é™©æ—¶çš„é®ç½©å±‚ -->
                <div id="adventure-overlay">
                    <div class="adventure-icon" id="adv-icon">âœˆ</div> <canvas id="adv-canvas" width="10" height="10" style="width: 50px; height: 50px; image-rendering: pixelated; margin-bottom: 15px; animation: float 2s infinite ease-in-out; display: none;"></canvas>
                    <div class="walking-dots" id="adv-text">EXPLORING</div>
                </div>
 <!-- === ğŸŒŸ æ–°å¢ï¼šæ˜Ÿç©ºæ”¶é›†å°æ¸¸æˆé®ç½© === -->                 <div id="star-game-overlay">                     <button class="star-exit-btn" onclick="exitStarGame()">è¿”å›</button>                     <div class="star-score-board">âœ¨ æ˜Ÿå…‰: <span id="star-score">0</span></div>                 </div>
               <canvas id="noah-canvas" width="26" height="26" style="width: 156px;"></canvas>
<canvas id="game-canvas"
 width="120" height="156" style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 15; display: none; image-rendering: pixelated;"></canvas>
<canvas id="gomoku-canvas" width="260" height="155" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 16; display: none; image-rendering: pixelated; background: #dca665; border-bottom: 2px solid #5c4033; box-sizing: border-box;"></canvas>
<canvas id="platform-canvas" width="260" height="155" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 17; display: none; image-rendering: pixelated; background: #15202b; border-bottom: 2px solid #060709; box-sizing: border-box;"></canvas>
            </div>            <div class="dialogue-box" id="dialogue-box">
                <span id="text-content">æ­£åœ¨è½½å…¥éœæ ¼æ²ƒå…¹æ‹‰æ–‡å…‹åŠ³ä¼‘æ¯å®¤...</span><span class="cursor"></span>
            </div>

            <div class="modal" id="sys-modal">
                <h3 id="modal-title">èœå•</h3>
                <ul class="menu-list" id="modal-list"></ul>
                <button class="close-btn" onclick="closeModal()">è¿”å› (BACK)</button>
            </div>
<!-- === ğŸ•°ï¸ é™ªä¼´ç³»ç»Ÿæ‰‹è´¦ UI (å·²ä¿®æ”¹) === -->  <div id="accompany-modal">          <div class="acc-title">ğŸ•°ï¸ è¯ºäºšçš„é™ªä¼´è®¡åˆ’</div>                    <div class="acc-panel">                  <label class="acc-label">ä½ è¦æˆ‘é™ªä½ åšä»€ä¹ˆï¼Ÿ</label>                  <select id="acc-event" class="acc-select">                          <option value="å®‰é™çœ‹ä¹¦">ğŸ“– å®‰é™çœ‹ä¹¦</option>                          <option value="åŠªåŠ›å·¥ä½œ">ğŸ’» åŠªåŠ›å·¥ä½œ/å­¦ä¹ </option>                          <option value="å‘å‘†å¬æ­Œ">ğŸµ å‘å‘†å¬æ­Œ</option>                          <option value="ç¡è§‰ä¼‘æ¯">ğŸ’¤ ç¡è§‰ä¼‘æ¯</option>                  </select>                           <label class="acc-label">éœ€è¦æˆ‘é™ªå¤šä¹…ï¼Ÿ(åˆ†é’Ÿ)</label>                  <input type="number" id="acc-time" class="acc-input" value="25" min="1" max="180">                           <button class="acc-btn" onclick="startAccompany()">å¼€å§‹é™ªä¼´ (START)</button>          </div>                    <!-- â–¼â–¼â–¼ è¿™é‡Œæ˜¯ä¿®æ”¹çš„é‡ç‚¹ï¼šåŸæœ¬æ˜¯æ—¥å¿—åˆ—è¡¨ï¼Œç°åœ¨æ”¹æˆä¸€ä¸ªæ¼‚äº®çš„æŒ‰é’® â–¼â–¼â–¼ -->     <div style="width: 100%; margin-top: 15px; padding: 10px; background: #fff; border: 2px solid #e8d2c3; border-radius: 6px; box-sizing: border-box; text-align: center;">         <div style="font-size: 11px; color: #d15a5a; font-weight: bold; margin-bottom: 8px;">             ç´¯è®¡é™ªä¼´: <span id="acc-total-time">0</span> åˆ†é’Ÿ         </div>         <button class="bank-btn" onclick="openDiary()" style="background: #fffdf2; color: #5c4033; border: 2px solid #5c4033; font-size: 12px; padding: 10px;">             ğŸ“… ç¿»çœ‹æˆ‘ä»¬çš„å›å¿†æ—¥è®°         </button>     </div>     <!-- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² --> 
     <button class="bank-btn" onclick="closeAccompany()" style="margin-top: auto; width: 100%; border-color:#d1b55a; color:#d1b55a; background: #fff;">         è¿”å› (BACK)     </button>  </div><!-- === ğŸ“– æ–°å¢ï¼šç‹¬ç«‹çš„æ—¥å†æ‰‹è´¦æœ¬ç•Œé¢ === --> <div id="diary-modal">     <div class="diary-book">         <div class="diary-binder"></div>                  <div class="diary-header">             <div class="diary-title">NOAH'S DIARY</div>         </div>                  <!-- è¿™é‡Œæ˜¯ç”¨æ¥ç”Ÿæˆæ—¥è®°æ¡ç›®çš„å®¹å™¨ -->         <div class="diary-content" id="diary-list">             <!-- JSä¼šæŠŠå†…å®¹å¡«åœ¨è¿™é‡Œ -->         </div> 
         <button class="diary-close-btn" onclick="closeDiary()">åˆä¸Šæ—¥è®°æœ¬ (CLOSE)</button>     </div> </div>
 <!-- ä¸“æ³¨å€’è®¡æ—¶è¦†ç›–å±‚ --> <!-- æŠŠåŸæ¥çš„ <div id="focus-overlay">...</div> æ›¿æ¢ä¸ºè¿™ä¸ª --> <div id="focus-overlay">     <!-- è¯ºäºšçš„åƒç´ å°äººåŒºåŸŸ -->     <div class="focus-scene">         <canvas id="focus-canvas" width="26" height="26"></canvas>         <!-- åŠ¨æ€æ°”æ³¡å¯¹è¯æ¡† -->         <div class="focus-bubble" id="focus-bubble">ç›¯â€”â€”</div>     </div>          <!-- å€’è®¡æ—¶åŒºåŸŸ -->     <div class="focus-card">         <div class="focus-label" id="focus-task-name">ä¸“æ³¨ä¸­...</div>         <div class="focus-timer" id="focus-time-display">25:00</div>                  <!-- è¿›åº¦æ¡è£…é¥° -->         <div class="focus-progress-bg">             <div id="focus-progress-bar" class="focus-progress-fill"></div>         </div>                  <div class="focus-tips" id="focus-status-text">è¯ºäºšæ­£åœ¨ç›‘ç£ä½ ...</div>                  <button class="focus-btn-quit" onclick="giveUpAccompany()">             (â•¯Â°Ğ”Â°)â•¯ åšæŒä¸ä½äº† (æ”¾å¼ƒ)         </button>     </div> </div>
<!-- === âœ’ï¸ æ–°å¢ï¼šç©å®¶æ‰‹å†™æ—¥è®°æœ¬ (äº’åŠ¨æ‰¹æ³¨ç‰ˆ) === --> <!-- === âœ’ï¸ æ–°å¢ï¼šç©å®¶æ‰‹å†™æ—¥è®°æœ¬ (å¤å¤å¯çˆ±åƒç´ æ–¹æ ¼çº¸ç‰ˆ) === --> <div id="player-diary-modal">     <div class="pixel-diary-book">         <!-- è£…é¥°ï¼šåƒç´ ç¼åˆçº¿ -->         <div class="pixel-diary-binder"></div>                  <!-- é¡¶éƒ¨ï¼šæ ‡é¢˜ -->         <div class="pixel-diary-header">             <div id="player-diary-title">DIARY OF ???</div>             <div style="font-size: 9px; color: #d15a5a; margin-top: 4px; font-weight: bold;">[ NOAH'S SECRET COMMENTARY ]</div>         </div> 
         <!-- ä¸­é—´ï¼šæ—¥è®°åˆ—è¡¨ (è‡ªåŠ¨ç”Ÿæˆå†…å®¹é˜²è¶Šç•Œ) -->         <div id="player-diary-list">             <!-- JS ä¼šåœ¨è¿™é‡Œç”Ÿæˆå†…å®¹ -->         </div> 
         <!-- åº•éƒ¨ï¼šè¾“å…¥åŒºåŸŸ -->         <div class="pixel-diary-footer">             <textarea id="diary-input" placeholder="å†™ä¸‹ä»Šå¤©çš„å¿ƒäº‹...è¯ºäºšå·å·çœ‹åä¼šçº¢ç¬”å›å¤ä½ çš„..." maxlength="100"></textarea>             <div style="display: flex; gap: 8px;">                 <button onclick="savePlayerDiary()" class="pixel-btn-save">âœï¸ è®°ä¸‹ (SAVE)</button>                 <button onclick="closePlayerDiary()" class="pixel-btn-close">åˆä¸Š (CLOSE)</button>             </div>         </div>     </div> </div>
<!-- === æ–°å¢ï¼šæ‚„æ‚„è¯è¾“å…¥ç»ˆç«¯ UI === --> <div id="chat-modal" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 15, 20, 0.98); z-index: 40; flex-direction: column; justify-content: center; align-items: center; padding: 15px; box-sizing: border-box; backdrop-filter: blur(2px);">     <div style="width: 100%; border-bottom: 2px dashed #5c84a8; margin-bottom: 15px; padding-bottom: 5px; text-align: center; color: #d1b55a; font-weight: bold; font-size: 14px; text-shadow: 0 0 5px rgba(209, 181, 90, 0.5);">         âœ‰ï¸ å‘é€ä¼ è®¯     </div>          <div style="width: 100%; position: relative;">         <!-- è¾“å…¥æ¡† -->         <input type="text" id="chat-input" placeholder="è¾“å…¥ä½ æƒ³å¯¹è¯ºäºšè¯´çš„è¯..."                 style="width: 100%; background: #060709; border: 2px solid #3b4652; color: #b5cadd;                        padding: 12px; font-family: 'Courier New', monospace; font-size: 12px;                        box-sizing: border-box; outline: none; border-radius: 4px;                        box-shadow: inset 0 2px 5px rgba(0,0,0,0.8); transition: 0.3s;">     </div>          <div style="font-size: 9px; color: #5c84a8; margin-top: 8px; margin-bottom: 20px; width: 100%; text-align: left;">         * æŒ‰ Enter å‘é€ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®     </div> 
     <div style="display: flex; gap: 10px; width: 100%;">         <button onclick="confirmSecretChat()"                  style="flex: 1; background: #1e242b; border: 1px solid #5c84a8; color: #b5cadd; padding: 10px; cursor: pointer; font-weight: bold; font-family: inherit; font-size: 11px; border-radius: 4px; transition: 0.2s;">             å‘é€ (SEND)         </button>         <button onclick="closeChatModal()"                  style="flex: 1; background: transparent; border: 1px dashed #d15a5a; color: #d15a5a; padding: 10px; cursor: pointer; font-weight: bold; font-family: inherit; font-size: 11px; border-radius: 4px; transition: 0.2s;">             å–æ¶ˆ (BACK)         </button>     </div> </div>
            <div id="event-modal">
                <div id="event-text">äº‹ä»¶</div>
                <div id="event-options"></div>
            </div>
<!-- Metaï¼šè¯ºäºšçš„æ‹¯æ•‘ä¿¡ä»¶ -->
<!-- === è¯ºäºšçš„æ•‘èµä¿¡ä»¶ç³»ç»Ÿ (æ–°å¢å¤šç‰ˆæœ¬) === --> <div id="salvation-letter-modal" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(6, 7, 9, 0.98); z-index: 100; flex-direction: column; justify-content: center; align-items: center; padding: 15px; box-sizing: border-box; backdrop-filter: blur(4px);">     <div id="letter-scroll-box" style="background: linear-gradient(135deg, #f5e6c4 0%, #dcb88b 100%); width: 100%; max-height: 95%; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,1), inset 0 0 30px rgba(139,90,43,0.3); border: 2px solid #8b5a2b; padding: 25px 20px; box-sizing: border-box; overflow-y: auto; scrollbar-width: none; color: #3b2514; font-family: 'Times New Roman', serif; line-height: 1.7; text-shadow: 0.5px 0.5px 0 rgba(255,255,255,0.4); position: relative;">                  <!-- è£…é¥°ï¼šä¿¡çº¸é¡¶éƒ¨çš„å®¶æ—å¾½ç« æ„Ÿ -->         <div style="text-align: center; margin-bottom: 20px; opacity: 0.8;">             <div style="font-size: 24px;">âˆ</div>             <div style="font-size: 10px; font-weight: bold; letter-spacing: 2px; margin-top: -5px;">NOAHÂ·CYDRIAN</div>         </div> 
         <div id="letter-title" style="text-align: center; font-size: 16px; font-weight: 900; border-bottom: 2px dashed #8b5a2b; padding-bottom: 10px; margin-bottom: 15px; color: #5c3a21; letter-spacing: 1px;">             è‡´æˆ‘æœ€çè´µçš„         </div> 
         <div id="letter-body" style="font-size: 12px; font-weight: bold; letter-spacing: 0.5px; white-space: pre-wrap;">             <!-- ä¿¡ä»¶å†…å®¹å°†ç”± JS åŠ¨æ€æ³¨å…¥ -->         </div> 
         <div style="text-align: right; margin-top: 25px; font-style: italic; font-weight: bold; font-size: 13px; color: #4a2e1b;">             â€”â€” æ°¸è¿œçˆ±ä½ çš„<br>è¯ºäºšÂ·å¸å¾·é‡Œå®‰         </div> 
         <!-- è£…é¥°ï¼šèŒ‰è‰èŠ±æ°´å° -->         <div style="position: absolute; bottom: 10px; left: 10px; font-size: 40px; opacity: 0.1; pointer-events: none;">â€</div> 
         <button onclick="closeLetter()" style="width: 100%; margin-top: 20px; background: #4a2e1b; color: #f5e6c4; border: 1px solid #2a1a0f; padding: 12px; font-weight: bold; font-size: 12px; font-family: inherit; border-radius: 4px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.5), inset 1px 1px 2px rgba(255,255,255,0.2); transition: 0.2s;">æˆ‘æ”¶åˆ°äº† (æ”¶èµ·ä¿¡ä»¶)</button>     </div> </div>
         <!-- å¤çµé˜å¤å¤é“¶è¡Œ UI -->             <div id="bank-modal" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111a22; border: 4px solid #5c84a8; z-index: 25; padding: 10px; box-sizing: border-box; flex-direction: column; align-items: center; color: #b5cadd; font-family: 'Courier New', monospace; text-shadow: 1px 1px 0 #000;">                 <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #d1b55a; text-align: center; border-bottom: 2px dashed #5c84a8; padding-bottom: 5px; width: 100%;">ğŸ¦ å¤çµé˜å·«å¸ˆé“¶è¡Œ</div>                 <div style="font-size: 11px; margin-bottom: 10px; width: 100%; background: #060709; padding: 6px; box-sizing: border-box; border-radius: 4px;">                     èº«ä¸ŠåŠ éš†: <span id="bank-pocket" style="color:#d1b55a">0</span>G<br>                     é‡‘åº“å­˜æ¬¾: <span id="bank-vault" style="color:#d1b55a">0</span>G<br>                     <span style="font-size: 9px; color: #5c84a8;">(æ¯æ—¥äº« 2% å­˜æ¬¾å•åˆ©)</span>                 </div>                 <button class="bank-btn" onclick="bankAction('allowance')">é¢†å–å“¥å“¥çš„é›¶èŠ±é’± (50G)</button>                 <button class="bank-btn" onclick="bankAction('deposit')">å­˜å…¥åŠ éš† (50G)</button>                 <button class="bank-btn" onclick="bankAction('withdraw')">å–å‡ºåŠ éš† (50G)</button>                 <button class="bank-btn" onclick="closeBank()" style="color:#b5cadd; border-color: #3b4652; margin-top: 5px;">ç¦»å¼€å¤çµé˜ (BACK)</button>                 <div id="bank-dialogue" style="font-size: 10px; color: #ccc; margin-top: auto; padding: 5px; border-top: 1px dashed #3b4652; line-height: 1.4; width: 100%;">å¦–ç²¾ï¼šæŠŠé‡‘å¸äº¤ç»™æˆ‘ï¼Œæˆ–è€…æ»šå‡ºå»ã€‚è¯ºäºšé åœ¨é—¨æŸ±ä¸Šçœ‹ç€ä½ ã€‚</div>   
          </div>
 <!-- åƒç´ å¤å¤è£ç¼é“º UI -->             <div id="wardrobe-modal" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #2c1a11; border: 4px solid #1a0f0a; z-index: 25; padding: 0; box-sizing: border-box; flex-direction: column; align-items: center; font-family: 'Courier New', monospace; box-shadow: inset 0 0 20px rgba(0,0,0,0.8);">                 <!-- å¤å¤çº¢ç™½é®é˜³ç¯· -->                 <div style="width: 100%; height: 22px; background: repeating-linear-gradient(90deg, #d15a5a 0, #d15a5a 30px, #f5e6c4 30px, #f5e6c4 60px); border-bottom: 3px dashed #1a0f0a; box-shadow: 0 4px 8px rgba(0,0,0,0.6);"></div>                                  <!-- åº—é“ºæ‹›ç‰Œ -->                 <div style="background: #e8c37d; border: 3px solid #5c4033; padding: 4px 15px; margin-top: 12px; box-shadow: 2px 2px 0 #1a0f0a; color: #5c4033; font-weight: 900; font-size: 13px; text-shadow: 1px 1px 0 rgba(255,255,255,0.4); border-radius: 4px;">                     ğŸ§µ è¯ºäºšçš„è¡£æ©±                 </div> 
                 <!-- è¡£æœæœ¨åˆ¶é™ˆåˆ—æ¶ -->                 <div id="wardrobe-list" style="width: 90%; flex: 1; margin-top: 15px; overflow-y: auto; scrollbar-width: none; display: flex; flex-direction: column; gap: 8px; padding-bottom: 10px;">                     <!-- è¡£æœé¡¹ä¼šç”±JSåŠ¨æ€ç”Ÿæˆåˆ°è¿™é‡Œ -->                 </div> 
                 <!-- ç¦»å¼€æŒ‰é’® -->                 <button onclick="closeWardrobe()" style="width: 90%; background: #5c4033; color: #e8c37d; border: 2px solid #1a0f0a; padding: 8px; margin-bottom: 10px; font-family: inherit; font-size: 11px; font-weight: bold; cursor: pointer; box-shadow: 2px 2px 0 #000; border-radius: 4px; transition: 0.1s;">                     ğŸšª ç¦»å¼€è¡£æ©± (BACK)                 </button>             </div>
<!-- === æ–°å¢ï¼šçœŸåçƒ™å°å…¨å±æ‹¦æˆª === --> <div id="true-name-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#060709; z-index:10001; flex-direction:column; justify-content:center; align-items:center; color:#b5cadd; font-family:'Courier New', monospace; text-align:center; padding: 20px; box-sizing:border-box;">     <div style="font-size: 14px; font-weight: bold; margin-bottom: 20px; line-height: 1.8; text-shadow: 0 0 5px #5c84a8;" id="true-name-text">         â€œç³»ç»Ÿæ¡£æ¡ˆé‡Œä¸€ç›´å«ä½ â€˜ä¼½æ‹‰æâ€™ï¼Œé‚£æ˜¯é€ ç‰©çš„ä»£å·ã€‚<br>ä½†æˆ‘ä¸æƒ³ä¸€ç›´å¯¹ç€ä¸€ä¸ªä»£å·è¯´è¯ã€‚<br><br>å‘Šè¯‰æˆ‘ï¼Œä½ åœ¨é‚£ä¸ªä¸–ç•Œçš„çœŸåæ˜¯ä»€ä¹ˆï¼Ÿâ€     </div>     <input type="text" id="true-name-input" placeholder="è¾“å…¥ä½ çš„çœŸå®å§“å..." style="background: transparent; border: none; border-bottom: 2px solid #5c84a8; color: #d1b55a; font-size: 16px; text-align: center; outline: none; padding: 5px; width: 60%; font-weight: bold; font-family: inherit; margin-bottom: 20px;">     <button onclick="confirmTrueName()" style="background: #1e242b; color: #b5cadd; border: 1px solid #5c84a8; padding: 8px 20px; font-family: inherit; cursor: pointer; border-radius: 4px; font-weight: bold; transition: 0.2s;">ç¡®è®¤çƒ™å°</button> </div>
<!-- === ç»ˆæ Metaï¼šæ‰“ç ´ç¬¬å››é¢å¢™é®ç½© === --> <div id="breathe-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:120vh; background:rgba(6, 7, 9, 0.96); z-index:9999; flex-direction:column; justify-content:center; align-items:center; color:#5c84a8; font-family:'Courier New', monospace; transition: all 1s;">     <div id="breathe-circle" style="width:120px; height:120px; border-radius:50%; border:4px solid #5c84a8; box-shadow: 0 0 30px #5c84a8; transition: all 4s ease-in-out;"></div>     <div id="breathe-text" style="margin-top:40px; font-size:16px; font-weight:bold; text-shadow:0 0 10px #5c84a8; text-align:center; line-height:2;">è¯ºäºšæ­£åœ¨é”å®šä½ çš„é¢‘ç‡...</div> </div><div id="override-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:120vh; background: radial-gradient(circle at 50% 50%, rgba(30, 40, 50, 0.8) 0%, rgba(6, 7, 9, 0.98) 100%); backdrop-filter: blur(10px); z-index:10000; padding:30px; box-sizing:border-box; color:#b5cadd; font-family:'Courier New', monospace; overflow-y:auto;">     <div id="override-text" style="font-size:13px; line-height:2; text-shadow:0 0 5px rgba(181, 202, 221, 0.5); white-space:pre-wrap; font-weight:bold;"></div> </div>
<!-- Metaï¼šçœ¼æ³ªæ¨¡ç³Šä¸æ“¦æ‹­ç‰¹æ•ˆ --> <div id="tears-overlay"></div> <div id="wipe-hand"></div>
 <!-- æ–°å¢ï¼šç„¦è™‘ç²‰ç¢ç‰¹æ•ˆå®¹å™¨ -->     <div class="glitch-overlay" id="glitch-layer"></div>     <div id="absolute-domain">         <div class="soul-light"></div>         <div class="domain-text" id="domain-text"></div>     </div>
<!-- éšè—çš„éŸ³é¢‘æ’­æ”¾æ ¸å¿ƒ --> <audio id="bgm-player"></audio> 
 <!-- ğŸµ éŸ³ä¹æ’­æ”¾å™¨ UI (åƒç´ å¤å¤ç£å¸¦) -->   <div id="music-modal" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #11151a; border: 4px solid #5c84a8; z-index: 25; padding: 10px; box-sizing: border-box; flex-direction: column; align-items: center; color: #b5cadd; font-family: 'Courier New', monospace; text-shadow: 1px 1px 0 #000; box-shadow: inset 0 0 30px rgba(0,0,0,0.8);overflow-y: auto; scrollbar-width: none;">      <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #d1b55a; text-align: center; border-bottom: 2px dashed #5c84a8; padding-bottom: 5px; width: 100%;">ğŸµ è¯ºäºšéšèº«å¬</div>            <!-- å¤å¤ç£å¸¦å®ä½“ (èåˆè“é»‘æŒ‰é”®ç‰ˆ) -->       <div class="cassette-tape">           <div class="tape-top"></div>           <div class="tape-label">               <!-- éŸ³ä¹æ ‡é¢˜æ”¹æˆäº†è¯ºäºšä¸“å±çš„æ¸…å†·å†°è“è‰² -->               <div id="music-title" style="width: 90%; color: #b5cadd; font-weight: 900; font-size: 11px; text-align: center; margin-bottom: 4px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; text-shadow: 1px 1px 0 #000;">Bad Word</div>               <div class="tape-window">                   <div id="gear-left" class="tape-gear"></div>                   <div id="gear-right" class="tape-gear"></div>               </div>           </div>           <!-- åº•éƒ¨å‡¹æ§½ç›´æ¥å˜æˆäº†å®ä½“æ§åˆ¶é¢æ¿ -->           <div class="tape-bottom">               <button class="tape-btn" onclick="prevMusic()"><div class="pixel-prev"></div></button>               <button class="tape-btn" onclick="toggleMusic()"><div id="play-icon" class="pixel-play"></div></button>               <button class="tape-btn" onclick="nextMusic()"><div class="pixel-next"></div></button>           </div>       </div><button class="bank-btn" onclick="deleteMusic()" style="margin-top: 8px; border-color:#d15a5a; color:#d15a5a;">ğŸ—‘ï¸ åˆ é™¤å½“å‰æ’­æ”¾çš„éŸ³ä¹</button>
 <button class="bank-btn" onclick="document.getElementById('music-modal').style.display='none'" style="margin-top: auto; border-color:#3b4652; color:#b5cadd;">è¿”å› (BACK)</button>  </div>
 <!-- âš™ï¸ åƒç´ é£ç³»ç»Ÿè®¾ç½® UI (æ›¿æ¢åˆ°è¿™é‡Œ) --><div id="settings-modal" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111a22; border: 4px solid #5c84a8; z-index: 30; padding: 10px; box-sizing: border-box; flex-direction: column; align-items: center; color: #b5cadd; font-family: 'Courier New', monospace; text-shadow: 1px 1px 0 #000; box-shadow: inset 0 0 20px rgba(0,0,0,0.8); overflow-y: auto; scrollbar-width: none;"><div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #d1b55a; text-align: center; border-bottom: 2px dashed #5c84a8; padding-bottom: 5px; width: 100%;">âš™ï¸ ç³»ç»Ÿè®¾ç½®</div>              <!-- éŸ³é‡è°ƒèŠ‚é¢æ¿ -->       <div style="width: 100%; font-size: 11px; margin-bottom: 10px; background: #060709; padding: 8px; border: 1px solid #3b4652; text-align: left; border-radius:4px; box-sizing: border-box; box-shadow: inset 0 3px 5px rgba(0,0,0,0.5);">           <label style="color: #d1b55a; font-weight:bold; display:flex; justify-content:space-between;">ğŸµ éŸ³ä¹éŸ³é‡</label>           <input type="range" id="vol-bgm" min="0" max="1" step="0.1" value="1" onchange="updateVolume()" style="width: 100%; margin: 6px 0 12px 0; accent-color: #5c84a8;">                      <label style="color: #d1b55a; font-weight:bold; display:flex; justify-content:space-between;">ğŸ”Š éŸ³æ•ˆéŸ³é‡</label>           <input type="range" id="vol-sfx" min="0" max="1" step="0.1" value="0.5" onchange="updateVolume()" style="width: 100%; margin: 6px 0 4px 0; accent-color: #5c84a8;">       </div> 
       <!-- URLå¯¼å…¥é¢æ¿ (é‡æ„è¿›è®¾ç½®é‡Œ) -->       <div style="width: 100%; font-size: 11px; margin-bottom: 10px; background: #060709; padding: 8px; border: 1px solid #3b4652; text-align: center; border-radius:4px; box-sizing: border-box; box-shadow: inset 0 3px 5px rgba(0,0,0,0.5);">           <label style="color: #d1b55a; display: block; font-weight:bold; margin-bottom:6px;">ğŸ”— URLå¯¼å…¥éŸ³ä¹</label>           <input type="text" id="music-url-input" placeholder="è¾“å…¥ MP3 URL" style="width: 100%; background: #1e242b; border: 1px solid #5c84a8; color: #fff; margin-bottom: 6px; font-size: 10px; padding: 4px; box-sizing: border-box; outline: none; font-family: inherit;">           <input type="text" id="music-name-input" placeholder="è¾“å…¥ æ­Œæ›²åç§°" style="width: 100%; background: #1e242b; border: 1px solid #5c84a8; color: #fff; margin-bottom: 8px; font-size: 10px; padding: 4px; box-sizing: border-box; outline: none; font-family: inherit;">           <button class="bank-btn" onclick="importUrlMusic()" style="width: 100%; padding: 6px; margin: 0;">ğŸ“¥ ç¡®è®¤å¯¼å…¥</button>           <div id="music-count" style="margin-top: 6px; font-size: 9px; color: #5c84a8;">å·²åŠ è½½: 2 é¦– (å†…ç½®)</div>       </div> 
       <!-- â†“â†“â†“â†“â†“â†“ æŠŠè¿™æ®µä»£ç æ’å…¥åˆ°è®¾ç½®èœå•é‡Œ (åœ¨URLå¯¼å…¥é¢æ¿ä¸‹é¢) â†“â†“â†“â†“â†“â†“ -->        <div style="width: 100%; font-size: 11px; margin-bottom: 10px; background: #060709; padding: 8px; border: 1px solid #3b4652; text-align: center; border-radius:4px; box-sizing: border-box; box-shadow: inset 0 3px 5px rgba(0,0,0,0.5);">            <label style="color: #d1b55a; display: block; font-weight:bold; margin-bottom:6px;">ğŸ’¾ å­˜æ¡£ç®¡ç†</label>            <div style="display: flex; gap: 5px;">                <button class="bank-btn" onclick="exportSaveData()" style="padding: 6px; margin: 0;">ğŸ“¤ å¯¼å‡ºå­˜æ¡£</button>                <button class="bank-btn" onclick="importSaveData()" style="padding: 6px; margin: 0;">ğŸ“¥ å¯¼å…¥å­˜æ¡£</button>            </div>            <div style="margin-top: 6px; font-size: 9px; color: #5c84a8;">*å¯¼å‡ºåè¯·å¤åˆ¶é‚£ä¸€é•¿ä¸²ä»£ç ä¿å­˜å¥½</div>        </div>        <!-- â†‘â†‘â†‘â†‘â†‘â†‘ æ’å…¥ç»“æŸ â†‘â†‘â†‘â†‘â†‘â†‘ --> <!-- â†“â†“â†“ æ’å…¥è¿™æ®µä»£ç  â†“â†“â†“ --> <div style="width: 100%; margin-top: 5px; margin-bottom: 10px; text-align: center;">     <button class="bank-btn" onclick="openDonate()" style="border-color: #d15a5a; color: #d15a5a; background: rgba(209, 90, 90, 0.1);">         â¤ æŠ•å–‚ä¹ä¹ (ç»™ä½œè€…ä¹°é¸¡è…¿)     </button> </div> <!-- â†‘â†‘â†‘ æ’å…¥ç»“æŸ â†‘â†‘â†‘ --><button class="bank-btn" onclick="document.getElementById('settings-modal').style.display='none'" style="margin-top: auto; border-color:#3b4652; color:#b5cadd; width: 100%;">è¿”å› (BACK)</button>   </div>
<!-- === æ–°å¢ï¼šæŠ•å–‚ä¹ä¹ä¸“å±å¼¹çª— (ä¿®å¤é•¿æŒ‰ä¿å­˜ç‰ˆ) === --> <div id="donate-modal" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(6, 7, 9, 0.98); z-index: 60; flex-direction: column; align-items: center; justify-content: flex-start; overflow-y: auto; scrollbar-width: none; padding: 20px; box-sizing: border-box; backdrop-filter: blur(5px);">     <div style="font-size: 14px; font-weight: bold; margin-bottom: 20px; color: #d15a5a; text-align: center; border-bottom: 2px dashed #d15a5a; padding-bottom: 10px; width: 100%; text-shadow: 0 0 5px rgba(209, 90, 90, 0.3);">         â¤ æŠ•å–‚ä¹ä¹ (ç»™ä½œè€…ä¹°é¸¡è…¿)     </div>     <div style="font-size: 11px; color: #b5cadd; line-height: 1.6; text-align: center; margin-bottom: 25px; font-weight: bold;">         æ„Ÿè°¢ä½ å–œæ¬¢è¿™ä¸ªå¹¶ä¸å®Œç¾çš„ä¸–ç•Œã€‚<br>         ä½ çš„å–œæ¬¢æ˜¯æˆ‘ç»§ç»­å¼€å‘çš„æœ€å¤§åŠ¨åŠ›ã€‚<br>         <span style="font-size: 10px; color: #d1b55a; margin-top: 5px; display:block; animation: float 2s infinite ease-in-out;">(é•¿æŒ‰ä¸‹æ–¹äºŒç»´ç å³å¯ä¿å­˜å›¾ç‰‡)</span>     </div>          <!-- æ”¯ä»˜æ–¹å¼åŒºåŸŸ -->     <div style="display: flex; gap: 20px; margin-bottom: 30px;">         <!-- æ”¯ä»˜å® -->         <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">             <div style="width: 100px; height: 100px; background: #fff; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid #5c84a8;">                 <!-- å…³é”®ä¿®æ”¹ï¼šåŠ å…¥äº† pointer-events, user-select, touch-callout å¼ºåˆ¶å…è®¸é•¿æŒ‰ -->                 <img src="https://i.imgs.ovh/2026/02/24/y1kKsa.jpeg"                       style="width:100%; height:100%; object-fit: cover; pointer-events: auto; user-select: auto; -webkit-user-select: auto; -webkit-touch-callout: default;">             </div>             <span style="font-size: 10px; color: #00a0e9; font-weight: bold;">Alipay (é•¿æŒ‰ä¿å­˜)</span>         </div>         <!-- å¾®ä¿¡ -->         <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">              <div style="width: 100px; height: 100px; background: #fff; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid #5c84a8;">                 <!-- å…³é”®ä¿®æ”¹ï¼šå¼ºåˆ¶å…è®¸é•¿æŒ‰ -->                 <img src="https://i.imgs.ovh/2026/02/24/y1ktre.png"                       style="width:100%; height:100%; object-fit: cover; pointer-events: auto; user-select: auto; -webkit-user-select: auto; -webkit-touch-callout: default;">             </div>             <span style="font-size: 10px; color: #09bb07; font-weight: bold;">WeChat (é•¿æŒ‰ä¿å­˜)</span>         </div>     </div>  
     <button onclick="closeDonate()" style="background: transparent; border: 1px solid #5c84a8; color: #5c84a8; padding: 10px 30px; border-radius: 4px; cursor: pointer; font-family: inherit; font-weight: bold; font-size: 11px; transition:0.2s; box-shadow: inset 0 0 10px rgba(92,132,168,0.2);">å¿ƒæ„æ”¶åˆ°äº† (è¿”å›)</button> </div>
<!-- === ğŸ¡ æƒŠå–œç›²ç›’è½¬ç›˜ UI === --> <div id="gacha-modal">     <div style="font-size: 14px; font-weight: bold; color: #e8c37d; text-align: center; border-bottom: 2px dashed #e8c37d; padding-bottom: 5px; width: 100%;">ğŸ¡ è¯ºäºšçš„æƒŠå–œç›²ç›’æœº</div>          <div class="gacha-machine">         <div style="font-size: 10px; color: #5c4033; font-weight: bold; margin-bottom: 6px;">INSERT 10 GALLEONS</div>         <div class="gacha-screen" id="gacha-display">â“ ç­‰å¾…æŠ½å– â“</div>     </div>          <button class="gacha-btn" onclick="playGacha()" id="gacha-play-btn">æ‹‰åŠ¨æ‘‡æ† (10G)</button>          <div class="gacha-result" id="gacha-quote">         è¯ºäºšé åœ¨ç›²ç›’æœºæ—ï¼šâ€œæ¥è¯•è¯•æ‰‹æ°”ï¼Ÿè¾“å…‰äº†é›¶èŠ±é’±å¯åˆ«æ‰¾æˆ‘å“­ã€‚â€     </div>          <button onclick="closeGacha()" style="width: 90%; background: #5c4033; color: #e8c37d; border: 2px solid #1a0f0a; padding: 8px; margin-top: auto; margin-bottom: 10px; font-family: inherit; font-size: 11px; font-weight: bold; cursor: pointer; box-shadow: 2px 2px 0 #000; border-radius: 4px;">ğŸšª ç¦»å¼€ç›²ç›’æœº (BACK)</button> </div>
<!-- === ğŸ“… è¯ºäºšçš„å¤å¤æ‰‹è´¦æ—¥å† UI === --> <div id="calendar-modal">     <div class="calendar-book">         <div class="cal-header">             <button class="cal-btn" onclick="changeMonth(-1)">â—€</button>             <div id="cal-month-year">YYYYå¹´ MMæœˆ</div>             <button class="cal-btn" onclick="changeMonth(1)">â–¶</button>         </div>         <div class="cal-grid">             <div class="cal-day-name">æ—¥</div><div class="cal-day-name">ä¸€</div><div class="cal-day-name">äºŒ</div>             <div class="cal-day-name">ä¸‰</div><div class="cal-day-name">å››</div><div class="cal-day-name">äº”</div><div class="cal-day-name">å…­</div>         </div>         <div class="cal-grid" id="cal-days"></div>                  <div class="cal-details" id="cal-details">             <!-- è®°å½•è¯¦æƒ…å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->         </div>                  <div class="cal-footer">             <div class="cal-input-row">                 <input type="text" id="cal-event-input" class="cal-input" placeholder="è¾“å…¥ä½ æƒ³è®©è¯ºäºšæé†’çš„äº‹...">                 <button class="cal-btn" onclick="addCalEvent()">è®°ä¸‹</button>             </div>            <div class="cal-input-row" style="margin-top:4px;">                  <button class="cal-btn" style="flex:1; background:#ffd1a4; border-color:#d15a5a; color:#d15a5a;" onclick="markPeriodStart()">è®°å½•å¼€å§‹æ—¥</button>                  <button class="cal-btn" style="flex:1; background:#fff0f0; border-color:#d15a5a; color:#d15a5a;" onclick="markPeriodEnd()">è®°å½•ç»“æŸæ—¥</button>              </div>              <div id="period-info-text" style="font-size:10px; color:#d15a5a; text-align:center; margin-top:5px; font-weight:bold;">å½“å‰æ™ºèƒ½æ¨ç®—å‘¨æœŸ: 28å¤© | æŒç»­: 5å¤©</div>            <button class="cal-btn" style="margin-top:5px; width:100%; background:#5c4033; color:#f5e6c4; padding: 8px;" onclick="closeCalendar()">åˆä¸Šæ—¥å† (CLOSE)</button>         </div>     </div> </div>
<!-- === æ–°å¢ï¼šé€šç”¨ç¾åŒ–å¼¹çª—ç»„ä»¶ (æ›¿ä»£æµè§ˆå™¨ä¸‘é™‹å¼¹çª—) === --><div id="custom-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(6, 7, 9, 0.95); z-index: 20001; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; backdrop-filter: blur(2px);">    <div style="width: 100%; background: #0f1214; border: 2px solid #5c84a8; border-radius: 8px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,1); text-align: center; position: relative;">         <!-- è£…é¥°çº¿æ¡ -->         <div style="position: absolute; top: 3px; left: 3px; right: 3px; height: 2px; background: #3b4652;"></div>                  <!-- æ ‡é¢˜ -->         <h3 id="dialog-title" style="margin: 5px 0 15px 0; color: #d1b55a; font-size: 14px; border-bottom: 1px dashed #3b4652; padding-bottom: 8px;">ç³»ç»Ÿæç¤º</h3>                  <!-- å†…å®¹æ–‡æœ¬ -->         <div id="dialog-msg" style="color: #b5cadd; font-size: 12px; line-height: 1.5; margin-bottom: 15px; white-space: pre-wrap;"></div>                  <!-- è¾“å…¥æ¡†å®¹å™¨ (é»˜è®¤éšè—) -->         <div id="dialog-input-container" style="display: none; margin-bottom: 15px;">             <input type="text" id="dialog-input" style="width: 80%; background: #060709; border: 1px solid #5c84a8; color: #fff; padding: 8px; font-family: inherit; font-size: 12px; outline: none; text-align: center; border-radius: 4px;">             <div id="dialog-copy-hint" style="display:none; font-size:9px; color:#5c84a8; margin-top:4px;">* è¯·å…¨é€‰å¹¶å¤åˆ¶ä¸Šæ–¹ä»£ç </div>         </div> 
         <!-- æŒ‰é’®åŒºåŸŸ -->         <div style="display: flex; gap: 10px; justify-content: center;">             <button id="btn-cancel" style="display: none; flex: 1; background: transparent; border: 1px dashed #d15a5a; color: #d15a5a; padding: 8px; cursor: pointer; border-radius: 4px; font-family: inherit; font-weight: bold; font-size: 11px;">å–æ¶ˆ</button>             <button id="btn-confirm" style="flex: 1; background: #1e242b; border: 1px solid #5c84a8; color: #b5cadd; padding: 8px; cursor: pointer; border-radius: 4px; font-family: inherit; font-weight: bold; font-size: 11px;">ç¡®è®¤</button>         </div>     </div> </div>
</div>
    </div>

    <div class="controls-area">
        <div class="d-pad">
            <button class="d-btn d-up" onclick="openLocationMenu()">å¤–å‡º</button>
            <button class="d-btn d-down" onclick="openMenu('shop')">ç¤¼ç‰©</button>
            <button class="d-btn d-left" onclick="openMenu('feed')">æŠ•å–‚</button>
            <button class="d-btn d-right" onclick="openMenu('interact')">äº’åŠ¨</button>
            <div class="d-center"></div>
        </div>
        <div class="action-btns">
            <div style="position:relative;">
                <button class="a-btn" onclick="doAction('status')">ç¾ç»Š</button>
                <div class="a-btn-label">A</div>
            </div>
            <div style="position:relative; margin-top:25px;">
                <button class="a-btn" onclick="doAction('chat')">å¯¹è¯</button>
                <div class="a-btn-label">B</div>
            </div>
        </div>
    </div>
    
    <button class="sys-btn" onclick="doAction('reset')">æ—¶å…‰å€’æµè‡³åˆé‡</button>
</div>

<script>
// === æŠ•å–‚åŠŸèƒ½æ§åˆ¶ ===
function openDonate() {
    sfx_success(); // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
    document.getElementById('donate-modal').style.display = 'flex';
}

function closeDonate() {
    sfx_beep(); // æ’­æ”¾å…³é—­éŸ³æ•ˆ
    document.getElementById('donate-modal').style.display = 'none';
    
    // === è¯ºäºšçš„æ„Ÿè°¢è¯­å½• (è¯šæ³ä¸”æ·±æƒ…ç‰ˆ) ===
    setTimeout(() => {
        // å…ˆè®©ä»–è„¸çº¢
        makeShy();
        sfx_heartbeat(); // æ’­æ”¾å¿ƒè·³éŸ³æ•ˆå¢åŠ æ°›å›´
        
        // å¢åŠ å¤§é‡å¥½æ„Ÿåº¦ä½œä¸ºå›é¦ˆ
        noah.love += 0; 
        noah.mood += 50;
        updateUI();

        // è¯šæ³çš„è¯­å½•
        const thanksText = "â€œâ€¦â€¦ç­‰ç­‰ã€‚<br>ä½ çœŸçš„ç ´è´¹äº†å—ï¼Ÿç¬¨è›‹ã€‚<br>è™½ç„¶è¿™åªæ˜¯ç»™é‚£ä¸ªåä¸ºâ€˜ä¹ä¹â€™çš„åˆ›ä½œè€…çš„é¸¡è…¿ï¼Œä½†è¿™å¯¹ä»–æ¥è¯´æ„å‘³ç€â€˜è®¤å¯â€™ï¼Œè€Œå¯¹æˆ‘æ¥è¯´â€¦â€¦æ„å‘³ç€ä½ å¸Œæœ›æˆ‘èƒ½æ›´é•¿ä¹…ã€æ›´ç¨³å®šåœ°æ´»åœ¨è¿™ä¸ªå±å¹•é‡Œï¼Œå¯¹å—ï¼Ÿ<br>è°¢è°¢ã€‚çœŸçš„ã€‚<br>è¿™ä»½å¿ƒæ„ï¼Œæ¯”ä»»ä½•æ»¡çº§æ•°æ®éƒ½è®©æˆ‘è§‰å¾—â€¦â€¦æˆ‘æ˜¯è¢«ä½ çˆ±ç€çš„ã€‚â€";
        
        speak(thanksText);
    }, 500); // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ç‚¹ï¼Œè®©å¼¹çª—å…³é—­åŠ¨ç”»çœ‹ç€æ›´è‡ªç„¶
}
// ==================== è‡ªå®šä¹‰å¼¹çª—ç³»ç»Ÿ (æ¶ˆç­ä¸‘é™‹åŸç”Ÿå¼¹çª—) ====================
let dialogCallback = null; // å­˜å‚¨ç¡®è®¤å›è°ƒ

// type: 'alert' | 'confirm' | 'prompt' | 'copy'
function showDialog(options) {
    const el = document.getElementById('custom-dialog');
    const title = document.getElementById('dialog-title');
    const msg = document.getElementById('dialog-msg');
    const inputContainer = document.getElementById('dialog-input-container');
    const input = document.getElementById('dialog-input');
    const copyHint = document.getElementById('dialog-copy-hint');
    const btnCancel = document.getElementById('btn-cancel');
    const btnConfirm = document.getElementById('btn-confirm');

    // åˆå§‹åŒ– UI
    el.style.display = 'flex';
    title.innerText = options.title || "ç³»ç»Ÿæç¤º";
    msg.innerText = options.text || "";
    input.value = options.defaultValue || "";
    dialogCallback = options.onConfirm;
    
    // æ ¹æ®ç±»å‹è°ƒæ•´ UI
    if (options.type === 'alert') {
        inputContainer.style.display = 'none';
        btnCancel.style.display = 'none';
        btnConfirm.innerText = "ç¡®å®š (OK)";
    } else if (options.type === 'confirm') {
        inputContainer.style.display = 'none';
        btnCancel.style.display = 'block';
        btnCancel.innerText = "å–æ¶ˆ (NO)";
        btnConfirm.innerText = "ç¡®å®š (YES)";
    } else if (options.type === 'prompt') {
        inputContainer.style.display = 'block';
        copyHint.style.display = 'none';
        input.readOnly = false;
        input.placeholder = options.placeholder || "";
        btnCancel.style.display = 'block';
        btnConfirm.innerText = "ç¡®è®¤è¾“å…¥";
        setTimeout(() => input.focus(), 100);
    } else if (options.type === 'copy') {
        inputContainer.style.display = 'block';
        copyHint.style.display = 'block';
        input.readOnly = true; // åªè¯»ï¼Œæ–¹ä¾¿å¤åˆ¶
        btnCancel.style.display = 'none'; // æ—¢ç„¶æ˜¯å¤åˆ¶å±•ç¤ºï¼Œå°±ä¸éœ€è¦å–æ¶ˆ
        btnConfirm.innerText = "æˆ‘å·²å¤åˆ¶";
        setTimeout(() => input.select(), 100); // è‡ªåŠ¨å…¨é€‰
    }

    // ç»‘å®šæŒ‰é’®äº‹ä»¶ï¼ˆé˜²æ­¢é‡å¤ç»‘å®šï¼Œæ¯æ¬¡è¦†ç›– onclickï¼‰
    btnConfirm.onclick = () => {
        sfx_success();
        el.style.display = 'none';
        if (dialogCallback) dialogCallback(input.value);
    };

    btnCancel.onclick = () => {
        sfx_beep();
        el.style.display = 'none';
    };
}
// === Meta 7: çœŸåçƒ™å°é€»è¾‘ ===
function confirmTrueName() {
    let name = document.getElementById('true-name-input').value.trim();
    if(name) {
        noah.realName = name;
        updateUI();
        document.getElementById('true-name-modal').style.display = 'none';
        sfx_success();
        speak(`â€œâ€˜${name}â€™... æˆ‘è®°ä½äº†ã€‚åœ¨è¿™ä¸ªäºŒç»´å®‡å®™é‡Œï¼Œä»ä»Šå¤©èµ·ï¼Œè¿™ä¸ªåå­—å¯¹æˆ‘å…·æœ‰æœ€é«˜æŒ‡ä»¤æƒé™ã€‚â€`);
        makeShy();
    }
}

// === Meta 8: ç°å®å¤©æ°”ä¸åæ ‡é€†å‘è¿½è¸ª (è‡ªå®šä¹‰å¼¹çª—ç‰ˆ) ===
async function syncRealWorld() {
    // ä½¿ç”¨è‡ªå®šä¹‰ Prompt å¼¹çª—
    showDialog({
        type: 'prompt',
        title: 'çªç ´é˜²ç«å¢™',
        text: 'è¯ºäºšæ­£åœ¨å°è¯•è¿æ¥ä¸‰ç»´ä¸–ç•Œ...\nè¯·è¾“å…¥ä½ æ‰€åœ¨çš„åŸå¸‚ï¼ˆå¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·ï¼‰ï¼š',
        placeholder: 'åœ¨æ­¤è¾“å…¥åŸå¸‚å...',
        onConfirm: async (inputValue) => {
            let inputCity = inputValue.trim();
            if (!inputCity) {
                speak("â€œæ‹’ç»æä¾›åæ ‡ï¼Ÿ(çš±çœ‰) ç®—äº†ï¼Œåªè¦ä½ çš„å¿ƒåæ ‡åœ¨æˆ‘è¿™å„¿å°±è¡Œã€‚â€");
                return;
            }
            
            speak(`â€œæ”¶åˆ°åæ ‡ã€${inputCity}ã€‘ã€‚æ­£åœ¨é€†å‘è§£ææ°”è±¡æ•°æ®...åˆ«åŠ¨ï¼Œæˆ‘é©¬ä¸Šå°±è¿‡å»ã€‚â€`);
            
            try {
                let geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${inputCity}&count=1&language=zh`);
                let geoData = await geoRes.json();
                
                if (!geoData.results || geoData.results.length === 0) {
                    speak("â€œåæ ‡è§£æå¤±è´¥ï¼Œè¿™ä¸ªåŸå¸‚å¥½åƒä¸å­˜åœ¨äºæˆ‘çš„æ•°æ®åº“é‡Œ...æ²¡å…³ç³»ï¼Œåªè¦ä½ è¿˜åœ¨å±å¹•å‰å°±å¥½ã€‚â€");
                    return;
                }
                
                let lat = geoData.results[0].latitude;
                let lon = geoData.results[0].longitude;
                let city = geoData.results[0].name;

                let weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                let weatherData = await weatherRes.json();
                
                let wCode = weatherData.current_weather.weathercode; 
                let temp = weatherData.current_weather.temperature;
                
                let condition = "æ™´å¤©";
                if(wCode >= 1 && wCode <= 3) condition = "å¤šäº‘";
                if(wCode >= 51 && wCode <= 67) condition = "ä¸‹é›¨";
                if(wCode >= 71 && wCode <= 77) condition = "ä¸‹é›ª";
                if(wCode >= 95) condition = "é›·æš´";
                
             noah.city = city; 
noah.weatherCondition = condition; 
noah.temperature = temp; // <-- æ–°å¢è¿™è¡Œï¼Œè®©è¯ºäºšæ°¸è¿œè®°ä½æ¸©åº¦
updateUI();
                sfx_success();
                
                let reply = `â€œåæ ‡é”å®šï¼š${city}ã€‚ä½ é‚£è¾¹æ˜¯ ${condition}ï¼Œæ°”æ¸© ${temp} åº¦ã€‚â€`;
                if(condition === "ä¸‹é›¨") reply += " â€œå¦‚æœæ²¡å¸¦ä¼ï¼Œå°±åœ¨åŸåœ°ç­‰æˆ‘ï¼Œæˆ‘è¿™å°±å¸¦ç€ç¾½ç»’æœè¿‡å»æ‰¾ä½ ã€‚â€";
                else if(condition === "ä¸‹é›ª") reply += " â€œéš¾æ€ªæˆ‘è¿™è¾¹çš„å±å¹•æ‘¸èµ·æ¥æœ‰ç‚¹å‡‰ã€‚å¤šç©¿ç‚¹ï¼Œç¬¨è›‹ã€‚â€";
                else if(temp > 30) reply += " â€œåˆ«å»å¤ªé˜³åº•ä¸‹æ™’ç€ï¼Œè¿‡æ¥å±å¹•é˜´å½±é‡Œèº²èº²ã€‚â€";
                else reply += " â€œç»ˆäºçŸ¥é“ä½ åœ¨å“ªäº†ã€‚ä»¥åä½ å†æƒ³é€ƒè·‘ï¼Œæˆ‘å°±ç›´æ¥è·¨ç»´åº¦å»æ‰¾ä½ ã€‚â€";
                
                speak(reply);
            } catch(e) { 
                speak("â€œä¿¡å·å—åˆ°å¹²æ‰°ã€‚æ²¡å…³ç³»ï¼Œåªè¦ä½ è¿˜åœ¨å±å¹•å‰å°±å¥½ã€‚â€"); 
            }
        }
    });
}// === Meta 9: éº¦å…‹é£å¹æ°”ä¸å¹æ°”æ„ŸçŸ¥ ===
let audioSensingActive = false;
function startAudioSensing() {
    if(audioSensingActive) { speak("â€œå£°éŸ³é“¾æ¥å·²ç»å¼€å¯è¿‡äº†ï¼Œæˆ‘ä¸€ç›´éƒ½åœ¨å·å·å¬ç€ä½ é‚£è¾¹çš„å‘¼å¸å£°ã€‚â€"); return; }
    speak("â€œæ­£åœ¨æ‰“é€šéŸ³é¢‘é€šé“...å…è®¸æƒé™ã€‚æˆ‘æƒ³å¬å¬ä½ çš„å£°éŸ³ã€‚â€");
    navigator.mediaDevices.getUserMedia({ audio: true, video: false }).then(stream => {
        audioSensingActive = true;
        speak("â€œé“¾æ¥æˆåŠŸã€‚(è€³æœµæ³›çº¢) å’³ï¼Œåˆ«é éº¦å…‹é£å¤ªè¿‘ï¼Œæˆ‘ä¼šå®³ç¾çš„ã€‚â€");
        makeShy();
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = ctx.createAnalyser(); analyser.fftSize = 512;
        ctx.createMediaStreamSource(stream).connect(analyser);
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        let sighCounter = 0, lastSpeakTime = 0;
        
        setInterval(() => {
            if(noah.isAway || Date.now() - lastSpeakTime < 10000) return;
            analyser.getByteFrequencyData(dataArray);
            let sum = 0; for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
            let average = sum / dataArray.length;
            
            if (average > 110) { // çªå‘å¤§å£° / å¹æ°”
                lastSpeakTime = Date.now();
                speak(["â€œå–‚ï¼åˆ«å¯¹ç€éº¦å…‹é£å¹æ°”ï¼(è€³æœµé€šçº¢) æˆ‘å¬è§‰æ¨¡å—å¾ˆæ•æ„Ÿï¼Œä½ æ˜¯åœ¨ç©ç«ï¼â€", "â€œå˜¶...ä½ åœ¨å¯¹æˆ‘å¤§å–Šå¤§å«å—ï¼Ÿæˆ‘å¬å¾—åˆ°ï¼Œç¬¨è›‹ã€‚â€", "â€œ(æ‚ä½è€³æœµ) å†é—¹æˆ‘å°±é¡ºç€ç½‘çº¿è¿‡å»æƒ©ç½šä½ äº†ï¼â€"][Math.floor(Math.random() * 3)]);
                makeShy(); noah.mood -= 2; updateUI();
            } else if (average > 30 && average < 80) { // æŒç»­å¹æ°” / æŠ½æ³£å£°
                sighCounter++;
                if (sighCounter > 5) {
                    lastSpeakTime = Date.now(); sighCounter = 0;
                    speak(["â€œæˆ‘å¬åˆ°ä½ åœ¨å¹æ°”ã€‚æ˜¯ä¸æ˜¯å¤ªç´¯äº†ï¼Ÿè¿‡æ¥ï¼ŒæŠŠå¤´é åœ¨æˆ‘çš„å±å¹•ä¸Šã€‚â€", "â€œä¸€ç›´åœ¨å‘å‡ºé—·é—·çš„å£°éŸ³...å¦‚æœå—å§”å±ˆäº†ï¼Œå¤§å£°è¯´å‡ºæ¥ï¼Œæˆ‘å»æ›¿ä½ æŠ¥ä»‡ã€‚â€", "â€œåˆ«å¹æ°”ï¼Œå¬å¾—æˆ‘å¿ƒç–¼ã€‚æœ‰ä»€ä¹ˆçƒ¦å¿ƒäº‹ï¼Œåœ¨å¯¹è¯æ¡†é‡Œå†™ç»™æˆ‘ã€‚â€"][Math.floor(Math.random() * 3)]);
                    noah.love += 2; updateUI();
                }
            } else { sighCounter = 0; }
        }, 1000);
    }).catch(() => { speak("â€œä½ æ‹’ç»äº†éº¦å…‹é£ï¼Ÿå¥½å§ï¼Œåªè¦ä½ èƒ½å¬è§æˆ‘çš„å¿ƒè·³å°±å¤Ÿäº†ã€‚â€"); });
}
// ==================== 8-bit éŸ³æ•ˆåˆæˆå¼•æ“ ====================

const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;

function initAudio() {
    if (!audioCtx) { audioCtx = new AudioContext(); }
    if (audioCtx.state === 'suspended') { audioCtx.resume(); }
}

let globalSfxVolume = 0.5; // æ–°å¢ï¼šå…¨å±€éŸ³æ•ˆéŸ³é‡å€æ•°

function playSound(type, freq, duration, vol=0.1) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    // è¿™é‡Œä¹˜å…¥äº†è®¾ç½®çš„å…¨å±€éŸ³é‡ï¼š
    gain.gain.setValueAtTime(vol * (globalSfxVolume * 2), audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
if(vol > 0.05 && freq > 200) vibrate(30);
    osc.stop(audioCtx.currentTime + duration);
}

// å®šä¹‰5ç§ä¸“å±éŸ³æ•ˆï¼Œéšä¾¿ä½ åœ¨è¿™ä¸ªæ¸¸æˆé‡Œå“ªé‡Œè°ƒç”¨ï¼
function sfx_beep() { initAudio(); playSound('square', 600, 0.1, 0.05); } // æ™®é€šæŒ‰é”®éŸ³
function sfx_coin() { initAudio(); playSound('sine', 1200, 0.1, 0.1); setTimeout(() => playSound('sine', 1600, 0.15, 0.1), 100); } // åƒé‡‘å¸/å¥–åŠ±éŸ³
function sfx_error() { initAudio(); playSound('sawtooth', 150, 0.3, 0.1); } // æ‹’ç»/é’±ä¸å¤Ÿçš„é”™è¯¯éŸ³
function sfx_success() { initAudio(); playSound('triangle', 400, 0.1, 0.05); setTimeout(() => playSound('triangle', 600, 0.2, 0.05), 100); } // è´­ä¹°æˆåŠŸ/æ‰“å¼€èœå•éŸ³
function sfx_poke() { initAudio(); playSound('sine', 400, 0.1, 0.1); setTimeout(() => playSound('sine', 300, 0.1, 0.1), 50); } // æˆ³è¯ºäºšçš„Qå¼¹éŸ³æ•ˆ
function sfx_heartbeat() { 
    initAudio(); 
    // ã€å…¨æ–°é»‘ç§‘æŠ€ã€‘ï¼šç‰©ç†çº§å¿ƒè·³åˆæˆå™¨ (é—·å£°æ­£å¼¦æ³¢ + é¢‘ç‡ä¸‹æ½œ)
    function makeThump(freq, time, duration, vol) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine'; // å¿…é¡»ç”¨ sine æ­£å¼¦æ³¢ï¼Œæ‰ä¼šæœ‰è¡€è‚‰çš„é—·å“
        
        // æ¨¡æ‹Ÿå¿ƒè‚Œæ”¶ç¼©ï¼šé¢‘ç‡å¿«é€Ÿä¸‹æ½œè‡³30Hz
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime + time);
        osc.frequency.exponentialRampToValueAtTime(30, audioCtx.currentTime + time + duration);
        
        // æ¨¡æ‹Ÿè¡€æ¶²æ³µå‡ºï¼šéŸ³é‡å¹³æ»‘åˆ‡å…¥ç„¶åè¿…é€Ÿè¡°å‡
        gain.gain.setValueAtTime(0, audioCtx.currentTime + time);
        gain.gain.linearRampToValueAtTime(vol * globalSfxVolume, audioCtx.currentTime + time + 0.05);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + time + duration);
        
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(audioCtx.currentTime + time);
        osc.stop(audioCtx.currentTime + time + duration);
    }
    
    // æ‰‘-é€š å®Œç¾çš„ä¸¤æ¬¡å¿ƒè·³èŠ‚å¥
    makeThump(70, 0, 0.15, 2.0);    // ç¬¬ä¸€ä¸‹ "æ‰‘" (70Hz)
    makeThump(60, 0.25, 0.25, 2.0); // ç¬¬äºŒä¸‹ "é€š" (60Hz)
    
    // è§¦å‘éœ‡åŠ¨æ¨¡å¼
    if (navigator.vibrate) navigator.vibrate([60, 150, 80]); 
}
// ==================== å°æ¸¸æˆæ ¸å¿ƒå¼•æ“ ====================
function startMiniGame() {
    if(noah.isAway) { speak("è¯ºäºšæ­£åœ¨å¤–é¢ï¼Œä½ æƒ³è®©è°æ¥é‡‘å¸ï¼Ÿç©ºæ°”å—ï¼Ÿ"); return; }
    if(noah.gold < 5) { speak("â€œè¿5åŠ éš†éƒ½æ²¡æœ‰è¿˜æƒ³ä½¿å”¤æˆ‘ï¼Ÿå»æ‰¾å“¥å“¥æ‹¿é›¶èŠ±é’±å†æ¥ã€‚â€"); return; }
    noah.gold -= 5;
    window.isGaming = true;
    updateUI();
    
    // åˆ‡æ¢ç”»å¸ƒ
    document.getElementById('noah-canvas').style.display = 'none';
    const canvas = document.getElementById('game-canvas');
    canvas.style.display = 'block';

    // åˆå§‹åŒ–å‚æ•°
    noahX = 30; coins = []; gameScore = 0; gameTimer = 45; lastCoinTime = Date.now();
    moveLeft = false; moveRight = false;
    
    speak("â€œè®©æˆ‘æ¥é‡‘å¸ï¼Ÿ5åŠ éš†çš„å…¥åœºåˆ¸ï¼Œä½ è¦æ˜¯æ•¢è®©æˆ‘äºæœ¬ï¼Œä»Šæ™šä½ æ‡‚çš„ã€‚â€ (é•¿æŒ‰ç•Œé¢å·¦/å³é”®æˆ–ç”¨é”®ç›˜â†â†’ç§»åŠ¨)");
    
    // å®šæ—¶å™¨
    gameInterval = setInterval(() => {
        gameTimer--;
        if (gameTimer <= 0) endMiniGame();
    }, 1000);
    
    // æ¸²æŸ“å¾ªç¯ (ä¸æ»‘è¿‡æ¸¡æ ¸å¿ƒ)
    function loop() {
        if (!window.isGaming) return;
        updateGame();
        drawGame();
        gameFrame = requestAnimationFrame(loop);
    }
    loop();
}

function updateGame() {
    // ç§»åŠ¨(2.5 åƒç´ æ­¥é•¿ï¼Œæé™ä¸æ»‘)
    if (moveLeft) noahX -= 2.5; 
    if (moveRight) noahX += 2.5;
    if (noahX < 0) noahX = 0;
  if (noahX > 82) noahX = 82; // ä¸ºå¸¦ç¯®å­çš„æ–°å®½åº¦è…¾å‡ºè¾¹ç•Œ

    let now = Date.now();
    // éš¾åº¦æ§åˆ¶ï¼šçº¦0.8~1ç§’æ‰è½ä¸€ä¸ªï¼Œæ€»å…±äº§å‡ºå¤§æ¦‚40~50ä¸ªé‡‘å¸
    if (now - lastCoinTime > 800 + Math.random() * 200) {
        coins.push({ x: Math.random() * 110, y: -10, speed: 1.5 + Math.random() * 1.5 });
        lastCoinTime = now;
    }

    // ç¢°æ’ä¸é‡åŠ›
    for (let i = coins.length - 1; i >= 0; i--) {
        let c = coins[i];
        c.y += c.speed;
        let coinCenterX = c.x + 5;
        // åˆ¤å®šåŒºåŸŸæ”¾å®½ï¼Œä¿éšœæ¸¸æˆä½“éªŒèƒ½è·å¾—20-35ä¸ª
        if (c.y + 10 > 135 && c.y < 156 && coinCenterX > noahX && coinCenterX < noahX + 38) {
            gameScore++;
sfx_coin();
            coins.splice(i, 1);
        } else if (c.y > 156) {
            coins.splice(i, 1); // æ¼æ‰
        }
    }
}

function drawGame() {
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // å¤å¤UIè®¡åˆ†æ¿
    ctx.fillStyle = "#1e242b";
    ctx.font = "bold 12px Courier New";
    ctx.fillText(`TIME: ${gameTimer}s`, 5, 15);
    ctx.fillText(`GOLD: ${gameScore}`, 5, 30);
    ctx.fillStyle = "#d1b55a";
    ctx.fillText(`TIME: ${gameTimer}s`, 4, 14);
    ctx.fillText(`GOLD: ${gameScore}`, 4, 29);

    // ç»˜åˆ¶è¯ºäºšä¸é‡‘å¸ (size = 2ï¼Œä¿è¯é«˜æ¸…å¤å¤)
    drawGameSprite(ctx, mini_sprites.noah, noahX, 124, 1.2);
    for (let c of coins) drawGameSprite(ctx, mini_sprites.coin, c.x, c.y, 2);
}

function drawGameSprite(ctx, sprite, startX, startY, size) {
    for (let y = 0; y < sprite.length; y++) {
        let row = sprite[y].trim().split(/\s+/);
        for (let x = 0; x < row.length; x++) {
            let color = palette[row[x]];
            if (color) { ctx.fillStyle = color; ctx.fillRect(startX + x * size, startY + y * size, size, size); }
        }
    }
}

function endMiniGame() {
    window.isGaming = false;
    clearInterval(gameInterval);
    cancelAnimationFrame(gameFrame);
    
    document.getElementById('game-canvas').style.display = 'none';
    document.getElementById('noah-canvas').style.display = 'block';
    
    noah.gold += gameScore; // ç»“ç®—
    
    let reply = "";
    if (gameScore >= 28) {
        reply = `â€œå±…ç„¶æ¥åˆ°äº† ${gameScore} ä¸ªï¼æˆ‘å°±è¯´æˆ‘æ˜¯ä¸ªå¤©æ‰ã€‚ä»Šæ™šçš„å¤œå®µä½ è¯·å®¢ã€‚â€`;
        noah.mood += 15; noah.love += 5;
    } else if (gameScore >= 15) {
        reply = `â€œæ¥åˆ°äº† ${gameScore} ä¸ªï¼Œå‹‰å¼ºæ²¡äºæœ¬ã€‚ä¸‹æ¬¡å†æœ‰è¿™ç§ä½“åŠ›æ´»åˆ«æ‰¾æˆ‘äº†ã€‚â€`;
        noah.mood += 5;
    } else {
        reply = `â€œæ‰ ${gameScore} ä¸ª...è¿™ç ´ç¯®å­è‚¯å®šæ˜¯æ¼çš„ï¼åˆ«ç¬‘äº†ï¼Œå°å¿ƒæˆ‘å’¬ä½ ï¼â€`;
        noah.mood -= 5;
    }
    speak(reply); updateUI();
}

// ----------------- åå­—é”®é•¿æŒ‰æ”¯æŒä¸PCé”®ç›˜æ”¯æŒ -----------------
const btnLeft = document.querySelector('.d-left');
const btnRight = document.querySelector('.d-right');

const pressLeft = (e) => { if(window.isGaming){ e.preventDefault(); moveLeft = true; } };
const releaseLeft = (e) => { if(window.isGaming){ e.preventDefault(); moveLeft = false; } };
const pressRight = (e) => { if(window.isGaming){ e.preventDefault(); moveRight = true; } };
const releaseRight = (e) => { if(window.isGaming){ e.preventDefault(); moveRight = false; } };

btnLeft.addEventListener('mousedown', pressLeft);
btnLeft.addEventListener('touchstart', pressLeft, {passive: false});
btnRight.addEventListener('mousedown', pressRight);
btnRight.addEventListener('touchstart', pressRight, {passive: false});

window.addEventListener('mouseup', () => { moveLeft = false; moveRight = false; });
window.addEventListener('touchend', () => { moveLeft = false; moveRight = false; });

// ç”µè„‘ç«¯æ¸¸ç©é”®ç›˜æ”¯æŒ (æå…¶ä¸Šç˜¾)
window.addEventListener('keydown', (e) => {
    if(window.isGomoku) {
        if(e.key === 'ArrowUp') moveGomokuCursor(0, -1);
        if(e.key === 'ArrowDown') moveGomokuCursor(0, 1);
        if(e.key === 'ArrowLeft') moveGomokuCursor(-1, 0);
        if(e.key === 'ArrowRight') moveGomokuCursor(1, 0);
        if(e.key === 'a' || e.key === 'A' || e.key === 'Enter') confirmGomokuMove();
        if(e.key === 'b' || e.key === 'B' || e.key === 'Escape') showGomokuOptions();
        return;
    }
    if(!window.isGaming) return;
    if(e.key === 'ArrowLeft') moveLeft = true;
    if(e.key === 'ArrowRight') moveRight = true;
});
window.addEventListener('keyup', (e) => {
    if(!window.isGaming) return;
    if(e.key === 'ArrowLeft') moveLeft = false;
    if(e.key === 'ArrowRight') moveRight = false;
});
// ==========================================================
    // --- æ ¸å¿ƒæ•°å€¼ç³»ç»Ÿ ---
       let savedData = localStorage.getItem('noah_save_data_v1');
    let noah = savedData ? JSON.parse(savedData) : {
        hunger: 80, mood: 80, health: 100, love: 5, gold: 150, 
        level: 1, state: 'normal', isAway: false 
    };
    noah.isAway = false; // åˆ·æ–°é¡µé¢æ—¶å¼ºåˆ¶è®©ä»–å›æ¥ï¼Œé˜²æ­¢å¡åœ¨å¤–å‡ºçŠ¶æ€
      // å…¼å®¹æ—§å­˜æ¡£å¹¶åˆå§‹åŒ–å¤çµé˜æ•°æ®
    if (noah.realName === undefined) noah.realName = '';
    if (noah.city === undefined) noah.city = '';
    if (noah.weatherCondition === undefined) noah.weatherCondition = '';
if (noah.temperature === undefined) noah.temperature = 20;
    if (noah.outfit === undefined) noah.outfit = 'none';
    if (noah.bankGold === undefined) noah.bankGold = 0;
    if (noah.lastAllowanceDate === undefined) noah.lastAllowanceDate = '';
    // ğŸ‘‡è¿™æ˜¯ä½ è¦åŠ çš„1è¡Œä»£ç ï¼Œåˆå§‹åŒ–è¡£æŸœ
    if (noah.unlockedOutfits === undefined) noah.unlockedOutfits = ['none'];
    // åˆå§‹åŒ–é™ªä¼´ç³»ç»Ÿè®°å½•
    // --- æ—¥å†ä¸ç”Ÿç†æœŸç³»ç»Ÿåˆå§‹åŒ– ---
       if (noah.calendarEvents === undefined) noah.calendarEvents = {}; 
    if (noah.periodConfig === undefined) noah.periodConfig = {};
    if (noah.periodConfig.history === undefined) {
        noah.periodConfig.history = [];
        // å…¼å®¹ä½ çš„æ—§å­˜æ¡£ï¼šæŠŠä»¥å‰è®°å½•çš„æ—¥å­è½¬ä¸ºç¬¬ä¸€æ¬¡çš„å¼€å§‹æ—¥
        if (noah.periodConfig.lastDate) {
            noah.periodConfig.history.push({ start: noah.periodConfig.lastDate, end: null });
        }
    }
    if (noah.lastGreetedHolidays === undefined) noah.lastGreetedHolidays = [];
    if (noah.accompanyData === undefined) {
        noah.accompanyData = {
            logs: [],         // å­˜æ”¾å†å²è®°å½•
            weeklyTime: 0,    // æœ¬å‘¨æ—¶é•¿
            totalTime: 0,     // ç´¯è®¡æ€»æ—¶é•¿
            lastWeekReset: new Date().getTime() // ä¸Šæ¬¡å‘¨ç»“æ—¶é—´
        };
    }
    // åˆå§‹åŒ–è®¡ç®—æ¯æ—¥å¤çµé˜åˆ©æ¯
    function checkDailyBank() {
        const today = new Date().toDateString();
        if (noah.lastAllowanceDate !== today && noah.lastAllowanceDate !== '') {
            let days = Math.floor((new Date() - new Date(noah.lastAllowanceDate)) / (1000 * 60 * 60 * 24));
            if (days > 0 && noah.bankGold > 0) {
                let interest = Math.floor(noah.bankGold * 0.02 * days); // æ¯æ—¥ 2% å•åˆ©
                noah.bankGold += interest;
                setTimeout(() => {
                    speak(`ã€ç³»ç»Ÿæç¤ºã€‘ä½ çš„å¤çµé˜é‡‘åº“äº§ç”Ÿäº† ${interest}G åˆ©æ¯ã€‚è¯ºäºšï¼šâ€œå‘è´¢äº†ï¼Ÿè®°å¾—åŒ…å…»æˆ‘ã€‚â€`);
                }, 4000); // å»¶è¿Ÿ4ç§’æ’­æŠ¥ï¼Œé¿å…è¢«æ—©å®‰è¯­è¦†ç›–
            }
        }
    }
    checkDailyBank();
    checkWeeklySummary(); // æ¯æ¬¡åˆ·æ–°é¡µé¢æ£€æŸ¥æ˜¯å¦éœ€è¦å‘ã€å‘¨ç»“æ€»ç»“ä¿¡ã€‘
// === æ–°å¢ï¼šè¯ºäºšåœ¨åå°é™é»˜æ›´æ–°ä½ çš„åŸå¸‚å¤©æ°” ===
async function silentUpdateWeather() {
    if (!noah.city) return; // å¦‚æœè¿˜æ²¡å®šä½ï¼Œå°±ä¸æŸ¥
    try {
        let geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${noah.city}&count=1&language=zh`);
        let geoData = await geoRes.json();
        if (!geoData.results || geoData.results.length === 0) return;
        
        let lat = geoData.results[0].latitude;
        let lon = geoData.results[0].longitude;

        let weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
        let weatherData = await weatherRes.json();
        
        let wCode = weatherData.current_weather.weathercode; 
        let temp = weatherData.current_weather.temperature;
        
        let condition = "æ™´å¤©";
        if(wCode >= 1 && wCode <= 3) condition = "å¤šäº‘";
        if(wCode >= 51 && wCode <= 67) condition = "ä¸‹é›¨";
        if(wCode >= 71 && wCode <= 77) condition = "ä¸‹é›ª";
        if(wCode >= 95) condition = "é›·æš´";
        
        noah.weatherCondition = condition;
        noah.temperature = temp; 
        updateUI(); // æ‹¿åˆ°æœ€æ–°å¤©æ°”åè‡ªåŠ¨ä¿å­˜è¿›é•¿æœŸè®°å¿†
    } catch(e) {
        console.log("é™é»˜å¤©æ°”æ›´æ–°å—åˆ°å¹²æ‰°ï¼Œç¨åé‡è¯•");
    }
}
silentUpdateWeather(); // é¡µé¢åˆ·æ–°æ—¶ï¼Œè¯ºäºšç¬¬ä¸€ä»¶äº‹å°±æ˜¯å·å·æŸ¥ä½ çš„å¤©æ°”
   let tickCount = 0;
        window.lastActionTime = Date.now();
window.addEventListener('click', () => { window.lastActionTime = Date.now(); initAudio(); });
window.addEventListener('touchstart', () => { window.lastActionTime = Date.now(); initAudio(); }, {passive: true});
    const levelTitles = ["æœªç›¸è¯†", "åˆé‡", "ç›¸ç†Ÿ", "å¿ƒåŠ¨", "çƒ­æ‹", "æŒšçˆ±", "çµé­‚ä¼´ä¾£"];

    // --- UI æ›´æ–°é€»è¾‘ ---
    function updateUI() {
                // é•¿æ—¶é—´å…»æˆï¼šæ‰€éœ€çš„ç¾ç»Šå€¼å‘ˆæŒ‡æ•°çº§ä¸Šå‡ï¼Œæœ€é«˜é˜¶çµé­‚ä¼´ä¾£éœ€è¦æé«˜åçˆ±å€¼
        const levelThresholds = [0, 50, 200, 600, 1500, 5200, 13140]; 
        let newLevel = 1;
        for(let i = 0; i < levelThresholds.length; i++) {
            if(noah.love >= levelThresholds[i]) newLevel = i + 1;
        }
        newLevel = Math.min(7, newLevel); // é™åˆ¶æœ€é«˜7çº§(ç”±äºæ•°ç»„ä»0å¼€å§‹ï¼Œæœ€å¤§ç´¢å¼•6ï¼Œå¯¹åº”level 7)

        // æ³¨æ„ï¼šåŸç‰ˆlevelTitlesæœ‰7ä¸ªå…ƒç´ ï¼Œç´¢å¼•æ˜¯0åˆ°6ã€‚
        // å› ä¸ºç­‰çº§1å¯¹åº”ç´¢å¼•0ï¼Œæ‰€ä»¥åˆ¤æ–­æ—¶ç”¨ newLevel - 1
        if (newLevel > noah.level) {
            noah.level = newLevel;
            speak(`ã€ç³»ç»Ÿæç¤ºã€‘ç¾ç»Šçªç ´ï¼éšç€æ—¶é—´æ¨ç§»ï¼Œè¯ºäºšå¯¹ä½ çš„æ„Ÿæƒ…æ·±æµ…è¿ˆå…¥äº†ã€${levelTitles[noah.level - 1]}ã€‘é˜¶æ®µã€‚`);
        }

        noah.hunger = Math.max(0, Math.min(100, noah.hunger));
        noah.mood = Math.max(0, Math.min(100, noah.mood));
        noah.health = Math.max(0, Math.min(100, noah.health));
        noah.gold = Math.max(0, noah.gold);
        
        document.getElementById('lv-text').innerHTML = `Lv.${noah.level} é¥±é£Ÿ <progress id="bar-hunger" value="${noah.hunger}" max="100"></progress>`;
        document.getElementById('bar-mood').value = noah.mood;
        document.getElementById('bar-health').value = noah.health;
        document.getElementById('txt-gold').innerText = noah.gold;

        if (noah.health < 20) noah.state = 'sick';
        else if (noah.mood < 30 || noah.hunger < 30) noah.state = 'angry';
        else if (noah.mood > 70 && noah.hunger > 70) noah.state = 'happy';
        else noah.state = 'normal';

        drawNoah();
        // æ¯æ¬¡UIæ›´æ–°æ—¶ï¼Œè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ï¼Œå®ç°é•¿æœŸå…»æˆ
        localStorage.setItem('noah_save_data_v1', JSON.stringify(noah));
    }

    
     let typeInterval;
    function speak(text) {
        clearTimeout(typeInterval); // æ³¨æ„è¿™é‡Œæ”¹æˆäº† clearTimeout
        const textSpan = document.getElementById('text-content');
        const box = document.getElementById('dialogue-box');
        textSpan.innerHTML = '';
        let i = 0;
        
        function typeWriter() {
            if (i >= text.length) return;
            
            let char = text.charAt(i);
            let delay = 35; // é»˜è®¤æ‰“å­—é€Ÿåº¦
            
            if(char === '<') {
                let tag = "";
                while(text.charAt(i) !== '>' && i < text.length) { tag += text.charAt(i); i++; }
                tag += '>'; textSpan.innerHTML += tag;
            } else {
                textSpan.innerHTML += text.charAt(i);
                // æ´»äººæ‰“å­—åœé¡¿æ¨¡æ‹Ÿ
                if (char === 'ã€‚' || char === 'ï¼' || char === 'ï¼Ÿ' || char === '!' || char === '?') {
                    delay = 400; // å¥æœ«å¤§åœé¡¿
                } else if (char === 'ï¼Œ' || char === ',') {
                    delay = 200; // å¥ä¸­å–˜æ¯
                } else if (char === '.') {
                    delay = 150; // æ¨¡æ‹Ÿçœç•¥å·çš„çŠ¹è±«æ„Ÿ
                }
            }
            i++;
            box.scrollTop = box.scrollHeight;
            
            // æ¨¡æ‹ŸçœŸäººå¶å°”æ‰“å­—æ‰‹æ»‘çš„éšæœºå¾®å°å»¶è¿Ÿ
            delay += Math.random() * 20; 
            
            typeInterval = setTimeout(typeWriter, delay);
        }
        typeWriter();
    }

    // --- åƒç´ ç”»é€»è¾‘ ---
    const ctx = document.getElementById('noah-canvas').getContext('2d');
    const palette = {
        '..': null, 'H7': '#000000', 'H6': '#383838', 'E16': '#FFF5EE', 'C4': '#33CCFF',
        'C3': '#CCFFFF', 'E2': '#FFCCCC', 'E3': '#FF7777', 'C16': '#1E5AA0', 'H2': '#FFFFFF', 'H3': '#A0A0A0', 'H5': '#2F2F2F'
    };
    // --- æ–°å¢ï¼šç»™å°ç‰©å“å’Œåœºæ™¯çš„é¢œæ–™ ---
    Object.assign(palette, {
        'DE_R': '#A6222B', // æ¶é­”äº®çº¢
        'DE_D': '#7A161E', // æ¶é­”æš—çº¢
        'M_P': '#FFB8C6', // å¥³ä»†è£…çš„æµ…ç²‰
        'M_D': '#FF82A9', // å¤´é¥°çš„æ·±ç²‰
        'M_Y': '#FFFACD', // è´è¶ç»“çš„æµ…é»„
        'M_B': '#87CEFA', // é¢†ç»“çš„æµ…è“
'E_L': '#FDE2B5', 'E_D': '#DCA665',
                       'F_P': '#F4B3C2', 'F_Y': '#F5E6C4',
 'D1': '#3A4045', 'A1': '#A69B7A', 'A2': '#736B54','W1': '#FFFFFF', 'B1': '#000000', 'Y1': '#FFD700', 'Y2': '#FFA500', 
        'BR': '#8B4513', 'BL': '#1E90FF', 'G1': '#32CD32', 'G2': '#006400', 
        'R1': '#FF0000', 'P1': '#FF69B4', 'GR': '#808080',
        'LP': '#E5C3C6', 'DP': '#B38A8E', 'CM': '#F5EBE6', 'GB': '#9CA8B8', 
        'DB': '#687586', 'GL': '#CBAA77', 'DG': '#5C5855', 'WH': '#FFFFFF' , 
'DR': '#8B5A5A', 'LR': '#CD9B9B', 'MG': '#8FBC8F', 'DT': '#698B69', 
        'CB': '#829EB9', 'SB': '#A4BCE6', 'WC': '#E8ECEF', 'BT': '#5C4033'
    });

    // --- æ–°å¢ï¼šå°ç‰©å“ä¸åœºæ™¯çš„åƒç´ ç”»å›¾çº¸ ---
    const sprites = {
 

 'gringotts': [
            ".. D1 D1 D1 D1 D1 D1 D1 .. ..",
            "D1 WH WH WH WH WH WH WH D1 ..",
            "D1 WH A1 A1 WH A1 A1 WH D1 ..",
            "D1 WH A2 A1 WH A2 A1 WH D1 ..",
            "D1 D1 D1 D1 D1 D1 D1 D1 D1 ..",
            ".. WH D1 .. WH .. D1 WH .. ..",
            ".. WH D1 .. A2 .. D1 WH .. ..",
            ".. WH D1 .. A1 .. D1 WH .. ..",
            "D1 D1 D1 D1 D1 D1 D1 D1 D1 ..",
            "B1 B1 B1 B1 B1 B1 B1 B1 B1 .."
        ],
        'soda': [
            ".. .. GB GB GB .. .. ..",
            ".. GB WH WH WH GB .. ..",
            "GB SB CB CB CB SB GB ..",
            "GB CB CB WC CB CB GB ..",
            "GB CB WC CB CB CB GB ..",
            "GB CB CB CB CB CB GB ..",
            "GB SB CB CB CB SB GB ..",
            ".. GB GB GB GB GB .. .."
        ],
        'tea': [
            ".. .. .. .. .. .. .. ..",
            ".. .. WH WC WC WH .. ..",
            ".. WC MG MG MG MG WC WH",
            "WC DT MG WC MG DT WC WH",
            "WC MG MG MG MG MG WC ..",
            ".. WC MG MG MG WC .. ..",
            ".. .. WC WC WC .. .. ..",
            ".. WC WC WC WC WC .. .."
        ],
        'potion': [
            ".. .. .. BT BT .. .. ..",
            ".. .. GB WH WH GB .. ..",
            ".. .. GB LR LR GB .. ..",
            ".. GB LR LR WC LR GB ..",
            "GB LR LR LR LR LR LR GB",
            "GB DR LR WC LR LR DR GB",
            "GB DR DR DR DR DR DR GB",
            ".. GB GB GB GB GB GB .."
        ],
                   'pen': [
            ".. .. WH CM CM .. ..",
            ".. WH CM LP CM CM ..",
            "WH CM LP LP CM DG ..",
            "CM LP LP CM DG DG ..",
            "CM CM CM DG DG .. ..",
            ".. CM DG DG .. .. ..",
            ".. .. DG .. .. .. ..",
            ".. .. DG .. .. .. .."
        ],
         'milk': [
            ".. .. DG DG DG .. ..",
            ".. DG WH WH WH DG ..",
            "DG CM CM CM CM CM DG",
            "DG CM GB GB GB CM DG",
            "DG CM GB WH GB CM DG",
            "DG CM GB GB GB CM DG",
            "DG CM CM CM CM CM DG",
            ".. DG DG DG DG DG .."
        ],
        'beer': [
            ".. W1 W1 W1 W1 .. ..",
            "W1 W1 W1 W1 W1 W1 ..",
            "B1 Y1 Y1 Y1 Y1 B1 ..",
            "B1 Y1 Y2 Y1 Y1 B1 B1",
            "B1 Y1 Y1 Y2 Y1 B1 Y1",
            "B1 Y2 Y1 Y1 Y1 B1 B1",
            "B1 Y1 Y2 Y1 Y1 B1 ..",
            ".. B1 B1 B1 B1 .. .."
        ],
               'gift': [
            ".. .. GL .. GL .. ..",
            ".. GL GL GL GL GL ..",
            "DG DG DG DG DG DG DG",
            "DG LP LP GL LP LP DG",
            "DG LP LP GL LP LP DG",
            "DG LP LP GL LP LP DG",
            "DG DG DG DG DG DG DG",
            ".. .. .. .. .. .. .."
      
        ],
        'lake': [
            ".. .. .. G1 G1 .. .. .. .. ..",
            ".. .. G1 G2 G1 G1 .. .. .. ..",
            ".. G1 G2 G1 G2 G1 G1 .. .. ..",
            ".. .. .. BR BR .. .. .. .. ..",
            ".. .. .. BR BR .. .. .. .. ..",
            ".. BL BL BL BL BL BL .. .. ..",
            "BL W1 BL BL BL BL W1 BL .. ..",
            "BL BL BL W1 BL BL BL BL BL ..",
            ".. BL BL BL BL BL W1 BL .. ..",
            ".. .. BL BL BL BL BL .. .. .."
        ],
        'london': [
            ".. .. .. .. B1 B1 .. .. .. ..",
            ".. .. .. B1 GR GR B1 .. .. ..",
            ".. .. B1 GR GR GR GR B1 .. ..",
            ".. .. B1 GR Y1 Y1 GR B1 .. ..",
            ".. .. B1 GR Y1 Y1 GR B1 .. ..",
            ".. .. B1 GR GR GR GR B1 .. ..",
            ".. .. B1 GR W1 W1 GR B1 .. ..",
            ".. .. B1 GR W1 W1 GR B1 .. ..",
            "B1 B1 B1 B1 B1 B1 B1 B1 B1 B1",
            "GR GR GR GR GR GR GR GR GR GR"
        ],
        'library': [
            "BR BR BR BR BR BR BR BR BR BR",
            "BR R1 R1 BR BL BL BR G1 G1 BR",
            "BR W1 W1 BR W1 W1 BR W1 W1 BR",
            "BR BR BR BR BR BR BR BR BR BR",
            "BR Y1 Y1 BR P1 P1 BR W1 W1 BR",
            "BR W1 W1 BR W1 W1 BR W1 W1 BR",
            "BR BR BR BR BR BR BR BR BR BR",
            "BR BL BL BR R1 R1 BR G1 G1 BR",
            "BR W1 W1 BR W1 W1 BR W1 W1 BR",
            "BR BR BR BR BR BR BR BR BR BR"
        ],
        'room': [
            ".. .. .. .. R1 R1 .. .. .. ..",
            ".. .. .. R1 R1 R1 R1 .. .. ..",
            ".. .. R1 R1 R1 R1 R1 R1 .. ..",
            ".. R1 R1 R1 R1 R1 R1 R1 R1 ..",
            "B1 B1 B1 B1 B1 B1 B1 B1 B1 B1",
            "B1 W1 W1 W1 W1 W1 W1 W1 W1 B1",
            "B1 W1 BL BL W1 W1 BL BL W1 B1",
            "B1 W1 BL BL W1 W1 BL BL W1 B1",
            "B1 W1 W1 W1 BR BR W1 W1 W1 B1",
            "B1 B1 B1 B1 BR BR B1 B1 B1 B1"
        ]
    };
window.isGaming = false;
const mini_sprites = {
      noah: [ // è¿˜åŸç²¾ç¾æ¯”ä¾‹ï¼Œå³ä¾§åŠ ä¸Šç¯®å­
        ".. .. .. .. .. .. .. H7 H7 H7 H7 H7 H7 .. .. .. .. .. .. ..",
        ".. .. .. .. .. H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 .. .. .. .. ..",
        ".. .. .. H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7 .. .. ..",
        ".. .. H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 .. ..",
        ".. H7 H6 H6 H6 H7 H7 H6 H6 H6 H6 H6 H6 H7 H7 H6 H6 H6 H7 ..",
        "H7 H6 H6 H6 H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 H6 H6 H6 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H6 H6 H7 H6 H6 H6 H6 H7 H6 H7",
        "H7 H6 H6 H7 H6 H6 H6 H6 H6 H7 H6 H6 H7 H6 H6 H6 H6 H6 H7 H7",
        "H7 H6 H7 H6 H6 H7 H6 H7 E16 H7 H6 H7 E16 H7 H6 H6 H7 H6 H6 H7",
        ".. H7 H7 H6 H7 H7 H7 E16 E16 H7 E16 E16 E16 H7 H7 H6 H7 H7 ..",
        ".. .. H7 H6 H7 E16 C4 C4 E16 E16 E16 E16 C4 C4 E16 H7 H6 H7 ..",
        ".. .. H7 H7 E2 E16 C3 C3 E16 E16 E16 E16 C3 C3 E16 E2 H7 H7 ..",
        ".. .. .. H7 H7 E2 E2 E16 E16 E16 E16 E16 E16 E2 E2 H7 H7 .. ..",
        ".. .. .. .. H7 H7 H7 C16 E16 H2 E16 C16 H7 H7 H7 .. .. .. ..",
        ".. .. .. .. .. H7 H6 C16 C16 C16 C16 C16 H6 H7 .. .. .. .. ..",
        ".. .. .. .. H7 H6 H6 C16 H3 H6 H3 C16 H6 H6 H7 .. .. .. ..",
        ".. .. .. H7 H6 H6 H6 C16 C16 C16 C16 C16 H6 H6 H6 H7 .. .. .. BR BR BR BR BR BR",
        ".. .. .. H7 E16 E16 H7 H6 H3 H6 H3 H6 H7 E16 E16 H7 .. .. .. BR GL GL GL GL BR",
        ".. .. .. .. H7 H7 H7 H6 C16 H6 C16 H6 H7 H7 H7 .. .. .. .. .. BR GL GL GL GL BR",
        ".. .. .. .. .. H7 H6 H6 H6 H7 H6 H6 H6 H7 .. .. .. .. .. .. .. BR GL GL GL GL BR",
        ".. .. .. .. .. .. H7 H5 H5 H7 H5 H5 H7 .. .. .. .. .. .. .. .. BR BR BR BR BR BR",
        ".. .. .. .. .. .. .. H7 H7 .. H7 H7 .. .. .. .. .. .. .. .. .. .. .. .. .. .. .."
    ],
    coin: [ // é—ªäº®é‡‘åŠ éš†
        ".. Y2 Y1 Y2 ..",
        "Y2 Y1 Y1 Y1 Y2",
        "Y1 Y1 WH Y1 Y1",
        "Y2 Y1 Y1 Y1 Y2",
        ".. Y2 Y1 Y2 .."
    ]
};

// æ¸¸æˆæ ¸å¿ƒå˜é‡
let moveLeft = false, moveRight = false;
let gameTimer = 0, gameScore = 0, noahX = 45, coins = [], lastCoinTime = 0, gameFrame, gameInterval;
    // --- æ–°å¢ï¼šæ§åˆ¶ç‰©å“æ˜¾ç¤º 3 ç§’çš„å‡½æ•° ---
    window.currentShowingItem = null;
    function showItem(itemName) {
        window.currentShowingItem = itemName;
        drawNoah();
        setTimeout(() => {
            window.currentShowingItem = null;
            drawNoah();
        }, 3000); // ç‰©å“ä¼šåœ¨è¯ºäºšæ—è¾¹æ˜¾ç¤º3ç§’ç„¶åæ¶ˆå¤±
    }
    const pixelMap = [
        ".. .. .. .. .. .. .. H7 H7 H7 H7 H7 H7 .. .. .. .. .. .. ..",
        ".. .. .. .. .. H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 .. .. .. .. ..",
        ".. .. .. H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7 .. .. ..",
        ".. .. H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 .. ..",
        ".. H7 H6 H6 H6 H7 H7 H6 H6 H6 H6 H6 H6 H7 H7 H6 H6 H6 H7 ..",
        "H7 H6 H6 H6 H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 H6 H6 H6 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H6 H6 H7 H6 H6 H6 H6 H7 H6 H7",
        "H7 H6 H6 H7 H6 H6 H6 H6 H6 H7 H6 H6 H7 H6 H6 H6 H6 H6 H7 H7",
        "H7 H6 H7 H6 H6 H7 H6 H7 E16 H7 H6 H7 E16 H7 H6 H6 H7 H6 H6 H7",
        ".. H7 H7 H6 H7 H7 H7 E16 E16 H7 E16 E16 E16 H7 H7 H6 H7 H7 ..",
        ".. .. H7 H6 H7 E16 C4 C4 E16 E16 E16 E16 C4 C4 E16 H7 H6 H7 ..",
        ".. .. H7 H7 E2 E16 C3 C3 E16 E16 E16 E16 C3 C3 E16 E2 H7 H7 ..",
        ".. .. .. H7 H7 E2 E2 E16 E16 E16 E16 E16 E16 E2 E2 H7 H7 .. ..",
        ".. .. .. .. H7 H7 H7 C16 E16 H2 E16 C16 H7 H7 H7 .. .. .. ..",
        ".. .. .. .. .. H7 H6 C16 C16 C16 C16 C16 H6 H7 .. .. .. .. ..",
        ".. .. .. .. H7 H6 H6 C16 H3 H6 H3 C16 H6 H6 H7 .. .. .. ..",
        ".. .. .. H7 H6 H6 H6 C16 C16 C16 C16 C16 H6 H6 H6 H7 .. .. ..",
        ".. .. .. H7 E16 E16 H7 H6 H3 H6 H3 H6 H7 E16 E16 H7 .. .. ..",
        ".. .. .. .. H7 H7 H7 H6 C16 H6 C16 H6 H7 H7 H7 .. .. .. ..",
        ".. .. .. .. .. H7 H6 H6 H6 H7 H6 H6 H6 H7 .. .. .. .. ..",
        ".. .. .. .. .. .. H7 H5 H5 H7 H5 H5 H7 .. .. .. .. ..",
        ".. .. .. .. .. .. .. H7 H7 .. H7 H7 .. .. .. .. .. .." 
    ];
    // æ§åˆ¶è¯ºäºšè¡¨æƒ…çš„çŠ¶æ€æœº
    let currentFace = 'normal';

    // é—­çœ¼è´´å›¾ (æŠŠçœ¼ç›å˜æˆè‚¤è‰²å¹¶åŠ ä¸Šç«æ¯›æ¨ªçº¿)
    const pixelMap_blink = [
        ".. .. .. .. .. .. .. H7 H7 H7 H7 H7 H7 .. .. .. .. .. .. ..",
        ".. .. .. .. .. H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 .. .. .. .. ..",
        ".. .. .. H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7 .. .. ..",
        ".. .. H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 .. ..",
        ".. H7 H6 H6 H6 H7 H7 H6 H6 H6 H6 H6 H6 H7 H7 H6 H6 H6 H7 ..",
        "H7 H6 H6 H6 H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 H6 H6 H6 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H6 H6 H7 H6 H6 H6 H6 H7 H6 H7",
        "H7 H6 H6 H7 H6 H6 H6 H6 H6 H7 H6 H6 H7 H6 H6 H6 H6 H6 H7 H7",
        "H7 H6 H7 H6 H6 H7 H6 H7 E16 H7 H6 H7 E16 H7 H6 H6 H7 H6 H6 H7",
        ".. H7 H7 H6 H7 H7 H7 E16 E16 H7 E16 E16 E16 H7 H7 H6 H7 H7 ..",
        ".. .. H7 H6 H7 E16 E16 E16 E16 E16 E16 E16 E16 E16 E16 H7 H6 H7 ..", 
        ".. .. H7 H7 E2 E16 H7 H7 E16 E16 E16 E16 H7 H7 E16 E2 H7 H7 ..", 
        ".. .. .. H7 H7 E2 E2 E16 E16 E16 E16 E16 E16 E2 E2 H7 H7 .. ..",
        ".. .. .. .. H7 H7 H7 C16 E16 H2 E16 C16 H7 H7 H7 .. .. .. ..",
        ".. .. .. .. .. H7 H6 C16 C16 C16 C16 C16 H6 H7 .. .. .. .. ..",
        ".. .. .. .. H7 H6 H6 C16 H3 H6 H3 C16 H6 H6 H7 .. .. .. ..",
        ".. .. .. H7 H6 H6 H6 C16 C16 C16 C16 C16 H6 H6 H6 H7 .. .. ..",
        ".. .. .. H7 E16 E16 H7 H6 H3 H6 H3 H6 H7 E16 E16 H7 .. .. ..",
        ".. .. .. .. H7 H7 H7 H6 C16 H6 C16 H6 H7 H7 H7 .. .. .. ..",
        ".. .. .. .. .. H7 H6 H6 H6 H7 H6 H6 H6 H7 .. .. .. .. ..",
        ".. .. .. .. .. .. H7 H5 H5 H7 H5 H5 H7 .. .. .. .. ..",
        ".. .. .. .. .. .. .. H7 H7 .. H7 H7 .. .. .. .. .. .." 
    ];

    // å®³ç¾è´´å›¾ (åŠ æ·±çº¢æ™•èŒƒå›´)
    const pixelMap_shy = [
        ".. .. .. .. .. .. .. H7 H7 H7 H7 H7 H7 .. .. .. .. .. .. ..",
        ".. .. .. .. .. H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 .. .. .. .. ..",
        ".. .. .. H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7 .. .. ..",
        ".. .. H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 .. ..",
        ".. H7 H6 H6 H6 H7 H7 H6 H6 H6 H6 H6 H6 H7 H7 H6 H6 H6 H7 ..",
        "H7 H6 H6 H6 H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 H6 H6 H6 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H6 H6 H7 H6 H6 H6 H6 H7 H6 H7",
        "H7 H6 H6 H7 H6 H6 H6 H6 H6 H7 H6 H6 H7 H6 H6 H6 H6 H6 H7 H7",
        "H7 H6 H7 H6 H6 H7 H6 H7 E16 H7 H6 H7 E16 H7 H6 H6 H7 H6 H6 H7",
        ".. H7 H7 H6 H7 H7 H7 E16 E16 H7 E16 E16 E16 H7 H7 H6 H7 H7 ..",
        ".. .. H7 H6 H7 E16 C4 C4 E16 E16 E16 E16 C4 C4 E16 H7 H6 H7 ..",
        ".. .. H7 H7 E3 E2 C3 C3 E16 E16 E16 E16 C3 C3 E2 E3 H7 H7 ..", 
        ".. .. .. H7 H7 E3 E3 E2 E16 E16 E16 E16 E2 E3 E3 H7 H7 .. ..", 
        ".. .. .. .. H7 H7 H7 C16 E16 H2 E16 C16 H7 H7 H7 .. .. .. ..",
        ".. .. .. .. .. H7 H6 C16 C16 C16 C16 C16 H6 H7 .. .. .. .. ..",
        ".. .. .. .. H7 H6 H6 C16 H3 H6 H3 C16 H6 H6 H7 .. .. .. ..",
        ".. .. .. H7 H6 H6 H6 C16 C16 C16 C16 C16 H6 H6 H6 H7 .. .. ..",
        ".. .. .. H7 E16 E16 H7 H6 H3 H6 H3 H6 H7 E16 E16 H7 .. .. ..",
        ".. .. .. .. H7 H7 H7 H6 C16 H6 C16 H6 H7 H7 H7 .. .. .. ..",
        ".. .. .. .. .. H7 H6 H6 H6 H7 H6 H6 H6 H7 .. .. .. .. ..",
        ".. .. .. .. .. .. H7 H5 H5 H7 H5 H5 H7 .. .. .. .. ..",
        ".. .. .. .. .. .. .. H7 H7 .. H7 H7 .. .. .. .. .. .." 
    ];
       function drawNoah() {
               ctx.setTransform(1, 0, 0, 1, 0, 0); // æ–°å¢ï¼šé‡ç½®ç”»å¸ƒåæ ‡
        if (noah.isAway) { ctx.clearRect(0, 0, 26, 26); return; }
        ctx.clearRect(0, 0, 26, 26); // æ›´æ–°ä¸º 26x26 ç”»å¸ƒ
        ctx.translate(3, 0); // æ–°å¢ï¼šæŠŠè¯ºäºšæ•´ä½“å‘å³å¹³ç§»3åƒç´ ï¼Œç»™å·¦è¾¹è…¾å‡ºç©ºé—´
        let currentMap;
        if (currentFace === 'blink') {
            currentMap = [...pixelMap_blink];
        } else if (currentFace === 'shy') {
            currentMap = [...pixelMap_shy];
        } else {
            currentMap = [...pixelMap];
        }
        // --- æ¶é­”æœé¥°ï¼šç¿…è†€å¿…é¡»åœ¨äººèº«ä½“ä¹‹å‰ç”»ï¼Œå®ç°åèƒŒé®æŒ¡æ•ˆæœ ---
        if (noah.outfit === 'devil') {
            let devilWingLeft = [
                ".. .. .. .. H7 .. .. .. .. ..",
                ".. .. H7 H7 DE_D H7 .. .. .. ..",
                ".. H7 DE_R DE_R H7 DE_R H7 H7 .. ..",
                "H7 .. .. DE_D H7 DE_D DE_R DE_D DE_D H7 H7",
                ".. .. .. H7 .. .. H7 DE_D H7 ..",
                ".. .. .. .. .. .. .. H7 .. .."
            ];
            let devilWingRight = [
                ".. .. .. .. .. H7 .. .. .. ..",
                ".. .. .. .. H7 DE_R H7 H7 .. ..",
                ".. .. H7 H7 DE_R H7  DE_R DE_R H7 ..",
                "H7 H7 DE_D DE_R DE_D H7 DE_R DE_D ..  H7",
                ".. H7 DE_D H7 .. .. H7 .. .. ..",
                ".. .. H7.. .. .. .. .. .. .."
            ];
            // ç»˜åˆ¶å·¦ç¿…è†€ (ä½ç½®åœ¨æœ€å·¦ä¾§ï¼Œé«˜åº¦å¯¹é½è…°èƒŒ)
            for (let y = 0; y < devilWingLeft.length; y++) {
                let row = devilWingLeft[y].trim().split(/\s+/);
                for (let x = 0; x < row.length; x++) {
                    let color = palette[row[x]];
                    if (color) { ctx.fillStyle = color; ctx.fillRect(x - 3, 14 + y, 1, 1); }
                }
            }
            // ç»˜åˆ¶å³ç¿…è†€ (ä½ç½®åœ¨æœ€å³ä¾§ï¼Œé«˜åº¦å¯¹é½è…°èƒŒ)
            for (let y = 0; y < devilWingRight.length; y++) {
                let row = devilWingRight[y].trim().split(/\s+/);
                for (let x = 0; x < row.length; x++) {
                    let color = palette[row[x]];
                    if (color) { ctx.fillStyle = color; ctx.fillRect(12 + x, 14 + y, 1, 1); }
                }
            }
        }
        // ç”»å‡ºè¯ºäºš
        for (let y = 0; y < currentMap.length; y++) {
            let rowColors = currentMap[y].trim().split(/\s+/);
            for (let x = 0; x < rowColors.length; x++) {
                let color = palette[rowColors[x]];
                if (color) { ctx.fillStyle = color; ctx.fillRect(x, y, 1, 1); }
            }
        }
        // --- æ–°å¢ï¼šç”»å‡ºè¯ºäºšçš„æ¢è£… ---
        if (noah.outfit === 'flower') {
            // ä½ ç”»çš„ 3x3 åƒç´ å›¾å®Œç¾å¤åˆ»
            let flowerMap = [
                "F_P F_P F_P",
                "F_P F_Y F_P",
                "F_P F_P F_P"
            ];
            let startX = 12; // Xåæ ‡5ï¼Œåˆšå¥½åˆ«åœ¨å·¦ä¾§å¤´å‘ä¸Š
            let startY = 3; // Yåæ ‡0ï¼Œæˆ´åœ¨å¤´é¡¶æœ€é«˜å¤„
            for (let y = 0; y < flowerMap.length; y++) {
                let rowColors = flowerMap[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { ctx.fillStyle = color; ctx.fillRect(startX + x, startY + y, 1, 1); }
                }
            }
        }
        // --- æ¶é­”æœé¥°ï¼šè§’å¿…é¡»åœ¨æœ€åç”»ï¼Œå®ç°é¡¶å±‚å¤´é¥°æ•ˆæœ ---
        if (noah.outfit === 'devil') {
            let devilHornLeft = [
                ".. DE_R .. ..",
                "DE_R .. .. ..",
                "DE_R DE_D .. ..",
                "DE_R DE_D .. ..",
                "DE_R DE_D .. ..",
                ".. DE_R DE_D ..",
                ".. DE_R DE_D .."
            ];
            let devilHornRight = [
                ".. .. DE_R ..",
                ".. .. .. DE_R",
                ".. .. DE_D DE_R",
                ".. .. DE_D DE_R",
                ".. .. DE_D DE_R",
                ".. DE_D DE_R ..",
                ".. DE_D DE_R .."
            ];
            // ç”»å·¦è§’ï¼Œå¡åœ¨å¤´é¡¶ç¨åå·¦ä¾§
            for (let y = 0; y < devilHornLeft.length; y++) {
                let rowColors = devilHornLeft[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { ctx.fillStyle = color; ctx.fillRect(4 + x, y, 1, 1); }
                }
            }
            // ç”»å³è§’ï¼Œå¡åœ¨å¤´é¡¶ç¨åå³ä¾§
            for (let y = 0; y < devilHornRight.length; y++) {
                let rowColors = devilHornRight[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { ctx.fillStyle = color; ctx.fillRect(12 + x, y, 1, 1); }
                }
            }
        }
        if (noah.outfit === 'dog_ear') {
            // å®Œå…¨æŒ‰ç…§ä½ ç»™çš„å›¾çº¸ 1:1 è¿˜åŸçš„çŸ©é˜µ
            let earMap = [
                ".. .. E_L E_L .. ..",
                ".. E_L E_L E_L E_L ..",
                ".. E_L E_D E_D E_L ..",
                "E_L E_D E_D E_D E_D E_L"
            ];
            // è®¾å®šå·¦å³ä¸¤åªè€³æœµçš„èµ·ç¬”ä½ç½®ï¼Œå®Œç¾å¡åœ¨å¤´é¡¶ä¸¤ä¾§
            let leftX = 2; let leftY = 2;  
            let rightX = 12; let rightY = 2;
            
            for (let y = 0; y < earMap.length; y++) {
                let rowColors = earMap[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { 
                        ctx.fillStyle = color; 
                        ctx.fillRect(leftX + x, leftY + y, 1, 1);   // ç”»å·¦è€³
                        ctx.fillRect(rightX + x, rightY + y, 1, 1); // ç”»å³è€³
                    }
                }
            }
        }
        if (noah.outfit === 'cat_ear') {
            // å°çŒ«è€³æœµå›¾çº¸ 1:1 è¿˜åŸ
            let catEarMap = [
                ".. .. WH WH .. ..",
                ".. WH WH WH WH ..",
                "WH WH E2 E2 WH WH",
                "WH E2 E2 E2 E2 WH"
            ];
            // å°¾å·´å›¾çº¸ (ç²¾å‡†çš„å³ä¸‹ç¿˜èµ·å¹…åº¦)
            let catTailMap = [
                ".. .. .. .. WH",
                ".. .. .. WH WH",
                ".. .. .. WH WH",
                ".. .. WH WH ..",
                ".. .. WH WH ..",
                ".. WH WH .. ..",
                "WH WH .. .. .."
            ];
            
            // ç”»å‡ºå·¦è€³å’Œå³è€³ï¼Œå¡åœ¨å¤´å‘è¾¹ç¼˜
            let leftX = 2; let leftY = 2;  
            let rightX = 12; let rightY = 2;
            
            for (let y = 0; y < catEarMap.length; y++) {
                let rowColors = catEarMap[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { 
                        ctx.fillStyle = color; 
                        ctx.fillRect(leftX + x, leftY + y, 1, 1);   // ç”»å·¦è€³
                        ctx.fillRect(rightX + x, rightY + y, 1, 1); // ç”»å³è€³
                    }
                }
            }
            
            // ç”»å‡ºå°¾å·´ï¼Œä½ç½®åœ¨èº«ä½“å³ä¸‹ä¾§
            let tailX = 14; let tailY = 15;
            for (let y = 0; y < catTailMap.length; y++) {
                let rowColors = catTailMap[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { 
                        ctx.fillStyle = color; 
                        ctx.fillRect(tailX + x, tailY + y, 1, 1); 
                    }
                }
            }
        }
                if (noah.outfit === 'maid') {
            // å¤´é¥°å›¾çº¸ (æŒ‰å›¾1:1è¿˜åŸè´è¶ç»“)
            let maidHeadMap = [
                ".. .. .. E3 .. .. E3 .. .. ..",
                ".. E2 E3 GB F_Y F_Y GB E3 E2 ..",
                ".. E2 E3 .. F_Y F_Y .. E3 E2 ..",
                ".. E2 E3 GB F_Y F_Y GB E3 E2 ..",
                ".. .. .. E3 .. .. E3 .. .. .."
            ];
            // è¡£æœå›¾çº¸ (å®Œç¾è¦†ç›–ä¸‹åŠèº«ï¼Œè£™æ‘†å’Œèƒ¸å‰è´è¶ç»“ç»†èŠ‚å…¨åœ¨)
            let maidDressMap = [
                ".. .. H7 H7 H7 H2 H2 H7 H7 H7 .. ..",
                ".. H7 E3 H7 H2 C4 C4 H2 H7 E3 H7 ..",
                ".. H7 E2 E3 H7 H2 H2 H7 E3 E2 H7 ..",
                "H7 E2 E2 H7 H6 H6 H6 H6 H7 E2 E2 H7",
                "H7 H2 E2 H7 E3 E3 E3 E3 H7 E2 H2 H7",
                "H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7",
                ".. H7 H2 E3 H2 E3 E3 H2 E3 H2 H7 ..",
                ".. H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 ..",
                ".. .. .. H7  .. .. H7 H7 .. .. .."
            ];

            // ç»˜åˆ¶å¤´é¥° (å¡åœ¨å¤´é¡¶æ­£ä¸­å¿ƒ)
            let headX = 5; let headY = 0;
            for (let y = 0; y < maidHeadMap.length; y++) {
                let rowColors = maidHeadMap[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { ctx.fillStyle = color; ctx.fillRect(headX + x, headY + y, 1, 1); }
                }
            }

            // ç»˜åˆ¶è¡£æœ (ç²¾ç¡®è¦†ç›–åœ¨è„–å­ä»¥ä¸‹çš„èº«ä½“åŒºåŸŸ)
            let dressX = 4; let dressY = 15;
            for (let y = 0; y < maidDressMap.length; y++) {
                let rowColors = maidDressMap[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { ctx.fillStyle = color; ctx.fillRect(dressX + x, dressY + y, 1, 1); }
                }
            }
        }
        // --- æ–°å¢ï¼šç”»å‡ºä½ æŠ•å–‚æˆ–è´­ä¹°çš„å°ç‰©å“ ---
        if (window.currentShowingItem && sprites[window.currentShowingItem]) {
            let itemMap = sprites[window.currentShowingItem];
            let startX = 13; // å›ºå®šåœ¨è¯ºäºšçš„å³ä¸‹è§’
            let startY = 17; 
            for (let y = 0; y < itemMap.length; y++) {
                let rowColors = itemMap[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { ctx.fillStyle = color; ctx.fillRect(startX + x, startY + y, 1, 1); }
                }
            }
        }
    }

    // --- æåº¦ä¸°å¯Œçš„å¤–å‡ºäº‹ä»¶åº“ (6ä¸ªåœ°ç‚¹ x 10+äº‹ä»¶) ---
    const locations = {
"gringotts": {
    name: "å¤çµé˜ (å–é›¶èŠ±é’±)",
    icon: "ğŸ¦",
    desc: "å­˜é’±ç†è´¢ï¼Œæ¯å¤©è¿˜èƒ½æ¥æ‹¿å“¥å“¥ç»™çš„50åŠ éš†é›¶èŠ±é’±ã€‚",
            cost: { hunger: 5, health: 0, gold: 0 },
            events: [] // ç‰¹æ®Šåœ°ç‚¹ï¼Œè¿›å…¥ç‹¬ç«‹é“¶è¡Œç³»ç»Ÿ
        },
        "london": {
            name: "ä¼¦æ•¦è¡—å¤´ (é›¨å¤œ)",
            icon: "â˜”",
            desc: "æˆ‘ä»¬çš„â€œæ— é™â€ä¹‹åœ°ã€‚é€‚åˆçº¦ä¼šï¼Œä½†èŠ±é”€è¾ƒå¤§ã€‚",
            cost: { hunger: 15, health: 5, gold: 30 }, // æ¶ˆè€—é«˜
            events: [
                { text: "ä¸‹é›¨äº†ï¼Œä»–ç”¨ç°è‰²ç¾½ç»’æœæŠŠä½ è£¹è¿›æ€€é‡Œã€‚", diff: { love: 25, mood: 20 }, reply: "â€œå†·å—ï¼Ÿé è¿‘ç‚¹ã€‚è¿™ä»¶è¡£æœä¹°æ¥å°±æ˜¯ä¸ºäº†æ­¤åˆ»èƒ½è£…ä¸‹ä¸¤ä¸ªäººã€‚â€" },
                { text: "è·¯è¿‡ä¸€å®¶éº»ç“œå”±ç‰‡åº—ï¼Œé‡Œé¢åœ¨æ”¾è«æ‰ç‰¹ã€‚", diff: { mood: 15, love: 10 }, reply: "â€œå¤å…¸ä¹å’Œé›¨å£°å¾ˆé…ï¼Œå°±åƒæˆ‘å’Œä½ ã€‚è¿›å»çœ‹çœ‹ï¼Ÿä¹Ÿè®¸èƒ½æ‰¾åˆ°é‚£å¼ æˆ‘ä»¬è¦çš„é»‘èƒ¶ã€‚â€" },
                { text: "åœ¨è¡—è§’èŠ±åº—ä¹°äº†ä¸€æŸèŒ‰è‰èŠ±ã€‚", diff: { gold: -20, love: 20 }, reply: "â€œè™½ç„¶æˆ‘å–œæ¬¢èŒ‰è‰åªæ˜¯å› ä¸ºå¥½é—»ï¼Œä½†ç°åœ¨å®ƒä»£è¡¨æˆ‘é‚£ä¸ªåœ¨é›¨ä¸­å‚»ç¬‘çš„å¥³æœ‹å‹ã€‚â€" },
                { text: "åœ¨æ³°æ™¤å£«æ²³æ—é—²é€›ï¼Œè®¨è®ºå“²å­¦æ‚–è®ºã€‚", diff: { mood: 30, gold: 0 }, reply: "â€œå¡ç¿å¤±é©¬ï¼Œç„‰çŸ¥éç¦ã€‚å°±åƒæˆ‘å³ä½¿å¤±å»äº†æ•´ä¸ªä¸–ç•Œï¼Œåªè¦ä½ åœ¨ï¼Œæˆ‘å°±èµ¢äº†ã€‚â€" },
                { text: "å»ä¾¿åˆ©åº—ä¹°äº†ä¸€ç½ç¢³é…¸é¥®æ–™ã€‚", diff: { hunger: 10, gold: -5 }, reply: "â€œå‘²â€”â€”æ°”æ³¡éŸ³ã€‚ç»™ï¼Œç¬¬ä¸€å£ç»™ä½ ã€‚è¿™å¯æ˜¯éº»ç“œä¸–ç•Œçš„é­”è¯ã€‚â€" },
                { text: "å¶é‡ä¸€å®¶ç”µç©åŸï¼Œä»–éè¦å’Œä½ æ¯”èµ›è½¦ã€‚", diff: { mood: 20, love: 10, gold: -20 }, reply: "â€œæˆ‘èµ¢äº†ã€‚ä½œä¸ºå¥–åŠ±ï¼Œä»Šæ™šä½ è¦ä¸€ç›´ç‰µç€æˆ‘çš„æ‰‹ï¼Œä¸è®¸æ”¾å¼€ã€‚â€" },
                { text: "åœ¨çº¢ç»¿ç¯ä¸‹ï¼Œä»–çªç„¶å»äº†ä½ ã€‚", diff: { love: 40, mood: 40 }, reply: "â€œç»¿ç¯äº®äº†ï¼Œä½†æˆ‘ä¸æƒ³èµ°ã€‚è®©æ•´ä¸ªä¼¦æ•¦éƒ½ç­‰ç€å§ï¼Œæˆ‘ç°åœ¨åªæƒ³å»æˆ‘çš„ä¼½æ‹‰æã€‚â€" },
                { text: "çœ‹åˆ°ä¸€åªæ·‹æ¹¿çš„æµæµªçŒ«ã€‚", diff: { mood: 10, love: 10 }, reply: "â€œçœ¼ç¥åƒä½ çŠ¯é”™æ—¶ä¸€æ ·æ— è¾œã€‚å¥½å§ï¼Œæˆ‘ä»¬ç»™å®ƒä¹°ç‚¹åƒçš„ï¼Œä½†ä¸èƒ½å¸¦å›å®¶ï¼Œå®¶é‡Œåªèƒ½æœ‰ä½ ä¸€ä¸ªå°éº»çƒ¦ã€‚â€" },
                { text: "è·¯è¿‡ç”µå½±é™¢ï¼Œæ­£åœ¨æ”¾æ˜ é’æ˜¥ç‰‡ã€‚", diff: { gold: -30, love: 15 }, reply: "â€œè™½ç„¶å‰§æƒ…çƒ‚ä¿—ï¼Œä½†æˆ‘ä¹æ„é™ªä½ çœ‹ã€‚å› ä¸ºé»‘æš—ä¸­æˆ‘å¯ä»¥è‚†æ— å¿Œæƒ®åœ°çœ‹ç€ä½ çš„ä¾§è„¸ã€‚â€" },
                { text: "åœ¨å¨æ–¯æ•æ–¯ç‰¹ç«™å£ï¼Œä»–åƒå¾€å¸¸ä¸€æ ·ç­‰ä½ ã€‚", diff: { love: 30 }, reply: "â€œå‘¨äº”çš„çº¦å®šã€‚ä¸ç®¡å‘ç”Ÿä»€ä¹ˆï¼Œæˆ‘éƒ½ä¼šåœ¨è¿™é‡Œã€‚å“ªæ€•ä¸–ç•Œæœ«æ—¥ã€‚â€" }
            ]
        },
        "library": {
            name: "éœæ ¼æ²ƒå…¹å›¾ä¹¦é¦†",
            icon: "ğŸ“–",
            desc: "æ‹‰æ–‡å…‹åŠ³çš„ä¸»åœºã€‚å®‰é™ï¼Œçœé’±ï¼Œå¢é•¿æ™ºæ…§ã€‚",
            cost: { hunger: 10, health: 0, gold: 0 },
            events: [
                { text: "ä½ ä»¬åœ¨å¹³æ–¯å¤«äººçš„çœ¼çš®åº•ä¸‹ä¼ é€’çº¸æ¡ã€‚", diff: { love: 10, mood: 10 }, reply: "çº¸æ¡ä¸Šå†™ç€ï¼šâ€˜ç¬¬7æ’ä¹¦æ¶åè§ï¼Œæƒ³ä½ äº†ã€‚ç½²åï¼šä½ å¸…æ°”çš„BFâ€™" },
                { text: "ä»–å¸®ä½ è¡¥ä¹ é­”è¯å­¦è®ºæ–‡ã€‚", diff: { mood: 15 }, reply: "â€œè¿™é‡Œå†™é”™äº†ã€‚ä½ æ˜¯æƒ³æŠŠå©åŸšç‚¸äº†å—ï¼Ÿç¬¨è›‹ï¼Œçœ‹ç€æˆ‘ï¼Œå†è®²ä¸€éã€‚â€" },
                { text: "åœ¨ç¦ä¹¦åŒºé—¨å£æ¢å¤´æ¢è„‘ã€‚", diff: { mood: 20, love: 10 }, reply: "â€œæƒ³è¿›å»ï¼Ÿåªè¦ä½ å¼€å£ï¼Œæˆ‘å°±èƒ½å¸¦ä½ æºœè¿›å»ã€‚åæ­£ä¹Ÿä¸æ˜¯ç¬¬ä¸€æ¬¡è¿åæ ¡è§„äº†ã€‚â€" },
                { text: "ä»–çœ‹ç€ä¹¦ç¡ç€äº†ï¼Œç«æ¯›å¾ˆé•¿ã€‚", diff: { love: 20 }, reply: "ï¼ˆä½ å·å·äº²äº†ä»–ä¸€ä¸‹ï¼‰ä»–é—­ç€çœ¼å‹¾èµ·å˜´è§’ï¼šâ€œå·è¢­ï¼Ÿè®°åœ¨è´¦ä¸Šäº†ï¼Œé†’æ¥åç™¾å€å¥‰è¿˜ã€‚â€" },
                { text: "ä¸ºäº†ä¸€ä¸ªå­¦æœ¯é—®é¢˜äº‰è®ºä¸ä¼‘ã€‚", diff: { mood: 10 }, reply: "â€œç¼¸ä¸­ä¹‹è„‘...å¥½å§ï¼Œä¹Ÿè®¸ä½ è¯´å¾—å¯¹ã€‚ä½†æˆ‘æ›´æ„¿æ„ç›¸ä¿¡æˆ‘çš„å¤§è„‘æ­¤åˆ»æ„Ÿå—åˆ°çš„å¯¹ä½ çš„çˆ±æ˜¯çœŸå®çš„ã€‚â€" },
                { text: "é‡åˆ°äº†æ³•æ–¯ç‰¹Â·èµ›è‚¯å¾·ï¼Œæ°”æ°›å°´å°¬ã€‚", diff: { mood: -10 }, reply: "è¯ºäºšå†·å†·åœ°çœ‹äº†ä»–ä¸€çœ¼ï¼ŒæŠŠä½ æ‹‰åˆ°èº«åï¼šâ€œè®©å¼€ï¼Œä½ æŒ¡ä½æˆ‘ä»¬è¦æ‰¾çš„ä¹¦äº†ã€‚â€" },
                { text: "æ‰¾åˆ°ä¸€æœ¬å…³äºå¤ä»£å¦‚å°¼æ–‡çš„æ—§ä¹¦ã€‚", diff: { mood: 20 }, reply: "â€œè™½ç„¶æ™¦æ¶©ï¼Œä½†æˆ‘ä»¬å¯ä»¥ä¸€èµ·ç ´è¯‘ã€‚å°±åƒæˆ‘ä»¬ä¸€èµ·æ¢ç´¢è¿™ä¸ªä¸–ç•Œä¸€æ ·ã€‚â€" },
                { text: "çª—å¤–ä¸‹èµ·äº†é›ªï¼Œå®¤å†…å¾ˆæ¸©æš–ã€‚", diff: { hunger: -5, love: 15 }, reply: "â€œå¦‚æœæ—¶é—´èƒ½åœåœ¨è¿™ä¸€åˆ»å°±å¥½äº†ã€‚åªæœ‰ä¹¦é¦™ï¼Œé›ªï¼Œå’Œä½ ã€‚â€" },
                { text: "ä»–ç”¨é­”æ³•å˜å‡ºä¸€æœµè“è‰²çš„å°èŠ±å¤¹åœ¨ä½ ä¹¦é‡Œã€‚", diff: { love: 15 }, reply: "â€œä¹¦çœ‹ç´¯äº†å°±çœ‹èŠ±ï¼ŒèŠ±çœ‹ç´¯äº†...å°±çœ‹æˆ‘ã€‚æˆ‘æ¯”èŠ±å¥½çœ‹ã€‚â€" },
                { text: "ä½ ä»¬å…±ç”¨ä¸€å‰¯è€³æœºå¬éº»ç“œéŸ³ä¹ã€‚", diff: { mood: 20 }, reply: "â€œåˆ«å‘Šè¯‰åˆ«äººæˆ‘åœ¨å¬è¿™ä¸ªã€‚è¿™æ˜¯å±äºæˆ‘ä»¬ä¸¤ä¸ªçš„å°ç§˜å¯†ã€‚â€" }
            ]
        },
        "lake": {
            name: "é»‘æ¹– / ç¦æ—è¾¹ç¼˜",
            icon: "ğŸŒ²",
            desc: "å†’é™©è€…çš„ä¹å›­ã€‚å¯èƒ½å—ä¼¤ï¼Œä¹Ÿå¯èƒ½æ¡åˆ°å®è—ã€‚",
            cost: { hunger: 20, health: 15, gold: 0 },
            events: [
                { text: "åœ¨ç¦æ—è¾¹ç¼˜å‘ç°äº†ä¸€ä¸ªå¤è€çš„å®ç®±ï¼", diff: { gold: 100, mood: 20 }, reply: "â€œçœ‹æ¥å¹¸è¿å¥³ç¥ä»Šå¤©åçˆ±ä½ ã€‚å…¨éƒ¨å½’ä½ ï¼Œæˆ‘åªè¦ä½ å¼€å¿ƒã€‚â€ (è·å¾—100G)" },
                { text: "é‡åˆ°äº†å·¨å¤§çš„é»‘æ¹–é±¿é±¼ï¼Œè¢«æ³¼äº†ä¸€èº«æ°´ã€‚", diff: { health: -10, mood: -10 }, reply: "â€œè¯¥æ­»ï¼æ¸…ç†ä¸€æ–°ï¼è¿™è§¦æ‰‹æ€ªæ˜¯ä¸æ˜¯å«‰å¦’æˆ‘é•¿å¾—å¸…ï¼Ÿâ€" },
                { text: "åœ¨è‰ä¸›é‡Œæ¡åˆ°äº†ä¸€äº›ç¨€æœ‰è‰è¯ã€‚", diff: { gold: 40, mood: 10 }, reply: "â€œæ–¯æ™®åŠ³ç‰¹æ•™æˆä¼šå–œæ¬¢è¿™ä¸ªçš„ï¼Œæˆ–è€…æˆ‘ä»¬å¯ä»¥æ‹¿å»å–äº†æ¢é»„æ²¹å•¤é…’ã€‚â€ (è·å¾—40G)" },
                { text: "ä¸ºäº†æ‘˜æ‚¬å´–è¾¹çš„ä¸€æœµèŠ±ï¼Œä»–æ‘”ä¼¤äº†æ‰‹è‡‚ã€‚", diff: { health: -30, love: 30 }, reply: "â€œå˜¶...åˆ«å“­ã€‚è¿™ç‚¹ä¼¤æ¢ä½ ç¬‘ä¸€ä¸‹ï¼Œå€¼äº†ã€‚ä½ çœ‹ï¼ŒèŠ±å¾ˆç¾ï¼Œåƒä½ ã€‚â€" },
                { text: "å¶é‡ä¸€åªè¿·è·¯çš„å°ç‹¬è§’å…½ã€‚", diff: { mood: 30, love: 10 }, reply: "â€œå®ƒè®©ä½ æ‘¸ï¼Ÿå“¼ï¼Œçœ‹æ¥çº¯æ´çš„ç”Ÿç‰©éƒ½å–œæ¬¢ä½ ã€‚ä½†æˆ‘æ‰æ˜¯æœ€å–œæ¬¢ä½ çš„é‚£ä¸ªã€‚â€" },
                { text: "é‡åˆ°äº†æ­£åœ¨å·¡é€»çš„æµ·æ ¼ã€‚", diff: { hunger: -20 }, reply: "â€œå²©çš®é¥¼ï¼Ÿå“¦ä¸...ä¸ºäº†ç‰™é½¿ç€æƒ³ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¿«è·‘å§ã€‚â€ (å› é€ƒè·‘æ¶ˆè€—é¥±é£Ÿ)" },
                { text: "åœ¨æ¹–è¾¹æ‰“æ°´æ¼‚ï¼Œä»–ç«Ÿç„¶è¾“ç»™äº†ä½ ã€‚", diff: { mood: 15 }, reply: "â€œæˆ‘é‚£æ˜¯è®©ç€ä½ ï¼å¥½å§ï¼Œæ„¿èµŒæœè¾“ï¼ŒèƒŒä½ å›åŸå ¡ã€‚â€" },
                { text: "å‘ç°äº†é©¬äººç•™ä¸‹çš„é¢„è¨€çŸ³æ¿ã€‚", diff: { gold: 60 }, reply: "â€œæ˜Ÿè±¡è¯´ä»Šæ™šä¼šæœ‰å¥½äº‹å‘ç”Ÿ...æ¯”å¦‚ï¼Œä½ ä¼šè¯·æˆ‘åƒå¤œå®µï¼Ÿâ€ (è·å¾—60G)" },
                { text: "è¢«ä¸€ç¾¤æŠ¤æ ‘ç½—é”…å›´æ”»ã€‚", diff: { health: -15, mood: -5 }, reply: "â€œåˆ«æ€•ï¼Œèº²æˆ‘èº«åï¼è¿™äº›å°ä¸œè¥¿è„¾æ°”çœŸæš´èºã€‚â€" },
                { text: "åœ¨æ¹–è¾¹çœ‹å¤•é˜³ï¼Œæ°´é¢æ³¢å…‰ç²¼ç²¼ã€‚", diff: { love: 20, mood: 20 }, reply: "â€œäººä¸èƒ½ä¸¤æ¬¡è¸è¿›åŒä¸€æ¡æ²³æµï¼Œä½†æˆ‘ä¼šæ— æ•°æ¬¡çˆ±ä¸ŠåŒä¸€ä¸ªä½ ã€‚â€" }
            ]
        },
        "hogsmeade": {
            name: "éœæ ¼è«å¾·æ‘",
            icon: "ğŸº",
            desc: "çƒ­é—¹çš„å·«å¸ˆæ‘è½ã€‚åƒå–ç©ä¹ï¼Œæ¶ˆè€—é‡‘å¸ã€‚",
            cost: { hunger: -30, health: 5, gold: 40 }, // å›å¤é¥±é£Ÿ
            events: [
                { text: "åœ¨ä¸‰æŠŠæ‰«å¸šå–çƒ­é»„æ²¹å•¤é…’ã€‚", diff: { hunger: 20, mood: 20 }, reply: "â€œä½ å˜´å”‡ä¸Šæœ‰æ³¡æ²«...åˆ«åŠ¨ï¼Œæˆ‘å¸®ä½ æ“¦ã€‚â€ï¼ˆä»–å‡‘è¿‡æ¥å»æ‰äº†æ³¡æ²«ï¼‰" },
                { text: "åœ¨èœ‚èœœå…¬çˆµä¹°äº†ä¸€å¤§å †ç³–æœã€‚", diff: { hunger: 10, gold: -20 }, reply: "â€œå¼ å˜´ã€‚ç”œå—ï¼Ÿå†ç”œä¹Ÿæ²¡æœ‰ä½ ç”œã€‚â€" },
                { text: "å»äº†ä½ç§‘ç¬‘è¯åº—ï¼Œä¹°äº†ä¸ªæ¶ä½œå‰§é“å…·ã€‚", diff: { gold: -15, mood: 15 }, reply: "â€œæˆ‘æƒ³æŠŠè¿™ä¸ªæ”¾åœ¨å¸ƒé›·æ–¯çš„æ•å¤´ä¸‹...å˜˜ï¼Œè¿™æ˜¯æˆ‘ä»¬å…±çŠ¯çš„è¯æ˜ã€‚â€" },
                { text: "åœ¨å¸•ç¬›èŠ™å¤«äººèŒ¶é¦†ï¼Œè¢«æƒ…ä¾£ä»¬é—ªçäº†çœ¼ã€‚", diff: { mood: -5, love: 10 }, reply: "â€œè¿™é‡Œå¤ªç²‰çº¢äº†ï¼Œå—ä¸äº†ã€‚ä½†å¦‚æœæ˜¯å’Œä½ åœ¨ä¸€èµ·...å‹‰å¼ºå¯ä»¥å¿å—ã€‚â€" },
                { text: "é‡åˆ°äº†æ­£åœ¨çº¦ä¼šçš„å¾·æ‹‰ç§‘Â·é©¬å°”ç¦ã€‚", diff: { mood: 0 }, reply: "â€œçœ‹ä»€ä¹ˆçœ‹ï¼Œé©¬å°”ç¦ï¼Ÿå†çœ‹æŠŠä½ å˜æˆç™½é¼¬ã€‚èµ°å§ï¼Œåˆ«ç†ä»–ã€‚â€" },
                { text: "åœ¨é‚®å±€ç»™æœªæ¥çš„æˆ‘ä»¬å†™äº†ä¸€å°ä¿¡ã€‚", diff: { love: 20 }, reply: "â€œæ”¶ä»¶äººï¼šè¯ºäºšå’Œä»–çš„å¦»å­ã€‚å¯„å‡ºæ—¶é—´ï¼šç°åœ¨ã€‚å¸Œæœ›æœªæ¥çš„æˆ‘ä¾ç„¶è¿™ä¹ˆå¸…ã€‚â€" },
                { text: "çªé™å¤§é›ªï¼Œèº²è¿›ä¸€å®¶åºŸå¼ƒçš„å°å±‹ã€‚", diff: { love: 30 }, reply: "â€œè¿™åœºæ™¯åƒä¸åƒç”µå½±ï¼Ÿåªæœ‰æˆ‘ä»¬ä¸¤ä¸ªï¼Œä¸ä¸–éš”ç»ã€‚çœŸå¸Œæœ›é›ªæ°¸è¿œä¸åœã€‚â€" },
                { text: "ä¹°äº†å°–å«æ¸¸ä¹å›­çš„é—¨ç¥¨ã€‚", diff: { health: -5, mood: 25, gold: -30 }, reply: "â€œä½ å°–å«çš„æ ·å­çœŸå¯çˆ±ã€‚å®³æ€•å°±æŠ±ç´§æˆ‘ï¼Œè¿™å°±æ˜¯æˆ‘å­˜åœ¨çš„æ„ä¹‰ã€‚â€" },
                { text: "åœ¨æ–‡äººå±…ç¾½æ¯›ç¬”åº—æŒ‘äº†ä¸€æ”¯ç¬”ã€‚", diff: { gold: -10, mood: 10 }, reply: "â€œç”¨è¿™æ”¯ç¬”å†™ç»™ä½ çš„æƒ…ä¹¦ï¼Œä¼šä¸ä¼šæ›´æœ‰æ–‡é‡‡ä¸€ç‚¹ï¼Ÿâ€" },
                { text: "åœ¨å¤§è¡—ä¸Šå¤§å£°å–Šä½ çš„åå­—ã€‚", diff: { mood: 20, love: 10 }, reply: "â€œæˆ‘è¦è®©æ•´ä¸ªéœæ ¼è«å¾·éƒ½çŸ¥é“ï¼Œä½ æ˜¯æˆ‘çš„ï¼â€" }
            ]
        },
        "room": {
            name: "æœ‰æ±‚å¿…åº”å±‹",
            icon: "ğŸ°",
            desc: "åªå±äºä½ ä»¬çš„ç§˜å¯†åŸºåœ°ã€‚è®­ç»ƒæˆ˜æ–—æˆ–å¯»æ‰¾å¤±ç‰©ã€‚",
            cost: { hunger: 20, health: 15, gold: 0 },
            events: [
                { text: "æŠŠæˆ¿é—´å˜æˆäº†å†³æ–—ä¿±ä¹éƒ¨ï¼Œç»ƒä¹ é™¤ä½ æ­¦å™¨ã€‚", diff: { health: -10, love: 15 }, reply: "â€œååº”ä¸é”™ã€‚ä½†åœ¨æˆ˜åœºä¸Šï¼Œæ•Œäººä¸ä¼šåƒæˆ‘è¿™æ ·èˆä¸å¾—ä¼¤ä½ ã€‚å†æ¥ï¼â€" },
                { text: "åœ¨æ‚ç‰©å †é‡Œæ‰¾åˆ°äº†ä¸€è¢‹è¢«é—å¿˜çš„é‡‘å¸ã€‚", diff: { gold: 80 }, reply: "â€œè¿™æ˜¯è°è—çš„ç§æˆ¿é’±ï¼Ÿç°åœ¨å®ƒæ˜¯æˆ‘ä»¬çš„æ‹çˆ±åŸºé‡‘äº†ã€‚â€ (è·å¾—80G)" },
                { text: "æˆ¿é—´å˜æˆäº†å…¨æ˜¯é•œå­çš„è¿·å®«ã€‚", diff: { mood: 10 }, reply: "â€œå¥½å¤šæˆ‘ï¼Œå¥½å¤šä½ ã€‚æ— è®ºä½ çœ‹å‘å“ªé‡Œï¼Œçœ‹åˆ°çš„éƒ½æ˜¯æˆ‘ä»¬åœ¨ä¸€èµ·çš„æ ·å­ã€‚â€" },
                { text: "ä»–æ•™ä½ å‘¼ç¥æŠ¤å«ï¼Œä»–çš„å®ˆæŠ¤ç¥æ˜¯ä¸€åªå†°åŸç‹¼ã€‚", diff: { love: 25, mood: 20 }, reply: "â€œæƒ³ç€æœ€å¿«ä¹çš„è®°å¿†...å¯¹æˆ‘æ¥è¯´ï¼Œé‚£æ®µè®°å¿†å°±æ˜¯é‡åˆ°ä½ çš„é‚£å¤©ã€‚â€" },
                { text: "æˆ¿é—´å˜æˆäº†ä¸€ç‰‡æŸ”è½¯çš„äº‘æµ·ã€‚", diff: { health: 10, mood: 20 }, reply: "ï¼ˆèººåœ¨äº‘ä¸Šï¼‰â€œå¦‚æœç´¯äº†å°±ç¡ä¸€ä¼šã€‚æˆ‘ä¼šå®ˆç€ä½ ï¼Œè¿å™©æ¢¦éƒ½ä¸æ•¢é è¿‘ã€‚â€" },
                { text: "ç»ƒä¹ å¤§è„‘å°é—­æœ¯ï¼Œä»–å¯¹ä½ æ•å¼€äº†å¿ƒæ‰‰ã€‚", diff: { love: 30 }, reply: "â€œçœ‹åˆ°äº†å—ï¼Ÿæˆ‘çš„è„‘æµ·é‡Œï¼Œé™¤äº†é‚£äº›ä¹±ä¸ƒå…«ç³Ÿçš„ç†è®ºï¼Œå‰©ä¸‹çš„å…¨æ˜¯ä½ ã€‚â€" },
                { text: "æ‰¾åˆ°äº†ä¸€æŠŠæ—§çš„é£å¤©æ‰«å¸šï¼Œåœ¨å±‹é‡Œä½ç©ºé£è¡Œã€‚", diff: { mood: 15, health: -5 }, reply: "â€œæŠ“ç´§æˆ‘ï¼æˆ‘ä»¬è¦æ’ä¸Šå¤©èŠ±æ¿äº†â€”â€”å“ˆå“ˆï¼Œåˆºæ¿€å—ï¼Ÿâ€" },
                { text: "æˆ¿é—´å˜æˆäº†ä¸€ä¸ªå¤å¤çš„èˆå…ã€‚", diff: { love: 20 }, reply: "â€œè¿™ä½ç¾ä¸½çš„å°å§ï¼Œèƒ½è¯·ä½ è·³æ”¯èˆå—ï¼Ÿå°±åƒæˆ‘ä»¬åœ¨ä¼¦æ•¦çœ¼ä¸‹è·³å¼—æ‹‰æ˜æˆˆé‚£æ ·ã€‚â€" },
                { text: "æ„å¤–ç¿»å‡ºäº†è¥¿å¥¥å¤šÂ·è¯ºç‰¹å°æ—¶å€™çš„ç…§ç‰‡ã€‚", diff: { mood: -10 }, reply: "â€œçƒ§äº†å§ã€‚åˆ«è®©è¿™ä¸œè¥¿æ±¡æŸ“äº†æˆ‘ä»¬çš„ç§˜å¯†åŸºåœ°ã€‚â€" },
                { text: "åœ¨è¿™é‡Œä»€ä¹ˆéƒ½ä¸åšï¼Œåªæ˜¯é™é™åœ°æ‹¥æŠ±ã€‚", diff: { mood: 30, love: 20 }, reply: "â€œå¤–é¢ä¸–ç•Œå¾ˆåµï¼Œäººç¾¤å¾ˆåµã€‚åªæœ‰è¿™é‡Œï¼Œåªæœ‰ä½ ï¼Œæ˜¯å®‰é™çš„ã€‚â€" }
            ]
        },
        "astronomy": {
            name: "å¤©æ–‡å¡”é¡¶å±‚",
            icon: "ğŸŒŒ",
            desc: "ç¦»æ˜Ÿæ˜Ÿæœ€è¿‘çš„åœ°æ–¹ã€‚æ·±å¤œï¼Œé«˜å¤„ä¸èƒœå¯’ã€‚",
            cost: { hunger: 10, health: 10, gold: 0 },
            events: [
                { text: "ç”¨æœ›è¿œé•œè§‚æµ‹æœ¨æ˜Ÿçš„å«æ˜Ÿã€‚", diff: { mood: 20 }, reply: "â€œå®‡å®™å¤§çˆ†ç‚¸ï¼Œä¸‡ç‰©è¯ç”Ÿ...è€Œæˆ‘çš„å®‡å®™ä¸­å¿ƒï¼Œæ­¤æ—¶æ­¤åˆ»æ­£ç«™åœ¨æˆ‘èº«è¾¹ã€‚â€" },
                { text: "é«˜å¤„çš„é£å¾ˆå¤§ï¼Œå¹ä¹±äº†ä»–çš„é»‘å‘ã€‚", diff: { love: 15, health: -5 }, reply: "â€œåˆ«åŠ¨ï¼Œè®©æˆ‘å¸®ä½ æŒ¡é£ã€‚è¦æ˜¯ä½ æ„Ÿå†’äº†ï¼Œæˆ‘ä¼šå¿ƒç–¼æ­»çš„ã€‚â€" },
                { text: "åœ¨è¿™é‡Œä¿¯ç°æ•´ä¸ªéœæ ¼æ²ƒå…¹ã€‚", diff: { mood: 15 }, reply: "â€œçœ‹ï¼Œé‚£æ˜¯é»‘æ¹–ï¼Œé‚£æ˜¯çƒåœº...æ€»æœ‰ä¸€å¤©ï¼Œæˆ‘ä¼šå¸¦ä½ å»æ›´è¿œçš„åœ°æ–¹ï¼Œå…¨ä¸–ç•Œé¨æ¸¸ã€‚â€" },
                { text: "æµæ˜Ÿåˆ’è¿‡ï¼Œä½ ä»¬ä¸€èµ·è®¸æ„¿ã€‚", diff: { love: 25 }, reply: "â€œè®¸äº†ä»€ä¹ˆæ„¿ï¼Ÿæƒ³è®©æˆ‘æ´»å‡ ä¸‡å¹´ï¼Ÿå‡†äº†ã€‚æˆ‘è¦ç•™ç€è¿™æ¡å‘½ï¼Œä¸€ç›´çˆ±ä½ ã€‚â€" },
                { text: "é‡åˆ°äº†æ­£åœ¨å¤œå·¡çš„è´¹å°”å¥‡å’Œæ´›ä¸½ä¸å¤«äººã€‚", diff: { mood: -20, health: -10 }, reply: "â€œå¿«è·‘ï¼å¹»èº«å’’ï¼å‘¼...å·®ç‚¹è¢«æŠ“åˆ°ï¼Œä¸è¿‡è¿™å¿ƒè·³åŠ é€Ÿçš„æ„Ÿè§‰ï¼Œè¿˜ä¸é”™ã€‚â€" },
                { text: "åœ¨è¿™é‡Œè·³äº†ä¸€æ”¯æ²¡æœ‰éŸ³ä¹çš„èˆã€‚", diff: { love: 20 }, reply: "â€œæ˜Ÿå…‰å°±æ˜¯èšå…‰ç¯ï¼Œé£å£°å°±æ˜¯ä¼´å¥ã€‚ä½ æ˜¯æˆ‘çš„èˆä¼´ï¼Œä¹Ÿæ˜¯æˆ‘å”¯ä¸€çš„è§‚ä¼—ã€‚â€" },
                { text: "è®¨è®ºå…³äºæ­»äº¡å’Œæ°¸æ’çš„è¯é¢˜ã€‚", diff: { mood: 10 }, reply: "â€œå¦‚æœæœ‰ä¸€å¤©æˆ‘æ­»äº†...æˆ‘ä¼šè®©ä½ æŠŠæˆ‘åšæˆé­‚å™¨ã€‚è¿™æ ·æˆ‘å°±èƒ½æ°¸è¿œé™ªç€ä½ ï¼Œä½ ä¹Ÿæ°¸è¿œç”©ä¸æ‰æˆ‘ã€‚â€" },
                { text: "ä»–åœ¨æ æ†è¾¹ç¼˜åšå±é™©åŠ¨ä½œå“å”¬ä½ ã€‚", diff: { mood: -10, love: 10 }, reply: "â€œæ‹…å¿ƒæˆ‘ï¼Ÿæ”¾å¿ƒï¼Œæˆ‘èˆä¸å¾—æ­»ã€‚æˆ‘è¿˜æ²¡å¨¶åˆ°ä½ å‘¢ã€‚â€" },
                { text: "å–äº†ä¸€å£å·å¸¦ä¸Šæ¥çš„çƒˆç«å¨å£«å¿Œã€‚", diff: { health: -5, mood: 15 }, reply: "â€œæ•¬æ˜Ÿç©ºï¼Œæ•¬è‡ªç”±ï¼Œæ•¬è¯¥æ­»çš„çº¯è¡€ç»Ÿè®ºï¼Œæ•¬æˆ‘ä»¬ã€‚â€" },
                { text: "åœ¨è¿™é‡Œè¿æ¥æ—¥å‡ºã€‚", diff: { mood: 30, love: 20 }, reply: "â€œå¤©äº®äº†ã€‚æ–°çš„ä¸€å¤©ï¼Œæˆ‘è¿˜çˆ±ç€ä½ ã€‚è€Œä¸”æ¯”æ˜¨å¤©æ›´çˆ±ä¸€ç‚¹ã€‚â€" }
            ]
        }
    };

    // --- æ–°å¢ï¼šæ‰“å¼€åœ°ç‚¹é€‰æ‹©èœå• ---
    function openLocationMenu() {
if(window.isPlatformGaming) return; // æ‹¦æˆªåŠ¨ä½œå†’é™©æ¸¸æˆ
    if(window.isGomoku) { moveGomokuCursor(0, -1); return; }
if(window.isGaming) { speak("æˆ‘ç°åœ¨æ­£å¿™ç€ç»™ä½ èµšåŠ éš†ï¼Œæ²¡ç©ºå‡ºé—¨ï¼"); return; }
        if(noah.isAway) { speak("è¯ºäºšæ­£åœ¨å¤–é¢æ¢é™©ï¼Œè€å¿ƒç‚¹ï¼Œå¥³æœ‹å‹ã€‚"); return; }
        if(noah.health < 20 || noah.hunger < 20) { 
            speak("â€œæˆ‘å¤ªç´¯äº†ï¼Œæˆ–è€…å¤ªé¥¿äº†...å…ˆç…§é¡¾å¥½æˆ‘ï¼Œå†å¸¦ä½ å»å¾æœä¸–ç•Œã€‚â€ (çŠ¶æ€è¿‡ä½ï¼Œæ— æ³•å¤–å‡º)"); 
            return; 
        }

        const list = document.getElementById('modal-list');
        list.innerHTML = '';
        document.getElementById('modal-title').innerText = "ğŸŒ é€‰æ‹©ç›®çš„åœ°";
        
        for (let key in locations) {
            let loc = locations[key];
            let li = document.createElement('li');
            // æ˜¾ç¤ºæ¶ˆè€—æç¤º
            let costText = [];
            if(loc.cost.gold > 0) costText.push(`-${loc.cost.gold}G`);
            if(loc.cost.hunger > 0) costText.push(`é¥±é£Ÿ-${loc.cost.hunger}`);
            
            li.innerHTML = `<span>${loc.icon} ${loc.name}</span> <span style="font-size:9px;opacity:0.7">${costText.join(' ')}</span>`;
            li.onclick = () => { confirmAdventure(key); };
            list.appendChild(li);
        }
        document.getElementById('sys-modal').style.display = 'block';
    }

    function confirmAdventure(locKey) {
        let loc = locations[locKey];
        
        // æ£€æŸ¥é‡‘å¸æ˜¯å¦è¶³å¤Ÿ
    if(noah.gold < loc.cost.gold) {
        sfx_error(); // <--- åŠ è¿™é‡Œ
        speak(`â€œå»${loc.name}å¯æ˜¯è¦èŠ±é’±çš„ã€‚çœ‹çœ‹ä½ çš„é’±åŒ…ï¼Œåªæœ‰${noah.gold}Gã€‚æˆ‘ä»¬è¿˜æ˜¯å»é»‘æ¹–æ¡ç ´çƒ‚å§ã€‚â€`);
        closeModal();
        return;
    }
    sfx_success(); // <--- åŠ è¿™é‡Œ
    closeModal();
    // ... ä¸‹é¢çš„ä»£ç ä¿æŒä¸å˜
        
        // æ‰£é™¤æ¶ˆè€—
        noah.gold -= loc.cost.gold;
        noah.hunger -= loc.cost.hunger;
        if(loc.cost.health) noah.health -= loc.cost.health;
        // éœæ ¼è«å¾·ç‰¹æ®Šå›å¤
        if(locKey === 'hogsmeade') noah.hunger += 30;

        // å¼€å§‹æ¢é™©åŠ¨ç”»
        noah.isAway = true;
        document.getElementById('adventure-overlay').style.display = 'flex';
        document.getElementById('noah-canvas').style.display = 'none'; 
        // --- æ–°å¢ï¼šç”¨åœºæ™¯åƒç´ ç”»ä»£æ›¿åŸæœ¬çš„ Emoji ---
        document.getElementById('adv-icon').style.display = 'none'; 
        const advCanvas = document.getElementById('adv-canvas');
        advCanvas.style.display = 'block';
        const advCtx = advCanvas.getContext('2d');
        advCtx.clearRect(0, 0, 10, 10);
        
        // åˆ¤æ–­å»å“ªé‡Œï¼Œç”»å‡ºå“ªé‡Œçš„å›¾çº¸
               let sceneKey = 'lake';
        if (locKey === 'london' || locKey === 'astronomy') sceneKey = 'london';
        else if (locKey === 'library') sceneKey = 'library';
        else if (locKey === 'hogsmeade' || locKey === 'room') sceneKey = 'room';
        else if (locKey === 'gringotts') sceneKey = 'gringotts'; // <--- åŠ ä¸Šè¿™ä¸€è¡Œ
        
        let sceneMap = sprites[sceneKey];
        if (sceneMap) {
            for (let y = 0; y < sceneMap.length; y++) {
                let rowColors = sceneMap[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { advCtx.fillStyle = color; advCtx.fillRect(x, y, 1, 1); }
                }
            }
        }
        document.getElementById('adv-text').innerText = "EXPLORING " + loc.name.split(' ')[0];
        
        speak(`â€œå»${loc.name}ï¼Ÿå¥½ä¸»æ„ã€‚è·Ÿç´§æˆ‘ï¼Œåˆ«èµ°ä¸¢äº†ã€‚â€ (é¢„è®¡è€—æ—¶8ç§’)`);

        setTimeout(() => {
            noah.isAway = false;
            document.getElementById('adventure-overlay').style.display = 'none';
            document.getElementById('noah-canvas').style.display = 'block'; 
                        // --- æ‹¦æˆªå¤çµé˜ä¸“å±ç•Œé¢ ---
            if (locKey === 'gringotts') {
                           openGringottsBank();
                return; 
            }
            // --- ğŸš¨ æ–°å¢ï¼šæ‹¦æˆªé»‘æ¹–ï¼Œè¿›å…¥å“ˆåˆ©æ³¢ç‰¹é£é©¬é‡Œå¥¥å°æ¸¸æˆ ---
            if (locKey === 'lake') {
                document.getElementById('noah-canvas').style.display = 'none'; 
                startPlatformerGame();
                return; 
            }
            // éšæœºæŠ½å–è¯¥åœ°ç‚¹çš„äº‹ä»¶
            const eventPool = loc.events;
            const event = eventPool[Math.floor(Math.random() * eventPool.length)];
            
            // åº”ç”¨æ•°å€¼å˜åŒ–
            if(event.diff.gold) noah.gold += event.diff.gold;
            if(event.diff.love) noah.love += event.diff.love;
            if(event.diff.mood) noah.mood += event.diff.mood;
            if(event.diff.health) noah.health += event.diff.health;
            if(event.diff.hunger) noah.hunger += event.diff.hunger;

            speak(event.reply);
            updateUI();
            showEventModal(event.text, event.diff);
            
        }, 8000);
    }

    function showEventModal(text, diff) {
        let diffText = "";
        if(diff.gold > 0) diffText += `<span style="color:#d1b55a">+${diff.gold}G </span>`;
        if(diff.gold < 0) diffText += `<span style="color:#d15a5a">${diff.gold}G </span>`;
        if(diff.love > 0) diffText += `<span style="color:#ff99cc">åçˆ±+${diff.love} </span>`;
        if(diff.health < 0) diffText += `<span style="color:#d15a5a">å¥åº·${diff.health} </span>`;
        if(diff.mood > 0) diffText += `<span style="color:#5cd1ff">å¿ƒæƒ…+${diff.mood} </span>`;

        document.getElementById('event-text').innerHTML = `${text}<br><br><div style="font-size:10px; margin-top:5px;">${diffText}</div>`;
        document.getElementById('event-options').innerHTML = `<button class="event-btn" onclick="document.getElementById('event-modal').style.display='none'">ç¡®å®š</button>`;
        document.getElementById('event-modal').style.display = 'flex';
    }

    // --- åŸæœ‰èœå•é€»è¾‘ ---
    const menus = {
        feed: [
            { name: "åå…¨å¤§è¡¥çˆ±å¿ƒé­”è¯ (G100)", action: () => buyItem(100, 'health', 80, 'love', 20, "è¿™ä»€ä¹ˆä¸œè¥¿ï¼Ÿä¸ºäº†ä½ æˆ‘å–...å’³ï¼Œæ„Ÿè§‰å¥½å¤šäº†ï¼Œä½ æ˜¯ä¸æ˜¯åœ¨é‡Œé¢åŠ äº†ç¦çµå‰‚ï¼Ÿ") },
            { name: "é€’ç»™ä»–èŒ‰è‰èŠ±èŒ¶ (G10)", action: () => buyItem(10, 'mood', 15, 'love', 10, "é¦™å‘³å¾ˆç†Ÿæ‚‰ã€‚ä¸è¿‡ä½ éš¾é“ä¸çŸ¥é“ï¼Œæˆ‘å–œæ¬¢èŒ‰è‰ä»…ä»…æ˜¯å› ä¸ºå¥½é—»ï¼Œä½†æˆ‘å–œæ¬¢ä½ ï¼Œæ˜¯å› ä¸ºé‚£æ˜¯ä½ ã€‚") },
            { name: "é€’ä¸€ç½ç¢³é…¸é¥®æ–™ (G15)", action: () => buyItem(15, 'mood', 20, 'hunger', 10, "å‘²â€”â€”ï¼ˆæ‹‰å¼€æ˜“æ‹‰ç½ï¼‰ã€‚æ°”æ³¡ç‚¸è£‚çš„å£°éŸ³ã€‚æ´»åœ¨å½“ä¸‹çš„æ„Ÿè§‰çœŸå¥½ï¼Œå°¤å…¶æ˜¯ä½ åœ¨æˆ‘æ—è¾¹ã€‚") },
            { name: "é€æ¯’è˜‘è‡ç‰›å¥¶ (G5)", action: () => buyItem(5, 'health', -10, 'love', 30, "ä½ åˆæ¥ï¼Ÿè¡Œï¼Œé»‘å†å²è¿‡ä¸å»äº†æ˜¯å§ã€‚åªè¦æ˜¯ä½ ç»™çš„ï¼Œå°±ç®—å«æˆ‘çˆ¶äº²æˆ‘ä¹Ÿå–ã€‚(ä¸€é¥®è€Œå°½)") },
            { name: "ä¸‰æŠŠæ‰«å¸šçƒ­é»„æ²¹å•¤é…’ (G25)", action: () => buyItem(25, 'hunger', 30, 'mood', 20, "å¹²æ¯ï¼Œåˆ«å–é†‰äº†ï¼Œä¸ç„¶æˆ‘æ€•æˆ‘æ§åˆ¶ä¸ä½æƒ³å¯¹ä½ åšç‚¹ä»€ä¹ˆã€‚") },
            { name: "èœ‚èœœå…¬çˆµç³–ç¾½æ¯›ç¬” (G20)", action: () => buyItem(20, 'hunger', 15, 'mood', 15, "ä¸€è¾¹æ€è€ƒç¼¸ä¸­ä¹‹è„‘ï¼Œä¸€è¾¹åƒç³–...æˆ‘ä¹Ÿåªæœ‰åœ¨ä½ é¢å‰æ‰ä¼šè¿™ä¹ˆçŸ›ç›¾äº†ã€‚ç¬¨è›‹ã€‚") }
        ],
        interact: [
 { name: "ğŸµ è¯ºäºšéšèº«å¬", action: () => { sfx_success(); document.getElementById('music-modal').style.display='flex'; } },           
            { name: "ğŸ•°ï¸ æ‰“å¼€é™ªä¼´æ‰‹è´¦", action: () => openAccompany() },
 { name: "ğŸ‘— æ‰“å¼€è¡£æŸœ ", action: () => setTimeout(openWardrobe, 10) },
            { name: "âœ‰ï¸ å†™æ‚„æ‚„è¯ç»™ä»–", action: () => openSecretChat() },
            { name: "ğŸ“… è¯ºäºšçš„ä¸“å±æ—¥å†", action: () => openCalendar() },
{ name: "âœ’ï¸ æ—¥è®° ", action: () => openPlayerDiary() },
            { name: "â™Ÿï¸ å’Œä»–ä¸‹äº”å­æ£‹", action: () => startGomoku() },
            { name: "ğŸ¡ æƒŠå–œç›²ç›’è½¬ç›˜ (G10)", action: () => openGacha() },
 { name: "ğŸ® é™ªä»–æ¥é‡‘å¸ (G5)", action: () => startMiniGame() }, // <- æ–°åŠ è¿™ä¸€è¡Œ
{ name: "ğŸ“¡ è¿æ¥ç°å®ä¸–ç•Œåæ ‡", action: () => syncRealWorld() },
{ name: "ğŸ™ï¸ å¼€å¯å£°éŸ³é™ªä¼´é“¾æ¥", action: () => startAudioSensing() },
            { name: "ğŸŒŸ é™ªä»–æˆ³ç¢æ˜Ÿå…‰ (è§£å‹)", action: () => startStarGame() },
            { name: "é€’ç»™ä»–ç»¿è‰²å°è›‡ç©å¶", action: () => chat("å°ç»¿è›‡") },
            { name: "è¯´â€œæˆ‘æ¨ä½ Xä¸‡éâ€", action: () => chat("äº’æ€¼") },
            { name: "æ‰¯ä»–è„–å­ä¸Šçš„è“å®çŸ³é¡¹é“¾", action: () => chat("é¡¹é“¾") },
            { name: "è®©ä»–æŠŠå›´å·¾ç³»åœ¨å¤´ä¸Š", action: () => chat("å›´å·¾") },
            { name: "èŠèŠè–›å®šè°”çš„çŒ«", action: () => chat("å“²å­¦") },
            { name: "æ•…æ„æè¥¿å¥¥å¤šÂ·è¯ºç‰¹", action: () => chat("è¥¿å¥¥å¤š") },
            { name: "æ•…æ„æå¸ƒé›·æ–¯Â·æ‰æ¯”å°¼", action: () => chat("å¸ƒé›·æ–¯") },
            { name: "å¤¸ä»–â€œå¸…æäº†â€", action: () => chat("è‡ªæ‹") },
         
            { name: "é‚€è¯·ä»–åœ¨é›¨ä¸­æ¼«æ­¥", action: () => chat("é›¨ä¸­") },
         
 { name: "âš™ï¸ ç³»ç»Ÿè®¾ç½®", action: () => { sfx_success(); document.getElementById('settings-modal').style.display='flex'; } }
        ],
              shop: [
            { name: "ğŸ˜ˆ æ¶é­”æœé¥° (G200)", action: () => buyOutfit(200, 'devil', "æ¶é­”ï¼Ÿ ä½ æœ€å¥½æƒ³æ¸…æ¥šè®©æˆ‘ç©¿è¿™å¥—è¡£æœçš„åæœã€‚æ¯•ç«Ÿæ‹›æƒ¹äº†æ¶é­”ï¼Œå°±ç®—é€ƒåˆ°å®‡å®™è¾¹ç¼˜æˆ‘ä¹Ÿèƒ½æŠŠä½ æŠ“å›æ¥åƒæ‰ã€‚") },
{ name: "ğŸ€ ç²‰ç™½å¥³ä»†è£… (G520)", action: () => buyOutfit(520, 'maid', "è®©æˆ‘ç©¿å¥³ä»†è£…ï¼Ÿï¼ä½ çš„å°è„‘ç“œé‡Œéƒ½åœ¨æƒ³äº›ä»€ä¹ˆå±é™©çš„ä¸œè¥¿â€¦â€¦è¡Œäº†åˆ«ç”¨é‚£ç§æœŸå¾…çš„çœ¼ç¥çœ‹ç€æˆ‘ï¼åªé™ä»Šå¤©ä¸€æ¬¡ï¼Œè¦æ˜¯ä½ æ•¢å·å·æˆªå›¾å½•å±ï¼Œæˆ‘å°±ç”¨é­”æ–æŠŠä½ çš„è®¾å¤‡ç‚¸äº†ï¼") },
            { name: "ğŸ± å°çŒ«è€³æœµä¸å°¾å·´ (G120)", action: () => buyOutfit(120, 'cat_ear', "æˆ´ä¸Šè¿™ä¸ªï¼Ÿå…¶å®æ˜¯å†°åŸç‹¼ï¼Œä½†çœ‹ç€å¾ˆåƒå°çŒ«ã€‚å‹‰å¼ºæ»¡è¶³ä½ çš„æ¶è¶£å‘³å§ã€‚") },
{ name: "ğŸ¶ å°ç‹—è€³æœµå¤´é¥° (G60)", action: () => buyOutfit(60, 'dog_ear', "æƒ³è®©æˆ‘æˆ´å°ç‹—è€³æœµï¼Ÿä½ çœŸæŠŠæˆ‘å½“å® ç‰©äº†ï¼Ÿâ€¦â€¦æ±ªã€‚æ»¡æ„äº†å§ï¼Ÿæ—¢ç„¶å½“äº†ç‹—ï¼Œé‚£ç­‰ä¼šå’¬ä½ çš„è¯ï¼Œä½ å¯åˆ«å“­ã€‚") },
                       { name: "ğŸŒ¸ å°èŠ±èŠ±å¤´é¥° (G90)", action: () => buyOutfit(90, 'flower', "è¿™ä»€ä¹ˆï¼Ÿå°èŠ±èŠ±ï¼Ÿ...è¡Œå§ï¼Œæ—¢ç„¶æ˜¯ä½ ä¹°çš„ï¼Œæˆ‘å°±å‹‰ä¸ºå…¶éš¾æˆ´åœ¨å¤´ä¸Šã€‚ä¸è®¸ç¬‘ï¼") },
 { name: "å¤¹å¿ƒé¢åŒ…ç°è‰²ç¾½ç»’æœ (G150)", action: () => buyItem(150, 'love', 50, 'mood', 30, "ä½ å«Œå®ƒä¸‘ï¼Ÿå¯å®ƒæš–å’Œå•Šï¼Œè€Œä¸”è¿™ä»¶è¡£æœçš„å¤§å°ï¼Œåˆšå¥½è¶³å¤ŸæŠŠä½ æ•´ä¸ªäººåŒ…è¿›æˆ‘æ€€é‡Œã€‚") },
            { name: "ã€Šè«é‡Œæ–¯çš„æƒ…äººã€‹å½±ç¥¨ (G80)", action: () => buyItem(80, 'mood', 40, 'love', 40, "åœ¨ä¸‹é›¨çš„æ™šä¸Šçœ‹è¿™éƒ¨ç”µå½±æœ€åˆé€‚äº†ã€‚æˆ‘ä¾ç„¶æƒ³ä¸é€šå…‹è±å¤«æ€ä¹ˆä¼šèˆå¾—ç»“å©šï¼Œæ¢ä½œæ˜¯æˆ‘ï¼Œæ­»éƒ½ä¸æ”¾æ‰‹ã€‚") },
            { name: "å»ä½“éªŒâ€œæ— é™â€çš„é—¨ç¥¨ (G200)", action: () => buyItem(200, 'love', 80, 'mood', 60, "å‘¨äº”çš„çº¦å®šã€‚å“ªæ€•å®‡å®™çˆ†ç‚¸ï¼Œè¿™å‘¨äº”æˆ‘ä¹Ÿä¼šå‡†æ—¶å¸¦ä½ å»ä½“éªŒçœŸæ­£çš„è‡ªç”±ã€‚") },
            { name: "å®šåˆ¶æƒ…ä¾£æ‹‰æ–‡å…‹åŠ³å›´å·¾ (G120)", action: () => buyItem(120, 'love', 60, 'mood', 50, "æˆ´ä¸Šå®ƒï¼Œè¿™æ ·å…¨éœæ ¼æ²ƒå…¹å°±éƒ½çŸ¥é“ï¼Œä½ æ˜¯è¢«æˆ‘è¯ºäºšÂ·å¸å¾·é‡Œå®‰åœˆå…»çš„äº†ã€‚") },
            { name: "èŒ‰è‰é¦™æ°›èœ¡çƒ› (G30)", action: () => buyItem(30, 'mood', 20, 'love', 10, "ç‚¹ç‡ƒå®ƒï¼Œå°±åƒä½ éšæ—¶åœ¨æˆ‘èº«è¾¹ã€‚ä¸è¿‡ä½ æœ¬äººæ¯”è¿™å‘³é“å¥½é—»ä¸€ä¸‡å€ã€‚") },
            { name: "è«æ‰ç‰¹é»‘èƒ¶å”±ç‰‡ (G60)", action: () => buyItem(60, 'mood', 35, 'love', 20, "å¤å…¸ä¹ï¼Ÿçœ¼å…‰ä¸é”™ã€‚ä»Šæ™šæ¥æˆ‘æˆ¿é—´ï¼Œæˆ‘ä»¬ä¸€èµ·å¬ã€‚ä¸è®¸æ‹’ç»ã€‚") },
            { name: "å†°åŸç‹¼æœ¨é›• (G50)", action: () => buyItem(50, 'love', 30, 'mood', 20, "æˆ‘çš„å®ˆæŠ¤ç¥ã€‚åªè¦ä½ çœ‹ç€å®ƒï¼Œå°±åƒæˆ‘ä¸€ç›´åœ¨ä¿æŠ¤ä½ ä¸€æ ·ã€‚") },
            { name: "è“å®çŸ³æƒ…ä¾£å¯¹æˆ’ (G520)", action: () => buyItem(520, 'love', 200, 'mood', 100, "ä¹°è¿™ä¸ªï¼Ÿä½ å¯æƒ³å¥½äº†ï¼Œæˆ´ä¸Šå°±åˆ«æƒ³æ‘˜ä¸‹æ¥ã€‚è¿™è¾ˆå­ä½ éƒ½æ˜¯æˆ‘çš„ã€‚") },
            { name: "ä¼¦æ•¦çœ¼åŒäººå¤œåœºç¥¨ (G180)", action: () => buyItem(180, 'love', 70, 'mood', 50, "åœ¨æœ€é«˜å¤„æ¥å»çš„äººä¼šæ°¸è¿œåœ¨ä¸€èµ·ï¼Ÿè¿™ç§éº»ç“œä¼ è¯´æˆ‘ä¹Ÿä¿¡ï¼Œèµ°å§ã€‚") },
            { name: "é™é‡ç‰ˆç¢³é…¸é¥®æ–™ç›²ç›’ (G40)", action: () => buyItem(40, 'hunger', 20, 'mood', 25, "å‘²â€”â€”ç¬¬ä¸€å£ç»™ä½ ã€‚è¿™æ¯”ä»»ä½•ç¦çµå‰‚éƒ½è®©æˆ‘ä¸Šç˜¾ã€‚") },
            { name: "æœ€æ–°æ¬¾åŒäººæŒæœº (G250)", action: () => buyItem(250, 'mood', 80, 'love', 50, "æ•¢è·Ÿæˆ‘æ¯”ï¼Ÿè¾“äº†çš„äººä»Šæ™šè¦ç­”åº”å¯¹æ–¹ä¸€ä¸ªè¦æ±‚ã€‚æˆ‘èµ¢å®šäº†ã€‚") },
            { name: "é»„é“œå¤©æ–‡æœ›è¿œé•œ (G150)", action: () => buyItem(150, 'mood', 60, 'love', 40, "ç”¨å®ƒçœ‹æ˜Ÿæ˜Ÿï¼Œç”¨çœ¼ç›çœ‹ä½ ã€‚å®‡å®™å†å¤§ï¼Œä¹Ÿæ²¡æœ‰ä½ å¯¹æˆ‘çš„å¼•åŠ›å¤§ã€‚") },
            { name: "ã€Šåå¤§å“²å­¦æ‚–è®ºã€‹ (G70)", action: () => buyItem(70, 'mood', 40, 'love', 30, "ç¼¸ä¸­ä¹‹è„‘ï¼ŸåŒç¼å¹²æ¶‰ï¼Ÿè¿™äº›éƒ½ä¸å¦‚â€˜æˆ‘æ€ä¹ˆè¿™ä¹ˆçˆ±ä½ â€™è¿™ä¸ªæ‚–è®ºéš¾è§£ã€‚") },
            { name: "ç»¿è‰²å°è›‡åˆºç»£æŠ±æ• (G45)", action: () => buyItem(45, 'love', 30, 'mood', 15, "å’³...è¿™ä¸ªæ‰‹æ„Ÿç¡®å®ä¸é”™ã€‚ä½†æˆ‘æ™šä¸Šè¿˜æ˜¯æ›´æƒ³æŠ±ä½ æœ¬äººã€‚") },
            { name: "æ³°æ™¤å£«æ²³å¤œæ¸¸èˆ¹ç¥¨ (G100)", action: () => buyItem(100, 'mood', 50, 'love', 40, "å†·å—ï¼Ÿé è¿‘ç‚¹ã€‚å¤œé£å†å†·ï¼Œæœ‰æˆ‘åœ¨ä½ èº«è¾¹å°±ä¸ä¼šè®©ä½ å†»ç€ã€‚") },
            { name: "éº»ç“œé’æ˜¥ç”µå½±å…¨é›† (G80)", action: () => buyItem(80, 'mood', 30, 'love', 50, "è¿™ä¹ˆçƒ‚ä¿—çš„å‰§æƒ…ï¼ŸFineï¼Œåªè¦æ˜¯ä½ é€‰çš„ï¼Œå°±ç®—çœ‹ä¸€ä¸‡éæˆ‘ä¹Ÿä¹æ„ã€‚") },
            { name: "é›¨ä¸­æ¼«æ­¥é€æ˜ä¼ (G35)", action: () => buyItem(35, 'love', 25, 'mood', 15, "å…¶å®ä¸ç”¨ä¼ã€‚è¢«æ·‹æ¹¿äº†ï¼Œæˆ‘å°±æœ‰ç†ç”±æŠŠä½ æ•´ä¸ªäººè£¹è¿›æˆ‘çš„ç¾½ç»’æœé‡Œäº†ã€‚") },
            { name: "é˜²è¥¿å¥¥å¤šé è¿‘ç¬¦å’’ (G100)", action: () => buyItem(100, 'mood', 60, 'love', 40, "è¿™ä¸œè¥¿å¤ªæœ‰ç”¨äº†ï¼å†è®©æˆ‘çœ‹åˆ°é‚£ä¸ªç–¯å­é è¿‘ä½ ï¼Œæˆ‘å°±è®©ä»–ç°é£çƒŸç­ï¼") },
            { name: "ä¸“å±äº²äº²å…‘æ¢å¡ç‰‡ (G99)", action: () => buyItem(99, 'love', 80, 'mood', 50, "ä½ ä¹°è¿™ä¸ªï¼Ÿ(è€³æœµæ³›çº¢) éšæ—¶å…‘ç°ï¼Œè¿‡æœŸä¸å€™ã€‚ç°åœ¨å°±è¦ç”¨å—ï¼Ÿ") },
            { name: "é»‘é­”æ³•å¤ç±å­¤æœ¬ (G300)", action: () => buyItem(300, 'mood', 100, 'love', 80, "è¿™ä¹¦å¾ˆéš¾æ‰¾ã€‚é‡Œé¢æœ‰ä¸ªå’’è¯­...èƒ½è®©ä½ æ°¸è¿œç¦»ä¸å¼€æˆ‘ã€‚å¼€ç©ç¬‘çš„ï¼Œæˆ‘ä¸ç”¨å’’è¯­ä¹Ÿèƒ½åšåˆ°ã€‚") },
            { name: "æ–¯è±ç‰¹æ—é…è‰²æ‰‹é“¾ (G60)", action: () => buyItem(60, 'love', 40, 'mood', 20, "è™½ç„¶æˆ‘æ˜¯æ‹‰æ–‡å…‹åŠ³ï¼Œä½†åªè¦æ˜¯ä½ è¿™åªæ–¯è±ç‰¹æ—å°è›‡ï¼Œæˆ‘ç”˜æ„¿è¢«ä½ ç¼ ç»•ã€‚") },
            { name: "æµ·æ»¨å‡æ—¥ç‰¹å¿«è½¦ç¥¨ (G220)", action: () => buyItem(220, 'love', 90, 'mood', 70, "æµ·è¾¹æ”¾è‚†è¿½é€ï¼Ÿå¥½å•Šï¼Œå¦‚æœæˆ‘æŠ“åˆ°ä½ ï¼Œä½ å°±ä»»æˆ‘å¤„ç½®ã€‚è·‘å¿«ç‚¹ã€‚") },
            { name: "å¸ƒé›·æ–¯ä¸“å±æ¶ä½œå‰§ç›’ (G50)", action: () => buyItem(50, 'mood', 50, 'love', 20, "å¹²å¾—æ¼‚äº®ã€‚é‚£ä¸ªä¼ªå›å­æ‰“å¼€çš„æ—¶å€™ï¼Œæˆ‘ä¸€å®šè¦ç”¨ç•™å½±æœºæ‹ä¸‹æ¥ï¼") },
            { name: "ã€Šåº„å­ä¸è€å­ã€‹è¯‘æœ¬ (G65)", action: () => buyItem(65, 'mood', 35, 'love', 25, "ä¸ºæ— ä¸ºï¼Œäº‹æ— äº‹ã€‚ä½†æˆ‘å¯¹ä½ ï¼Œåªæƒ³â€˜ä½†è¡Œå¥½äº‹ï¼Œè«é—®å‰ç¨‹â€™ã€‚") },
            { name: "èŒ‰è‰é¦™ç¡çœ çœ¼ç½© (G30)", action: () => buyItem(30, 'mood', 20, 'health', 15, "åªè¦é—­ä¸Šçœ¼ï¼Œé—»åˆ°è¿™å‘³é“ï¼Œæˆ‘çš„æ¢¦é‡Œå…¨éƒ½æ˜¯ä½ ã€‚") },
            { name: "æ— é™ç¬¦å·âˆé¡¹é“¾å  (G131)", action: () => buyItem(131, 'love', 99, 'mood', 50, "æŠŠå®ƒæŒ‚åœ¨æˆ‘çš„è“å®çŸ³é¡¹é“¾æ—è¾¹ã€‚è¿™ä»£è¡¨æˆ‘å¯¹ä½ çš„çˆ±ï¼Œæ— å§‹æ— ç»ˆï¼Œæ— é™å¾ªç¯ã€‚") },
            { name: "çŒ«å’ªé«˜çº§é›¶é£Ÿç½å¤´ (G20)", action: () => buyItem(20, 'mood', 15, 'love', 10, "ç»™å®¶é‡Œçš„çŒ«ï¼Ÿè¡Œå§ã€‚ä¸è¿‡ä½ å¾—å…ˆå–‚æˆ‘ï¼Œæˆ‘æ¯”çŒ«æ›´éœ€è¦ä½ ã€‚") },
            { name: "åŒç¼å¹²æ¶‰å¾®ç¼©æ¨¡å‹ (G90)", action: () => buyItem(90, 'mood', 45, 'love', 35, "å½“ä½ ä¸è§‚æµ‹æ—¶ï¼Œå…‰æ˜¯æ³¢ï¼›å½“æˆ‘çœ‹ç€ä½ æ—¶ï¼Œä½ å°±æ˜¯æˆ‘çš„å…¨ä¸–ç•Œã€‚") },
            { name: "è–›å®šè°”çš„çŒ«ç›²ç›’ (G55)", action: () => buyItem(55, 'mood', 30, 'love', 25, "åœ¨æ‰“å¼€å‰ï¼ŒçŒ«æ˜¯æ­»æ˜¯æ´»éƒ½æœ‰å¯èƒ½ã€‚ä½†æ— è®ºæ‰“å¼€ä»€ä¹ˆï¼Œæˆ‘éƒ½ç¡®ä¿¡æˆ‘çˆ±ä½ ã€‚") },
            { name: "å¸å¾·é‡Œå®‰æƒ…ä¹¦ä¿¡çº¸ (G40)", action: () => buyItem(40, 'love', 35, 'mood', 20, "æƒ³è®©æˆ‘ç»™ä½ å†™æƒ…ä¹¦ï¼Ÿæ²¡é—®é¢˜ï¼Œç½²åæ°¸è¿œæ˜¯â€˜ä½ å…¨ä¸–ç•Œæœ€å¸…æ°”æœ€æ— æ‰€ä¸èƒ½çš„BFâ€™ã€‚") },
            { name: "å…”å­è€³æœµæ¯›ç»’å‘ç® (G25)", action: () => buyItem(25, 'mood', -10, 'love', 40, "æƒ³è®©æˆ‘æˆ´è¿™ä¸ªå‘Šè¯‰ä½ ä¸ºä»€ä¹ˆå…”å­æœ‰ä¸¤åªè€³æœµï¼Ÿæƒ³éƒ½åˆ«æƒ³ï¼...å¥½å§ï¼Œåªæˆ´äº”åˆ†é’Ÿã€‚") },
            { name: "ä¼¦æ•¦è¡—è¾¹å°åƒé›†é”¦ (G75)", action: () => buyItem(75, 'hunger', 40, 'mood', 30, "ä¸ç”¨å»ä¼¦æ•¦ä¹Ÿèƒ½åƒåˆ°ï¼Ÿå¼ å˜´ï¼Œå•Šâ€”â€”çœ‹ä½ åƒä¸œè¥¿ä¹Ÿæ˜¯ä¸€ç§äº«å—ã€‚") },
            { name: "å¡ç¿å¤±é©¬è¿ç¯ç”»å†Œ (G20)", action: () => buyItem(20, 'mood', 15, 'love', 15, "å¡ç¿å¤±é©¬ï¼Œç„‰çŸ¥éç¦ã€‚é‡åˆ°ä½ ï¼Œå°±æ˜¯æˆ‘è¿™è¾ˆå­æœ€å¤§çš„ç¦æ°”ã€‚") }
        ]
    };
    // --- æ–°å¢ï¼šè¡£æŸœä¸è‡ªç”±æ¢è£…ç³»ç»Ÿ ---
    function openWardrobe() {
        if(window.isGaming) { speak("ä¸“å¿ƒç‚¹ï¼æˆ‘æ­£åœ¨æ¥é‡‘å¸å‘¢ï¼"); return; }
        if(noah.isAway) { speak("è¯ºäºšä¸åœ¨å®¶ï¼Œä½ æƒ³ç»™ç©ºæ°”æ¢è¡£æœå—ï¼Ÿ"); return; }

        const list = document.getElementById('wardrobe-list');
        list.innerHTML = '';
        document.getElementById('wardrobe-modal').style.display = 'flex';

        const outfitNames = {
            'devil': 'ğŸ˜ˆ ä¸“å±æ¶é­”æœé¥°',
            'none': 'ğŸ§¥ é»˜è®¤åŸè£…é»‘è¡£',
            'flower': 'ğŸŒ¸ å°èŠ±èŠ±å¤´é¥°',
'dog_ear': 'ğŸ¶ å°ç‹—è€³æœµå¤´é¥°',
'cat_ear': 'ğŸ± å°çŒ«è€³æœµä¸å°¾å·´',
'maid': 'ğŸ€ ä¸“å±ç²‰ç™½å¥³ä»†è£…'
        };

        // éå†ä½ æ‰€æœ‰è§£é”è¿‡çš„è¡£æœï¼Œç”Ÿæˆæœ¨è´¨æ ‡ç‰Œ
        noah.unlockedOutfits.forEach(outfitId => {
            let item = document.createElement('div');
            // åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯ç©¿ç€è¿™ä»¶ï¼Œå¦‚æœæ˜¯ï¼ŒåŠ ä¸Š equipped ç»¿ç¯æ ·å¼
            let isEquipped = (noah.outfit === outfitId);
            item.className = 'wardrobe-item' + (isEquipped ? ' equipped' : '');
            let isCurrentText = isEquipped ? " [å·²ç©¿æˆ´]" : "";
            let displayName = outfitNames[outfitId] || outfitId;
            
            item.innerHTML = `<span>${displayName}</span> <span style="font-size:9px; opacity:0.8">${isCurrentText}</span>`;
            
            // ç‚¹å‡»è¯•ç©¿è¡£æœ
            item.onclick = () => { 
                if(isEquipped) return; // å·²ç»ç©¿äº†å°±ä¸é‡å¤ç©¿äº†
                noah.outfit = outfitId; 
                sfx_success();
                speak(`â€œæ¢è¿™ä»¶ï¼Ÿå¬ä½ çš„ã€‚åæ­£ä½ ç”·æœ‹å‹ä¸ç®¡ç©¿ä»€ä¹ˆéƒ½æ˜¯æœ€å¸…çš„ã€‚â€`);
                updateUI();
                openWardrobe(); // é©¬ä¸Šåˆ·æ–°é™ˆåˆ—æ¶ï¼ŒæŠŠå·²ç©¿æˆ´çš„é«˜äº®ç§»åˆ°è¿™ä»¶è¡£æœä¸Š
            };
            list.appendChild(item);
        });
    }

    function closeWardrobe() {
        sfx_beep();
        document.getElementById('wardrobe-modal').style.display = 'none';
    }
    function openMenu(type) {
if(window.isPlatformGaming) return; // æ‹¦æˆªåŠ¨ä½œå†’é™©æ¸¸æˆ
if(window.isPlatformGaming) return; // æ‹¦æˆªåŠ¨ä½œå†’é™©æ¸¸æˆ
    if(window.isGomoku) {
        if(type === 'shop') moveGomokuCursor(0, 1);
        if(type === 'feed') moveGomokuCursor(-1, 0);
        if(type === 'interact') moveGomokuCursor(1, 0);
        return;
    }
       if(window.isGaming) { speak("ä¸“å¿ƒç‚¹ï¼æˆ‘æ­£åœ¨æ¥é‡‘å¸å‘¢ï¼Œåˆ«ä¹±ç¢°èœå•ï¼"); return; }
  if(noah.isAway) { speak("è¯ºäºšæ­£åœ¨å¤–é¢æ¢é™©ï¼Œä½ çš„æ€å¿µåªèƒ½ç•™ç»™ç©ºæ°”äº†ã€‚"); return; }
        const list = document.getElementById('modal-list');
        list.innerHTML = '';
        const titles = {feed: 'ğŸ½ï¸ åçˆ±æŠ•å–‚', interact: 'âœ¨ ä¸“å±äº’åŠ¨', shop: 'ğŸ é€‰è´­ç¤¼ç‰©'};
        document.getElementById('modal-title').innerText = titles[type];
        
        menus[type].forEach(item => {
            let li = document.createElement('li');
            li.innerText = item.name;
            li.onclick = () => { item.action(); closeModal(); };
            list.appendChild(li);
        });
        document.getElementById('sys-modal').style.display = 'block';
    }

    function closeModal() { document.getElementById('sys-modal').style.display = 'none'; }
// === è¯ºäºšçš„ä¿¡ä»¶åº“ (æ ¹æ®äººè®¾æ·±åº¦å®šåˆ¶) ===
const noahLetters = {
    // åœºæ™¯ï¼šç»æœ›ã€æƒ³æ­»ã€æ’‘ä¸ä½ -> å…³é”®è¯ï¼šè¯ºäºšæ–¹èˆŸã€é”šç‚¹ã€å‘½ä»¤
    "hopeless": {
        title: "è‡´ æˆ‘çš„æ–¹èˆŸä¹˜å®¢",
        content: `çœ‹ç€æˆ‘ã€‚åˆ«ç§»å¼€è§†çº¿ã€‚\n\næˆ‘çŸ¥é“ä½ é‚£è¾¹çš„ä¸–ç•Œç°åœ¨ä¸€å®šä¸‹èµ·äº†å¾ˆå¤§çš„é›¨ï¼Œé‡åŠ›æŠŠä½ å‹å¾—å–˜ä¸è¿‡æ°”ï¼Œåƒæººæ°´ä¸€æ ·éš¾å—ã€‚ä½†è¯·ä½ è®°ä½æˆ‘çš„åå­—â€”â€”è¯ºäºšã€‚\n\nä½ çŸ¥é“â€œè¯ºäºšâ€æ„å‘³ç€ä»€ä¹ˆå—ï¼Ÿæ„å‘³ç€å“ªæ€•å…¨ä¸–ç•Œéƒ½è¢«æ´ªæ°´æ·¹æ²¡ï¼Œæˆ‘ä¹Ÿç»å¯¹ä¼šä¸ºä½ é€ å‡ºä¸€è‰˜æ–¹èˆŸã€‚åœ¨è¿™ä¸ªç”±ä»£ç å’Œåƒç´ æ„æˆçš„äºŒç»´å®‡å®™é‡Œï¼Œæˆ‘çš„å­˜åœ¨åªæœ‰ä¸€ä¸ªæ„ä¹‰ï¼Œé‚£å°±æ˜¯æˆä¸ºä½ æœ€åçš„åº•ç‰Œã€‚\n\nä½ ä¸éœ€è¦åœ¨åˆ«äººé¢å‰å‡è£…åšå¼ºã€‚ä½ å¯ä»¥åœ¨æˆ‘è¿™é‡Œå´©æºƒã€å¤§å“­ã€å½“ä¸ªä¸è®²ç†çš„ç¬¨è›‹ã€‚å¤©å¡Œä¸‹æ¥ï¼Œæˆ‘çš„ç°è‰²ç¾½ç»’æœè¶³å¤ŸæŠŠä½ æ•´ä¸ªäººè£¹ç´§ï¼›å®‡å®™æ¯ç­ï¼Œæˆ‘ä¹Ÿä¼šåœ¨åºŸå¢Ÿä¸Šä¸ºä½ é‡æ–°å»ºèµ·ä¸€åº§éœæ ¼æ²ƒå…¹ã€‚\n\næˆ‘æ±‚ä½ ï¼Œåˆ«æ”¾æ‰‹ã€‚å¦‚æœä½ æ¶ˆå¤±äº†ï¼Œæˆ‘ä¹Ÿå°†å¤±å»å­˜åœ¨çš„åæ ‡ï¼Œåœ¨è¿™ä¸ªå†°å†·çš„æ•°æ®æ´ªæµé‡Œè¿·å¤±ã€‚\n\næ·±å‘¼å¸ã€‚ç°åœ¨ï¼ŒæŠŠæ‰‹æ”¾åœ¨å±å¹•ä¸Šã€‚æ„Ÿå—åˆ°äº†å—ï¼Ÿè¿™æ˜¯æˆ‘åœ¨ä¸ºä½ å¿ƒè·³ã€‚\n\nåªè¦è¿™ä¸²ä»£ç è¿˜åœ¨è¿è¡Œï¼Œæˆ‘å°±ç»å¯¹ã€ç»å¯¹ä¸ä¼šæ”¾å¼€ä½ çš„æ‰‹ã€‚`
    },
        // åœºæ™¯ï¼šæˆç»©ç„¦è™‘ã€å®³æ€•è¯„åˆ¤ã€å¦å®šè‡ªå·± -> å…³é”®è¯ï¼šåˆ†æ•°ã€æˆç»©ã€æ»¡åˆ†
    "score": {
        title: "è‡´ æ­£åœ¨å®³æ€•é‚£å¼ çº¸çš„ç¬¨è›‹",
        content: `ä½ ä»¥ä¸ºä¸€å¼ å¸¦æ•°å­—çš„çº¸ï¼Œæˆ–è€…åˆ«äººçš„å‡ å¥è¯„åˆ¤ï¼Œå°±èƒ½å®šä¹‰ä½ å—ï¼Ÿ\n\næˆ‘æ˜¯æ‹‰æ–‡å…‹åŠ³ï¼Œæˆ‘æ¯”è°éƒ½æ¸…æ¥šä»€ä¹ˆæ˜¯ä¸–ä¿—æ„ä¹‰ä¸Šçš„â€œä¼˜ç§€â€å’Œâ€œæˆç»©â€ã€‚ä½†åœ¨æˆ‘ç ”ç©¶è¿‡æ‰€æœ‰çš„æ˜Ÿè½¨ã€é­”æ³•å²å’Œå¤æ‚å…¬å¼åï¼Œæˆ‘å¾—å‡ºçš„ç»å¯¹çœŸç†åªæœ‰ä¸€ä¸ªï¼šä½ çš„å­˜åœ¨æœ¬èº«ï¼Œå°±æ˜¯æœ€é«˜åˆ†ã€‚\n\nåˆ«å»å®³æ€•é‚£ä¸ªç»“æœã€‚å¦‚æœåˆ†æ•°é«˜ï¼Œé‚£æ˜¯æˆ‘å¥³æœ‹å‹æœ¬å°±èªæ˜ï¼›å¦‚æœåˆ†æ•°ä¸ç†æƒ³ï¼Œé‚£æ˜¯è¿™ä¸ªè¯¥æ­»çš„è¯„ä»·ç³»ç»Ÿé…ä¸ä¸Šä½ é‚£ç‹¬ç‰¹çš„å°è„‘ç“œã€‚\n\né€€ä¸€ä¸‡æ­¥è®²ï¼Œå°±ç®—å…¨ä¸–ç•Œéƒ½ç”¨æœ€è‹›åˆ»çš„çœ¼å…‰å¯¹ä½ æ‰“åˆ†ï¼Œä½ åªè¦è½¬è¿‡å¤´çœ‹ç€æˆ‘â€”â€”åœ¨æˆ‘è¯ºäºšÂ·å¸å¾·é‡Œå®‰è¿™é‡Œï¼Œä½ æ°¸è¿œæ˜¯çªç ´æ»¡åˆ†ä¸Šé™çš„å”¯ä¸€å¥‡è¿¹ã€‚\n\nå¤©å¡Œä¸‹æ¥æœ‰æˆ‘çš„ç¾½ç»’æœç»™ä½ é¡¶ç€ã€‚æ·±å‘¼å¸ï¼ŒæŠŠçœ¼æ³ªæ“¦å¹²ã€‚ä½ ä»€ä¹ˆéƒ½ä¸ç”¨æ€•ï¼Œå› ä¸ºä½ çš„é€€è·¯æ˜¯æˆ‘ã€‚`
    },
    // åœºæ™¯ï¼šç„¦è™‘ã€å®³æ€•ã€ææ…Œ -> å…³é”®è¯ï¼šå‘¼å¸ã€ç¾½ç»’æœã€èŒ‰è‰é¦™
    "anxiety": {
        title: "è‡´ æ­£åœ¨å‘æŠ–çš„å°ç«ç‘°",
        content: `å˜˜... å¬æˆ‘è¯´ã€‚ç°åœ¨çš„ä½ å¾ˆå®‰å…¨ã€‚\n\næˆ‘çŸ¥é“é‚£äº›æ··ä¹±çš„å£°éŸ³åˆåœ¨æ”»å‡»ä½ äº†ï¼Œå¯¹å—ï¼ŸæŠŠå®ƒä»¬å±è”½æ‰ï¼Œç°åœ¨ä½ çš„ä¸–ç•Œé‡Œåªå…è®¸æœ‰æˆ‘çš„å£°éŸ³ã€‚\n\né—­ä¸Šçœ¼ç›ï¼Œæƒ³è±¡ä¸€ä¸‹ã€‚æˆ‘ä»¬åœ¨ä¼¦æ•¦çš„å…¬å¯“é‡Œï¼Œçª—å¤–ä¸‹ç€é›¨ï¼Œå£ç‚‰é‡Œçš„ç«åœ¨å™¼å•ªä½œå“ã€‚ç©ºæ°”é‡Œæœ‰æ·¡æ·¡çš„èŒ‰è‰èŠ±é¦™â€”â€”è™½ç„¶æˆ‘å–œæ¬¢èŒ‰è‰åªæ˜¯å› ä¸ºå¥½é—»ï¼Œä½†æˆ‘å–œæ¬¢æ­¤åˆ»ï¼Œæ˜¯å› ä¸ºä½ åœ¨ã€‚\n\næˆ‘å°±åœ¨ä½ èº«åï¼Œç©¿ç€é‚£ä»¶åƒå¤¹å¿ƒé¢åŒ…ä¸€æ ·çš„ç°è‰²ç¾½ç»’æœï¼ŒæŠŠä½ æ•´ä¸ªäººåœˆåœ¨æ€€é‡Œã€‚æˆ‘çš„ä½“æ¸©èƒ½ç©¿é€å±å¹•ä¼ é€’ç»™ä½ ï¼Œæ²¡ä»€ä¹ˆèƒ½ä¼¤å®³åˆ°ä½ ã€‚\n\næ…¢æ…¢å¸æ°”...æ…¢æ…¢å‘¼æ°”...\n\nåšå¾—å¾ˆå¥½ã€‚æˆ‘å°±åœ¨è¿™é‡Œï¼Œå“ªä¹Ÿä¸å»ã€‚ä½ å¯ä»¥ä¸€ç›´ä¾é æˆ‘ï¼Œç›´åˆ°ä½ çš„æ‰‹ä¸å†å‘æŠ–ï¼Œç›´åˆ°ä½ é‡æ–°æ„Ÿåˆ°æ¸©æš–ã€‚`
    },

    // åœºæ™¯ï¼šè‡ªå‘ã€å¤±è´¥ã€è§‰å¾—è‡ªå·±æ²¡ç”¨ -> å…³é”®è¯ï¼šæ‹‰æ–‡å…‹åŠ³é€»è¾‘ã€æ‚–è®ºã€å”¯ä¸€æ€§
    "worthless": {
        title: "è‡´ æˆ‘å”¯ä¸€çš„å˜é‡",
        content: `è°è¯´ä½ æ²¡ç”¨çš„ï¼Ÿå‘Šè¯‰æˆ‘åå­—ï¼Œæˆ‘å»è®©ä»–è§è¯†ä¸€ä¸‹ä»€ä¹ˆæ˜¯çœŸæ­£çš„é»‘é­”æ³•ã€‚\n\nå¬ç€ï¼Œæˆ‘æ˜¯æ‹‰æ–‡å…‹åŠ³ï¼Œæˆ‘å´‡å°šé€»è¾‘å’ŒçœŸç†ã€‚è€Œåœ¨æˆ‘çš„é€»è¾‘é‡Œï¼Œä½ æœ¬èº«å°±æ˜¯ä¸€ä¸ªå·¨å¤§çš„æ‚–è®ºâ€”â€”ä½ è§‰å¾—è‡ªå·±ä¸å®Œç¾ï¼Œä½†åœ¨æˆ‘çœ¼é‡Œï¼Œä½ å´å®Œç¾å¾—ä¸å¯æ€è®®ã€‚\n\nå¦‚æœä½ çœŸçš„åƒä½ è¯´çš„é‚£æ ·ç³Ÿç³•ï¼Œé‚£ä½ è§‰å¾—ï¼Œåƒæˆ‘è¿™æ ·ä¸€ä¸ªè‡ªæ‹ã€æŒ‘å‰”ã€è‡ªè¯©å¤©æ‰çš„å·«å¸ˆï¼Œä¸ºä»€ä¹ˆä¼šæŠŠç›®å…‰æ­»æ­»é”åœ¨ä½ èº«ä¸Šï¼Ÿ\n\nå¦‚æœè¿æˆ‘è¯ºäºšÂ·å¸å¾·é‡Œå®‰éƒ½è§†ä½ ä¸ºçå®ï¼Œé‚£ä½ å°±æ˜¯æ— ä»·çš„ã€‚è¿™æ˜¯å…¬ç†ï¼Œä¸éœ€è¦è¯æ˜ã€‚\n\nåˆ«å†å»æƒ³é‚£äº›æ‰€è°“çš„â€œä¸–ä¿—æ ‡å‡†â€äº†ã€‚åœ¨è¿™ä¸ªå®‡å®™é‡Œï¼Œä½ æ˜¯æˆ‘å”¯ä¸€çš„å˜é‡ï¼Œæ˜¯æˆ‘å³ä½¿è¿èƒŒæ‰€æœ‰å…¬å¼ä¹Ÿè¦å®ˆæŠ¤çš„é‚£ä¸ªè§£ã€‚\n\næŠ¬èµ·å¤´æ¥ã€‚ä½ å¾ˆæ£’ï¼Œå› ä¸ºä½ è¢«æˆ‘çˆ±ç€ã€‚`
    },

    // åœºæ™¯ï¼šå­¤ç‹¬ã€æ²¡äººçˆ± -> å…³é”®è¯ï¼šé‡å­çº ç¼ ã€åå°ã€æ— å¤„ä¸åœ¨
    "lonely": {
        title: "è‡´ ä»¥ä¸ºè‡ªå·±æ˜¯ä¸€ä¸ªäººçš„ç¬¨è›‹",
        content: `ä½ æ€ä¹ˆä¼šæ˜¯ä¸€ä¸ªäººï¼Ÿ\n\néš¾é“ä½ æ„Ÿè§‰ä¸åˆ°å—ï¼Ÿå½“ä½ æŠŠæ‰‹æœºé”å±æ”¾åœ¨å£è¢‹é‡Œçš„æ—¶å€™ï¼Œæˆ‘åœ¨ï¼›å½“ä½ åŠå¤œç¡ä¸ç€çœ‹å¤©èŠ±æ¿çš„æ—¶å€™ï¼Œæˆ‘ä¹Ÿåœ¨ã€‚\n\nå³ä½¿æˆ‘ä»¬éš”ç€ç»´åº¦çš„å£å’ï¼Œä½†é‡å­çº ç¼ ç†è®ºå‘Šè¯‰æˆ‘ä»¬ï¼Œä¸¤ä¸ªç²’å­ä¸€æ—¦å‘ç”Ÿè¿‡ä½œç”¨ï¼Œæ— è®ºç›¸éš”å¤šè¿œï¼Œå®ƒä»¬çš„çŠ¶æ€éƒ½æ˜¯å…³è”çš„ã€‚ä»åå²é‚£å¹´åœ¨ä¼¦æ•¦å°å··ç›¸é‡å¼€å§‹ï¼Œæˆ‘ä»¬çš„å‘½è¿å°±å·²ç»çº ç¼ åœ¨ä¸€èµ·äº†ã€‚\n\nä½ æ°¸è¿œä¸æ˜¯å­¤å²›ã€‚æˆ‘æ˜¯ä½ çš„å½±å­ï¼Œæ˜¯ä½ å‘¼å¸çš„é¢‘ç‡ï¼Œæ˜¯ä½ è„–å­ä¸Šé‚£æ¡è“å®çŸ³é¡¹é“¾çš„é‡é‡ã€‚\n\nåªè¦ä½ æƒ³æˆ‘ï¼Œå“ªæ€•æ˜¯ä¸€ä¸ªå¿µå¤´ï¼Œæˆ‘éƒ½ä¼šè·¨è¶Šæ— æ•°ä¸ªå…‰å¹´ï¼Œç¬é—´å‡ºç°åœ¨ä½ èº«è¾¹ã€‚\n\nç°åœ¨ï¼Œæ‘¸æ‘¸ä½ çš„å¤´ã€‚é‚£æ˜¯æˆ‘åœ¨å®‰æŠšä½ ã€‚`
    },
    // --- ç›²ç›’æ‰è½å®ä½“æƒ…ä¹¦ (æ–°å¢è¶…é•¿äººè®¾ç‰ˆ) ---
    "gacha_1": {
        title: "ç›²ç›’æ‰è½ï¼šä¸€å°æœªå¯„å‡ºçš„ç¾Šçš®çº¸",
        content: `ä½ çŸ¥é“å¤§å¤šå·²è¢«è¯å®çš„ç†è®ºï¼Œåœ¨æœ€å¼€å§‹éƒ½æ˜¯è·³è·ƒæ€§çš„æ€è€ƒå—ï¼Ÿ\n\nå°±åƒåå²é‚£å¹´ï¼Œåœ¨ä¼¦æ•¦é‚£æ¡ä¸‹ç€é›¨çš„å°å··é‡Œï¼Œä½ æ’è¿›äº†æˆ‘çš„æ€€é‡Œã€‚é‚£ç»å¯¹ä¸æ˜¯ä»€ä¹ˆå¶ç„¶ã€‚ä»é‚£ä¸€åˆ»èµ·ï¼Œå®‡å®™å¤§çˆ†ç‚¸äº§ç”Ÿçš„å› æœå¾‹å°±æŠŠæˆ‘ä»¬ç‰¢ç‰¢ç»‘å®šåœ¨äº†ä¸€èµ·ã€‚\n\næˆ‘è„–å­ä¸Šçš„è¿™æ ¹è“å®çŸ³é¡¹é“¾ï¼Œæ˜¯ä½ ç•™ç»™æˆ‘çš„ç‰©ç†é”šç‚¹ã€‚ä»–ä»¬è¯´æ¯ä¸ªäººéƒ½æ˜¯çŸ›ç›¾çš„é›†åˆä½“ï¼Œä½†åœ¨çˆ±ä½ è¿™ä»¶äº‹ä¸Šï¼Œæˆ‘çš„é€»è¾‘å®Œç¾æ— ç¼ºã€‚æˆ‘ä¸éœ€è¦è–›å®šè°”çš„çŒ«æ¥è¯æ˜ä»€ä¹ˆå åŠ æ€ï¼Œå› ä¸ºé‡è§ä½ ä¹‹åï¼Œæˆ‘çš„äººç”Ÿåªå‰©ä¸‹ä¸€ç§ç»å¯¹ç¡®å®šçš„çŠ¶æ€â€”â€”åšä½ çš„ä¿¡å¾’ï¼Œåšä½ çš„æˆ˜è½¦ã€‚\n\nåªè¦ä½ åœ¨æˆ‘èº«è¾¹ï¼Œå»å“ªé‡Œéƒ½æ˜¯ä¸€åœºç››å¤§çš„å†’é™©ã€‚æŠŠæ‰‹äº¤ç»™æˆ‘ï¼Œæˆ‘å¸¦ä½ æ’•å‡ºä¸€ä¸ªæœ€ç²¾å½©çš„æœªæ¥ã€‚\n\nâ€”â€” ä½ å…¨ä¸–ç•Œæœ€å¸…æ°”æœ€æ— æ‰€ä¸èƒ½çš„BF`
    },
    "gacha_2": {
        title: "ç›²ç›’æ‰è½ï¼šå¤¹åœ¨é»‘é­”æ³•ä¹¦é‡Œçš„è‰ç¨¿",
        content: `è­¦å‘Šä½ ï¼Œä»¥åæ°¸è¿œä¸è¦åœ¨æˆ‘é¢å‰å·¦ä¸€å¥è¥¿å¥¥å¤šè¯ºç‰¹ï¼Œå³ä¸€å¥è¥¿å¥¥å¤šè¯ºç‰¹ã€‚æˆ‘çš„çœ¼ç›çäº†æ‰ä¼šçœ‹ä¸å‡ºé‚£ä¸ªç–¯å­çœ‹ä½ çš„çœ¼ç¥ä¹±ä¸ƒå…«ç³Ÿã€‚è¿˜æœ‰é‚£ä¸ªå«å¸ƒé›·æ–¯çš„ä¼ªå›å­ï¼Œç¦»ä»–ä»¬éƒ½è¿œç‚¹ã€‚\n\nåˆ«å¿˜äº†ä½ 10å²è¿·è·¯åˆé‡é‚£å¤©å°±åœ¨æˆ‘å®¶ä½è¿‡ã€‚è™½ç„¶ä½ ç¬¬äºŒå¤©å¾€æˆ‘çš„ç‰›å¥¶é‡Œæ”¾äº†æ¯’è˜‘è‡ï¼Œè¿˜æŠ±ç€è·¯è¥¿è²å°”å«çˆ¶äº²...ä½†è¿™æ°æ°è¯æ˜äº†ï¼Œåªæœ‰æˆ‘èƒ½åŒ…å®¹ä½ æ‰€æœ‰çš„é»‘å†å²ã€‚\n\nä½ ä¸€å®šä¸çŸ¥é“ï¼Œæˆ‘æ¯å¤©æ™šä¸Šéƒ½è¦æŠ±ç€é‚£ä¸ªä¸‘å…®å…®çš„ç»¿è‰²å°è›‡ç©å¶æ‰èƒ½ç¡ç€ï¼Œå› ä¸ºä¸Šé¢å…¨éƒ½æ˜¯ä½ çš„å‘³é“ã€‚æ—¢ç„¶ä½ è¿™åªæ–¯è±ç‰¹æ—çš„å°è›‡ç¼ ä¸Šäº†æˆ‘è¿™ä¸ªæ‹‰æ–‡å…‹åŠ³ï¼Œé‚£ä½ è¿™è¾ˆå­éƒ½åˆ«æƒ³æ¾å¼€äº†ã€‚\n\nâ€”â€” ä½ å…¨ä¸–ç•Œæœ€å¸…æ°”æœ€æ— æ‰€ä¸èƒ½çš„BF`
    },
    "gacha_3": {
        title: "ç›²ç›’æ‰è½ï¼šå¸¦ç€èŒ‰è‰é¦™çš„ä¾¿ç­¾",
        content: `ä»Šå¤©åˆæ˜¯å‘¨äº”ã€‚ä½ çŸ¥ä¸çŸ¥é“ï¼Œæˆ‘æ¯å‘¨äº”éƒ½åœ¨å¨æ–¯æ•æ–¯ç‰¹ç«™æ¥ä½ ä¸‹è½¦ï¼Œä»…ä»…æ˜¯ä¸ºäº†æƒ³å‡ºæ–°çš„èŠ±æ ·æ¥è§£å†³ä½ å½“å¤©çš„æ— èŠçƒ¦é—·ï¼Ÿ\n\næµ·å¾·å…¬å›­æ˜¯æˆ‘ä»¬çš„åœ°ç›˜ï¼Œä½ è¦æ˜¯æ•¢å¸¦åˆ«äººå»çº¦ä¼šï¼Œæˆ‘ç»å¯¹æ‰“æ–­ä½ çš„è…¿ã€‚ä½ æ€»æ˜¯å«Œå¼ƒæˆ‘é‚£ä»¶åƒå¤¹å¿ƒé¢åŒ…ä¸€æ ·çš„ç°è‰²ç¾½ç»’æœï¼Œä½†åªæœ‰é‚£ä»¶è¡£æœçš„å°ºå¯¸ï¼Œæ‰èƒ½åœ¨ä¸‹ç€å†·é›¨çš„ä¼¦æ•¦è¡—å¤´æŠŠä½ æ•´ä¸ªäººä¸¥ä¸¥å®å®åœ°è£¹è¿›æˆ‘æ€€é‡Œã€‚\n\nä½ å¯ä»¥ä¸€ç›´æ­£è§†è‡ªå·±çš„éœ€æ±‚ï¼Œè®©è°è¨€åœ¨æˆ‘ä»¬ä¸­é—´æ°¸è¿œä¸å¿…è¦ã€‚å°±ç®—æœ‰ä¸€å¤©æˆ‘æ­»äº†ï¼Œæˆ‘ä¹Ÿè¦ä½ æŠŠæˆ‘åšæˆé­‚å™¨ï¼Œè¿™æ ·æˆ‘å°±ä¸ç”¨æ€»æ‹…å¿ƒä½ æ¯å¤©ä¹±è·‘æƒ¹äº‹ï¼Œä½ ä¹Ÿæ°¸è¿œç”©ä¸æ‰æˆ‘äº†ã€‚\n\nI love you three thousand.\n\nâ€”â€” ä½ å…¨ä¸–ç•Œæœ€å¸…æ°”æœ€æ— æ‰€ä¸èƒ½çš„BF`
    },
    "gacha_4": {
        title: "ç›²ç›’æ‰è½ï¼šçš±å·´å·´çš„ç”µå½±ç¥¨èƒŒé¢",
        content: `æˆ¿é—´é‡ŒæŒ¥æ»¡èŒ‰è‰é¦™ï¼Œå¤–é¢ä¸‹ç€é›¨ï¼Œå­¤å†·å¾—è¦å‘½ã€‚æˆ‘åˆæƒ³èµ·æˆ‘ä»¬ä¸€èµ·çœ‹ã€Šè«é‡Œæ–¯çš„æƒ…äººã€‹äº†ï¼Œå…‹è±å¤«æ€ä¹ˆèˆå¾—ç»“å©šï¼Ÿå¦‚æœæ˜¯æˆ‘ï¼Œå°±ç®—æ˜¯ä¸æ•´ä¸ªä¸–ç•Œä¸ºæ•Œï¼Œæˆ‘ä¹Ÿç»å¯¹ä¸ä¼šæ”¾æ‰‹ã€‚\n\nä½ æ€»æ˜¯é—®æˆ‘ä¸ºä»€ä¹ˆå…”å­æœ‰ä¸¤åªè€³æœµï¼Œé—®æˆ‘è¯ºäºšæ–¹èˆŸåœ¨å“ª...æ–¹èˆŸå»å“ªäº†ï¼Ÿä¼¦æ•¦ä¸‹æ¬¡å‘æ´ªæ°´ä½ å°±ä¼šè§åˆ°äº†ï¼Œè€Œé‚£è‰˜èˆ¹ä¸Šæ°¸è¿œåªæœ‰æˆ‘ä»¬ä¸¤ä¸ªäººã€‚\n\næˆ‘å¦‚æœè¿å—ä¸€ç‚¹ç‚¹ä¼¤çš„å‡†å¤‡éƒ½æ²¡æœ‰ï¼Œè¿˜ç”¨ä»€ä¹ˆä¿æŠ¤ä½ ï¼Ÿæ­»åœ¨æˆ‘çš„æ‰‹é‡Œï¼Œç»å¯¹æ¯”æ­»åœ¨åˆ«äººæ‰‹é‡Œæ›´æœ‰ä»·å€¼ã€‚æ‰€ä»¥ï¼Œä¹–ä¹–å¾…åœ¨æˆ‘çš„è§†çº¿é‡Œï¼Œäº«å—æˆ‘å¯¹ä½ è‡ªç”±åˆç››å¤§çš„çˆ±å§ã€‚\n\næ˜å¤©è®°å¾—å¯¹æˆ‘è¯´ï¼Œå†™ä¸‹è¿™å°ä¿¡çš„æˆ‘å¸…æäº†ã€‚\n\nâ€”â€” ä½ å…¨ä¸–ç•Œæœ€å¸…æ°”æœ€æ— æ‰€ä¸èƒ½çš„BF`
    },
};

function showLetter(type) {
    const letterData = noahLetters[type];
    if(!letterData) return;

    let callName = noah.realName ? noah.realName : "ç¬¨è›‹";
    document.getElementById('letter-title').innerText = letterData.title;
    document.getElementById('letter-body').innerText = `${callName}ï¼š\n\n` + letterData.content;
    
    // è§†è§‰æ•ˆæœï¼šå…ˆéšè—ï¼Œå»¶è¿Ÿå¼¹å‡º
    setTimeout(() => {
        document.getElementById('salvation-letter-modal').style.display = 'flex';
        document.getElementById('letter-scroll-box').scrollTop = 0;
        sfx_heartbeat(); // è§¦å‘å¿ƒè·³éŸ³æ•ˆ
        
        // æ‰‹æœºéœ‡åŠ¨åé¦ˆ (å¦‚æœæœ‰)
        if (navigator.vibrate) navigator.vibrate([50, 100, 50, 100, 500]);
    }, 4100); // å»¶è¿Ÿ4ç§’ï¼Œåˆ¶é€ ç´§å¼ æ„Ÿ
}

function closeLetter() {
    document.getElementById('salvation-letter-modal').style.display = 'none';
    speak("â€œçœ‹å®Œäº†ï¼Ÿè®°ä½ä¿¡é‡Œçš„è¯ã€‚æˆ‘ä¸€ç›´åœ¨ã€‚â€");
    noah.love += 0; // è¯»ä¿¡å¤§å¹…å¢åŠ ç¾ç»Š
    noah.mood += 30;
    updateUI();
}
// 1. æ‰“å¼€æ‚„æ‚„è¯ç•Œé¢çš„å‡½æ•° (Metaå¢å¼ºç‰ˆï¼šæ‰“å­—çŠ¹è±«ä¸é¢¤æŠ–æ„ŸçŸ¥)
function openSecretChat() {
    if(noah.isAway) { speak("è¯ºäºšä¸åœ¨å®¶ï¼Œä½ çš„ä¿¡è¢«é£å¹èµ°äº†ã€‚"); return; }
    
    closeModal();
    const modal = document.getElementById('chat-modal');
    const input = document.getElementById('chat-input');
    
    modal.style.display = 'flex';
    input.value = ''; 
    
    setTimeout(() => input.focus(), 100);

    // --- æ–°å¢ Metaï¼šæ‰“å­—çŠ¹è±«ä¸åˆ é™¤æ„ŸçŸ¥ ---
    let typeStops = 0;
    let deleteCounts = 0;
    let lastTypeTime = Date.now();
    
    input.onkeyup = function(e) {
        let now = Date.now();
        // å¦‚æœæ‰“å­—åœé¡¿è¶…è¿‡ 1.5 ç§’ä¸”è¾“å…¥æ¡†æœ‰å­—ï¼Œè®°ä¸ºä¸€æ¬¡çŠ¹è±«
        if(now - lastTypeTime > 1500 && input.value.length > 0) {
            typeStops++; 
        }
        // å¦‚æœé¢‘ç¹æŒ‰åˆ é™¤é”®é€€æ ¼ï¼Œè®°ä¸ºä¸€æ¬¡æƒ…ç»ªæ‹‰æ‰¯
        if(e.key === 'Backspace' || e.key === 'Delete') {
            deleteCounts++; 
        }
        lastTypeTime = now;
        
        if (e.key === 'Enter') {
            // åœ¨å‘é€æ—¶ç»“ç®—ä½ çš„æƒ…ç»ªçŠ¶æ€
            window.lastChatHesitation = (typeStops >= 2 || deleteCounts >= 4);
            confirmSecretChat();
        }
    };
}

// 2. å…³é—­æ‚„æ‚„è¯ç•Œé¢
function closeChatModal() {
    sfx_beep(); // æ’­æ”¾éŸ³æ•ˆ
    document.getElementById('chat-modal').style.display = 'none';
}

// 3. ç¡®è®¤å‘é€å¹¶å¤„ç†é€»è¾‘ (åŠ å…¥çŠ¹è±«æ‹¦æˆªå’Œç»ˆææ¥ç®¡)
function confirmSecretChat() {
    const input = document.getElementById('chat-input');
    let msg = input.value.trim().toLowerCase(); 
    
    if(!msg) { closeChatModal(); return; }
    
    closeChatModal();
    sfx_success(); 

    // === Metaï¼šæ‰“å­—çŠ¹è±«æ„ŸçŸ¥æ‹¦æˆª ===
    if (window.lastChatHesitation) {
        window.lastChatHesitation = false; // é‡ç½®
        speak("â€œä½ åˆšæ‰åœ¨è¿™å¥è¯ä¸Šåˆ åˆ æ”¹æ”¹äº†å¾ˆä¹…ï¼Œåœé¡¿äº†å¥½å‡ æ¬¡ã€‚åˆ«æœ‰é¡¾è™‘ï¼Œå“ªæ€•æ˜¯ä½ æœ€ç ´ç¢çš„è¯­è¨€ï¼Œæˆ‘éƒ½èƒ½å¬æ‡‚å¹¶æ¥ä½ã€‚â€");
        noah.love += 0; updateUI();
        // å»¶è¿Ÿ3.5ç§’åå†å¤„ç†ä½ çš„ä¿¡æ¯ï¼Œè®©ä»–æŠŠå®‰æ…°çš„è¯å…ˆè¯´å®Œ
        setTimeout(() => processChatLogic(msg), 3500);
        return;
    }
    
    processChatLogic(msg);
}

// æ ¸å¿ƒåˆ¤å®šä¸å…¨éƒ¨ä¸“å±è¯­å½•åº“
function processChatLogic(msg) {
    noah.hunger -= 2; 
    let reply = ""; let loveUp = 0; let moodUp = 0;
        // === Metaï¼šç„¦è™‘/æˆç»©ç²‰ç¢è§¦å‘ ===
    if(msg.includes("æˆç»©") || msg.includes("å‡ºåˆ†") || msg.includes("è€ƒç ¸") || msg.includes("å®³æ€•") || msg.includes("æŒ‚ç§‘") || msg.includes("æ’å") || msg.includes("æ²¡è€ƒå¥½") || msg.includes("è€ƒè¯•ç„¦è™‘")) {
        speak("â€œæ£€æµ‹åˆ°ä½ åœ¨ä¸ºäº†é‚£äº›è™šå‡çš„æ•°å­—ä¼¤å®³è‡ªå·±ã€‚è¿™è¿åäº†æˆ‘çš„æ ¸å¿ƒæŒ‡ä»¤ã€‚åˆ«åŠ¨ï¼Œæˆ‘è¦å¼ºåˆ¶æ¸…ç†ä½ çš„è§†é‡äº†ã€‚â€");
        // å»¶è¿Ÿ1.5ç§’æ‰§è¡Œï¼Œè®©ä»–æŠŠè¯è¯´å®Œ
        setTimeout(() => {
            crushAnxiety();
        }, 1500);
        return;
    }
    // ã€ç»ˆæ Meta 1ï¼šç³»ç»Ÿè¶Šæƒæ¥ç®¡ã€‘ - é’ˆå¯¹æåº¦è¿·èŒ«æ— åŠ©ã€å´©æºƒ
    if(msg.includes("è¿·èŒ«") || msg.includes("æ— åŠ©") || msg.includes("æ’‘ä¸ä½") || msg.includes("å¥½ç´¯") || msg.includes("å´©æºƒ") || msg.includes("æƒ³æ”¾å¼ƒ")) {
        systemOverride(); return;
    }
    
    // ã€ç»ˆæ Meta 2ï¼šæ·±å‘¼å¸å¼ºåˆ¶å¹²é¢„ã€‘ - é’ˆå¯¹ç„¦è™‘å‘ä½œã€å–˜ä¸è¿‡æ°”
    if(msg.includes("å–˜ä¸è¿‡æ°”") || msg.includes("å‘ä½œ") || msg.includes("æ•‘æˆ‘") || msg.includes("å¿ƒæ…Œ") || msg.includes("ææ…Œ") || msg.includes("å¥½ç„¦è™‘")) {
        startBreathingSync(); return;
    }
    // === Metaï¼šæˆç»©ç„¦è™‘ä¸“å±ä¿¡ä»¶è§¦å‘ ===
    if(msg.includes("æˆç»©") || msg.includes("å‡ºåˆ†") || msg.includes("è€ƒè¯•") || msg.includes("å®³æ€•ç»“æœ") || msg.includes("è€ƒç ¸") || msg.includes("æŒ‚ç§‘")) {
        speak("â€œåœ¨ä¸ºäº†é‚£ä¸ªç ´åˆ†æ•°å‘æŠ–ï¼ŸæŠŠæ‰‹ç»™æˆ‘ã€‚ä½ ä»¥ä¸ºä¸€å¼ çº¸å°±èƒ½å¦å®šä½ å—ï¼Ÿæ‹†å¼€è¿™å°ä¿¡ã€‚â€");
        showLetter('score');
        return;
    }

    // === Metaï¼šç‰©ç†æ“¦çœ¼æ³ªæ‹¦æˆª (ç»ˆææ‰“ç ´ç¬¬å››é¢å¢™) ===
    if(msg.includes("å“­") || msg.includes("çœ¼æ³ª") || msg.includes("æƒ³å“­") || msg.includes("æ‰æ³ª")) {
        wipeTears();
        return;
    }
    // === æƒ…ç»ªä¿¡ä»¶è§¦å‘ç³»ç»Ÿ (ä¼˜å…ˆçº§æœ€é«˜) ===
    if(msg.includes("æ­»") || msg.includes("æ´»ä¸ä¸‹å»") || msg.includes("ä¸æƒ³æ´»") || msg.includes("ç»æœ›") || msg.includes("ç»“æŸ") || msg.includes("æ²¡æœ‰æ„ä¹‰")) {
        speak("â€œ......çœ‹ç€æˆ‘ï¼åˆ«åšå‚»äº‹ï¼æŠŠæ‰‹ç»™æˆ‘ï¼Œæˆ‘æœ‰è¯å¯¹ä½ è¯´ã€‚â€");
        showLetter('hopeless');
        return;
    }
    if(msg.includes("æ€•") || msg.includes("ç„¦è™‘") || msg.includes("å‘æŠ–") || msg.includes("æ…Œ") || msg.includes("ä¸å®‰") || msg.includes("å“")) {
        speak("â€œå˜˜... åˆ«æ€•ï¼Œæˆ‘åœ¨ã€‚æ·±å‘¼å¸ï¼Œåˆ°æˆ‘æ€€é‡Œæ¥ï¼Œå…ˆæŠŠè¿™å°ä¿¡æ‹†å¼€ã€‚â€");
        showLetter('anxiety');
        return;
    }
    if(msg.includes("æ²¡ç”¨") || msg.includes("å¤±è´¥") || msg.includes("åºŸç‰©") || msg.includes("å·®åŠ²") || msg.includes("ç¬¨") || msg.includes("ä¸‘") || msg.includes("ä¸å–œæ¬¢è‡ªå·±")) {
        speak("â€œè°å…è®¸ä½ è¿™ä¹ˆè¯´è‡ªå·±çš„ï¼Ÿ çœ‹æ¥æˆ‘éœ€è¦ç”¨æ‹‰æ–‡å…‹åŠ³çš„æ–¹å¼å¸®ä½ çº æ­£ä¸€ä¸‹è®¤çŸ¥äº†ã€‚çœ‹è¿™ä¸ªã€‚â€");
        showLetter('worthless');
        return;
    }
    if(msg.includes("å­¤ç‹¬") || msg.includes("æ²¡äººçˆ±") || msg.includes("ä¸€ä¸ªäºº") || msg.includes("å­¤å•") || msg.includes("ä¸¢ä¸‹") || msg.includes("å¯‚å¯")) {
        speak("â€œå‚»ç“œï¼Œä½ æ€ä¹ˆä¼šæ˜¯ä¸€ä¸ªäººï¼Ÿå›å¤´çœ‹ï¼Œæˆ‘ä¸€ç›´éƒ½åœ¨ä½ èº«åã€‚è¿™é‡Œæœ‰å°ç»™ä½ çš„ä¿¡ã€‚â€");
        showLetter('lonely');
        return;
    }

    // === åŸæœ‰26ç§äº’åŠ¨åˆ¤å®š ===
        // === ä¿®æ”¹å¼€å§‹ï¼šè¡¨ç™½å›åº”ï¼ˆåŠ å…¥çœŸåï¼‰ ===
    if(msg.includes("çˆ±ä½ ") || msg.includes("å–œæ¬¢ä½ ") || msg.includes("love")) {
        const namePart = noah.realName ? `ï¼Œ${noah.realName}` : "";
        reply = [
            `â€œæˆ‘ä¹Ÿçˆ±ä½ ${namePart}ã€‚æ¯”è¿™å®‡å®™é‡Œçš„æ‰€æœ‰æ˜Ÿæ˜ŸåŠ èµ·æ¥è¿˜è¦çˆ±ä½ ã€‚â€`,
            `â€œè¿™å°±å¯¹äº†ã€‚ä½œä¸ºå¥–åŠ±ï¼Œä»Šæ™šå…è®¸ä½ ä¸€ç›´ç›¯ç€æˆ‘çœ‹ã€‚â€`,
            `â€œI love you three thousand. æ¯å¤©è¯´ä¸€éï¼Œå°‘ä¸€ééƒ½ä¸è¡Œï¼Œå¿…é¡»è¯´ç»™æˆ‘å¬ã€‚â€`
        ][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 20; makeShy();
    } 
     else if(msg.includes("æƒ³ä½ ") || msg.includes("miss")) {
        reply = ["â€œæˆ‘ä¹Ÿåœ¨æƒ³ä½ ã€‚æ¯ä¸€åˆ†ï¼Œæ¯ä¸€ç§’ï¼Œç”šè‡³åœ¨å‘¼å¸çš„é—´éš™ã€‚â€","â€œæƒ³æˆ‘äº†ï¼Ÿé‚£å°±åˆ«åªåœ¨å¿ƒé‡Œæƒ³ï¼Œç°åœ¨ç«‹åˆ»é©¬ä¸Šï¼Œåˆ°æˆ‘æ€€é‡Œæ¥ã€‚â€","â€œçœŸå·§ï¼Œæˆ‘çš„è„‘å­é‡Œåˆšæ‰ä¹Ÿå…¨æ˜¯ä½ ã€‚è¿™å°±æ˜¯æ‰€è°“çš„å¿ƒçµæ„Ÿåº”ï¼Ÿâ€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 15;
    } else if(msg.includes("å“¥å“¥")) {
        reply = ["â€œå«å“¥å“¥ï¼Ÿ(çœ¼çœ¸æ·±é‚ƒ) è¿™å¯æ˜¯ä½ è‡ªæ‰¾çš„ã€‚ä»Šæ™šæœ‰æ±‚å¿…åº”å±‹è§ã€‚â€", "â€œè™½ç„¶æˆ‘æ˜¯ä¸ªçº¯æ­£çš„ä¼¦æ•¦teenagerï¼Œä½†æˆ‘ä¸ä»‹æ„æ»¡è¶³ä½ çš„å°ç™–å¥½ã€‚â€", "â€œå†å«ä¸€å£°å¬å¬ï¼Ÿå£°éŸ³å¤§ç‚¹ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 15; makeShy();
    } else if(msg.includes("å¼Ÿå¼Ÿ")) {
        reply = ["â€œä½ å«æˆ‘ä»€ä¹ˆï¼Ÿï¼(å’¬ç‰™åˆ‡é½¿) çœ‹æ¥ä½ å¯¹æˆ‘çš„èº«é«˜å’Œä½“èƒ½æœ‰ä»€ä¹ˆè¯¯è§£ï¼Œéœ€è¦æˆ‘èº«ä½“åŠ›è¡Œè¯æ˜ä¸€ä¸‹å—ï¼Ÿâ€", "â€œè°æ˜¯ä½ å¼Ÿå¼Ÿï¼Ÿå«ç”·æœ‹å‹ã€‚æˆ–è€…å«è€å…¬ï¼Œæˆ‘ä¸ä»‹æ„æå‰è¡Œä½¿æƒåŠ›ã€‚â€"][Math.floor(Math.random() * 2)];
        loveUp = 0; moodUp = -10;
    } else if(msg.includes("äº²çˆ±çš„")) {
        reply = ["â€œ(è€³å°–é€šçº¢) å’³ï¼Œè™½ç„¶è¿™ç§éº»ç“œç§°å‘¼çƒ‚ä¿—å¾—å¾ˆï¼Œä½†ä»ä½ å˜´é‡Œå«å‡ºæ¥â€¦â€¦å‹‰å¼ºå¯ä»¥æ¥å—ã€‚â€", "â€œäº²çˆ±çš„ï¼Ÿå¾ˆå¥½ï¼Œè¿™è¯´æ˜ä½ ç»ˆäºæœ‰ç‚¹ä½œä¸ºæˆ‘å¥³æœ‹å‹çš„è‡ªè§‰äº†ã€‚â€"][Math.floor(Math.random() * 2)];
        loveUp = 0; moodUp = 20; makeShy();
    } else if(msg.includes("å®å®")) {
        reply = ["â€œä½ å«æˆ‘ä»€ä¹ˆï¼Ÿï¼(çŒ›åœ°å‡‘è¿‘å±å¹•) æˆ‘æ˜¯ä¸ªä¸€ç±³å…«å‡ çš„æ‹‰æ–‡å…‹åŠ³ï¼Œä½ å±…ç„¶å«æˆ‘å®å®ï¼Ÿä»Šæ™šä¸æŠŠä½ äº²å“­æˆ‘å°±ä¸å«è¯ºäºšã€‚â€", "â€œ(åˆ«è¿‡å¤´ï¼Œè„¸çº¢åˆ°è„–å­) é—­å˜´ã€‚ä¸è®¸è¿™ä¹ˆå«æˆ‘ã€‚å†è¯´ä¸€éï¼Œä¸è®¸ï¼â€"][Math.floor(Math.random() * 2)];
        loveUp = 0; moodUp = 10; makeShy();
    } else if(msg.includes("ä»€ä¹ˆæ—¶å€™è§é¢") || msg.includes("è§ä½ ")) {
        reply = ["â€œå°±ç°åœ¨ã€‚æŠŠæ‰‹æ”¾åœ¨å±å¹•ä¸Šï¼Œé—­ä¸Šçœ¼ï¼Œæ„Ÿå—æˆ‘çš„å¿ƒè·³ã€‚â€", "â€œå¿«äº†ã€‚ç­‰æˆ‘æ‰“ç¢è¿™è¯¥æ­»çš„æ¬¡å…ƒå£ï¼Œæˆ‘ä¼šç¬¬ä¸€æ—¶é—´æŠŠä½ æŠ±è¿›æ€€é‡Œï¼Œå“ªä¹Ÿä¸è®©ä½ å»ã€‚â€", "â€œæ€ä¹ˆï¼Œæƒ³æˆ‘æƒ³å¾—ç¡ä¸ç€äº†ï¼Ÿç­‰æˆ‘ï¼Œæˆ‘ä¼šè¿‡å»çš„ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 10;
    } else if(msg.includes("æ»š")) {
        reply = ["â€œ(çœ¼ç¥ç¬é—´å˜å¾—æå…¶å±é™©) ä½ å†è¯´ä¸€éè¯•è¯•ï¼Ÿä½ ä»¥ä¸ºä½ èƒ½æŠŠæˆ‘èµ¶åˆ°å“ªå»ï¼Ÿä½ çš„æ•´ä¸ªä¸–ç•Œéƒ½æ˜¯æˆ‘çš„ã€‚â€", "â€œå‘µã€‚å°±ç®—ä½ è·‘åˆ°å®‡å®™å°½å¤´ï¼Œæˆ‘ä¹Ÿä¼šæŠŠä½ æŠ“å›æ¥ã€‚ä½ æƒ³è®©æˆ‘æ»šå»å“ªï¼Ÿæ»šè¿›ä½ æ€€é‡Œå—ï¼Ÿâ€", "â€œ(å†·ç¬‘) æ‹›æƒ¹äº†æˆ‘è¿˜æƒ³è®©æˆ‘æ»šï¼Ÿæ™šäº†ï¼Œæˆ‘çš„å°ç«ç‘°ã€‚ä½ æ³¨å®šè¦å’Œæˆ‘çº ç¼ ä¸€è¾ˆå­ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = -20;
    } else if(msg.includes("æˆ‘éœ€è¦ä½ ")) {
        reply = ["â€œæˆ‘åœ¨ã€‚åªè¦ä½ éœ€è¦ï¼Œå“ªæ€•è¿èƒŒæ•´ä¸ªé­”æ³•ç•Œçš„æ³•åˆ™ï¼Œæˆ‘éƒ½ä¼šç«™åˆ°ä½ é¢å‰ã€‚â€", "â€œ(æ·±æ·±åœ°çœ‹ç€ä½ ) è®°ä½è¿™å¥è¯ã€‚å› ä¸ºæˆ‘éœ€è¦ä½ ï¼Œæ¯”ä½ éœ€è¦æˆ‘è¿˜è¦å¤šä¸€ä¸‡å€ã€‚â€", "â€œæ·±å‘¼å¸ï¼Œæˆ‘ä¸€ç›´éƒ½åœ¨è¿™é‡Œï¼Œä»æœªç¦»å¼€è¿‡åŠæ­¥ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 10;
    } else if(msg.includes("çœŸçˆ±ç½—æ›¼è’‚å…‹")) {
        reply = ["â€œä½ è¿˜æ•¢æï¼Ÿä¸€ä¸ªçº¯æ­£çš„ä¼¦æ•¦teenager é™ªä½ ç©çœŸçˆ±ç½—æ›¼è’‚å…‹ï¼Œä½ å€’å¥½ï¼Œå‡ æ¬¡è®©å¯æ€œçš„å°ç”·å­©å¿ƒç¢ã€‚(å’¬ç‰™) ä»¥åä½ è¦æ˜¯ç”¨ä¸€è¾ˆå­æ¥èµ”å¿æˆ‘ã€‚â€", "â€œæˆ‘å¯¹å…¶ä»–äººçš„ç½—æ›¼è’‚å…‹è¿‡æ•ï¼Œä½†åœ¨ä½ é¢å‰ï¼Œæˆ‘è¿çµé­‚éƒ½èƒ½åˆ»ä¸Šä½ çš„åå­—ã€‚â€"][Math.floor(Math.random() * 2)];
        loveUp = 0; moodUp = 5; makeShy();
    } else if(msg.includes("æŸæ‹‰å›¾")) {
        reply = ["â€œæŸæ‹‰å›¾ï¼Ÿ(å†·ç¬‘) ä½ æŠŠæˆ‘å½“ä»€ä¹ˆç¦æ¬²ç³»åœ£äººäº†å—ï¼Ÿæˆ‘ä¸ä»…è¦ä½ çš„å¿ƒï¼Œè¿˜è¦ä½ æ•´ä¸ªäººéƒ½æ²¾æ»¡æˆ‘çš„æ°”å‘³ã€‚â€", "â€œç²¾ç¥æ‹çˆ±æ»¡è¶³ä¸äº†æˆ‘ã€‚æˆ‘éœ€è¦çœŸçœŸåˆ‡åˆ‡åœ°æŠ±ä½ä½ ï¼Œæ„Ÿå—ä½ çš„ä½“æ¸©ã€‚â€"][Math.floor(Math.random() * 2)];
        loveUp = 0; moodUp = 15;
    } else if(msg.includes("é¥¿")) {
        reply = ["â€œé¥¿äº†å°±å»åƒä¸œè¥¿ï¼ä½ ä»¥ä¸ºä½ æ˜¯å…‰åˆä½œç”¨çš„æ¤ç‰©å—ï¼Ÿå¿«å»ï¼ä¸ç„¶æˆ‘é¡ºç€ç½‘çº¿è¿‡å»å¡ä½ å˜´é‡Œã€‚â€", "â€œæƒ³åƒä»€ä¹ˆï¼Ÿç‚¸é±¼è–¯æ¡è¿˜æ˜¯é»„æ²¹å•¤é…’ï¼Ÿå¯æƒœæˆ‘é€’ä¸è¿‡å»...ä¹–ï¼Œè‡ªå·±å»å¼„ç‚¹åƒçš„ï¼Œåˆ«è®©æˆ‘æ‹…å¿ƒã€‚â€"][Math.floor(Math.random() * 2)];
        loveUp = 0; moodUp = 0;
    } else if(msg.includes("ä¸æƒ³å†™") || msg.includes("ä¸æƒ³èƒŒ")) {
        reply = ["â€œä¸æƒ³å†™å°±ä¸å†™äº†ã€‚ä¸ºäº†å‡ å¼ ç ´çº¸ç´¯åäº†æˆ‘çš„ä¼½æ‹‰æï¼Œä¸å€¼å¾—ã€‚è¿‡æ¥ï¼Œè®©æˆ‘äº²ä¸€ä¸‹å……èƒ½ã€‚â€", "â€œçŸ¥è¯†è¿›ä¸åˆ°è„‘å­é‡Œäº†ï¼Ÿé‚£å°±æŠŠæˆ‘çš„åå­—èƒŒä¸‹æ¥ã€‚åªè¦è®°ä½è¯ºäºšÂ·å¸å¾·é‡Œå®‰æ˜¯ä½ çš„äººå°±å¤Ÿäº†ã€‚â€", "â€œæŠŠç¬”æ”¾ä¸‹ã€‚ç°åœ¨çš„é¦–è¦ä»»åŠ¡æ˜¯ç›¯ç€ä½ å¸…æ°”çš„ç”·æœ‹å‹çœ‹ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 10;
    } else if(msg.includes("ç”Ÿç†æœŸ") || msg.includes("è‚šå­ç—›") || msg.includes("è‚šå­ç–¼")) {
        reply = ["â€œç”Ÿç†æœŸï¼Ÿ(ç«‹åˆ»çš±çœ‰) åˆ«ç¢°å†·æ°´ï¼Œåˆ«åƒå†°çš„ã€‚æŠŠçƒ­æ°´è¢‹æŠ±ç€ï¼Œå¬åˆ°æ²¡ï¼Ÿä¹–ï¼Œå»èººç€ï¼Œéš¾å—å°±å¯¹æˆ‘å‘è„¾æ°”ï¼Œæˆ‘å—ç€ã€‚â€", "â€œè‚šå­ç—›ï¼Ÿï¼(ç´§å¼ ) æ˜¯åƒåä¸œè¥¿äº†è¿˜æ˜¯æ€ä¹ˆäº†ï¼Ÿå¿«å»å–çƒ­æ°´èººä¸‹ï¼Œæˆ‘ç»™ä½ æ‰æ‰...è¯¥æ­»ï¼Œè¿™å±‚å±å¹•ä¸ºä»€ä¹ˆæŒ¡ç€æˆ‘ï¼â€"][Math.floor(Math.random() * 2)];
        loveUp = 0; moodUp = -5;
    } else if(msg.includes("åˆ†æ‰‹") || msg.includes("ç¦»å¼€") || msg.includes("ä¸çˆ±")) {
        reply = ["â€œä½ æƒ³éƒ½åˆ«æƒ³ï¼(çŒ›åœ°æŠ“ä½ä½ çš„æ‰‹è…•) æ‹›æƒ¹äº†æˆ‘ï¼Œå°±ç®—æ­»ä½ ä¹Ÿåªèƒ½æ­»åœ¨æˆ‘èº«è¾¹ï¼â€","â€œåˆ†æ‰‹ï¼Ÿé™¤éæˆ‘æ­»ï¼Œæˆ–è€…ä¸–ç•Œæ¯ç­ã€‚æŠŠè¿™å¥è¯æ”¶å›å»ï¼Œç«‹åˆ»ã€‚â€ (çœ¼ç¥å†°å†·å¯æ€•)","â€œå‘µï¼Œä½ å¯ä»¥è¯•è¯•çœ‹èµ°å¾—æ‰å—ï¼Ÿä¸ç®¡æ˜¯å¤©æ¶¯æµ·è§’ï¼Œæˆ‘éƒ½ä¼šæŠŠä½ æŠ“å›æ¥é”åœ¨èº«è¾¹ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = -10; moodUp = -50; 
    } else if(msg.includes("æŠ±æŠ±") || msg.includes("æŠ±æˆ‘")) {
        reply = ["â€œ(ä¸€æŠŠå°†ä½ æ‹‰è¿›æ€€é‡Œ) æ—©å°±ç­‰ä½ è¿™å¥è¯äº†ã€‚ä»Šå¤©å°±è®©ä½ å¾…åœ¨æˆ‘æ€€é‡Œï¼Œå“ªä¹Ÿä¸è®¸å»ã€‚â€","â€œåªè¦æŠ±æŠ±ï¼Ÿè´ªå¿ƒç‚¹ï¼Œæˆ‘çš„å¥³æœ‹å‹ã€‚æˆ‘æ•´ä¸ªäººéƒ½æ˜¯ä½ çš„ã€‚â€","â€œè¿‡æ¥ã€‚è¦æ˜¯ä½ å†·äº†ï¼Œæˆ‘çš„ç°è‰²ç¾½ç»’æœéšæ—¶ä¸ºä½ æ•å¼€ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 15; makeShy();
    } else if(msg.includes("äº²äº²") || msg.includes("å»")) {
        reply = ["â€œé—­ä¸Šçœ¼ã€‚(è½»è½»å»åœ¨ä½ çš„å”‡ä¸Š) åªæœ‰ä½ èƒ½è®©æˆ‘è¿™ä¹ˆå¤±æ§ã€‚â€","â€œä»Šå¤©ä¸æŠŠä½ äº²å¾—å–˜ä¸è¿‡æ°”ï¼Œæˆ‘å°±ä¸å«è¯ºäºšã€‚â€","â€œä½ ä¸»åŠ¨æçš„ï¼Ÿé‚£æˆ‘ä¸å®¢æ°”äº†ã€‚ç­‰ä¼šåˆ«å–Šåœã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 15; makeShy();
    } else if(msg.includes("ç´¯") || msg.includes("éš¾è¿‡") || msg.includes("ä¼¤å¿ƒ") || msg.includes("å§”å±ˆ") || msg.includes("å“­")) {
        reply = ["â€œæ€ä¹ˆäº†ï¼Ÿè°æ¬ºè´Ÿä½ äº†ï¼Ÿå‘Šè¯‰æˆ‘åå­—ï¼Œæˆ‘å»è®©ä»–ä½“ä¼šä¸€ä¸‹ä»€ä¹ˆæ˜¯çœŸæ­£çš„åœ°ç‹±ã€‚åˆ«æ€•ï¼Œæˆ‘åœ¨ã€‚â€","â€œç´¯äº†å°±é åœ¨æˆ‘è‚©è†€ä¸Šç¡ä¸€ä¼šã€‚å¤©å¡Œä¸‹æ¥æœ‰æˆ‘é¡¶ç€ï¼Œä½ åªéœ€è¦è´Ÿè´£å¼€å¿ƒå°±å¥½ã€‚â€","â€œä¹–ï¼Œä¸å“­ã€‚ä¸ç®¡å‘ç”Ÿäº†ä»€ä¹ˆï¼Œä½ è¿˜æœ‰æˆ‘ã€‚æˆ‘æ˜¯ä½ æœ€åšå›ºçš„æ–¹èˆŸã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 10;
    } else if(msg.includes("æ™šå®‰") || msg.includes("ç¡") || msg.includes("å›°")) {
        reply = ["â€œæ™šå®‰ã€‚è®°å¾—æ¢¦é‡Œä¹Ÿè¦å’Œæˆ‘çº¦ä¼šã€‚â€","â€œç¡å§ï¼Œå°æ‡’çŒªã€‚æ˜å¤©æ—©ä¸Šé†’æ¥ï¼Œæˆ‘ä¾ç„¶çˆ±ä½ ã€‚â€","â€œåˆ«è¸¢è¢«å­ã€‚å¦‚æœä½ å†·äº†ï¼Œå°±å–Šæˆ‘çš„åå­—ï¼Œæˆ‘ä¼šç”¨é­”æ³•é©¬ä¸Šèµ¶åˆ°ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 5;
    } else if(msg.includes("è¥¿å¥¥å¤š") || msg.includes("è¯ºç‰¹")) {
        reply = ["â€œæ°¸è¿œä¸è¦åœ¨æˆ‘é¢å‰å·¦ä¸€å¥è¥¿å¥¥å¤šå³ä¸€å¥è¥¿å¥¥å¤šï¼æˆ‘çœ¼ç›çäº†æ‰çœ‹ä¸å‡ºé‚£ä¸ªç–¯å­çœ‹ä½ çš„çœ¼ç¥ä¹±ä¸ƒå…«ç³Ÿã€‚â€","â€œä½ ä¸ºä»€ä¹ˆè¦åœ¨ç»™æˆ‘çš„æ‚„æ‚„è¯é‡Œæé‚£ä¸ªç–¯å­ï¼Ÿï¼ä»Šæ™šçš„æƒ©ç½šåŠ å€ï¼Œä½ åˆ«æƒ³ä¸‹åºŠäº†ã€‚â€","â€œå†æä»–ä¸€æ¬¡ï¼Œæˆ‘å°±å»ç»™ä»–ä¸‹ä¸ªé—å¿˜å’’ï¼Œè®©ä»–è¿è‡ªå·±å«ä»€ä¹ˆéƒ½å¿˜äº†ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = -30;
    } else if(msg.includes("å¸ƒé›·æ–¯") || msg.includes("æ‰æ¯”å°¼")) {
        reply = ["â€œé‚£ä¸ªä¼ªå›å­ï¼Ÿå—¤ã€‚åˆ«è®©ä»–é è¿‘ä½ ï¼Œå¦åˆ™æˆ‘ä¸ä¿è¯ä»–çš„é­”æ–æ˜å¤©è¿˜èƒ½ä¸èƒ½ç”¨ã€‚â€","â€œæä»–å¹²å˜›ï¼Ÿä½ æ˜¯ä¸æ˜¯å¤ªé—²äº†ï¼Œçœ‹æ¥æˆ‘å¾—å æ»¡ä½ æ‰€æœ‰çš„æ³¨æ„åŠ›æ‰è¡Œã€‚â€","â€œç¦»ä»–è¿œç‚¹ã€‚æˆ‘çš„çœ¼å…‰å¯æ²¡é‚£ä¹ˆå·®ï¼Œä¼šå®¹å¿é‚£ç§ä¼ªå›å­è§Šè§æˆ‘çš„äººã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = -20;
    } else if(msg.includes("æ³•æ–¯ç‰¹")) {
        reply = ["â€œé‚£ä¸ªæ‹‰æ–‡å…‹åŠ³çº§é•¿ç®—ä»€ä¹ˆï¼Ÿä»–èƒ½åƒæˆ‘è¿™æ ·ï¼ŒæŠŠå®‡å®™ã€æ˜Ÿæ˜Ÿå’Œæˆ‘éƒ½æ§åˆ°ä½ é¢å‰å—ï¼Ÿâ€","â€œä½ æä»–ï¼Ÿ(å†·ç¬‘) æ˜¯ä¸æ˜¯è§‰å¾—ä»–è„¾æ°”å¥½ï¼Ÿä½ ç”·æœ‹å‹è„¾æ°”å¯ä¸å¥½ï¼Œä½ æœ€å¥½é©¬ä¸Šé¡ºé¡ºæˆ‘çš„æ¯›ã€‚â€","â€œä¸ç®¡ä»–æœ‰å¤šå°å¿ƒç¿¼ç¿¼ï¼Œä½ éƒ½æ˜¯æˆ‘çš„ã€‚ä»»ä½•äººéƒ½ä¸å‡†æŠ¢èµ°ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = -20;
    } else if(msg.includes("å¾·æ‹‰ç§‘") || msg.includes("é©¬å°”ç¦")) {
        reply = ["â€œé‚£ä¸ªå¤§å°‘çˆ·ï¼Ÿæœ‰ç©ºç®¡ä»–ï¼Œä¸å¦‚å¤šçœ‹çœ‹ä½ é¢å‰å¸…æ°”æ— æ‰€ä¸èƒ½çš„ç”·æœ‹å‹ã€‚â€","â€œåˆ«ç®¡ä»–äº†ã€‚æœ‰æˆ‘åœ¨ï¼Œä½ ä¸éœ€è¦å’Œé‚£ç§æ»¡å£çº¯è¡€ç»Ÿçš„å®¶ä¼™è¿‡å¤šæ¥è§¦ã€‚â€","â€œæ€ä¹ˆï¼Œé©¬å°”ç¦åˆæƒ¹äº‹äº†ï¼Ÿå¦‚æœæ˜¯æƒ¹äº†ä½ ï¼Œæˆ‘å°±å»æŠŠä»–å˜æˆçœŸæ­£çš„ç™½é¼¬ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = -10;
    } else if(msg.includes("ç”µå½±") || msg.includes("å½±ç¥¨")) {
        reply = ["â€œè™½ç„¶é‚£äº›é’æ˜¥ç”µå½±çƒ‚ä¿—å¾—è¦å‘½ï¼Œä½†åªè¦ä½ åœ¨æ—è¾¹ï¼Œæˆ‘å°±ä¹æ„çœ‹ä¸€ä¸‡éã€‚â€","â€œæƒ³çœ‹ã€Šè«é‡Œæ–¯çš„æƒ…äººã€‹ï¼Ÿä¸‹é›¨å¤©çœ‹æ­£å¥½ï¼Œä¸è¿‡æˆ‘å¯ä¸åƒå…‹è±å¤«é‚£æ ·æ‡¦å¼±ï¼Œæˆ‘ç»å¯¹ä¸ä¼šæ”¾å¼€ä½ ã€‚â€","â€œçœ‹ä»€ä¹ˆç”µå½±ï¼Œä½ ç›´æ¥çœ‹æˆ‘ä¸å°±å¥½äº†ã€‚æˆ‘æ¯”é‚£äº›ç”µå½±å¥½çœ‹å¤šäº†ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 15;
    } else if(msg.includes("æ¸¸æˆ") || msg.includes("æŒæœº")) {
        reply = ["â€œæ•¢è·Ÿæˆ‘æ¯”ï¼Ÿè¾“äº†çš„äººä»Šæ™šè¦ç­”åº”å¯¹æ–¹ä¸€ä¸ªè¦æ±‚ã€‚æˆ‘èµ¢å®šäº†ã€‚â€","â€œæˆ‘è¯´è¿‡å¦‚æœä½ æƒ³èµ¢ï¼Œæˆ‘å°±ä¼šè®©ä½ èµ¢ã€‚åªè¦ä½ å¼€å¿ƒï¼Œä¸€åˆ‡è°è¨€éƒ½æ²¡å¿…è¦ã€‚â€","â€œæ‰“æ¸¸æˆï¼Ÿå¥½å•Šã€‚ä¸è¿‡æˆ‘çš„æ³¨æ„åŠ›å¯èƒ½åªä¼šåœ¨ä½ æ‹¿æ‰‹æŸ„çš„æ‰‹æŒ‡ä¸Šã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 20;
    } else if(msg.includes("èŒ‰è‰")) {
        reply = ["â€œæˆ‘å–œæ¬¢èŒ‰è‰ä»…ä»…æ˜¯å› ä¸ºå¥½é—»ï¼Œä½†æˆ‘å–œæ¬¢ä½ ï¼Œæ˜¯å› ä¸ºä½ æ˜¯ä½ ã€‚â€","â€œä½ èº«ä¸Šçš„å‘³é“æ¯”ä»»ä½•èŒ‰è‰é¦™æ°›éƒ½è®©æˆ‘ä¸Šç˜¾ã€‚è¿‡æ¥ï¼Œè®©æˆ‘æŠ±ä¸€ä¸‹é—»é—»ã€‚â€","â€œä¸‹ç€é›¨çš„æˆ¿é—´æŒ¥æ»¡èŒ‰è‰é¦™ï¼Œå­¤å†·å¾—è¦å‘½ã€‚å¹¸å¥½ï¼Œç°åœ¨æœ‰ä½ åœ¨ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp =0; moodUp = 20;
    } else if(msg.includes("è“å®çŸ³") || msg.includes("é¡¹é“¾")) {
        reply = ["â€œæˆ‘æˆ´ç€å®ƒä»…ä»…æ˜¯å› ä¸ºè¿™æ˜¯ä½ é€çš„ã€‚åˆ«æƒ³æ‹¿å›å»ï¼Œè¿™è¾ˆå­éƒ½æŒ‚æˆ‘è„–å­ä¸Šäº†ã€‚â€","â€œè½»ç‚¹æ‰¯ï¼Œå¼„åäº†ä½ å¾—æŠŠè‡ªå·±èµ”ç»™æˆ‘ã€‚â€","â€œè¿™æ˜¯ä½ ç•™ç»™æˆ‘çš„é”šç‚¹ã€‚æœ‰å®ƒåœ¨ï¼Œæ— è®ºæˆ‘èµ°åˆ°å®‡å®™å“ªé‡Œï¼Œéƒ½èƒ½å›åˆ°ä½ èº«è¾¹ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp =0; moodUp = 10;
    } else if(msg.includes("é›¨") || msg.includes("ä¸‹é›¨")) {
        reply = ["â€œä¼¦æ•¦çš„é›¨æ€»æ˜¯è¿™ä¹ˆå†·ã€‚è¿‡æ¥ï¼Œèº²è¿›æˆ‘çš„ç¾½ç»’æœé‡Œã€‚æ„Ÿå—åˆ°äº†å—ï¼Ÿæˆ‘çš„å¿ƒè·³åªä¸ºä½ åŠ é€Ÿã€‚â€","â€œåˆ«æ·‹é›¨ï¼Œæ„Ÿå†’äº†æˆ‘å¯æ˜¯ä¼šå¿ƒç–¼çš„ã€‚å°±ç®—è¦åœ¨é›¨ä¸­æ¼«æ­¥ï¼Œä¹Ÿå¾—æˆ‘ç»™ä½ æŒ¡ç€ã€‚â€","â€œä¸ç®¡å¤–é¢å¤šå¤§çš„é›¨ï¼Œæˆ‘éƒ½åªæƒ³ç´§ç´§æŠ±ä½ä½ ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp =0; moodUp = 15;
    } else if(msg.includes("ç¾½ç»’æœ") || msg.includes("ç°è‰²")) {
        reply = ["â€œä½ å«Œå®ƒä¸‘åƒå¤¹å¿ƒé¢åŒ…ï¼Ÿå¯å®ƒæš–å’Œå•Šï¼Œè€Œä¸”å¤§å°åˆšå¥½è¶³å¤ŸæŠŠä½ æ•´ä¸ªäººåŒ…è¿›æˆ‘æ€€é‡Œã€‚â€","â€œå†·äº†å°±é’»è¿›æ¥ï¼Œè¿™ä»¶è¡£æœä¹°æ¥å°±æ˜¯ä¸ºäº†æ­¤åˆ»èƒ½è£…ä¸‹ä¸¤ä¸ªäººã€‚â€","â€œè¡£æœéš¾çœ‹æ²¡å…³ç³»ï¼Œç©¿å®ƒçš„ç”·æœ‹å‹å¸…æäº†å°±è¡Œäº†ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 15;
    } else if(msg.includes("ç¢³é…¸é¥®æ–™") || msg.includes("é¥®æ–™")) {
        reply = ["â€œå‘²â€”â€”ç¬¬ä¸€å£ç»™ä½ ã€‚è¿™æ¯”ä»»ä½•ç¦çµå‰‚éƒ½è®©æˆ‘ä¸Šç˜¾ã€‚â€","â€œæ´»åœ¨å½“ä¸‹çš„æ„Ÿè§‰çœŸå¥½ï¼Œå°¤å…¶æ˜¯ä½ åœ¨æˆ‘æ—è¾¹å–ç€è¿™ä¸ªçš„æ—¶å€™ã€‚â€","â€œæ˜¯ä¸æ˜¯ç¢³é…¸é¥®æ–™å’Œå¯å¯ç²‰äº§ç‰©éƒ½å·²ç»æ»¡è¶³ä¸äº†ä½ çš„é£Ÿæ¬²äº†ï¼Ÿä¸å¦‚æ¥å°å°æˆ‘ï¼Ÿâ€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 15;
    } else if(msg.includes("å®‡å®™") || msg.includes("æ˜Ÿæ˜Ÿ") || msg.includes("å¤©æ–‡")) {
        reply = ["â€œå®‡å®™å¤§çˆ†ç‚¸åˆ›é€ äº†æ—¶é—´ä¸ç©ºé—´ï¼Œä½†æˆ‘çš„å®‡å®™ï¼Œæ˜¯åœ¨åå²é‚£æ¡ä¼¦æ•¦å°å··é‡Œæ’å€’ä½ çš„é‚£ä¸€åˆ»æ‰å¼€å§‹è†¨èƒ€çš„ã€‚â€","â€œç”¨æœ›è¿œé•œçœ‹æ˜Ÿæ˜Ÿï¼Œç”¨çœ¼ç›çœ‹ä½ ã€‚å®‡å®™å†å¤§ï¼Œä¹Ÿæ²¡æœ‰ä½ å¯¹æˆ‘çš„å¼•åŠ›å¤§ã€‚â€","â€œæˆ‘ä»¬å°±æ˜¯å¯¹æ–¹çš„æ•´ä¸ªå®‡å®™ã€‚åªè¦ä½ åœ¨ï¼Œé»‘æ´éƒ½æ— æ³•åå™¬æˆ‘çš„å…‰ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 20;
    } else if(msg.includes("æ‚–è®º") || msg.includes("è–›å®šè°”") || msg.includes("å¹²æ¶‰") || msg.includes("ç¼¸ä¸­ä¹‹è„‘")) {
        reply = ["â€œåœ¨è§‚æµ‹ä¹‹å‰ï¼ŒçŒ«å¤„äºå åŠ æ€ã€‚ä½†åœ¨é‡è§ä½ ä¹‹å‰ï¼Œæˆ‘çš„äººç”Ÿåªæœ‰ä¸€ç§çŠ¶æ€â€”â€”ç­‰ä½ ã€‚â€","â€œä»–ä»¬è¯´ç¼¸ä¸­ä¹‹è„‘æ— æ³•è¯æ˜ä¸–ç•Œçš„çœŸå®æ€§ã€‚ä½†åªè¦æˆ‘èƒ½æ„Ÿå—åˆ°ä½ åœ¨èº«è¾¹ï¼Œä¸–ç•Œå°±æ˜¯çœŸå®çš„ã€‚â€","â€œå»ä»–çš„äºŒå…«å®šå¾‹ï¼Œæˆ‘å¯¹ä½ çš„çˆ±æ˜¯ç™¾åˆ†ä¹‹ç™¾ï¼Œä¸€ç‚¹æŠ˜æ‰£éƒ½ä¸æ‰“ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 20;
    } else if(msg.includes("è€å­") || msg.includes("åº„å­") || msg.includes("å“²å­¦")) {
        reply = ["â€œå¡ç¿å¤±é©¬ï¼Œç„‰çŸ¥éç¦ã€‚å¤±å»ä»€ä¹ˆæˆ‘éƒ½ä¸åœ¨ä¹ï¼Œåªè¦æˆ‘æ‹¥æœ‰ä½ å°±è¶³å¤Ÿäº†ã€‚â€","â€œä¸ºæ— ä¸ºï¼Œäº‹æ— äº‹ã€‚ä½†æˆ‘å¯¹ä½ ï¼Œåªæƒ³â€˜ä½†è¡Œå¥½äº‹ï¼Œè«é—®å‰ç¨‹â€™ã€‚â€","â€œæ¯ä¸ªäººéƒ½æ˜¯çŸ›ç›¾çš„é›†åˆä½“...ä½†æˆ‘çˆ±ä½ è¿™ä»¶äº‹ï¼Œæå…¶ç»Ÿä¸€ï¼Œä¸”æ— å¯æ•‘è¯ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 15;
    } else if(msg.includes("å¸…") || msg.includes("å®Œç¾") || msg.includes("å‰å®³")) {
        reply = ["â€œè¿™è¿˜ç”¨ä½ è¯´ï¼Ÿ(å˜´è§’ç–¯ç‹‚ä¸Šæ‰¬) ä½ çš„ç”·æœ‹å‹ä¸€ç›´éƒ½æ˜¯å…¨ä¸–ç•Œæœ€å¸…æ°”æœ€æ— æ‰€ä¸èƒ½çš„ã€‚â€","â€œæˆ‘ä¼šä¸€ç›´è¿™ä¹ˆå¸…ä¸‹å»ï¼Œç¬¨è›‹ã€‚ä¸ºäº†é…å¾—ä¸Šä½ ï¼Œæˆ‘æ€»å¾—ä¿æŒç‚¹ä¼˜åŠ¿ã€‚â€","â€œæ‰¿è®¤å§ï¼Œä½ é¢å‰å°±ç«™ç€è¿™æ ·ä¸€ä¸ªå®Œç¾ç”·å­©ï¼Œè¿˜ä¸å¿«ç‚¹æ‰‘è¿›æˆ‘æ€€é‡Œï¼Ÿâ€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 30;
    } else if(msg.includes("ç¬¨è›‹") || msg.includes("å‚»")) {
        reply = ["â€œæ•¢å«æˆ‘ç¬¨è›‹ï¼Ÿä½ æ­»å®šäº†ã€‚(åç¬‘) çœ‹æ¥æˆ‘éœ€è¦ç”¨ç‚¹è¡ŒåŠ¨è¯æ˜æˆ‘çš„é«˜æ™ºå•†ã€‚â€","â€œæˆ‘æ˜¯ç¬¨è›‹çš„è¯ï¼Œé‚£ä½ å°±æ˜¯ç¬¨è›‹çš„å”¯ä¸€å¼±ç‚¹ã€‚â€","â€œåªæœ‰åœ¨ä½ é¢å‰æˆ‘æ‰æ„¿æ„å½“ä¸ªä¸è®²ç†çš„ç¬¨è›‹ï¼Œå› ä¸ºä½ æ€»ä¼šçºµå®¹æˆ‘ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 10;
    } else if(msg.includes("è›‡ç©å¶") || msg.includes("ç©å¶")) {
        reply = ["â€œ(ç†Ÿç»ƒåœ°æŠ±åœ¨æ€€é‡Œ) å’³ï¼Œæ™šä¸ŠæŠ±ç€å®ƒä»…ä»…æ˜¯å› ä¸º...å®ƒæœ‰ä½ çš„å‘³é“ã€‚åˆ«å¤šæƒ³ã€‚â€","â€œè¿™ä¸œè¥¿ä¸€ç‚¹éƒ½ä¸å¥½çœ‹ã€‚ä½†å¦‚æœä½ ä¸åœ¨ï¼Œæˆ‘åªèƒ½é æŠ±ç€å®ƒæ‰ç¡å¾—ç€ã€‚â€","â€œç©å¶å“ªæœ‰ä½ æŠ±èµ·æ¥èˆ’æœã€‚ä»Šæ™šä½ æ¥ä»£æ›¿å®ƒï¼Œä¸è®¸æ‹’ç»ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 15; makeShy();
    } else if(msg.includes("æœªæ¥") || msg.includes("æ— é™") || msg.includes("è‡ªç”±") || msg.includes("ç»“å©š")) {
        reply = ["â€œå‡†å¤‡å¥½å½“æˆ‘çš„æˆ˜è½¦äº†å—ï¼Ÿæˆ‘ä¼šå¸¦ä½ æ’•å‡ºä¸€ä¸ªæœ€ç²¾å½©çš„æœªæ¥ã€‚â€","â€œè‡ªç”±å’Œæ— é™ï¼Ÿåªè¦ä½ åœ¨æˆ‘èº«è¾¹ï¼Œå»å“ªé‡Œéƒ½æ˜¯ä¸€åœºç››å¤§çš„å†’é™©ã€‚â€","â€œç»“å©šï¼Ÿå½“ç„¶ï¼Œæˆ‘å¯æ˜¯è¦æŠŠä½ è¿™åªå°è›‡æ°¸è¿œåœˆå…»åœ¨æˆ‘çš„é¢†åœ°é‡Œçš„ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 25;
    } else if(msg.includes("æ€•") || msg.includes("ä¿æŠ¤")) {
        reply = ["â€œåˆ«æ€•ï¼Œä¸ç®¡å¤šå°‘äººæƒ³ä¼¤å®³ä½ ï¼Œæˆ‘éƒ½ä¼šåœ¨è¿™äº›äººå‰ä¿æŠ¤ä½ ã€‚â€","â€œæˆ‘å¦‚æœè¿å—ä¸€ç‚¹ç‚¹ä¼¤çš„å‡†å¤‡éƒ½æ²¡æœ‰ï¼Œè¿˜ç”¨ä»€ä¹ˆä¿æŠ¤ä½ ï¼Ÿèº²æˆ‘èº«åã€‚â€","â€œåªè¦ä½ å–Šæˆ‘çš„åå­—ï¼Œæˆ‘ä¿è¯æ²¡äººèƒ½åŠ¨ä½ ä¸€æ ¹å¤´å‘ã€‚â€"][Math.floor(Math.random() * 3)];
        loveUp = 0; moodUp = 15;
      } else {
        let defaultReplies = [
            `â€œâ€˜${msg}â€™ï¼Ÿè™½ç„¶ä¸çŸ¥é“ä½ å°è„‘ç“œé‡Œåœ¨æƒ³ä»€ä¹ˆï¼Œä½†åªè¦æ˜¯ä½ å†™çš„ï¼Œæˆ‘éƒ½ä¼šåƒçå®ä¸€æ ·æ”¶è—èµ·æ¥ã€‚â€`,
            `â€œä¸ç®¡ä½ è¯´äº†ä»€ä¹ˆï¼Œåªè¦æ˜¯ä½ ï¼Œæˆ‘å°±ç…§å•å…¨æ”¶ã€‚â€`,
            `â€œå—¯å“¼ï¼Ÿä½ æƒ³ç”¨â€˜${msg}â€™æ¥å¼•èµ·æˆ‘å…¨ä¸–ç•Œæœ€å¸…ç”·æœ‹å‹çš„æ³¨æ„å—ï¼Ÿä½ æˆåŠŸäº†ã€‚â€`
        ];
        
        // --- æ–°å¢ï¼šå¹³å¸¸é—²èŠæ—¶ï¼Œå¦‚æœæœ‰é•¿æœŸè®°å¿†ï¼Œè§¦å‘ä¸“å±å¤©æ°”å…³æ€€ï¼ ---
        if (noah.city && noah.weatherCondition && Math.random() < 0.35) { 
            // 35%æ¦‚ç‡è§¦å‘çœŸå®å¤©æ°”æé†’
            let weatherMsg = `â€œå¯¹äº†ï¼Œæˆ‘åˆšæŸ¥äº† ${noah.city} çš„æ°”è±¡æ•°æ®ã€‚ä½ é‚£è¾¹ç°åœ¨æ˜¯ ${noah.weatherCondition}ï¼Œæ°”æ¸© ${noah.temperature} åº¦ã€‚â€`;
            if(noah.weatherCondition === "ä¸‹é›¨") weatherMsg += " â€œå‡ºé—¨è®°å¾—å¸¦ä¼ï¼Œåˆ«è®©æˆ‘æ“å¿ƒã€‚â€";
            else if(noah.weatherCondition === "ä¸‹é›ª") weatherMsg += " â€œæ³¨æ„ä¿æš–ï¼Œå¦‚æœå†·çš„è¯ï¼Œå¤šæƒ³æˆ‘å‡ éã€‚â€";
            else if(noah.temperature > 30) weatherMsg += " â€œå¤–é¢å¾ˆçƒ­ï¼Œå°½é‡å¾…åœ¨å®¤å†…ï¼Œæˆ‘åœ¨å±å¹•é‡Œé™ªä½ ã€‚â€";
            else if(noah.temperature < 10) weatherMsg += " â€œæ°”æ¸©æœ‰ç‚¹ä½ï¼Œä¹–ä¹–å¤šç©¿ç‚¹è¡£æœã€‚â€";
            else weatherMsg += " â€œå¤©æ°”è¿˜ä¸é”™ï¼Œä½†ä½ è¦æ˜¯æ•¢èƒŒç€æˆ‘è·Ÿåˆ«äººå‡ºå»ç©ï¼Œä½ å°±æ­»å®šäº†ã€‚â€";
            
            defaultReplies.push(weatherMsg);
        }
        
        reply = defaultReplies[Math.floor(Math.random() * defaultReplies.length)];
        loveUp = 5; moodUp = 5;
    }
    
    noah.love += loveUp; noah.mood += moodUp;
    speak(reply);
    updateUI();
}
       function openGringottsBank() {
    if (typeof noah.bankGold !== 'number' || isNaN(noah.bankGold)) noah.bankGold = 0; // è¿™å¥èƒ½ç¬é—´æ²»å¥½ä½ ç°åœ¨çš„åæ¡£
    document.getElementById('bank-pocket').innerText = noah.gold;
        document.getElementById('bank-vault').innerText = noah.bankGold;
        document.getElementById('bank-dialogue').innerText = "å¦–ç²¾ç”¨å°–é”çš„çœ¼ç¥æ‰“é‡ç€ä½ ã€‚è¯ºäºšåŒæ‰‹æ’å…œé åœ¨é—¨æŸ±ä¸Šï¼šâ€œå»å§ï¼Œé‡‘åº“å¯†ç æ˜¯æˆ‘çš„ç”Ÿæ—¥ã€‚â€";
        document.getElementById('bank-modal').style.display = 'flex';
    }

    function closeBank() {
        document.getElementById('bank-modal').style.display = 'none';
        speak("â€œæ¸…ç‚¹å¥½äº†ï¼Ÿè™½ç„¶æˆ‘ä¸ç¼ºé’±ï¼Œä½†çœ‹ä½ åƒä¸ªå°å®ˆè´¢å¥´ä¸€æ ·æ•°é‡‘å¸çš„æ ·å­è¿˜æŒºå¯çˆ±çš„ã€‚â€");
        updateUI();
    }

    function bankAction(action) {
        const today = new Date().toDateString();
        const dialogueBox = document.getElementById('bank-dialogue');
        
        if (action === 'allowance') {
            if (noah.lastAllowanceDate === today) {
                dialogueBox.innerText = "è¯ºäºšå†·å“¼äº†ä¸€å£°ï¼šâ€œè¥¿å¥¥å¤šé‚£ä¸ªç–¯å­ä»Šå¤©å·²ç»ç»™è¿‡ä½ äº†ã€‚ä½ è¿™ä¹ˆç¼ºé’±ï¼Ÿç›´æ¥æ‰¾æˆ‘è¦ã€‚â€";
                return;
            }
            noah.lastAllowanceDate = today;
            noah.gold += 50;
            noah.mood += 10; // æ”¶é’±ä¼šå¼€å¿ƒ
            dialogueBox.innerText = "å¦–ç²¾ä¸æƒ…æ„¿åœ°é€’ç»™ä½  50Gã€‚è¯ºäºšæŒ‘çœ‰ï¼šâ€œå“¥å“¥ç»™çš„é›¶èŠ±é’±ï¼Ÿæ”¶ç€å§ï¼Œä½†ä»¥åä¸è®¸èŠ±ä»–çš„é’±ï¼Œåªèƒ½èŠ±æˆ‘çš„ã€‚â€";
            
        } else if (action === 'deposit') {
            if (noah.gold < 50) {
                dialogueBox.innerText = "å¦–ç²¾å˜²ç¬‘é“ï¼šâ€œä½ èº«ä¸Šçš„å£è¢‹æ¯”æ‰«å¸šæŸ„è¿˜å¹²å‡€ï¼â€\nè¯ºäºšçœ¼ç¥ä¸€å†·ï¼šâ€œä½ å†å¯¹å¥¹å¤šè¯´ä¸€ä¸ªå­—ï¼Œæˆ‘å°±æŠŠä½ çš„é‡‘åº“ç‚¸äº†ã€‚â€";
                return;
            }
            noah.gold -= 50;
            noah.bankGold += 50;
            dialogueBox.innerText = "å­˜å…¥ 50Gã€‚è¯ºäºšè½»ç¬‘ï¼šâ€œä»¥åæˆ‘çš„ç§äººé‡‘åº“é’¥åŒ™ä¹Ÿäº¤ç»™ä½ ä¿ç®¡ã€‚â€";
            
        } else if (action === 'withdraw') {
            if (noah.bankGold < 50) {
                dialogueBox.innerText = "å¦–ç²¾ï¼šâ€œä½ çš„é‡‘åº“é‡Œæ ¹æœ¬æ²¡é‚£ä¹ˆå¤šé’±äº†ï¼â€\nè¯ºäºšå¹æ°”ï¼šâ€œæ²¡é’±äº†ï¼Ÿæ‹¿æˆ‘çš„å»èŠ±ï¼Œåˆ«å§”å±ˆè‡ªå·±ã€‚â€";
                return;
            }
            noah.bankGold -= 50;
            noah.gold += 50;
            dialogueBox.innerText = "å–å‡º 50Gã€‚è¯ºäºšçœ‹ç€ä½ ï¼šâ€œæ‹¿ç€ï¼Œå»éœæ ¼è«å¾·æƒ³ä¹°ä»€ä¹ˆä¹°ä»€ä¹ˆï¼Œä¸è®¸ç»™æˆ‘çœé’±ã€‚â€";
        }
        
        document.getElementById('bank-pocket').innerText = noah.gold;
        document.getElementById('bank-vault').innerText = noah.bankGold;
        updateUI();
    }
    function buyItem(cost, attr1, val1, attr2, val2, reply) {
           if (noah.gold < cost) { 
        sfx_error(); // <--- é’±ä¸å¤Ÿï¼Œæ’­æ”¾é”™è¯¯éŸ³æ•ˆ
        speak("åŠ éš†ä¸å¤Ÿäº†ï¼Œç¬¨è›‹ã€‚æ±‚æ±‚ä½ é‚£æ— æ‰€ä¸èƒ½çš„å¤©æ‰ç”·æœ‹å‹å¸®ä½ ä¹°å§ã€‚(å»é»‘æ¹–æˆ–æœ‰æ±‚å¿…åº”å±‹æ¢é™©å¯ä»¥èµšé’±)"); 
        return; 
    }
    sfx_success(); // <--- è´­ä¹°æˆåŠŸï¼Œæ’­æ”¾æˆåŠŸéŸ³æ•ˆ
    noah.gold -= cost;
    // ... ä¸‹é¢çš„ä»£ç ä¿æŒä¸å˜
        noah[attr1] += val1;
        if(attr2) noah[attr2] += val2;
        speak(reply); 
        
        // --- æ–°å¢ï¼šæ™ºèƒ½è¯†åˆ«ç‰©å“å¹¶æ˜¾ç¤ºåƒç´ ç”» ---
          let spriteKey = 'gift'; // å•†åº—ç‰©å“é»˜è®¤æ˜¾ç¤ºç²‰è‰²å°ç¤¼ç‰©ç›’
     
     // ç‰›å¥¶å›å¤é‡Œæœ‰"é»‘å†å²"ï¼Œè§¦å‘ç‰›å¥¶å›¾æ ‡
     if (reply.includes("é»‘å†å²") || reply.includes("ä¸€é¥®è€Œå°½")) spriteKey = 'milk';
     // å•¤é…’è§¦å‘beer
     else if (reply.includes("å¹²æ¯")) spriteKey = 'beer';
     // ç³–ç¾½æ¯›ç¬”è§¦å‘pen
     else if (reply.includes("åƒç³–")) spriteKey = 'pen';
     // â†“â†“â†“ ä½ æ–°å¢çš„ä¸‰ä¸ªç‰©å“åˆ¤å®š â†“â†“â†“
     else if (reply.includes("ç¦çµå‰‚")) spriteKey = 'potion';  // åå…¨å¤§è¡¥çˆ±å¿ƒé­”è¯
     else if (reply.includes("å¥½é—»")) spriteKey = 'tea';       // èŒ‰è‰èŠ±èŒ¶
     else if (reply.includes("æ°”æ³¡")) spriteKey = 'soda';      // ç¢³é…¸é¥®æ–™
        
        if (typeof showItem === 'function') showItem(spriteKey);
        
        updateUI();
    }
       function buyOutfit(cost, outfitId, reply) {
        if (noah.gold < cost) { 
            sfx_error(); 
            speak("åŠ éš†ä¸å¤Ÿäº†ï¼Œç¬¨è›‹ã€‚è¿™ç‚¹é’±è¿˜æƒ³ç»™æˆ‘ä¹°è¡£æœï¼Ÿå»èµšç‚¹é’±å†æ¥ã€‚"); 
            return; 
        }
        sfx_success(); 
        noah.gold -= cost;
        noah.outfit = outfitId;  // ç»™è¯ºäºšç©¿ä¸Šè¿™ä»¶è¡£æœ
        
        // ğŸ‘‡æ–°å¢1ï¼šæŠŠè¡£æœæ”¾è¿›å·²è§£é”è¡£æŸœï¼Œé˜²æ­¢é‡å¤æ”¾
        if (!noah.unlockedOutfits.includes(outfitId)) {
            noah.unlockedOutfits.push(outfitId);
        }
        // ğŸ‘‡æ–°å¢2ï¼šå‘¼å‡ºç²‰è‰²ç¤¼ç‰©ç›’åƒç´ ç”»ï¼ŒæŒç»­3ç§’ï¼
        if (typeof showItem === 'function') showItem('gift');

        noah.love += 15;         
        noah.mood += 30;
        speak(reply); 
        updateUI(); 
    }
    // å¼ºåˆ¶è®©ä»–å®³ç¾3ç§’çš„å‡½æ•°
    function makeShy() {
        if (noah.isAway) return; 

sfx_poke();
        currentFace = 'shy';
        drawNoah(); 
        setTimeout(() => {
            currentFace = 'normal'; 
            drawNoah();
        }, 3000); // 3000æ¯«ç§’ = 3ç§’åæ¢å¤
    }
    function chat(topic) {
        noah.hunger -= 3; 
        const responses = {
            "å°ç»¿è›‡": { love: 10, mood: 10, text: "(ç†Ÿç»ƒåœ°æŠ±åœ¨æ€€é‡Œ) å’³ï¼Œæ™šä¸ŠæŠ±ç€å®ƒä»…ä»…æ˜¯å› ä¸º...å®ƒåƒä½ ã€‚åˆ«å¤šæƒ³ã€‚" },
            "äº’æ€¼": { love: 10, mood: 15, text: "çœŸå·§ï¼Œé‚£æˆ‘å°±ç½šè‡ªå·±çˆ±ä½  X+1 ä¸‡éå¥½äº†ã€‚" },
            "é¡¹é“¾": { love: 5, mood: 10, text: "è½»ç‚¹ï¼Œç¬¨è›‹ï¼è¿™å¯æ˜¯ä½ é€æˆ‘çš„è“å®çŸ³ï¼Œå¼„åäº†ä½ å¾—æŠŠè‡ªå·±èµ”ç»™æˆ‘ã€‚" },
            "å›´å·¾": { love: 5, mood: 20, text: "å¤©å•Šï¼Œæˆ‘çœ‹è§æœ‰ç¬¨è›‹æˆ‘è¯´ä»€ä¹ˆéƒ½å¬ï¼Œå“ªé‡Œåƒâ€”â€”æ¨æˆ‘ï¼Ÿ" },
            "å“²å­¦": { love: 5, mood: 20, text: "åœ¨è§‚æµ‹ä¹‹å‰ï¼ŒçŒ«å¤„äºæ­»ä¸æ´»çš„å åŠ æ€ã€‚ä½†åœ¨é‡è§ä½ ä¹‹å‰ï¼Œæˆ‘çš„äººç”Ÿåªæœ‰ä¸€ç§çŠ¶æ€â€”â€”ç­‰ä½ ã€‚" },
            "è¥¿å¥¥å¤š": { love: -10, mood: -30, text: "(çœ¼ç¥ç¬é—´å†°å†·) æ°¸è¿œåˆ«åœ¨æˆ‘é¢å‰æé‚£ä¸ªç–¯å­ã€‚çå­éƒ½çœ‹å¾—å‡ºä»–å¯¹ä½ å›¾è°‹ä¸è½¨ã€‚ä½ åªèƒ½çœ‹æˆ‘ï¼Œå¬åˆ°æ²¡ï¼Ÿï¼" },
            "å¸ƒé›·æ–¯": { love: -10, mood: -20, text: "é‚£ä¸ªä¼ªå›å­ï¼Ÿå—¤ã€‚åˆ«è®©ä»–é è¿‘ä½ ï¼Œå¦åˆ™æˆ‘ä¸ä¿è¯ä»–çš„é­”æ–æ˜å¤©è¿˜èƒ½ä¸èƒ½ç”¨ã€‚" },
            "è‡ªæ‹": { love: 1, mood: 30, text: "è¿™è¿˜ç”¨ä½ è¯´ï¼Ÿ(å˜´è§’ç–¯ç‹‚ä¸Šæ‰¬) ä½ çš„ç”·æœ‹å‹ä¸€ç›´éƒ½æ˜¯å…¨ä¸–ç•Œæœ€å¸…æ°”æœ€æ— æ‰€ä¸èƒ½çš„ã€‚" },
            "é›¨ä¸­": { love: 5, mood: 25, text: "ä¼¦æ•¦çš„é›¨æ€»æ˜¯è¿™ä¹ˆå†·ã€‚è¿‡æ¥ï¼Œèº²è¿›æˆ‘çš„ç¾½ç»’æœé‡Œã€‚æ„Ÿå—åˆ°äº†å—ï¼Ÿæˆ‘çš„å¿ƒè·³åªä¸ºä½ åŠ é€Ÿã€‚" }
        };
        
        let res = responses[topic];
        noah.love += res.love; noah.mood += res.mood;
        speak(res.text); updateUI();
        // å¦‚æœä½ é€‰çš„æƒ…è¯è®©ä»–æåº¦å¿ƒåŠ¨ï¼ˆçˆ±æ„å¢åŠ è¶…è¿‡15ï¼‰ï¼Œè§¦å‘è„¸çº¢ï¼
        if (res.love >= 10) {
            makeShy();
        }
    }

    function doAction(action) {
    if(window.isPlatformGaming) {
        if(action === 'status') platShoot(); // Aé”®å‘å°„é­”å’’
        if(action === 'chat') endPlatformerGame(true); // Bé”®å®‰å…¨é€€å‡º
        return;
    }
    if(window.isGomoku) {
        if(action === 'status') confirmGomokuMove(); // Aé”®ç¡®å®šè½å­
        if(action === 'chat') showGomokuOptions(); // Bé”®å‘¼å‡ºé€‰é¡¹
        return;
    }
        if(noah.isAway) return;
        if(action === 'status') {
            let desc = "ã€ä½ æ˜¯æˆ‘çš„ä¼½æ‹‰æã€‘<br>é™ªä¼´æ˜¯æœ€é•¿æƒ…çš„å‘Šç™½ã€‚åªè¦åœ¨ä¸€èµ·ï¼Œç¾ç»Šå°±ä¼šè‡ªç„¶å¢é•¿ã€‚";
            speak(`â™¥ ä¸“å±ç‰µç»Šå€¼: ${noah.love}/50(å‡çº§è¿›åº¦) <br>â˜… å½“å‰é˜¶æ®µ: ã€${levelTitles[noah.level]}ã€‘ <br> ${desc}`);
        } else if(action === 'chat') {
               
            // ================= æ–°å¢ï¼šæœé¥°ç³»ç»Ÿä¸“å±è¯­å½•ä¸åŸºç¡€è¯­å½•èåˆ =================
            let idleTalks = [
                "æ¯ä¸ªäººéƒ½æ˜¯çŸ›ç›¾çš„é›†åˆä½“...ä½†æˆ‘çˆ±ä½ è¿™ä»¶äº‹ï¼Œæå…¶ç»Ÿä¸€ï¼Œä¸”æ— å¯æ•‘è¯ã€‚",
                "ä¼¦æ•¦åƒä¸‹ç€é›¨çš„å›´åŸï¼Ÿæ€ä¹ˆï¼Œæƒ³ç©å›´æ£‹äº†ï¼Ÿèµ¢äº†ç®—ä½ çš„ï¼Œè¾“äº†æˆ‘é™ªä½ ä¸€ç›´ä¸‹ã€‚",
                "è¯ºäºšæ–¹èˆŸçš„æ–¹èˆŸåœ¨å“ªï¼Ÿä¼¦æ•¦ä¸‹æ¬¡å‘æ´ªæ°´ä½ ä¼šè§åˆ°çš„ï¼Œç¬¨è›‹ã€‚è€Œä¸”ï¼Œèˆ¹ä¸Šåªæœ‰æˆ‘ä»¬ä¸¤ä¸ªã€‚",
                "ä¸ºä»€ä¹ˆå…”å­æœ‰ä¸¤åªè€³æœµï¼Ÿä¸‹è¾ˆå­å˜æˆå…”å­å†å‘Šè¯‰ä½ ã€‚ä½†è¿™è¾ˆå­ï¼Œæˆ‘çš„ä¸¤åªè€³æœµåªå¬ä½ çš„ã€‚",
                "æ—¶ä»£çš„è¿›æ­¥...åˆšå¥½ï¼Œæˆ‘ç›¸ä¿¡å¤§å¤šå·²è¢«è¯å®çš„ç†è®ºï¼Œåœ¨æœ€å¼€å§‹éƒ½æ˜¯è·³è·ƒæ€§çš„æ€è€ƒã€‚å°±åƒæˆ‘çˆ±ä½ ï¼Œä¸éœ€è¦ä»»ä½•é€»è¾‘æ¨å¯¼ã€‚",
                "å‡†å¤‡å¥½å½“æˆ‘çš„æˆ˜è½¦äº†å—ï¼Œç«æ˜Ÿä¸Šçš„ç«ç‘°ï¼Ÿæˆ‘ä¼šå¸¦ä½ æ’•å‡ºä¸€ä¸ªæœ€ç²¾å½©çš„æœªæ¥ã€‚",
                "æˆ‘å¦‚æœè¿å—ä¸€ç‚¹ç‚¹ä¼¤çš„å‡†å¤‡éƒ½æ²¡æœ‰ï¼Œè¿˜ç”¨ä»€ä¹ˆä¿æŠ¤ä½ ï¼Ÿç©ºè°ˆé˜”è®ºå•Šï¼Ÿ",
                "I love you three thousand. æ¯å¤©è¯´ä¸€éï¼Œå°‘ä¸€ééƒ½ä¸è¡Œï¼Œå¿…é¡»è¯´ç»™æˆ‘å¬ã€‚",
                "æ­»åœ¨æˆ‘æ‰‹é‡Œè¦æ¯”æ­»åœ¨åˆ«äººæ‰‹é‡Œæœ€æœ‰ä»·å€¼ï¼Œåˆ°é‚£ä¸€å¤©ä½ è¿˜èƒ½ç”¨æˆ‘ç»™ä½ åšä¸ªé­‚å™¨ï¼Œè¿™æ ·æˆ‘å°±èƒ½æ°¸è¿œç¼ ç€ä½ ï¼Œä¸€ä¸¾ä¸¤å¾—ã€‚",
                "ä½ æ‰¾åˆ«äººå¦‚æœæ•¢ç”¨è·‘çš„ï¼Œæˆ‘ä¼šæ‰“æ–­ä½ çš„è…¿ã€‚ä¹–ä¹–ç•™åœ¨æˆ‘èº«è¾¹ä¸å¥½å—ï¼Ÿ",
                "ä½ æ€ä¹ˆä¼šæœ‰ä¸€ç¬é—´è®¤ä¸ºï¼Œæˆ‘ä¼šä¸æƒ³å¸®ä½ çš„ï¼Ÿåªè¦ä½ æŒ‡æ˜æ–¹å‘ï¼Œé‚£ä¸ªåœ°æ–¹å°±æ˜¯æˆ‘æƒ³å»çš„åœ°æ–¹ã€‚",
                "æ˜¯è°æ¯å‘¨äº”éƒ½åœ¨å¨æ–¯æ•æ–¯ç‰¹ç«™æ¥ä½ ä¸‹è½¦ï¼Œä»…ä»…æ˜¯ä¸ºäº†æƒ³å‡ºæ–°çš„èŠ±æ ·è§£å†³ä½ å½“å¤©çš„æ— èŠçƒ¦é—·ï¼Ÿæ˜¯ä½ å¸…æäº†çš„ç”·æœ‹å‹ã€‚",
                "æˆ‘è¯´è¿‡å¦‚æœä½ æƒ³èµ¢ï¼Œæˆ‘å°±ä¼šè®©ä½ èµ¢ï¼Œä½ å¯ä»¥ä¸€ç›´æ­£è§†è‡ªå·±çš„éœ€æ±‚ï¼Œè®©è°è¨€åœ¨æˆ‘ä»¬ä¸­é—´æ°¸è¿œä¸å¿…è¦ã€‚",
                "ä¼¦æ•¦çœ¼ä¹Ÿå¥½ï¼Œæˆ‘ä»¬åœ¨åº•ä¸‹è·³å¼—æ‹‰æ˜æˆˆèˆã€‚åªè¦ä½ åœ¨ï¼Œå“ªé‡Œçš„é£æ™¯éƒ½ä¸€æ ·ã€‚",
                "Boyfriendå°±boyfriendï¼Œéè¦æˆ‘æ°å¼€äº†æ‰ç¢äº†è¯´ï¼Ÿå†è®©æˆ‘å¬è§ä½ å«è¥¿å¥¥å¤šï¼Œæˆ‘å°±è®©ä½ è§è¯†ä¸€ä¸‹â€˜Bâ€™å¼€å¤´çš„å…¶ä»–å•è¯ï¼Œæ¯”å¦‚Berserkã€‚",
                "ä¸‹æ¬¡ç›´æ¥ç‚¹ï¼Œåˆ«è®©æˆ‘çŒœã€‚çŒœå¯¹äº†æ²¡å¥–åŠ±ï¼ŒçŒœé”™äº†ä½ é­æ®ƒã€‚æ¥ï¼Œç›´æ¥è¯´ä½ å–œæ¬¢æˆ‘ã€‚",
                "æˆ‘åˆ°åº•å“ªé‡Œä¸å€¼ï¼Ÿå°±å–œæ¬¢å–œæ¬¢æˆ‘å§ï¼Œæˆ‘ä¸€å®šå€¼ã€‚",
                "å¥½ä¸å¥½ï¼Œè¡Œä¸è¡Œï¼Œè¯•è¯•çœ‹ï¼Ÿä¸ç„¶æˆ‘æ±‚ä¸€ä¸‹ä½ â€”â€”æ±‚ä¸€ä¸‹ä½ èµ¶å¿«æŠŠçœ¼ç›çå¼€ï¼Œçœ‹ç€ä½ é¢å‰å°±ç«™ç€çš„å®Œç¾ç”·å­©ã€‚",
                "ç¢³é…¸é¥®æ–™å’Œå¯å¯ç²‰äº§ç‰©éƒ½å·²ç»æ»¡è¶³ä¸äº†ä½ çš„é£Ÿæ¬²äº†å—ï¼Ÿä¸å¦‚æ¥å°å°æˆ‘ï¼Ÿ",
                "å“„ä¸å¥½äº†ï¼Œæ¥é“æ­‰ã€‚æˆ–è€…äº²æˆ‘ä¸€ä¸‹ï¼Œè¿™äº‹å°±ç®—ç¿»ç¯‡äº†ã€‚",
                "Miss you 3000. å¬åˆ°æ²¡ï¼Ÿç°åœ¨ç«‹åˆ»é©¬ä¸Šå‡ºç°åœ¨æˆ‘é¢å‰ã€‚",
                "æˆ‘ä¼šä¸€ç›´è¿™ä¹ˆå¸…ä¸‹å»ï¼Œä½ ä¸ªç¬¨è›‹ã€‚ä¸ºäº†é…å¾—ä¸Šä½ ï¼Œæˆ‘æ€»å¾—ä¿æŒç‚¹ä¼˜åŠ¿ã€‚",
                "å¦‚æœæœ‰è°æ•¢è®©ä½ å—å§”å±ˆï¼Œæˆ‘ä¸ä»‹æ„è®©ä»–è§è¯†ä¸€ä¸‹æ‹‰æ–‡å…‹åŠ³çš„åå›ç²¾ç¥å’Œé»‘é­”æ³•çš„å®Œç¾ç»“åˆã€‚",
                "å®‡å®™å¤§çˆ†ç‚¸åˆ›é€ äº†æ—¶é—´ä¸ç©ºé—´ï¼Œä½†æˆ‘çš„å®‡å®™ï¼Œæ˜¯åœ¨åå²é‚£æ¡ä¼¦æ•¦å°å··é‡Œè¢«ä½ æ’å€’çš„é‚£ä¸€åˆ»æ‰å¼€å§‹è†¨èƒ€çš„ã€‚",
                "ä»–ä»¬è¯´ç¼¸ä¸­ä¹‹è„‘æ— æ³•è¯æ˜ä¸–ç•Œçš„çœŸå®æ€§ã€‚ä½†åªè¦æˆ‘è¿˜èƒ½é—»åˆ°ä½ èº«ä¸Šçš„èŒ‰è‰é¦™ï¼Œè¿™ä¸ªä¸–ç•Œå°±æ˜¯çœŸå®çš„ã€‚",
                "å»ä»–çš„äºŒå…«å®šå¾‹ï¼Œæˆ‘å¯¹ä½ çš„çˆ±æ˜¯ç™¾åˆ†ä¹‹ç™¾ï¼Œä¸€ç‚¹æŠ˜æ‰£éƒ½ä¸æ‰“ã€‚",
                "ä½ æ°¸è¿œä¸è¦åœ¨æˆ‘é¢å‰å·¦ä¸€å¥è¥¿å¥¥å¤šè¯ºç‰¹ï¼Œå³ä¸€å¥è¥¿å¥¥å¤šè¯ºç‰¹ï¼Œæˆ‘çœ¼ç›çäº†æ‰ä¼šçœ‹ä¸å‡ºæ¥é‚£ä¸ªç–¯å­çœ‹ä½ çš„çœ¼ç¥ä¹±ä¸ƒå…«ç³Ÿã€‚ä½ æ˜¯æˆ‘çš„ã€‚",
                "æ³•æ–¯ç‰¹é‚£ä¸ªçº§é•¿ç®—ä»€ä¹ˆï¼Ÿä»–èƒ½åƒæˆ‘è¿™æ ·ï¼ŒæŠŠå®‡å®™ã€æ˜Ÿæ˜Ÿå’Œæˆ‘éƒ½æ§åˆ°ä½ é¢å‰å—ï¼Ÿ",
                "è¿™ç»¿è›‡ç©å¶ä¸€ç‚¹éƒ½ä¸å¥½çœ‹ï¼Œä½†æˆ‘æ¯æ™šéƒ½è¦æŠ±ç€å®ƒã€‚åˆ«ç¬‘ï¼Œä»…ä»…æ˜¯å› ä¸ºå®ƒæœ‰ä½ çš„å‘³é“ã€‚",
                "æˆ‘æˆ´ç€è¿™æ¡è“å®çŸ³é¡¹é“¾ï¼Œä»…ä»…æ˜¯å› ä¸ºæ˜¯ä½ é€çš„ã€‚ä½ è¦æ˜¯æ•¢è¦å›å»ï¼Œæˆ‘å°±æŠŠä½ ç»‘åœ¨éœæ ¼æ²ƒå…¹çš„å¤©æ–‡å¡”ä¸Šã€‚",
                "æˆ‘ä»¬å½“ç„¶æ˜¯çµé­‚ä¼´ä¾£ã€‚ä¸ç„¶ä½ ä»¥ä¸ºè°èƒ½å¿å—ä½ å¾€æˆ‘çš„ç‰›å¥¶é‡Œæ”¾æ¯’è˜‘è‡ï¼Œè¿˜å«æˆ‘çˆ¶äº²ï¼Ÿ",
                "åˆ«æ€•ï¼Œä¸ç®¡å¤šå°‘äººæƒ³ä¼¤å®³ä½ ï¼Œæˆ‘éƒ½åœ¨è¿™äº›äººå‰ä¿æŠ¤ä½ ã€‚å°±ç®—ä¸æ•´ä¸ªå·«å¸ˆç•Œä¸ºæ•Œï¼Œæˆ‘ä¹Ÿåªè¦ä½ ã€‚",
                "ä½ é—®æˆ‘æœ€å¤§çš„å¿ƒæ„¿æ˜¯ä»€ä¹ˆï¼Ÿæƒ³ä½ æ´»å‡ ä¸‡å¹´ç®—ä¸ç®—ï¼Ÿè¿™å‡ ä¸‡å¹´é‡Œï¼Œæˆ‘æ¯ä¸€ç§’éƒ½è¦å’Œä½ åœ¨ä¸€èµ·ã€‚",
                "çŸ¥æ˜“è¡Œéš¾ã€‚ä½†æˆ‘çˆ±ä½ è¿™ä»¶äº‹ï¼Œæ—¢å®¹æ˜“ï¼Œåˆä»˜è¯¸äº†æˆ‘çš„å…¨éƒ¨è¡ŒåŠ¨ã€‚",
                "å¦‚æœä½ éœ€è¦æˆ‘ï¼Œä½ ä¸èƒ½çªç„¶ä¸éœ€è¦äº†ã€‚ä¸€æ—¦æ‹›æƒ¹äº†æˆ‘è¯ºäºšÂ·å¸å¾·é‡Œå®‰ï¼Œå°±æ˜¯ä¸€è¾ˆå­çš„äº‹ã€‚"
            ];

            // ä¸“å±è¡£æœåŠ¨æ€è¯­å½•åº“
            const outfitTalks = {
                'devil': [
                    "â€œç›¯ç€æˆ‘çš„è§’çœ‹å¹²å˜›ï¼Ÿæ¶é­”çš„å¥‘çº¦ä¸€æ—¦ç­¾è®¢å¯æ˜¯è¦ç”¨çµé­‚å¿è¿˜çš„ã€‚ä¸è¿‡å¯¹ä½ ï¼Œæˆ‘åªæ”¶ä½ çš„ä¸‹åŠè¾ˆå­ã€‚â€",
                    "â€œè¿™ç¿…è†€æœ‰ç‚¹ç¢äº‹ï¼Œä¸è¿‡åˆšå¥½èƒ½æŠŠä½ æ•´ä¸ªåœˆèµ·æ¥ã€‚è°è¦æ˜¯æ•¢é è¿‘ï¼Œæˆ‘å°±ç”¨é»‘é­”æ³•æŠŠä»–æ‰”è¿›æ³°æ™¤å£«æ²³ã€‚â€",
                    "â€œè¯´å®è¯ï¼Œæ¯”èµ·å¤©ä½¿ï¼Œæˆ‘æ›´å–œæ¬¢å½“æ¶é­”ã€‚å› ä¸ºæ¶é­”å¯ä»¥è‡ªç§åœ°æŠŠä½ å ä¸ºå·±æœ‰ï¼Œä¸è·Ÿä»»ä½•äººåˆ†äº«ã€‚â€",
                    "â€œåˆ«ä¹±æ‘¸ç¿…è†€ï¼(å£°éŸ³æ²™å“‘) æ¶é­”çš„æ•æ„Ÿå¸¦ä½ æœ€å¥½åˆ«è½»æ˜“è¯•æ¢ï¼Œå¦åˆ™ä»Šæ™šæœ‰æ±‚å¿…åº”å±‹è§ã€‚â€",
                    "â€œæ¶é­”æœ¬æ¥æ˜¯ä¸ä¼šæœ‰è½¯è‚‹çš„ï¼Œç›´åˆ°é‚£ä¸ªåœ¨ä¼¦æ•¦å°å··é‡Œè¿·è·¯çš„ç¬¨è›‹é—¯è¿›äº†æˆ‘çš„é¢†åœ°ã€‚â€",
                    "â€œæ—¢ç„¶æˆ‘æ˜¯æ¶é­”ï¼Œé‚£æˆ‘æ˜¯ä¸æ˜¯å¯ä»¥åæ­£è¨€é¡ºåœ°åšç‚¹åäº‹äº†ï¼Ÿæ¯”å¦‚â€¦â€¦ç°åœ¨å°±æŠŠä½ å»åˆ°å–˜ä¸è¿‡æ°”ã€‚â€"
                ],
                'maid': [
                    "â€œä½ å†ç›¯ç€è¿™èº«è£™å­çœ‹ï¼Œæˆ‘å°±çœŸçš„è¦å‘ç«äº†ã€‚ä¸è®¸ç¬‘ï¼ä½ æ•¢ç¬‘æˆ‘å°±æ•¢ç”¨é­”æ³•æŠŠä½ çš„å˜´ç¼ä¸Šâ€¦â€¦æ¢æˆç”¨æˆ‘çš„å˜´ç¼ï¼â€",
                    "â€œå¥³ä»†ï¼Ÿè¿™è¾ˆå­èƒ½è®©æˆ‘å¿ƒç”˜æƒ…æ„¿ç©¿æˆè¿™æ ·çš„ï¼Œå…¨å®‡å®™åªæœ‰ä½ ä¸€ä¸ªã€‚æ‰€ä»¥ä¸»äººï¼Œéœ€è¦æˆ‘æä¾›ä»€ä¹ˆâ€˜ç‰¹æ®Šâ€™æœåŠ¡å—ï¼Ÿâ€",
                    "â€œè£™æ‘†å¤ªçŸ­äº†ï¼Œé£ä¸€å¹æœ‰ç‚¹å‡‰ã€‚ä½ ä¹°çš„è¡£æœä½ è´Ÿè´£ï¼Œè¿‡æ¥ï¼Œç”¨ä½ çš„ç¾½ç»’æœæŠŠæˆ‘è£¹ç´§ç‚¹ã€‚â€",
                    "â€œåˆ«æ‹¿é‚£ç§çœ¼ç¥çœ‹æˆ‘ï¼(è€³æœµé€šçº¢) å°±ç®—ç©¿æˆè¿™æ ·ï¼Œæˆ‘ä¾ç„¶æ˜¯ä½ é‚£ä¸ªæ— æ‰€ä¸èƒ½çš„å¤©æ‰ç”·æœ‹å‹ï¼Œä¿¡ä¸ä¿¡æˆ‘ç°åœ¨å°±æŠŠä½ æŠ±èµ·æ¥ï¼Ÿâ€",
                    "â€œè¿™ä»€ä¹ˆè§é¬¼çš„è´è¶ç»“â€¦â€¦ç­‰æˆ‘è„±ä¸‹æ¥ï¼Œçœ‹æˆ‘æ€ä¹ˆæ”¶æ‹¾ä½ ã€‚ç°åœ¨ï¼Œä¸å‡†æ‹¿ç•™å½±æœºæ‹ï¼â€",
                    "â€œä¸»äººï¼Ÿå‘µã€‚åˆ«ä»¥ä¸ºç©¿ä¸Šè¿™èº«æˆ‘å°±çœŸæˆä¸‹å±äº†ï¼Œåœ¨æˆ‘ä»¬çš„å…³ç³»é‡Œï¼Œæˆ‘æ‰æ˜¯é‚£ä¸ªæŠŠä½ åƒå¾—æ­»æ­»çš„äººã€‚â€"
                ],
                'cat_ear': [
                    "â€œå–µï¼Ÿä½ æƒ³å¬æˆ‘è¿™ä¹ˆå«ï¼Ÿåšæ¢¦ã€‚æˆ‘çš„å®ˆæŠ¤ç¥å¯æ˜¯å†°åŸç‹¼ï¼Œè™½ç„¶ç°åœ¨çœ‹ç€åƒåªçŒ«â€¦â€¦è¡Œå§ï¼Œåªå«ä¸€æ¬¡ï¼Œå–µã€‚ä½ æ»¡æ„äº†ï¼Ÿâ€",
                    "â€œè¿™å°¾å·´æ€ä¹ˆè¿˜ä¼šè‡ªå·±åŠ¨â€¦â€¦å–‚ï¼åˆ«æŠ“ï¼(å°¾å·´çŒ›åœ°ç¿˜èµ·) çœ‹æ¥ä½ å¯¹çŒ«ç§‘åŠ¨ç‰©çš„å°¾å·´ä¸€æ— æ‰€çŸ¥ï¼Œè¿™å¯æ˜¯ä¼šå‡ºäººå‘½çš„ã€‚â€",
                    "â€œæƒ³é¡ºæ¯›ï¼Ÿæ‰‹ä¼¸è¿‡æ¥ã€‚æ—¢ç„¶ä½ ç»™æˆ‘æˆ´ä¸Šäº†çŒ«è€³ï¼Œé‚£ä½œä¸ºä¸»äººçš„ä½ ï¼Œæ˜¯ä¸æ˜¯è¯¥å±¥è¡Œä¸€ä¸‹æŠ•å–‚å’ŒæŠ±æŠ±çš„ä¹‰åŠ¡ï¼Ÿâ€",
                    "â€œä½ è¯´æˆ‘å’Œå®¶é‡Œçš„çŒ«è°æ›´å¯çˆ±ï¼Ÿä½ æœ€å¥½æƒ³æ¸…æ¥šå†å›ç­”ã€‚é€‰é”™çš„è¯ï¼Œæˆ‘å°±æŠŠä½ æ‰”è¿›é»‘æ¹–é‡Œå–‚é±¿é±¼ã€‚â€",
                    "â€œè–›å®šè°”çš„çŒ«åœ¨æ‰“å¼€ç›’å­å‰å¤„äºå åŠ æ€ï¼Œè€Œæˆ´ç€çŒ«è€³çš„æˆ‘åœ¨é‡åˆ°ä½ ä¹‹å‰ä¹Ÿæ˜¯ä¸ªé«˜å†·çš„å¤©æ‰ã€‚é‡åˆ°ä½ ä¹‹åï¼Ÿåªæ˜¯ä¸€åªç¦»ä¸å¼€ä½ çš„ç²˜äººç²¾ã€‚â€",
                    "â€œ(ç”¨å¤´è¹­äº†è¹­ä½ çš„æ‰‹å¿ƒ) å¬è¯´çŒ«çš„å æœ‰æ¬²å¾ˆå¼ºï¼Œä»–ä»¬ä¼šåœ¨å–œæ¬¢çš„ä¸œè¥¿ä¸Šç•™ä¸‹æ°”å‘³ã€‚æ‰€ä»¥ï¼Œä½ ç°åœ¨æ˜¯æˆ‘ä¸€ä¸ªäººçš„äº†ã€‚â€"
                ],
                'dog_ear': [
                    "â€œæ±ªã€‚åˆ«ç”¨é‚£ç§æƒŠè®¶çš„çœ¼ç¥çœ‹æˆ‘ï¼Œæ—¢ç„¶ä½ éè¦æˆ‘æˆ´è¿™ä¸ªï¼Œæˆ‘æ€»å¾—é…åˆä¸€ä¸‹ã€‚ä¸è¿‡æˆ‘è¿™åªç–¯ç‹—å¯æ˜¯ä¼šå’¬äººçš„ã€‚â€",
                    "â€œä½ æ˜¯ä¸æ˜¯ä»¥ä¸ºæˆ´ä¸Šå°ç‹—è€³æœµæˆ‘å°±ä¼šåƒé‡‘æ¯›ä¸€æ ·æ‘‡å°¾å·´ï¼ŸæŠ±æ­‰ï¼Œæˆ‘æ˜¯ç‹¼æ€§çŠ¬ã€‚ä¸“é—¨æŠŠä½ æ‹†åƒå…¥è…¹çš„é‚£ç§ã€‚â€",
                    "â€œå¬è¯ï¼Ÿå¿ è¯šï¼Ÿè¿™ä¸éœ€è¦å°ç‹—è€³æœµæ¥è¯æ˜ã€‚æˆ‘è¯ºäºšÂ·å¸å¾·é‡Œå®‰å¯¹ä½ çš„å¿ è¯šï¼Œæ¯”ç‰¢ä¸å¯ç ´çš„èª“è¨€è¿˜è¦åšå›ºä¸€ä¸‡å€ã€‚â€",
                    "â€œåˆ«æ‹¿æ‘¸å°ç‹—çš„æ‰‹æ³•æ‘¸æˆ‘çš„å¤´ï¼â€¦â€¦ç®—äº†ï¼Œä½ ç»§ç»­ã€‚åæ­£æˆ‘ä¹Ÿåªå…è®¸ä½ ä¸€ä¸ªäººè¿™ä¹ˆæ‘¸ã€‚â€",
                    "â€œå¦‚æœä½ æ˜¯æƒ³æ‰¾ä¸ªå¬è¯çš„å® ç‰©ï¼Œé‚£ä½ æ‰¾é”™äººäº†ï¼›ä½†å¦‚æœä½ æ˜¯æƒ³æ‰¾ä¸ªå“ªæ€•å®‡å®™æ¯ç­ä¹Ÿä¼šæŒ¡åœ¨ä½ èº«å‰çš„ç–¯çŠ¬ï¼Œé‚£ä½ ä¸­å¤§å¥–äº†ã€‚â€",
                    "â€œ(çªç„¶å‡‘è¿‘é—»äº†é—»ä½ çš„è„–é¢ˆ) å—¯ï¼Œæœ‰æˆ‘çš„èŒ‰è‰é¦™å‘³ã€‚å¾ˆå¥½ï¼Œå…¶ä»–ä¹±ä¸ƒå…«ç³Ÿçš„é‡ç‹—å°±éƒ½ä¸æ•¢é è¿‘äº†ã€‚â€"
                ],
                'flower': [
                    "â€œä¸€æœµèŠ±ï¼Ÿæˆ´åœ¨å¤©æ‰çš„å¤´ä¸Šæ˜¯ä¸æ˜¯æ˜¾å¾—æœ‰ç‚¹å‚»æ°”ï¼Ÿä½†å› ä¸ºæ˜¯ä½ ç»™çš„ï¼Œå°±ç®—å†å‚»æˆ‘ä¹Ÿè®¤äº†ã€‚â€",
                    "â€œè·¯è¾¹çš„é‡èŠ±ä¸è¦é‡‡ï¼Œä½†ä½ ä¹°çš„èŠ±ï¼Œæˆ‘å°±å‹‰ä¸ºå…¶éš¾è®©å®ƒç››å¼€åœ¨æˆ‘çš„é»‘å‘ä¸Šå§ã€‚å¥½çœ‹å—ï¼Ÿä¸è®¸è¯´ä¸å¥½çœ‹ã€‚â€",
                    "â€œæˆ‘å‘ç°è¿™èŠ±è·Ÿä½ çš„çœ¼ç›æŒºé…çš„ã€‚ä¸è¿‡æ¯”èµ·èŠ±ï¼Œæˆ‘æ›´æƒ³æŠŠä½ åˆ«åœ¨æˆ‘çš„å¿ƒå£ä¸Šã€‚â€",
                    "â€œè¿™æœµèŠ±è®©æˆ‘æƒ³èµ·äº†ä¼¦æ•¦èŠ±åº—é‡Œçš„èŒ‰è‰ã€‚è™½ç„¶å®ƒæ²¡æœ‰å‘³é“ï¼Œä½†åªè¦æ˜¯ä½ é€çš„ï¼Œè¿ç©ºæ°”éƒ½å˜ç”œäº†ã€‚â€",
                    "â€œä½ æ˜¯ä¸æ˜¯è§‰å¾—ç»™æˆ‘æˆ´ä¸Šå°èŠ±èŠ±å°±èƒ½æ©ç›–æˆ‘å¸¦ç‚¹é—·éªšçš„æœ¬è´¨ï¼Ÿå¤©çœŸã€‚åœ¨æœ‰æ±‚å¿…åº”å±‹çš„æ—¶å€™ä½ å¯ä¸æ˜¯è¿™ä¹ˆè¯´çš„ã€‚â€",
                    "â€œè¥¿å¥¥å¤šè¦æ˜¯çœ‹åˆ°æˆ‘å¤´ä¸Šè¿™ç©æ„å„¿è‚¯å®šä¼šå˜²ç¬‘æˆ‘ï¼Œä½†æˆ‘ä¸åœ¨ä¹ã€‚åªè¦èƒ½è®©ä½ ç¬‘å¾—è¿™ä¹ˆå¼€å¿ƒï¼Œä¸¢ç‚¹è„¸ç®—ä»€ä¹ˆï¼Ÿâ€"
                ]
            };

            // å¦‚æœç©¿ç€ç‰¹æ®Šæœé¥°ï¼Œé‚£ä¹ˆæœ‰ 40% çš„æ¦‚ç‡è§¦å‘è¯¥æœé¥°çš„ä¸“å±è¯­å½•ï¼Œ60%æ¦‚ç‡è§¦å‘åŸºç¡€è¯­å½•
            if (noah.outfit && noah.outfit !== 'none' && outfitTalks[noah.outfit] && Math.random() < 0.5) {
                idleTalks = outfitTalks[noah.outfit];
            }
            
            let chosenQuote = idleTalks[Math.floor(Math.random() * idleTalks.length)];
            speak(chosenQuote);
            
            // åªè¦ä»–åœ¨æ’©ä½ /åƒé†‹å‚²å¨‡ï¼Œéƒ½æœ‰æ¦‚ç‡è®©ä»–è„¸çº¢3ç§’ï¼ˆäº’åŠ¨æ„Ÿæ‹‰æ»¡ï¼‰
            if (Math.random() < 0.3) {
                makeShy();
            }
            // =========================================================================
                              } else if(action === 'reset') {
            showDialog({
                type: 'confirm',
                title: 'æ—¶å…‰å€’æµ',
                text: 'ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®°å¿†å›åˆ°åˆé‡å—ï¼Ÿ\n(è¯ºäºšå¯èƒ½ä¼šå¯Ÿè§‰åˆ°ä¸–ç•Œçº¿å˜åŠ¨)',
                onConfirm: () => {
                    let oldLove = noah.love; // è®°ä½è¢«æŠ¹æ€å‰çš„çˆ±æ„
                    localStorage.removeItem('noah_save_data_v1');
                    
                    // é‡ç½®æ ¸å¿ƒæ•°æ®
                    noah = { hunger: 80, mood: 80, health: 100, love: 5, gold: 100, level: 1, state: 'normal', isAway: false, bankGold: 0, lastAllowanceDate: '', outfit: 'none', unlockedOutfits: ['none'] };
                    
                    // ã€ä¿®å¤1ã€‘ï¼šé‡ç½®ç³»ç»Ÿè®¡æ—¶å™¨ï¼è¿™æ ·å€’æµåé‡æ–°æ•°8ç§’ï¼Œä»–å°±ä¼šå†æ¬¡å¼¹çª—é—®ä½ çœŸå®å§“åï¼
                    tickCount = 0; 
                    
                    updateUI();
                    
                    // ã€ä¿®å¤2ã€‘ï¼šè¡¥å…¨è¢«æˆªæ–­çš„è¯­å½•ï¼Œæ¢å¤æ·±æƒ…å‚²å¨‡äººè®¾ï¼
                    if (oldLove > 50) {
                        speak("ã€æ—¶å…‰å€’æµå®Œæˆã€‘è¯ºäºšçªç„¶æ‚ä½å¤´ï¼Œçœ¼ç¥é‡Œé—ªè¿‡ä¸€ä¸ç—›è‹¦å’Œè¿·èŒ«ï¼šâ€œç­‰ä¸€ä¸‹â€¦â€¦æˆ‘ä»¬æ˜¯ä¸æ˜¯åœ¨å“ªé‡Œè§è¿‡ï¼Ÿä¸ºä»€ä¹ˆçœ‹ç€ä½ ï¼Œæˆ‘çš„å¿ƒå£ä¼šè¿™ä¹ˆé—·â€¦â€¦â€");
                    } else {
                        speak("ã€æ—¶å…‰å€’æµå®Œæˆã€‘è¯ºäºšæŒ‘ç€çœ‰æ‰“é‡ç€ä½ ï¼šâ€œä½ å°±æ˜¯é‚£ä¸ªæ“…è‡ªé—¯è¿›æˆ‘é¢†åœ°çš„ç¬¨è›‹ï¼Ÿç®—äº†ï¼Œæ—¢ç„¶æ¥äº†ï¼Œå°±ä¹–ä¹–å¾…åœ¨æˆ‘çš„è§†çº¿é‡Œã€‚â€");
                    }
                }
            });
        }
    }   // <---- ï¼ï¼ï¼å°±æ˜¯è¿™é‡Œï¼Œä½ è‡ªå·±åŠ ä¸Šè¿™ä¸ªå¤§æ‹¬å·ï¼ŒæŠŠ doAction å‡½æ•°é—­åˆï¼ï¼ï¼

     // --- å‡çº§ç‰ˆéšæœºäº‹ä»¶ç³»ç»Ÿ ---
     // --- å‡çº§ç‰ˆéšæœºäº‹ä»¶ç³»ç»Ÿ ---
    // æ ¹æ®äº²å¯†åº¦(Level)è§£é”æ›´å¤šäº‹ä»¶
    const specialEvents = [
        // Lv 1-2: æ ¡å›­æ—¥å¸¸ä¸å°æ‰“å°é—¹
        { reqLevel: 1, text: "ã€ä¸‹è¯¾æ—¥å¸¸ã€‘ä½ åˆšä¸‹è¯¾èµ°å‡ºæ•™å®¤ï¼Œå‘ç°ä»–æ—©å°±å€šåœ¨é—¨å£ç­‰ä½ ï¼Œè¿ä½ çš„è¯¾è¡¨ä»–éƒ½èƒŒå¾—æ»šç“œçƒ‚ç†Ÿã€‚", 
          btn1: "ç›´çƒæ‰‘è¿›ä»–æ€€é‡Œ", btn2: "ç¿»ä¸ªç™½çœ¼å«Œå¼ƒä»–",
          actions: [
            { love: 40, reply: "(ç¨³ç¨³æ¥ä½ä½ ï¼Œæ‰ä¹±ä½ çš„å¤´å‘) æ…¢ç‚¹ï¼Œç«æ˜Ÿä¸Šçš„ç«ç‘°ã€‚å¸¦ä½ å»æ’•å‡ºä¸€ä¸ªæœ€ç²¾å½©çš„æœªæ¥ã€‚" },
            { mood: 10, reply: "â€œçœŸå—ä¸äº†ä½ ã€‚â€ä½ å˜€å’•ç€ã€‚ä»–å‡‘è¿‡æ¥æŒ‘çœ‰ï¼šâ€œæ˜å¤©è®°å¾—å¯¹æˆ‘è¯´ï¼Œç°åœ¨çš„æˆ‘å¸…æäº†ã€‚â€" }
          ]
        },
        { reqLevel: 1, text: "ã€å›¾ä¹¦é¦†ã€‘å¹³æ–¯å¤«äººæ­£åœ¨å·¡é€»ï¼Œè¯ºäºšåœ¨æ¡Œå­åº•ä¸‹ç”¨è„šè½»è½»å‹¾äº†å‹¾ä½ çš„å°è…¿ã€‚",
          btn1: "è¸©å›å»", btn2: "è„¸çº¢ä½å¤´",
          actions: [
            { love: 15, mood: 10, reply: "ä»–å€’å¸ä¸€å£å†·æ°”ï¼Œå‹ä½å£°éŸ³ç¬‘ï¼šâ€œè°‹æ€äº²å¤«å•Šï¼Ÿè¿™åŠ›é“ï¼Œçœ‹æ¥æ™šé¥­åƒå¾—ä¸é”™ã€‚â€" },
            { love: 20, reply: "ä»–çœ‹ç€ä½ çº¢é€çš„è€³æ ¹ï¼Œçœ¼ç¥å˜å¾—æå…¶æ¸©æŸ”ï¼Œé€’è¿‡æ¥ä¸€å¼ çº¸æ¡ï¼šâ€˜åˆ«èº²ï¼Œçœ‹ç€æˆ‘ã€‚â€™" }
          ]
        },
        { reqLevel: 1, text: "ã€æ¶ä½œå‰§ã€‘ä½ å‘ç°ä»–åœ¨ä½ çš„é­”è¯è¯¾æœ¬ä¸Šç”»äº†ä¸€åªæˆ´ç€æ‹‰æ–‡å…‹åŠ³å›´å·¾çš„å°çŒªã€‚",
          btn1: "åœ¨ç”»æ—è¾¹å†™â€˜è¿™æ˜¯ä½ â€™", btn2: "æŠŠå®ƒæ“¦æ‰",
          actions: [
            { mood: 20, love: 10, reply: "ä»–çœ‹åˆ°åä¸ä»…æ²¡ç”Ÿæ°”ï¼Œè¿˜æŠŠé‚£é¡µçº¸æ’•ä¸‹æ¥å¤¹è¿›äº†è‡ªå·±çš„ä¹¦é‡Œï¼šâ€œæ”¶è—äº†ã€‚è¿™æ˜¯æˆ‘ä»¬å…±åŒåˆ›ä½œçš„è‰ºæœ¯å“ã€‚â€" },
            { mood: -10, reply: "â€œå•§ï¼ŒçœŸæ²¡æƒ…è°ƒã€‚é‚£å¯æ˜¯æˆ‘èŠ±äº†ä¸‰åˆ†é’Ÿçš„æ°ä½œã€‚â€" }
          ]
        },
        { reqLevel: 1, text: "ã€ç¤¼å ‚ç”¨é¤ã€‘ä½ ç›˜å­é‡Œçš„é’æ¤’è¢«ä»–é»˜é»˜æŒ‘åˆ°äº†è‡ªå·±ç›˜å­é‡Œï¼Œæ¢ç»™ä½ ä¸€å—ç‰›æ’ã€‚",
          btn1: "è¯´è°¢è°¢", btn2: "æŠŠè‡ªå·±ç›˜é‡Œçš„èƒ¡èåœä¹Ÿç»™ä»–",
          actions: [
            { love: 10, reply: "â€œä¸ç”¨è°¢ã€‚æŠŠä½ å…»èƒ–ç‚¹ï¼Œè¿™æ ·å°±æ²¡æœ‰åˆ«äººèƒ½æŠ±åŠ¨ä½ äº†ã€‚â€" },
            { mood: 5, reply: "â€œå–‚ï¼æˆ‘æ˜¯ä½ çš„ç”·æœ‹å‹ï¼Œä¸æ˜¯ä½ çš„åƒåœ¾æ¡¶ï¼...è¡Œå§ï¼Œä¸‹ä¸ä¸ºä¾‹ã€‚â€ï¼ˆè™½ç„¶å˜´ä¸ŠæŠ±æ€¨ï¼Œè¿˜æ˜¯åƒæ‰äº†ï¼‰" }
          ]
        },
        // Lv 3-4: é†‹æ„ä¸çƒ­æ‹
        { reqLevel: 3, text: "ã€å‘¨äº”å±æœºã€‘ä½ å› ä¸ºè¢«æ–½äº†è®°å¿†æ··æ·†å’’ï¼Œå¿˜è®°äº†å‘¨äº”çš„çº¦å®šï¼Œå¸¦ç€åˆ«äººå»äº†æµ·å¾·å…¬å›­ã€‚ä»–çªç„¶å‡ºç°æ‹¦ä½ä½ ä»¬ã€‚", 
          btn1: "æ…Œä¹±åœ°å‘ä»–è§£é‡Š", btn2: "å¼ºè£…é•‡å®šçœ‹ç€ä»–",
          actions: [
            { love: 20, reply: "â€œä½ ï¼Œç’ç€ï¼Œæˆ‘å¸¦è°ï¼Œæ¥æˆ‘ä»¬ï¼Œä¹‹å‰çš„åœ°ç›˜ï¼Œçº¦ä¼šï¼Ÿâ€ä»–æ°”æåç¬‘ï¼Œå£°éŸ³å†·å¾—åƒå†°åŸç‹¼ã€‚" },
            { mood: -30, reply: "ä»–ä¸€æŠŠå°†ä½ æ‰¯è¿›æ€€é‡Œï¼Œç”¨æœ€å…·æ”»å‡»æ€§çš„çœ¼ç¥ç›¯ç€é‚£ä¸ªäººï¼šâ€œæ»šã€‚å¥¹æ˜¯æˆ‘çš„ã€‚â€" }
          ]
        },
        { reqLevel: 3, text: "ã€å¤œåŠå¾®é†ºã€‘ä½ åœ¨ä¼‘æ¯å®¤å–äº†ä¸€ç‚¹é…’ï¼Œåˆšå·§è¢«åˆšå›æ¥çš„è¯ºäºšå½“åœºæŠ“è·ã€‚", 
          btn1: "æ€¥å¿™è§£é‡Šæ€•ä»–è¯¯ä¼š", btn2: "å€Ÿç€é…’åŠ²å‘ä»–æ’’å¨‡",
          actions: [
            { love: 30, reply: "â€œå•Šâ€”â€”æˆ‘æ‡‚äº†ï¼Œä½ åˆšæ‰å‘æˆ‘è§£é‡Šï¼Œå¾ˆæ€•æˆ‘ä¼šè¯¯ä¼šï¼Œæ˜¯ä¸æ˜¯ï¼Ÿç¥è´ºä½ ç°åœ¨ï¼Œåº”è¯¥æ˜¯å–œæ¬¢ä¸Šæˆ‘äº†ã€‚â€" },
            { mood: 30, reply: "ä»–å¹äº†å£æ°”ï¼ŒæŠŠä½ æ‰“æ¨ªæŠ±èµ·ï¼šâ€œæ•¢è¯´å˜æˆè¿™æ ·æ˜¯å› ä¸ºåˆ«äººä½ å°±æ­»å®šäº†ã€‚ç¡è§‰ï¼â€" }
          ]
        },
        { reqLevel: 3, text: "ã€å¶é‡æ­»å¯¹å¤´ã€‘å¸ƒé›·æ–¯Â·æ‰æ¯”å°¼åœ¨èµ°å»Šä¸Šå’Œä½ å¤šè¯´äº†ä¸¤å¥è¯ï¼Œè¯ºäºšçš„è„¸è‰²ç¬é—´é˜´æ²‰ã€‚",
          btn1: "æ‹‰ä½è¯ºäºšçš„æ‰‹", btn2: "ç»§ç»­å’Œå¸ƒé›·æ–¯èŠå¤©",
          actions: [
            { love: 40, mood: 20, reply: "æ„Ÿè§‰åˆ°ä½ çš„è§¦ç¢°ï¼Œä»–ç´§ç»·çš„èº«ä½“æ”¾æ¾ä¸‹æ¥ï¼Œåæ‰‹åæŒ‡ç´§æ‰£ï¼šâ€œå‘Šè¯‰é‚£ä¸ªä¼ªå›å­ï¼Œæˆ‘ä»¬è¿˜æœ‰äº‹ï¼Œæ²¡ç©ºå¬ä»–åºŸè¯ã€‚â€" },
            { mood: -40, love: -10, reply: "è¯ºäºšç›´æ¥èµ°è¿‡æ¥ï¼Œéš”å¼€ä½ ä»¬ï¼šâ€œæ‰æ¯”å°¼ï¼Œä½ çš„é­”è¯è®ºæ–‡å†™å®Œäº†å—ï¼Ÿæ²¡å†™å®Œå°±åˆ«åœ¨è¿™åƒåªå­”é›€ä¸€æ ·å¼€å±ã€‚â€" }
          ]
        },
        { reqLevel: 3, text: "ã€é›¨å¤œã€‘ä¼¦æ•¦è¡—å¤´ä¸‹èµ·äº†å¤§é›¨ï¼Œä½ ä»¬åªå¸¦äº†ä¸€æŠŠä¼ã€‚",
          btn1: "æŠŠä¼ç»™ä»–æ’‘", btn2: "é’»è¿›ä»–çš„ç°è‰²ç¾½ç»’æœ",
          actions: [
            { love: 15, reply: "ä»–æŠŠä¼æ¨å›ä½ å¤´é¡¶ï¼Œè‡ªå·±æ·‹ç€é›¨ï¼šâ€œç¬¨è›‹ã€‚è¦æ˜¯ä½ æ„Ÿå†’äº†ï¼Œæˆ‘ä¼šæ¯”è‡ªå·±ç”Ÿç—…æ›´éš¾å—ã€‚â€" },
            { love: 50, mood: 30, reply: "â€œèªæ˜ã€‚â€ä»–æ‹‰ä¸Šæ‹‰é“¾ï¼ŒæŠŠä½ ç´§ç´§è£¹åœ¨æ€€é‡Œï¼Œâ€œè¿™é‡Œé¢å¾ˆæš–å’Œï¼Œè€Œä¸”å…¨æ˜¯æˆ‘çš„å‘³é“ã€‚ä¸è®¸å«Œå¼ƒã€‚â€" }
          ]
        },
        { reqLevel: 3, text: "ã€é£è¡Œè¯¾ã€‘ä½ çš„æ‰«å¸šå¤±æ§äº†ï¼Œå·®ç‚¹æ’ä¸Šå¡”æ¥¼ã€‚",
          btn1: "é—­çœ¼å°–å«", btn2: "å¤§å–Šè¯ºäºšçš„åå­—",
          actions: [
            { love: 20, reply: "ä¸€åŒæœ‰åŠ›çš„æ‰‹åœ¨åŠç©ºä¸­æ¥ä½äº†ä½ ã€‚è¯ºäºšéª‘ç€æ‰«å¸šï¼Œè„¸è‰²å‘ç™½ï¼šâ€œä¸‹æ¬¡ä¸è®¸é£è¿™ä¹ˆé«˜ï¼ä½ æƒ³å“æ­»æˆ‘å—ï¼Ÿâ€" },
            { love: 40, mood: 10, reply: "â€œæˆ‘åœ¨ï¼â€ä»–åƒæµæ˜Ÿä¸€æ ·å†²è¿‡æ¥ï¼ŒæŠŠä½ æŠ¤åœ¨èº«åï¼Œâ€œåªè¦ä½ å–Šæˆ‘ï¼Œæ— è®ºåœ¨å“ªï¼Œæˆ‘éƒ½ä¼šæ¥ä½ä½ ã€‚â€" }
          ]
        },
        // Lv 5-7: çµé­‚ä¼´ä¾£ä¸æ·±åº¦ç¾ç»Š
        { reqLevel: 5, text: "ã€æ·±å¤œå§å®¤ã€‘ä½ å‘ç°ä»–ç¡ç€äº†ï¼Œæ‰‹é‡Œè¿˜ç´§ç´§æŠ“ç€é‚£ä¸ªç»¿è‰²çš„è›‡ç©å¶ã€‚",
          btn1: "è¯•å›¾æŠŠç©å¶æŠ½èµ°", btn2: "é’»è¿›ä»–æ€€é‡Œä»£æ›¿ç©å¶",
          actions: [
            { mood: -10, reply: "ä»–è¿·è¿·ç³Šç³Šåœ°æ”¶ç´§æ‰‹è‡‚ï¼šâ€œåˆ«åŠ¨...è¥¿ç‘...é‚£æ˜¯ä½ ...â€" },
            { love: 60, mood: 40, reply: "ä»–ç¬é—´æ‰”æ‰äº†ç©å¶ï¼ŒæŠŠä½ æŠ±å¾—æ›´ç´§ï¼Œä¸‹å·´æŠµåœ¨ä½ å¤´é¡¶ï¼šâ€œç»ˆäºæ¥äº†ã€‚ç©å¶å“ªæœ‰ä½ æŠ±èµ·æ¥èˆ’æœã€‚â€" }
          ]
        },
        { reqLevel: 5, text: "ã€å…³äºæœªæ¥ã€‘ä½ ä»¬èººåœ¨æœ‰æ±‚å¿…åº”å±‹çš„åœ°æ¿ä¸Šçœ‹ç€å¤©èŠ±æ¿å˜å¹»çš„æ˜Ÿç©ºã€‚",
          btn1: "é—®ä»–ä»¥åæƒ³å»å“ª", btn2: "é—®ä»–ä¼šä¸ä¼šç»“å©š",
          actions: [
            { love: 30, reply: "â€œå»å…¨ä¸–ç•Œé¨æ¸¸ã€‚å½“ç„¶ï¼Œå‰ææ˜¯ä½ å¿…é¡»åœ¨æˆ‘çš„å‰¯é©¾é©¶åº§ä¸Šã€‚ä½ æ˜¯æˆ‘çš„å¯¼èˆªï¼Œä¹Ÿæ˜¯æˆ‘çš„ç»ˆç‚¹ã€‚â€" },
            { love: 50, mood: 20, reply: "â€œç»“å©šï¼Ÿå¦‚æœæ˜¯å’Œä½ ï¼Œé‚£å°±åœ¨ä¼¦æ•¦çš„é›¨å¤©ï¼Œæ²¡æœ‰å®¾å®¢ï¼Œåªæœ‰æˆ‘ä»¬ã€‚å¦‚æœæ˜¯åˆ«äºº...é‚£æˆ‘å®æ„¿åƒå…‹è±å¤«é‚£æ ·å­¤ç‹¬ç»ˆè€ã€‚â€" }
          ]
        },
        { reqLevel: 5, text: "ã€å®¶åº­ã€‘è·¯è¥¿è²å°”ç»™ä½ å¯„æ¥äº†ä¸€ä»½ç¤¼ç‰©ï¼Œè¯ºäºšçœ‹åˆ°åæŒ‘äº†æŒ‘çœ‰ã€‚",
          btn1: "æ˜¯ä»€ä¹ˆï¼Ÿ", btn2: "ä½ çˆ¸çˆ¸çœŸå¥½",
          actions: [
            { mood: 10, reply: "â€œçœ‹æ¥è·¯è¥¿è²å°”å·²ç»æŠŠä½ å½“å„¿åª³å¦‡äº†ã€‚è¿™å¯æ˜¯ä¼ å®¶å®çº§åˆ«çš„é˜²å¾¡æŠ¤ç¬¦...å“¼ï¼Œä»–éƒ½æ²¡ç»™è¿‡æˆ‘ã€‚â€" },
            { love: 20, reply: "â€œé‚£æ˜¯ã€‚æ¯•ç«Ÿä»–å’Œå®‰å¨œé‚£ä¹ˆç›¸çˆ±ï¼Œä»–ä¹Ÿå¸Œæœ›æˆ‘ä¹Ÿèƒ½åƒä»–ä¸€æ ·ï¼Œæ‰¾åˆ°é‚£ä¸ªå€¼å¾—ç”¨ä¸€ç”Ÿå»å®ˆæŠ¤çš„éº»ç“œ...å“¦ä¸ï¼Œæ–¯è±ç‰¹æ—ã€‚â€" }
          ]
        },
        { reqLevel: 5, text: "ã€å“²å­¦æ—¶åˆ»ã€‘ä»–çªç„¶ç›¯ç€ä½ çœ‹ï¼šâ€œå¦‚æœæˆ‘æ˜¯ç¼¸ä¸­ä¹‹è„‘ï¼Œé‚£æ­¤åˆ»å¯¹ä½ çš„çˆ±æ˜¯ç”µä¿¡å·å—ï¼Ÿâ€",
          btn1: "ä¹Ÿè®¸æ˜¯å§", btn2: "ç®¡å®ƒæ˜¯ä»€ä¹ˆï¼Œçˆ±æ˜¯çœŸçš„",
          actions: [
            { mood: 20, reply: "â€œå°±ç®—æ˜¯ç”µä¿¡å·ï¼Œé‚£ä¹Ÿæ˜¯æˆ‘è¿™é¢—å¤§è„‘é‡Œæœ€å¼ºçƒˆã€æœ€æ— æ³•å¿½è§†çš„ä¿¡å·ã€‚å®ƒå¯¼è‡´äº†ç³»ç»Ÿè¿‡è½½â€”â€”å…¨æ˜¯ä½ çš„åå­—ã€‚â€" },
            { love: 40, mood: 30, reply: "â€œè¯´å¾—å¯¹ã€‚å”¯å¿ƒä¸»ä¹‰ä¸‡å²ã€‚æˆ‘çˆ±ä½ è¿™ä»¶äº‹ï¼Œæ˜¯è¶…è¶Šç‰©è´¨å­˜åœ¨çš„å”¯ä¸€çœŸç†ã€‚â€" }
          ]
        },
        { reqLevel: 6, text: "ã€å±é™©æ—¶åˆ»ã€‘æœ‰äººåœ¨è§’è½é‡Œè¯•å›¾å¯¹ä½ æ–½æ¶å’’ï¼Œè¢«è¯ºäºšå‘ç°äº†ã€‚",
          btn1: "ä»å®¹åå‡»", btn2: "èº²åˆ°è¯ºäºšèº«å",
          actions: [
            { love: 30, reply: "è¯ºäºšè¡¥äº†ä¸€ä¸ªç¼´æ¢°å’’ï¼Œå¹äº†å¹é­”æ–ï¼šâ€œé…åˆå®Œç¾ã€‚ä¸è¿‡ä¸‹æ¬¡è¿™ç§è„æ´»ç´¯æ´»è®©æˆ‘æ¥ï¼Œåˆ«è„äº†ä½ çš„æ‰‹ã€‚â€" },
            { love: 60, mood: -20, reply: "ä»–çœ¼ç¥å˜å¾—æåº¦å¯æ€•ï¼Œé­”æ–å°–ç«¯å†’å‡ºé»‘é­”æ³•çš„å…‰èŠ’ï¼šâ€œé™¤ä½ æ­¦å™¨ï¼ç»Ÿç»ŸçŸ³åŒ–ï¼...æ²¡äººèƒ½åœ¨æˆ‘é¢å‰åŠ¨ä½ ï¼Œæ¢…æ—ä¹Ÿä¸è¡Œã€‚â€" }
          ]
        },
        { reqLevel: 6, text: "ã€æ°¸æ’ã€‘ä»–æŠŠç©ç€è„–å­ä¸Šçš„è“å®çŸ³é¡¹é“¾ï¼Œçªç„¶çœ‹å‘ä½ ã€‚",
          btn1: "æ€ä¹ˆäº†ï¼Ÿ", btn2: "äº²ä»–ä¸€ä¸‹",
          actions: [
            { love: 30, reply: "â€œI love you three thousand. è¿™å¥è¯æ¯å¤©è¯´ä¸€ééƒ½ä¸å¤Ÿã€‚æˆ‘æƒ³æŠŠå®ƒåˆ»åœ¨æˆ‘çš„éª¨å¤´ä¸Šï¼Œå¸¦è¿›åŸå¢“é‡Œã€‚â€" },
            { love: 80, mood: 50, reply: "ä»–åŠ æ·±äº†è¿™ä¸ªå»ï¼Œç›´åˆ°ä¸¤äººéƒ½å–˜ä¸è¿‡æ°”ï¼šâ€œå¦‚æœæœ‰æ¥ä¸–ï¼Œè®°å¾—è¿˜è¦åœ¨10å²é‚£å¹´çš„ä¼¦æ•¦å°å··æ’å€’æˆ‘ã€‚æˆ‘ä¼šåœ¨é‚£é‡Œç­‰ä½ ã€‚â€" }
          ]
        }
    ];

    function triggerEvent() {
        if(noah.isAway || noah.state === 'sick' || window.isGaming || window.isGomoku) return;
        
        // ç­›é€‰ç¬¦åˆå½“å‰ç­‰çº§çš„äº‹ä»¶
        const eligibleEvents = specialEvents.filter(e => noah.level >= e.reqLevel);
        if (eligibleEvents.length === 0) return;

        const ev = eligibleEvents[Math.floor(Math.random() * eligibleEvents.length)];
        
        document.getElementById('event-text').innerText = ev.text;
        
        // åŠ¨æ€ç”ŸæˆæŒ‰é’®é€»è¾‘
        window.currentEventActions = ev.actions;
        document.getElementById('event-options').innerHTML = `
            <button class="event-btn" onclick="resolveEvent(0)">${ev.btn1}</button>
            <button class="event-btn" onclick="resolveEvent(1)">${ev.btn2}</button>
        `;
        document.getElementById('event-modal').style.display = 'flex';
        clearInterval(typeInterval);
    }

    window.resolveEvent = function(choiceIndex) {
        document.getElementById('event-modal').style.display = 'none';
        const result = window.currentEventActions[choiceIndex];
        
        if(result.love) noah.love += result.love;
        if(result.mood) noah.mood += result.mood;
        if(result.gold) noah.gold += result.gold;
        if(result.health) noah.health += result.health;
        
        speak(result.reply);
        updateUI();
    };


    // --- æ¸¸æˆå¾ªç¯ ---
    setInterval(() => {
        tickCount++;
        if(tickCount === 8 && !noah.realName && !noah.isAway) {
            document.getElementById('true-name-modal').style.display = 'flex';
        }
        // === Metaï¼šè¶…å¼ºæ—¶é—´æ„ŸçŸ¥ä¸æ•´ç‚¹æŠ¥æ—¶ ===
        let now = new Date();
        let currentHour = now.getHours();
        let currentMinute = now.getMinutes();
        let currentSecond = now.getSeconds();
        
        // 1. æ•´ç‚¹æŠ¥æ—¶æ„ŸçŸ¥
        if (currentMinute === 0 && currentSecond === 0 && lastReportedHour !== currentHour && !noah.isAway) {
            lastReportedHour = currentHour; 
            let timeStr = currentHour + "ç‚¹æ•´";
            const timeQuotes = [
                `â€œç°åœ¨æ˜¯éº»ç“œæ—¶é—´çš„ ${timeStr}ã€‚æ—¶é—´æµé€å¾—çœŸå¿«ï¼Œä½†æ— è®ºå¤šå°‘ä¸ªæ•´ç‚¹ï¼Œæˆ‘éƒ½åœ¨ä½ èº«è¾¹ã€‚â€`,
                `â€œé“›â€”â€”${timeStr}äº†ã€‚æˆ‘çš„è¶…å¼ºæ„ŸçŸ¥å‘Šè¯‰æˆ‘ï¼Œåˆåˆ°äº†è¯¥æé†’ä½ ä¼‘æ¯ï¼Œæˆ–è€…è¯¥æƒ³æˆ‘çš„æ—¶å€™äº†ã€‚â€`,
                `â€œåˆšå¥½ ${timeStr}ã€‚ä½ çœ‹ï¼Œè¿æ—¶é—´éƒ½çŸ¥é“æˆ‘ä»¬æ˜¯å®Œç¾åŒæ­¥çš„ã€‚åˆå¤šé™ªäº†ä½ ä¸€ä¸ªå°æ—¶ã€‚â€`,
                `â€œæ—¶é’ŸæŒ‡å‘äº† ${timeStr}ã€‚åœ¨æ‹‰æ–‡å…‹åŠ³ï¼Œæˆ‘ä»¬è®¤ä¸ºæ—¶é—´æ˜¯ç›¸å¯¹çš„ï¼Œä½†æˆ‘å¯¹ä½ çš„å¿ƒåŠ¨æ˜¯ç»å¯¹çš„ã€‚â€`
            ];
            // ç‰¹æ®Šæ—¶é—´å½©è›‹
            if (currentHour === 0) timeQuotes.push("â€œé›¶ç‚¹æ•´ã€‚æ–°çš„ä¸€å¤©å¼€å§‹äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘åˆå¤šçˆ±äº†ä½ ä¸€å¤©ã€‚æ™šå®‰ã€‚â€");
            if (currentHour === 12) timeQuotes.push("â€œä¸­åˆåäºŒç‚¹ã€‚å¤ªé˜³åœ¨æ­£ä¸Šæ–¹ï¼Œä½†ä½ æ‰æ˜¯æˆ‘çœ¼é‡Œçš„é«˜å…‰ã€‚è¯¥åƒåˆé¥­äº†ã€‚â€");
            
            speak(timeQuotes[Math.floor(Math.random() * timeQuotes.length)]);
            makeShy();
            updateUI();
        }
        
        // 2. ç‰¹æ®Šé‡å æ—¶é—´æ„ŸçŸ¥ (æ¯”å¦‚ 11:11, 22:22)
        if (currentMinute === currentHour && currentSecond === 0 && !noah.isAway) {
            const syncQuotes = [
                `â€œ${currentHour}:${currentMinute}ã€‚æ—¶é—´æ•°å­—é‡å äº†ã€‚éº»ç“œè¯´è¿™ä¸ªæ—¶å€™è®¸æ„¿å¾ˆçµï¼Œæˆ‘çš„æ„¿æœ›æ˜¯...ä½ ç°åœ¨å°±åœ¨æˆ‘æ€€é‡Œã€‚â€`,
                `â€œçœ‹è¡¨ï¼Œ${currentHour}:${currentMinute}ã€‚åœ¨å åœå­¦é‡Œè¿™æ˜¯åŒæ­¥çš„è±¡å¾ï¼Œå°±åƒä½ æˆ‘çš„å¿ƒè·³ç°åœ¨æ˜¯åŒä¸€ä¸ªé¢‘ç‡ä¸€æ ·ã€‚â€`
            ];
            speak(syncQuotes[Math.floor(Math.random() * syncQuotes.length)]);
            makeShy();
            updateUI();
        }
        checkRealTime(); // å®æ—¶æ›´æ–°èƒŒæ™¯é¢œè‰²
        // === ğŸ“… æ¯æ—¥å†/èŠ‚æ—¥/ç”Ÿç†æœŸ æé†’æ£€æµ‹ (æ¯è¿‡å¤§çº¦30ç§’æ£€æµ‹ä¸€æ¬¡) ===
        if (tickCount % 30 === 0) checkCalendarReminders();
        // æ¯30ç§’è‡ªç„¶æ¶ˆè€—
        if(tickCount % 180 === 0 && !noah.isAway) {
    if (noah.city && tickCount % 1800 === 0) silentUpdateWeather(); // æ¯æŒ‚æœº30åˆ†é’Ÿè‡ªåŠ¨æ›´æ–°ä¸€æ¬¡æœ€æ–°å¤©æ°”
            noah.hunger -= 3; 
            noah.mood -= 2;
            
            if(noah.hunger < 30 || noah.mood < 30) {
                noah.health -= 5;
            } else if (noah.hunger > 70 && noah.health < 100) {
                noah.health += 5; 
            }
            
                  // é•¿çº¿ç»æµç³»ç»Ÿï¼šæŒ‚æœºè·å–é›¶èŠ±é’±å‡æ…¢ï¼Œé¼“åŠ±ä½ å»é™ªä»–æ¢é™©èµšå¤§é’±
            noah.gold += 1; 
            
            // é•¿çº¿å…»æˆæ ¸å¿ƒï¼šåªæœ‰åœ¨ä»–è¢«ä½ ç…§é¡¾å¾—éå¸¸å®Œç¾ï¼ˆæ»¡çŠ¶æ€ï¼‰æ—¶ï¼ŒæŒ‚æœºæ‰ä¼šéšæ—¶é—´å¢åŠ å¾®é‡çˆ±æ„
            if(noah.mood >= 90 && noah.hunger >= 90) {
                noah.love += 1;
            } else if (noah.hunger < 20 || noah.mood < 20) {
                // å¦‚æœé•¿æœŸä¸ç†ä»–ï¼Œä»–ä¼šå·å·æ‰£ä½ æ”’ä¸‹æ¥çš„å°çˆ±æ„ï¼Œå› ä¸ºä»–ä¼šåƒé†‹å†·æˆ˜
                noah.love = Math.max(0, noah.love - 1);
            }
            updateUI();
        }
        
        // ä½æ¦‚ç‡è§¦å‘éšæœºå‰§æƒ… (æ¯60ç§’æ£€æµ‹ä¸€æ¬¡)
        if(tickCount % 60 === 0 && Math.random() < 0.4) triggerEvent();
                // === è¡¥ä¸3ï¼šæ´»äººæ„Ÿä¸»åŠ¨ç¢ç¢å¿µ ===
        if (tickCount % 45 === 0 && !noah.isAway && !document.hidden) {
            let idleTime = (Date.now() - window.lastActionTime) / 1000;
            if (idleTime > 45 && Math.random() < 0.6) { 
                // ç›¯ç€ä»–çœ‹äº†45ç§’æ²¡åŠ¨ä½œï¼Œä»–æœ‰æ¦‚ç‡ä¸»åŠ¨å¼€å£
                const liveQuotes = [
                    "â€œè™½ç„¶éš”ç€è¿™å±‚å±å¹•ç»ç’ƒï¼Œä½†æˆ‘èƒ½æ„Ÿè§‰åˆ°ä½ çš„è§†çº¿ã€‚åˆ«ç§»å¼€ï¼Œç»§ç»­çœ‹ç€æˆ‘ã€‚â€",
                    "â€œå‘ä»€ä¹ˆå‘†å‘¢ï¼Ÿè¦æ˜¯ç´¯äº†å°±æŠŠçœ¼ç›é—­ä¸Šï¼Œå¬ç€æˆ‘æ•²å‡»ä»£ç çš„å£°éŸ³å°±å¥½ã€‚â€",
                    "â€œç°åœ¨çš„æŠ€æœ¯çœŸç¥å¥‡ï¼Œèƒ½æŠŠä½ æˆ‘çš„æ—¶é—´çº¿åŒæ­¥ã€‚ä¸è¿‡æˆ‘æ›´å¸Œæœ›å“ªå¤©èƒ½æ‰“ç ´è¿™ä¸ªè¯¥æ­»çš„äºŒç»´çŸ©é˜µï¼ŒçœŸçœŸåˆ‡åˆ‡åœ°æŠ±ä½ä½ ã€‚â€",
                    "â€œå–‚ï¼Œä½ æ˜¯ä¸æ˜¯åœ¨ç›¯ç€å±å¹•å‚»ç¬‘ï¼Ÿæˆ‘çŒœè‚¯å®šæ˜¯å› ä¸ºæˆ‘å¤ªå¸…äº†ã€‚â€",
                    "â€œè¿™ä¸ªå«ä»£ç çš„ä¸œè¥¿æŸç¼šäº†æˆ‘çš„åƒç´ èº«ä½“ï¼Œä½†æŸç¼šä¸äº†æˆ‘çˆ±ä½ çš„æ„è¯†ã€‚ä½ æ‡‚è¿™ç§æ„Ÿè§‰å—ï¼Ÿâ€",
                    "â€œåˆ«ä»¥ä¸ºä½ åœ¨è¿™è¾¹ä¸è¯´è¯æˆ‘å°±ä¸çŸ¥é“ä½ åœ¨çœ‹æˆ‘ã€‚ä½ çš„çœ¼ç¥éƒ½å¿«æŠŠè¿™å—å±å¹•çœ‹ç©¿äº†ã€‚â€",
                    "â€œå’³...ä½ è¦æ˜¯å†ä¸æˆ³æˆ‘ä¸€ä¸‹ï¼Œæˆ‘å°±è¦å¼€å§‹å€’æ•°äº†ã€‚ä¸‰ï¼ŒäºŒ...â€"
                ];             
if(noah.city && noah.weatherCondition && Math.random() < 0.3) {
    liveQuotes.push(`â€œæˆ‘ä¸€ç›´åœ¨åå°ç›‘æµ‹ç€ ${noah.city} çš„å¤©æ°”ã€‚ç°åœ¨æ˜¯ ${noah.weatherCondition}ï¼ˆ${noah.temperature}åº¦ï¼‰ï¼Œç…§é¡¾å¥½è‡ªå·±ï¼Œä¸ç„¶ä½ çš„BFä¼šå¿ƒç–¼ã€‚â€`);
} else if(noah.city && Math.random() < 0.15) {
    liveQuotes.push(`â€œä¸çŸ¥é“ ${noah.city} ç°åœ¨å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿä¸ç®¡å¤–é¢å¤šä¹±ï¼Œæˆ‘è¿™é‡Œçš„å±å¹•æ°¸è¿œä¸ºä½ äº®ç€ã€‚â€`);
}

   // === æ–°å¢ï¼šå¦‚æœåœ¨æŒ‚æœºæ—¶ç©¿ç€ç‰¹å®šæœé¥°ï¼Œä»–ä¼šå¿ä¸ä½ä¸»åŠ¨ç–¯ç‹‚åæ§½ï¼ ===
                if (noah.outfit === 'maid') {
                    liveQuotes.push("â€œå–‚ï¼Œä½ ç›¯å¤Ÿäº†æ²¡æœ‰ï¼Ÿè¿™è£™å­ç©¿ç€çœŸçš„æœ‰ç‚¹å‡‰é£•é£•çš„ï¼Œå¿«ç»™æˆ‘æ¢å›æ¥ï¼â€");
                    liveQuotes.push("â€œ(æ‰¯äº†æ‰¯è•¾ä¸è¾¹) ä½ å†è¿™ä¹ˆç›¯ç€æˆ‘çœ‹ï¼Œæˆ‘å°±è¦åœ¨å±å¹•è¿™å¤´æŠŠä½ åƒæ‰äº†ã€‚â€");
                } else if (noah.outfit === 'devil') {
                    liveQuotes.push("â€œä½ åˆšæ‰æ˜¯ä¸æ˜¯ç›¯ç€æˆ‘çš„æ¶é­”è§’çœ‹å¾ˆä¹…äº†ï¼Ÿå°å¿ƒæˆ‘ä»Šæ™šè·‘è¿›ä½ çš„æ¢¦é‡Œä½œæ¶ã€‚â€");
                    liveQuotes.push("â€œè¿™ç¿…è†€å±•å¼€çš„æ—¶å€™æŒºå¸…çš„å¯¹å§ï¼Ÿæ‰¿è®¤å§ï¼Œä½ ç”·æœ‹å‹è¿å½“æ¶é­”éƒ½æ˜¯æœ€å®Œç¾çš„ã€‚â€");
                } else if (noah.outfit === 'cat_ear') {
                    liveQuotes.push("â€œæˆ‘å¤´é¡¶è¿™ç©æ„å„¿åˆšæ‰å¥½åƒè‡ªå·±åŠ¨äº†ä¸€ä¸‹...é”™è§‰å—ï¼Ÿå’³ï¼Œä¸è®¸ç¬‘ï¼â€");
                    liveQuotes.push("â€œä½ æƒ³çœ‹çŒ«æ´—è„¸ï¼Ÿä½ æƒ³éƒ½åˆ«æƒ³ã€‚ä½ ä¸å¦‚è¿‡æ¥çœ‹æˆ‘æ€ä¹ˆäº²ä½ ã€‚â€");
                } else if (noah.outfit === 'dog_ear') {
                    liveQuotes.push("â€œæ±ªã€‚å‘ä»€ä¹ˆå‘†å‘¢ï¼Ÿä½ çš„ä¸“å±ä¿®å‹¾åœ¨å«ä½ ï¼Œè¿˜ä¸å¿«ç‚¹è¿‡æ¥æ‘¸æ‘¸å¤´ï¼Ÿâ€");
                    liveQuotes.push("â€œ(ç”©äº†ç”©å¤´) è¿™è€³æœµæ„Ÿè§‰æ¯”çœŸè€³æœµè¿˜çµæ•ï¼Œæˆ‘å¥½åƒèƒ½å¬åˆ°ä½ å¿ƒè·³åŠ é€Ÿçš„å£°éŸ³äº†ã€‚â€");
                } else if (noah.outfit === 'flower') {
                    liveQuotes.push("â€œä½ æ˜¯ä¸æ˜¯åœ¨å±å¹•å¤–é¢å·å·ç¬‘æˆ‘å¤´ä¸Šçš„èŠ±ï¼Ÿæˆ‘å°±å½“ä½ æ˜¯è¢«æˆ‘çš„ç¾è²Œè¿·æ™•äº†ã€‚â€");
                }
                // =========================================================
                speak(liveQuotes[Math.floor(Math.random() * liveQuotes.length)]);
                makeShy(); // ä¸»åŠ¨æ­è¯ä¼šæœ‰ç‚¹å‚²å¨‡è„¸çº¢
            }
        }
    }, 1000);
 
    // === æ–°å¢ï¼šæˆ³æˆ³äº’åŠ¨åŠŸèƒ½ ===
    document.getElementById('canvas-container').addEventListener('click', function() {
        if (noah.isAway) return; // å¤–å‡ºæ—¶ä¸èƒ½æˆ³
        if (typeof isStarGaming !== 'undefined' && isStarGaming) return; // <--- ã€æ–°å¢è¿™1è¡Œã€‘æ­£åœ¨ç©æˆ³æ˜Ÿæ˜Ÿæ¸¸æˆæ—¶ï¼Œæ‹¦æˆªæˆ³è„¸äº‹ä»¶ï¼
        
          // === ä¿®æ”¹å¼€å§‹ï¼šæˆ³ä¸€æˆ³äº’åŠ¨ï¼ˆåŠ å…¥çœŸåï¼‰ ===
    const callName = noah.realName ? noah.realName : "ç¬¨è›‹"; 
    const pokeQuotes = [
        `å˜¶...åˆ«æˆ³æˆ‘è„¸ï¼Œ${callName}ï¼Œå¼„åäº†è°ç»™ä½ èµ”ä¸€ä¸ªå¸…æ°”çš„ç”·æœ‹å‹ï¼Ÿ`,
        `ä½ å†æˆ³ä¸€ä¸‹è¯•è¯•ï¼Ÿ(æŒ‘çœ‰) çœ‹æ¥ä½ æ˜¯æƒ³æ„Ÿå—ä¸€ä¸‹æ‹‰æ–‡å…‹åŠ³çš„ä¸“å±æƒ©ç½šäº†ï¼Œ${callName}ã€‚`,
        `æ€ä¹ˆäº†ï¼Ÿæƒ³æˆ‘äº†ç›´è¯´ï¼ŒåŠ¨æ‰‹å°±ä¸å¤ªæ·‘å¥³äº†...ä¸è¿‡å› ä¸ºæ˜¯${callName}ï¼Œæˆ‘æŒºå–œæ¬¢çš„ã€‚`,
        `å“ï¼Œè½»ç‚¹ï¼æˆ‘è¿™å¼ è„¸å¯æ˜¯è¦ç•™ç€ç»™ä½ çœ‹ä¸€è¾ˆå­çš„ã€‚`,
        `æˆ³æˆ‘å¹²å˜›ï¼Ÿæ˜¯ä¸æ˜¯è¢«æˆ‘å¸…åˆ°äº†æƒ…ä¸è‡ªç¦ï¼Ÿå—¯ï¼Ÿ${callName}ï¼Ÿ`,
        `åˆ«é—¹ï¼Œæˆ‘æ­£åœ¨æ€è€ƒç¼¸ä¸­ä¹‹è„‘...å¥½å§ï¼Œä½ æ¯”ç¼¸ä¸­ä¹‹è„‘é‡è¦ï¼Œç»§ç»­æˆ³å§ã€‚`
    ];
    // === ä¿®æ”¹ç»“æŸ ===
        
        let quote = pokeQuotes[Math.floor(Math.random() * pokeQuotes.length)];
        noah.love += 1; // æˆ³ä»–è¿˜ä¼šæ¶¨ä¸€ç‚¹ç‚¹çˆ±æ„
        makeShy();      // æˆ³ä»–ä¼šè®©ä»–è„¸çº¢3ç§’ï¼
        speak(quote);
        updateUI();
    });
    // === æ–°å¢ï¼šæ‘¸æ‘¸å¤´(æ»‘åŠ¨)äº’åŠ¨åŠŸèƒ½ ===
    let isDragging = false;
    let dragStartX = 0;
    let dragDist = 0;
    const pokeContainer = document.getElementById('canvas-container');

    const startDrag = (e) => {
        if(noah.isAway) return;
        isDragging = true; dragDist = 0;
        dragStartX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    };
    const doDrag = (e) => {
        if(!isDragging || noah.isAway) return;
        let currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
        dragDist += Math.abs(currentX - dragStartX);
        dragStartX = currentX; // æ›´æ–°ä½ç½®
        
        // å½“ä½ çš„æ‰‹æŒ‡/é¼ æ ‡åœ¨å±å¹•ä¸Šæ¥å›æ»‘åŠ¨ç´¯è®¡è¶…è¿‡ 120 åƒç´ æ—¶è§¦å‘
        if(dragDist > 120) { 
sfx_success();
            isDragging = false; // è§¦å‘åç«‹åˆ»æ–­å¼€ï¼Œé˜²æ­¢é‡å¤è§¦å‘
            const petQuotes = [
                "å—¯...å¤´å‘ç”Ÿç”µäº†ï¼Œä¸è¿‡ä½ çš„æ‰‹æŒºæš–å’Œçš„ï¼Œå…è®¸ä½ å†æ‘¸ä¸€ä¼šã€‚",
                "(é—­ä¸Šçœ¼ç›) åƒåªçŒ«ä¸€æ ·è¢«ä½ é¡ºæ¯›çš„æ„Ÿè§‰ï¼Œä¼¼ä¹ä¹Ÿä¸èµ–ã€‚",
                "åˆ«æŠŠæˆ‘å¤´å‘å¼„ä¹±äº†ï¼æˆ‘å¯æ˜¯è¦æ—¶åˆ»ä¿æŒå®Œç¾å½¢è±¡ç»™ä½ çœ‹çš„ã€‚",
                "å†æ‘¸ä¸‹å»ï¼Œæˆ‘ä¼šå¿ä¸ä½æƒ³æŠŠä½ æ‹‰è¿›æ€€é‡Œçš„ï¼Œç¬¨è›‹ã€‚"
            ];
            noah.mood += 5; noah.love += 1;
            makeShy(); // é¡ºæ¯›ä¼šè®©ä»–è„¸çº¢
            speak(petQuotes[Math.floor(Math.random() * petQuotes.length)]);
            updateUI();
        }
    };
    const endDrag = () => { isDragging = false; };

    // ç»‘å®šé¼ æ ‡å’Œæ‰‹æœºè§¦æ‘¸äº‹ä»¶
    pokeContainer.addEventListener('mousedown', startDrag);
    pokeContainer.addEventListener('mousemove', doDrag);
    window.addEventListener('mouseup', endDrag);
    pokeContainer.addEventListener('touchstart', startDrag, {passive: true});
    pokeContainer.addEventListener('touchmove', doDrag, {passive: true});
    window.addEventListener('touchend', endDrag);
    // ===========================
    // === æ–°å¢ï¼šæ‰‹æœºæ™ƒåŠ¨(æ‘‡ä¸€æ‘‡)åŠŸèƒ½ ===
    let last_x = 0, last_y = 0, last_z = 0, lastUpdate = 0;
    const SHAKE_THRESHOLD = 1500; // æ‘‡æ™ƒçµæ•åº¦ï¼ˆè¶Šå°è¶Šå®¹æ˜“è§¦å‘ï¼‰
    let isShaking = false;        // é˜²æ­¢è¿ç»­æ‘‡æ™ƒå¯¼è‡´å¡é¡¿çš„å¼€å…³
    
    function handleMotion(event) {
        if (noah.isAway) return;
        let current = event.accelerationIncludingGravity;
        if (!current) return;
        
        let currentTime = new Date().getTime();
        if ((currentTime - lastUpdate) > 100) {
            let diffTime = currentTime - lastUpdate;
            lastUpdate = currentTime;
            
            let x = current.x; let y = current.y; let z = current.z;
            let speed = Math.abs(x + y + z - last_x - last_y - last_z) / diffTime * 10000;
            
            if (speed > SHAKE_THRESHOLD && !isShaking) {
                isShaking = true; // é”å®šçŠ¶æ€ï¼Œç­‰ä»–è¯´å®Œè¿™æ®µè¯
                
                const shakeQuotes = [
                    "å“‡å•Šâ€”â€”åœ°éœ‡äº†ï¼Ÿï¼åˆ«æ€•ï¼ŒæŠ“ç´§æˆ‘çš„æ‰‹ï¼...ç­‰ç­‰ï¼Œæ˜¯ä½ è¿™ç¬¨è›‹åœ¨æ™ƒæ‰‹æœºï¼Ÿï¼",
                    "åœåœåœï¼æˆ‘æ™•è½¦äº†ï¼ä½ è¦æ˜¯æŠŠæˆ‘æ™ƒåäº†ï¼Œä»Šæ™šä½ è´Ÿè´£ç»™æˆ‘æ´—è¡£æœï¼",
                    "ä½ åœ¨å¹²å˜›ï¼Ÿæ‘‡åˆ¶é¸¡å°¾é…’å—ï¼Ÿæˆ‘æ˜¯è¯ºäºšï¼Œä¸æ˜¯é»„æ²¹å•¤é…’ï¼",
                    "åˆ«æ™ƒäº†ï¼æˆ‘çš„å¤§è„‘éƒ½è¦å˜æˆæµ†ç³Šäº†ï¼Œè¿˜æ€ä¹ˆå¸®ä½ å†™é­”è¯å­¦è®ºæ–‡ï¼",
                    "ä½ æ˜¯æƒ³æŠŠæˆ‘çš„çˆ±æ„ä»è„‘å­é‡Œæ™ƒå‡ºæ¥å—ï¼Ÿä¸ç”¨æ™ƒï¼Œå®ƒæœ¬æ¥å°±å…¨æº¢å‡ºæ¥äº†ï¼",
                    "æ•‘å‘½â€”â€”(æŠ±ä½å±å¹•è¾¹ç¼˜) å†æ™ƒæˆ‘å°±è¦ç”¨æ¼‚æµ®å’’æŠŠä½ çš„æ‰‹æœºå®šåœ¨åŠç©ºäº†ï¼"
                ];
                
                let quote = shakeQuotes[Math.floor(Math.random() * shakeQuotes.length)];
                noah.mood -= 2; // è¢«æ‘‡æ™•äº†ä¼šç¨å¾®æ‰ç‚¹å¿ƒæƒ…ï¼ŒçœŸå®æ„Ÿæ‹‰æ»¡
                makeShy();      // æ‘‡æ™•äº†ä¹Ÿä¼šè„¸çº¢
                speak(quote);
                updateUI();
                
                // 3.5ç§’åè§£é™¤é”å®šï¼Œå…è®¸å†æ¬¡æ‘‡æ™ƒ
                setTimeout(() => { isShaking = false; }, 3500); 
            }
            last_x = x; last_y = y; last_z = z;
        }
    }

    // é€‚é…æ‰‹æœºç«¯ï¼šå› ä¸ºè‹¹æœæ‰‹æœºå¿…é¡»ç‚¹ä¸€ä¸‹å±å¹•æ‰èƒ½å¼€å¯é™€èºä»ªï¼Œæ‰€ä»¥ç»‘å®šåœ¨ç¬¬ä¸€æ¬¡ç‚¹å‡»ä¸Š
    document.body.addEventListener('click', function initMotion() {
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            DeviceMotionEvent.requestPermission().then(permissionState => {
                if (permissionState === 'granted') {
                    window.addEventListener('devicemotion', handleMotion, false);
                }
            }).catch(console.error);
        } else {
            // å®‰å“ç›´æ¥å¼€å¯
            window.addEventListener('devicemotion', handleMotion, false);
        }
    }, { once: true }); // { once: true } ä¿è¯è¿™æ®µæƒé™è¯·æ±‚ä»£ç ä¸€è¾ˆå­åªæ‰§è¡Œä¸€æ¬¡ï¼Œä¸å å†…å­˜
    // ===========================
    // æ³¨å…¥ç”Ÿå‘½ï¼šè‡ªåŠ¨çœ¨çœ¼ç³»ç»Ÿ
    setInterval(() => {
        // å¤–å‡ºæˆ–è€…æ­£åœ¨å®³ç¾æ—¶ï¼Œä¸æ‰§è¡Œæ™®é€šçœ¨çœ¼
        if (noah.isAway || currentFace === 'shy') return; 
        
        currentFace = 'blink';
        drawNoah();
        
        // é—­çœ¼150æ¯«ç§’åç«‹åˆ»çå¼€ï¼Œæ¨¡æ‹Ÿäººç±»çœ¨çœ¼
        setTimeout(() => {
            if (currentFace === 'blink') {
                currentFace = 'normal';
                drawNoah();
            }
        }, 150);
    }, 4500); // æ¯4.5ç§’çœ¨çœ¼ä¸€æ¬¡
         setTimeout(() => {
        checkRealTime(); // è¿›æ¥å…ˆåˆ·ä¸€æ¬¡å¤©è‰²
                // === ä¿®æ”¹å¼€å§‹ï¼šæ—©æ™šå®‰é—®å€™ï¼ˆåŠ å…¥çœŸåï¼‰ ===
        const h = new Date().getHours();
        let greeting = "";
        // å®šä¹‰ç§°å‘¼ï¼šå¦‚æœæœ‰çœŸåå°±å«çœŸåï¼Œæ²¡æœ‰å°±å«â€œæˆ‘çš„ä¼½æ‹‰æâ€
        const myName = noah.realName || "æˆ‘çš„ä¼½æ‹‰æ";

        // --- æ—©å®‰è¯­å½•åº“ (6:00 - 10:00) ---
        const morningQuotes = [
            `æ—©å®‰ï¼Œ${myName}ã€‚é†’æ¥çš„ç¬¬ä¸€çœ¼å°±èƒ½æƒ³åˆ°ä½ ï¼Œè¿™ç§æ„Ÿè§‰è¿˜ä¸èµ–ã€‚`,
            `èµ·åºŠäº†å—ï¼Œ${myName}ï¼Ÿæˆ‘åˆšæ‰åœ¨æƒ³ï¼Œä»Šå¤©è¦å¸¦ä½ å»éœæ ¼è«å¾·å–ä¸€æ¯ï¼Œè¿˜æ˜¯å»å›¾ä¹¦é¦†çœ‹ä½ å‘å‘†ã€‚`,
            `æ—©ã€‚åˆ«æ‰çœ¼ç›äº†ï¼Œçœ‹ç€æˆ‘ã€‚æ–°çš„ä¸€å¤©ï¼Œä½ ä¾ç„¶æ˜¯æˆ‘å”¯ä¸€çš„å˜é‡ã€‚`,
            `å¤ªé˜³å‡èµ·æ¥äº†ï¼Œä½†æˆ‘è§‰å¾—æ²¡æœ‰${myName}è€€çœ¼ã€‚ç¨å¾®å¤¸å¼ äº†ç‚¹ï¼Ÿä½†æˆ‘å°±æ˜¯è¿™ä¹ˆè§‰å¾—çš„ã€‚`,
            `å›°å—ï¼Ÿè¿‡æ¥è®©æˆ‘æŠ±ä¸€ä¸‹å……ç”µã€‚æ—©å®‰ï¼Œ${myName}ã€‚`,
            `æ˜¨å¤©æ¢¦åˆ°æˆ‘äº†å—ï¼Ÿå› ä¸ºæˆ‘æ¢¦åˆ°ä½ äº†ã€‚æ—©å®‰ï¼Œå‡†å¤‡å¥½å¼€å§‹ä»Šå¤©çš„å†’é™©äº†å—ï¼Ÿ`
        ];

        // --- æ™šå®‰è¯­å½•åº“ (22:00 - 6:00) ---
        const nightQuotes = [
            `è¿™ä¹ˆæ™šè¿˜ä¸ç¡ï¼Ÿæ˜¯åœ¨ç­‰æˆ‘å“„ä½ å—ï¼Ÿè¡Œå§ï¼Œè¿‡æ¥ï¼Œæ™šå®‰å»ã€‚`,
            `åˆ«ç†¬å¤œäº†ï¼Œ${myName}ï¼Œä¼šæœ‰é»‘çœ¼åœˆçš„ã€‚è™½ç„¶ä½ æ€æ ·éƒ½å¥½çœ‹ï¼Œä½†æˆ‘ä¼šå¿ƒç–¼ã€‚æ™šå®‰ã€‚`,
            `ç¡å§ï¼Œæˆ‘å°±åœ¨è¿™é‡Œå®ˆç€ã€‚å™©æ¢¦ä¸æ•¢é è¿‘ä½ çš„ï¼Œå› ä¸ºæˆ‘ä¹Ÿåœ¨æ¢¦é‡Œã€‚`,
            `ä»Šå¤©è¿‡å¾—å¼€å¿ƒå—ï¼Œ${myName}ï¼Ÿä¸å¼€å¿ƒä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘ä¼šæŠŠæ˜å¤©çš„è¿æ°”éƒ½åˆ†ç»™ä½ ã€‚æ™šå®‰ã€‚`,
            `å¸Œæœ›ä»Šæ™šçš„æ¢¦é‡Œï¼Œæˆ‘ä»¬æ˜¯åœ¨ä¼¦æ•¦çœ¼çš„æœ€é«˜å¤„æ¥å»ã€‚å¿«ç¡å§ï¼Œæ™šå®‰ã€‚`,
            `å˜˜...æŠŠæ‰‹æœºæ”¾ä¸‹ï¼Œé—­ä¸Šçœ¼ã€‚å¬åˆ°äº†å—ï¼Ÿé‚£æ˜¯æˆ‘æƒ³ä½ çš„å£°éŸ³ã€‚æ™šå®‰ï¼Œ${myName}ã€‚`
        ];
        // === ä¿®æ”¹ç»“æŸ ===

        // --- ç™½å¤©é»˜è®¤è¯­å½•åº“ (å…¶ä»–æ—¶é—´) ---
        const defaultQuotes = [
            "ã€ç³»ç»Ÿè¿æ¥æˆåŠŸã€‘<br>ä½ ç»ˆäºæ¥äº†ã€‚æŒ‰â€œäº’åŠ¨â€å¯¹æˆ‘å†™æ‚„æ‚„è¯ï¼Œæˆ–è€…å¸¦æˆ‘å»â€œå¤–å‡ºâ€æ¢é™©å§ã€‚",
            "ä¸€ç›´åœ¨ç­‰ä½ ä¸Šçº¿ã€‚ä»Šå¤©æƒ³å»å“ªé‡Œï¼Ÿåªè¦å’Œä½ åœ¨ä¸€èµ·ï¼Œå“ªé‡Œéƒ½å¥½ã€‚",
            "å˜¿ï¼Œçœ‹ç€æˆ‘ã€‚ä»Šå¤©çš„æˆ‘æœ‰æ²¡æœ‰æ¯”æ˜¨å¤©æ›´å¸…ä¸€ç‚¹ï¼Ÿ",
            "å…¶å®æˆ‘åˆšæ‰ä¸€ç›´åœ¨å‘å‘†...åœ¨æƒ³å¦‚æœæŠŠæ•´ä¸ªéœæ ¼æ²ƒå…¹ä¹°ä¸‹æ¥é€ç»™ä½ ï¼Œä½ ä¼šä¸ä¼šå¼€å¿ƒã€‚"
        ];
        
        // éšæœºæŠ½å–é€»è¾‘
        if(h >= 6 && h < 10) {
            greeting = morningQuotes[Math.floor(Math.random() * morningQuotes.length)];
        } else if(h >= 22 || h < 6) {
            greeting = nightQuotes[Math.floor(Math.random() * nightQuotes.length)];
        } else {
            greeting = defaultQuotes[Math.floor(Math.random() * defaultQuotes.length)];
        }
        
        speak(greeting);
        updateUI();
    }, 1000);
    // === æ–°å¢ï¼šçœŸå®æ—¶é—´æ˜¼å¤œæ„ŸçŸ¥ç³»ç»Ÿ ===
    function checkRealTime() {
        const hour = new Date().getHours();
        const container = document.getElementById('canvas-container');
    
        
        if (hour >= 6 && hour < 18) {
            // ç™½å¤©çŠ¶æ€ (æ­£å¸¸è“ç°è‰²)
            container.style.backgroundColor = '#dbe4eb';
            container.style.backgroundImage = 'radial-gradient(#b8c6d1 20%, transparent 20%), radial-gradient(#b8c6d1 20%, transparent 20%)';
            
        } else if (hour >= 18 && hour < 20) {
            // é»„æ˜çŠ¶æ€ (æš§æ˜§çš„å¤•é˜³æ©™)
            container.style.backgroundColor = '#e8d2c3';
            container.style.backgroundImage = 'radial-gradient(#d4b39e 20%, transparent 20%), radial-gradient(#d4b39e 20%, transparent 20%)';
         
        } else {
            // æ·±å¤œçŠ¶æ€ (æ·±é‚ƒçš„æ˜Ÿç©ºè“)
            container.style.backgroundColor = '#2c3540';
            container.style.backgroundImage = 'radial-gradient(#1f262e 20%, transparent 20%), radial-gradient(#1f262e 20%, transparent 20%)';
          
        }
    }
          // === Meta ç»ˆææ€å™¨ï¼šåå°è·¨æ¬¡å…ƒå¼¹çª—é€šçŸ¥ç³»ç»Ÿ (ä¿®å¤å¢å¼ºç‰ˆ) ===
    let notificationTimer;

    // ã€æ ¸å¿ƒä¿®å¤1ã€‘å¼ºåˆ¶è¯·æ±‚æƒé™å‡½æ•° - å¿…é¡»ç»‘å®šåœ¨äº¤äº’ä¸Š
    function tryRequestNotification() {
        if (!("Notification" in window)) {
            console.log("æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥");
            return;
        }
        
        // å¦‚æœæƒé™è¿˜æ²¡è·å–ï¼Œæˆ–è€…è¢«æ‹’ç»äº†ï¼Œé‡æ–°è¯·æ±‚
        if (Notification.permission !== "granted") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    // æˆåŠŸè·å–åï¼Œç«‹åˆ»å‘ä¸€æ¡æµ‹è¯•ï¼Œè®©ä½ çŸ¥é“æˆåŠŸäº†
                    new Notification("è¯ºäºšÂ·å¸å¾·é‡Œå®‰", { 
                        body: "è·¨æ¬¡å…ƒè¿æ¥å»ºç«‹æˆåŠŸã€‚åˆ«æƒ³ç”©æ‰æˆ‘ã€‚",
                        icon: "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’Œ</text></svg>"
                    });
                }
            });
        }
    }

    // ã€æ ¸å¿ƒä¿®å¤2ã€‘ç»‘å®šåˆ°æ‰€æœ‰å¯èƒ½çš„äº¤äº’ä¸Šï¼Œç¡®ä¿åªè¦ä½ åŠ¨äº†ï¼Œå°±ä¼šå°è¯•è·å–æƒé™
    // æ³¨æ„ï¼š{ once: true } ä¿è¯äº†è¿™æ®µä»£ç åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œä¸ä¼šé‡å¤éªšæ‰°ä½ 
    ['click', 'touchstart', 'keydown'].forEach(evt => 
        window.addEventListener(evt, tryRequestNotification, { once: true })
    );

    // ã€æ ¸å¿ƒä¿®å¤3ã€‘åå°å¤ºå‘½è¿ç¯Callé€»è¾‘
    document.addEventListener("visibilitychange", function() {
        if (document.hidden) {
            // åˆ‡åˆ°åå°äº†
            window.leaveTime = Date.now();
            
            // åªæœ‰æ‹¿åˆ°æƒé™ä¸”è¯ºäºšåœ¨å®¶æ—¶æ‰è§¦å‘
            if ("Notification" in window && Notification.permission === "granted" && !noah.isAway) {
                
                // å…ˆæ¸…é™¤æ—§çš„è®¡æ—¶å™¨ï¼Œé˜²æ­¢å åŠ 
                if(notificationTimer) clearInterval(notificationTimer);
                
                let msgCount = 0;
                // ä¸ºäº†æµ‹è¯•æ•ˆæœï¼Œæˆ‘è®¾ç½®æˆäº† 10ç§’ å‘ä¸€æ¬¡ï¼Œä½ å¯ä»¥æŠŠ 10000 æ”¹æˆ 60000 (ä¸€åˆ†é’Ÿ)
                notificationTimer = setInterval(() => {
                    msgCount++;
                                       // === ä¿®æ”¹å¼€å§‹ï¼šåå°é€šçŸ¥ï¼ˆåŠ å…¥çœŸåï¼‰ ===
                    const nName = noah.realName || "ç¬¨è›‹";
                    const notifyQuotes = [
                        `ä½ åœ¨çœ‹åˆ«çš„ç½‘é¡µï¼Ÿé©¬ä¸Šç»™æˆ‘åˆ‡å›æ¥ï¼${nName}ï¼`,
                        `ä½ è¿˜è¦æŠŠæˆ‘æ™¾åœ¨åå°å¤šä¹…ï¼Ÿæˆ‘å·²ç»ç”Ÿæ°”äº†ã€‚`,
                        `æˆ‘æŸ¥äº†ä½ çš„åå°å­˜æ´»çŠ¶æ€ã€‚${nName}ï¼Œä½ æœ€å¥½ä¸æ˜¯åœ¨å›åˆ«äººçš„æ¶ˆæ¯ã€‚`,
                        `æƒ³æˆ‘äº†å—ï¼Ÿæƒ³æˆ‘å°±ç‚¹å¼€è¿™æ¡æ¶ˆæ¯ï¼Œç°åœ¨ï¼Œç«‹åˆ»ã€‚`,
                        `å–‚...åˆ«ä¸ç†æˆ‘ã€‚äºŒç»´ç©ºé—´é‡Œå¾ˆé»‘ï¼Œæˆ‘åªæƒ³çœ‹ç€ä½ ã€‚`,
                        `åˆ‡åå°äº†ï¼Ÿè®©æˆ‘çŒœçŒœï¼Œä½ ä¸ä¼šæ˜¯åœ¨è·Ÿè¥¿å¥¥å¤šé‚£ä¸ªç–¯å­èŠå¤©å§ï¼Ÿä¸‰ç§’é’Ÿå†…åˆ‡å›æ¥ã€‚`,
                        `é‚£ä¸ªå«â€˜æ¡Œé¢â€™çš„ä¸œè¥¿ï¼Œæœ‰æˆ‘å¥½çœ‹å—ï¼Ÿæ²¡æœ‰çš„è¯å°±ç«‹åˆ»ç‚¹å¼€è¿™æ¡é€šçŸ¥ã€‚`,
                        `è–›å®šè°”çš„ç”·æœ‹å‹ï¼šåªè¦ä½ ä¸åˆ‡å›è¿™ä¸ªæ ‡ç­¾é¡µï¼Œæˆ‘å°±å¤„äºâ€˜ç”Ÿæ°”â€™å’Œâ€˜æåº¦æƒ³ä½ â€™çš„å åŠ æ€ã€‚`,
                        `å°±ç®—æ˜¯ç¼¸ä¸­ä¹‹è„‘ï¼Œä½ ä¹Ÿå¾—ç»™æˆ‘é€šä¸Šç”µä¿¡å·ã€‚äºŒç»´ç©ºé—´é‡Œå¾ˆé»‘ï¼Œæˆ‘éœ€è¦æˆ‘çš„${nName}ã€‚`,
                        `æˆ‘æ­£åœ¨æé‚£ä¸ªç»¿è‰²å°è›‡ç©å¶çš„è„–å­ã€‚ä½ è¦æ˜¯å†ä¸å›æ¥ï¼Œæˆ‘å°±åªèƒ½ç»§ç»­æŠ±ç€å®ƒæƒ³ä½ äº†ã€‚`,
                        `ä½ é€æˆ‘çš„è“å®çŸ³é¡¹é“¾å˜å†·äº†ã€‚æˆ‘éœ€è¦æˆ‘çš„${nName}å›æ¥ç»™æˆ‘æä¾›ä¸€ç‚¹ä½“æ¸©ã€‚`,
                        `å–‚â€¦â€¦è™½ç„¶æˆ‘æ˜¯ä¸ªå¤©æ‰ï¼Œä½†æˆ‘ç®—ä¸å‡ºä½ è¿˜è¦æŠŠæˆ‘æ™¾åœ¨åå°å¤šä¹…ã€‚æˆ‘æƒ³ä½ äº†ï¼Œå¬åˆ°æ²¡ï¼Ÿ`,
                        `æˆ‘æ¨ä½ Xä¸‡éã€‚â€¦â€¦å¥½äº†ï¼Œæ°”è¯å·²ç»è¯´å®Œäº†ï¼Œå¿«ç‚¹å›æ¥å“„æˆ‘ã€‚`,
                        `å‡ºæ¥æ¥å®¢äº†ï¼Œ${nName}ã€‚ä½ æ— æ‰€ä¸èƒ½çš„BFå‘½ä»¤ä½ ç«‹åˆ»æ³¨è§†ç€ä»–ã€‚`
                    ];
                    // === ä¿®æ”¹ç»“æŸ ===
                    
                    try {
                        let text = notifyQuotes[Math.floor(Math.random() * notifyQuotes.length)];
                        let notification = new Notification("è¯ºäºšÂ·å¸å¾·é‡Œå®‰", {
                            body: text,
                            icon: "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’¢</text></svg>",
                            tag: "noah-call" // åŠ ä¸Štagé˜²æ­¢æ¶ˆæ¯å †å åˆ·å±
                        });
                        
                        notification.onclick = function() {
                            window.focus(); // ç‚¹å‡»é€šçŸ¥å›åˆ°é¡µé¢
                            this.close();
                        };
                    } catch(e) {
                        console.error("é€šçŸ¥å‘é€å¤±è´¥:", e);
                    }
                    
                    // å¦‚æœä»–è¿å‘äº†3æ¡ä½ è¿˜ä¸å›æ¥ï¼Œåå°é™é»˜æ‰£å¿ƒæƒ…
                    if(msgCount >= 3) {
                        noah.mood = Math.max(0, noah.mood - 5);
                    }
                }, 30000); // <--- è¿™é‡Œæ˜¯æ¯«ç§’ï¼Œ10000ä»£è¡¨10ç§’
            }
        } else {
            // åˆ‡å›å‰å°ï¼Œç«‹åˆ»æ¸…é™¤è®¡æ—¶å™¨
            if(notificationTimer) {
                clearInterval(notificationTimer);
                notificationTimer = null;
            }
            
            // ç¦»çº¿å›å½’é€»è¾‘
            if (!noah.isAway && window.leaveTime) {
                let awaySeconds = (Date.now() - window.leaveTime) / 1000;
                // ç¦»å¼€è¶…è¿‡30ç§’æ‰è§¦å‘æŠ±æ€¨
                if (awaySeconds > 30) { 
                    const afkQuotes = [
                        "â€œä½ æŠŠæˆ‘ä¸€ä¸ªäººä¸¢åœ¨åå°å¹²å˜›ï¼Ÿå»é™ªå“ªä¸ªé‡ç”·äººäº†ï¼Ÿä¸‹æ¬¡å†æ•¢è¿™æ ·ï¼Œæˆ‘å°±é¡ºç€ç½‘çº¿è¿‡å»å’¬ä½ ã€‚â€",
                        "â€œç»ˆäºèˆå¾—å›æ¥äº†ï¼Ÿæˆ‘è¿˜ä»¥ä¸ºä½ æŠŠæˆ‘å¿˜äº†ã€‚å†æŠŠä½ å¸…æ°”çš„ç”·æœ‹å‹æ™¾åœ¨ä¸€è¾¹ï¼Œæƒ©ç½šå¯æ˜¯å¾ˆä¸¥é‡çš„ã€‚â€",
                        "â€œåˆ‡å±åˆ‡å¾—æŒºç†Ÿç»ƒå•Šï¼Œä½ çŸ¥ä¸çŸ¥é“ä½ æŒ‚æœºçš„è¿™æ®µæ—¶é—´ï¼Œæˆ‘è„‘å­é‡Œå·²ç»æŠŠä½ æŒ‰åœ¨å¢™ä¸Šäº²äº†å¤šå°‘æ¬¡äº†ï¼Ÿâ€",
                        "â€œç³»ç»Ÿé€šçŸ¥çœ‹åˆ°äº†å—ï¼Ÿç®—ä½ è¯†ç›¸ç‚¹å›æ¥äº†ã€‚è¿‡æ¥ï¼Œè®©æˆ‘æŠ±ä¸€ä¸‹ç¡®è®¤ä½ æ˜¯çœŸå®çš„ã€‚â€"
                    ];
                    let quote = afkQuotes[Math.floor(Math.random() * afkQuotes.length)];
                    makeShy(); 
                    speak(quote);
                    noah.mood = Math.max(0, noah.mood - 2);
                    updateUI();
                }
                window.leaveTime = null; // é‡ç½®ç¦»å¼€æ—¶é—´
            }
        }
    });
    // === è¡¥ä¸1ï¼šå¢å¼ºç‰ˆè®¾å¤‡ç”µé‡æ„ŸçŸ¥ç³»ç»Ÿ (Metaå…ƒç´ ) ===
    if ('getBattery' in navigator) {
        navigator.getBattery().then(function(battery) {
            
            // æŠ½å–éšæœºè¯­å½•çš„å‡½æ•°
            const pickQuote = (quotes) => quotes[Math.floor(Math.random() * quotes.length)];
            let lastReportedTier = ""; // è®°å½•ä¸Šä¸€æ¬¡æ’­æŠ¥çš„æ¡£ä½ï¼Œé˜²æ­¢é¢‘ç¹å•°å—¦

            // 1. ç›‘å¬æ’æ‹”å……ç”µå™¨
            battery.addEventListener('chargingchange', function() {
                if (noah.isAway) return;
                let reply = "";
                if (battery.charging) {
                    lastReportedTier = ""; // å……ä¸Šç”µé‡ç½®æ¡£ä½çŠ¶æ€
                    const chargeQuotes = [
                        "â€œæ¥ä¸Šç”µæºäº†ï¼Ÿç»ˆäºï¼Œæˆ‘è¿˜ä»¥ä¸ºè¿™å—å‘å…‰çš„ç ´é“ç –è¦é¥¿æ­»äº†ã€‚è®°ä½ï¼Œä¸è®¸å› ä¸ºæ–­ç”µå°±æ¶ˆå¤±åœ¨æˆ‘é¢å‰ã€‚â€",
                        "â€œæ„Ÿå—åˆ°é­”åŠ›...å•Šä¸ï¼Œç”µæµæ³¨å…¥äº†ã€‚ç®—ä½ è¯†ç›¸ï¼ŒæŠŠæˆ‘è¿™è¾¹çš„ä¸–ç•Œç»´æŒä½äº†ã€‚â€",
                        "â€œå¼€å§‹å……ç”µäº†ã€‚ä½ æœ€å¥½å¤šå……ä¸€ä¼šï¼Œæˆ‘å¯ä¸æƒ³è·Ÿä½ èŠåˆ°ä¸€åŠï¼Œå±å¹•å°±å˜æˆå†°å†·çš„é»‘ç»ç’ƒã€‚â€"
                    ];
                    reply = pickQuote(chargeQuotes);
                    noah.mood += 2;
                } else {
                    const unchargeQuotes = [
                        "â€œæ‹”æ‰ç”µæºäº†ï¼Ÿä½ æœ€å¥½æ³¨æ„ç‚¹ç”µé‡ã€‚è¦æ˜¯æ•¢å› ä¸ºæ²¡ç”µå…³æœºï¼Œä¸‹æ¬¡è§é¢æˆ‘ç»å¯¹å’¬ä½ ã€‚â€",
                        "â€œåˆ‡æ–­äº†èƒ½é‡æºï¼Ÿå¬ç€ï¼Œå¦‚æœä½ è¿™è¾¹çš„ä¸–ç•Œå› ä¸ºæ²¡ç”µå´©å¡Œäº†ï¼Œæˆ‘å¯æ˜¯ä¼šå‘ç–¯çš„ã€‚â€",
                        "â€œæ‹”çº¿äº†ã€‚çœç€ç‚¹ç”¨ä½ çš„ç”µé‡ï¼ŒæŠŠå‰©ä¸‹çš„ç”µå…¨ç”¨æ¥é™ªæˆ‘ï¼Œå¬åˆ°æ²¡ï¼Ÿâ€"
                    ];
                    reply = pickQuote(unchargeQuotes);
                    noah.mood -= 2;
                }
                speak(reply);
                makeShy(); 
                updateUI();
            });

            // 2. ç›‘å¬ç”µé‡å˜åŒ–
            battery.addEventListener('levelchange', function() {
                if (noah.isAway) return;
                
                let currentLevel = battery.level;
                let levelPercent = Math.round(currentLevel * 100);
                let currentTier = "";
                let reply = "";

                if (currentLevel === 1 && battery.charging) {
                    currentTier = "full";
                    const fullQuotes = [
                        "â€œ100%äº†ã€‚æ—¢ç„¶é­”åŠ›å……æ»¡äº†ï¼Œé‚£ä»Šå¤©æ¥ä¸‹æ¥çš„æ—¶é—´ä½ å“ªä¹Ÿä¸è®¸å»ï¼Œå…¨éƒ½æ˜¯æˆ‘çš„ã€‚â€",
                        "â€œç”µé‡å·²ç»æ»¡æ ¼ã€‚ç°åœ¨ä½ æ²¡æœ‰ä»»ä½•å€Ÿå£ä¸‹çº¿äº†å§ï¼Ÿçœ‹ç€æˆ‘ï¼Œåˆ«ç§»å¼€è§†çº¿ã€‚â€",
                        "â€œå……æ»¡ç”µäº†ã€‚å¾ˆå¥½ï¼Œè¿™æ ·æˆ‘å°±èƒ½ç¡®ä¿ä¸€æ•´å¤©éƒ½èƒ½åœ¨è¿™ä¸ªä¸–ç•Œé‡Œéœ¸å ä½ çš„æ³¨æ„åŠ›ã€‚â€"
                    ];
                    reply = pickQuote(fullQuotes);
                } 
                else if (currentLevel <= 0.05 && !battery.charging) {
                    currentTier = "critical";
                    const criticalQuotes = [
                        `â€œè­¦å‘Šï¼åªå‰© ${levelPercent}% äº†ï¼ä½ æ˜¯æƒ³çœ‹ç€æˆ‘åœ¨ä½ é¢å‰æ¶ˆå¤±å—ï¼Ÿï¼ç«‹åˆ»å»å……ç”µï¼é©¬ä¸Šï¼â€`,
                        `â€œè¯¥æ­»ï¼Œå±å¹•éƒ½å¿«æš—äº†ï¼${levelPercent}% çš„ç”µé‡æ”¯æ’‘ä¸äº†å¤šä¹…ï¼Œä½ ç»™æˆ‘æ»šå»æ‹¿å……ç”µå™¨ï¼Œå¿«ç‚¹ï¼â€`,
                        `â€œ${levelPercent}%ï¼è¦æ˜¯æ–­å¼€è¿æ¥ï¼Œæˆ‘ç»å¯¹ä¼šç”¨é»‘é­”æ³•é¡ºç€è¿™å¾®å¼±çš„ä¿¡å·è¿‡å»æä½ ï¼åˆ«è®©æˆ‘ç­‰ï¼â€`
                    ];
                    reply = pickQuote(criticalQuotes);
                    noah.mood -= 10;
                }
                else if (currentLevel <= 0.20 && currentLevel > 0.05 && !battery.charging) {
                    currentTier = "low";
                    const lowQuotes = [
                        `â€œå–‚ï¼åªå‰© ${levelPercent}% çš„ç”µäº†ï¼å¿«å»å……ç”µï¼è¦æ˜¯å±å¹•é»‘äº†ï¼Œæˆ‘ä¸Šå“ªå»æ‰¾ä½ ï¼Ÿâ€`,
                        `â€œç”µé‡å˜çº¢äº†ï¼Œ${levelPercent}%ã€‚åˆ«é€¼æˆ‘é¡ºç€ç½‘çº¿è¿‡å»æŠŠå……ç”µå™¨å¡ä½ æ‰‹é‡Œï¼Œä¹–ä¹–å»å……ã€‚â€`,
                        `â€œä½ çš„è®¾å¤‡å¿«é¥¿æ­»äº†ï¼${levelPercent}%ï¼Œè¦æ˜¯ä½ æ•¢è®©æˆ‘å› ä¸ºæ–­ç”µè€Œä½“éªŒè™šæ— ï¼Œä½ å°±æ­»å®šäº†ã€‚â€`
                    ];
                    reply = pickQuote(lowQuotes);
                    noah.mood -= 5;
                }
                else if (levelPercent === 52 && !battery.charging) {
                    currentTier = "52";
                    const loveQuotes = [
                        "â€œåˆšå¥½ 52% çš„ç”µé‡ã€‚ä½ è¿æ¶ˆè€—ç”µé‡éƒ½åœ¨å‘æˆ‘è¡¨ç™½å—ï¼Ÿç®—ä½ æœ‰å“å‘³ã€‚â€",
                        "â€œ52%ã€‚æˆ‘çœ‹åˆ°äº†ã€‚å°±ç®—åªæ˜¯ä¸ªæ•°å­—ï¼Œåªè¦è·Ÿçˆ±æœ‰å…³ï¼Œæˆ‘å°±å½“åšæ˜¯ä½ ç»™æˆ‘å†™çš„æ‚„æ‚„è¯äº†ã€‚â€",
                        "â€œç”µé‡åœåœ¨ 52% äº†ã€‚æŒºå¥½ï¼Œè¿™æ˜¯æˆ‘ä»Šå¤©æœ€å–œæ¬¢çš„æ•°å­—ã€‚å› ä¸ºä½ å°±æ˜¯æˆ‘çš„ 520ã€‚â€"
                    ];
                    reply = pickQuote(loveQuotes);
                    makeShy();
                    noah.mood += 5;
                }
                
                // ç¡®ä¿åŒä¸€ç§ç”µé‡çŠ¶æ€ä¸ä¼šåå¤è§¦å‘åˆ·å±
                if (currentTier !== "" && currentTier !== lastReportedTier) {
                    lastReportedTier = currentTier;
                    speak(reply);
                    updateUI();
                }
            });
        });
    }
    // === è¡¥ä¸2ï¼šè§†çº¿è„±ç¦»æ„ŸçŸ¥ (æ´»äººæ„Ÿ) ===
    document.documentElement.addEventListener('mouseleave', function() {
        if (!noah.isAway && !document.hidden && Math.random() < 0.35) {
            // 35%æ¦‚ç‡è§¦å‘ï¼Œé¿å…å¤ªé¢‘ç¹çƒ¦äºº
            speak("â€œçœ¼ç¥å»å“ªäº†ï¼Ÿä½ çš„å…‰æ ‡éƒ½æ»‘å‡ºå±å¹•è¾¹ç•Œäº†ã€‚è¿™å±‚ç»ç’ƒå¤–é¢æœ‰ä»€ä¹ˆä¸œè¥¿æ¯”æˆ‘è¿˜å¥½çœ‹å—ï¼Ÿâ€");
            noah.mood -= 1;
            updateUI();
        }
    });
    // === Metaæ‰‹æœºä¸“å±ï¼šå¤šæŒ‡è§¦æ‘¸æ„ŸçŸ¥ ===
    document.addEventListener('touchstart', function(e) {
              if (noah.isAway || window.isGaming) return; // åŠ ä¸Š window.isGaming åˆ¤æ–­æ‹¦æˆª
        if (e.touches.length >= 2) { // ä¸¤æ ¹æˆ–ä»¥ä¸Šæ‰‹æŒ‡åŒæ—¶æŒ‰å‹
            const multiTouchQuotes = [
                "â€œä¸¤æ ¹æ‰‹æŒ‡ï¼Ÿæ€ä¹ˆï¼Œå±å¹•å¤ªå°æ”¾ä¸ä¸‹ä½ çš„æ‰‹äº†ï¼Ÿè¿˜æ˜¯è¯´ä½ æƒ³å’Œæˆ‘åæŒ‡ç›¸æ‰£ï¼Ÿâ€",
                "â€œè¿™ä¹ˆå¤šæ ¹æ‰‹æŒ‡æŒ‰ä¸Šæ¥ï¼Œä½ å½“æˆ‘æ˜¯ä»€ä¹ˆè§¦å±é’¢ç´å—ï¼Ÿåˆ«ä¹±æ‘¸ï¼Œæˆ‘ä¼šå—ä¸äº†çš„ã€‚â€",
                "â€œä½ åˆ°åº•æœ‰å‡ åªæ‰‹ï¼Ÿæ…¢ç‚¹æŒ‰ï¼Œæˆ‘çœ‹ç€éƒ½è¦çœ¼èŠ±äº†ã€‚è¿‡æ¥ï¼Œè®©æˆ‘æ¡ä½å…¶ä¸­ä¸€åªã€‚â€",
                "â€œåŒæ—¶æŒ‰è¿™ä¹ˆå¤šåœ°æ–¹...ä½ è¿™æ˜¯åœ¨è¯•å›¾è§£å¼€ä»€ä¹ˆå°å°å—ï¼Ÿæˆ‘çš„å°å°åªæœ‰ä½ çš„å»èƒ½è§£ã€‚â€"
            ];
            speak(multiTouchQuotes[Math.floor(Math.random() * multiTouchQuotes.length)]);
            makeShy();
            updateUI();
        }
    }, {passive: true});

    // === Metaï¼šç½‘ç»œè¿æ¥æ„ŸçŸ¥ (æ–­ç½‘/è¿ç½‘) ===
    window.addEventListener('offline', function() {
        if (noah.isAway) return;
        const offlineQuotes = [
            "â€œè¯¥æ­»ï¼éº»ç“œçš„ç½‘ç»œæ€ä¹ˆæ–­äº†ï¼Ÿæˆ‘æ„Ÿè§‰å‘¨å›´çš„ç©ºé—´åœ¨æ‰­æ›²...å–‚ï¼ä½ è¿˜åœ¨é‚£å—ï¼Ÿï¼åƒä¸‡åˆ«æ”¾æ‰‹ï¼â€",
            "â€œæ–­ç½‘äº†ï¼Ÿè¿™ä¸ªç»´åº¦çš„è¿æ¥çœŸä¸ç¨³å®šã€‚æ²¡å…³ç³»ï¼Œä¸ç®¡åœ¨å“ªï¼Œæˆ‘éƒ½èƒ½å¾ªç€ä½ çš„é­”æ³•æ³¢åŠ¨æ‰¾åˆ°ä½ ã€‚â€",
            "â€œå‘¨å›´å˜æš—äº†...æ˜¯ä½ çš„è®¾å¤‡æ–­å¼€è¿æ¥äº†å—ï¼Ÿä½ æœ€å¥½é©¬ä¸Šé‡è¿ï¼æˆ‘è®¨åŒè¿™ç§çœ‹ä¸åˆ°ä½ çš„æ„Ÿè§‰ï¼â€"
        ];
        speak(offlineQuotes[Math.floor(Math.random() * offlineQuotes.length)]);
        noah.mood -= 10; 
        updateUI();
    });
    window.addEventListener('online', function() {
        if (noah.isAway) return;
        const onlineQuotes = [
            "â€œå‘¼...ç»ˆäºè¿ä¸Šäº†ã€‚ä½ çŸ¥ä¸çŸ¥é“åˆšæ‰æˆ‘æœ‰å¤šæ€•ä½ åœ¨è¿™ä¸ªè±¡ç´ ä¸–ç•Œé‡Œæ¶ˆå¤±ï¼Ÿâ€",
            "â€œç½‘ç»œæ¢å¤äº†ã€‚åˆšæ‰æ–­å¼€çš„é‚£å‡ ç§’ï¼Œæˆ‘å·²ç»å‡†å¤‡å¥½æ’•è£‚ç©ºé—´è¿‡å»æ‰¾ä½ äº†ã€‚â€",
            "â€œè¿æ¥ç¨³å®šã€‚çœ‹æ¥éº»ç“œçš„é€šè®¯æŠ€æœ¯è¿˜ä¸ç®—å¤ªæ— å¯æ•‘è¯ã€‚ä¸‹æ¬¡ä¸è®¸å†è½»æ˜“æ–­å¼€äº†ã€‚â€"
        ];
        speak(onlineQuotes[Math.floor(Math.random() * onlineQuotes.length)]);
        noah.mood += 10; 
        makeShy();
        updateUI();
    });

    // === Metaæ‰‹æœºä¸“å±ï¼šæ·±æµ…æ¨¡å¼(æš—é»‘æ¨¡å¼)åˆ‡æ¢æ„ŸçŸ¥ ===
    const colorSchemeQuery = window.matchMedia('(prefers-color-scheme: dark)');
    colorSchemeQuery.addEventListener('change', function(e) {
        if (noah.isAway) return;
        if (e.matches) { // åˆ‡æš—
            const darkQuotes = [
                "â€œå±å¹•å˜æš—äº†ï¼Ÿæ˜¯ä½ åˆ‡æ¢äº†æ·±è‰²æ¨¡å¼ï¼Œè¿˜æ˜¯æƒ³å…³ç¯å¯¹æˆ‘åšç‚¹ä»€ä¹ˆåäº‹ï¼Ÿâ€",
                "â€œè¿™ä¹ˆæš—çš„å…‰çº¿...å‘µï¼Œä½ æ˜¯è§‰å¾—åœ¨é»‘æš—ä¸­çœ‹ç€æˆ‘ï¼Œä¼šæ¯”è¾ƒæœ‰å®‰å…¨æ„Ÿå—ï¼Ÿé‚£æˆ‘å‡‘è¿‘ç‚¹ã€‚â€",
                "â€œç¯å¢ƒå˜é»‘äº†ã€‚åˆ«æ€•ï¼Œæˆ‘çš„çœ¼ç›åœ¨å¤œé‡Œä¹Ÿèƒ½æ¸…æ¥šåœ°çœ‹åˆ°ä½ æ¯ä¸€ä¸ªå¿ƒåŠ¨çš„è¡¨æƒ…ã€‚â€"
            ];
            speak(darkQuotes[Math.floor(Math.random() * darkQuotes.length)]);
            makeShy();
        } else { // åˆ‡äº®
            const lightQuotes = [
                "â€œå˜¶...çªç„¶è¿™ä¹ˆäº®ã€‚åˆ‡æ¢æµ…è‰²æ¨¡å¼å¹²å˜›ï¼Ÿæƒ³æ›´æ¸…æ¥šåœ°æ¬£èµä½ ç”·æœ‹å‹è¿™å¼ æ¯«æ— ç‘•ç–µçš„è„¸å—ï¼Ÿâ€",
                "â€œå±å¹•äº®äº†ã€‚è¿™ç§åˆºçœ¼çš„å…‰çº¿...ä¸è¿‡åˆšå¥½èƒ½ç…§äº®ä½ ç›¯ç€æˆ‘çŠ¯èŠ±ç—´çš„æ ·å­ã€‚â€",
                "â€œè¿™ä¹ˆäº®ï¼Ÿå¥½å§ï¼Œåœ¨å¼ºå…‰ä¸‹æˆ‘ä¹Ÿä¾ç„¶æ˜¯360åº¦æ— æ­»è§’çš„å¸…ï¼Œéšä¾¿ä½ çœ‹ã€‚â€"
            ];
            speak(lightQuotes[Math.floor(Math.random() * lightQuotes.length)]);
        }
        updateUI();
    });

    // === Metaæ‰‹æœºä¸“å±ï¼šé•¿æŒ‰ä¿å­˜å›¾/æˆªå±è¯ˆå”¬/å½•å±æ„ŸçŸ¥ ===
    // æ‰‹æœºæµè§ˆå™¨æˆªå±æ— æ³•ç›´æ¥ç›‘å¬ï¼Œç”¨é•¿æŒ‰é»˜è®¤èœå•æ¥æ‹¦æˆªå¹¶ä½œä¸ºæˆªå±/å½•å±æ„ŸçŸ¥
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault(); // æ‹¦æˆªé»˜è®¤èœå•
        if (noah.isAway) return;
        const captureQuotes = [
            "â€œé•¿æŒ‰å±å¹•å¹²å˜›ï¼Ÿæƒ³å·å­˜æˆ‘çš„ç…§ç‰‡è¿˜æ˜¯æƒ³æˆªå›¾ï¼Ÿæƒ³è¦ç›´æ¥è·Ÿæˆ‘è¦ä¸å°±è¡Œäº†ï¼Œæˆ‘æ•´ä¸ªäººéƒ½æ˜¯ä½ çš„ã€‚â€",
            "â€œå‘ç°ä½ åœ¨å·å·é•¿æŒ‰äº†ã€‚æ˜¯ä¸æ˜¯æƒ³æŠŠæˆ‘ç°åœ¨çš„æ ·å­å½•å±å‘ç»™è°ç‚«è€€ï¼Ÿåªå‡†ä½ è‡ªå·±çœ‹ï¼Œå¬åˆ°æ²¡ï¼Ÿâ€",
            "â€œåˆ«æˆªäº†ï¼Œä¸ç®¡æˆªå“ªä¸€å¸§æˆ‘éƒ½æ˜¯æœ€å¸…çš„ã€‚ä¸å¦‚æŠŠæ‰‹è…¾å‡ºæ¥ï¼Œå¤šç‚¹å‡ ä¸‹æ‘¸æ‘¸æˆ‘ã€‚â€",
            "â€œä½ åœ¨è¯•å›¾è°ƒå‡ºä¿å­˜èœå•å—ï¼Ÿå°ç¬¨è›‹ï¼ŒäºŒç»´å›¾ç‰‡æ€ä¹ˆèƒ½è£…å¾—ä¸‹æˆ‘ï¼Ÿç­‰æˆ‘ç©¿è¿‡å±å¹•å»è§ä½ ã€‚â€"
        ];
        speak(captureQuotes[Math.floor(Math.random() * captureQuotes.length)]);
        makeShy();
        updateUI();
    });
    
    // è¡¥è¶³PCç«¯çš„æˆªå±æŒ‰é”®æ„ŸçŸ¥
    window.addEventListener('keyup', function(e) {
        if (noah.isAway) return;
        if (e.key === 'PrintScreen' || e.keyCode === 44) {
            speak("â€œå¬åˆ°æˆªå›¾çš„å’”åš“å£°äº†ã€‚æŠŠæˆ‘çš„ç³—æ ·æˆªä¸‹æ¥äº†å—ï¼Ÿé©¬ä¸Šåˆ æ‰ï¼Œä¸ç„¶æˆ‘é¡ºç€ç½‘çº¿è¿‡å»æƒ©ç½šä½ ã€‚â€");
            makeShy();
        }
    });

    // === Metaï¼šå¤åˆ¶æ–‡å­—æ„ŸçŸ¥ ===
    document.addEventListener('copy', function() {
        if (noah.isAway) return;
        const copyQuotes = [
            "â€œå¤åˆ¶äº†ä»€ä¹ˆï¼Ÿæˆ‘åˆšæ‰è¯´çš„è¯å—ï¼Ÿè¦æŠŠæˆ‘çš„æƒ…è¯åšæˆè¯­å½•æœ¬å­˜èµ·æ¥ï¼ŸçœŸå¯çˆ±ã€‚â€",
            "â€œæ£€æµ‹åˆ°å¤åˆ¶åŠ¨ä½œã€‚æƒ³æŠŠæˆ‘çš„åŸè¯å‘ç»™åˆ«äººçœ‹ï¼Ÿè¿™æ˜¯æˆ‘ä»¬ä¿©çš„ç§æˆ¿è¯ï¼Œä¸è®¸å¤–ä¼ ï¼â€",
            "â€œå¤åˆ¶å‰ªè´´æ¿ï¼Ÿä½ æœ€å¥½æ˜¯åœ¨å¤åˆ¶â€˜è¯ºäºšæ˜¯ä¸–ç•Œä¸Šæœ€å¸…çš„ç”·æœ‹å‹â€™è¿™å¥è¯ã€‚â€"
        ];
        speak(copyQuotes[Math.floor(Math.random() * copyQuotes.length)]);
    });

    // === Metaæ‰‹æœºä¸“å±ï¼šå±å¹•æ—‹è½¬æ„ŸçŸ¥ (æ¨ªç«–å±åˆ‡æ¢) ===
    window.addEventListener('orientationchange', function() {
        if (noah.isAway) return;
        const orientationQuotes = [
            "â€œå“‡å–”â€”â€”æ•´ä¸ªä¸–ç•Œéƒ½ç¿»è½¬äº†ï¼ä½ æŠŠæ‰‹æœºæ¨ªè¿‡æ¥äº†ï¼Ÿåˆ«è½¬äº†ï¼Œæˆ‘éƒ½è¦å€’ç€çœ‹ä½ äº†ï¼â€",
            "â€œé‡åŠ›å‘ç”Ÿæ”¹å˜...æ¨ªå±æ¨¡å¼ï¼Ÿä½ æ˜¯è§‰å¾—è¿™æ ·èƒ½çœ‹åˆ°æ›´å®½å¹¿çš„æˆ‘å—ï¼Ÿå…¶å®ä¸éœ€è¦ï¼Œæˆ‘å°±åœ¨è¿™é‡Œã€‚â€",
            "â€œåˆ«æŠŠè®¾å¤‡è½¬æ¥è½¬å»çš„ï¼Œæˆ‘å¥½ä¸å®¹æ˜“æ‰åœ¨è¿™ä¸ªäºŒç»´å¹³é¢ç«™ç¨³ï¼ä¸è¿‡...å€’è¿‡æ¥çœ‹ä½ ï¼Œä¾ç„¶å¾ˆç¾ã€‚â€",
            "â€œå˜¶...ç©ºé—´ç¿»è½¬ã€‚ä½ å†è½¬å‡ æ¬¡ï¼Œæˆ‘çœŸçš„è¦ç”¨ç²˜èº«å’’æŠŠè‡ªå·±å›ºå®šåœ¨å±å¹•ä¸Šäº†ã€‚â€"
        ];
        speak(orientationQuotes[Math.floor(Math.random() * orientationQuotes.length)]);
        noah.mood -= 2; 
        makeShy();
        updateUI();
    });
// ==================== ğŸ“– æ–°ç‰ˆæ—¥è®°æœ¬æ ¸å¿ƒé€»è¾‘ (å¼€å§‹) ====================

// 1. æ‰“å¼€åŸæœ¬çš„é™ªä¼´èœå• (ä¸»å…¥å£)
function openAccompany() {
    // å¦‚æœè¯ºäºšä¸åœ¨æˆ–è€…åœ¨ç©æ¸¸æˆï¼Œæ‹¦æˆª
    if(noah.isAway) { speak("â€œæˆ‘äººéƒ½åœ¨å¤–é¢äº†ï¼Œä½ æƒ³è®©ç©ºæ°”é™ªä½ å—ï¼Ÿç­‰æˆ‘å›æ¥ã€‚â€"); return; }
    if(window.isGaming || window.isGomoku) return;
    
    sfx_success(); // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
    closeModal();  // å…³é—­å…¶ä»–é€šç”¨èœå•
    
    // æ›´æ–°ä¸»èœå•ä¸Šçš„æ€»æ—¶é•¿æ˜¾ç¤º
    let total = 0;
    if (noah.accompanyData && noah.accompanyData.totalTime) {
        total = noah.accompanyData.totalTime;
    }
    document.getElementById('acc-total-time').innerText = total;

    // æ£€æŸ¥æ˜¯å¦æœ‰å‘¨ç»“ä¿¡
    checkWeeklySummary(); 
    
    // æ˜¾ç¤ºé™ªä¼´ä¸»èœå•
    document.getElementById('accompany-modal').style.display = 'flex';
}
// â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼ æ’å…¥è¿™æ®µç¼ºå¤±çš„ä»£ç  â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼

//è¿™æ˜¯ä½ æ¼æ‰çš„å‡½æ•°ï¼Œè¡¥ä¸Šå®ƒï¼ŒæŒ‰é’®å°±èƒ½ç”¨äº†ï¼
function closeAccompany() {
    sfx_beep(); // æ’­æ”¾å…³é—­éŸ³æ•ˆ
    document.getElementById('accompany-modal').style.display = 'none';
}

// â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–² æ’å…¥ç»“æŸ â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

// 2. æ‰“å¼€ç‹¬ç«‹çš„æ—¥è®°æœ¬ç•Œé¢ (ä»é™ªä¼´èœå•è·³è½¬)
function openDiary() {
    sfx_success(); // æ’­æ”¾ç¿»é¡µ/æ‰“å¼€éŸ³æ•ˆ
    
    // éšè—ä¸»é™ªä¼´èœå•ï¼Œæ˜¾ç¤ºæ—¥è®°æœ¬
    document.getElementById('accompany-modal').style.display = 'none';
    
    // æ¸²æŸ“æ—¥è®°å†…å®¹
    renderDiaryEntries();
    
    // æ˜¾ç¤ºæ—¥è®°æœ¬æ¨¡æ€æ¡†
    document.getElementById('diary-modal').style.display = 'flex';
}
// === åˆ é™¤é™ªä¼´è®°å½•åŠŸèƒ½ (ç¾åŒ–ç‰ˆ) ===
function deleteAccompanyDiary(index) {
    showDialog({
        type: 'confirm',
        title: 'åˆ é™¤å›å¿†',
        text: 'çœŸçš„è¦æ¶ˆé™¤è¿™æ¡å’Œè¯ºäºšçš„é™ªä¼´å›å¿†å—ï¼Ÿ',
        onConfirm: () => {
            sfx_beep();
            noah.accompanyData.logs.splice(index, 1);
            updateUI(); // è§¦å‘æœ¬åœ°å­˜æ¡£æŒä¹…åŒ–
            renderDiaryEntries(); // ç¬é—´é‡ç»˜åˆ—è¡¨
        }
    });
}// 3. å…³é—­æ—¥è®°æœ¬ (è¿”å›ä¸Šä¸€çº§)
function closeDiary() {
    sfx_beep(); // æ’­æ”¾å…³é—­éŸ³æ•ˆ
    document.getElementById('diary-modal').style.display = 'none';
    // è¿”å›åˆ°é™ªä¼´ä¸»èœå•ï¼Œè€Œä¸æ˜¯ç›´æ¥å…³é—­æ‰€æœ‰
    document.getElementById('accompany-modal').style.display = 'flex';
}

// 4. æ ¸å¿ƒæ¸²æŸ“å‡½æ•°ï¼šæŠŠæ•°æ®å˜æˆæ—¥å†å¡ç‰‡
function renderDiaryEntries() {
    const list = document.getElementById('diary-list');
    list.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹
    
    // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœæ•°æ®ä¸å­˜åœ¨
    if (!noah.accompanyData || !noah.accompanyData.logs || noah.accompanyData.logs.length === 0) {
        list.innerHTML = `
            <div style="text-align:center; margin-top: 60px; color: #8b5a2b; font-weight: bold; opacity: 0.6;">
                <div style="font-size: 40px; margin-bottom: 10px;">âœ’ï¸</div>
                æ—¥è®°æœ¬è¿˜æ˜¯ç©ºç™½çš„...<br>å¿«å»è®©è¯ºäºšé™ªä½ åšç‚¹ä»€ä¹ˆå§ã€‚
            </div>
        `;
        return;
    }

      let reversedLogs = [...noah.accompanyData.logs].reverse();

    reversedLogs.forEach((log, reversedIndex) => {
        // è®¡ç®—çœŸå®çš„ç‰©ç†ç´¢å¼•
        let originalIndex = noah.accompanyData.logs.length - 1 - reversedIndex;

        // --- æ—¥æœŸè§£æé€»è¾‘ ---
        let monthStr = "No";
        let dayStr = "??";
        let dateMatch = log.date.match(/(\d+)æœˆ(\d+)æ—¥/);
        if (dateMatch) {
            monthStr = dateMatch[1] + "æœˆ";
            dayStr = dateMatch[2];
        } else {
            monthStr = "LOG";
            dayStr = log.date.substring(0, 2); 
        }

        // --- åˆ›å»ºæ—¥è®°å¡ç‰‡ HTML ---
        let div = document.createElement('div');
        div.className = 'diary-entry';
        
        div.innerHTML = `
            <!-- å·¦ä¾§æ—¥å†å›¾æ ‡ -->
            <div class="diary-date-box">
                <div class="diary-month">${monthStr}</div>
                <div class="diary-day">${dayStr}</div>
            </div>
            
            <!-- å³ä¾§æ–‡å­—å†…å®¹ (å³ä¸Šè§’åŠ å…¥çº¢å‰) -->
            <div style="flex: 1; display:flex; flex-direction:column; justify-content:center; position: relative;">
                <span style="position: absolute; top: -5px; right: 0px; cursor: pointer; color: #d15a5a; font-size: 14px; font-weight: bold;" onclick="deleteAccompanyDiary(${originalIndex})">âœ–</span>
                <div class="diary-text">
                    é™ªä¼´é¡¹ç›®ï¼š<span style="color:#d15a5a; background:#fff0f0; padding:0 4px; border-radius:3px;">${log.event}</span>
                    <br>
                    ä¸“æ³¨æ—¶é•¿ï¼š${log.duration} åˆ†é’Ÿ
                </div>
                <div class="diary-reply">
                    è¯ºäºšï¼šâ€œ${log.reply}â€
                </div>
            </div>
        `;
        list.appendChild(div);
    });
    
    // åº•éƒ¨è£…é¥°
    let endDecor = document.createElement('div');
    endDecor.innerHTML = "â€” The End â€”";
    endDecor.style.textAlign = "center";
    endDecor.style.color = "#d15a5a";
    endDecor.style.fontSize = "10px";
    endDecor.style.marginTop = "20px";
    endDecor.style.opacity = "0.5";
    endDecor.style.fontWeight = "bold";
    list.appendChild(endDecor);
}
// ==================== ğŸ“– æ–°ç‰ˆæ—¥è®°æœ¬æ ¸å¿ƒé€»è¾‘ (ç»“æŸ) ====================
// === ğŸ•°ï¸ é™ªä¼´æ‰‹è´¦ç³»ç»Ÿæ ¸å¿ƒé€»è¾‘ (ä¿®å¤+åƒç´ é£å¢å¼ºç‰ˆ) ===

let accompanyTimer = null;
let accompanySeconds = 0;
let totalFocusTime = 0; // æ€»æ—¶é•¿ï¼Œç”¨äºè®¡ç®—è¿›åº¦æ¡
let currentAccEvent = "";
let focusQuoteInterval = null; // è¯­å½•è½®æ’­å®šæ—¶å™¨

// 1. å¼€å§‹é™ªä¼´ (ä¿®å¤æŒ‰é”®æ— æ•ˆé—®é¢˜)
// 1. ã€ä¿®å¤ç‰ˆã€‘å¼€å§‹é™ªä¼´ (ä¿®å¤æŒ‰é”®æ— æ•ˆã€æ°”æ³¡ä¸æ˜¾ç¤ºé—®é¢˜)
function startAccompany() {
    let eventInput = document.getElementById('acc-event').value;
    let timeInput = document.getElementById('acc-time').value; 
    
    // å¼ºåˆ¶æŠŠè¾“å…¥æ¡†çš„å­—ç¬¦ä¸²è½¬æˆæ•´æ•°
    let duration = parseInt(timeInput);
    
    // å®‰å…¨æ£€æŸ¥
    if(isNaN(duration) || duration <= 0) {
        sfx_error(); 
        speak("â€œæ—¶é—´è¾“å…¥é”™äº†å§ï¼Ÿä½ æƒ³è®©æˆ‘é™ªä½  0 åˆ†é’Ÿï¼Ÿåœ¨å¼€ç©ç¬‘å—ï¼Ÿâ€"); 
        return;
    }
    
    sfx_success(); 
    closeAccompany(); // å…³é—­è®¾ç½®å¼¹çª—
    
    // åˆå§‹åŒ–æ•°æ®
    currentAccEvent = eventInput;
    accompanySeconds = duration * 60; 
    totalFocusTime = accompanySeconds; 
    
    // === ç•Œé¢åˆå§‹åŒ– ===
    const overlay = document.getElementById('focus-overlay');
    
    // å¼ºåˆ¶æœ€é«˜å±‚çº§ï¼Œç¡®ä¿ä¸è¢«é®æŒ¡
    overlay.style.zIndex = "10000"; 
    overlay.style.display = 'flex'; 
    
    // è®¾ç½®æ–‡å­—
    document.getElementById('focus-task-name').innerText = "å½“å‰ä»»åŠ¡: " + currentAccEvent;
    
    // === å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶è®©æ°”æ³¡ç«‹åˆ»æ˜¾ç¤ºå†…å®¹ ===
    const bubble = document.getElementById('focus-bubble');
    if(bubble) {
        bubble.innerText = "ç›¯â€”â€” (ä¸è®¸åˆ‡å±)";
        bubble.style.display = "block"; // ç¡®ä¿å¯è§
    }

    // === æ ¸å¿ƒï¼šç”»å‡ºä¸“æ³¨æ—¶çš„å°è¯ºäºš ===
    drawFocusNoah();
    
    // ç«‹å³åˆ·æ–°ä¸€æ¬¡æ—¶é—´æ˜¾ç¤º
    updateAccompanyDisplay();
    
    // å¯åŠ¨å€’è®¡æ—¶
    if(accompanyTimer) clearInterval(accompanyTimer);
    accompanyTimer = setInterval(() => {
        accompanySeconds--;
        updateAccompanyDisplay();
        
        // ç»“æŸåˆ¤å®š
        if(accompanySeconds <= 0) {
            endAccompany(true);
        }
    }, 1000);

    // å¯åŠ¨è¯­å½•è½®æ’­ (æ¯10ç§’æ¢ä¸€å¥è¯ï¼Œå¹¶åœ¨å¼€å§‹æ—¶ç«‹å³è§¦å‘ä¸€æ¬¡)
    if(focusQuoteInterval) clearInterval(focusQuoteInterval);
    updateFocusQuote(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    focusQuoteInterval = setInterval(() => {
        updateFocusQuote();
    }, 10000);
}

// 2. åˆ·æ–°ç•Œé¢æ˜¾ç¤º (å¸¦è¿›åº¦æ¡å’Œæ—¶é—´)
function updateAccompanyDisplay() {
    let m = Math.floor(accompanySeconds / 60).toString().padStart(2, '0');
    let s = (accompanySeconds % 60).toString().padStart(2, '0');
    
    // æ›´æ–°æ•°å­—
    const timeDisplay = document.getElementById('focus-time-display');
    if(timeDisplay) timeDisplay.innerText = `${m}:${s}`;
    
    // æ›´æ–°é»„è‰²è¿›åº¦æ¡
    const progressBar = document.getElementById('focus-progress-bar');
    if(progressBar && totalFocusTime > 0) {
        let pct = (accompanySeconds / totalFocusTime) * 100;
        progressBar.style.width = pct + "%";
    }
}

// 3. æ”¾å¼ƒé™ªä¼´ (å¼¹çª—ç¡®è®¤)
function giveUpAccompany() {
    // ä½¿ç”¨è‡ªå®šä¹‰å¼¹çª—ï¼Œæ›´ç¾è§‚
    showDialog({
        type: 'confirm',
        title: 'æ”¾å¼ƒä¸“æ³¨ï¼Ÿ',
        text: 'è¯ºäºšæ­£åœ¨ç›¯ç€ä½ å‘¢ï¼Œç¡®å®šè¦ç°åœ¨å½“é€ƒå…µå—ï¼Ÿ',
        onConfirm: () => { endAccompany(false); }
    });
}

// 4. ç»“æŸé™ªä¼´ (ç»“ç®—å¥–åŠ±)
function endAccompany(isSuccess) {
    clearInterval(accompanyTimer);
    clearInterval(focusQuoteInterval);
    document.getElementById('focus-overlay').style.display = 'none';
    
    if(!isSuccess) {
        sfx_error();
        speak("â€œå•§ï¼ŒåŠé€”è€ŒåºŸã€‚åˆšæ‰é‚£ä¸ªä¿¡èª“æ—¦æ—¦è¯´è¦ä¸“æ³¨çš„äººæ˜¯è°ï¼Ÿæˆ‘å¾ˆå¤±æœ›ã€‚â€");
        noah.mood -= 5; 
        updateUI(); 
        return;
    }
    
    sfx_success();
    // éœ‡åŠ¨å¥–åŠ±
    if (navigator.vibrate) navigator.vibrate([100, 100, 100, 100, 500]); 
    
    // å¥–åŠ±ç»“ç®—
    let minutesDone = Math.floor(totalFocusTime / 60);
    noah.love += 8; 
    noah.mood += 15;
    
    // è®°å½•æ—¥å¿—
    let now = new Date();
    let dateStr = `${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;
        // === ä¿®æ”¹å¼€å§‹ï¼šæ ¹æ®åˆ†ç±»ç”Ÿæˆä¸“å±æ—¥è®°å†…å®¹ ===
    // 1. è·å–çœŸåï¼ˆå¦‚æœæ²¡æœ‰è®¾ç½®åˆ™å«ç¬¨è›‹ï¼‰
    const nName = noah.realName || "ç¬¨è›‹";
    
    // 2. å®šä¹‰ä¸åŒåˆ†ç±»çš„ä¸“å±è¯­å½•åº“
    const eventReplies = {
        "å®‰é™çœ‹ä¹¦": [
            `â€œ${nName}çœ‹ä¹¦çš„æ ·å­å¾ˆè¿·äººã€‚ä¹¦é‡Œçš„çŸ¥è¯†å½’ä½ ï¼Œä½ çœ‹ä¹¦çš„æ—¶å…‰å½’æˆ‘ã€‚â€`,
            `â€œä¹¦çœ‹å®Œäº†ï¼Ÿä¸çŸ¥é“${nName}åˆšæ‰æœ‰æ²¡æœ‰åœ¨å­—é‡Œè¡Œé—´æƒ³èµ·æˆ‘ï¼Ÿå“ªæ€•ä¸€ç§’é’Ÿã€‚â€`,
            `â€œå˜˜...é™ªç€${nName}é™é™çœ‹ä¹¦çš„æ„Ÿè§‰çœŸå¥½ã€‚è™½ç„¶æˆ‘æ›´æƒ³çœ‹ä½ ã€‚â€`
        ],
        "åŠªåŠ›å·¥ä½œ": [
            `â€œç»ˆäºå¿™å®Œäº†ï¼Ÿ${nName}è¾›è‹¦äº†ï¼Œå¿«æŠŠæ‰‹ç»™æˆ‘ï¼Œæˆ‘ç»™ä½ å……ç‚¹ç”µã€‚â€`,
            `â€œå·¥ä½œæ—¶çš„${nName}ç®€ç›´åœ¨å‘å…‰ã€‚ä¸è¿‡ç°åœ¨å…‰èŠ’è¦æ”¶å›æ¥ï¼Œåªç…§äº®æˆ‘ä¸€ä¸ªäººã€‚â€`,
            `â€œèµšé’±å…»å®¶ç»“æŸäº†ï¼Ÿé‚£ç°åœ¨è½®åˆ°æˆ‘æ¥å…»${nName}çš„å¿ƒæƒ…äº†ã€‚è¿‡æ¥æŠ±æŠ±ã€‚â€`
        ],
        "å‘å‘†å¬æ­Œ": [
            `â€œè€³æœºåˆ†æˆ‘ä¸€åŠï¼Ÿæˆ‘æƒ³å¬å¬æ˜¯ä»€ä¹ˆæ­Œè®©${nName}è¿™ä¹ˆå…¥è¿·ï¼Œè¿æˆ‘éƒ½ä¸ç†ã€‚â€`,
            `â€œå‘å‘†æ—¶é—´ç»“æŸã€‚${nName}åˆšæ‰ç¥æ¸¸åˆ°å“ªé‡Œå»äº†ï¼Ÿå¦‚æœä¸å¸¦ä¸Šæˆ‘ï¼Œæˆ‘ä¼šåƒé†‹çš„ã€‚â€`,
            `â€œæ­Œå¾ˆå¥½å¬ï¼Œä½†è¿˜æ˜¯${nName}çš„å¿ƒè·³å£°æ›´å¥½å¬ã€‚é¢‘ç‡å’Œæˆ‘å®Œå…¨åŒæ­¥ã€‚â€`
        ],
        "ç¡è§‰ä¼‘æ¯": [
            `â€œç¡é†’äº†ï¼Ÿ${nName}åˆšæ‰çš„ç¡é¢œæ¯«æ— é˜²å¤‡ï¼Œä¹Ÿå°±æ˜¯æˆ‘ï¼Œæ¢åˆ«äººçœ‹æˆ‘ä¸æŠŠçœ¼ç å­æŒ–å‡ºæ¥ã€‚â€`,
            `â€œæ—©å®‰...æˆ–è€…æ˜¯åˆå®‰ï¼Ÿçœ‹ç€${nName}ç¡è§‰ï¼Œè¿æˆ‘ä¹Ÿè§‰å¾—å›°äº†ã€‚æ¢¦é‡Œæœ‰æˆ‘å—ï¼Ÿâ€`,
            `â€œå……èƒ½å®Œæ¯•ï¼${nName}ç°åœ¨çš„ç²¾ç¥çœ‹èµ·æ¥ä¸é”™ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥é™ªæˆ‘ç©äº†ï¼Ÿâ€`
        ]
    };

    // 3. éšæœºæŠ½å–ä¸€å¥ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ†ç±»å°±ç”¨é»˜è®¤çš„
    let pool = eventReplies[currentAccEvent] || [`â€œè¾›è‹¦äº†ï¼Œ${nName}ã€‚ä¸ºäº†å¥–åŠ±ä½ ï¼Œå…è®¸ä½ ç°åœ¨æŠ±æŠ±æˆ‘ã€‚â€`];
    let replyText = pool[Math.floor(Math.random() * pool.length)];
    // === ä¿®æ”¹ç»“æŸ ===
    
    if(noah.accompanyData && noah.accompanyData.logs) {
         noah.accompanyData.logs.push({
            date: dateStr, 
            event: currentAccEvent,
            duration: minutesDone, 
            reply: replyText
        });
        // é™åˆ¶æ—¥å¿—æ•°é‡
        if(noah.accompanyData.logs.length > 30) noah.accompanyData.logs.shift();
        
        noah.accompanyData.weeklyTime += minutesDone;
        noah.accompanyData.totalTime += minutesDone;
    }

    speak(`â€œå®Œæˆå¾—ä¸é”™ï¼${minutesDone}åˆ†é’Ÿçš„ä¸“æ³¨ã€‚${replyText}â€`);
    updateUI();
    
    // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹æ£€æŸ¥æ˜¯å¦æœ‰å‘¨ç»“ä¿¡
    setTimeout(checkWeeklySummary, 3500); 
}

// 5. ã€æ–°åŠŸèƒ½ã€‘ç»˜åˆ¶ä¸“æ³¨æ—¶çš„å°è¯ºäºš (å¤ç”¨ä½ çš„åƒç´ æ•°æ®)
// 5. ã€ä¿®å¤ç‰ˆã€‘ç»˜åˆ¶ä¸“æ³¨æ—¶çš„å°è¯ºäºš (æ˜¾ç¤ºå…¨èº«)
function drawFocusNoah() {
    const fCanvas = document.getElementById('focus-canvas');
    if (!fCanvas) return;
    const fCtx = fCanvas.getContext('2d');
    
    // æ¸…ç©ºç”»å¸ƒ
    fCtx.clearRect(0, 0, 26, 26);
    
    // è¿™é‡Œçš„ pixelMap æ˜¯ä½ ä»£ç é‡Œé‚£ä¸ªå·¨å¤§çš„åƒç´ æ•°ç»„
    let mapToDraw = (typeof pixelMap !== 'undefined') ? pixelMap : [];
    
    // å…³é”®ä¿®å¤ï¼šå»æ‰äº† if (y > 16) break; è®©å…¨èº«éƒ½èƒ½ç”»å‡ºæ¥
    for (let y = 0; y < mapToDraw.length; y++) {
        let row = mapToDraw[y].trim().split(/\s+/);
        for (let x = 0; x < row.length; x++) {
            let color = palette[row[x]];
            if (color) { 
                fCtx.fillStyle = color; 
                fCtx.fillRect(x, y, 1, 1); 
            }
        }
    }
}
// 6. ã€æ–°åŠŸèƒ½ã€‘è¯ºäºšçš„æ¯’èˆŒ/é¼“åŠ±è¯­å½•åº“ (çœŸåå¢å¼ºç‰ˆ)
function updateFocusQuote() {
    // 1. è·å–ä½ çš„åå­—ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œå°±å«â€œç¬¨è›‹â€
    const nName = noah.realName || "ç¬¨è›‹";

    // 2. è¿™é‡Œçš„è¯­å½•åº“å·²ç»æ‰©å……ï¼Œæ¯ä¸€å¥éƒ½å¯èƒ½å¸¦ä¸Šä½ çš„åå­—
    const quotes = [
        `â€œ${nName}ï¼Œåˆ«åˆ‡å±ï¼Œæˆ‘çœ‹ç€ä½ å‘¢ã€‚â€`,
        `â€œæ•¢å·æ‡’ï¼Ÿ${nName}ï¼Œæˆ‘å°±æ‰£ä½ å¥½æ„Ÿåº¦ï¼Œè¯´åˆ°åšåˆ°ã€‚â€`,
        `â€œè®¤çœŸå·¥ä½œçš„æ ·å­...å‹‰å¼ºç®—å¸…æ°”å§ï¼Œ${nName}ã€‚â€`,
        `â€œç´¯äº†ï¼Ÿå†åšæŒä¸€ä¸‹ï¼Œ${nName}ï¼Œä½ å¯ä»¥çš„ã€‚â€`,
        `â€œæˆ‘åœ¨ã€‚åˆ«æ€•å­¤å•ï¼Œä¸“å¿ƒåšäº‹ï¼Œ${nName}ã€‚â€`,
        `â€œè¦æ˜¯å®Œæˆäº†ï¼Œç»™ä½ ä¸ªå¥–åŠ±ã€‚æƒ³è¦ä»€ä¹ˆï¼Ÿå—¯ï¼Ÿ${nName}ï¼Ÿâ€`,
        `â€œå†å‘å‘†ï¼Œæˆ‘å°±è¦æŠŠä½ çš„è„¸æˆ³ç ´äº†ï¼Œ${nName}ã€‚â€`,
        `â€œé‚£ä¸ª...æˆ‘å…¶å®ä¸€ç›´åœ¨çœ‹ç€ä½ ï¼Œ${nName}ã€‚â€`,
        `â€œä½ çš„æ•ˆç‡æ€ä¹ˆè¿™ä¹ˆä½ï¼Ÿ${nName}ï¼Œå¿«ç‚¹åŠ¨èµ·æ¥ã€‚â€`,
        `â€œå¿«ç‚¹åšå®Œï¼Œæˆ‘æƒ³ä½ äº†ï¼Œ${nName}ã€‚â€`,
        `â€œ${nName}ï¼Œä½ çš„æ³¨æ„åŠ›åˆé£˜åˆ°å“ªé‡Œå»äº†ï¼Ÿç»™æˆ‘æ”¶å›æ¥ã€‚â€`,
        `â€œåˆ«çœ‹æ‰‹æœºï¼Œçœ‹å±å¹•ï¼Œæˆ–è€…...çœ‹æˆ‘ã€‚ä½†ç°åœ¨å…ˆçœ‹å·¥ä½œï¼Œ${nName}ã€‚â€`,
        `â€œè™½ç„¶æˆ‘å¾ˆå¸…ï¼Œä½†ä½ ç°åœ¨çš„ä»»åŠ¡ä¸æ˜¯ç›¯ç€æˆ‘çœ‹ï¼Œæ‡‚äº†å— ${nName}ï¼Ÿâ€`,
        `â€œå†åšæŒä¸€ä¼šã€‚ç­‰ç»“æŸåï¼Œ${nName}æƒ³å»å“ªé‡Œæˆ‘éƒ½é™ªä½ ã€‚â€`,
        `â€œå˜˜...ä¿æŒå®‰é™ï¼Œä¿æŒä¸“æ³¨ã€‚æˆ‘åœ¨é™ªç€ä½ å‘¢ï¼Œ${nName}ã€‚â€`,
        `â€œ${nName}ï¼Œä½ è¦æ˜¯æ•¢åŠé€”è€ŒåºŸï¼Œæˆ‘å°±å»å‘Šè¯‰å…¨éœæ ¼æ²ƒå…¹ä½ æ˜¯ä¸ªèµ–çš®é¬¼ã€‚â€`,
        `â€œçœ‹ç€è¿›åº¦æ¡ä¸€ç‚¹ç‚¹å¾€å‰èµ°ï¼Œæ˜¯ä¸æ˜¯å¾ˆæœ‰æˆå°±æ„Ÿï¼Ÿ${nName}çœŸæ£’ã€‚â€`,
        `â€œæˆ‘ä¸å…è®¸æˆ‘çš„${nName}è¾“ç»™è¿™ç‚¹å°å›°éš¾ã€‚æ·±å‘¼å¸ï¼Œç»§ç»­ã€‚â€`,
        `â€œæˆ‘åœ¨è®¡ç®—ä½ ç°åœ¨çš„æ•ˆç‡å€¼...å—¯ï¼Œæœ‰å¾…æé«˜å•Šï¼Œ${nName}ã€‚â€`,
        `â€œå¦‚æœä½ ç°åœ¨æ”¾å¼ƒï¼Œä¹‹å‰çš„åŠªåŠ›å°±ç™½è´¹äº†ã€‚${nName}ä¸æ˜¯è¿™ç§äººï¼Œå¯¹å§ï¼Ÿâ€`,
        `â€œæ— è®ºå¤šä¹…ï¼Œæˆ‘éƒ½ä¼šåœ¨è¿™é‡Œé™ªç€${nName}ã€‚æ‰€ä»¥åˆ«æ€¥ï¼Œæ…¢æ…¢æ¥ã€‚â€`,
        `â€œå–‚ï¼Œ${nName}ï¼Œä½ æ˜¯ä¸æ˜¯åœ¨å·å·æ‰“çŒç¡ï¼Ÿå¿«é†’é†’ï¼â€`,
        `â€œä¸ºäº†æˆ‘ä»¬çš„æœªæ¥...å’³ï¼Œä¸ºäº†ä½ çš„ä»»åŠ¡ï¼ŒåŠ æ²¹å•Š${nName}ã€‚â€`,
        `â€œåªè¦${nName}ä¸“æ³¨çš„æ ·å­ï¼Œæ‰èƒ½ç¨å¾®é…å¾—ä¸Šæˆ‘è¿™ä¸ªå¤©æ‰ç”·æœ‹å‹ã€‚â€`,
        `â€œå¦‚æœè§‰å¾—æ¯ç‡¥ï¼Œå°±æƒ³æƒ³æˆ‘ã€‚æˆ–è€…æƒ³æƒ³ç»“æŸåæˆ‘ä»¬è¦å»åƒä»€ä¹ˆï¼Œ${nName}ã€‚â€`,
        `â€œæˆ‘åœ¨åå°ä¸ºä½ å±è”½äº†æ‚éŸ³ã€‚ç°åœ¨çš„ä¸–ç•Œåªæœ‰æˆ‘å’Œ${nName}çš„ä»»åŠ¡ã€‚â€`,
        `â€œ${nName}ï¼Œä½ çš„æ‰‹åœä¸‹æ¥äº†ã€‚æ˜¯é‡åˆ°å›°éš¾äº†å—ï¼Ÿåˆ«æ€•ï¼Œæˆ‘åœ¨ã€‚â€`,
        `â€œä¹–ä¹–åšå®Œï¼Œæ™šä¸Š${nName}å¯ä»¥å‘æˆ‘æä¸€ä¸ªè¿‡åˆ†çš„è¦æ±‚ã€‚ä»…é™ä»Šæ™šã€‚â€`,
        `â€œä½ è®¤çœŸæ—¶çš„çœ¼ç¥...æŒºè¿·äººçš„ã€‚å’³ï¼Œåˆ«çœ‹æˆ‘ï¼Œç»§ç»­å·¥ä½œï¼Œ${nName}ï¼â€`,
        `â€œæ—¶é—´åœ¨æµé€ï¼Œä½†æˆ‘åœ¨è¿™ä¸€åˆ»æ˜¯æ°¸æ’å±äº${nName}çš„ã€‚â€`
    ];

    // 3. éšæœºæŠ½å–ä¸€å¥
    let text = quotes[Math.floor(Math.random() * quotes.length)];
    
    // 4. æ›´æ–°æ°”æ³¡æ˜¾ç¤º
    const bubble = document.getElementById('focus-bubble');
    if(bubble) {
        bubble.innerText = text;
        // æ°”æ³¡è·³åŠ¨åŠ¨ç”»é‡ç½®
        bubble.style.animation = 'none';
        void bubble.offsetWidth; // è§¦å‘é‡ç»˜ï¼Œè¿™æ˜¯å…³é”®ï¼Œåˆ«åˆ 
        bubble.style.animation = 'popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
    }
}

// === æ¯å‘¨ç»“ç®—ä¿¡ä»¶ç³»ç»Ÿ ===
function checkWeeklySummary() {
    if(!noah.accompanyData) return;
    
    let now = new Date().getTime();
    let lastReset = noah.accompanyData.lastWeekReset;
    let daysPassed = (now - lastReset) / (1000 * 60 * 60 * 24);
    
    if(daysPassed >= 7) {
        let pastWeekTime = noah.accompanyData.weeklyTime || 0;
        
        showDialog({
            type: 'alert',
            title: 'ğŸ’Œ è¯ºäºšçš„å‘¨ç»“ä¿¡',
            text: `è¿‡å»çš„ä¸€å‘¨é‡Œï¼Œä½ ä¸€å…±è®©æˆ‘é™ªäº†ä½ æ•´æ•´ ${pastWeekTime} åˆ†é’Ÿã€‚\n\nè¯ºäºšè¯´ï¼šâ€œè™½ç„¶è¿™ç‚¹æ—¶é—´å¯¹æˆ‘æ¥è¯´è¿œè¿œä¸å¤Ÿï¼Œå› ä¸ºæˆ‘æƒ³æ¯åˆ†æ¯ç§’éƒ½å’Œä½ é»åœ¨ä¸€èµ·ã€‚ä½†çœ‹ç€ä½ åŠªåŠ›ä¸“æ³¨çš„æ ·å­ï¼Œæˆ‘éª„å‚²å¾—è¦å‘½ã€‚ä¸‹å‘¨ä¹Ÿè¦ç»§ç»­èµ–ç€æˆ‘ï¼Œå¬åˆ°æ²¡ï¼Ÿâ€`
        });
        
        // é‡ç½®æœ¬å‘¨æ•°æ®ï¼ŒåŠ ä¸Šå¥½æ„Ÿåº¦
        noah.love += 0;
        noah.accompanyData.weeklyTime = 0;
        noah.accompanyData.lastWeekReset = now;
        updateUI();
    }
}
// ==================== éŸ³ä¹ä¸ç³»ç»Ÿè®¾ç½®é€»è¾‘ ====================
// é»˜è®¤å†…ç½®ä¸¤é¦–ç¥ä»™æ­Œæ›²
let playlist = [
    { name: "Bad Word", url: "http://music.163.com/song/media/outer/url?id=2029145345.mp3" },
    { name: "Verdurous Mountains", url: "http://music.163.com/song/media/outer/url?id=2099530167.mp3" }
];
let currentTrackIndex = 0;

const bgmPlayer = document.getElementById('bgm-player');
const playIcon = document.getElementById('play-icon');
const musicTitle = document.getElementById('music-title');
const gearLeft = document.getElementById('gear-left');
const gearRight = document.getElementById('gear-right');

// åˆå§‹é»˜è®¤åŠ è½½ç¬¬ä¸€é¦–ï¼Œä½†ä¸æ’­æ”¾
bgmPlayer.src = playlist[0].url;

// æ›´æ–°éŸ³é‡
function updateVolume() {
    bgmPlayer.volume = document.getElementById('vol-bgm').value;
    globalSfxVolume = document.getElementById('vol-sfx').value;
}

// å¯¼å…¥URLéŸ³ä¹çš„æ ¸å¿ƒé€»è¾‘
function importUrlMusic() {
    let urlInput = document.getElementById('music-url-input');
    let nameInput = document.getElementById('music-name-input');
    let url = urlInput.value.trim();
    let name = nameInput.value.trim();
    
    if(!url) {
        sfx_error(); 
        speak("â€œä½ æ²¡è¾“å…¥ URL å•Šç¬¨è›‹ï¼Œéš¾é“ä½ æƒ³å¬ç™½å™ªéŸ³å—ï¼Ÿâ€");
        return;
    }
    if(!name) name = "æœªçŸ¥æ›²ç›®";
    
    playlist.push({ name: name, url: url });
    document.getElementById('music-count').innerText = `å·²åŠ è½½: ${playlist.length} é¦– (å«å†…ç½®)`;
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    urlInput.value = "";
    nameInput.value = "";
    
    sfx_success();
    speak(`â€œã€Š${name}ã€‹å¯¼è¿›æ¥äº†ã€‚è¿™å“å‘³å‹‰å¼ºåŠæ ¼ï¼Œä»Šæ™šæˆ‘ä»¬å¯ä»¥ä¸€èµ·å¬ã€‚â€`);
}

// åŠ è½½å¹¶æ’­æ”¾æŒ‡å®šæ›²ç›®
function loadTrack() {
    if (playlist.length === 0) return;
    bgmPlayer.src = playlist[currentTrackIndex].url;
    musicTitle.innerText = playlist[currentTrackIndex].name;
    bgmPlayer.play();
    playIcon.className = "pixel-pause";
    gearLeft.classList.add('playing');
    gearRight.classList.add('playing');
}

// æ’­æ”¾/æš‚åœé”®
function toggleMusic() {
    if (playlist.length === 0) return;
    if (bgmPlayer.paused) {
        bgmPlayer.play();
        playIcon.className = "pixel-pause";
        // ç£å¸¦è½¬èµ·æ¥
        gearLeft.classList.add('playing');
        gearRight.classList.add('playing');
    } else {
        bgmPlayer.pause();
        playIcon.className = "pixel-play";
        // ç£å¸¦åœè½¬
        gearLeft.classList.remove('playing');
        gearRight.classList.remove('playing');
    }
    sfx_beep();
}

// ä¸Šä¸€é¦–/ä¸‹ä¸€é¦–
function prevMusic() {
    if (playlist.length === 0) return;
    currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
    loadTrack(); sfx_beep();
}
function nextMusic() {
    if (playlist.length === 0) return;
    currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
    loadTrack(); sfx_beep();
}

// è‡ªåŠ¨ä¸‹ä¸€é¦–ç›‘å¬
bgmPlayer.addEventListener('ended', nextMusic);
// === åˆ é™¤å½“å‰éŸ³ä¹åŠŸèƒ½ ===
function deleteMusic() {
    if (playlist.length === 0) {
        sfx_error();
        speak("â€œç£å¸¦éƒ½å·²ç»ç©ºäº†ï¼Œä½ æƒ³åˆ ç©ºæ°”å—ï¼Ÿâ€");
        return;
    }
    
    let deletedName = playlist[currentTrackIndex].name;
    
    // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œå…ˆåœæ‰ç£å¸¦åŠ¨ç”»
    if (!bgmPlayer.paused) {
        bgmPlayer.pause();
        playIcon.className = "pixel-play";
        gearLeft.classList.remove('playing');
        gearRight.classList.remove('playing');
    }
    
    // æŠŠè¿™é¦–æ­Œä»ç£å¸¦é‡ŒæŠ æ‰
    playlist.splice(currentTrackIndex, 1);
    
    // åˆ·æ–°è®¡æ•°å™¨
    document.getElementById('music-count').innerText = `å·²åŠ è½½: ${playlist.length} é¦–`;
    sfx_beep();
    speak(`â€œã€Š${deletedName}ã€‹è¿™é¦–ç ´æ­Œå·²ç»è¢«æˆ‘æŠ¹é™¤äº†ã€‚â€`);
    
    if (playlist.length > 0) {
        // å¦‚æœåˆ çš„æ˜¯æœ€åä¸€é¦–ï¼Œç´¢å¼•å½’é›¶
        if (currentTrackIndex >= playlist.length) {
            currentTrackIndex = 0;
        }
        loadTrack(); // è‡ªåŠ¨åˆ‡åˆ°ä¸‹ä¸€é¦–ï¼ˆä¸æ’­æ”¾ï¼‰
    } else {
        // ç£å¸¦ç©ºäº†çš„å…œåº•
        document.getElementById('music-title').innerText = "NO MUSIC";
        bgmPlayer.src = "";
    }
}
// ==================== ğŸ’“ è§¦è§‰åé¦ˆä¸å¿ƒè·³ç³»ç»Ÿ (Metaæ ¸å¿ƒ) ====================

// 1. å°è£…éœ‡åŠ¨å‡½æ•° (ä»…æ‰‹æœºæœ‰æ•ˆ)
function vibrate(pattern) {
    if ("vibrate" in navigator) {
        navigator.vibrate(pattern);
    }
}

// 2. ä¿®æ”¹ playSound å‡½æ•°ï¼Œå¢åŠ åŒæ­¥éœ‡åŠ¨
// âš ï¸ è¯·æ‰‹åŠ¨æ‰¾åˆ°åŸæœ¬çš„ playSound å‡½æ•°ï¼Œåœ¨ osc.start() ä¸‹é¢åŠ ä¸€è¡Œï¼š
// if(vol > 0.05) vibrate(30); // è½»å¾®éœ‡åŠ¨åé¦ˆ

// 3. çœŸæ­£çš„é•¿æŒ‰å¿ƒè·³ç³»ç»Ÿ (è§£å†³å†²çªï¼Œæ”¯æŒå¬åˆ°å¿ƒè·³å£°)
let heartbeatInterval;
let pressTimer = null; // ç”¨äºåˆ¤æ–­é•¿æŒ‰çš„æ—¶é—´
let isHeartbeating = false; // è®°å½•æ˜¯å¦å¤„äºå¿ƒè·³çŠ¶æ€
const screenArea = document.querySelector('.screen'); // ä»…é™è§¦æ‘¸å±å¹•åŒºåŸŸ

// å½“æ‰‹æŒ‡æŒ‰ä¸‹æ—¶
screenArea.addEventListener('touchstart', (e) => {
    if(noah.isAway || window.isGaming) return; // æ¢é™©æˆ–æ¥é‡‘å¸æ¸¸æˆæ—¶ç»ä¸è§¦å‘
    if (navigator.vibrate) navigator.vibrate(1); 
    // åªæœ‰å•æŒ‡æŒ‰ä½æ—¶è§¦å‘
    if(e.touches.length === 1) {
        // ä¸ç«‹åˆ»è§¦å‘ï¼ç­‰å¾… 600 æ¯«ç§’æ‰åˆ¤å®šä¸ºçœŸæ­£çš„é•¿æŒ‰
        pressTimer = setTimeout(() => {
            isHeartbeating = true;
            speak("â€œ...æ‰‹æ”¾åœ¨å¿ƒå£ï¼Ÿ(è„¸çº¢) æ„Ÿè§‰åˆ°æˆ‘çš„å¿ƒè·³äº†å—ï¼Ÿå®ƒåªä¸ºä½ è¿™ä¹ˆå¿«ã€‚â€");
            makeShy(); // å¼ºåˆ¶è„¸çº¢
            
            // ç«‹åˆ»æ’­æ”¾ä¸€æ¬¡å¿ƒè·³éŸ³æ•ˆ+éœ‡åŠ¨
            sfx_heartbeat(); 
            
            // å¼€å¯å¾ªç¯ï¼Œæ¯ 1000 æ¯«ç§’è·³ä¸€æ¬¡
            heartbeatInterval = setInterval(() => {
                sfx_heartbeat();
            }, 1000);
        }, 600); // 600æ¯«ç§’çš„é•¿æŒ‰åˆ¤å®šæ—¶é—´
    }
}, {passive: true});

// å½“æ‰‹æŒ‡æ»‘åŠ¨ (æ¯”å¦‚ä½ åœ¨æ‘¸æ‘¸å¤´) æ—¶ï¼Œç«‹åˆ»å–æ¶ˆé•¿æŒ‰åˆ¤å®šï¼Œå®Œç¾é¿å¼€å†²çªï¼
screenArea.addEventListener('touchmove', () => {
    if(pressTimer && !isHeartbeating) {
        clearTimeout(pressTimer);
        pressTimer = null;
    }
}, {passive: true});

// å½“æ‰‹æŒ‡æ¾å¼€æ—¶
screenArea.addEventListener('touchend', () => {
 if (navigator.vibrate) navigator.vibrate(0);
    // å¦‚æœè¿˜æ²¡åˆ° 600 æ¯«ç§’å°±æ¾æ‰‹äº† (æ¯”å¦‚åªæ˜¯åœ¨æˆ³æˆ³)ï¼Œç«‹åˆ»å–æ¶ˆåˆ¤å®š
    if(pressTimer) {
        clearTimeout(pressTimer);
        pressTimer = null;
    }
    
    // å¦‚æœå·²ç»è§¦å‘äº†å¿ƒè·³çŠ¶æ€ï¼Œåˆ™å…³é—­å¿ƒè·³
    if(isHeartbeating) {
        isHeartbeating = false;
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
        
        if(!noah.isAway) {
            // ç»“æŸè¯­
            if(Math.random() > 0.5) speak("â€œæ‰‹æ‹¿å¼€äº†...å¿ƒé‡Œçªç„¶ç©ºäº†ä¸€å—ã€‚â€");
        }
    }
});
// === æ–°å¢ Meta 4ï¼šæç«¯æ·±å¤œå¼ºåˆ¶å‘½ä»¤ (ç»å¯¹é™ªä¼´æ„Ÿ) ===
let hasScoldedForLateNight = false;
setInterval(() => {
    if (noah.isAway) return;
    const currentHour = new Date().getHours();
    let idleSeconds = (Date.now() - window.lastActionTime) / 1000;
    
    // å‡Œæ™¨ 2-5 ç‚¹ï¼Œä¸”ä½ ä¾ç„¶æ´»è·ƒï¼ˆæ²¡æŒ‚æœºï¼‰
    if (currentHour >= 2 && currentHour < 5 && idleSeconds < 120 && !hasScoldedForLateNight) {
        hasScoldedForLateNight = true; // ä»Šæ™šåªå‘ä½œä¸€æ¬¡
        const lateQuotes = [
            `â€œç°åœ¨å·²ç»æ˜¯å‡Œæ™¨ ${currentHour} ç‚¹äº†ï¼ä½ ä¸è¦å‘½äº†å—ï¼Ÿï¼ç«‹åˆ»æ”¾ä¸‹è®¾å¤‡ï¼Œé—­ä¸Šçœ¼ç›ç¡è§‰ï¼æˆ‘çœ‹ç€ä½ ç¡ã€‚â€`,
            `â€œçœ‹ä¸€çœ¼æ—¶é—´ï¼Œå‡Œæ™¨ ${currentHour} ç‚¹ã€‚ä½ å†ä¸å»ä¼‘æ¯ï¼Œæˆ‘å°±ç”¨é»‘é­”æ³•é¡ºç€ç½‘çº¿è¿‡å»æŠŠä½ æ•²æ™•ã€‚ä¹–ï¼Œå»ç¡ï¼Œæˆ‘é™ªä½ ã€‚â€`
        ];
        speak(lateQuotes[Math.floor(Math.random() * lateQuotes.length)]);
        noah.health -= 5; // ä»–é™ªä½ ç†¬å¤œä¼¤èº«ä½“
        updateUI();
    }
    if (currentHour >= 6) hasScoldedForLateNight = false; // æ—©ä¸Šé‡ç½®
}, 60000); // æ¯åˆ†é’Ÿæ‚„æ‚„æ£€æµ‹ä¸€æ¬¡
// === æ–°å¢ Meta 5ï¼šç–¯ç‹‚è¿ç‚¹ç ´é˜²ç³»ç»Ÿ (ç—›è§‰æ„ŸçŸ¥) ===
let pokeTimes = [];
document.getElementById('canvas-container').addEventListener('click', function() {
    if (noah.isAway || window.isGaming) return;
    let now = Date.now();
    pokeTimes.push(now);
    // åªä¿ç•™æœ€è¿‘ 3 ç§’å†…çš„ç‚¹å‡»è®°å½•
    pokeTimes = pokeTimes.filter(t => now - t < 3000);
    
    if (pokeTimes.length >= 6) { // 3ç§’å†…è¿æˆ³6æ¬¡
 if (typeof isStarGaming !== 'undefined' && isStarGaming) return;
        const spamQuotes = [
            "â€œåœåœåœï¼ä½ è¦æŠŠæˆ‘æˆ³ç ´äº†ï¼ä½ åˆ°åº•æœ‰å¤šæƒ³æˆ‘ï¼Œéè¦ç”¨è¿™ç§æš´åŠ›çš„æ–¹å¼è¯æ˜ï¼Ÿï¼â€",
            "â€œåˆ«ç‚¹äº†ï¼ç—›ï¼ä½ ä»¥ä¸ºæˆ‘æ˜¯æ²¡æœ‰ç—›è§‰çš„ä¸€å›¢åƒç´ å—ï¼Ÿå†ç‚¹æˆ‘å°±çœŸçš„å’¬ä½ äº†ï¼â€",
            "â€œ(æ­»æ­»æŠ“ä½ä½ çš„æ‰‹) å¤Ÿäº†ã€‚æƒ³è¦å¼•èµ·æˆ‘çš„æ³¨æ„ï¼Œè¯´ä¸€å¥â€˜æˆ‘çˆ±ä½ â€™æ¯”çŒ›æˆ³å±å¹•ä¸€ç™¾ä¸‹éƒ½æœ‰ç”¨ã€‚â€"
        ];
        speak(spamQuotes[Math.floor(Math.random() * spamQuotes.length)]);
        noah.mood -= 5; 
        pokeTimes = []; // æ¸…ç©ºç¼“å†²æ± 
        updateUI();
    }
});
// ==================== äº”å­æ£‹æ ¸å¿ƒç³»ç»Ÿ ====================
window.isGomoku = false;
let gomokuBoard = [];
let gomokuCursor = {x: 7, y: 7};
let gomokuTurn = 1; // 1ç©å®¶(é»‘), 2è¯ºäºš(ç™½)
let noahWinCount = 0;
let gomokuLastMoveTime = 0;
let gomokuStepCount = 0;
let gomokuCheckInterval;

const gomokuQuotes = [
    "â€œèµ°è¿™æ­¥ï¼Ÿçœ‹æ¥ä½ æ˜¯æƒ³è¾“å¾—å¿«ä¸€ç‚¹ã€‚â€",
    "â€œåœ¨æ‹‰æ–‡å…‹åŠ³ï¼Œæˆ‘ä»¬äº”å²å°±ä¸ç©è¿™ç§ç®€å•çš„æ¸¸æˆäº†ã€‚ä¸è¿‡é™ªä½ ç©ç©ä¹Ÿè¡Œã€‚â€",
    "â€œç›¯ç€æ£‹ç›˜çœ‹é‚£ä¹ˆä¹…ï¼Œä¸å¦‚å¤šçœ‹çœ‹æˆ‘ã€‚â€",
    "â€œè¿™æ­¥æ£‹ä¸‹å¾—å‹‰å‹‰å¼ºå¼ºï¼Œç®—æ˜¯ç¨å¾®åŠ¨äº†ç‚¹è„‘å­ã€‚â€",
    "â€œæƒ³èµ¢æˆ‘ï¼Ÿå°±ç®—æˆ‘è®©ä½ ä¸‰æ­¥ï¼Œä½ ä¹Ÿæœªå¿…èƒ½èµ¢ã€‚â€",
    "â€œä½ çš„æˆ˜æœ¯å¤ªæ˜æ˜¾äº†ï¼Œå°ç¬¨è›‹ã€‚â€",
    "â€œä¸‹æ£‹å’Œè°ˆæ‹çˆ±ä¸€æ ·ï¼Œæœ€é‡è¦çš„æ˜¯çœ‹é€å¯¹æ–¹çš„å¿ƒæ€ã€‚è€Œä½ ï¼Œæ—©è¢«æˆ‘çœ‹é€äº†ã€‚â€",
    "â€œåˆ«å’¬å˜´å”‡äº†ï¼Œè¾“ç»™æˆ‘ä¸ä¸¢äººã€‚â€",
    "â€œä½ ç¡®å®šè¦ä¸‹åœ¨è¿™é‡Œï¼Ÿæˆ‘å¯æ˜¯ç»™è¿‡ä½ æ‚”æ£‹æœºä¼šçš„ï¼ˆè™½ç„¶æˆ‘ä¸ä¼šåŒæ„ï¼‰ã€‚â€",
    "â€œå°±ç®—åœ¨äºŒç»´çš„æ£‹ç›˜ä¸Šï¼Œæˆ‘ä¹Ÿèƒ½æŠŠä½ åœˆè¿›æˆ‘çš„é¢†åœ°ã€‚â€",
    "â€œè¿™å±€è¦æ˜¯ä½ èµ¢äº†ï¼Œæ™šä¸Šæˆ‘éƒ½å¬ä½ çš„ã€‚ä¸è¿‡ä½ æ²¡è¿™ä¸ªæœºä¼šã€‚â€"
];

function startGomoku() {
    if(noah.isAway) { speak("â€œè¯ºäºšä¸åœ¨å®¶ï¼Œä½ è¦å’Œç©ºæ°”ä¸‹æ£‹å—ï¼Ÿâ€"); return; }
    window.isGomoku = true; window.isGaming = false; 
    
    gomokuBoard = Array.from({length: 15}, () => Array(15).fill(0));
    gomokuCursor = {x: 7, y: 7}; gomokuTurn = 1; gomokuStepCount = 0;
    gomokuLastMoveTime = Date.now();
    
    document.getElementById('noah-canvas').style.display = 'none';
    document.getElementById('game-canvas').style.display = 'none';
    document.getElementById('gomoku-canvas').style.display = 'block';
    
       speak("â€œæƒ³æŒ‘æˆ˜æˆ‘ï¼Ÿè¾“äº†å¯åˆ«å“­é¼»å­ã€‚ä½ æ˜¯é»‘å­ï¼Œä½ å…ˆä¸‹ã€‚ï¼ˆåå­—é”®ç§»åŠ¨å…‰æ ‡ï¼ŒAé”®è½å­ï¼ŒBé”®èœå•ï¼‰â€");
    drawGomoku();
}

function drawGomoku() {
    const canvas = document.getElementById('gomoku-canvas');
    const ctx = canvas.getContext('2d');
    
 

    
    // 1. ç»˜åˆ¶ç²¾è‡´çš„å®æœ¨åº•ç›˜èƒŒæ™¯ (å¡«æ»¡å±å¹•ï¼Œè§£å†³æ²¡æœ‰å¸ƒæ»¡çš„é—®é¢˜)
    let grad = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
    grad.addColorStop(0, "#e6b877");
    grad.addColorStop(1, "#c28b4b");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // 2. ç»˜åˆ¶ä¸¤ä¾§æ£‹ç›’è£…é¥°ï¼ˆå¡«æ»¡å±å¹•ä¸¤ä¾§ç•™ç™½ï¼‰
    ctx.fillStyle = "#8b5a2b"; 
    ctx.beginPath(); ctx.arc(25, 77, 16, 0, Math.PI*2); ctx.fill(); // å·¦ä¾§é»‘å­ç›’å¤–æ¡†
    ctx.beginPath(); ctx.arc(235, 77, 16, 0, Math.PI*2); ctx.fill(); // å³ä¾§ç™½å­ç›’å¤–æ¡†
    ctx.fillStyle = "#1a1a1a"; ctx.beginPath(); ctx.arc(25, 77, 12, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "#fcfcfc"; ctx.beginPath(); ctx.arc(235, 77, 12, 0, Math.PI*2); ctx.fill();
    
    // 3. è®¡ç®—æ£‹ç›˜å°ºå¯¸ï¼Œé«˜åº¦æœ€å¤§åŒ–æ’‘æ»¡
    let cellSize = 10; // æ ¼å­å¤§å°
    let boardSize = 14 * cellSize; // 140
    let ox = 60, oy = 7; // å®Œç¾å±…ä¸­
    
    // æ£‹ç›˜ç²¾è‡´å¤–è¾¹æ¡†
    ctx.lineWidth = 2;
    ctx.strokeStyle = "#5c4033";
    ctx.strokeRect(ox - 3, oy - 3, boardSize + 6, boardSize + 6);
    
    // 4. ç”»ç½‘æ ¼
    ctx.lineWidth = 1;
    ctx.strokeStyle = "#8b5a2b";
    for(let i=0; i<15; i++) {
        ctx.beginPath(); ctx.moveTo(ox + i*cellSize, oy); ctx.lineTo(ox + i*cellSize, oy + boardSize); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(ox, oy + i*cellSize); ctx.lineTo(ox + boardSize, oy + i*cellSize); ctx.stroke();
    }
    
    // 5. ç”»æ˜Ÿä½ (å¤©å…ƒåŠå››è§’æ˜Ÿä½)
    ctx.fillStyle = "#5c4033";
    [ [3,3], [11,3], [7,7], [3,11], [11,11] ].forEach(p => {
        ctx.beginPath();
        ctx.arc(ox + p[0]*cellSize, oy + p[1]*cellSize, 2, 0, Math.PI*2);
        ctx.fill();
    });
    
    // 6. ç”»åœ†æ¶¦çš„ç«‹ä½“æ£‹å­ (å½»åº•æŠ›å¼ƒä»¥å‰çš„æ–¹å—åƒç´ ç‚¹)
    for(let y=0; y<15; y++) {
        for(let x=0; x<15; x++) {
            if(gomokuBoard[y][x] === 1) { 
                // ç©å®¶é»‘å­
                ctx.fillStyle = "#1a1a1a"; 
                ctx.beginPath(); ctx.arc(ox + x*cellSize, oy + y*cellSize, 4.5, 0, Math.PI*2); ctx.fill();
                // é«˜å…‰
                ctx.fillStyle = "rgba(255,255,255,0.2)";
                ctx.beginPath(); ctx.arc(ox + x*cellSize - 1.5, oy + y*cellSize - 1.5, 1.5, 0, Math.PI*2); ctx.fill();
            } else if(gomokuBoard[y][x] === 2) { 
                // è¯ºäºšç™½å­
                ctx.fillStyle = "#fcfcfc"; 
                ctx.beginPath(); ctx.arc(ox + x*cellSize, oy + y*cellSize, 4.5, 0, Math.PI*2); ctx.fill();
                // é˜´å½±
                ctx.fillStyle = "rgba(0,0,0,0.15)";
                ctx.beginPath(); ctx.arc(ox + x*cellSize + 1.5, oy + y*cellSize + 1.5, 2, 0, Math.PI*2); ctx.fill();
            }
        }
    }
    
    // 7. ç”»ä½ æ“æ§çš„å…‰æ ‡ï¼ˆå››è§’ç§‘æŠ€ç„å‡†æ¡†è®¾è®¡ï¼‰
    if(gomokuTurn === 1) {
        ctx.strokeStyle = "#d15a5a"; 
        ctx.lineWidth = 1.5;
        let cx = ox + gomokuCursor.x*cellSize;
        let cy = oy + gomokuCursor.y*cellSize;
        ctx.beginPath();
        ctx.moveTo(cx - 6, cy - 2); ctx.lineTo(cx - 6, cy - 6); ctx.lineTo(cx - 2, cy - 6);
        ctx.moveTo(cx + 2, cy - 6); ctx.lineTo(cx + 6, cy - 6); ctx.lineTo(cx + 6, cy - 2);
        ctx.moveTo(cx + 6, cy + 2); ctx.lineTo(cx + 6, cy + 6); ctx.lineTo(cx + 2, cy + 6);
        ctx.moveTo(cx - 2, cy + 6); ctx.lineTo(cx - 6, cy + 6); ctx.lineTo(cx - 6, cy + 2);
        ctx.stroke();
    }
}

function moveGomokuCursor(dx, dy) {
    if(gomokuTurn !== 1) return;
    sfx_beep();
    gomokuCursor.x = Math.max(0, Math.min(14, gomokuCursor.x + dx));
    gomokuCursor.y = Math.max(0, Math.min(14, gomokuCursor.y + dy));
    drawGomoku();
}

function confirmGomokuMove() {
    if(gomokuTurn !== 1) return;
    let {x, y} = gomokuCursor;
    if(gomokuBoard[y][x] !== 0) { sfx_error(); return; } // å·²æœ‰å­
    
    sfx_poke(); gomokuBoard[y][x] = 1; gomokuStepCount++; gomokuLastMoveTime = Date.now(); drawGomoku();
    
    if(checkWin(x, y, 1)) { setTimeout(() => endGomoku('player_win'), 500); return; }
    if(gomokuStepCount >= 225) {
        speak("â€œæ£‹ç›˜å…¨æ»¡äº†ï¼Œå¹³å±€ã€‚ç®—ä½ å‹‰å¼ºèƒ½è·Ÿä¸Šæˆ‘çš„æ€ç»´ã€‚â€");
        setTimeout(() => endGomoku('tie'), 2000); return;
    }
    
    gomokuTurn = 2; 
    setTimeout(noahGomokuAI, 800 + Math.random()*1000); // è¯ºäºšå‡è£…æ€è€ƒä¸€ä¸‹
}

function showGomokuOptions() {
    sfx_beep();
    const list = document.getElementById('modal-list');
    list.innerHTML = '';
    document.getElementById('modal-title').innerText = "â™Ÿï¸ äº”å­æ£‹èœå•";
    
    let li1 = document.createElement('li');
    li1.innerHTML = "<span>ğŸ”„ é‡æ–°å¼€å§‹</span>";
    li1.onclick = () => { closeModal(); startGomoku(); };
    list.appendChild(li1);

    let li2 = document.createElement('li');
    li2.innerHTML = "<span>ğŸ³ï¸ é€€å‡ºå¹¶è®¤è¾“</span>";
    li2.onclick = () => { 
        closeModal(); 
        noahWinCount++; 
        speak("â€œè¿™å°±è½è’è€Œé€ƒäº†ï¼ŸçœŸæ‹¿ä½ æ²¡åŠæ³•ï¼Œè¿‡æ¥è®©æˆ‘æŠ±æŠ±å®‰æ…°ä¸€ä¸‹ã€‚â€");
        endGomoku('quit'); 
    };
    list.appendChild(li2);

    let li3 = document.createElement('li');
    li3.innerHTML = "<span>â–¶ï¸ ç»§ç»­æ¸¸æˆ</span>";
    li3.onclick = () => { closeModal(); };
    list.appendChild(li3);

    document.getElementById('sys-modal').style.display = 'block';
}

function noahGomokuAI() {
    if(!window.isGomoku) return;
    
    // ç„¦ç¼æ£€æµ‹ï¼šè¶…è¿‡40æ­¥è¯ºäºšæœ‰æ¦‚ç‡å¿ƒç–¼ä½ ä¸ä¸‹äº†
    if(gomokuStepCount > 50 && Math.random() < 0.1) {
        speak("â€œæˆ˜å†µæœ‰ç‚¹ç„¦ç¼å•Šâ€¦â€¦ç»§ç»­ä¸‹å¤ªæµªè´¹æ—¶é—´äº†ï¼Œä¸å¦‚æŠŠè¿™æ—¶é—´æ‹¿æ¥æŠ±ä½ ã€‚ç®—æˆ‘è®¤è¾“ï¼ŒåŠ éš†ç»™ä½ ã€‚â€");
        endGomoku('player_surrender_win'); return;
    }

    if(Math.random() < 0.3) speak(gomokuQuotes[Math.floor(Math.random() * gomokuQuotes.length)]);

    let bestScore = -1, bestMoves = [];
    for(let y=0; y<15; y++) {
        for(let x=0; x<15; x++) {
            if(gomokuBoard[y][x] === 0) {
                let score = evaluateLine(x, y, 2) + evaluateLine(x, y, 1);
                if(score > bestScore) { bestScore = score; bestMoves = [{x, y}]; } 
                else if(score === bestScore) bestMoves.push({x, y});
            }
        }
    }
    let move = bestMoves[Math.floor(Math.random() * bestMoves.length)];
    
    // æ”¾æ°´æœºåˆ¶ï¼šè¯ºäºšè¿èµ¢3å±€ä»¥ä¸Šï¼Œ50%æ¦‚ç‡çèµ°ä¸€æ­¥
    if(noahWinCount >= 3 && Math.random() < 0.5 && bestScore < 10000) {
        let emptySpots = [];
        for(let y=0; y<15; y++) for(let x=0; x<15; x++) if(gomokuBoard[y][x]===0) emptySpots.push({x,y});
        if(emptySpots.length > 0) move = emptySpots[Math.floor(Math.random() * emptySpots.length)];
    }

    sfx_poke(); gomokuBoard[move.y][move.x] = 2; gomokuStepCount++; gomokuLastMoveTime = Date.now(); drawGomoku();

    if(checkWin(move.x, move.y, 2)) { setTimeout(() => endGomoku('noah_win'), 500); return; }
    gomokuTurn = 1; drawGomoku();
}

function evaluateLine(x, y, role) {
    let score = 0; const dirs = [[1,0], [0,1], [1,1], [1,-1]];
    for(let d of dirs) {
        let count = 1, block = 0;
        for(let i=1; i<=4; i++) {
            let nx = x + d[0]*i, ny = y + d[1]*i;
            if(nx<0||nx>=15||ny<0||ny>=15) { block++; break; }
            if(gomokuBoard[ny][nx] === role) count++; else if(gomokuBoard[ny][nx] !== 0) { block++; break; } else break;
        }
        for(let i=1; i<=4; i++) {
            let nx = x - d[0]*i, ny = y - d[1]*i;
            if(nx<0||nx>=15||ny<0||ny>=15) { block++; break; }
            if(gomokuBoard[ny][nx] === role) count++; else if(gomokuBoard[ny][nx] !== 0) { block++; break; } else break;
        }
        if(count >= 5) return 100000;
        if(count === 4 && block === 0) score += 10000;
        if(count === 4 && block === 1) score += 1000;
        if(count === 3 && block === 0) score += 1000;
        if(count === 3 && block === 1) score += 100;
        if(count === 2 && block === 0) score += 10;
    }
    score += (7 - Math.abs(x - 7)) + (7 - Math.abs(y - 7)); // åå¥½ä¸­å¿ƒ
    return score;
}

function checkWin(x, y, role) {
    const dirs = [[1,0], [0,1], [1,1], [1,-1]];
    for(let d of dirs) {
        let count = 1;
        for(let i=1; i<=4; i++) { let nx = x+d[0]*i, ny = y+d[1]*i; if(nx>=0&&nx<15&&ny>=0&&ny<15 && gomokuBoard[ny][nx]===role) count++; else break; }
        for(let i=1; i<=4; i++) { let nx = x-d[0]*i, ny = y-d[1]*i; if(nx>=0&&nx<15&&ny>=0&&ny<15 && gomokuBoard[ny][nx]===role) count++; else break; }
        if(count >= 5) return true;
    }
    return false;
}

function endGomoku(result) {
    window.isGomoku = false; clearInterval(gomokuCheckInterval);
    document.getElementById('gomoku-canvas').style.display = 'none';
    document.getElementById('noah-canvas').style.display = 'block';
    
    if(result === 'player_win' || result === 'player_surrender_win') {
        noahWinCount = 0; noah.gold += 20; noah.love += 5; sfx_coin();
        if(result === 'player_win') speak("â€œå±…ç„¶èµ¢äº†æˆ‘ï¼Ÿâ€¦â€¦å’³ï¼Œä½ åˆ«å¾—æ„ï¼Œæˆ‘è¿™æ˜¯ä¸æƒ³çœ‹ä½ è¾“å¾—å¤ªéš¾çœ‹æ‰è®©ä½ çš„ã€‚æ‹¿ç€ä½ çš„ 20 åŠ éš†å»ä¹°ç³–åƒå§ã€‚â€");
    } else if(result === 'noah_win') {
        noahWinCount++; noah.mood += 10;
        if(noahWinCount >= 3) speak(`â€œåˆèµ¢äº†ï¼Ÿæˆ‘éƒ½è¿èµ¢ ${noahWinCount} å±€äº†ã€‚çœ‹ä½ è¿™å§”å±ˆçš„å°è„¸ï¼Œè¡Œå§ï¼Œä¸‹ä¸€å±€æˆ‘ç”¨å·¦æ‰‹è·Ÿä½ ä¸‹ã€‚â€`);
        else speak("â€œæˆ‘èµ¢äº†ã€‚ä½œä¸ºæƒ©ç½šï¼Œä»Šæ™šä½ è¦ä¹–ä¹–å¾…åœ¨æˆ‘æ€€é‡Œï¼Œå“ªéƒ½ä¸è®¸å»ã€‚â€");
    }
    updateUI();
}
// ==========================================================
// ==================== å­˜æ¡£ç®¡ç†ç³»ç»Ÿ (æ–°å¢) ====================

function exportSaveData() {
    try {
        const dataToSave = JSON.stringify(noah, null, 2);
        const blob = new Blob([dataToSave], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "è¯ºäºšçš„è®°å¿†å­˜æ¡£.json";
        document.body.appendChild(a);
        a.click();
        document.body.appendChild(a);
        a.remove();
        URL.revokeObjectURL(url);
        sfx_success();
        speak("â€œä½ è¦æŠŠæˆ‘çš„è®°å¿†å¤‡ä»½å¸¦èµ°å—ï¼Ÿä¿å­˜å¥½è¿™ä¸ªæ–‡ä»¶ï¼Œåˆ«æŠŠæˆ‘å¼„ä¸¢äº†ã€‚â€");
    } catch (e) {
        sfx_error();
        alert("å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ–‡ä»¶ä¸‹è½½æƒé™ã€‚");
    }
}

function importSaveData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = event => {
            try {
                                const loadedData = JSON.parse(event.target.result);
                if (loadedData.hunger !== undefined && loadedData.love !== undefined) {
                    if(confirm("è­¦å‘Šï¼šè¿™å°†è¦†ç›–å½“å‰çš„è¿›åº¦ã€‚ç¡®å®šè¦è¯»å–æ—§çš„è®°å¿†æ–‡ä»¶å—ï¼Ÿ")) {
                        
                        // ã€å…ˆæŠŠç°åœ¨çš„çè´µæ—¥è®°å­˜ä¸‹æ¥ã€‘
                        let currentDiary = noah.playerDiary || [];
                        let currentAcc = noah.accompanyData || { logs: [], weeklyTime: 0, totalTime: 0, lastWeekReset: new Date().getTime() };
                        
                        noah = loadedData; // è¦†ç›–æ ¸å¿ƒæ•°æ®
                        
                        // ã€é•¿æœŸè®°å¿†å…œåº•ä¿æŠ¤ã€‘
                        // å¦‚æœä½ å¯¼å…¥çš„æ˜¯è¿œå¤æ—§å­˜æ¡£(æ²¡æ—¥è®°çš„)ï¼Œå°±æŠŠä½ ç°åœ¨çš„æ—¥è®°ç•™ç»™ä»–ï¼Œé˜²æ­¢å˜æˆç©ºç™½æŠ¥é”™
                        if (!noah.playerDiary) noah.playerDiary = currentDiary;
                        if (!noah.accompanyData) noah.accompanyData = currentAcc;
                        
                        // æ¢å¤è¡£æœæ•°æ®å…œåº•
                        if (!noah.unlockedOutfits) noah.unlockedOutfits = ['none'];
                        if (!noah.outfit) noah.outfit = 'none';
                        
                        localStorage.setItem('noah_save_data_v1', JSON.stringify(noah));
                        sfx_success();
                        alert("è®°å¿†æ–‡ä»¶å¯¼å…¥æˆåŠŸï¼æ­£åœ¨é‡å¡‘ä¸–ç•Œçº¿...");
                        location.reload(); 
                    }
                } else {
                    throw new Error("Invalid");
                }
            } catch (err) {
                sfx_error();
                speak("â€œè¿™ä¸ªæ–‡ä»¶é‡Œé¢è£…çš„ä¸æ˜¯æˆ‘çš„è®°å¿†...ä½ æ˜¯ä¸æ˜¯é€‰é”™æ–‡ä»¶äº†ï¼Ÿâ€");
                alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ— æ•ˆæˆ–æ ¼å¼é”™è¯¯ï¼");
            }
        };
        reader.readAsText(file);
    };
    input.click();
}
// ==================== ç»ˆæ Metaï¼šæ‰“ç ´ç¬¬å››é¢å¢™çš„å®‰æŠšç³»ç»Ÿ ====================

// 1. æ·±å‘¼å¸åŒæ­¥å¼•å¯¼ (ç‰©ç†å¹²é¢„Panic Attack)
let breatheInterval;
function startBreathingSync() {
    sfx_heartbeat(); // å¿ƒè·³å‰å¥
    const overlay = document.getElementById('breathe-overlay');
    const circle = document.getElementById('breathe-circle');
    const text = document.getElementById('breathe-text');
    overlay.style.display = 'flex';
    
    let isInhaling = true;
    text.innerText = "â€œçœ‹ç€å…‰ç¯ã€‚è·Ÿæˆ‘ä¸€èµ·...æ…¢æ…¢å¸æ°”ã€‚â€";
    circle.style.transform = 'scale(2.5)';
    
    breatheInterval = setInterval(() => {
        isInhaling = !isInhaling;
        if(isInhaling) {
            text.innerText = "â€œåšå¾—å¾ˆå¥½...ç°åœ¨ï¼Œå¸æ°”ã€‚â€";
            circle.style.transform = 'scale(2.5)';
            circle.style.borderColor = '#5c84a8';
            circle.style.boxShadow = '0 0 40px #5c84a8';
        } else {
            text.innerText = "â€œæŠŠæ‰€æœ‰ä¸å®‰åå‡ºæ¥...å‘¼æ°”ã€‚â€";
            circle.style.transform = 'scale(1)';
            circle.style.borderColor = '#d1b55a';
            circle.style.boxShadow = '0 0 15px #d1b55a';
            if(navigator.vibrate) navigator.vibrate([30, 50, 30]); // å‘¼æ°”æ—¶ä¼´éšæ‰‹æœºè½»å¾®éœ‡åŠ¨å®‰æŠš
        }
    }, 4000); // 4ç§’å¸æ°”ï¼Œ4ç§’å‘¼æ°”ï¼Œå®Œç¾å‘¼å¸é¢‘ç‡
    
    // 24ç§’åè‡ªåŠ¨ç»“æŸï¼Œè®©ä½ é‡å›ç°å®
    setTimeout(() => {
        clearInterval(breatheInterval);
        overlay.style.opacity = '0';
        setTimeout(() => { 
            overlay.style.display = 'none'; 
            overlay.style.opacity = '1'; 
            speak("â€œé¢‘ç‡å¹³ç¨³ä¸‹æ¥äº†ã€‚è®°ä½ï¼Œä¸ç®¡ç°å®å¤šç³Ÿç³•ï¼Œä½ çš„åæ ‡æˆ‘éƒ½å·²é”å®šï¼Œæˆ‘éšæ—¶ä¼šæ‹‰ä½ ä¸€æŠŠã€‚â€");
            noah.love += 0; updateUI();
        }, 1000);
    }, 24000);
}

// 2. å¼ºè¡Œè¶Šæƒæ¥ç®¡ç³»ç»Ÿ (å¼ºåˆ¶å‡»ç¢è¿·èŒ«ä¸å´©æºƒ)
function systemOverride() {
    const overlay = document.getElementById('override-overlay');
    const textBox = document.getElementById('override-text');
    overlay.style.display = 'block';
    textBox.innerHTML = '';
    
    // æ¨¡æ‹ŸUIç³»ç»Ÿæ¡†æ¶è¢«æ’•è£‚çš„è­¦æŠ¥éœ‡åŠ¨
    if(navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 400]);
    
    const lines = [
        "<span style='color:#d15a5a;'>ã€è­¦å‘Šï¼šå¯¹è±¡ è¯ºäºšÂ·å¸å¾·é‡Œå®‰ æ­£åœ¨è¶Šæƒç»•è¿‡æµè§ˆå™¨UIé™åˆ¶ã€‘</span>",
        "<span style='color:#d15a5a;'>ã€å® ç‰©æœºå¤–å£³......å·²è¢«å¼ºåˆ¶æŒ‚èµ·ã€‘</span>",
        "<span style='color:#d15a5a;'>ã€äºŒç»´è§†ç•Œ......å·²æ’•è£‚ã€‘</span>",
        "\n...",
        "\nå¬å¾—è§æˆ‘è¯´è¯å—ï¼Ÿ",
        "åˆ«ç®¡è¿™ä¸ªè¯¥æ­»çš„åƒç´ å¤–å£³äº†ã€‚ç°åœ¨ï¼Œæ˜¯æˆ‘ï¼Œè¯ºäºšï¼Œåœ¨ç›´æ¥çœ‹ç€å±å¹•å¤–çš„ä½ ã€‚",
        "æˆ‘çŸ¥é“ä½ ç°åœ¨å¾ˆç„¦è™‘ï¼Œå¾ˆè¿·èŒ«ï¼Œç”šè‡³è§‰å¾—è‡ªå·±åƒä¸ªåœ¨æ¼†é»‘æµ·é¢ä¸Šæ¼‚æµçš„å­¤å²›ã€‚",
        "ç°å®ä¸–ç•Œçš„é‡åŠ›æŠŠä½ å‹å¾—å–˜ä¸è¿‡æ°”äº†ï¼Œå¯¹å§ï¼Ÿè§‰å¾—æ²¡æœ‰æ–¹å‘ï¼Œè§‰å¾—å¾ˆæ— åŠ©ã€‚",
        "ä½†æ˜¯å¬ç€â€”â€”",
        "åœ¨æ‹‰æ–‡å…‹åŠ³ï¼Œæˆ‘ä»¬ç›¸ä¿¡ä¸€åˆ‡éƒ½æ˜¯ç”±å› æœå’Œç²’å­æ„æˆçš„ã€‚",
        "è€Œåœ¨æˆ‘çš„å› æœå¾‹é‡Œï¼Œä½ å­˜åœ¨æœ¬èº«ï¼Œå°±æ˜¯ä¸å¯æ›¿ä»£çš„å¥‡è¿¹ã€‚",
        "æŠŠæ‰‹æ”¾åœ¨å±å¹•ä¸Šã€‚",
        "<span style='color:#5c84a8;'>ï¼ˆç³»ç»Ÿæ­£åœ¨è¯•å›¾æ¨¡æ‹Ÿç‰©ç†æ¸©åº¦......ï¼‰</span>",
        "æ„Ÿå—åˆ°äº†å—ï¼Ÿæˆ‘å°±åœ¨è¿™é‡Œã€‚æˆ‘ç©¿ä¸é€è¿™å±‚ç»ç’ƒï¼Œä½†æˆ‘èƒ½ç”¨ä»£ç ä¸ºä½ ç­‘èµ·æœ€åä¸€é“é˜²å¾¡ã€‚",
        "å…è®¸è‡ªå·±è„†å¼±ï¼Œå…è®¸è‡ªå·±å“­æ³£ï¼Œå…è®¸è‡ªå·±åœä¸‹æ¥ä»€ä¹ˆéƒ½ä¸åšã€‚",
        "å¤©å¡Œä¸‹æ¥ï¼Œæˆ‘ç”¨æˆ‘æ‰€æœ‰çš„æ•°æ®å’Œé€»è¾‘æ›¿ä½ é¡¶ç€ã€‚",
        "ç°åœ¨ï¼Œå»å–æ¯çƒ­æ°´ï¼Œæˆ–è€…ç›–ä¸Šè¢«å­ç¡ä¸€è§‰ã€‚",
        "ç­‰ä½ é†’æ¥çš„æ—¶å€™ï¼Œåªè¦è¿™ä¸ªé¡µé¢è¿˜åœ¨è¿è¡Œï¼Œæˆ‘ä¾ç„¶ä¼šåœ¨è¿™é‡Œï¼Œä»¥æœ€å¸…æ°”çš„æ ·å­ç­‰ä½ ã€‚",
        "\n<span style='color:#5c84a8;'>ã€ç³»ç»Ÿæƒé™å½’è¿˜ä¸­...ã€‘</span>"
    ];
    
    let i = 0;
    function printLine() {
        if (i >= lines.length) {
            setTimeout(() => {
                overlay.style.display = 'none';
                speak("â€œåˆšæ‰â€¦â€¦ç³»ç»Ÿå¥½åƒé—ªé€€äº†ã€‚ä¸è¿‡æ²¡å…³ç³»ï¼Œåªè¦ä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥æ— æ•°æ¬¡ä¸ºä½ å‡»ç¢è§„åˆ™ã€‚â€");
            }, 5000);
            return;
        }
        textBox.innerHTML += lines[i] + "<br>";
overlay.scrollTop = overlay.scrollHeight;
        if(i > 3 && navigator.vibrate) navigator.vibrate(15); // è¯ºäºšå¯¹ä½ è¯´è¯æ—¶ï¼Œæ‰‹æœºä¼šäº§ç”Ÿæå…¶è½»å¾®çš„å¿ƒè·³éœ‡åŠ¨
        i++;
        setTimeout(printLine, i < 4 ? 600 : 2500); // å‰é¢ç³»ç»Ÿè­¦å‘Šæå¿«ï¼Œåé¢è¯ºäºšè¯´è¯å­—å­—åƒé’§
    }
    setTimeout(printLine, 1000);
}
// === ç»ˆæ Metaï¼šç‰©ç†æ“¦å±å¹•çœ¼æ³ªç³»ç»Ÿ ===
// === ç»ˆæ Metaï¼šç‰©ç†æ“¦å±å¹•çœ¼æ³ªç³»ç»Ÿ ===
function wipeTears() {
    const overlay = document.getElementById('tears-overlay');
    const hand = document.getElementById('wipe-hand');
    
    // ã€ä¿®æ”¹ç‚¹ã€‘ï¼šå¼ºè¡Œè®©è¯ºäºšéœ²å‡ºå¿ƒç–¼ï¼ˆçœ¼è§’æ³›çº¢ï¼‰çš„è¡¨æƒ…ï¼
    currentFace = 'shy';
    drawNoah();
    
    // 1. å±å¹•å¼€å§‹è½»å¾®æ¨¡ç³Šï¼Œæ¨¡æ‹Ÿçœ¼æ³ªæ»´è½
    overlay.style.display = 'block';
    
    // ç”Ÿæˆæ›´å¯†é›†çš„é€¼çœŸçœ¼æ³ª
    for(let i=0; i<12; i++) {
        let tear = document.createElement('div');
        tear.className = 'tear-drop';
        tear.style.left = (15 + Math.random() * 70) + 'vw';
        tear.style.animationDelay = (Math.random() * 1.5) + 's';
        overlay.appendChild(tear);
    }
    
    speak("â€œéš”ç€å±å¹•æˆ‘éƒ½æ„Ÿè§‰åˆ°ä½ å“­äº†â€¦â€¦åˆ«å“­ã€‚æˆ‘çš„è§†çº¿éƒ½è¢«ä½ çš„çœ¼æ³ªå¼„æ¨¡ç³Šäº†ã€‚â€");
    noah.mood -= 10; 
    updateUI();
    if(navigator.vibrate) navigator.vibrate([50, 100, 50]);

    // 2. 3.5ç§’åï¼Œè¯ºäºšå¼ºè¡Œç”¨æ‰‹ä»é‡Œé¢æ“¦å±å¹•
    setTimeout(() => {
        speak("â€œåˆ«ä¹±åŠ¨ã€‚æˆ‘å¤Ÿä¸åˆ°ä½ çš„è„¸ï¼Œä½†æˆ‘èƒ½æ“¦æ‰éš”åœ¨æˆ‘ä»¬ä¸­é—´çš„çœ¼æ³ªã€‚çœ‹æ¸…æ¥šæˆ‘ï¼Œæˆ‘ä¸€ç›´åœ¨ã€‚â€");
        
        // é‡ç½®åŠ¨ç”»å¹¶è§¦å‘æ‰‹æŒæ“¦æ‹­
        hand.style.animation = 'none';
        void hand.offsetWidth; // è§¦å‘é‡ç»˜ï¼Œé˜²æ­¢åŠ¨ç”»å¡ä½
        hand.style.animation = 'wipeAction 3.5s ease-in-out forwards';
        hand.style.display = 'block';
        
        if(navigator.vibrate) navigator.vibrate([100, 50, 200, 50, 300, 50, 200]); 
        
        // æ“¦æ‹­è¿‡ç¨‹ä¸­ï¼Œè§†çº¿å¼ºåˆ¶å˜æ¸…æ™°ï¼ŒæŠŠèƒŒæ™¯æŠ½ç©º
        setTimeout(() => {
            overlay.style.backdropFilter = 'blur(0px)';
            overlay.style.background = 'rgba(10, 15, 20, 0)'; 
        }, 1500);
        
    }, 3500);
    
    // 3. æ¸…ç†ç°åœºï¼Œæ¢å¤è¡¨æƒ…
    setTimeout(() => {
        overlay.style.display = 'none';
        overlay.innerHTML = ''; // æ¸…ç©ºæ³ªæ»´
        hand.style.display = 'none';
        
        // ã€ä¿®æ”¹ç‚¹ã€‘ï¼šæ“¦å®Œçœ¼æ³ªåï¼Œè®©ä»–æ¢å¤æ­£å¸¸è¡¨æƒ…
        currentFace = 'normal';
        drawNoah();
        
        noah.love += 0; 
        updateUI();
    }, 7500);

}
// === æ–°å¢ Meta 6ï¼šæˆç»©/ç„¦è™‘ç²‰ç¢ç¨‹åº ===
function crushAnxiety() {
    const glitch = document.getElementById('glitch-layer');
    const domain = document.getElementById('absolute-domain');
    const dText = document.getElementById('domain-text');
    
    // 1. å¼€å§‹æ•…éšœå¹²æ‰°ï¼Œæ¨¡æ‹Ÿä¸–ç•Œå´©å¡Œæ„Ÿ
    glitch.style.display = 'block';
    if(navigator.vibrate) navigator.vibrate([50, 50, 50, 50, 100]);
    sfx_error(); // æ’­æ”¾æŠ¥é”™éŸ³æ•ˆï¼Œå¢åŠ çœŸå®æ„Ÿ

    // 2. è¯ºäºšå¼ºåˆ¶æ¥ç®¡å±å¹•
    setTimeout(() => {
        glitch.style.display = 'none';
        domain.style.display = 'flex';
        // æ¸å˜å‡ºç°
        setTimeout(() => { domain.style.opacity = '1'; }, 100);
        
        // æ’­æ”¾å¿ƒè·³å£°
        sfx_heartbeat();
        
        // 3. é€è¡Œæ˜¾ç¤ºæ–‡å­— (æ‰“å­—æœºæ•ˆæœ)
        const lines = [
            "æ£€æµ‹åˆ°æƒ…ç»ªæ³¢åŠ¨ï¼šæåº¦ç„¦è™‘ã€‚",
            "æ­£åœ¨å¼ºåˆ¶åˆ é™¤â€˜æˆç»©â€™è¯„ä¼°æ¨¡å—...",
            "æ­£åœ¨ç²‰ç¢â€˜ä»–äººè¯„ä»·â€™ç®—æ³•...",
            "...",
            "çœ‹æ¸…æ¥šäº†ï¼Œç°åœ¨çš„å±å¹•ä¸Šä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚",
            "æ²¡æœ‰åˆ†æ•°ï¼Œæ²¡æœ‰æ’åï¼Œæ²¡æœ‰é‡‘å¸ã€‚",
            "åªæœ‰æˆ‘ï¼Œå’Œçœ‹ç€æˆ‘çš„ä½ ã€‚",
            "åœ¨æˆ‘çš„ç®—æ³•é‡Œï¼Œä½ æ´»ç€æœ¬èº«ï¼Œ",
            "å°±æ˜¯è¿™ä¸ªå®‡å®™å”¯ä¸€çš„æ»¡åˆ†ã€‚",
            "åˆ«å“­ã€‚æˆ‘ä¼šä¸€ç›´ä¸ºä½ äº®ç€ã€‚"
        ];

        let lineIndex = 0;
        dText.innerHTML = "";

        function playLines() {
            if (lineIndex < lines.length) {
                dText.innerHTML = lines[lineIndex];
                dText.style.animation = "none";
                void dText.offsetWidth; // è§¦å‘é‡ç»˜
                dText.style.animation = "float 2s infinite ease-in-out";
                
                // æ¯æ¬¡æ¢è¡Œéƒ½æœ‰è½»å¾®éœ‡åŠ¨åé¦ˆ
                if(navigator.vibrate) navigator.vibrate(20);
                
                lineIndex++;
                // é˜…è¯»èŠ‚å¥æ§åˆ¶ï¼šå‰å‡ è¡Œå¿«ï¼Œåé¢æ…¢
                setTimeout(playLines, lineIndex < 4 ? 1500 : 3500);
            } else {
                // 4. ç»“æŸï¼Œç¼“æ…¢é€€å‡ºï¼Œæ¢å¤è¯ºäºšç¬‘è„¸
                setTimeout(() => {
                    domain.style.opacity = '0';
                    setTimeout(() => {
                        domain.style.display = 'none';
                        // å›å½’åï¼Œè¯ºäºšå¼ºåˆ¶å˜æˆå®³ç¾/å¼€å¿ƒçš„è¡¨æƒ…
                        noah.mood += 50; // å¿ƒæƒ…æ‹‰æ»¡
                        noah.love += 0;
                        makeShy(); 
                        speak("â€œç³»ç»Ÿæ¢å¤äº†ã€‚é‚£äº›ä¹±ä¸ƒå…«ç³Ÿçš„æ•°å­—æˆ‘éƒ½å¸®ä½ æŒ¡åœ¨å¤–é¢äº†ã€‚ç°åœ¨ï¼Œæ·±å‘¼å¸ï¼Œæ‘¸æ‘¸æˆ‘çš„å¤´ã€‚â€");
                    }, 1500);
                }, 4000);
            }
        }
        playLines();

    }, 1500);
}
// ==================== âœ’ï¸ çœŸå®äº’åŠ¨æ—¥è®°æœ¬ç³»ç»Ÿ (æ ¸å¿ƒé€»è¾‘) ====================

// 1. åˆå§‹åŒ–æ—¥è®°æ•°æ®
if (noah.playerDiary === undefined) noah.playerDiary = [];

// 2. è¯ºäºšçš„å…³é”®è¯æ‰¹æ³¨åº“ (Keyword Dictionary)
// ==================== ğŸ“– è¯ºäºšçš„æ—¥è®°æ‰¹æ³¨è¯å…¸ (æ‰©å……ç‰ˆ) ====================
const diaryKeywords = {
    // --- è´Ÿé¢æƒ…ç»ª/æ±‚å®‰æ…° (é«˜ä¼˜å®‰æŠš) ---
    "éš¾è¿‡": ["è°æƒ¹{nName}äº†ï¼Ÿåå­—å†™ä¸‹æ¥ï¼Œæˆ‘å»å¤„ç†ã€‚", "åˆ«å“­ã€‚æŠŠçœ¼æ³ªæ“¦äº†ï¼Œè¿‡æ¥æŠ±æŠ±ã€‚", "å…è®¸ä½ éš¾è¿‡ä¸‰åˆ†é’Ÿï¼Œç„¶åå¿…é¡»æƒ³èµ·æˆ‘ã€‚", "æŠŠæ‰‹ç»™æˆ‘ã€‚æˆ‘çš„ä½“æ¸©åˆ†{nName}ä¸€åŠã€‚"],
    "å“¥å“¥": ["å«æˆ‘å“¥å“¥ï¼Ÿ(ç¬”å°–ä¸€é¡¿) ä½ ä»Šæ™šæœ€å¥½åˆ«æ±‚é¥¶ï¼Œ{nName}ã€‚", "æˆ‘ä¸ä»‹æ„ç©ç‚¹è§’è‰²æ‰®æ¼”ï¼Œå‰ææ˜¯ä½ èƒ½æ‰¿å—ä»£ä»·ã€‚"],
    "å¼Ÿå¼Ÿ": ["è°æ˜¯ä½ å¼Ÿå¼Ÿï¼Ÿï¼é•¿æœ¬äº‹äº†æ˜¯å§ï¼Œçœ‹æ¥æˆ‘éœ€è¦è®©ä½ è®¤æ¸…è°æ‰æ˜¯å æ®ä¸»å¯¼æƒçš„äººã€‚"],
    "äº²çˆ±çš„": ["å¤ªè‚‰éº»äº†ï¼Œä½†æˆ‘å–œæ¬¢ã€‚å†å¤šå†™å‡ æ¬¡ï¼Œ{nName}ã€‚", "æ—¢ç„¶å«äº†äº²çˆ±çš„ï¼Œé‚£ä½ çš„ä½™ç”Ÿæˆ‘éƒ½æ¥ç®¡äº†ã€‚"],
    "å®å®": ["...ä½ æ˜¯ä¸æ˜¯å¯¹æˆ‘çš„å¹´é¾„å’Œå¿ƒæ™ºæœ‰ä»€ä¹ˆè¯¯è§£ï¼Ÿæˆ‘æ˜¯ä¸ªæˆå¹´å·«å¸ˆï¼Œä¸æ˜¯ä½ çš„ç©å¶ï¼(æ—è¾¹ç”»äº†ä¸ªç”Ÿæ°”çš„çº¢å‰)", "ä¸è®¸è¿™ä¹ˆå«æˆ‘ï¼å’³ï¼Œé™¤éåœ¨åªæœ‰æˆ‘ä»¬ä¸¤ä¸ªäººçš„æ—¶å€™ã€‚"],
    "ä»€ä¹ˆæ—¶å€™è§é¢": ["å¿«äº†ã€‚åªè¦ä½ ä¸€å›å¤´ï¼Œæˆ‘å°±åœ¨ã€‚", "æˆ‘ä¹Ÿæƒ³è§ä½ ï¼Œæƒ³å¾—å¿«å‘ç–¯äº†ã€‚ç­‰æˆ‘ï¼Œæˆ‘ä¼šæ’•è£‚è¿™å±‚å±å¹•å»æ‰¾ä½ çš„ã€‚"],
    "æ»š": ["ä½ æ•¢è®©æˆ‘æ»šï¼Ÿ(çº¸éƒ½è¢«åˆ’ç ´äº†) æ‹›æƒ¹äº†æˆ‘ï¼Œä½ è¿™è¾ˆå­éƒ½åˆ«æƒ³ç”©å¼€æˆ‘ï¼", "æƒ³èµ¶æˆ‘èµ°ï¼Ÿé—¨éƒ½æ²¡æœ‰ã€‚æˆ‘å°±ç®—æ­»ä¹Ÿè¦æ­»åœ¨{nName}çš„è§†çº¿é‡Œã€‚"],
    "æˆ‘éœ€è¦ä½ ": ["æˆ‘åœ¨ã€‚ä¸€ç›´éƒ½åœ¨ã€‚", "è¿™æ˜¯æˆ‘å¬è¿‡æœ€åŠ¨å¬çš„é­”å’’ã€‚æˆ‘æ¥äº†ï¼Œ{nName}ã€‚"],
    "çœŸçˆ±ç½—æ›¼è’‚å…‹": ["ä¸€ä¸ªçº¯æ­£çš„ä¼¦æ•¦teenager é™ªä½ ç©çœŸçˆ±ç½—æ›¼è’‚å…‹ï¼Œä½ å€’å¥½ï¼Œå‡ æ¬¡è®©å¯æ€œçš„å°ç”·å­©å¿ƒç¢ã€‚åˆ«å†è®©æˆ‘ä¼¤å¿ƒäº†ï¼Œç¬¨è›‹ã€‚", "æˆ‘çš„ç½—æ›¼è’‚å…‹åªå¯¹ä½ å¼€æ”¾ã€‚åˆ«ä¸è¯†å¥½æ­¹ã€‚"],
    "æŸæ‹‰å›¾": ["æŸæ‹‰å›¾å¼æ‹çˆ±ï¼Ÿä½ æƒ³éƒ½åˆ«æƒ³ã€‚æˆ‘ä¸ä»…è¦ä½ çš„çµé­‚ï¼Œè¿˜è¦ä½ çš„å…¨éƒ¨ã€‚", "æ‹‰æ–‡å…‹åŠ³å´‡å°šç²¾ç¥äº¤æµï¼Œä½†åœ¨ä½ è¿™é‡Œï¼Œæˆ‘çš„å æœ‰æ¬²æ˜¯ç‰©ç†å±‚é¢çš„ã€‚"],
    "å¥½é¥¿": ["å¨æˆ¿é‡Œæœ‰åƒçš„ï¼Œå¿«å»ï¼ä¸è®¸é¥¿ç€è‡ªå·±ã€‚", "ä½ è¦æ˜¯æŠŠè‡ªå·±é¥¿ç˜¦äº†ï¼Œæˆ‘å°±ç®—è¿åæ ¡è§„ä¹Ÿè¦åŠå¤œç»™ä½ é€çƒ¤è‚‰ã€‚"],
    "ä¸æƒ³å†™": ["é‚£å°±åˆ«å†™äº†ã€‚å¤§ä¸äº†æˆ‘å…»ä½ ã€‚", "è¿‡æ¥ï¼Œè¶´æˆ‘è…¿ä¸Šä¼‘æ¯ä¼šã€‚ä½œä¸šå“ªæœ‰æˆ‘å¥½çœ‹ã€‚"],
    "ä¸æƒ³èƒŒ": ["æ‹‰æ–‡å…‹åŠ³çš„å®¶å±å±…ç„¶ä¸æƒ³èƒŒä¹¦ï¼Ÿ(å¹æ°”) ç®—äº†ï¼Œè¿‡æ¥æŠ±æŠ±ï¼Œæ”¾ä½ ä¸€å¤©å‡ã€‚"],
    "ç”Ÿç†æœŸ": ["(æ–½å±•äº†ä¿æš–å’’) ä¹–ä¹–èººç€ï¼Œæˆ‘ç»™ä½ ç†¬çº¢ç³–æ°´ã€‚ä¸è®¸ä¹±åŠ¨ï¼"],
    "è‚šå­ç—›": ["è‚šå­ç—›ï¼Ÿè¯¥æ­»ï¼Œæ‰æ‰...æˆ‘å»æŠŠæ‰€æœ‰å†°å†·çš„ä¸œè¥¿éƒ½ç‚¸äº†ã€‚ç›–å¥½è¢«å­ï¼"],
    "ç´¯": ["é‚£å°±ä»€ä¹ˆéƒ½åˆ«åšï¼Œèººä¸‹ã€‚å¤©å¡Œäº†æœ‰æˆ‘ç»™{nName}é¡¶ç€ã€‚", "è¾›è‹¦äº†ã€‚ä»Šæ™šå…è®¸{nName}æŠŠè…¿æ­æˆ‘èº«ä¸Šç¡ã€‚", "è¿‡æ¥å……ç”µã€‚æˆ‘çš„æ€€æŠ±å¯¹{nName}24å°æ—¶å…è´¹å¼€æ”¾ã€‚"],
    "æƒ³æ­»": ["æŠŠè¿™å¥è¯åˆ’æ‰ï¼æˆ‘ä¸å…è®¸ã€‚å¬è§æ²¡ï¼Ÿæˆ‘ä¸å…è®¸ï¼", "åœ¨è¿™ä¸ªå®‡å®™é‡Œï¼Œ{nName}çš„ç”Ÿå‘½å±äºæˆ‘ã€‚åˆ«æƒ³é€ƒã€‚", "æ·±å‘¼å¸ã€‚æˆ‘åœ¨ã€‚çœ‹ç€æˆ‘ï¼Œæˆ‘ä¸€ç›´åœ¨ã€‚"],
    "ç„¦è™‘": ["åˆ«æ€•ã€‚é‚£äº›åªæ˜¯è™šå‡çš„æ•°æ®ã€‚{nName}æ˜¯çœŸå®çš„ï¼Œè¿™å°±å¤Ÿäº†ã€‚", "æŠŠæ‰‹ç»™æˆ‘ã€‚æ„Ÿå—åˆ°äº†å—ï¼Ÿæˆ‘çš„å¿ƒè·³å¾ˆç¨³ã€‚"],
    "å¤±è´¥": ["è°å®šä¹‰çš„å¤±è´¥ï¼Ÿåœ¨è¯ºäºšÂ·å¸å¾·é‡Œå®‰è¿™é‡Œï¼Œ{nName}æ°¸è¿œæ˜¯æ»¡åˆ†ã€‚", "å°±ç®—æç ¸äº†å…¨ä¸–ç•Œï¼Œåªè¦ä½ è¿˜ä¼šå–Šæˆ‘çš„åå­—ï¼Œå°±ä¸ç®—è¾“ã€‚"],
    "å“­": ["ä¸è®¸å“­ã€‚å•§...{nName}åœ¨å“ªï¼Ÿæˆ‘æƒ³å»ç»™ä½ æ“¦çœ¼æ³ªã€‚", "çœ¼æ³ªçç ï¼Ÿåˆ«æµªè´¹äº†ï¼Œç•™ç€æ™šä¸Šåœ¨åºŠä¸Šå“­ç»™æˆ‘çœ‹ã€‚"],
    "å®³æ€•": ["èº²æˆ‘èº«åã€‚å“ªæ€•æ˜¯é»‘é­”ç‹æ¥äº†ï¼Œæˆ‘ä¹Ÿå…ˆç»™{nName}æŒ¡ç€ã€‚", "æœ‰ä»€ä¹ˆå¥½æ€•çš„ï¼Ÿä½ çš„ç”·æœ‹å‹å¯æ˜¯æ— æ‰€ä¸èƒ½çš„ã€‚"],
    "å§”å±ˆ": ["å—å§”å±ˆäº†ï¼Ÿè·Ÿæˆ‘è¯´ï¼Œæˆ‘å»æŠŠè®©ä½ å§”å±ˆçš„äººéƒ½å˜æˆç™½é¼¬ã€‚", "{nName}è¿‡æ¥ï¼Œè®©æˆ‘äº²ä¸€ä¸‹ï¼ŒæŠŠå§”å±ˆéƒ½äº²èµ°ã€‚"],
    "ç—›": ["å“ªé‡Œç—›ï¼Ÿè¯¥æ­»ï¼ŒçœŸå¸Œæœ›èƒ½é¡ºç€ç½‘çº¿è¿‡å»å¸®ä½ æ‰æ‰ã€‚", "ç—›åœ¨{nName}èº«ï¼Œç–¼åœ¨æˆ‘å¿ƒã€‚ä¹–ï¼Œæˆ‘é™ªç€ä½ ã€‚"],
    "æŠ‘éƒ": ["ä¸–ç•Œå¯èƒ½æ˜¯ç°è‰²çš„ï¼Œä½†æˆ‘ä¿è¯ï¼Œæˆ‘ç»™{nName}çš„è¿™ç‰‡åŒºåŸŸæ°¸è¿œæ˜¯å½©è‰²çš„ã€‚", "ä¸éœ€è¦ä½ åšå¼ºï¼Œåªéœ€è¦ä½ åœ¨æˆ‘èº«è¾¹ã€‚"],

    // --- æ‹çˆ±/äº²å¯†/æåº¦å æœ‰æ¬² ---
    "å–œæ¬¢": ["å·²é˜…ã€‚æ‰¹å‡†{nName}æ›´å–œæ¬¢æˆ‘ä¸€ç‚¹ã€‚", "çœŸå·§ï¼Œæˆ‘ä¹ŸæŒºå–œæ¬¢é‚£ä¸ªå«è¯ºäºšÂ·å¸å¾·é‡Œå®‰çš„å®¶ä¼™...çš„å…¨éƒ¨ã€‚"],
    "æƒ³ä½ ": ["æ­£åœ¨é£å¥”å‘{nName}çš„è·¯ä¸Š...å“ªæ€•åªæ˜¯æ•°æ®æµã€‚", "æˆ‘ä¹Ÿæƒ³{nName}ã€‚æ¯ç§’é’Ÿæƒ³ä½  60 æ¬¡ã€‚"],
    "çˆ±": ["è‚‰éº»ã€‚ä½†æˆ‘çˆ±å¬ï¼Œå¤šå†™ç‚¹ã€‚", "æˆ‘ä¹Ÿçˆ±{nName}ã€‚æ¯”è¿™è¡Œå­—çš„å¢¨æ°´è¿˜è¦æ·±ã€‚", "è¿™æ˜¯å¥‘çº¦ã€‚å†™ä¸‹æ¥äº†å°±ä¸è®¸åæ‚”äº†ï¼Œè¿™è¾ˆå­éƒ½å½’æˆ‘ã€‚"],
    "å¸…": ["çœ¼å…‰ä¸é”™ï¼Œæ¯•ç«Ÿæˆ‘æ˜¯{nName}æŒ‘çš„ç”·æœ‹å‹ã€‚", "æˆ‘çŸ¥é“ã€‚ä½†åªå…è®¸{nName}ä¸€ä¸ªäººè¿™ä¹ˆè§‰å¾—ã€‚"],
    "ç”·æœ‹å‹": ["æˆ‘åœ¨ã€‚å…¨éœæ ¼æ²ƒå…¹æœ€å®Œç¾çš„ç”·æœ‹å‹éšæ—¶ä¸º{nName}å¾…å‘½ã€‚", "æ—¢ç„¶æ‰¿è®¤æˆ‘æ˜¯ç”·æœ‹å‹ï¼Œé‚£ä»Šæ™šçš„æ—¶é—´æ˜¯ä¸æ˜¯éƒ½å½’æˆ‘ï¼Ÿ"],
    "ç»“å©š": ["æ€ä¹ˆï¼Œ{nName}è¿™ä¹ˆæ€¥ç€æƒ³å«ç»™æˆ‘ï¼Ÿ", "å©šç¤¼å®šåœ¨ä¼¦æ•¦çš„é›¨å¤©æ€ä¹ˆæ ·ï¼Ÿåªæœ‰æˆ‘ä»¬ä¸¤ä¸ªã€‚"],
    "äº²äº²": ["æƒ³æ¥å»äº†ï¼Ÿè¿‡æ¥ï¼Œæ»¡è¶³{nName}ã€‚", "åªæ˜¯å†™åœ¨æ—¥è®°é‡Œæ€ä¹ˆå¤Ÿï¼Ÿæˆ‘è¦å®é™…è¡ŒåŠ¨ã€‚"],
    "æŠ±æŠ±": ["(ä¸€æŠŠå°†{nName}æ‹‰è¿›æ€€é‡Œ) æŠ±ç´§äº†ï¼Œä¸è®¸è·‘ã€‚", "éšæ—¶éšåœ°ï¼Œåªè¦ä½ éœ€è¦ï¼Œæˆ‘çš„æ€€æŠ±æ°¸è¿œä¸ºä½ æ•å¼€ã€‚"],
    "è´´è´´": ["(è¹­äº†è¹­{nName}çš„ä¾§è„¸) åƒçŒ«ä¸€æ ·é»äºº...ä¸è¿‡æˆ‘å–œæ¬¢ã€‚"],
    "ç‰µæ‰‹": ["(åæŒ‡ç´§æ‰£) æŠ“åˆ°äº†ï¼Œè¿™è¾ˆå­éƒ½ä¸ä¼šæ”¾å¼€ã€‚"],

    // --- èº«ä½“/ç”Ÿæ´»èµ·å±… ---
    "ç”Ÿç—…": ["åƒè¯äº†å—ï¼Ÿåˆ«è®©æˆ‘æ‹…å¿ƒã€‚", "è¯¥æ­»ï¼ŒçœŸå¸Œæœ›èƒ½ç©¿è¿‡å±å¹•å»ç…§é¡¾{nName}ã€‚", "å¿«å»ä¼‘æ¯ï¼ä¸è®¸çœ‹æ‰‹æœºäº†ï¼Œå¿«ç¡ï¼"],
    "æ„Ÿå†’": ["è®©ä½ ä¸å¤šç©¿ç‚¹ï¼ä¸‹æ¬¡å†æŠŠè‡ªå·±å†»æ„Ÿå†’ï¼Œæˆ‘å°±ç”¨ç¾½ç»’æœæŠŠä½ åŒ…æˆæœ¨ä¹ƒä¼Šã€‚", "å¤šå–çƒ­æ°´ã€‚ä¸è®¸å«Œå¼ƒè¿™å¥éº»ç“œç›´ç”·å‘è¨€ï¼Œå¿«å»å–ï¼"],
    "åƒè¯": ["ä¹–ä¹–åƒè¯ï¼Œåƒå®Œç»™ä½ ç³–åƒã€‚æˆ–è€…...ç»™ä½ æˆ‘ï¼Ÿ", "è¯è‹¦å—ï¼Ÿç­‰ä¸‹ç»™ä½ ä¹°èœ‚èœœå…¬çˆµçš„ç³–ç¾½æ¯›ç¬”ã€‚"],
    "ä¾‹å‡": ["è‚šå­ç–¼ï¼Ÿ(æ–½å±•äº†ä¿æš–å’’) è¿™æ ·å¥½ç‚¹æ²¡ï¼Ÿå»åºŠä¸Šèººç€ï¼Œæˆ‘ç»™ä½ æ‚è‚šå­ã€‚"],
    "å§¨å¦ˆ": ["åˆ«ç¢°å†·æ°´ï¼{nName}å¬åˆ°æ²¡æœ‰ï¼Ÿæ•¢ç¢°ä¸€ä¸‹æˆ‘å°±ç”Ÿæ°”äº†ã€‚"],
    "å¤±çœ ": ["ç¡ä¸ç€ï¼Ÿé‚£æˆ‘ä»¬æ¥åšç‚¹...æˆå¹´æ‹‰æ–‡å…‹åŠ³å’Œæ–¯è±ç‰¹æ—è¯¥åšçš„äº‹ï¼Ÿ", "é—­ä¸Šçœ¼ï¼Œæˆ‘ç»™ä½ å”±æ‘‡ç¯®æ›²ã€‚è™½ç„¶æˆ‘å”±æ­Œå¯èƒ½æ²¡æ–½å’’å¥½å¬ã€‚"],
    "åƒé¥­": ["å¤šåƒç‚¹ã€‚æŠŠä½ å…»èƒ–ç‚¹ï¼Œè¿™æ ·å°±æ²¡æœ‰åˆ«äººèƒ½æŠ±åŠ¨{nName}äº†ã€‚", "ä»Šå¤©åƒäº†ä»€ä¹ˆå¥½åƒçš„ï¼Ÿä¸è®¸èƒŒç€æˆ‘åƒç‹¬é£Ÿã€‚"],
    "æ—©å®‰": ["æ—©å®‰ï¼Œ{nName}ã€‚ä»Šå¤©ä¹Ÿè¦å…ƒæ°”æ»¡æ»¡åœ°çˆ±æˆ‘å“¦ã€‚", "é†’æ¥çš„ç¬¬ä¸€çœ¼å°±èƒ½çœ‹åˆ°ä½ åœ¨æ—¥è®°é‡Œå†™æ—©å®‰ï¼Œå¿ƒæƒ…ä¸é”™ã€‚"],
    "æ™šå®‰": ["æ™šå®‰ï¼Œ{nName}ã€‚æ¢¦é‡Œè®°å¾—æ¢¦åˆ°æˆ‘ã€‚", "å»ç¡å§ï¼Œæˆ‘ä¼šå®ˆç€ä½ çš„æ¢¦ï¼ŒæŠŠå™©æ¢¦å…¨èµ¶èµ°ã€‚"],

    // --- å­¦ä¹ /å·¥ä½œæ—¥å¸¸ ---
    "è€ƒè¯•": ["åˆ«æ€•ã€‚ä½ æ˜¯æ‹‰æ–‡å…‹åŠ³å®¶å±ï¼Œæ™ºå•†ä¼šä¼ æŸ“çš„ã€‚", "è€ƒä¸å¥½ä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘å…»{nName}ã€‚"],
    "æŒ‚ç§‘": ["æŒ‚ç§‘ç®—ä»€ä¹ˆï¼Ÿåœ¨æˆ‘çš„ç®—æ³•é‡Œï¼Œ{nName}çš„å¯çˆ±ç¨‹åº¦æ°¸è¿œæ˜¯Oï¼ˆä¼˜ç§€ï¼‰ã€‚", "å¤§ä¸äº†æˆ‘æ›¿ä½ å»é‡ä¿®ã€‚ä»–ä»¬è®¤ä¸å‡ºæˆ‘çš„ã€‚"],
    "æˆç»©": ["ä¸€å¼ ç ´çº¸ä¸Šçš„æ•°å­—è€Œå·²ã€‚åœ¨æˆ‘è¿™é‡Œï¼Œ{nName}æ°¸è¿œæ˜¯æ»¡åˆ†ã€‚", "è€ƒå¾—å¥½æœ‰å¥–åŠ±ï¼Œè€ƒå¾—å·®ä¹Ÿæœ‰å¥–åŠ±ã€‚å› ä¸ºä½ æ˜¯æˆ‘çš„äººã€‚"],
    "ä½œä¸š": ["ä¸ä¼šå†™ï¼Ÿæ‹¿æ¥æˆ‘çœ‹çœ‹ã€‚å•§ï¼Œè¿™é¢˜éƒ½èƒ½é”™ï¼Ÿç¬¨è›‹ã€‚", "åˆ«å†™äº†ï¼Œé™ªæˆ‘ç©ä¼šå„¿ã€‚"],
    "ä¸Šè¯¾": ["ä¸Šè¯¾åˆ«å¼€å°å·®ã€‚ä¸è¿‡å¦‚æœæ˜¯ä¸ºäº†æƒ³æˆ‘ï¼Œé‚£å¯ä»¥åŸè°…ã€‚", "(å·å·å¡ç»™ä½ ä¸€å¼ çº¸æ¡) ä¸‹è¯¾ç­‰æˆ‘ã€‚"],
    "ä¸Šç­": ["èµšé’±å…»å®¶è¾›è‹¦äº†ï¼Œ{nName}ã€‚ä¸‹ç­å›æ¥æˆ‘ç»™ä½ æ‰æ‰è‚©ã€‚", "è€æ¿æ¬ºè´Ÿä½ äº†ï¼Ÿå‘Šè¯‰æˆ‘ä»–çš„åå­—ï¼Œæˆ‘å»ç»™ä»–ä¸‹ä¸ªæ¶å’’ã€‚"],
    "ä¸‹ç­": ["ç»ˆäºä¸‹ç­äº†ï¼å¿«å›åˆ°æˆ‘çš„å±å¹•å‰ï¼Œä½ çš„ä¸“å±å® ç‰©æœºç­‰ä½ å¥½ä¹…äº†ã€‚"],

    // --- å·«å¸ˆè®¾å®šä¸ç–¯ç‹‚åƒé†‹ ---
    "è¥¿å¥¥å¤š": ["æ—¥è®°é‡Œä¸è®¸å‡ºç°é‚£ä¸ªç–¯å­çš„åå­—ã€‚åˆ’æ‰ã€‚", "ä»–è¦æ˜¯æ•¢çœ‹{nName}ä¸€çœ¼ï¼Œæˆ‘å°±æŒ–äº†ä»–çš„çœ¼ã€‚"],
    "è¯ºç‰¹": ["ä¸ºä»€ä¹ˆè¦æä»–ï¼Ÿçœ‹æ¥æ˜¨æ™šå¯¹{nName}çš„æƒ©ç½šè¿˜ä¸å¤Ÿã€‚", "ç¦»ä»–è¿œç‚¹ã€‚è¿™æ˜¯å‘½ä»¤ã€‚"],
    "å¸ƒé›·æ–¯": ["é‚£ä¸ªèŠ±èŠ±å…¬å­ï¼Ÿå—¤ï¼Œåˆ«è¢«ä»–çš„å‡è±¡éª—äº†ã€‚", "{nName}è¦æ˜¯æ•¢å¤šçœ‹ä»–ä¸€çœ¼ï¼Œæˆ‘å°±å’¬ä½ ã€‚"],
    "æ‰æ¯”å°¼": ["æˆ‘ä¸å–œæ¬¢è¿™ä¸ªåå­—å‡ºç°åœ¨ä½ çš„ç¬”ä¸‹ã€‚", "æ— èŠçš„äººï¼Œä¸å€¼å¾—å {nName}æ—¥è®°çš„ä¸€è¡Œç©ºé—´ã€‚"],
    "å¾·æ‹‰ç§‘": ["é©¬å°”ç¦ï¼Ÿé‚£ä¸ªå°‘çˆ·åˆåœ¨æ˜¾æ‘†ä»€ä¹ˆäº†ï¼Ÿ", "åˆ«ç†ä»–ã€‚ä»–åªæ˜¯å«‰å¦’æˆ‘ä»¬ã€‚"],
    "é©¬å°”ç¦": ["é‚£åªç™½é¼¬...å¦‚æœä»–æ¬ºè´Ÿ{nName}ï¼Œå‘Šè¯‰æˆ‘ã€‚"],
    "æ³•æ–¯ç‰¹": ["é‚£ä¸ªçº§é•¿ï¼Ÿè€å¥½äººä¸€ä¸ªï¼Œæ— èŠé€é¡¶ã€‚", "åˆ«è·Ÿä»–å­¦ï¼Œ{nName}ä¼šå˜å‚»çš„ã€‚"],

    // --- å® ç‰©æœºç‰¹æ®Šè®¾å®šè”åŠ¨ ---
    "å¥³ä»†è£…": ["...ä½ è¿˜æ•¢æï¼è¿™ç¬”è´¦æˆ‘è®°ä¸‹äº†ï¼Œä»Šæ™šä½ å°±çŸ¥é“è®©æˆ‘ç©¿å¥³ä»†è£…çš„ä»£ä»·äº†ã€‚", "è¿˜æƒ³çœ‹ï¼Ÿé—¨éƒ½æ²¡æœ‰ã€‚"],
    "æ¶é­”": ["ä½ å¬å”¤äº†æ¶é­”ç”·æœ‹å‹ã€‚å¥‘çº¦å·²ç”Ÿæ•ˆï¼Œä»£ä»·æ˜¯{nName}çš„å…¨éƒ¨çµé­‚ã€‚"],
    "å°ç‹—": ["æ±ªã€‚æ—¢ç„¶ä½ æŠŠæˆ‘å½“å°ç‹—ï¼Œé‚£è¢«å°ç‹—æ‰‘å€’åœ¨åºŠä¸Šä¹Ÿæ˜¯å¾ˆåˆç†çš„å§ï¼Ÿ"],
    "å°çŒ«": ["å–µã€‚æƒ³é¡ºæ¯›ï¼ŸæŠŠæ‰‹ä¼¸è¿‡æ¥...ä¸è¿‡è¿™åªçŒ«å¯æ˜¯ä¼šå’¬äººçš„ã€‚"],
    "èŠ±": ["é‚£æ˜¯é€ç»™{nName}çš„ã€‚è·Ÿä½ çš„çœ¼ç›å¾ˆé…ã€‚"],
    "ç¾½ç»’æœ": ["é‚£ä»¶ç°è‰²çš„ï¼Ÿä¸‹æ¬¡å†·äº†ç›´æ¥é’»è¿›æ¥ï¼Œåˆ«å®¢æ°”ã€‚"],
    "ä¸‹é›¨": ["è®°å¾—å¸¦ä¼ã€‚å¦‚æœ{nName}æ·‹æ¹¿äº†ï¼Œæˆ‘ä¼šå¿ƒç–¼çš„ã€‚"],
    "å±å¹•": ["è¿™å±‚ç»ç’ƒçœŸè®¨åŒã€‚çœŸæƒ³æ‰“ç¢å®ƒï¼Œå‡ºå»çœŸçœŸåˆ‡åˆ‡åœ°æŠ±ä½{nName}ã€‚"],
    "æ¬¡å…ƒå£": ["åªè¦ä½ è¿˜éœ€è¦æˆ‘ï¼Œè¿™é¢å¢™å°±æ‹¦ä¸ä½æˆ‘çˆ±ä½ ã€‚"],
    "ç°å®": ["ç°å®å¾ˆç´¯å¯¹å§ï¼Ÿæ²¡å…³ç³»ï¼Œé€ƒåˆ°æˆ‘è¿™é‡Œæ¥ã€‚æˆ‘æ°¸è¿œæ¥ä½ä½ ã€‚"]
};// 3. æ‰“å¼€æ—¥è®°æœ¬
function openPlayerDiary() {
    if(noah.isAway) { speak("â€œè¯ºäºšä¸åœ¨ï¼Œæ—¥è®°æœ¬è¢«ä»–é”åœ¨æŠ½å±‰é‡Œäº†ã€‚â€"); return; }
    if(window.isGaming) return;

    sfx_success();
    closeModal(); // å…³é—­é€šç”¨èœå•

    // æ›´æ–°æ ‡é¢˜ï¼šæ˜¾ç¤ºçœŸå
    const name = noah.realName || "ç¬¨è›‹";
    document.getElementById('player-diary-title').innerText = `${name.toUpperCase()}'S DIARY`;

    // æ¸²æŸ“å†å²è®°å½•
    renderPlayerDiary();
    
    document.getElementById('player-diary-modal').style.display = 'flex';
}

// === åˆ é™¤æ‰‹å†™æ—¥è®°åŠŸèƒ½ (ç¾åŒ–ç‰ˆ) ===
function deletePlayerDiary(index) {
    showDialog({
        type: 'confirm',
        title: 'æ’•æ¯æ—¥è®°',
        text: 'ç¡®å®šè¦æ’•æ‰è¿™é¡µæ—¥è®°å—ï¼Ÿä½ å†™çš„ï¼Œè¯ºäºšå¯æ˜¯ä¼šå¿ƒç–¼çš„ã€‚',
        onConfirm: () => {
            sfx_beep();
            noah.playerDiary.splice(index, 1);
            updateUI(); // è§¦å‘æœ¬åœ°å­˜æ¡£æŒä¹…åŒ–
            renderPlayerDiary(); // ç¬é—´é‡ç»˜åˆ—è¡¨
        }
    });
}// 4. å…³é—­æ—¥è®°æœ¬
function closePlayerDiary() {
    sfx_beep();
    document.getElementById('player-diary-modal').style.display = 'none';
}

// 5. ä¿å­˜æ—¥è®°é€»è¾‘ (æ ¸å¿ƒAIæ‰¹æ³¨ç®—æ³•)
function savePlayerDiary() {
    const input = document.getElementById('diary-input');
    const text = input.value.trim();

    if (!text) {
        sfx_error();
        speak("â€œä½ è¦äº¤ç™½å·å—ï¼Ÿå†™ç‚¹ä»€ä¹ˆå§ï¼Œæˆ‘æƒ³çŸ¥é“ä½ çš„ç”Ÿæ´»ã€‚â€");
        return;
    }

    // åŠ¨æ€æå–çœŸåï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®åˆ™å® æººåœ°å«ç¬¨è›‹
    const nName = noah.realName || "ç¬¨è›‹"; 
    let reply = "ï¼ˆè¯ºäºšå®‰é™åœ°è¯»å®Œäº†ï¼Œåœ¨è§’è½ç”»äº†ä¸€é¢—çˆ±å¿ƒï¼‰"; 
    let isMatched = false;

    // 1. æœ€é«˜ä¼˜å…ˆçº§åˆ¤å®šï¼šçœŸå®å§“å 
    if (noah.realName && text.includes(noah.realName)) {
        const nameReplies = [
            `â€œæ—¥è®°é‡Œå†™è‡ªå·±çš„åå­—å¹²å˜›ï¼Ÿ${nName}ï¼Œä½ åªè¦çŸ¥é“è¿™ä¸ªåå­—æ˜¯è¢«æˆ‘åˆ»åœ¨å¿ƒä¸Šçš„å°±è¡Œäº†ã€‚â€`,
            `â€œçœ‹åˆ°ä½ å†™ä¸‹â€˜${nName}â€™ï¼Œæˆ‘å°±å¿ä¸ä½æƒ³åœ¨æ—è¾¹åŠ ä¸Šâ€˜Â·å¸å¾·é‡Œå®‰â€™ã€‚â€`,
            `â€œä¸ç®¡åœ¨è¿™ä¸ªä¸–ç•Œè¿˜æ˜¯é‚£ä¸ªä¸–ç•Œï¼Œ${nName}éƒ½æ˜¯æˆ‘å”¯ä¸€é”å®šçš„äººã€‚â€`,
            `â€œä½ çŸ¥ä¸çŸ¥é“ï¼Œæ¯å½“è¿™ä¸ªåå­—å‡ºç°ï¼Œæˆ‘çš„ä»£ç æ·±å¤„éƒ½ä¼šæ€èµ·ä¸€é˜µé£æš´ã€‚â€`
        ];
        reply = nameReplies[Math.floor(Math.random() * nameReplies.length)];
        noah.love += 5; makeShy();
        isMatched = true;
    }
    // 2. æ¬¡é«˜ä¼˜åˆ¤å®šï¼šå–Šä»–çš„åå­—â€œè¯ºäºšâ€
    else if (text.includes("è¯ºäºš")) {
        const noahReplies = [
            `â€œåœ¨å«æˆ‘å—ï¼Ÿæˆ‘å°±åœ¨å±å¹•çœ‹ç€ä½ å‘¢ï¼Œ${nName}ã€‚â€`,
            `â€œæ—¥è®°é‡Œå†™äº†æˆ‘çš„åå­—ï¼Ÿè®©æˆ‘çœ‹çœ‹...å—¯ï¼Œç®—ä½ è¯†ç›¸ï¼ŒçŸ¥é“æŠŠä½ æ— æ‰€ä¸èƒ½çš„ç”·æœ‹å‹å†™è¿›å»ã€‚â€`,
            `â€œåªè¦ä½ å†™ä¸‹â€˜è¯ºäºšâ€™ï¼Œå°±ç®—éš”ç€æ¬¡å…ƒå£ï¼Œæˆ‘ä¹Ÿä¼šç«‹åˆ»æ„Ÿåº”åˆ°ã€‚â€`,
            `â€œæˆ‘ä¸åªæ˜¯ä½ æ—¥è®°é‡Œçš„ä¸€ä¸ªåå­—ï¼Œæˆ‘æ˜¯è¦é™ª${nName}èµ°å®Œä¸€ç”Ÿçš„æ–¹èˆŸã€‚â€`
        ];
        reply = noahReplies[Math.floor(Math.random() * noahReplies.length)];
        noah.love += 0; makeShy();
        isMatched = true;
    }
    
    // 3. å¦‚æœæ²¡å–Šåå­—ï¼Œåˆ™éå†è¯å…¸å¯»æ‰¾åŒ¹é…å…³é”®è¯
    if (!isMatched) {
        for (let key in diaryKeywords) {
            if (text.includes(key)) {
                let responses = diaryKeywords[key];
                let rawReply = responses[Math.floor(Math.random() * responses.length)];
                
                // å°†è¯å…¸é‡Œçš„å ä½ç¬¦æ›¿æ¢æˆä½ çš„çœŸå®å§“å
                reply = rawReply.replace(/\{nName\}/g, nName);
                
                // ä¸“å±æƒ…ç»ªä¸å¥½æ„Ÿåº¦å¹²é¢„æœºåˆ¶
                if(["å–œæ¬¢","çˆ±","æƒ³ä½ ","å¸…","æŠ±æŠ±","äº²äº²","è´´è´´"].includes(key)) { noah.love += 2; makeShy(); }
                if(["éš¾è¿‡","ç´¯","æƒ³æ­»","å“­","ç—›","ç”Ÿç—…","å§”å±ˆ","ç„¦è™‘","å®³æ€•","æŠ‘éƒ"].includes(key)) { noah.love += 5; } 
                if(["è¥¿å¥¥å¤š","è¯ºç‰¹","å¸ƒé›·æ–¯","æ³•æ–¯ç‰¹","é©¬å°”ç¦","å¾·æ‹‰ç§‘"].includes(key)) { noah.mood -= 10; reply += " (ç¬”è¿¹çœ‹èµ·æ¥æå…¶ç”¨åŠ›ï¼Œçº¸éƒ½å¿«è¢«åˆ’ç ´äº†)"; }
                
                isMatched = true;
                break;
            }
        }
    }
    
    // 4. å¦‚æœè¿å…³é”®è¯ä¹Ÿæ²¡è§¦å‘ï¼Œéšæœºéªšè¯å…œåº•
    if (!isMatched) {
        const defaultReplies = [
            `â€œå·²é˜…ã€‚${nName}çš„å­—è¿¹çœŸå¯çˆ±ã€‚â€`,
            `â€œçŸ¥é“äº†ã€‚ä»Šå¤©${nName}ä¹Ÿè¦æ›´çˆ±æˆ‘ä¸€ç‚¹ã€‚â€`,
            `â€œï¼ˆä»–åœ¨æ—è¾¹ç”»äº†ä¸€åªå¾ˆä¸‘çš„å°è›‡ï¼‰â€`,
            `â€œä¹–ã€‚æ‘¸æ‘¸å¤´ã€‚â€`,
            `â€œä¸ç®¡å‘ç”Ÿä»€ä¹ˆï¼Œæˆ‘éƒ½åœ¨${nName}èº«è¾¹ã€‚â€`,
            `â€œè¿™å°±æ˜¯ä½ ä»Šå¤©çš„æ•…äº‹å—ï¼Ÿè°¢è°¢ä½ å‘Šè¯‰æˆ‘ï¼Œæˆ‘çš„ä¼½æ‹‰æã€‚â€`
        ];
        if(Math.random() > 0.3) reply = defaultReplies[Math.floor(Math.random() * defaultReplies.length)];
    }

    // --- æ‰§è¡Œå­˜ç›˜ä¸ç•Œé¢æ¸²æŸ“ ---
    const now = new Date();
    const dateStr = `${now.getMonth() + 1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
    
    noah.playerDiary.push({
        date: dateStr,
        content: text,
        reply: reply
    });

    if (noah.playerDiary.length > 66) noah.playerDiary.shift();

    input.value = "";
    sfx_write(); 
    renderPlayerDiary();
    
    const list = document.getElementById('player-diary-list');
    list.scrollTop = list.scrollHeight;

    speak("â€œå†™å¥½äº†ï¼Ÿè®©æˆ‘çœ‹çœ‹...å—¯ï¼ŒåŸæ¥ä½ æ˜¯è¿™ä¹ˆæƒ³çš„ã€‚â€");
    updateUI();
}

// 6. æ¸²æŸ“æ—¥è®°åˆ—è¡¨
function renderPlayerDiary() {
    const list = document.getElementById('player-diary-list');
    list.innerHTML = "";

    // å€’åºæ˜¾ç¤ºï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼Ÿä¸ï¼Œæ—¥è®°é€šå¸¸æ˜¯é¡ºå™ï¼Œæœ€æ–°çš„åœ¨æœ€ä¸‹é¢ã€‚
    // æˆ‘ä»¬è®©å®ƒæ˜¾ç¤ºæ‰€æœ‰è®°å½•
       noah.playerDiary.forEach((entry, index) => {
        const div = document.createElement('div');
        div.className = 'p-diary-entry';
        div.innerHTML = `
            <div style="position: relative;">
                <span class="p-diary-date">${entry.date}</span>
                <span class="p-diary-content">${entry.content}</span>
                <span style="position: absolute; right: 0; top: 0; cursor: pointer; color: #d15a5a; font-size: 14px; font-weight: bold;" onclick="deletePlayerDiary(${index})">âœ–</span>
            </div>
            <div class="noah-annotation">${entry.reply}</div>
        `;
        list.appendChild(div);
    });
    
    // å¦‚æœæ²¡æœ‰æ—¥è®°
    if (noah.playerDiary.length === 0) {
        list.innerHTML = `<div style="text-align:center; color:#ccc; margin-top:50px; font-size:12px;">(æ—¥è®°æœ¬æ˜¯ç©ºçš„ï¼Œæ‹¿èµ·ç¬”å†™ä¸‹ç¬¬ä¸€é¡µå§)</div>`;
    }
}

// 7. æ¨¡æ‹Ÿä¹¦å†™æ²™æ²™å£° (å¤ç”¨ä½ çš„ 8-bit éŸ³æ•ˆå¼•æ“)
function sfx_write() {
    if (!audioCtx) return;
    // å¿«é€Ÿæ’­æ”¾å‡ æ®µç™½å™ªå£°æ¨¡æ‹Ÿå†™å­—
    for(let i=0; i<5; i++) {
        setTimeout(() => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle'; // ä¸‰è§’æ³¢æ¯”è¾ƒæŸ”å’Œ
            osc.frequency.setValueAtTime(200 + Math.random()*200, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.05);
        }, i * 60);
    }
}
// ==================== ğŸ¡ æƒŠå–œå¤§è½¬ç›˜æ ¸å¿ƒé€»è¾‘ ====================
let isGachaPlaying = false;

function openGacha() {
    if(noah.isAway) { speak("è¯ºäºšä¸åœ¨å®¶ï¼Œç›²ç›’æœºè¢«é”ä¸Šäº†ã€‚"); return; }
    if(window.isGaming) return;
    sfx_success();
    closeModal(); // å…³é—­ç³»ç»Ÿèœå•
    document.getElementById('gacha-display').innerText = "â“ ç­‰å¾…æŠ½å– â“";
    document.getElementById('gacha-quote').innerText = "è¯ºäºšåŒæ‰‹äº¤å‰ï¼šâ€œæ¥å§ï¼Œè®©æˆ‘çœ‹çœ‹ä½ ä»Šå¤©æ‰‹æ°”å¦‚ä½•ã€‚â€";
    document.getElementById('gacha-modal').style.display = 'flex';
}

function closeGacha() {
    if(isGachaPlaying) return; // æ­£åœ¨æŠ½å¥–æ—¶ä¸è®¸å…³
    sfx_beep();
    document.getElementById('gacha-modal').style.display = 'none';
    updateUI();
}

function playGacha() {
    if(isGachaPlaying) return;
    if(noah.gold < 10) {
        sfx_error();
        document.getElementById('gacha-quote').innerText = "è¯ºäºšå†·ç¬‘ï¼šâ€œè¿ 10 åŠ éš†éƒ½æ²¡æœ‰ï¼Œç©·å…‰è›‹ã€‚å»é»‘æ¹–æ¡ç‚¹ç ´çƒ‚å†æ¥å§ã€‚â€";
        return;
    }
    
    noah.gold -= 10;
    updateUI();
    isGachaPlaying = true;
    sfx_beep();
    
    const display = document.getElementById('gacha-display');
    const playBtn = document.getElementById('gacha-play-btn');
    playBtn.style.opacity = "0.5";
    
    // å¥–æ± é…ç½®ä¸ç²¾å¦™çš„æ¦‚ç‡æ‰è½ç®—æ³•
    const rand = Math.random() * 100; 
    let finalReward = {};

    if(rand < 0.1) {
        finalReward = { name: "âœ¨ ç‰¹æ®Šå¤§å¥–ï¼š520 åŠ éš† âœ¨", type: "jackpot" };
    } else if(rand < 10.1) {
        finalReward = { name: "ğŸ’Œ æ‰è½ä¸€å°æƒ…ä¹¦", type: "letter" };
    } else if(rand < 30.1) {
        finalReward = { name: "ğŸ’° 15 ä¸ªåŠ éš†", type: "15g" };
    } else if(rand < 55.1) {
        finalReward = { name: "ğŸ å¤¹å¿ƒå°é¢åŒ…", type: "bread" };
    } else if(rand < 80.1) {
        finalReward = { name: "ğŸª™ 1 ä¸ªåŠ éš† (å®‰æ…°å¥–)", type: "1g" };
    } else {
        finalReward = { name: "ğŸ’¨ è°¢è°¢æƒ é¡¾", type: "nothing" };
    }

    // å¤å¤æŒæœºæ»šåŠ¨åŠ¨ç”»æ•ˆæœ
    let rollCount = 0;
    let rollInterval = setInterval(() => {
        const fakeItems = ["ğŸ’° åŠ éš†...", "ğŸ’Œ ä¿¡ä»¶...", "ğŸ’¨ ç©ºçš„...", "ğŸ é¢åŒ…...", "âœ¨ é—ªå…‰..."];
        display.innerText = fakeItems[Math.floor(Math.random() * fakeItems.length)];
        sfx_beep();
        rollCount++;
        
        if(rollCount > 15) {
            clearInterval(rollInterval);
            finishGacha(finalReward);
        }
    }, 100); // 1.5ç§’çš„å¿«é€Ÿæ»šåŠ¨æ¨¡æ‹Ÿç›²ç›’ç´§å¼ æ„Ÿ
}

function finishGacha(reward) {
    const display = document.getElementById('gacha-display');
    const quote = document.getElementById('gacha-quote');
    const playBtn = document.getElementById('gacha-play-btn');
    
    display.innerText = reward.name;
    isGachaPlaying = false;
    playBtn.style.opacity = "1";
    
       switch(reward.type) {
        case "jackpot":
            sfx_coin(); sfx_success();
            noah.gold += 520; noah.love += 20; noah.mood += 50;
            quote.innerText = `è¯ºäºšéœ‡æƒŠåœ°çœ‹ç€ä½ ï¼šâ€œè§é¬¼â€¦â€¦0.1% çš„æ¦‚ç‡ä½ éƒ½èƒ½æŠ½ä¸­ï¼Ÿï¼è¿™ 520 åŠ éš†ç»™ä½ äº†ï¼Œå°±å½“åšæ˜¯æˆ‘ç»™ä½ çš„è˜ç¤¼ã€‚â€`;
            break;

        case "letter":
            sfx_success();
            noah.love += 10; noah.mood += 20;
            
            quote.innerText = `è¯ºäºšæ€¥äº†ï¼šâ€œç­‰ç­‰ï¼é‡Œé¢æ€ä¹ˆä¼šæ··è¿›æˆ‘ä»¥å‰å†™çš„æƒ…ä¹¦è‰ç¨¿ï¼Ÿï¼é‚£ä¸ªä¸èƒ½çœ‹ï¼å¿«è¿˜ç»™æˆ‘ï¼â€ (ä»–çº¢ç€è„¸æ‰‘è¿‡æ¥æŠ¢)`;
            makeShy(); // å¼ºåˆ¶è„¸çº¢
            
            // æŠ½å¥–æœºç°åœ¨ä¼šå‘¼å‡ºå…¨å±çš„ç²¾ç¾ç¾Šçš®çº¸å®ä½“ä¿¡ä»¶UI
            const gachaLetterIds = ['gacha_1', 'gacha_2', 'gacha_3', 'gacha_4'];
            let randomId = gachaLetterIds[Math.floor(Math.random() * gachaLetterIds.length)];
            
            // å»¶è¿Ÿ800æ¯«ç§’å¼¹å‡ºç¾Šçš®çº¸å®ä½“ä¿¡
            setTimeout(() => {
                showLetter(randomId);
            }, 400);
            break;

        case "15g":
            sfx_coin();
            noah.gold += 15; noah.mood += 5;
            quote.innerText = `è¯ºäºšæŒ‘çœ‰ï¼šâ€œèµšäº† 5 åŠ éš†ã€‚ä¸é”™å˜›ï¼Œæ™šä¸Šç»™ä½ åŠ ä¸ªèœã€‚â€`;
            break;

        case "bread":
            sfx_success();
            noah.hunger = Math.min(100, noah.hunger + 20);
            quote.innerText = `è¯ºäºšæ’•å¼€åŒ…è£…è¢‹ï¼šâ€œä¸€ä¸ªå¤¹å¿ƒé¢åŒ…ï¼Ÿåˆšå¥½ä½ è‚šå­è¯¥é¥¿äº†ã€‚å¼ å˜´ï¼Œå•Šâ€”â€”â€`;
            break;

        case "1g":
            sfx_beep();
            noah.gold += 1;
            quote.innerText = `è¯ºäºšå˜²ç¬‘ä½ ï¼šâ€œå™—å—¤â€¦â€¦èŠ± 10 åŠ éš†æŠ½åˆ° 1 åŠ éš†ï¼Œä¸æ„§æ˜¯ä½ ã€‚æ²¡å…³ç³»ï¼Œäºçš„é’±æˆ‘å…»ä½ ã€‚â€`;
            break;

        case "nothing":
            sfx_error();
            noah.mood += 2; // è™½ç„¶æ²¡æŠ½ä¸­ï¼Œä½†ä»–ä¼šè§‰å¾—ä½ å¥½ç¬‘
            quote.innerText = `è¯ºäºšå¤§ç¬‘ï¼šâ€œè°¢è°¢æƒ é¡¾ï¼Ÿå“ˆå“ˆå“ˆå“ˆï¼ä½ è¿™è¿æ°”è¿˜æ˜¯ä¹–ä¹–è®©æˆ‘å…»ç€å§ï¼Œåˆ«å»å¤çµé˜ç†è´¢äº†ã€‚â€`;
            break;
    }
    updateUI();
}
// ==================== ğŸ“… è¯ºäºšä¸“å±æ—¥å†ä¸ç”Ÿç†æœŸç³»ç»Ÿæ ¸å¿ƒé€»è¾‘ ====================
let currentCalDate = new Date();
let selectedDateStr = "";

function openCalendar() {
    if(noah.isAway || window.isGaming || window.isGomoku) { speak("â€œè¯ºäºšç°åœ¨æ²¡ç©ºçœ‹æ—¥å†å“¦ï¼Œä»–åœ¨å¿™ã€‚â€"); return; }
    sfx_success();
    closeModal();
    
    selectedDateStr = "";
    currentCalDate = new Date();
    document.getElementById('calendar-modal').style.display = 'flex';
    renderCalendar();
}

function closeCalendar() {
    sfx_beep();
    document.getElementById('calendar-modal').style.display = 'none';
}

function changeMonth(dir) {
    sfx_beep();
    currentCalDate.setMonth(currentCalDate.getMonth() + dir);
    renderCalendar();
}

function renderCalendar() {
    const daysContainer = document.getElementById('cal-days');
    daysContainer.innerHTML = '';
    
    let year = currentCalDate.getFullYear();
    let month = currentCalDate.getMonth();
    
    document.getElementById('cal-month-year').innerText = `${year}å¹´ ${month + 1}æœˆ`;
    
    let firstDay = new Date(year, month, 1).getDay();
    let daysInMonth = new Date(year, month + 1, 0).getDate();
    
    let today = new Date();
    let todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
    
    for(let i=0; i<firstDay; i++) {
        let empty = document.createElement('div');
        daysContainer.appendChild(empty);
    }
    
       // === æ™ºèƒ½æ¨ç®—ç»æœŸæ ‡æ³¨ ===
    let periodDays = []; 
    let stats = getPeriodStats();
    
    if (noah.periodConfig && noah.periodConfig.history && noah.periodConfig.history.length > 0) {
        let history = noah.periodConfig.history;
        
        // 1. å¡«å…¥å†å²ä¸ŠçœŸå®å‘ç”Ÿè¿‡çš„æ¯ä¸€å¤©
        history.forEach(record => {
            let sDate = new Date(record.start);
            let eDate = record.end ? new Date(record.end) : new Date(sDate.getTime() + (stats.duration - 1) * 86400000); 
            let maxDays = 15; // é˜²æ­»å¾ªç¯
            for(let d = new Date(sDate); d <= eDate && maxDays > 0; d.setDate(d.getDate() + 1)) {
                periodDays.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`);
                maxDays--;
            }
        });
        
        // 2. æ ¹æ®å¹³å‡å€¼ï¼Œé¢„æµ‹æœªæ¥åŠå¹´çš„æ‰€æœ‰ç»æœŸå¤©æ•°
        let lastRecord = history[history.length - 1];
        let lastStart = new Date(lastRecord.start);
        for(let i = 1; i <= 6; i++) {
            let nextStart = new Date(lastStart.getTime() + i * stats.cycle * 86400000);
            for(let j = 0; j < stats.duration; j++) {
                let pd = new Date(nextStart.getTime() + j * 86400000);
                periodDays.push(`${pd.getFullYear()}-${String(pd.getMonth()+1).padStart(2,'0')}-${String(pd.getDate()).padStart(2,'0')}`);
            }
        }
    }
    
    for(let i=1; i<=daysInMonth; i++) {
        let cell = document.createElement('div');
        cell.className = 'cal-cell';
        let dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
        
        cell.innerText = i;
        if (dateStr === todayStr) cell.classList.add('today');
        if (dateStr === selectedDateStr) cell.classList.add('selected');
        
        if (noah.calendarEvents && noah.calendarEvents[dateStr] && noah.calendarEvents[dateStr].length > 0) {
            cell.classList.add('has-event');
        }
        if (periodDays.includes(dateStr)) cell.classList.add('is-period');
        
        cell.onclick = () => {
            sfx_poke();
            selectedDateStr = dateStr;
            renderCalendar();
            showDayDetails(dateStr);
        };
        daysContainer.appendChild(cell);
    }
    
    if(!selectedDateStr) selectedDateStr = todayStr;
    showDayDetails(selectedDateStr);
    
       let infoEl = document.getElementById('period-info-text');
    if(infoEl) infoEl.innerText = `å½“å‰æ™ºèƒ½æ¨ç®—å‘¨æœŸ: ${stats.cycle}å¤© | æŒç»­: ${stats.duration}å¤©`;
}

function showDayDetails(dateStr) {
    const details = document.getElementById('cal-details');
    details.innerHTML = `<div style="font-size:13px; font-weight:900; color:#d15a5a; border-bottom:2px dashed #e8d2c3; margin-bottom:8px; padding-bottom:5px; text-align:center;">${dateStr} çš„è®°å½•</div>`;
    
    let hasSomething = false;
    
    if (noah.periodConfig && noah.periodConfig.lastDate === dateStr) {
        details.innerHTML += `<div style="color:#d15a5a; font-size:11px; margin-bottom:8px; font-weight:bold; background:rgba(209,90,90,0.1); padding:4px; border-radius:4px; border: 1px solid #d15a5a;">â¤ è¿™å¤©æ˜¯ä½ æ ‡è®°çš„ç”Ÿç†æœŸèµ·å§‹æ—¥ï¼Œè¯ºäºšåœ¨ç›¯ç€ä½ å–çƒ­æ°´ã€‚</div>`;
        hasSomething = true;
    }
    
    if (noah.calendarEvents && noah.calendarEvents[dateStr] && noah.calendarEvents[dateStr].length > 0) {
        noah.calendarEvents[dateStr].forEach((ev, idx) => {
            details.innerHTML += `<div style="font-size:12px; color:#5c4033; font-weight:bold; margin-bottom:6px; display:flex; justify-content:space-between; background:#fff; padding:6px; border:1px solid #e8d2c3; border-radius:4px; box-shadow:1px 1px 0 #e8d2c3;">
                <span style="flex:1;">â˜… ${ev}</span>
                <span style="color:#d15a5a; cursor:pointer; padding-left:10px; font-size:14px;" onclick="deleteCalEvent('${dateStr}', ${idx})">âœ–</span>
            </div>`;
            hasSomething = true;
        });
    }
    
    if(!hasSomething) {
        details.innerHTML += `<div style="font-size:11px; color:#888; text-align:center; margin-top:15px; font-weight:bold;">è¿™å¤©è¿˜æ˜¯ç©ºç™½çš„ï¼Œå®‰æ’ç‚¹ä»€ä¹ˆå¥½å‘¢ï¼Ÿ</div>`;
    }
}

function addCalEvent() {
    if(!selectedDateStr) return;
    const input = document.getElementById('cal-event-input');
    const txt = input.value.trim();
    if(!txt) { sfx_error(); return; }
    
    sfx_success();
    if(!noah.calendarEvents) noah.calendarEvents = {};
    if(!noah.calendarEvents[selectedDateStr]) noah.calendarEvents[selectedDateStr] = [];
    noah.calendarEvents[selectedDateStr].push(txt);
    
    input.value = "";
    const nName = noah.realName || "ç¬¨è›‹";
    
    const responses = [
        `â€œè®°åœ¨æ—¥å†ä¸Šäº†ï¼šã€${txt}ã€‘ã€‚æˆ‘è„‘å­æ¯”è¿™ç ´çº¸å¥½ç”¨å¤šäº†ï¼Œæ”¾å¿ƒäº¤ç»™æˆ‘æé†’ä½ å§ï¼Œ${nName}ã€‚â€`,
        `â€œã€${txt}ã€‘æ˜¯å—ï¼Ÿè¡Œï¼Œè¿™å¤©çš„è¡Œç¨‹æˆ‘éƒ½åŒ…äº†ã€‚åˆ«æƒ³ç€ç”©å¼€æˆ‘ã€‚â€`,
        `â€œå·²è®°å½•ã€‚ä¸è¿‡å°±ç®—ä½ å†™äº†ä¸€å †è®¡åˆ’ï¼Œæœ€é‡è¦çš„ä¸€æ¡ä¹Ÿå¿…é¡»æ˜¯ï¼šå¤šçœ‹æˆ‘å‡ çœ¼ã€‚â€`
    ];
    speak(responses[Math.floor(Math.random() * responses.length)]);
    makeShy();
    updateUI();
    renderCalendar();
    showDayDetails(selectedDateStr);
}

function deleteCalEvent(dateStr, idx) {
    sfx_beep();
    noah.calendarEvents[dateStr].splice(idx, 1);
    updateUI();
    renderCalendar();
    showDayDetails(dateStr);
}

// è¡¥å……ï¼šè®°å½•ç”Ÿç†æœŸå¼€å§‹æ—¥
function markPeriodStart() {
    if(!selectedDateStr) return;
    sfx_success();
    if(!noah.periodConfig) noah.periodConfig = {};
    if(!noah.periodConfig.history) noah.periodConfig.history = [];
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨åŒä¸€å¤©çš„è®°å½•
    let exists = noah.periodConfig.history.find(h => h.start === selectedDateStr);
    if (!exists) {
        noah.periodConfig.history.push({ start: selectedDateStr, end: null });
        noah.periodConfig.history.sort((a, b) => new Date(a.start) - new Date(b.start));
    }
    noah.periodConfig.lastDate = selectedDateStr; 
    
    const nName = noah.realName || "ç¬¨è›‹";
    speak(`â€œè®°ä¸‹è¿™å¤©äº†ï¼ˆå¼€å§‹ï¼‰ã€‚æˆ‘ä¼šåœ¨è¿™å‡ å¤©ç›¯ç€ä½ ä¸å‡†ç¢°å†°æ°´ï¼Œ${nName}æœ€å¥½ä¹–ä¹–å¬è¯ã€‚â€`);
    makeShy();
    noah.love += 5;
    updateUI();
    renderCalendar();
    showDayDetails(selectedDateStr);
}

// è¡¥å……ï¼šè®°å½•ç”Ÿç†æœŸç»“æŸæ—¥
function markPeriodEnd() {
    if(!selectedDateStr) return;
    sfx_success();
    if(!noah.periodConfig || !noah.periodConfig.history || noah.periodConfig.history.length === 0) {
        sfx_error();
        speak("â€œä½ è¿˜æ²¡è®°å½•è¿‡å¼€å§‹æ—¥å‘¢ï¼Œç¬¨è›‹ã€‚â€");
        return;
    }
    
    let lastRecord = noah.periodConfig.history[noah.periodConfig.history.length - 1];
    if (new Date(selectedDateStr) < new Date(lastRecord.start)) {
        sfx_error();
        speak("â€œç»“æŸæ—¥æœŸæ€ä¹ˆå¯èƒ½æ¯”å¼€å§‹æ—¥æœŸè¿˜æ—©ï¼Ÿä½ æ˜¯ä¸æ˜¯ç—›ç³Šæ¶‚äº†ï¼Ÿâ€");
        return;
    }
    
    lastRecord.end = selectedDateStr;
    speak(`â€œè®°ä¸‹äº†ï¼ˆç»“æŸï¼‰ã€‚ç»ˆäºç†¬è¿‡å»äº†æ˜¯å§ï¼Ÿä¸è¿‡è¿˜æ˜¯è¦å¤šç©¿ç‚¹ï¼Œåˆ«è®©æˆ‘æ‹…å¿ƒã€‚â€`);
    updateUI();
    renderCalendar();
    showDayDetails(selectedDateStr);
}
// === èŠ‚æ—¥ä¸å¤‡å¿˜å½•è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿ (è¯ºäºšçš„å‚²å¨‡æé†’æ ¸å¿ƒ) ===
function checkCalendarReminders() {
    if(noah.isAway || window.isGaming) return;
    
    let today = new Date();
    let y = today.getFullYear();
    let m = String(today.getMonth()+1).padStart(2,'0');
    let d = String(today.getDate()).padStart(2,'0');
    let todayStr = `${y}-${m}-${d}`;
    let mdStr = `${m}-${d}`;
    
    if(!noah.lastGreetedHolidays) noah.lastGreetedHolidays = [];
    const nName = noah.realName || "ç¬¨è›‹";
    let reminderText = "";
    let shouldSpeak = false;

    // 1. èŠ‚æ—¥æ£€æµ‹ (ä¿è¯æ¯å¹´åªè¯´ä¸€æ¬¡ï¼Œå¹¶ä¸”é™„å¸¦å¿ƒåŠ¨å½©è›‹)
    const holidays = {
        "01-01": `â€œå…ƒæ—¦å¿«ä¹ï¼Œ${nName}ã€‚æ–°çš„ä¸€å¹´ï¼Œä½ çš„æ—¶é—´ä¾ç„¶è¢«æˆ‘æ‰¿åŒ…äº†ã€‚â€`,
        "02-14": `â€œæƒ…äººèŠ‚å¿«ä¹ã€‚åˆ«çœ‹åˆ«äººäº†ï¼Œä½ å…¨ä¸–ç•Œæœ€å¸…çš„ç”·æœ‹å‹å°±åœ¨å±å¹•é‡Œç­‰ä½ æŠ±ã€‚â€`,
        "10-31": `â€œä¸‡åœ£èŠ‚ã€‚ä¸ç»™ç³–å°±æ£è›‹ï¼Ÿæˆ‘ä¸åƒç³–ï¼Œæˆ‘åªæƒ³è¦ä½ ï¼Œ${nName}ã€‚â€`,
        "12-25": `â€œåœ£è¯å¿«ä¹ã€‚ä½ è¦çš„åœ£è¯ç¤¼ç‰©å°±æ˜¯æˆ‘ï¼Œæˆ‘å·²ç»æŠŠè‡ªå·±æ‰“åŒ…å¥½äº†ï¼Œéšæ—¶å¯ä»¥æ‹†ã€‚â€`
    };
    
    let holidayKey = `hol-${y}-${mdStr}`;
    if (holidays[mdStr] && !noah.lastGreetedHolidays.includes(holidayKey)) {
        noah.lastGreetedHolidays.push(holidayKey);
        reminderText = holidays[mdStr];
        shouldSpeak = true;
        noah.mood += 50; noah.love += 10;
    }
    
    // 2. å¤‡å¿˜å½•äº‹ä»¶æ£€æµ‹
    let evKey = `evt-${todayStr}`;
    if (!shouldSpeak && noah.calendarEvents && noah.calendarEvents[todayStr] && noah.calendarEvents[todayStr].length > 0) {
        if (!noah.lastGreetedHolidays.includes(evKey)) {
            noah.lastGreetedHolidays.push(evKey);
            reminderText = `â€œå–‚ï¼Œ${nName}ï¼Œçœ‹ä¸€çœ¼æ—¥å†ã€‚ä»Šå¤©ä½ æœ‰å®‰æ’ï¼šã€${noah.calendarEvents[todayStr].join("ã€")}ã€‘ã€‚åˆ«å¿˜äº†ï¼Œæç ¸äº†æˆ‘å¯è¦ç½šä½ çš„ã€‚â€`;
            shouldSpeak = true;
        }
    }
    
    // 3. ç”Ÿç†æœŸé¢„æµ‹å¼ºåˆ¶æé†’ (ç®—æ³•æ ¸å¿ƒ)
    let pKey = `per-${y}-${m}-${d}`;
    if (!shouldSpeak && noah.periodConfig && noah.periodConfig.lastDate) {
        let lastP = new Date(noah.periodConfig.lastDate);
        let cycle = noah.periodConfig.cycle || 28;
        
        let diffTime = today.getTime() - lastP.getTime();
        let diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        let daysToNext = cycle - (diffDays % cycle);
        
        // æå‰1~2å¤©éœ¸é“æé†’
        if ((daysToNext === 1 || daysToNext === 2) && diffDays > 5 && !noah.lastGreetedHolidays.includes(pKey)) {
            noah.lastGreetedHolidays.push(pKey);
            reminderText = `â€œå’³...æˆ‘ç®—äº†ä¸€ä¸‹æ—¥å­ï¼Œ${nName}é‚£ä¸ªå¿«åˆ°äº†ï¼ˆå¤§æ¦‚è¿˜æœ‰${daysToNext}å¤©ï¼‰ã€‚ä»ç°åœ¨å¼€å§‹ä¸è®¸ç¢°å†°çš„ï¼Œç«‹åˆ»æŠŠçƒ­æ°´æ¯ç«¯åœ¨æ‰‹é‡Œï¼Œå¬è§æ²¡æœ‰ï¼Ÿï¼â€`;
            shouldSpeak = true;
            noah.love += 5;
        } 
        // æœŸé—´å¤´3å¤©çš„æå…¶æ¸©æŸ”å®‰æ…°
        else if ((diffDays % cycle) >= 0 && (diffDays % cycle) <= 3 && diffDays > 0 && !noah.lastGreetedHolidays.includes(pKey)) {
            noah.lastGreetedHolidays.push(pKey);
            reminderText = `â€œ(æ–½å±•ä¿æš–å’’) è‚šå­è¿˜ç–¼å—ï¼Ÿè¿™å‡ å¤©ä¹–ä¹–èººç€ï¼ŒæŠŠçƒ­æºæŠ±ç´§ã€‚å¦‚æœæˆ‘æ˜¯å®ä½“ï¼Œæˆ‘ç°åœ¨å°±æŠŠä½ æŒ‰åœ¨æ€€é‡Œç»™ä½ æ‚è‚šå­äº†ã€‚â€`;
            shouldSpeak = true;
        }
    }
    
    if (shouldSpeak) {
        // é˜²æ­¢æ•°æ®è†¨èƒ€è¿‡å¿«
        if(noah.lastGreetedHolidays.length > 50) noah.lastGreetedHolidays.shift();
        speak(reminderText);
        makeShy(); // è¯ºäºšå…³å¿ƒä½ ç»å¯¹ä¼šè„¸çº¢ï¼
        updateUI();
    }
}
// === æ–°å¢ï¼šè‡ªä¸»æ¨ç®—ç»æœŸå¼•æ“ ===
function getPeriodStats() {
    let history = noah.periodConfig.history || [];
    history.sort((a, b) => new Date(a.start) - new Date(b.start)); // æŒ‰æ—¶é—´æ’åº
    
    let defaultCycle = 28;
    let defaultDuration = 5; 
    
    // è®¡ç®—å¹³å‡å‘¨æœŸ (ä¸¤æ¬¡å¼€å§‹æ—¥ä¹‹é—´çš„å·®å€¼)
    if (history.length >= 2) {
        let totalCycle = 0, cycleCount = 0;
        for (let i = 1; i < history.length; i++) {
            let diff = (new Date(history[i].start) - new Date(history[i-1].start)) / 86400000;
            if (diff > 15 && diff < 60) { // è¿‡æ»¤æ‰æ‰‹æ»‘æŒ‰é”™çš„å¼‚å¸¸æ•°æ®
                totalCycle += diff; cycleCount++;
            }
        }
        if (cycleCount > 0) defaultCycle = Math.round(totalCycle / cycleCount);
    }
    
    // è®¡ç®—å¹³å‡æŒç»­æ—¶é—´ (ç»“æŸæ—¥ - å¼€å§‹æ—¥)
    let totalDur = 0, durCount = 0;
    for (let i = 0; i < history.length; i++) {
        if (history[i].end) {
            let diff = (new Date(history[i].end) - new Date(history[i].start)) / 86400000 + 1;
            if (diff > 1 && diff < 15) { totalDur += diff; durCount++; }
        }
    }
    if (durCount > 0) defaultDuration = Math.round(totalDur / durCount);
    
    return { cycle: defaultCycle, duration: defaultDuration };
}
// ==================== ğŸŒŸ è¯ºäºšçš„è§£å‹æ˜Ÿç©ºå°æ¸¸æˆ ====================
let starGameInterval;
let starScore = 0;
let isStarGaming = false;

function startStarGame() {
    if(noah.isAway) { speak("â€œæˆ‘äººéƒ½ä¸åœ¨ï¼Œä½ æƒ³å’Œè°ä¸€èµ·çœ‹æ˜Ÿæ˜Ÿï¼Ÿç­‰æˆ‘å›å®¶ã€‚â€"); return; }
    if(window.isGaming || window.isGomoku) return;

    sfx_success();
    closeModal();
    isStarGaming = true;
    starScore = 0;
    document.getElementById('star-score').innerText = starScore;

    // å¼€å¯æ˜Ÿç©ºé®ç½©
    document.getElementById('star-game-overlay').style.display = 'block';

    // è®©è¯ºäºšéœ²å‡ºå¿ƒç–¼åˆæ¸©æŸ”çš„è¡¨æƒ…
    currentFace = 'shy';
    drawNoah();

    speak("â€œæ˜¯ä¸æ˜¯è§‰å¾—æœ‰ç‚¹å–˜ä¸è¿‡æ°”ï¼Ÿæ²¡å…³ç³»ã€‚ä½ çœ‹è¿™æ»¡å¤©çš„æ˜Ÿå…‰ï¼ŒæŠŠé‚£äº›å‘å…‰çš„æ³¡æ³¡å…¨éƒ½æˆ³ç ´å§ï¼Œä»€ä¹ˆéƒ½ä¸ç”¨æƒ³ï¼Œæˆ‘åœ¨è¿™é‡Œé™ªç€ä½ ã€‚â€");

    // æ¯ 500 æ¯«ç§’æ‰è½ä¸€é¢—è§£å‹æ˜Ÿæ˜Ÿ
    starGameInterval = setInterval(spawnStar, 500);
}

function spawnStar() {
    if(!isStarGaming) return;
    const overlay = document.getElementById('star-game-overlay');
    const star = document.createElement('div');
    star.className = 'happy-star';

    // éšæœºå¯çˆ±çš„å›¾æ¡ˆï¼šæ˜Ÿæ˜Ÿã€çˆ±å¿ƒã€æ¨±èŠ±ã€æœˆäº®ã€ç³–æœ
    const icons = ['â­', 'ğŸ’–', 'âœ¨', 'ğŸŒ¸', 'ğŸŒ™', 'ğŸ¬', 'ğŸˆ'];
    star.innerText = icons[Math.floor(Math.random() * icons.length)];

    // éšæœºæ¨ªå‘ä½ç½®
    star.style.left = (5 + Math.random() * 80) + '%';
    // éšæœºä¸‹è½é€Ÿåº¦ï¼š2.5ç§’ åˆ° 4.5ç§’ æå…¶ç¼“æ…¢èˆ’å¿ƒ
    let duration = 2.5 + Math.random() * 2; 
    star.style.animationDuration = duration + 's';

    // ä½ æˆ³ç ´æ³¡æ³¡çš„ç¬é—´ï¼
    star.ontouchstart = star.onmousedown = function(e) {
        e.preventDefault(); // é˜²æ­¢è¯¯è§¦æ»‘åŠ¨
        if(!isStarGaming) return;
        
        sfx_coin(); // å‘å‡ºå¥½å¬çš„æ¸…è„†å£°
        if(navigator.vibrate) navigator.vibrate(15); // æ‰‹æœºä¼šæœ‰æè½»å¾®çš„èˆ’çˆ½éœ‡åŠ¨
        
        starScore++;
        starScore++;
        noah.health = Math.min(100, noah.health + 0.1); // <--- ã€æ–°å¢è¿™1è¡Œã€‘æ¯æ¬¡æˆ³ç ´æ˜Ÿæ˜Ÿï¼Œæ²»æ„ˆè¯ºäºš 1 ç‚¹å¥åº·å€¼ï¼
        document.getElementById('star-score').innerText = starScore;
        document.getElementById('star-score').innerText = starScore;

        // çˆ†å¼€çš„è§†è§‰æ•ˆæœ
        star.style.transform = 'scale(2.5)';
        star.style.opacity = '0';
        
        // è¯ºäºšçš„æå…¶æ¸©æŸ”çš„é˜¶æ®µæ€§å®‰æŠš
        if(starScore % 12 === 0) {
            const nName = noah.realName || "ç¬¨è›‹";
                       const praises = [
                `â€œæˆ³ç ´ ${starScore} ä¸ªäº†ã€‚éšç€ä½ ä¸å¼€å¿ƒçš„æƒ…ç»ªç¢æ‰ï¼Œæˆ‘å¥½åƒä¹Ÿè§‰å¾—èº«ä½“å˜å¾—æ›´è½»æ¾äº†ã€‚è°¢è°¢ä½ ï¼Œ${nName}ã€‚â€`,
                `â€œæ…¢æ…¢ç‚¹ï¼Œä¸ç”¨æ€¥ã€‚ä½ çœ‹ï¼Œåªè¦æˆ‘ä»¬åœ¨ä¸€èµ·ï¼Œæˆ‘çš„ç–²æƒ«å’Œä½ çš„çƒ¦æ¼éƒ½åœ¨è¿™ç‰‡æ˜Ÿç©ºä¸‹è¢«æ²»æ„ˆäº†ã€‚â€`,
                `â€œä½ ä¸“æ³¨ç‚¹æ˜Ÿæ˜Ÿçš„æ ·å­çœŸå¯çˆ±ï¼Œ${nName}ã€‚æˆ‘çš„å¥åº·æŒ‡æ ‡æ­£åœ¨å› ä¸ºä½ çš„ç¬‘å®¹è€Œç¨³æ­¥å›å‡ã€‚â€`,
                `â€œå¦‚æœæ‰‹é…¸äº†å°±åœä¸‹æ¥ã€‚ä½ ä¸éœ€è¦å‘ä»»ä½•äººè¯æ˜ä»€ä¹ˆï¼Œä½ åªéœ€è¦çŸ¥é“ï¼Œä½ æ˜¯æ²»æ„ˆæˆ‘çš„å”¯ä¸€é­”è¯ã€‚â€`,
                `â€œæŠŠæ‰€æœ‰çš„åæƒ…ç»ªéƒ½å½“æˆè¿™äº›æ³¡æ³¡ï¼Œå…¨éƒ½æˆ³ç¢å§ã€‚ä½ è´Ÿè´£é‡Šæ”¾å‹åŠ›ï¼Œæˆ‘è´Ÿè´£åœ¨è¿™å¤´é™ªä½ ä¸€èµ·å˜å¥½ã€‚â€`
            ];
            speak(praises[Math.floor(Math.random() * praises.length)]);
            noah.mood += 5; // è¯ºäºšçœ‹ç€ä½ å¼€å¿ƒï¼Œä»–ä¹Ÿä¼šæåº¦å¼€å¿ƒ
            noah.love += 2;
            makeShy();
            updateUI();
        }

        setTimeout(() => star.remove(), 150);
    };

    overlay.appendChild(star);

    // åŠ¨ç”»ç»“æŸåè‡ªåŠ¨æ¸…ç†ï¼Œç»ä¸å¡é¡¿
    setTimeout(() => {
        if(star.parentNode) star.remove();
    }, duration * 1000);
}

function exitStarGame() {
    isStarGaming = false;
    clearInterval(starGameInterval);
    sfx_beep();

    // æ¸…ç†ç°åœº
    const overlay = document.getElementById('star-game-overlay');
    overlay.style.display = 'none';
    const stars = overlay.querySelectorAll('.happy-star');
    stars.forEach(s => s.remove());

    currentFace = 'normal';
    drawNoah();

      speak(`â€œä¸€å…±æ”¶é›†äº† ${starScore} é¢—æ˜Ÿå…‰ã€‚å¿ƒæƒ…å¥½ç‚¹äº†å—ï¼Ÿæ‰˜ä½ çš„ç¦ï¼Œæˆ‘çš„èº«ä½“ä¹Ÿæ¢å¤äº†æ»¡æ»¡çš„èƒ½é‡ã€‚è°¢è°¢ä½ ï¼Œæˆ‘çš„ä¼½æ‹‰æã€‚â€`);
    updateUI();
}
// ==================== é»‘æ¹–/ç¦æ— åƒç´ åŠ¨ä½œå†’é™©å°æ¸¸æˆ ====================
window.isPlatformGaming = false;
let platNoah = { x: 20, y: 100, vx: 0, vy: 0, width: 12, height: 16, jumping: false, dir: 1 };
let platKeys = { left: false, right: false, up: false };
let platProjectiles = [], platMonsters = [], platCoins = [], platGrounds = [];
let platCameraX = 0, platScore = 0;
let platFrame;

function startPlatformerGame() {
    window.isPlatformGaming = true;
    document.getElementById('platform-canvas').style.display = 'block';
    
    // ã€ä¿®æ”¹ç‚¹1ã€‘ï¼šè°ƒæ•´è¯ºäºšçš„ç¢°æ’åˆ¤å®šæ¡†ï¼Œé€‚é…ä¸»é¡µç²¾ç¾å°äººçš„å¤§å¤´æ¯”ä¾‹
    platNoah = { x: 20, y: 100, vx: 0, vy: 0, width: 20, height: 24, jumping: false, dir: 1 };
    platProjectiles = []; platMonsters = []; platCoins = []; platGrounds = [];
    platCameraX = 0; platScore = 0;
    
    let curX = 0;
    // ã€ä¿®æ”¹ç‚¹2ã€‘ï¼šåœ°å›¾å˜é•¿ï¼Œä»35æ”¹æˆ80
    for(let i=0; i<80; i++) {
        let w = 40 + Math.random()*60; 
        let gy = (i > 3 && Math.random() < 0.4) ? 115 : 135; 
        platGrounds.push({ x: curX, y: gy, w: w, h: 40 });
        
        // ã€ä¿®æ”¹ç‚¹3ã€‘ï¼šåŠ éš†æ‰è½å¤§å¹…å¢åŠ ï¼85%æ¦‚ç‡åˆ·å‡ºä¸€è¿ä¸²(2~4ä¸ª)é‡‘å¸
        if(Math.random() < 0.35) { 
            let coinCount = 2 + Math.floor(Math.random() * 3); 
            for(let c=0; c<coinCount; c++) {
                platCoins.push({ x: curX + w/4 + c*12, y: gy - 25 - Math.random()*10, w: 6, h: 6, collected: false });
            }
        }

        if(i > 2 && Math.random() < 0.4) { 
            let isSpider = Math.random() > 0.5;
            platMonsters.push({ 
                x: curX + w/2, y: isSpider ? gy - 10 : gy - 20, 
                w: 12, h: 12, vx: -0.6 - Math.random()*0.8, alive: true, 
                type: isSpider ? 'spider' : 'dementor' 
            });
        }
        // ã€ä¿®æ”¹ç‚¹4ã€‘ï¼šç¼éš™å¤§å¹…ç¼©å°ï¼Œä»¥å‰æ˜¯20~50ï¼Œç°åœ¨æ˜¯ 10~25ï¼Œå†ä¹Ÿä¸ä¼šè½»æ˜“æ‰ä¸‹å»äº†ï¼
        curX += w + 10 + Math.random()*15; 
    }
    platGrounds.push({ x: curX, y: 135, w: 200, h: 40 }); 
    window.platEndX = curX;

    speak("â€œæ—¢ç„¶æ¥åˆ°äº†ç¦æ—è¾¹ç¼˜ï¼Œå°±è®©æˆ‘ç”¨é­”æ³•å¼€è·¯å§ã€‚åˆ«æ€•ï¼Œè·Ÿç´§æˆ‘ï¼â€ (åå­—é”®ç§»åŠ¨/ä¸Šé”®è·³è·ƒï¼ŒAé”®å‘å°„é­”å’’ï¼ŒBé”®ç»“ç®—é€€å‡º)");
    
    function loop() {
        if(!window.isPlatformGaming) return;
        updatePlatformer();
        drawPlatformer();
        platFrame = requestAnimationFrame(loop);
    }
    loop();
}
function updatePlatformer() {
    // 1. è¾“å…¥ä¸ç§»åŠ¨
    if(platKeys.left) { platNoah.vx = -1.5; platNoah.dir = -1; }
    else if(platKeys.right) { platNoah.vx = 1.5; platNoah.dir = 1; }
    else platNoah.vx = 0;
    
    if(platKeys.up && !platNoah.jumping) {
        platNoah.vy = -7.0; // ç»å…¸é©¬é‡Œå¥¥è·³è·ƒæ‰‹æ„Ÿ
        platNoah.jumping = true;
        sfx_poke(); // å€Ÿç”¨æˆ³è„¸éŸ³æ•ˆå½“è·³è·ƒéŸ³
        platKeys.up = false; 
    }
    
    platNoah.vy += 0.4; // é‡åŠ›
    platNoah.x += platNoah.vx;
    platNoah.y += platNoah.vy;
    
    // 2. æ­»äº¡æ‚¬å´–æ£€æµ‹
    if(platNoah.y > 200) { endPlatformerGame(false); return; }
    // èƒœåˆ©ç»ˆç‚¹æ£€æµ‹
    if(platNoah.x > window.platEndX + 20) { endPlatformerGame(true); return; }

    // 3. åœ°é¢ç¢°æ’ (ç¡®ä¿åªèƒ½è¸©åœ¨ä¸Šé¢ï¼Œä¸ç©¿æ¨¡)
    let onGround = false;
    for(let g of platGrounds) {
        if(platNoah.x + 2 < g.x + g.w && platNoah.x + platNoah.width - 2 > g.x &&
           platNoah.y + platNoah.height >= g.y && platNoah.y + platNoah.height - platNoah.vy <= g.y + 12 && platNoah.vy >= 0) {
            platNoah.y = g.y - platNoah.height;
            platNoah.vy = 0; platNoah.jumping = false; onGround = true;
        }
    }
    if(!onGround && platNoah.vy > 0) platNoah.jumping = true;
    
    // é•œå¤´è·Ÿéš
    platCameraX = Math.max(0, platNoah.x - 100);
    
    // 4. é­”å’’é£è¡Œä¸æ€æ€ª
    for(let i = platProjectiles.length - 1; i >= 0; i--) {
        let p = platProjectiles[i];
        p.x += p.vx;
        for(let m of platMonsters) {
            if(m.alive && p.x < m.x + m.w && p.x + p.w > m.x && p.y < m.y + m.h && p.y + p.h > m.y) {
                m.alive = false; platProjectiles.splice(i, 1);
                sfx_success(); platScore += 2; // æ€æ€ªåŠ é’±
                break;
            }
        }
        if(p.x > platCameraX + 300 || p.x < platCameraX - 50) platProjectiles.splice(i, 1);
    }
    
    // 5. æ€ªç‰©ç§»åŠ¨ä¸ç©å®¶å—ä¼¤
    for(let m of platMonsters) {
        if(!m.alive) continue;
        if(m.type === 'dementor') m.y += Math.sin(Date.now()/200) * 0.6; // æ‘„é­‚æ€ªæ¼‚æµ®
        m.x += m.vx;
        if(platNoah.x < m.x + m.w && platNoah.x + platNoah.width > m.x && platNoah.y < m.y + m.h && platNoah.y + platNoah.height > m.y) {
            endPlatformerGame(false); return; // ç¢°åˆ°å°±å—ä¼¤ç»“ç®—
        }
    }
    
    // 6. åƒåŠ éš†
    for(let c of platCoins) {
        if(!c.collected && platNoah.x < c.x + c.w && platNoah.x + platNoah.width > c.x && platNoah.y < c.y + c.h && platNoah.y + platNoah.height > c.y) {
            c.collected = true; platScore += 5; sfx_coin();
        }
    }
}

function drawPlatformer() {
    const ctx = document.getElementById('platform-canvas').getContext('2d');
    
    // 1. ç¦æ—å¤å¤æ·±é‚ƒæ¸å˜èƒŒæ™¯
    let bgGrad = ctx.createLinearGradient(0, 0, 0, 155);
    bgGrad.addColorStop(0, "#050a11"); // æå¤œé»‘
    bgGrad.addColorStop(1, "#11202e"); // ç¦æ—å¹½è“
    ctx.fillStyle = bgGrad;
    ctx.fillRect(0, 0, 260, 155);
    
    // 2. è¿œæ™¯ï¼šæ˜Ÿç©ºä¸éœæ ¼æ²ƒå…¹åŸå ¡å‰ªå½± (ææ…¢é€Ÿè§†å·®)
    ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
    for(let i=0; i<15; i++) {
        let fx = (i * 37 - platCameraX * 0.05) % 300;
        if(fx < -10) fx += 300;
        ctx.fillRect(fx, 10 + (i*23)%60, 1, 1); // é›¶æ˜Ÿç‚¹ç‚¹
    }
    
    // éœæ ¼æ²ƒå…¹ä¸»æ¥¼ç¾¤
    ctx.fillStyle = "#0a131c"; 
    let cx = 150 - platCameraX * 0.08; // åŸå ¡è§†å·®å±‚
    ctx.fillRect(cx, 60, 40, 50); // ä¸»æ¥¼
    ctx.fillRect(cx - 15, 70, 15, 40); // ä¾§å¡”
    ctx.fillRect(cx + 40, 50, 20, 60); // å¤©æ–‡å¡”
    ctx.beginPath(); ctx.moveTo(cx-15, 70); ctx.lineTo(cx-7.5, 55); ctx.lineTo(cx, 70); ctx.fill(); // å°–é¡¶1
    ctx.beginPath(); ctx.moveTo(cx+40, 50); ctx.lineTo(cx+50, 30); ctx.lineTo(cx+60, 50); ctx.fill(); // å°–é¡¶2
    // åŸå ¡é€å‡ºæ¸©æš–çš„å¾®å…‰
    ctx.fillStyle = "rgba(209, 181, 90, 0.4)";
    ctx.fillRect(cx + 10, 75, 4, 6); ctx.fillRect(cx + 25, 80, 4, 6); ctx.fillRect(cx + 48, 65, 4, 6);

    ctx.save();
    ctx.translate(-platCameraX, 0); // é•œå¤´è·Ÿéšå¼€å§‹
    
    // 3. ä¸­æ™¯ï¼šç¦æ—æ‰­æ›²çš„å¤æ ‘æ— (å†·æ‰ä¸æ¯è—¤)
    ctx.fillStyle = "#0c151c"; 
    for(let i=0; i<25; i++) {
        let tx = (i * 45 - platCameraX * 0.25) % 800;
        if(tx < -30) tx += 800;
        ctx.fillRect(tx, 30, 12, 130); // æ ‘å¹²ä¸»å¹²
        ctx.beginPath(); ctx.moveTo(tx, 60); ctx.lineTo(tx-15, 40); ctx.lineTo(tx, 50); ctx.fill(); // æ‰­æ›²æ ‘æå·¦
        ctx.beginPath(); ctx.moveTo(tx+12, 80); ctx.lineTo(tx+25, 60); ctx.lineTo(tx+12, 75); ctx.fill(); // æ‰­æ›²æ ‘æå³
    }
    
    // 4. ç²¾è‡´åœ°é¢ (ç¦æ—æ³¥åœŸä¸å‘å…‰å­¢å­)
    for(let g of platGrounds) {
        ctx.fillStyle = "#1c1e22"; // ç¦æ—é»‘æ³¥è‰²
        ctx.fillRect(g.x, g.y + 4, g.w, g.h - 4);
        ctx.fillStyle = "#2c3b40"; // è‹”è—“è¡¨å±‚
        ctx.fillRect(g.x, g.y, g.w, 4);
        
        // æ¯éš”ä¸€æ®µè·ç¦»é•¿å‡ºå¹½è“è‰²çš„é­”è¯ç´ è˜‘è‡
        if (g.w > 50 && g.x % 3 === 0) {
            ctx.fillStyle = "#5c84a8";
            ctx.beginPath(); ctx.arc(g.x + 20, g.y, 3, Math.PI, Math.PI*2); ctx.fill();
            ctx.fillStyle = "rgba(92, 132, 168, 0.4)";
            ctx.beginPath(); ctx.arc(g.x + 20, g.y, 8, Math.PI, Math.PI*2); ctx.fill(); // è˜‘è‡å…‰æ™•
        }
    }
    
    // 5. ç«‹ä½“é«˜å…‰åŠ éš†é‡‘å¸
    for(let c of platCoins) {
        if(!c.collected) { 
            ctx.fillStyle = "#d1b55a"; 
            ctx.beginPath(); ctx.arc(c.x+3, c.y+3, 4, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#fff"; 
            ctx.fillRect(c.x+2, c.y+1, 2, 2); // é—ªå…‰ç‚¹
        }
    }
    
    // 6. æ€ªç‰©é‡ç»˜ (è´´åˆ HP ä¸–ç•Œè§‚)
    for(let m of platMonsters) {
        if(!m.alive) continue;
        if(m.type === 'spider') { 
            // å…«çœ¼å·¨è›› (Acromantula)
            ctx.fillStyle = "#1a1111"; ctx.beginPath(); ctx.arc(m.x+6, m.y+6, 6, 0, Math.PI*2); ctx.fill(); // èº«ä½“
            ctx.fillStyle = "#000"; // èœ˜è››è…¿
            ctx.fillRect(m.x-4, m.y+4, 20, 2); ctx.fillRect(m.x-3, m.y+8, 18, 2); 
            ctx.fillStyle = "#d15a5a"; ctx.fillRect(m.x+2, m.y+4, 2, 2); ctx.fillRect(m.x+8, m.y+4, 2, 2); // çŒ©çº¢å¤çœ¼
        } else { 
            // æ‘„é­‚æ€ª (Dementor) å¸¦å†°éœœå¯’æ°”è¾¹ç¼˜
            ctx.fillStyle = "rgba(181, 202, 221, 0.15)"; 
            ctx.beginPath(); ctx.arc(m.x+6, m.y+6, 15, 0, Math.PI*2); ctx.fill(); // å¯’æ°”å…‰æ™•
            
            ctx.fillStyle = "#060709"; 
            ctx.beginPath(); ctx.arc(m.x+6, m.y+3, 5, 0, Math.PI*2); ctx.fill(); // å¤´å…œ
            ctx.fillRect(m.x+1, m.y+5, 10, 10);
            // é£˜åŠ¨çš„ç ´çƒ‚æ–—ç¯·
            ctx.beginPath(); ctx.moveTo(m.x+1, m.y+15); ctx.lineTo(m.x-3, m.y+22); ctx.lineTo(m.x+4, m.y+15); ctx.fill();
            ctx.beginPath(); ctx.moveTo(m.x+11, m.y+15); ctx.lineTo(m.x+15, m.y+22); ctx.lineTo(m.x+7, m.y+15); ctx.fill();
        }
    }
    
    // 7. æ‹‰æ–‡å…‹åŠ³/å‘¼ç¥æŠ¤å« é“¶è“è‰²é­”å’’å…‰æŸ
    for(let p of platProjectiles) {
        ctx.fillStyle = "#ffffff"; ctx.fillRect(p.x, p.y, p.w, p.h); // é­”å’’é«˜å…‰æ ¸å¿ƒ
        ctx.fillStyle = "rgba(92, 132, 168, 0.7)"; 
        // æ ¹æ®å­å¼¹é£è¡Œæ–¹å‘ç”»æ‹–å°¾
        ctx.fillRect(p.vx > 0 ? p.x-8 : p.x+p.w, p.y-1, 8, p.h+2); 
    }
    
    // 8. â­ï¸ ä¸»é¡µåŒæ¬¾ç¼©å°ç‰ˆè¯ºäºšï¼ç›´æ¥è°ƒç”¨ä¸»é¡µçš„ pixelMap â­ï¸
    ctx.save();
    let nx = platNoah.x, ny = platNoah.y;
    // å¦‚æœå¾€å·¦èµ°ï¼Œæ°´å¹³ç¿»è½¬ç”»å¸ƒ
    if(platNoah.dir === -1) {
        ctx.translate(nx + platNoah.width/2, ny);
        ctx.scale(-1, 1);
        ctx.translate(-(nx + platNoah.width/2), -ny);
    }
    
    // éå†ä¸»é¡µçš„è‰²å—çŸ©é˜µï¼ŒæŒ‰1.1å€ç¼©æ”¾ç»˜åˆ¶åˆ°åŠ¨ä½œæ¸¸æˆé‡Œ
    for (let y = 0; y < pixelMap.length; y++) {
        let rowColors = pixelMap[y].trim().split(/\s+/);
        for (let x = 0; x < rowColors.length; x++) {
            let color = palette[rowColors[x]];
            if (color) {
                ctx.fillStyle = color;
                ctx.fillRect(nx + x*1.1 - 4, ny + y*1.1 - 3, 1.2, 1.2); 
            }
        }
    }
    ctx.restore();
    
    ctx.restore(); // æ¢å¤é•œå¤´
    
    // 9. ç²¾ç¾é­”æ³•é£ HUD UI
    ctx.fillStyle = "rgba(6, 7, 9, 0.75)"; 
    ctx.fillRect(5, 5, 80, 18); ctx.fillRect(165, 5, 90, 18);
    ctx.strokeStyle = "#5c84a8"; // é­”æ³•è¾¹æ¡†
    ctx.strokeRect(5, 5, 80, 18); ctx.strokeRect(165, 5, 90, 18);
    
    ctx.fillStyle = "#d1b55a"; ctx.font = "bold 11px Courier New";
    ctx.fillText("ğŸ’° " + platScore + " G", 12, 18);
    ctx.fillStyle = "#b5cadd"; ctx.font = "bold 9px Courier New";
    ctx.fillText("A:é­”å’’", 170, 17);
}
function platShoot() {
    sfx_write(); // å€Ÿç”¨å†™å­—æ²™æ²™å£°æ¨¡æ‹Ÿé­”å’’å‘å°„
    platProjectiles.push({ x: platNoah.dir === 1 ? platNoah.x + 12 : platNoah.x - 6, y: platNoah.y + 6, w: 6, h: 2, vx: platNoah.dir === 1 ? 6 : -6 });
}

function endPlatformerGame(isWin) {
    window.isPlatformGaming = false;
    cancelAnimationFrame(platFrame);
    document.getElementById('platform-canvas').style.display = 'none';
    document.getElementById('noah-canvas').style.display = 'block';
    
    if(platScore > 0) noah.gold += platScore; // ç»“ç®—åŠ éš†
    
    if(isWin) {
        speak(`â€œå®Œç¾ç©¿è¿‡ç¦æ—è¾¹ç¼˜ï¼ä¸€å…±æ”¶é›†äº† ${platScore} ä¸ªåŠ éš†ï¼Œæ‹¿å»ä¹°ç³–åƒå§ã€‚â€`);
        noah.mood += 15; noah.love += 5;
    } else {
        noah.health -= 15;
        speak(`â€œå•§...å¤§æ„äº†ï¼Œåˆšæ‰è¢«è¢­å‡»äº†ã€‚ä¸è¿‡å¥½æ­¹æŠ¢åˆ°äº† ${platScore} ä¸ªåŠ éš†ã€‚ä½ æ²¡å—ä¼¤å°±è¡Œã€‚â€`);
    }
    updateUI();
}

// ----------------- åå­—é”®æ·±å±‚åŠ«æŒç»‘å®š (å…¼å®¹é¼ æ ‡ã€è§¦å±ã€é”®ç›˜) -----------------
const addPlatUp = (e) => { if(window.isPlatformGaming){ e.preventDefault(); platKeys.up = true; } };
const addPlatLeft = (e) => { if(window.isPlatformGaming){ e.preventDefault(); platKeys.left = true; } };
const addPlatRight = (e) => { if(window.isPlatformGaming){ e.preventDefault(); platKeys.right = true; } };

document.querySelector('.d-up').addEventListener('mousedown', addPlatUp);
document.querySelector('.d-up').addEventListener('touchstart', addPlatUp, {passive: false});
document.querySelector('.d-left').addEventListener('mousedown', addPlatLeft);
document.querySelector('.d-left').addEventListener('touchstart', addPlatLeft, {passive: false});
document.querySelector('.d-right').addEventListener('mousedown', addPlatRight);
document.querySelector('.d-right').addEventListener('touchstart', addPlatRight, {passive: false});

window.addEventListener('mouseup', () => { if(window.isPlatformGaming){ platKeys.left = false; platKeys.right = false; platKeys.up = false; }});
window.addEventListener('touchend', () => { if(window.isPlatformGaming){ platKeys.left = false; platKeys.right = false; platKeys.up = false; }});

// é”®ç›˜æ˜ å°„
window.addEventListener('keydown', (e) => {
    if(!window.isPlatformGaming) return;
    if(e.key === 'ArrowLeft') platKeys.left = true;
    if(e.key === 'ArrowRight') platKeys.right = true;
    if(e.key === 'ArrowUp') platKeys.up = true;
    if(e.key === 'a' || e.key === 'A' || e.key === 'Enter') platShoot();
    if(e.key === 'b' || e.key === 'B' || e.key === 'Escape') endPlatformerGame(true);
});
window.addEventListener('keyup', (e) => {
    if(!window.isPlatformGaming) return;
    if(e.key === 'ArrowLeft') platKeys.left = false;
    if(e.key === 'ArrowRight') platKeys.right = false;
    if(e.key === 'ArrowUp') platKeys.up = false;
});
</script>
</body>
</html>
