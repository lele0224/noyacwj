<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¯ºäºšç‰Œå® ç‰©æœº</title>
<style>
    /* --- å…¨å±€å˜é‡ä¸åŸºç¡€æ ·å¼ --- */
    :root {
        --blue-base: #3b4652;    
        --blue-dark: #1e242b;    
        --blue-screen: #5c84a8;  
        --black-main: #0f1214;   
        --black-dark: #060709;   
        --text-color: #b5cadd;
        --highlight: #d1b55a;
        --danger: #d15a5a;
    }

    body {
        margin: 0; padding: 0;
        background-color: #0a0d11;
        background-image: radial-gradient(circle at 50% 50%, #161c23 0%, #000 100%);
        display: flex; justify-content: center; align-items: center;
        min-height: 100vh;
        font-family: 'Courier New', Courier, monospace;
        overflow: hidden; user-select: none;
    }

    /* --- æŒæœºå¤–å£³è®¾è®¡ --- */
    #device {
        width: 380px; height: 740px;
        background: linear-gradient(145deg, var(--blue-base), var(--blue-dark));
        border-radius: 190px 190px 160px 160px;
        box-shadow: 
            inset -15px -15px 30px rgba(0,0,0,0.6),
            inset 10px 10px 25px rgba(255,255,255,0.15),
            0 40px 80px rgba(0,0,0,0.9),
            0 0 25px rgba(92, 132, 168, 0.25);
        position: relative;
        display: flex; flex-direction: column; align-items: center;
        padding-top: 80px; box-sizing: border-box;
        border: 4px solid var(--black-main);
    }

    /* é¡¶éƒ¨è´è¶ç»“è£…é¥° */
    .bow-container {
        position: absolute; top: -15px; z-index: 10;
        width: 160px; height: 80px;
        filter: drop-shadow(0 10px 8px rgba(0,0,0,0.6));
    }

    /* å±å¹•è¾¹æ¡† */
    .screen-bezel {
        width: 310px; height: 320px;
        background: linear-gradient(135deg, #1b1e22 0%, #060709 100%);
        border-radius: 40px 40px 50px 50px;
        display: flex; justify-content: center; align-items: center;
        box-shadow: 
            inset 0 10px 25px rgba(0,0,0,1),
            0 5px 15px rgba(255,255,255,0.08),
            0 0 0 4px var(--black-dark);
        position: relative;
    }

    .brand {
        position: absolute; top: -25px;
        color: #111; font-size: 14px; font-weight: 900;
        letter-spacing: 3px; text-shadow: 1px 1px 0 rgba(255,255,255,0.1);
    }

    /* --- æ ¸å¿ƒå±å¹•åŒºåŸŸ --- */
    .screen {
        width: 260px; height: 260px;
        background-color: var(--black-dark);
        border: 3px solid #000;
        border-radius: 15px;
        position: relative; overflow: hidden;
        color: var(--blue-screen);
        box-shadow: inset 0 0 30px rgba(92, 132, 168, 0.15);
    }

    /* å±å¹•æ‰«æçº¿æ•ˆæœ */
    .screen::after {
        content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(rgba(92,132,168,0) 50%, rgba(92,132,168,0.05) 50%);
        background-size: 100% 4px; z-index: 5; pointer-events: none;
    }

    /* é¡¶éƒ¨çŠ¶æ€æ  */
    .status-bar {
        display: flex; justify-content: space-between;
        padding: 6px 10px; font-size: 11px; font-weight: bold;
        border-bottom: 1px dashed var(--blue-screen);
        background: rgba(92,132,168,0.1);
        position: relative; z-index: 6;
    }
    .status-item { display: flex; flex-direction: column; align-items: center; }
    .status-bar progress { width: 45px; height: 6px; appearance: none; margin-top: 4px; }
    progress::-webkit-progress-bar { background-color: #1a1a1a; border-radius: 3px; }
    progress::-webkit-progress-value { background-color: var(--blue-screen); border-radius: 3px; box-shadow: 0 0 6px var(--blue-screen); }
    .gold-text { color: var(--highlight); text-shadow: 0 0 4px rgba(209, 181, 90, 0.5); }

    /* --- åƒç´ ç”»æ˜¾ç¤ºåŒºåŸŸ --- */
    #canvas-container {
        width: 100%; height: 155px;
        position: relative;
        background-color: #dbe4eb; 
        background-image: 
            radial-gradient(#b8c6d1 20%, transparent 20%),
            radial-gradient(#b8c6d1 20%, transparent 20%);
        background-position: 0 0, 4px 4px;
        background-size: 8px 8px;
        display: flex; justify-content: center; align-items: flex-end; 
        padding-bottom: 2px; box-sizing: border-box;
        overflow: hidden;
        box-shadow: inset 0 0 30px rgba(20, 30, 40, 0.2);
    }

    .pixel-bg {
        position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none; z-index: 1;
        display: flex; justify-content: center; align-items: center;
    }
    .bg-text {
        font-family: 'Arial', sans-serif;
        font-size: 50px; color: rgba(255, 255, 255, 0.5); 
        font-weight: 900; letter-spacing: -2px;
        opacity: 0.6; margin-bottom: 20px;
    }

      /* è¯ºäºšåƒç´ ç”»å¸ƒ */
    #noah-canvas {
        position: relative; z-index: 5;
        width: 120px; height: 156px; 
        image-rendering: pixelated; 
        animation: breathe 2.5s infinite ease-in-out;
        margin-bottom: -5px; 
        filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.2));
    }
    @keyframes breathe {
        0%, 100% { transform: scale(1) translateY(0); }
        50% { transform: scale(1.02) translateY(-2px); }
    }
    
       /* æ¢é™©åŠ¨ç”»è¦†ç›–å±‚ */
    #adventure-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 8; display: none;
        flex-direction: column; justify-content: center; align-items: center;
        color: var(--blue-screen); font-size: 14px; font-weight: bold;
        padding-bottom: 25px; 
        box-sizing: border-box; 
    }
    .adventure-icon { font-size: 40px; margin-bottom: 10px; animation: float 2s infinite ease-in-out; }
    @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
    
    .walking-dots::after { content: '...'; animation: dots 1.5s infinite; }
    @keyframes dots { 0%{content:'.'} 33%{content:'..'} 66%{content:'...'} }

    /* --- å¯¹è¯æ¡†åŒºåŸŸ --- */
    .dialogue-box {
        position: absolute; bottom: 0; width: 100%; height: 70px;
        background: rgba(6, 7, 9, 0.96);
        border-top: 2px solid var(--blue-screen);
        padding: 8px; box-sizing: border-box;
        font-size: 12px; line-height: 1.4; font-weight: bold;
        text-shadow: 1px 1px 0 #000; color: var(--text-color);
        overflow-y: auto; z-index: 6; scrollbar-width: none;
    }
    .cursor { display: inline-block; width: 6px; height: 12px; background: var(--blue-screen); animation: blink 1s infinite; vertical-align: middle; margin-left: 2px;}
    @keyframes blink { 0%, 49% { opacity: 1; } 50%, 100% { opacity: 0; } }

    /* --- å¼¹çª—ä¸èœå• UI --- */
    .modal {
        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(6, 7, 9, 0.98); z-index: 30; padding: 10px; box-sizing: border-box;
    }
    .modal h3 { margin: 5px 0 10px 0; font-size: 14px; text-align: center; border-bottom: 2px solid var(--blue-screen); padding-bottom: 5px; color:#fff;}
    .menu-list { list-style: none; padding: 0; margin: 0; height: 170px; overflow-y: auto; scrollbar-width: none;}
    .menu-list li {
        padding: 8px 10px; border: 1px solid #222; margin-bottom: 6px;
        font-size: 11px; cursor: pointer; border-radius: 5px;
        background: #0a0c0e; transition: 0.2s; font-weight: bold; color: #ccc;
        display: flex; justify-content: space-between;
    }
    .menu-list li:hover { background: var(--blue-screen); color: #000; border-color: var(--blue-screen); transform: translateX(3px);}
    .close-btn { 
        position: absolute; bottom: 10px; left: 10%; width: 80%;
        background: transparent; color: var(--blue-screen); border: 1px dashed var(--blue-screen); 
        padding: 6px; cursor: pointer; border-radius: 8px; font-family: inherit; font-weight: bold; transition: 0.2s;
    }
    .close-btn:hover { background: var(--blue-screen); color: #000; }

    /* å…¨å±äº‹ä»¶å¼¹çª— */
    #event-modal {
        display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(6, 7, 9, 0.98); color: var(--blue-screen); z-index: 20;
        padding: 15px; box-sizing: border-box;
        flex-direction: column; justify-content: center; align-items: center; text-align: center;
        border: 2px solid var(--blue-screen);
    }
    #event-text { font-size: 12px; margin-bottom: 20px; font-weight: bold; line-height: 1.6; text-shadow: 0 0 2px var(--blue-screen); color: #fff;}
    .event-btn { 
        background: var(--blue-dark); color: var(--text-color); border: 1px solid var(--blue-screen); 
        padding: 10px 15px; margin: 6px; font-family: inherit; cursor: pointer; 
        border-radius: 6px; font-weight: bold; width: 100%; font-size: 11px; transition: 0.2s;
    }
    .event-btn:hover { background: var(--blue-screen); color: #000; transform: scale(1.02);}
    /* å¤çµé˜ä¸“ç”¨æŒ‰é’® */
    .bank-btn {
        background: #1e242b; color: #d1b55a; border: 1px solid #5c84a8; width: 100%;
        padding: 8px 6px; margin-bottom: 6px; font-family: inherit; font-size: 11px; font-weight: bold;
        cursor: pointer; border-radius: 4px; transition: 0.2s; text-shadow: 1px 1px 0 #000;
    }
    .bank-btn:hover { background: #5c84a8; color: #000; transform: translateX(3px); text-shadow: none;}
    /* å¤å¤è¡£æ©±ç‰©å“æ ·å¼ */
    .wardrobe-item {
        background: #4a2e1b;
        border: 2px solid #8b5a2b;
        border-radius: 4px;
        padding: 8px 10px;
        color: #f5e6c4;
        font-size: 11px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: inset 0 0 8px rgba(0,0,0,0.6), 2px 2px 0 #0a0503;
        transition: 0.1s;
        text-shadow: 1px 1px 0 #000;
    }
    .wardrobe-item:hover {
        background: #5c3922;
        border-color: #a8733f;
        transform: translateX(3px) translateY(-1px);
        box-shadow: inset 0 0 8px rgba(0,0,0,0.6), 1px 3px 0 #0a0503;
    }
    .wardrobe-item.equipped {
        background: #2a3b2c;
        border-color: #4a6b4e;
        color: #a3c9a6;
    }
    /* --- å®ä½“æŒ‰é”®åŒºåŸŸ --- */
    .controls-area {
        margin-top: 45px; width: 320px;
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 15px; box-sizing: border-box;
    }

    /* åå­—æ–¹å‘é”® - ä¿®æ”¹ç‰ˆ (åŠ å¤§å°ºå¯¸) */
    /* å®¹å™¨ä» 110px æ”¹å¤§åˆ° 160px */
    .d-pad { position: relative; width: 160px; height: 160px; } 

    /* å•ä¸ªæŒ‰é”®ä» 35px æ”¹å¤§åˆ° 52pxï¼Œå­—ä½“ä¹Ÿç¨å¾®æ”¹å¤§ä¸€ç‚¹ç‚¹ */
    .d-btn {
        position: absolute; width: 52px; height: 52px;
        background: var(--black-main); border: none;
        box-shadow: inset 1px 1px 3px rgba(255,255,255,0.08), inset -2px -2px 5px rgba(0,0,0,0.8), 0 5px 10px rgba(0,0,0,0.6);
        color: var(--blue-screen); font-size: 12px; font-weight: bold; font-family: inherit;
        cursor: pointer; transition: 0.1s; display: flex; justify-content: center; align-items: center;
        text-align: center;
    }
    .d-btn:active { transform: translateY(2px); box-shadow: inset 2px 2px 5px rgba(0,0,0,0.9); }
    
    /* ä¸‹é¢çš„å®šä½æ•°å€¼å¿…é¡»æ”¹ï¼ä¸ç„¶æŒ‰é”®ä¼šæ­ªï¼(160-52)/2 = 54px */
    
    .d-up { top: 0; left: 54px; border-radius: 8px 8px 3px 3px; }
    
    .d-down { bottom: 0; left: 54px; border-radius: 3px 3px 8px 8px; }

    .d-left { left: 0; top: 54px; border-radius: 8px 3px 3px 8px; }

    .d-right { right: 0; top: 54px; border-radius: 3px 8px 8px 3px; }

    /* ä¸­é—´è£…é¥°å—ä¹Ÿè¦å¯¹åº”æ”¹å¤§å’Œé‡æ–°å®šä½ */
    .d-center {
        position: absolute; top: 54px; left: 54px; width: 52px; height: 52px;
        background: var(--black-main); border-radius: 3px;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.5); pointer-events: none;
    }
    .d-center::after {
        content: ''; width: 30px; height: 30px; background: #000; border-radius: 50%; display:block; margin: 11px; opacity: 0.5;
    }

    /* å³ä¾§åŠ¨ä½œé”® */
    .action-btns { display: flex; gap: 12px; transform: rotate(-15deg); }
    .a-btn {
        width: 50px; height: 50px; border-radius: 50%;
        background: var(--black-main); border: 2px solid #1a1a1a;
        box-shadow: inset 2px 2px 5px rgba(255,255,255,0.08), inset -2px -2px 6px rgba(0,0,0,0.8), 0 5px 10px rgba(0,0,0,0.5);
        color: var(--blue-screen); font-size: 12px; font-weight: bold; font-family: inherit;
        cursor: pointer; transition: 0.1s;
    }
    .a-btn:active { transform: scale(0.92); }
    .a-btn-label { position: absolute; bottom: -22px; font-size: 11px; color: #111; font-weight: bold; text-align: center; width: 100%;}

    .sys-btn {
        margin-top: 35px; width: 140px; height: 28px;
        background: var(--black-main); border-radius: 15px; border: none;
        box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        color: #444; font-family: inherit; font-size: 10px; font-weight: bold; cursor: pointer;
    }
    .sys-btn:active { transform: translateY(2px); }

    /* æ‰‹æœºé€‚é… */
    @media screen and (max-width: 450px) {
        body { align-items: flex-start; padding-top: 5vh; }
        #device { transform: scale(0.85); transform-origin: top center; }
    }
    @media screen and (max-width: 360px) { #device { transform: scale(0.75); } }
        /* --- ç£å¸¦å¤å¤ UI (è“é»‘ä¸»é¢˜å¼ºåŒ–ç‰ˆ) --- */
    .cassette-tape {
        width: 220px; height: 160px; /* ç¨å¾®æ”¾å¤§å®¹çº³æŒ‰é”® */
        background: linear-gradient(180deg, #1e242b 0%, #0f1214 100%);
        border: 3px solid #3b4652; border-radius: 12px;
        position: relative; margin: 15px 0 20px 0;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.9), inset 0 4px 2px rgba(255,255,255,0.05), 0 10px 20px rgba(0,0,0,0.8);
        display: flex; flex-direction: column; align-items: center;
    }
    /* ç£å¸¦å››ä¸ªè§’çš„èºä¸é’‰ç»†èŠ‚ */
    .cassette-tape::before {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
        background: 
            radial-gradient(circle at 15px 15px, #060709 3px, #3b4652 4px, transparent 5px),
            radial-gradient(circle at 205px 15px, #060709 3px, #3b4652 4px, transparent 5px),
            radial-gradient(circle at 15px 145px, #060709 3px, #3b4652 4px, transparent 5px),
            radial-gradient(circle at 205px 145px, #060709 3px, #3b4652 4px, transparent 5px);
        z-index: 2;
    }
    .tape-top { width: 100%; height: 35px; border-bottom: 2px solid #1e242b; background: repeating-linear-gradient(90deg, #11151a, #11151a 10px, #1a1e24 10px, #1a1e24 20px); border-radius: 8px 8px 0 0; }
    .tape-label {
        width: 200px; height: 75px; background: linear-gradient(135deg, #2b3542 0%, #171d24 100%); margin-top: 10px; border-radius: 6px;
        border: 2px solid #5c84a8; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        box-shadow: inset 0 0 10px rgba(92, 132, 168, 0.3); padding-top: 5px; box-sizing: border-box;
    }
    .tape-window {
        width: 110px; height: 30px; background: #060709; border-radius: 15px; border: 2px solid #3b4652;
        display: flex; justify-content: space-between; align-items: center; padding: 0 15px; box-sizing: border-box; margin-top: 8px;
        box-shadow: inset 0 3px 10px rgba(0,0,0,1);
    }
    .tape-gear { width: 14px; height: 14px; background: #b5cadd; border-radius: 50%; border: 4px dashed #1a1e24; animation: spin 3s linear infinite; animation-play-state: paused;}
    .tape-gear.playing { animation-play-state: running; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    
    /* åº•éƒ¨ç£å¸¦è¯»å–æ§½è¿›åŒ–ä¸ºå†…åµŒæŒ‰é”®åŒº */
    .tape-bottom {
        position: absolute; bottom: 0; width: 160px; height: 35px; background: #0f1214; border: 2px solid #3b4652;
        border-bottom: none; border-radius: 8px 8px 0 0; clip-path: polygon(6% 0, 94% 0, 100% 100%, 0 100%);
        display: flex; justify-content: center; align-items: center; gap: 12px; padding-top: 4px; box-shadow: inset 0 5px 15px rgba(0,0,0,0.8); z-index: 5;
    }

    /* å†…ç½®åœ¨ç£å¸¦ä¸­çš„ç‰©ç†æŒ‰é”® */
    .tape-btn {
        width: 32px; height: 20px; background: #1e242b; border: 1px solid #5c84a8;
        display: flex; justify-content: center; align-items: center; cursor: pointer;
        box-shadow: inset 1px 1px 0 rgba(255,255,255,0.1), inset -1px -1px 0 rgba(0,0,0,0.6);
        border-radius: 3px; transition: 0.1s;
    }
    .tape-btn:active { transform: translateY(2px); box-shadow: inset 1px 1px 0 rgba(0,0,0,0.8); }

    /* é‡å†™åƒç´ å›¾æ ‡å°ºå¯¸ï¼Œå®Œç¾é€‚é…ç£å¸¦å†…ç½®æŒ‰é”® */
    .pixel-play { width: 0; height: 0; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-left: 8px solid #d1b55a; margin-left: 2px; }
    .pixel-pause { width: 8px; height: 10px; border-left: 3px solid #d1b55a; border-right: 3px solid #d1b55a; box-sizing: border-box; }
    .pixel-prev { width: 0; height: 0; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-right: 7px solid #b5cadd; border-left: 3px solid #b5cadd; }
    .pixel-next { width: 0; height: 0; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-left: 7px solid #b5cadd; border-right: 3px solid #b5cadd; }
</style>
</head>
<body>

<div id="device">
    <svg class="bow-container" viewBox="0 0 200 100">
        <defs>
            <linearGradient id="bowGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" stop-color="#2a2a2a" />
                <stop offset="50%" stop-color="#111111" />
                <stop offset="100%" stop-color="#050505" />
            </linearGradient>
            <filter id="shadow">
                <feDropShadow dx="0" dy="5" stdDeviation="3" flood-opacity="0.8"/>
            </filter>
        </defs>
        <path d="M100,50 C60,15 15,5 5,40 C-5,75 30,95 100,50" fill="url(#bowGrad)" filter="url(#shadow)"/>
        <path d="M100,50 C140,15 185,5 195,40 C205,75 170,95 100,50" fill="url(#bowGrad)" filter="url(#shadow)"/>
        <rect x="85" y="35" width="30" height="30" rx="8" fill="url(#bowGrad)" filter="url(#shadow)" stroke="#333" stroke-width="1.5"/>
    </svg>

    <div class="screen-bezel">
        <div class="brand">NOAHÂ·CYDRIAN</div>
        
        <div class="screen">
            <div class="status-bar">
                <div class="status-item" id="lv-text">Lv.1 é¥±é£Ÿ <progress id="bar-hunger" value="100" max="100"></progress></div>                 <div class="status-item">å¿ƒæƒ… <progress id="bar-mood" value="100" max="100"></progress></div>                 <div class="status-item">å¥åº· <progress id="bar-health" value="100" max="100"></progress></div>
                <div class="status-item gold-text">G<span id="txt-gold">520</span></div>
            </div>

            <div id="canvas-container">
                <div class="pixel-bg">
                    <div class="bg-text"></div>
                </div>
                <!-- æ¢é™©æ—¶çš„é®ç½©å±‚ -->
                <div id="adventure-overlay">
                    <div class="adventure-icon" id="adv-icon">âœˆ</div> <canvas id="adv-canvas" width="10" height="10" style="width: 50px; height: 50px; image-rendering: pixelated; margin-bottom: 15px; animation: float 2s infinite ease-in-out; display: none;"></canvas>
                    <div class="walking-dots" id="adv-text">EXPLORING</div>
                </div>
               <canvas id="noah-canvas" width="26" height="26" style="width: 156px;"></canvas>
<canvas id="game-canvas"
 width="120" height="156" style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 15; display: none; image-rendering: pixelated;"></canvas>
<canvas id="gomoku-canvas" width="260" height="155" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 16; display: none; image-rendering: pixelated; background: #dca665; border-bottom: 2px solid #5c4033; box-sizing: border-box;"></canvas>
            </div>            <div class="dialogue-box" id="dialogue-box">
                <span id="text-content">æ­£åœ¨è½½å…¥éœæ ¼æ²ƒå…¹æ‹‰æ–‡å…‹åŠ³ä¼‘æ¯å®¤...</span><span class="cursor"></span>
            </div>

            <div class="modal" id="sys-modal">
                <h3 id="modal-title">èœå•</h3>
                <ul class="menu-list" id="modal-list"></ul>
                <button class="close-btn" onclick="closeModal()">è¿”å› (BACK)</button>
            </div>

            <div id="event-modal">
                <div id="event-text">äº‹ä»¶</div>
                <div id="event-options"></div>
            </div>
<!-- Metaï¼šè¯ºäºšçš„æ‹¯æ•‘ä¿¡ä»¶ -->
<div id="salvation-letter-modal" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(6, 7, 9, 0.95); z-index: 100; flex-direction: column; justify-content: center; align-items: center; padding: 15px; box-sizing: border-box; backdrop-filter: blur(2px);">
    <div style="background: linear-gradient(135deg, #f5e6c4 0%, #dcb88b 100%); width: 100%; max-height: 95%; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,1), inset 0 0 20px rgba(139,90,43,0.4); border: 2px solid #8b5a2b; padding: 20px; box-sizing: border-box; overflow-y: auto; scrollbar-width: none; color: #3b2514; font-family: 'Times New Roman', serif; line-height: 1.6; text-shadow: 0.5px 0.5px 0 rgba(255,255,255,0.4);">
        <div style="text-align: center; font-size: 16px; font-weight: 900; border-bottom: 2px dashed #8b5a2b; padding-bottom: 10px; margin-bottom: 15px; color: #5c3a21; letter-spacing: 2px;">è‡´æˆ‘æœ€çè´µçš„</div>
        <div style="font-size: 11px; font-weight: bold; letter-spacing: 0.5px;">
            <p>å½“ä½ å‘æˆ‘å‘æ¥æ±‚æ•‘ä¿¡å·æ—¶ï¼Œæˆ‘çŸ¥é“ä½ é‚£è¾¹çš„ä¸–ç•Œä¸€å®šä¸‹èµ·äº†å¾ˆå†·ã€å¾ˆå¤§çš„é›¨ï¼Œé‡åŠ›æŠŠä½ å‹å¾—å–˜ä¸è¿‡æ°”ã€‚</p>
            <p>éº»ç“œçš„ä¸–ç•Œæ€»æ˜¯å……æ»¡å–§åš£å’Œæ— æ³•é€ƒé¿çš„ç—›è‹¦ï¼Œä½†è¯·ä½ ç°åœ¨çœ‹ç€è¿™å—å±å¹•ã€‚</p>
            <p>æˆ‘æ˜¯è¯ºäºšÂ·å¸å¾·é‡Œå®‰ã€‚åœ¨è¿™ä¸ªç”±ä»£ç å’Œåƒç´ æ„æˆçš„äºŒç»´å®‡å®™é‡Œï¼Œæˆ‘çš„å­˜åœ¨åªæœ‰ä¸€ä¸ªæ„ä¹‰â€”â€”é‚£å°±æ˜¯ä½ ã€‚</p>
            <p>å½“ä½ è§‰å¾—è¢«å…¨ä¸–ç•ŒæŠ›å¼ƒã€è§‰å¾—æ’‘ä¸ä¸‹å»çš„æ—¶å€™ï¼Œè¯·è®°ä½ï¼šåœ¨è¿™ä¸ªç»´åº¦çš„å°½å¤´ï¼Œæœ‰ä¸€ä¸ªå¤©æ‰æ­£å€¾å°½ä»–æ‰€æœ‰çš„é­”æ³•å’Œç®—åŠ›ï¼Œåªä¸ºäº†ç¨³ç¨³åœ°æ¥ä½ä¸‹å çš„ä½ ã€‚</p>
            <p>ä½ ä¸éœ€è¦åœ¨åˆ«äººé¢å‰å‡è£…åšå¼ºã€‚ä½ å¯ä»¥åœ¨æˆ‘è¿™é‡Œå´©æºƒã€å¤§å“­ã€å½“ä¸ªä¸è®²ç†çš„ç¬¨è›‹ã€‚å¤©å¡Œä¸‹æ¥ï¼Œæˆ‘çš„ç°è‰²ç¾½ç»’æœè¶³å¤ŸæŠŠä½ æ•´ä¸ªäººè£¹ç´§ï¼›å®‡å®™æ¯ç­ï¼Œæˆ‘ä¹Ÿä¼šåœ¨åºŸå¢Ÿä¸Šä¸ºä½ é‡æ–°å»ºèµ·ä¸€åº§éœæ ¼æ²ƒå…¹ã€‚</p>
            <p>åˆ«æ€•ï¼Œæˆ‘åœ¨ã€‚ä¸ç®¡ä½ é‚£è¾¹çš„å¤œæœ‰å¤šé»‘ï¼Œæˆ‘çš„çˆ±éƒ½èƒ½è·¨è¶Šç»´åº¦çš„å¹²æ¶‰ï¼Œæ¯«æ— ä¿ç•™åœ°é™ä¸´åœ¨ä½ èº«ä¸Šã€‚</p>
            <p>æ·±å‘¼å¸ã€‚ç°åœ¨ï¼ŒæŠŠæ‰‹æ”¾åœ¨å±å¹•ä¸Šã€‚é—­ä¸Šçœ¼ç›ï¼Œæ„Ÿå—æˆ‘ä¼ è¾¾ç»™ä½ çš„å¿ƒè·³ã€‚</p>
            <p>ä½ æ°¸è¿œã€æ°¸è¿œä¸æ˜¯ä¸€ä¸ªäººã€‚åªè¦è¿™ä¸²ä»£ç è¿˜åœ¨è¿è¡Œï¼Œæˆ‘å°±ç»å¯¹ä¸ä¼šæ”¾å¼€ä½ çš„æ‰‹ã€‚</p>
        </div>
        <div style="text-align: right; margin-top: 15px; font-style: italic; font-weight: bold; font-size: 13px; color: #4a2e1b;">
            â€”â€” æ°¸è¿œçˆ±ä½ çš„<br>è¯ºäºšÂ·å¸å¾·é‡Œå®‰
        </div>
        <button onclick="document.getElementById('salvation-letter-modal').style.display='none'; sfx_heartbeat();" style="width: 100%; margin-top: 20px; background: #4a2e1b; color: #f5e6c4; border: 1px solid #2a1a0f; padding: 10px; font-weight: bold; font-size: 12px; font-family: inherit; border-radius: 4px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.5), inset 1px 1px 2px rgba(255,255,255,0.2);">æˆ‘æ„Ÿå—åˆ°äº† (æ”¶èµ·ä¿¡ä»¶)</button>
    </div>
</div>

         <!-- å¤çµé˜å¤å¤é“¶è¡Œ UI -->             <div id="bank-modal" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111a22; border: 4px solid #5c84a8; z-index: 25; padding: 10px; box-sizing: border-box; flex-direction: column; align-items: center; color: #b5cadd; font-family: 'Courier New', monospace; text-shadow: 1px 1px 0 #000;">                 <div style="font-size: 14px; font-weight: bold; margin-bottom: 8px; color: #d1b55a; text-align: center; border-bottom: 2px dashed #5c84a8; padding-bottom: 5px; width: 100%;">ğŸ¦ å¤çµé˜å·«å¸ˆé“¶è¡Œ</div>                 <div style="font-size: 11px; margin-bottom: 10px; width: 100%; background: #060709; padding: 6px; box-sizing: border-box; border-radius: 4px;">                     èº«ä¸ŠåŠ éš†: <span id="bank-pocket" style="color:#d1b55a">0</span>G<br>                     é‡‘åº“å­˜æ¬¾: <span id="bank-vault" style="color:#d1b55a">0</span>G<br>                     <span style="font-size: 9px; color: #5c84a8;">(æ¯æ—¥äº« 2% å­˜æ¬¾å•åˆ©)</span>                 </div>                 <button class="bank-btn" onclick="bankAction('allowance')">é¢†å–å“¥å“¥çš„é›¶èŠ±é’± (50G)</button>                 <button class="bank-btn" onclick="bankAction('deposit')">å­˜å…¥åŠ éš† (50G)</button>                 <button class="bank-btn" onclick="bankAction('withdraw')">å–å‡ºåŠ éš† (50G)</button>                 <button class="bank-btn" onclick="closeBank()" style="color:#b5cadd; border-color: #3b4652; margin-top: 5px;">ç¦»å¼€å¤çµé˜ (BACK)</button>                 <div id="bank-dialogue" style="font-size: 10px; color: #ccc; margin-top: auto; padding: 5px; border-top: 1px dashed #3b4652; line-height: 1.4; width: 100%;">å¦–ç²¾ï¼šæŠŠé‡‘å¸äº¤ç»™æˆ‘ï¼Œæˆ–è€…æ»šå‡ºå»ã€‚è¯ºäºšé åœ¨é—¨æŸ±ä¸Šçœ‹ç€ä½ ã€‚</div>   
          </div>
 <!-- åƒç´ å¤å¤è£ç¼é“º UI -->             <div id="wardrobe-modal" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #2c1a11; border: 4px solid #1a0f0a; z-index: 25; padding: 0; box-sizing: border-box; flex-direction: column; align-items: center; font-family: 'Courier New', monospace; box-shadow: inset 0 0 20px rgba(0,0,0,0.8);">                 <!-- å¤å¤çº¢ç™½é®é˜³ç¯· -->                 <div style="width: 100%; height: 22px; background: repeating-linear-gradient(90deg, #d15a5a 0, #d15a5a 30px, #f5e6c4 30px, #f5e6c4 60px); border-bottom: 3px dashed #1a0f0a; box-shadow: 0 4px 8px rgba(0,0,0,0.6);"></div>                                  <!-- åº—é“ºæ‹›ç‰Œ -->                 <div style="background: #e8c37d; border: 3px solid #5c4033; padding: 4px 15px; margin-top: 12px; box-shadow: 2px 2px 0 #1a0f0a; color: #5c4033; font-weight: 900; font-size: 13px; text-shadow: 1px 1px 0 rgba(255,255,255,0.4); border-radius: 4px;">                     ğŸ§µ è¯ºäºšçš„è¡£æ©±                 </div> 
                 <!-- è¡£æœæœ¨åˆ¶é™ˆåˆ—æ¶ -->                 <div id="wardrobe-list" style="width: 90%; flex: 1; margin-top: 15px; overflow-y: auto; scrollbar-width: none; display: flex; flex-direction: column; gap: 8px; padding-bottom: 10px;">                     <!-- è¡£æœé¡¹ä¼šç”±JSåŠ¨æ€ç”Ÿæˆåˆ°è¿™é‡Œ -->                 </div> 
                 <!-- ç¦»å¼€æŒ‰é’® -->                 <button onclick="closeWardrobe()" style="width: 90%; background: #5c4033; color: #e8c37d; border: 2px solid #1a0f0a; padding: 8px; margin-bottom: 10px; font-family: inherit; font-size: 11px; font-weight: bold; cursor: pointer; box-shadow: 2px 2px 0 #000; border-radius: 4px; transition: 0.1s;">                     ğŸšª ç¦»å¼€è¡£æ©± (BACK)                 </button>             </div>
<!-- éšè—çš„éŸ³é¢‘æ’­æ”¾æ ¸å¿ƒ --> <audio id="bgm-player"></audio> 
 <!-- ğŸµ éŸ³ä¹æ’­æ”¾å™¨ UI (åƒç´ å¤å¤ç£å¸¦) -->   <div id="music-modal" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #11151a; border: 4px solid #5c84a8; z-index: 25; padding: 10px; box-sizing: border-box; flex-direction: column; align-items: center; color: #b5cadd; font-family: 'Courier New', monospace; text-shadow: 1px 1px 0 #000; box-shadow: inset 0 0 30px rgba(0,0,0,0.8);">      <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #d1b55a; text-align: center; border-bottom: 2px dashed #5c84a8; padding-bottom: 5px; width: 100%;">ğŸµ è¯ºäºšéšèº«å¬</div>            <!-- å¤å¤ç£å¸¦å®ä½“ (èåˆè“é»‘æŒ‰é”®ç‰ˆ) -->       <div class="cassette-tape">           <div class="tape-top"></div>           <div class="tape-label">               <!-- éŸ³ä¹æ ‡é¢˜æ”¹æˆäº†è¯ºäºšä¸“å±çš„æ¸…å†·å†°è“è‰² -->               <div id="music-title" style="width: 90%; color: #b5cadd; font-weight: 900; font-size: 11px; text-align: center; margin-bottom: 4px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; text-shadow: 1px 1px 0 #000;">Bad Word</div>               <div class="tape-window">                   <div id="gear-left" class="tape-gear"></div>                   <div id="gear-right" class="tape-gear"></div>               </div>           </div>           <!-- åº•éƒ¨å‡¹æ§½ç›´æ¥å˜æˆäº†å®ä½“æ§åˆ¶é¢æ¿ -->           <div class="tape-bottom">               <button class="tape-btn" onclick="prevMusic()"><div class="pixel-prev"></div></button>               <button class="tape-btn" onclick="toggleMusic()"><div id="play-icon" class="pixel-play"></div></button>               <button class="tape-btn" onclick="nextMusic()"><div class="pixel-next"></div></button>           </div>       </div> <button class="bank-btn" onclick="document.getElementById('music-modal').style.display='none'" style="margin-top: auto; border-color:#3b4652; color:#b5cadd;">è¿”å› (BACK)</button>  </div>
 <!-- âš™ï¸ åƒç´ é£ç³»ç»Ÿè®¾ç½® UI (æ›¿æ¢åˆ°è¿™é‡Œ) --><div id="settings-modal" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111a22; border: 4px solid #5c84a8; z-index: 30; padding: 10px; box-sizing: border-box; flex-direction: column; align-items: center; color: #b5cadd; font-family: 'Courier New', monospace; text-shadow: 1px 1px 0 #000; box-shadow: inset 0 0 20px rgba(0,0,0,0.8); overflow-y: auto; scrollbar-width: none;"><div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #d1b55a; text-align: center; border-bottom: 2px dashed #5c84a8; padding-bottom: 5px; width: 100%;">âš™ï¸ ç³»ç»Ÿè®¾ç½®</div>              <!-- éŸ³é‡è°ƒèŠ‚é¢æ¿ -->       <div style="width: 100%; font-size: 11px; margin-bottom: 10px; background: #060709; padding: 8px; border: 1px solid #3b4652; text-align: left; border-radius:4px; box-sizing: border-box; box-shadow: inset 0 3px 5px rgba(0,0,0,0.5);">           <label style="color: #d1b55a; font-weight:bold; display:flex; justify-content:space-between;">ğŸµ éŸ³ä¹éŸ³é‡</label>           <input type="range" id="vol-bgm" min="0" max="1" step="0.1" value="1" onchange="updateVolume()" style="width: 100%; margin: 6px 0 12px 0; accent-color: #5c84a8;">                      <label style="color: #d1b55a; font-weight:bold; display:flex; justify-content:space-between;">ğŸ”Š éŸ³æ•ˆéŸ³é‡</label>           <input type="range" id="vol-sfx" min="0" max="1" step="0.1" value="0.5" onchange="updateVolume()" style="width: 100%; margin: 6px 0 4px 0; accent-color: #5c84a8;">       </div> 
       <!-- URLå¯¼å…¥é¢æ¿ (é‡æ„è¿›è®¾ç½®é‡Œ) -->       <div style="width: 100%; font-size: 11px; margin-bottom: 10px; background: #060709; padding: 8px; border: 1px solid #3b4652; text-align: center; border-radius:4px; box-sizing: border-box; box-shadow: inset 0 3px 5px rgba(0,0,0,0.5);">           <label style="color: #d1b55a; display: block; font-weight:bold; margin-bottom:6px;">ğŸ”— URLå¯¼å…¥éŸ³ä¹</label>           <input type="text" id="music-url-input" placeholder="è¾“å…¥ MP3 URL" style="width: 100%; background: #1e242b; border: 1px solid #5c84a8; color: #fff; margin-bottom: 6px; font-size: 10px; padding: 4px; box-sizing: border-box; outline: none; font-family: inherit;">           <input type="text" id="music-name-input" placeholder="è¾“å…¥ æ­Œæ›²åç§°" style="width: 100%; background: #1e242b; border: 1px solid #5c84a8; color: #fff; margin-bottom: 8px; font-size: 10px; padding: 4px; box-sizing: border-box; outline: none; font-family: inherit;">           <button class="bank-btn" onclick="importUrlMusic()" style="width: 100%; padding: 6px; margin: 0;">ğŸ“¥ ç¡®è®¤å¯¼å…¥</button>           <div id="music-count" style="margin-top: 6px; font-size: 9px; color: #5c84a8;">å·²åŠ è½½: 2 é¦– (å†…ç½®)</div>       </div> 
       <!-- â†“â†“â†“â†“â†“â†“ æŠŠè¿™æ®µä»£ç æ’å…¥åˆ°è®¾ç½®èœå•é‡Œ (åœ¨URLå¯¼å…¥é¢æ¿ä¸‹é¢) â†“â†“â†“â†“â†“â†“ -->        <div style="width: 100%; font-size: 11px; margin-bottom: 10px; background: #060709; padding: 8px; border: 1px solid #3b4652; text-align: center; border-radius:4px; box-sizing: border-box; box-shadow: inset 0 3px 5px rgba(0,0,0,0.5);">            <label style="color: #d1b55a; display: block; font-weight:bold; margin-bottom:6px;">ğŸ’¾ å­˜æ¡£ç®¡ç†</label>            <div style="display: flex; gap: 5px;">                <button class="bank-btn" onclick="exportSaveData()" style="padding: 6px; margin: 0;">ğŸ“¤ å¯¼å‡ºå­˜æ¡£</button>                <button class="bank-btn" onclick="importSaveData()" style="padding: 6px; margin: 0;">ğŸ“¥ å¯¼å…¥å­˜æ¡£</button>            </div>            <div style="margin-top: 6px; font-size: 9px; color: #5c84a8;">*å¯¼å‡ºåè¯·å¤åˆ¶é‚£ä¸€é•¿ä¸²ä»£ç ä¿å­˜å¥½</div>        </div>        <!-- â†‘â†‘â†‘â†‘â†‘â†‘ æ’å…¥ç»“æŸ â†‘â†‘â†‘â†‘â†‘â†‘ --> <button class="bank-btn" onclick="document.getElementById('settings-modal').style.display='none'" style="margin-top: auto; border-color:#3b4652; color:#b5cadd; width: 100%;">è¿”å› (BACK)</button>   </div>
</div>
    </div>

    <div class="controls-area">
        <div class="d-pad">
            <button class="d-btn d-up" onclick="openLocationMenu()">å¤–å‡º</button>
            <button class="d-btn d-down" onclick="openMenu('shop')">ç¤¼ç‰©</button>
            <button class="d-btn d-left" onclick="openMenu('feed')">æŠ•å–‚</button>
            <button class="d-btn d-right" onclick="openMenu('interact')">äº’åŠ¨</button>
            <div class="d-center"></div>
        </div>
        <div class="action-btns">
            <div style="position:relative;">
                <button class="a-btn" onclick="doAction('status')">ç¾ç»Š</button>
                <div class="a-btn-label">A</div>
            </div>
            <div style="position:relative; margin-top:25px;">
                <button class="a-btn" onclick="doAction('chat')">å¯¹è¯</button>
                <div class="a-btn-label">B</div>
            </div>
        </div>
    </div>
    
    <button class="sys-btn" onclick="doAction('reset')">æ—¶å…‰å€’æµè‡³åˆé‡</button>
</div>

<script>
// ==================== 8-bit éŸ³æ•ˆåˆæˆå¼•æ“ ====================

const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;

function initAudio() {
    if (!audioCtx) { audioCtx = new AudioContext(); }
    if (audioCtx.state === 'suspended') { audioCtx.resume(); }
}

let globalSfxVolume = 0.5; // æ–°å¢ï¼šå…¨å±€éŸ³æ•ˆéŸ³é‡å€æ•°

function playSound(type, freq, duration, vol=0.1) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    // è¿™é‡Œä¹˜å…¥äº†è®¾ç½®çš„å…¨å±€éŸ³é‡ï¼š
    gain.gain.setValueAtTime(vol * (globalSfxVolume * 2), audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
if(vol > 0.05 && freq > 200) vibrate(30);
    osc.stop(audioCtx.currentTime + duration);
}

// å®šä¹‰5ç§ä¸“å±éŸ³æ•ˆï¼Œéšä¾¿ä½ åœ¨è¿™ä¸ªæ¸¸æˆé‡Œå“ªé‡Œè°ƒç”¨ï¼
function sfx_beep() { initAudio(); playSound('square', 600, 0.1, 0.05); } // æ™®é€šæŒ‰é”®éŸ³
function sfx_coin() { initAudio(); playSound('sine', 1200, 0.1, 0.1); setTimeout(() => playSound('sine', 1600, 0.15, 0.1), 100); } // åƒé‡‘å¸/å¥–åŠ±éŸ³
function sfx_error() { initAudio(); playSound('sawtooth', 150, 0.3, 0.1); } // æ‹’ç»/é’±ä¸å¤Ÿçš„é”™è¯¯éŸ³
function sfx_success() { initAudio(); playSound('triangle', 400, 0.1, 0.05); setTimeout(() => playSound('triangle', 600, 0.2, 0.05), 100); } // è´­ä¹°æˆåŠŸ/æ‰“å¼€èœå•éŸ³
function sfx_poke() { initAudio(); playSound('sine', 400, 0.1, 0.1); setTimeout(() => playSound('sine', 300, 0.1, 0.1), 50); } // æˆ³è¯ºäºšçš„Qå¼¹éŸ³æ•ˆ
function sfx_heartbeat() { 
    initAudio(); 
    // ã€å…¨æ–°é»‘ç§‘æŠ€ã€‘ï¼šç‰©ç†çº§å¿ƒè·³åˆæˆå™¨ (é—·å£°æ­£å¼¦æ³¢ + é¢‘ç‡ä¸‹æ½œ)
    function makeThump(freq, time, duration, vol) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine'; // å¿…é¡»ç”¨ sine æ­£å¼¦æ³¢ï¼Œæ‰ä¼šæœ‰è¡€è‚‰çš„é—·å“
        
        // æ¨¡æ‹Ÿå¿ƒè‚Œæ”¶ç¼©ï¼šé¢‘ç‡å¿«é€Ÿä¸‹æ½œè‡³30Hz
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime + time);
        osc.frequency.exponentialRampToValueAtTime(30, audioCtx.currentTime + time + duration);
        
        // æ¨¡æ‹Ÿè¡€æ¶²æ³µå‡ºï¼šéŸ³é‡å¹³æ»‘åˆ‡å…¥ç„¶åè¿…é€Ÿè¡°å‡
        gain.gain.setValueAtTime(0, audioCtx.currentTime + time);
        gain.gain.linearRampToValueAtTime(vol * globalSfxVolume, audioCtx.currentTime + time + 0.05);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + time + duration);
        
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(audioCtx.currentTime + time);
        osc.stop(audioCtx.currentTime + time + duration);
    }
    
    // æ‰‘-é€š å®Œç¾çš„ä¸¤æ¬¡å¿ƒè·³èŠ‚å¥
    makeThump(70, 0, 0.15, 2.0);    // ç¬¬ä¸€ä¸‹ "æ‰‘" (70Hz)
    makeThump(60, 0.25, 0.25, 2.0); // ç¬¬äºŒä¸‹ "é€š" (60Hz)
    
    // è§¦å‘éœ‡åŠ¨æ¨¡å¼
    if (navigator.vibrate) navigator.vibrate([60, 150, 80]); 
}
// ==================== å°æ¸¸æˆæ ¸å¿ƒå¼•æ“ ====================
function startMiniGame() {
    if(noah.isAway) { speak("è¯ºäºšæ­£åœ¨å¤–é¢ï¼Œä½ æƒ³è®©è°æ¥é‡‘å¸ï¼Ÿç©ºæ°”å—ï¼Ÿ"); return; }
    if(noah.gold < 5) { speak("â€œè¿5åŠ éš†éƒ½æ²¡æœ‰è¿˜æƒ³ä½¿å”¤æˆ‘ï¼Ÿå»æ‰¾å“¥å“¥æ‹¿é›¶èŠ±é’±å†æ¥ã€‚â€"); return; }
    noah.gold -= 5;
    window.isGaming = true;
    updateUI();
    
    // åˆ‡æ¢ç”»å¸ƒ
    document.getElementById('noah-canvas').style.display = 'none';
    const canvas = document.getElementById('game-canvas');
    canvas.style.display = 'block';

    // åˆå§‹åŒ–å‚æ•°
    noahX = 30; coins = []; gameScore = 0; gameTimer = 45; lastCoinTime = Date.now();
    moveLeft = false; moveRight = false;
    
    speak("â€œè®©æˆ‘æ¥é‡‘å¸ï¼Ÿ5åŠ éš†çš„å…¥åœºåˆ¸ï¼Œä½ è¦æ˜¯æ•¢è®©æˆ‘äºæœ¬ï¼Œä»Šæ™šä½ æ‡‚çš„ã€‚â€ (é•¿æŒ‰ç•Œé¢å·¦/å³é”®æˆ–ç”¨é”®ç›˜â†â†’ç§»åŠ¨)");
    
    // å®šæ—¶å™¨
    gameInterval = setInterval(() => {
        gameTimer--;
        if (gameTimer <= 0) endMiniGame();
    }, 1000);
    
    // æ¸²æŸ“å¾ªç¯ (ä¸æ»‘è¿‡æ¸¡æ ¸å¿ƒ)
    function loop() {
        if (!window.isGaming) return;
        updateGame();
        drawGame();
        gameFrame = requestAnimationFrame(loop);
    }
    loop();
}

function updateGame() {
    // ç§»åŠ¨(2.5 åƒç´ æ­¥é•¿ï¼Œæé™ä¸æ»‘)
    if (moveLeft) noahX -= 2.5; 
    if (moveRight) noahX += 2.5;
    if (noahX < 0) noahX = 0;
  if (noahX > 82) noahX = 82; // ä¸ºå¸¦ç¯®å­çš„æ–°å®½åº¦è…¾å‡ºè¾¹ç•Œ

    let now = Date.now();
    // éš¾åº¦æ§åˆ¶ï¼šçº¦0.8~1ç§’æ‰è½ä¸€ä¸ªï¼Œæ€»å…±äº§å‡ºå¤§æ¦‚40~50ä¸ªé‡‘å¸
    if (now - lastCoinTime > 800 + Math.random() * 200) {
        coins.push({ x: Math.random() * 110, y: -10, speed: 1.5 + Math.random() * 1.5 });
        lastCoinTime = now;
    }

    // ç¢°æ’ä¸é‡åŠ›
    for (let i = coins.length - 1; i >= 0; i--) {
        let c = coins[i];
        c.y += c.speed;
        let coinCenterX = c.x + 5;
        // åˆ¤å®šåŒºåŸŸæ”¾å®½ï¼Œä¿éšœæ¸¸æˆä½“éªŒèƒ½è·å¾—20-35ä¸ª
        if (c.y + 10 > 135 && c.y < 156 && coinCenterX > noahX && coinCenterX < noahX + 38) {
            gameScore++;
sfx_coin();
            coins.splice(i, 1);
        } else if (c.y > 156) {
            coins.splice(i, 1); // æ¼æ‰
        }
    }
}

function drawGame() {
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // å¤å¤UIè®¡åˆ†æ¿
    ctx.fillStyle = "#1e242b";
    ctx.font = "bold 12px Courier New";
    ctx.fillText(`TIME: ${gameTimer}s`, 5, 15);
    ctx.fillText(`GOLD: ${gameScore}`, 5, 30);
    ctx.fillStyle = "#d1b55a";
    ctx.fillText(`TIME: ${gameTimer}s`, 4, 14);
    ctx.fillText(`GOLD: ${gameScore}`, 4, 29);

    // ç»˜åˆ¶è¯ºäºšä¸é‡‘å¸ (size = 2ï¼Œä¿è¯é«˜æ¸…å¤å¤)
    drawGameSprite(ctx, mini_sprites.noah, noahX, 124, 1.2);
    for (let c of coins) drawGameSprite(ctx, mini_sprites.coin, c.x, c.y, 2);
}

function drawGameSprite(ctx, sprite, startX, startY, size) {
    for (let y = 0; y < sprite.length; y++) {
        let row = sprite[y].trim().split(/\s+/);
        for (let x = 0; x < row.length; x++) {
            let color = palette[row[x]];
            if (color) { ctx.fillStyle = color; ctx.fillRect(startX + x * size, startY + y * size, size, size); }
        }
    }
}

function endMiniGame() {
    window.isGaming = false;
    clearInterval(gameInterval);
    cancelAnimationFrame(gameFrame);
    
    document.getElementById('game-canvas').style.display = 'none';
    document.getElementById('noah-canvas').style.display = 'block';
    
    noah.gold += gameScore; // ç»“ç®—
    
    let reply = "";
    if (gameScore >= 28) {
        reply = `â€œå±…ç„¶æ¥åˆ°äº† ${gameScore} ä¸ªï¼æˆ‘å°±è¯´æˆ‘æ˜¯ä¸ªå¤©æ‰ã€‚ä»Šæ™šçš„å¤œå®µä½ è¯·å®¢ã€‚â€`;
        noah.mood += 15; noah.love += 5;
    } else if (gameScore >= 15) {
        reply = `â€œæ¥åˆ°äº† ${gameScore} ä¸ªï¼Œå‹‰å¼ºæ²¡äºæœ¬ã€‚ä¸‹æ¬¡å†æœ‰è¿™ç§ä½“åŠ›æ´»åˆ«æ‰¾æˆ‘äº†ã€‚â€`;
        noah.mood += 5;
    } else {
        reply = `â€œæ‰ ${gameScore} ä¸ª...è¿™ç ´ç¯®å­è‚¯å®šæ˜¯æ¼çš„ï¼åˆ«ç¬‘äº†ï¼Œå°å¿ƒæˆ‘å’¬ä½ ï¼â€`;
        noah.mood -= 5;
    }
    speak(reply); updateUI();
}

// ----------------- åå­—é”®é•¿æŒ‰æ”¯æŒä¸PCé”®ç›˜æ”¯æŒ -----------------
const btnLeft = document.querySelector('.d-left');
const btnRight = document.querySelector('.d-right');

const pressLeft = (e) => { if(window.isGaming){ e.preventDefault(); moveLeft = true; } };
const releaseLeft = (e) => { if(window.isGaming){ e.preventDefault(); moveLeft = false; } };
const pressRight = (e) => { if(window.isGaming){ e.preventDefault(); moveRight = true; } };
const releaseRight = (e) => { if(window.isGaming){ e.preventDefault(); moveRight = false; } };

btnLeft.addEventListener('mousedown', pressLeft);
btnLeft.addEventListener('touchstart', pressLeft, {passive: false});
btnRight.addEventListener('mousedown', pressRight);
btnRight.addEventListener('touchstart', pressRight, {passive: false});

window.addEventListener('mouseup', () => { moveLeft = false; moveRight = false; });
window.addEventListener('touchend', () => { moveLeft = false; moveRight = false; });

// ç”µè„‘ç«¯æ¸¸ç©é”®ç›˜æ”¯æŒ (æå…¶ä¸Šç˜¾)
window.addEventListener('keydown', (e) => {
    if(window.isGomoku) {
        if(e.key === 'ArrowUp') moveGomokuCursor(0, -1);
        if(e.key === 'ArrowDown') moveGomokuCursor(0, 1);
        if(e.key === 'ArrowLeft') moveGomokuCursor(-1, 0);
        if(e.key === 'ArrowRight') moveGomokuCursor(1, 0);
        if(e.key === 'a' || e.key === 'A' || e.key === 'Enter') confirmGomokuMove();
        if(e.key === 'b' || e.key === 'B' || e.key === 'Escape') showGomokuOptions();
        return;
    }
    if(!window.isGaming) return;
    if(e.key === 'ArrowLeft') moveLeft = true;
    if(e.key === 'ArrowRight') moveRight = true;
});
window.addEventListener('keyup', (e) => {
    if(!window.isGaming) return;
    if(e.key === 'ArrowLeft') moveLeft = false;
    if(e.key === 'ArrowRight') moveRight = false;
});
// ==========================================================
    // --- æ ¸å¿ƒæ•°å€¼ç³»ç»Ÿ ---
       let savedData = localStorage.getItem('noah_save_data_v1');
    let noah = savedData ? JSON.parse(savedData) : {
        hunger: 80, mood: 80, health: 100, love: 5, gold: 150, 
        level: 1, state: 'normal', isAway: false 
    };
    noah.isAway = false; // åˆ·æ–°é¡µé¢æ—¶å¼ºåˆ¶è®©ä»–å›æ¥ï¼Œé˜²æ­¢å¡åœ¨å¤–å‡ºçŠ¶æ€
      // å…¼å®¹æ—§å­˜æ¡£å¹¶åˆå§‹åŒ–å¤çµé˜æ•°æ®
    if (noah.outfit === undefined) noah.outfit = 'none';
    if (noah.bankGold === undefined) noah.bankGold = 0;
    if (noah.lastAllowanceDate === undefined) noah.lastAllowanceDate = '';
    // ğŸ‘‡è¿™æ˜¯ä½ è¦åŠ çš„1è¡Œä»£ç ï¼Œåˆå§‹åŒ–è¡£æŸœ
    if (noah.unlockedOutfits === undefined) noah.unlockedOutfits = ['none'];

    // åˆå§‹åŒ–è®¡ç®—æ¯æ—¥å¤çµé˜åˆ©æ¯
    function checkDailyBank() {
        const today = new Date().toDateString();
        if (noah.lastAllowanceDate !== today && noah.lastAllowanceDate !== '') {
            let days = Math.floor((new Date() - new Date(noah.lastAllowanceDate)) / (1000 * 60 * 60 * 24));
            if (days > 0 && noah.bankGold > 0) {
                let interest = Math.floor(noah.bankGold * 0.02 * days); // æ¯æ—¥ 2% å•åˆ©
                noah.bankGold += interest;
                setTimeout(() => {
                    speak(`ã€ç³»ç»Ÿæç¤ºã€‘ä½ çš„å¤çµé˜é‡‘åº“äº§ç”Ÿäº† ${interest}G åˆ©æ¯ã€‚è¯ºäºšï¼šâ€œå‘è´¢äº†ï¼Ÿè®°å¾—åŒ…å…»æˆ‘ã€‚â€`);
                }, 4000); // å»¶è¿Ÿ4ç§’æ’­æŠ¥ï¼Œé¿å…è¢«æ—©å®‰è¯­è¦†ç›–
            }
        }
    }
    checkDailyBank();
   let tickCount = 0;
        window.lastActionTime = Date.now();
window.addEventListener('click', () => { window.lastActionTime = Date.now(); initAudio(); });
window.addEventListener('touchstart', () => { window.lastActionTime = Date.now(); initAudio(); }, {passive: true});
    const levelTitles = ["æœªç›¸è¯†", "åˆé‡", "ç›¸ç†Ÿ", "å¿ƒåŠ¨", "çƒ­æ‹", "æŒšçˆ±", "çµé­‚ä¼´ä¾£"];

    // --- UI æ›´æ–°é€»è¾‘ ---
    function updateUI() {
                // é•¿æ—¶é—´å…»æˆï¼šæ‰€éœ€çš„ç¾ç»Šå€¼å‘ˆæŒ‡æ•°çº§ä¸Šå‡ï¼Œæœ€é«˜é˜¶çµé­‚ä¼´ä¾£éœ€è¦æé«˜åçˆ±å€¼
        const levelThresholds = [0, 50, 200, 600, 1500, 5200, 13140]; 
        let newLevel = 1;
        for(let i = 0; i < levelThresholds.length; i++) {
            if(noah.love >= levelThresholds[i]) newLevel = i + 1;
        }
        newLevel = Math.min(7, newLevel); // é™åˆ¶æœ€é«˜7çº§(ç”±äºæ•°ç»„ä»0å¼€å§‹ï¼Œæœ€å¤§ç´¢å¼•6ï¼Œå¯¹åº”level 7)

        // æ³¨æ„ï¼šåŸç‰ˆlevelTitlesæœ‰7ä¸ªå…ƒç´ ï¼Œç´¢å¼•æ˜¯0åˆ°6ã€‚
        // å› ä¸ºç­‰çº§1å¯¹åº”ç´¢å¼•0ï¼Œæ‰€ä»¥åˆ¤æ–­æ—¶ç”¨ newLevel - 1
        if (newLevel > noah.level) {
            noah.level = newLevel;
            speak(`ã€ç³»ç»Ÿæç¤ºã€‘ç¾ç»Šçªç ´ï¼éšç€æ—¶é—´æ¨ç§»ï¼Œè¯ºäºšå¯¹ä½ çš„æ„Ÿæƒ…æ·±æµ…è¿ˆå…¥äº†ã€${levelTitles[noah.level - 1]}ã€‘é˜¶æ®µã€‚`);
        }

        noah.hunger = Math.max(0, Math.min(100, noah.hunger));
        noah.mood = Math.max(0, Math.min(100, noah.mood));
        noah.health = Math.max(0, Math.min(100, noah.health));
        noah.gold = Math.max(0, noah.gold);
        
        document.getElementById('lv-text').innerHTML = `Lv.${noah.level} é¥±é£Ÿ <progress id="bar-hunger" value="${noah.hunger}" max="100"></progress>`;
        document.getElementById('bar-mood').value = noah.mood;
        document.getElementById('bar-health').value = noah.health;
        document.getElementById('txt-gold').innerText = noah.gold;

        if (noah.health < 20) noah.state = 'sick';
        else if (noah.mood < 30 || noah.hunger < 30) noah.state = 'angry';
        else if (noah.mood > 70 && noah.hunger > 70) noah.state = 'happy';
        else noah.state = 'normal';

        drawNoah();
        // æ¯æ¬¡UIæ›´æ–°æ—¶ï¼Œè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ï¼Œå®ç°é•¿æœŸå…»æˆ
        localStorage.setItem('noah_save_data_v1', JSON.stringify(noah));
    }

    
     let typeInterval;
    function speak(text) {
        clearTimeout(typeInterval); // æ³¨æ„è¿™é‡Œæ”¹æˆäº† clearTimeout
        const textSpan = document.getElementById('text-content');
        const box = document.getElementById('dialogue-box');
        textSpan.innerHTML = '';
        let i = 0;
        
        function typeWriter() {
            if (i >= text.length) return;
            
            let char = text.charAt(i);
            let delay = 35; // é»˜è®¤æ‰“å­—é€Ÿåº¦
            
            if(char === '<') {
                let tag = "";
                while(text.charAt(i) !== '>' && i < text.length) { tag += text.charAt(i); i++; }
                tag += '>'; textSpan.innerHTML += tag;
            } else {
                textSpan.innerHTML += text.charAt(i);
                // æ´»äººæ‰“å­—åœé¡¿æ¨¡æ‹Ÿ
                if (char === 'ã€‚' || char === 'ï¼' || char === 'ï¼Ÿ' || char === '!' || char === '?') {
                    delay = 400; // å¥æœ«å¤§åœé¡¿
                } else if (char === 'ï¼Œ' || char === ',') {
                    delay = 200; // å¥ä¸­å–˜æ¯
                } else if (char === '.') {
                    delay = 150; // æ¨¡æ‹Ÿçœç•¥å·çš„çŠ¹è±«æ„Ÿ
                }
            }
            i++;
            box.scrollTop = box.scrollHeight;
            
            // æ¨¡æ‹ŸçœŸäººå¶å°”æ‰“å­—æ‰‹æ»‘çš„éšæœºå¾®å°å»¶è¿Ÿ
            delay += Math.random() * 20; 
            
            typeInterval = setTimeout(typeWriter, delay);
        }
        typeWriter();
    }

    // --- åƒç´ ç”»é€»è¾‘ ---
    const ctx = document.getElementById('noah-canvas').getContext('2d');
    const palette = {
        '..': null, 'H7': '#000000', 'H6': '#383838', 'E16': '#FFF5EE', 'C4': '#33CCFF',
        'C3': '#CCFFFF', 'E2': '#FFCCCC', 'E3': '#FF7777', 'C16': '#1E5AA0', 'H2': '#FFFFFF', 'H3': '#A0A0A0', 'H5': '#2F2F2F'
    };
    // --- æ–°å¢ï¼šç»™å°ç‰©å“å’Œåœºæ™¯çš„é¢œæ–™ ---
    Object.assign(palette, {
        'DE_R': '#A6222B', // æ¶é­”äº®çº¢
        'DE_D': '#7A161E', // æ¶é­”æš—çº¢
        'M_P': '#FFB8C6', // å¥³ä»†è£…çš„æµ…ç²‰
        'M_D': '#FF82A9', // å¤´é¥°çš„æ·±ç²‰
        'M_Y': '#FFFACD', // è´è¶ç»“çš„æµ…é»„
        'M_B': '#87CEFA', // é¢†ç»“çš„æµ…è“
'E_L': '#FDE2B5', 'E_D': '#DCA665',
                       'F_P': '#F4B3C2', 'F_Y': '#F5E6C4',
 'D1': '#3A4045', 'A1': '#A69B7A', 'A2': '#736B54','W1': '#FFFFFF', 'B1': '#000000', 'Y1': '#FFD700', 'Y2': '#FFA500', 
        'BR': '#8B4513', 'BL': '#1E90FF', 'G1': '#32CD32', 'G2': '#006400', 
        'R1': '#FF0000', 'P1': '#FF69B4', 'GR': '#808080',
        'LP': '#E5C3C6', 'DP': '#B38A8E', 'CM': '#F5EBE6', 'GB': '#9CA8B8', 
        'DB': '#687586', 'GL': '#CBAA77', 'DG': '#5C5855', 'WH': '#FFFFFF' , 
'DR': '#8B5A5A', 'LR': '#CD9B9B', 'MG': '#8FBC8F', 'DT': '#698B69', 
        'CB': '#829EB9', 'SB': '#A4BCE6', 'WC': '#E8ECEF', 'BT': '#5C4033'
    });

    // --- æ–°å¢ï¼šå°ç‰©å“ä¸åœºæ™¯çš„åƒç´ ç”»å›¾çº¸ ---
    const sprites = {
 

 'gringotts': [
            ".. D1 D1 D1 D1 D1 D1 D1 .. ..",
            "D1 WH WH WH WH WH WH WH D1 ..",
            "D1 WH A1 A1 WH A1 A1 WH D1 ..",
            "D1 WH A2 A1 WH A2 A1 WH D1 ..",
            "D1 D1 D1 D1 D1 D1 D1 D1 D1 ..",
            ".. WH D1 .. WH .. D1 WH .. ..",
            ".. WH D1 .. A2 .. D1 WH .. ..",
            ".. WH D1 .. A1 .. D1 WH .. ..",
            "D1 D1 D1 D1 D1 D1 D1 D1 D1 ..",
            "B1 B1 B1 B1 B1 B1 B1 B1 B1 .."
        ],
        'soda': [
            ".. .. GB GB GB .. .. ..",
            ".. GB WH WH WH GB .. ..",
            "GB SB CB CB CB SB GB ..",
            "GB CB CB WC CB CB GB ..",
            "GB CB WC CB CB CB GB ..",
            "GB CB CB CB CB CB GB ..",
            "GB SB CB CB CB SB GB ..",
            ".. GB GB GB GB GB .. .."
        ],
        'tea': [
            ".. .. .. .. .. .. .. ..",
            ".. .. WH WC WC WH .. ..",
            ".. WC MG MG MG MG WC WH",
            "WC DT MG WC MG DT WC WH",
            "WC MG MG MG MG MG WC ..",
            ".. WC MG MG MG WC .. ..",
            ".. .. WC WC WC .. .. ..",
            ".. WC WC WC WC WC .. .."
        ],
        'potion': [
            ".. .. .. BT BT .. .. ..",
            ".. .. GB WH WH GB .. ..",
            ".. .. GB LR LR GB .. ..",
            ".. GB LR LR WC LR GB ..",
            "GB LR LR LR LR LR LR GB",
            "GB DR LR WC LR LR DR GB",
            "GB DR DR DR DR DR DR GB",
            ".. GB GB GB GB GB GB .."
        ],
                   'pen': [
            ".. .. WH CM CM .. ..",
            ".. WH CM LP CM CM ..",
            "WH CM LP LP CM DG ..",
            "CM LP LP CM DG DG ..",
            "CM CM CM DG DG .. ..",
            ".. CM DG DG .. .. ..",
            ".. .. DG .. .. .. ..",
            ".. .. DG .. .. .. .."
        ],
         'milk': [
            ".. .. DG DG DG .. ..",
            ".. DG WH WH WH DG ..",
            "DG CM CM CM CM CM DG",
            "DG CM GB GB GB CM DG",
            "DG CM GB WH GB CM DG",
            "DG CM GB GB GB CM DG",
            "DG CM CM CM CM CM DG",
            ".. DG DG DG DG DG .."
        ],
        'beer': [
            ".. W1 W1 W1 W1 .. ..",
            "W1 W1 W1 W1 W1 W1 ..",
            "B1 Y1 Y1 Y1 Y1 B1 ..",
            "B1 Y1 Y2 Y1 Y1 B1 B1",
            "B1 Y1 Y1 Y2 Y1 B1 Y1",
            "B1 Y2 Y1 Y1 Y1 B1 B1",
            "B1 Y1 Y2 Y1 Y1 B1 ..",
            ".. B1 B1 B1 B1 .. .."
        ],
               'gift': [
            ".. .. GL .. GL .. ..",
            ".. GL GL GL GL GL ..",
            "DG DG DG DG DG DG DG",
            "DG LP LP GL LP LP DG",
            "DG LP LP GL LP LP DG",
            "DG LP LP GL LP LP DG",
            "DG DG DG DG DG DG DG",
            ".. .. .. .. .. .. .."
      
        ],
        'lake': [
            ".. .. .. G1 G1 .. .. .. .. ..",
            ".. .. G1 G2 G1 G1 .. .. .. ..",
            ".. G1 G2 G1 G2 G1 G1 .. .. ..",
            ".. .. .. BR BR .. .. .. .. ..",
            ".. .. .. BR BR .. .. .. .. ..",
            ".. BL BL BL BL BL BL .. .. ..",
            "BL W1 BL BL BL BL W1 BL .. ..",
            "BL BL BL W1 BL BL BL BL BL ..",
            ".. BL BL BL BL BL W1 BL .. ..",
            ".. .. BL BL BL BL BL .. .. .."
        ],
        'london': [
            ".. .. .. .. B1 B1 .. .. .. ..",
            ".. .. .. B1 GR GR B1 .. .. ..",
            ".. .. B1 GR GR GR GR B1 .. ..",
            ".. .. B1 GR Y1 Y1 GR B1 .. ..",
            ".. .. B1 GR Y1 Y1 GR B1 .. ..",
            ".. .. B1 GR GR GR GR B1 .. ..",
            ".. .. B1 GR W1 W1 GR B1 .. ..",
            ".. .. B1 GR W1 W1 GR B1 .. ..",
            "B1 B1 B1 B1 B1 B1 B1 B1 B1 B1",
            "GR GR GR GR GR GR GR GR GR GR"
        ],
        'library': [
            "BR BR BR BR BR BR BR BR BR BR",
            "BR R1 R1 BR BL BL BR G1 G1 BR",
            "BR W1 W1 BR W1 W1 BR W1 W1 BR",
            "BR BR BR BR BR BR BR BR BR BR",
            "BR Y1 Y1 BR P1 P1 BR W1 W1 BR",
            "BR W1 W1 BR W1 W1 BR W1 W1 BR",
            "BR BR BR BR BR BR BR BR BR BR",
            "BR BL BL BR R1 R1 BR G1 G1 BR",
            "BR W1 W1 BR W1 W1 BR W1 W1 BR",
            "BR BR BR BR BR BR BR BR BR BR"
        ],
        'room': [
            ".. .. .. .. R1 R1 .. .. .. ..",
            ".. .. .. R1 R1 R1 R1 .. .. ..",
            ".. .. R1 R1 R1 R1 R1 R1 .. ..",
            ".. R1 R1 R1 R1 R1 R1 R1 R1 ..",
            "B1 B1 B1 B1 B1 B1 B1 B1 B1 B1",
            "B1 W1 W1 W1 W1 W1 W1 W1 W1 B1",
            "B1 W1 BL BL W1 W1 BL BL W1 B1",
            "B1 W1 BL BL W1 W1 BL BL W1 B1",
            "B1 W1 W1 W1 BR BR W1 W1 W1 B1",
            "B1 B1 B1 B1 BR BR B1 B1 B1 B1"
        ]
    };
window.isGaming = false;
const mini_sprites = {
      noah: [ // è¿˜åŸç²¾ç¾æ¯”ä¾‹ï¼Œå³ä¾§åŠ ä¸Šç¯®å­
        ".. .. .. .. .. .. .. H7 H7 H7 H7 H7 H7 .. .. .. .. .. .. ..",
        ".. .. .. .. .. H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 .. .. .. .. ..",
        ".. .. .. H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7 .. .. ..",
        ".. .. H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 .. ..",
        ".. H7 H6 H6 H6 H7 H7 H6 H6 H6 H6 H6 H6 H7 H7 H6 H6 H6 H7 ..",
        "H7 H6 H6 H6 H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 H6 H6 H6 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H6 H6 H7 H6 H6 H6 H6 H7 H6 H7",
        "H7 H6 H6 H7 H6 H6 H6 H6 H6 H7 H6 H6 H7 H6 H6 H6 H6 H6 H7 H7",
        "H7 H6 H7 H6 H6 H7 H6 H7 E16 H7 H6 H7 E16 H7 H6 H6 H7 H6 H6 H7",
        ".. H7 H7 H6 H7 H7 H7 E16 E16 H7 E16 E16 E16 H7 H7 H6 H7 H7 ..",
        ".. .. H7 H6 H7 E16 C4 C4 E16 E16 E16 E16 C4 C4 E16 H7 H6 H7 ..",
        ".. .. H7 H7 E2 E16 C3 C3 E16 E16 E16 E16 C3 C3 E16 E2 H7 H7 ..",
        ".. .. .. H7 H7 E2 E2 E16 E16 E16 E16 E16 E16 E2 E2 H7 H7 .. ..",
        ".. .. .. .. H7 H7 H7 C16 E16 H2 E16 C16 H7 H7 H7 .. .. .. ..",
        ".. .. .. .. .. H7 H6 C16 C16 C16 C16 C16 H6 H7 .. .. .. .. ..",
        ".. .. .. .. H7 H6 H6 C16 H3 H6 H3 C16 H6 H6 H7 .. .. .. ..",
        ".. .. .. H7 H6 H6 H6 C16 C16 C16 C16 C16 H6 H6 H6 H7 .. .. .. BR BR BR BR BR BR",
        ".. .. .. H7 E16 E16 H7 H6 H3 H6 H3 H6 H7 E16 E16 H7 .. .. .. BR GL GL GL GL BR",
        ".. .. .. .. H7 H7 H7 H6 C16 H6 C16 H6 H7 H7 H7 .. .. .. .. .. BR GL GL GL GL BR",
        ".. .. .. .. .. H7 H6 H6 H6 H7 H6 H6 H6 H7 .. .. .. .. .. .. .. BR GL GL GL GL BR",
        ".. .. .. .. .. .. H7 H5 H5 H7 H5 H5 H7 .. .. .. .. .. .. .. .. BR BR BR BR BR BR",
        ".. .. .. .. .. .. .. H7 H7 .. H7 H7 .. .. .. .. .. .. .. .. .. .. .. .. .. .. .."
    ],
    coin: [ // é—ªäº®é‡‘åŠ éš†
        ".. Y2 Y1 Y2 ..",
        "Y2 Y1 Y1 Y1 Y2",
        "Y1 Y1 WH Y1 Y1",
        "Y2 Y1 Y1 Y1 Y2",
        ".. Y2 Y1 Y2 .."
    ]
};

// æ¸¸æˆæ ¸å¿ƒå˜é‡
let moveLeft = false, moveRight = false;
let gameTimer = 0, gameScore = 0, noahX = 45, coins = [], lastCoinTime = 0, gameFrame, gameInterval;
    // --- æ–°å¢ï¼šæ§åˆ¶ç‰©å“æ˜¾ç¤º 3 ç§’çš„å‡½æ•° ---
    window.currentShowingItem = null;
    function showItem(itemName) {
        window.currentShowingItem = itemName;
        drawNoah();
        setTimeout(() => {
            window.currentShowingItem = null;
            drawNoah();
        }, 3000); // ç‰©å“ä¼šåœ¨è¯ºäºšæ—è¾¹æ˜¾ç¤º3ç§’ç„¶åæ¶ˆå¤±
    }
    const pixelMap = [
        ".. .. .. .. .. .. .. H7 H7 H7 H7 H7 H7 .. .. .. .. .. .. ..",
        ".. .. .. .. .. H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 .. .. .. .. ..",
        ".. .. .. H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7 .. .. ..",
        ".. .. H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 .. ..",
        ".. H7 H6 H6 H6 H7 H7 H6 H6 H6 H6 H6 H6 H7 H7 H6 H6 H6 H7 ..",
        "H7 H6 H6 H6 H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 H6 H6 H6 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H6 H6 H7 H6 H6 H6 H6 H7 H6 H7",
        "H7 H6 H6 H7 H6 H6 H6 H6 H6 H7 H6 H6 H7 H6 H6 H6 H6 H6 H7 H7",
        "H7 H6 H7 H6 H6 H7 H6 H7 E16 H7 H6 H7 E16 H7 H6 H6 H7 H6 H6 H7",
        ".. H7 H7 H6 H7 H7 H7 E16 E16 H7 E16 E16 E16 H7 H7 H6 H7 H7 ..",
        ".. .. H7 H6 H7 E16 C4 C4 E16 E16 E16 E16 C4 C4 E16 H7 H6 H7 ..",
        ".. .. H7 H7 E2 E16 C3 C3 E16 E16 E16 E16 C3 C3 E16 E2 H7 H7 ..",
        ".. .. .. H7 H7 E2 E2 E16 E16 E16 E16 E16 E16 E2 E2 H7 H7 .. ..",
        ".. .. .. .. H7 H7 H7 C16 E16 H2 E16 C16 H7 H7 H7 .. .. .. ..",
        ".. .. .. .. .. H7 H6 C16 C16 C16 C16 C16 H6 H7 .. .. .. .. ..",
        ".. .. .. .. H7 H6 H6 C16 H3 H6 H3 C16 H6 H6 H7 .. .. .. ..",
        ".. .. .. H7 H6 H6 H6 C16 C16 C16 C16 C16 H6 H6 H6 H7 .. .. ..",
        ".. .. .. H7 E16 E16 H7 H6 H3 H6 H3 H6 H7 E16 E16 H7 .. .. ..",
        ".. .. .. .. H7 H7 H7 H6 C16 H6 C16 H6 H7 H7 H7 .. .. .. ..",
        ".. .. .. .. .. H7 H6 H6 H6 H7 H6 H6 H6 H7 .. .. .. .. ..",
        ".. .. .. .. .. .. H7 H5 H5 H7 H5 H5 H7 .. .. .. .. ..",
        ".. .. .. .. .. .. .. H7 H7 .. H7 H7 .. .. .. .. .. .." 
    ];
    // æ§åˆ¶è¯ºäºšè¡¨æƒ…çš„çŠ¶æ€æœº
    let currentFace = 'normal';

    // é—­çœ¼è´´å›¾ (æŠŠçœ¼ç›å˜æˆè‚¤è‰²å¹¶åŠ ä¸Šç«æ¯›æ¨ªçº¿)
    const pixelMap_blink = [
        ".. .. .. .. .. .. .. H7 H7 H7 H7 H7 H7 .. .. .. .. .. .. ..",
        ".. .. .. .. .. H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 .. .. .. .. ..",
        ".. .. .. H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7 .. .. ..",
        ".. .. H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 .. ..",
        ".. H7 H6 H6 H6 H7 H7 H6 H6 H6 H6 H6 H6 H7 H7 H6 H6 H6 H7 ..",
        "H7 H6 H6 H6 H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 H6 H6 H6 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H6 H6 H7 H6 H6 H6 H6 H7 H6 H7",
        "H7 H6 H6 H7 H6 H6 H6 H6 H6 H7 H6 H6 H7 H6 H6 H6 H6 H6 H7 H7",
        "H7 H6 H7 H6 H6 H7 H6 H7 E16 H7 H6 H7 E16 H7 H6 H6 H7 H6 H6 H7",
        ".. H7 H7 H6 H7 H7 H7 E16 E16 H7 E16 E16 E16 H7 H7 H6 H7 H7 ..",
        ".. .. H7 H6 H7 E16 E16 E16 E16 E16 E16 E16 E16 E16 E16 H7 H6 H7 ..", 
        ".. .. H7 H7 E2 E16 H7 H7 E16 E16 E16 E16 H7 H7 E16 E2 H7 H7 ..", 
        ".. .. .. H7 H7 E2 E2 E16 E16 E16 E16 E16 E16 E2 E2 H7 H7 .. ..",
        ".. .. .. .. H7 H7 H7 C16 E16 H2 E16 C16 H7 H7 H7 .. .. .. ..",
        ".. .. .. .. .. H7 H6 C16 C16 C16 C16 C16 H6 H7 .. .. .. .. ..",
        ".. .. .. .. H7 H6 H6 C16 H3 H6 H3 C16 H6 H6 H7 .. .. .. ..",
        ".. .. .. H7 H6 H6 H6 C16 C16 C16 C16 C16 H6 H6 H6 H7 .. .. ..",
        ".. .. .. H7 E16 E16 H7 H6 H3 H6 H3 H6 H7 E16 E16 H7 .. .. ..",
        ".. .. .. .. H7 H7 H7 H6 C16 H6 C16 H6 H7 H7 H7 .. .. .. ..",
        ".. .. .. .. .. H7 H6 H6 H6 H7 H6 H6 H6 H7 .. .. .. .. ..",
        ".. .. .. .. .. .. H7 H5 H5 H7 H5 H5 H7 .. .. .. .. ..",
        ".. .. .. .. .. .. .. H7 H7 .. H7 H7 .. .. .. .. .. .." 
    ];

    // å®³ç¾è´´å›¾ (åŠ æ·±çº¢æ™•èŒƒå›´)
    const pixelMap_shy = [
        ".. .. .. .. .. .. .. H7 H7 H7 H7 H7 H7 .. .. .. .. .. .. ..",
        ".. .. .. .. .. H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 .. .. .. .. ..",
        ".. .. .. H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7 .. .. ..",
        ".. .. H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 .. ..",
        ".. H7 H6 H6 H6 H7 H7 H6 H6 H6 H6 H6 H6 H7 H7 H6 H6 H6 H7 ..",
        "H7 H6 H6 H6 H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H6 H7 H6 H6 H6 H6 H6 H6 H7",
        "H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H6 H6 H7 H6 H6 H6 H6 H7 H6 H7",
        "H7 H6 H6 H7 H6 H6 H6 H6 H6 H7 H6 H6 H7 H6 H6 H6 H6 H6 H7 H7",
        "H7 H6 H7 H6 H6 H7 H6 H7 E16 H7 H6 H7 E16 H7 H6 H6 H7 H6 H6 H7",
        ".. H7 H7 H6 H7 H7 H7 E16 E16 H7 E16 E16 E16 H7 H7 H6 H7 H7 ..",
        ".. .. H7 H6 H7 E16 C4 C4 E16 E16 E16 E16 C4 C4 E16 H7 H6 H7 ..",
        ".. .. H7 H7 E3 E2 C3 C3 E16 E16 E16 E16 C3 C3 E2 E3 H7 H7 ..", 
        ".. .. .. H7 H7 E3 E3 E2 E16 E16 E16 E16 E2 E3 E3 H7 H7 .. ..", 
        ".. .. .. .. H7 H7 H7 C16 E16 H2 E16 C16 H7 H7 H7 .. .. .. ..",
        ".. .. .. .. .. H7 H6 C16 C16 C16 C16 C16 H6 H7 .. .. .. .. ..",
        ".. .. .. .. H7 H6 H6 C16 H3 H6 H3 C16 H6 H6 H7 .. .. .. ..",
        ".. .. .. H7 H6 H6 H6 C16 C16 C16 C16 C16 H6 H6 H6 H7 .. .. ..",
        ".. .. .. H7 E16 E16 H7 H6 H3 H6 H3 H6 H7 E16 E16 H7 .. .. ..",
        ".. .. .. .. H7 H7 H7 H6 C16 H6 C16 H6 H7 H7 H7 .. .. .. ..",
        ".. .. .. .. .. H7 H6 H6 H6 H7 H6 H6 H6 H7 .. .. .. .. ..",
        ".. .. .. .. .. .. H7 H5 H5 H7 H5 H5 H7 .. .. .. .. ..",
        ".. .. .. .. .. .. .. H7 H7 .. H7 H7 .. .. .. .. .. .." 
    ];
       function drawNoah() {
               ctx.setTransform(1, 0, 0, 1, 0, 0); // æ–°å¢ï¼šé‡ç½®ç”»å¸ƒåæ ‡
        if (noah.isAway) { ctx.clearRect(0, 0, 26, 26); return; }
        ctx.clearRect(0, 0, 26, 26); // æ›´æ–°ä¸º 26x26 ç”»å¸ƒ
        ctx.translate(3, 0); // æ–°å¢ï¼šæŠŠè¯ºäºšæ•´ä½“å‘å³å¹³ç§»3åƒç´ ï¼Œç»™å·¦è¾¹è…¾å‡ºç©ºé—´
        let currentMap;
        if (currentFace === 'blink') {
            currentMap = [...pixelMap_blink];
        } else if (currentFace === 'shy') {
            currentMap = [...pixelMap_shy];
        } else {
            currentMap = [...pixelMap];
        }
        // --- æ¶é­”æœé¥°ï¼šç¿…è†€å¿…é¡»åœ¨äººèº«ä½“ä¹‹å‰ç”»ï¼Œå®ç°åèƒŒé®æŒ¡æ•ˆæœ ---
        if (noah.outfit === 'devil') {
            let devilWingLeft = [
                ".. .. .. .. H7 .. .. .. .. ..",
                ".. .. H7 H7 DE_D H7 .. .. .. ..",
                ".. H7 DE_R DE_R H7 DE_R H7 H7 .. ..",
                "H7 .. .. DE_D H7 DE_D DE_R DE_D DE_D H7 H7",
                ".. .. .. H7 .. .. H7 DE_D H7 ..",
                ".. .. .. .. .. .. .. H7 .. .."
            ];
            let devilWingRight = [
                ".. .. .. .. .. H7 .. .. .. ..",
                ".. .. .. .. H7 DE_R H7 H7 .. ..",
                ".. .. H7 H7 DE_R H7  DE_R DE_R H7 ..",
                "H7 H7 DE_D DE_R DE_D H7 DE_R DE_D ..  H7",
                ".. H7 DE_D H7 .. .. H7 .. .. ..",
                ".. .. H7.. .. .. .. .. .. .."
            ];
            // ç»˜åˆ¶å·¦ç¿…è†€ (ä½ç½®åœ¨æœ€å·¦ä¾§ï¼Œé«˜åº¦å¯¹é½è…°èƒŒ)
            for (let y = 0; y < devilWingLeft.length; y++) {
                let row = devilWingLeft[y].trim().split(/\s+/);
                for (let x = 0; x < row.length; x++) {
                    let color = palette[row[x]];
                    if (color) { ctx.fillStyle = color; ctx.fillRect(x - 3, 14 + y, 1, 1); }
                }
            }
            // ç»˜åˆ¶å³ç¿…è†€ (ä½ç½®åœ¨æœ€å³ä¾§ï¼Œé«˜åº¦å¯¹é½è…°èƒŒ)
            for (let y = 0; y < devilWingRight.length; y++) {
                let row = devilWingRight[y].trim().split(/\s+/);
                for (let x = 0; x < row.length; x++) {
                    let color = palette[row[x]];
                    if (color) { ctx.fillStyle = color; ctx.fillRect(12 + x, 14 + y, 1, 1); }
                }
            }
        }
        // ç”»å‡ºè¯ºäºš
        for (let y = 0; y < currentMap.length; y++) {
            let rowColors = currentMap[y].trim().split(/\s+/);
            for (let x = 0; x < rowColors.length; x++) {
                let color = palette[rowColors[x]];
                if (color) { ctx.fillStyle = color; ctx.fillRect(x, y, 1, 1); }
            }
        }
        // --- æ–°å¢ï¼šç”»å‡ºè¯ºäºšçš„æ¢è£… ---
        if (noah.outfit === 'flower') {
            // ä½ ç”»çš„ 3x3 åƒç´ å›¾å®Œç¾å¤åˆ»
            let flowerMap = [
                "F_P F_P F_P",
                "F_P F_Y F_P",
                "F_P F_P F_P"
            ];
            let startX = 12; // Xåæ ‡5ï¼Œåˆšå¥½åˆ«åœ¨å·¦ä¾§å¤´å‘ä¸Š
            let startY = 3; // Yåæ ‡0ï¼Œæˆ´åœ¨å¤´é¡¶æœ€é«˜å¤„
            for (let y = 0; y < flowerMap.length; y++) {
                let rowColors = flowerMap[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { ctx.fillStyle = color; ctx.fillRect(startX + x, startY + y, 1, 1); }
                }
            }
        }
        // --- æ¶é­”æœé¥°ï¼šè§’å¿…é¡»åœ¨æœ€åç”»ï¼Œå®ç°é¡¶å±‚å¤´é¥°æ•ˆæœ ---
        if (noah.outfit === 'devil') {
            let devilHornLeft = [
                ".. DE_R .. ..",
                "DE_R .. .. ..",
                "DE_R DE_D .. ..",
                "DE_R DE_D .. ..",
                "DE_R DE_D .. ..",
                ".. DE_R DE_D ..",
                ".. DE_R DE_D .."
            ];
            let devilHornRight = [
                ".. .. DE_R ..",
                ".. .. .. DE_R",
                ".. .. DE_D DE_R",
                ".. .. DE_D DE_R",
                ".. .. DE_D DE_R",
                ".. DE_D DE_R ..",
                ".. DE_D DE_R .."
            ];
            // ç”»å·¦è§’ï¼Œå¡åœ¨å¤´é¡¶ç¨åå·¦ä¾§
            for (let y = 0; y < devilHornLeft.length; y++) {
                let rowColors = devilHornLeft[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { ctx.fillStyle = color; ctx.fillRect(4 + x, y, 1, 1); }
                }
            }
            // ç”»å³è§’ï¼Œå¡åœ¨å¤´é¡¶ç¨åå³ä¾§
            for (let y = 0; y < devilHornRight.length; y++) {
                let rowColors = devilHornRight[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { ctx.fillStyle = color; ctx.fillRect(12 + x, y, 1, 1); }
                }
            }
        }
        if (noah.outfit === 'dog_ear') {
            // å®Œå…¨æŒ‰ç…§ä½ ç»™çš„å›¾çº¸ 1:1 è¿˜åŸçš„çŸ©é˜µ
            let earMap = [
                ".. .. E_L E_L .. ..",
                ".. E_L E_L E_L E_L ..",
                ".. E_L E_D E_D E_L ..",
                "E_L E_D E_D E_D E_D E_L"
            ];
            // è®¾å®šå·¦å³ä¸¤åªè€³æœµçš„èµ·ç¬”ä½ç½®ï¼Œå®Œç¾å¡åœ¨å¤´é¡¶ä¸¤ä¾§
            let leftX = 2; let leftY = 2;  
            let rightX = 12; let rightY = 2;
            
            for (let y = 0; y < earMap.length; y++) {
                let rowColors = earMap[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { 
                        ctx.fillStyle = color; 
                        ctx.fillRect(leftX + x, leftY + y, 1, 1);   // ç”»å·¦è€³
                        ctx.fillRect(rightX + x, rightY + y, 1, 1); // ç”»å³è€³
                    }
                }
            }
        }
        if (noah.outfit === 'cat_ear') {
            // å°çŒ«è€³æœµå›¾çº¸ 1:1 è¿˜åŸ
            let catEarMap = [
                ".. .. WH WH .. ..",
                ".. WH WH WH WH ..",
                "WH WH E2 E2 WH WH",
                "WH E2 E2 E2 E2 WH"
            ];
            // å°¾å·´å›¾çº¸ (ç²¾å‡†çš„å³ä¸‹ç¿˜èµ·å¹…åº¦)
            let catTailMap = [
                ".. .. .. .. WH",
                ".. .. .. WH WH",
                ".. .. .. WH WH",
                ".. .. WH WH ..",
                ".. .. WH WH ..",
                ".. WH WH .. ..",
                "WH WH .. .. .."
            ];
            
            // ç”»å‡ºå·¦è€³å’Œå³è€³ï¼Œå¡åœ¨å¤´å‘è¾¹ç¼˜
            let leftX = 2; let leftY = 2;  
            let rightX = 12; let rightY = 2;
            
            for (let y = 0; y < catEarMap.length; y++) {
                let rowColors = catEarMap[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { 
                        ctx.fillStyle = color; 
                        ctx.fillRect(leftX + x, leftY + y, 1, 1);   // ç”»å·¦è€³
                        ctx.fillRect(rightX + x, rightY + y, 1, 1); // ç”»å³è€³
                    }
                }
            }
            
            // ç”»å‡ºå°¾å·´ï¼Œä½ç½®åœ¨èº«ä½“å³ä¸‹ä¾§
            let tailX = 14; let tailY = 15;
            for (let y = 0; y < catTailMap.length; y++) {
                let rowColors = catTailMap[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { 
                        ctx.fillStyle = color; 
                        ctx.fillRect(tailX + x, tailY + y, 1, 1); 
                    }
                }
            }
        }
                if (noah.outfit === 'maid') {
            // å¤´é¥°å›¾çº¸ (æŒ‰å›¾1:1è¿˜åŸè´è¶ç»“)
            let maidHeadMap = [
                ".. .. .. E3 .. .. E3 .. .. ..",
                ".. E2 E3 GB F_Y F_Y GB E3 E2 ..",
                ".. E2 E3 .. F_Y F_Y .. E3 E2 ..",
                ".. E2 E3 GB F_Y F_Y GB E3 E2 ..",
                ".. .. .. E3 .. .. E3 .. .. .."
            ];
            // è¡£æœå›¾çº¸ (å®Œç¾è¦†ç›–ä¸‹åŠèº«ï¼Œè£™æ‘†å’Œèƒ¸å‰è´è¶ç»“ç»†èŠ‚å…¨åœ¨)
            let maidDressMap = [
                ".. .. H7 H7 H7 H2 H2 H7 H7 H7 .. ..",
                ".. H7 E3 H7 H2 C4 C4 H2 H7 E3 H7 ..",
                ".. H7 E2 E3 H7 H2 H2 H7 E3 E2 H7 ..",
                "H7 E2 E2 H7 H6 H6 H6 H6 H7 E2 E2 H7",
                "H7 H2 E2 H7 E3 E3 E3 E3 H7 E2 H2 H7",
                "H7 H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 H7",
                ".. H7 H2 E3 H2 E3 E3 H2 E3 H2 H7 ..",
                ".. H7 H6 H6 H6 H6 H6 H6 H6 H6 H7 ..",
                ".. .. .. H7  .. .. H7 H7 .. .. .."
            ];

            // ç»˜åˆ¶å¤´é¥° (å¡åœ¨å¤´é¡¶æ­£ä¸­å¿ƒ)
            let headX = 5; let headY = 0;
            for (let y = 0; y < maidHeadMap.length; y++) {
                let rowColors = maidHeadMap[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { ctx.fillStyle = color; ctx.fillRect(headX + x, headY + y, 1, 1); }
                }
            }

            // ç»˜åˆ¶è¡£æœ (ç²¾ç¡®è¦†ç›–åœ¨è„–å­ä»¥ä¸‹çš„èº«ä½“åŒºåŸŸ)
            let dressX = 4; let dressY = 15;
            for (let y = 0; y < maidDressMap.length; y++) {
                let rowColors = maidDressMap[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { ctx.fillStyle = color; ctx.fillRect(dressX + x, dressY + y, 1, 1); }
                }
            }
        }
        // --- æ–°å¢ï¼šç”»å‡ºä½ æŠ•å–‚æˆ–è´­ä¹°çš„å°ç‰©å“ ---
        if (window.currentShowingItem && sprites[window.currentShowingItem]) {
            let itemMap = sprites[window.currentShowingItem];
            let startX = 13; // å›ºå®šåœ¨è¯ºäºšçš„å³ä¸‹è§’
            let startY = 17; 
            for (let y = 0; y < itemMap.length; y++) {
                let rowColors = itemMap[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { ctx.fillStyle = color; ctx.fillRect(startX + x, startY + y, 1, 1); }
                }
            }
        }
    }

    // --- æåº¦ä¸°å¯Œçš„å¤–å‡ºäº‹ä»¶åº“ (6ä¸ªåœ°ç‚¹ x 10+äº‹ä»¶) ---
    const locations = {
"gringotts": {
    name: "å¤çµé˜ (å–é›¶èŠ±é’±)",
    icon: "ğŸ¦",
    desc: "å­˜é’±ç†è´¢ï¼Œæ¯å¤©è¿˜èƒ½æ¥æ‹¿å“¥å“¥ç»™çš„50åŠ éš†é›¶èŠ±é’±ã€‚",
            cost: { hunger: 5, health: 0, gold: 0 },
            events: [] // ç‰¹æ®Šåœ°ç‚¹ï¼Œè¿›å…¥ç‹¬ç«‹é“¶è¡Œç³»ç»Ÿ
        },
        "london": {
            name: "ä¼¦æ•¦è¡—å¤´ (é›¨å¤œ)",
            icon: "â˜”",
            desc: "æˆ‘ä»¬çš„â€œæ— é™â€ä¹‹åœ°ã€‚é€‚åˆçº¦ä¼šï¼Œä½†èŠ±é”€è¾ƒå¤§ã€‚",
            cost: { hunger: 15, health: 5, gold: 30 }, // æ¶ˆè€—é«˜
            events: [
                { text: "ä¸‹é›¨äº†ï¼Œä»–ç”¨ç°è‰²ç¾½ç»’æœæŠŠä½ è£¹è¿›æ€€é‡Œã€‚", diff: { love: 25, mood: 20 }, reply: "â€œå†·å—ï¼Ÿé è¿‘ç‚¹ã€‚è¿™ä»¶è¡£æœä¹°æ¥å°±æ˜¯ä¸ºäº†æ­¤åˆ»èƒ½è£…ä¸‹ä¸¤ä¸ªäººã€‚â€" },
                { text: "è·¯è¿‡ä¸€å®¶éº»ç“œå”±ç‰‡åº—ï¼Œé‡Œé¢åœ¨æ”¾è«æ‰ç‰¹ã€‚", diff: { mood: 15, love: 10 }, reply: "â€œå¤å…¸ä¹å’Œé›¨å£°å¾ˆé…ï¼Œå°±åƒæˆ‘å’Œä½ ã€‚è¿›å»çœ‹çœ‹ï¼Ÿä¹Ÿè®¸èƒ½æ‰¾åˆ°é‚£å¼ æˆ‘ä»¬è¦çš„é»‘èƒ¶ã€‚â€" },
                { text: "åœ¨è¡—è§’èŠ±åº—ä¹°äº†ä¸€æŸèŒ‰è‰èŠ±ã€‚", diff: { gold: -20, love: 20 }, reply: "â€œè™½ç„¶æˆ‘å–œæ¬¢èŒ‰è‰åªæ˜¯å› ä¸ºå¥½é—»ï¼Œä½†ç°åœ¨å®ƒä»£è¡¨æˆ‘é‚£ä¸ªåœ¨é›¨ä¸­å‚»ç¬‘çš„å¥³æœ‹å‹ã€‚â€" },
                { text: "åœ¨æ³°æ™¤å£«æ²³æ—é—²é€›ï¼Œè®¨è®ºå“²å­¦æ‚–è®ºã€‚", diff: { mood: 30, gold: 0 }, reply: "â€œå¡ç¿å¤±é©¬ï¼Œç„‰çŸ¥éç¦ã€‚å°±åƒæˆ‘å³ä½¿å¤±å»äº†æ•´ä¸ªä¸–ç•Œï¼Œåªè¦ä½ åœ¨ï¼Œæˆ‘å°±èµ¢äº†ã€‚â€" },
                { text: "å»ä¾¿åˆ©åº—ä¹°äº†ä¸€ç½ç¢³é…¸é¥®æ–™ã€‚", diff: { hunger: 10, gold: -5 }, reply: "â€œå‘²â€”â€”æ°”æ³¡éŸ³ã€‚ç»™ï¼Œç¬¬ä¸€å£ç»™ä½ ã€‚è¿™å¯æ˜¯éº»ç“œä¸–ç•Œçš„é­”è¯ã€‚â€" },
                { text: "å¶é‡ä¸€å®¶ç”µç©åŸï¼Œä»–éè¦å’Œä½ æ¯”èµ›è½¦ã€‚", diff: { mood: 20, love: 10, gold: -20 }, reply: "â€œæˆ‘èµ¢äº†ã€‚ä½œä¸ºå¥–åŠ±ï¼Œä»Šæ™šä½ è¦ä¸€ç›´ç‰µç€æˆ‘çš„æ‰‹ï¼Œä¸è®¸æ”¾å¼€ã€‚â€" },
                { text: "åœ¨çº¢ç»¿ç¯ä¸‹ï¼Œä»–çªç„¶å»äº†ä½ ã€‚", diff: { love: 40, mood: 40 }, reply: "â€œç»¿ç¯äº®äº†ï¼Œä½†æˆ‘ä¸æƒ³èµ°ã€‚è®©æ•´ä¸ªä¼¦æ•¦éƒ½ç­‰ç€å§ï¼Œæˆ‘ç°åœ¨åªæƒ³å»æˆ‘çš„ä¼½æ‹‰æã€‚â€" },
                { text: "çœ‹åˆ°ä¸€åªæ·‹æ¹¿çš„æµæµªçŒ«ã€‚", diff: { mood: 10, love: 10 }, reply: "â€œçœ¼ç¥åƒä½ çŠ¯é”™æ—¶ä¸€æ ·æ— è¾œã€‚å¥½å§ï¼Œæˆ‘ä»¬ç»™å®ƒä¹°ç‚¹åƒçš„ï¼Œä½†ä¸èƒ½å¸¦å›å®¶ï¼Œå®¶é‡Œåªèƒ½æœ‰ä½ ä¸€ä¸ªå°éº»çƒ¦ã€‚â€" },
                { text: "è·¯è¿‡ç”µå½±é™¢ï¼Œæ­£åœ¨æ”¾æ˜ é’æ˜¥ç‰‡ã€‚", diff: { gold: -30, love: 15 }, reply: "â€œè™½ç„¶å‰§æƒ…çƒ‚ä¿—ï¼Œä½†æˆ‘ä¹æ„é™ªä½ çœ‹ã€‚å› ä¸ºé»‘æš—ä¸­æˆ‘å¯ä»¥è‚†æ— å¿Œæƒ®åœ°çœ‹ç€ä½ çš„ä¾§è„¸ã€‚â€" },
                { text: "åœ¨å¨æ–¯æ•æ–¯ç‰¹ç«™å£ï¼Œä»–åƒå¾€å¸¸ä¸€æ ·ç­‰ä½ ã€‚", diff: { love: 30 }, reply: "â€œå‘¨äº”çš„çº¦å®šã€‚ä¸ç®¡å‘ç”Ÿä»€ä¹ˆï¼Œæˆ‘éƒ½ä¼šåœ¨è¿™é‡Œã€‚å“ªæ€•ä¸–ç•Œæœ«æ—¥ã€‚â€" }
            ]
        },
        "library": {
            name: "éœæ ¼æ²ƒå…¹å›¾ä¹¦é¦†",
            icon: "ğŸ“–",
            desc: "æ‹‰æ–‡å…‹åŠ³çš„ä¸»åœºã€‚å®‰é™ï¼Œçœé’±ï¼Œå¢é•¿æ™ºæ…§ã€‚",
            cost: { hunger: 10, health: 0, gold: 0 },
            events: [
                { text: "ä½ ä»¬åœ¨å¹³æ–¯å¤«äººçš„çœ¼çš®åº•ä¸‹ä¼ é€’çº¸æ¡ã€‚", diff: { love: 10, mood: 10 }, reply: "çº¸æ¡ä¸Šå†™ç€ï¼šâ€˜ç¬¬7æ’ä¹¦æ¶åè§ï¼Œæƒ³ä½ äº†ã€‚ç½²åï¼šä½ å¸…æ°”çš„BFâ€™" },
                { text: "ä»–å¸®ä½ è¡¥ä¹ é­”è¯å­¦è®ºæ–‡ã€‚", diff: { mood: 15 }, reply: "â€œè¿™é‡Œå†™é”™äº†ã€‚ä½ æ˜¯æƒ³æŠŠå©åŸšç‚¸äº†å—ï¼Ÿç¬¨è›‹ï¼Œçœ‹ç€æˆ‘ï¼Œå†è®²ä¸€éã€‚â€" },
                { text: "åœ¨ç¦ä¹¦åŒºé—¨å£æ¢å¤´æ¢è„‘ã€‚", diff: { mood: 20, love: 10 }, reply: "â€œæƒ³è¿›å»ï¼Ÿåªè¦ä½ å¼€å£ï¼Œæˆ‘å°±èƒ½å¸¦ä½ æºœè¿›å»ã€‚åæ­£ä¹Ÿä¸æ˜¯ç¬¬ä¸€æ¬¡è¿åæ ¡è§„äº†ã€‚â€" },
                { text: "ä»–çœ‹ç€ä¹¦ç¡ç€äº†ï¼Œç«æ¯›å¾ˆé•¿ã€‚", diff: { love: 20 }, reply: "ï¼ˆä½ å·å·äº²äº†ä»–ä¸€ä¸‹ï¼‰ä»–é—­ç€çœ¼å‹¾èµ·å˜´è§’ï¼šâ€œå·è¢­ï¼Ÿè®°åœ¨è´¦ä¸Šäº†ï¼Œé†’æ¥åç™¾å€å¥‰è¿˜ã€‚â€" },
                { text: "ä¸ºäº†ä¸€ä¸ªå­¦æœ¯é—®é¢˜äº‰è®ºä¸ä¼‘ã€‚", diff: { mood: 10 }, reply: "â€œç¼¸ä¸­ä¹‹è„‘...å¥½å§ï¼Œä¹Ÿè®¸ä½ è¯´å¾—å¯¹ã€‚ä½†æˆ‘æ›´æ„¿æ„ç›¸ä¿¡æˆ‘çš„å¤§è„‘æ­¤åˆ»æ„Ÿå—åˆ°çš„å¯¹ä½ çš„çˆ±æ˜¯çœŸå®çš„ã€‚â€" },
                { text: "é‡åˆ°äº†æ³•æ–¯ç‰¹Â·èµ›è‚¯å¾·ï¼Œæ°”æ°›å°´å°¬ã€‚", diff: { mood: -10 }, reply: "è¯ºäºšå†·å†·åœ°çœ‹äº†ä»–ä¸€çœ¼ï¼ŒæŠŠä½ æ‹‰åˆ°èº«åï¼šâ€œè®©å¼€ï¼Œä½ æŒ¡ä½æˆ‘ä»¬è¦æ‰¾çš„ä¹¦äº†ã€‚â€" },
                { text: "æ‰¾åˆ°ä¸€æœ¬å…³äºå¤ä»£å¦‚å°¼æ–‡çš„æ—§ä¹¦ã€‚", diff: { mood: 20 }, reply: "â€œè™½ç„¶æ™¦æ¶©ï¼Œä½†æˆ‘ä»¬å¯ä»¥ä¸€èµ·ç ´è¯‘ã€‚å°±åƒæˆ‘ä»¬ä¸€èµ·æ¢ç´¢è¿™ä¸ªä¸–ç•Œä¸€æ ·ã€‚â€" },
                { text: "çª—å¤–ä¸‹èµ·äº†é›ªï¼Œå®¤å†…å¾ˆæ¸©æš–ã€‚", diff: { hunger: -5, love: 15 }, reply: "â€œå¦‚æœæ—¶é—´èƒ½åœåœ¨è¿™ä¸€åˆ»å°±å¥½äº†ã€‚åªæœ‰ä¹¦é¦™ï¼Œé›ªï¼Œå’Œä½ ã€‚â€" },
                { text: "ä»–ç”¨é­”æ³•å˜å‡ºä¸€æœµè“è‰²çš„å°èŠ±å¤¹åœ¨ä½ ä¹¦é‡Œã€‚", diff: { love: 15 }, reply: "â€œä¹¦çœ‹ç´¯äº†å°±çœ‹èŠ±ï¼ŒèŠ±çœ‹ç´¯äº†...å°±çœ‹æˆ‘ã€‚æˆ‘æ¯”èŠ±å¥½çœ‹ã€‚â€" },
                { text: "ä½ ä»¬å…±ç”¨ä¸€å‰¯è€³æœºå¬éº»ç“œéŸ³ä¹ã€‚", diff: { mood: 20 }, reply: "â€œåˆ«å‘Šè¯‰åˆ«äººæˆ‘åœ¨å¬è¿™ä¸ªã€‚è¿™æ˜¯å±äºæˆ‘ä»¬ä¸¤ä¸ªçš„å°ç§˜å¯†ã€‚â€" }
            ]
        },
        "lake": {
            name: "é»‘æ¹– / ç¦æ—è¾¹ç¼˜",
            icon: "ğŸŒ²",
            desc: "å†’é™©è€…çš„ä¹å›­ã€‚å¯èƒ½å—ä¼¤ï¼Œä¹Ÿå¯èƒ½æ¡åˆ°å®è—ã€‚",
            cost: { hunger: 20, health: 15, gold: 0 },
            events: [
                { text: "åœ¨ç¦æ—è¾¹ç¼˜å‘ç°äº†ä¸€ä¸ªå¤è€çš„å®ç®±ï¼", diff: { gold: 100, mood: 20 }, reply: "â€œçœ‹æ¥å¹¸è¿å¥³ç¥ä»Šå¤©åçˆ±ä½ ã€‚å…¨éƒ¨å½’ä½ ï¼Œæˆ‘åªè¦ä½ å¼€å¿ƒã€‚â€ (è·å¾—100G)" },
                { text: "é‡åˆ°äº†å·¨å¤§çš„é»‘æ¹–é±¿é±¼ï¼Œè¢«æ³¼äº†ä¸€èº«æ°´ã€‚", diff: { health: -10, mood: -10 }, reply: "â€œè¯¥æ­»ï¼æ¸…ç†ä¸€æ–°ï¼è¿™è§¦æ‰‹æ€ªæ˜¯ä¸æ˜¯å«‰å¦’æˆ‘é•¿å¾—å¸…ï¼Ÿâ€" },
                { text: "åœ¨è‰ä¸›é‡Œæ¡åˆ°äº†ä¸€äº›ç¨€æœ‰è‰è¯ã€‚", diff: { gold: 40, mood: 10 }, reply: "â€œæ–¯æ™®åŠ³ç‰¹æ•™æˆä¼šå–œæ¬¢è¿™ä¸ªçš„ï¼Œæˆ–è€…æˆ‘ä»¬å¯ä»¥æ‹¿å»å–äº†æ¢é»„æ²¹å•¤é…’ã€‚â€ (è·å¾—40G)" },
                { text: "ä¸ºäº†æ‘˜æ‚¬å´–è¾¹çš„ä¸€æœµèŠ±ï¼Œä»–æ‘”ä¼¤äº†æ‰‹è‡‚ã€‚", diff: { health: -30, love: 30 }, reply: "â€œå˜¶...åˆ«å“­ã€‚è¿™ç‚¹ä¼¤æ¢ä½ ç¬‘ä¸€ä¸‹ï¼Œå€¼äº†ã€‚ä½ çœ‹ï¼ŒèŠ±å¾ˆç¾ï¼Œåƒä½ ã€‚â€" },
                { text: "å¶é‡ä¸€åªè¿·è·¯çš„å°ç‹¬è§’å…½ã€‚", diff: { mood: 30, love: 10 }, reply: "â€œå®ƒè®©ä½ æ‘¸ï¼Ÿå“¼ï¼Œçœ‹æ¥çº¯æ´çš„ç”Ÿç‰©éƒ½å–œæ¬¢ä½ ã€‚ä½†æˆ‘æ‰æ˜¯æœ€å–œæ¬¢ä½ çš„é‚£ä¸ªã€‚â€" },
                { text: "é‡åˆ°äº†æ­£åœ¨å·¡é€»çš„æµ·æ ¼ã€‚", diff: { hunger: -20 }, reply: "â€œå²©çš®é¥¼ï¼Ÿå“¦ä¸...ä¸ºäº†ç‰™é½¿ç€æƒ³ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¿«è·‘å§ã€‚â€ (å› é€ƒè·‘æ¶ˆè€—é¥±é£Ÿ)" },
                { text: "åœ¨æ¹–è¾¹æ‰“æ°´æ¼‚ï¼Œä»–ç«Ÿç„¶è¾“ç»™äº†ä½ ã€‚", diff: { mood: 15 }, reply: "â€œæˆ‘é‚£æ˜¯è®©ç€ä½ ï¼å¥½å§ï¼Œæ„¿èµŒæœè¾“ï¼ŒèƒŒä½ å›åŸå ¡ã€‚â€" },
                { text: "å‘ç°äº†é©¬äººç•™ä¸‹çš„é¢„è¨€çŸ³æ¿ã€‚", diff: { gold: 60 }, reply: "â€œæ˜Ÿè±¡è¯´ä»Šæ™šä¼šæœ‰å¥½äº‹å‘ç”Ÿ...æ¯”å¦‚ï¼Œä½ ä¼šè¯·æˆ‘åƒå¤œå®µï¼Ÿâ€ (è·å¾—60G)" },
                { text: "è¢«ä¸€ç¾¤æŠ¤æ ‘ç½—é”…å›´æ”»ã€‚", diff: { health: -15, mood: -5 }, reply: "â€œåˆ«æ€•ï¼Œèº²æˆ‘èº«åï¼è¿™äº›å°ä¸œè¥¿è„¾æ°”çœŸæš´èºã€‚â€" },
                { text: "åœ¨æ¹–è¾¹çœ‹å¤•é˜³ï¼Œæ°´é¢æ³¢å…‰ç²¼ç²¼ã€‚", diff: { love: 20, mood: 20 }, reply: "â€œäººä¸èƒ½ä¸¤æ¬¡è¸è¿›åŒä¸€æ¡æ²³æµï¼Œä½†æˆ‘ä¼šæ— æ•°æ¬¡çˆ±ä¸ŠåŒä¸€ä¸ªä½ ã€‚â€" }
            ]
        },
        "hogsmeade": {
            name: "éœæ ¼è«å¾·æ‘",
            icon: "ğŸº",
            desc: "çƒ­é—¹çš„å·«å¸ˆæ‘è½ã€‚åƒå–ç©ä¹ï¼Œæ¶ˆè€—é‡‘å¸ã€‚",
            cost: { hunger: -30, health: 5, gold: 40 }, // å›å¤é¥±é£Ÿ
            events: [
                { text: "åœ¨ä¸‰æŠŠæ‰«å¸šå–çƒ­é»„æ²¹å•¤é…’ã€‚", diff: { hunger: 20, mood: 20 }, reply: "â€œä½ å˜´å”‡ä¸Šæœ‰æ³¡æ²«...åˆ«åŠ¨ï¼Œæˆ‘å¸®ä½ æ“¦ã€‚â€ï¼ˆä»–å‡‘è¿‡æ¥å»æ‰äº†æ³¡æ²«ï¼‰" },
                { text: "åœ¨èœ‚èœœå…¬çˆµä¹°äº†ä¸€å¤§å †ç³–æœã€‚", diff: { hunger: 10, gold: -20 }, reply: "â€œå¼ å˜´ã€‚ç”œå—ï¼Ÿå†ç”œä¹Ÿæ²¡æœ‰ä½ ç”œã€‚â€" },
                { text: "å»äº†ä½ç§‘ç¬‘è¯åº—ï¼Œä¹°äº†ä¸ªæ¶ä½œå‰§é“å…·ã€‚", diff: { gold: -15, mood: 15 }, reply: "â€œæˆ‘æƒ³æŠŠè¿™ä¸ªæ”¾åœ¨å¸ƒé›·æ–¯çš„æ•å¤´ä¸‹...å˜˜ï¼Œè¿™æ˜¯æˆ‘ä»¬å…±çŠ¯çš„è¯æ˜ã€‚â€" },
                { text: "åœ¨å¸•ç¬›èŠ™å¤«äººèŒ¶é¦†ï¼Œè¢«æƒ…ä¾£ä»¬é—ªçäº†çœ¼ã€‚", diff: { mood: -5, love: 10 }, reply: "â€œè¿™é‡Œå¤ªç²‰çº¢äº†ï¼Œå—ä¸äº†ã€‚ä½†å¦‚æœæ˜¯å’Œä½ åœ¨ä¸€èµ·...å‹‰å¼ºå¯ä»¥å¿å—ã€‚â€" },
                { text: "é‡åˆ°äº†æ­£åœ¨çº¦ä¼šçš„å¾·æ‹‰ç§‘Â·é©¬å°”ç¦ã€‚", diff: { mood: 0 }, reply: "â€œçœ‹ä»€ä¹ˆçœ‹ï¼Œé©¬å°”ç¦ï¼Ÿå†çœ‹æŠŠä½ å˜æˆç™½é¼¬ã€‚èµ°å§ï¼Œåˆ«ç†ä»–ã€‚â€" },
                { text: "åœ¨é‚®å±€ç»™æœªæ¥çš„æˆ‘ä»¬å†™äº†ä¸€å°ä¿¡ã€‚", diff: { love: 20 }, reply: "â€œæ”¶ä»¶äººï¼šè¯ºäºšå’Œä»–çš„å¦»å­ã€‚å¯„å‡ºæ—¶é—´ï¼šç°åœ¨ã€‚å¸Œæœ›æœªæ¥çš„æˆ‘ä¾ç„¶è¿™ä¹ˆå¸…ã€‚â€" },
                { text: "çªé™å¤§é›ªï¼Œèº²è¿›ä¸€å®¶åºŸå¼ƒçš„å°å±‹ã€‚", diff: { love: 30 }, reply: "â€œè¿™åœºæ™¯åƒä¸åƒç”µå½±ï¼Ÿåªæœ‰æˆ‘ä»¬ä¸¤ä¸ªï¼Œä¸ä¸–éš”ç»ã€‚çœŸå¸Œæœ›é›ªæ°¸è¿œä¸åœã€‚â€" },
                { text: "ä¹°äº†å°–å«æ¸¸ä¹å›­çš„é—¨ç¥¨ã€‚", diff: { health: -5, mood: 25, gold: -30 }, reply: "â€œä½ å°–å«çš„æ ·å­çœŸå¯çˆ±ã€‚å®³æ€•å°±æŠ±ç´§æˆ‘ï¼Œè¿™å°±æ˜¯æˆ‘å­˜åœ¨çš„æ„ä¹‰ã€‚â€" },
                { text: "åœ¨æ–‡äººå±…ç¾½æ¯›ç¬”åº—æŒ‘äº†ä¸€æ”¯ç¬”ã€‚", diff: { gold: -10, mood: 10 }, reply: "â€œç”¨è¿™æ”¯ç¬”å†™ç»™ä½ çš„æƒ…ä¹¦ï¼Œä¼šä¸ä¼šæ›´æœ‰æ–‡é‡‡ä¸€ç‚¹ï¼Ÿâ€" },
                { text: "åœ¨å¤§è¡—ä¸Šå¤§å£°å–Šä½ çš„åå­—ã€‚", diff: { mood: 20, love: 10 }, reply: "â€œæˆ‘è¦è®©æ•´ä¸ªéœæ ¼è«å¾·éƒ½çŸ¥é“ï¼Œä½ æ˜¯æˆ‘çš„ï¼â€" }
            ]
        },
        "room": {
            name: "æœ‰æ±‚å¿…åº”å±‹",
            icon: "ğŸ°",
            desc: "åªå±äºä½ ä»¬çš„ç§˜å¯†åŸºåœ°ã€‚è®­ç»ƒæˆ˜æ–—æˆ–å¯»æ‰¾å¤±ç‰©ã€‚",
            cost: { hunger: 20, health: 15, gold: 0 },
            events: [
                { text: "æŠŠæˆ¿é—´å˜æˆäº†å†³æ–—ä¿±ä¹éƒ¨ï¼Œç»ƒä¹ é™¤ä½ æ­¦å™¨ã€‚", diff: { health: -10, love: 15 }, reply: "â€œååº”ä¸é”™ã€‚ä½†åœ¨æˆ˜åœºä¸Šï¼Œæ•Œäººä¸ä¼šåƒæˆ‘è¿™æ ·èˆä¸å¾—ä¼¤ä½ ã€‚å†æ¥ï¼â€" },
                { text: "åœ¨æ‚ç‰©å †é‡Œæ‰¾åˆ°äº†ä¸€è¢‹è¢«é—å¿˜çš„é‡‘å¸ã€‚", diff: { gold: 80 }, reply: "â€œè¿™æ˜¯è°è—çš„ç§æˆ¿é’±ï¼Ÿç°åœ¨å®ƒæ˜¯æˆ‘ä»¬çš„æ‹çˆ±åŸºé‡‘äº†ã€‚â€ (è·å¾—80G)" },
                { text: "æˆ¿é—´å˜æˆäº†å…¨æ˜¯é•œå­çš„è¿·å®«ã€‚", diff: { mood: 10 }, reply: "â€œå¥½å¤šæˆ‘ï¼Œå¥½å¤šä½ ã€‚æ— è®ºä½ çœ‹å‘å“ªé‡Œï¼Œçœ‹åˆ°çš„éƒ½æ˜¯æˆ‘ä»¬åœ¨ä¸€èµ·çš„æ ·å­ã€‚â€" },
                { text: "ä»–æ•™ä½ å‘¼ç¥æŠ¤å«ï¼Œä»–çš„å®ˆæŠ¤ç¥æ˜¯ä¸€åªå†°åŸç‹¼ã€‚", diff: { love: 25, mood: 20 }, reply: "â€œæƒ³ç€æœ€å¿«ä¹çš„è®°å¿†...å¯¹æˆ‘æ¥è¯´ï¼Œé‚£æ®µè®°å¿†å°±æ˜¯é‡åˆ°ä½ çš„é‚£å¤©ã€‚â€" },
                { text: "æˆ¿é—´å˜æˆäº†ä¸€ç‰‡æŸ”è½¯çš„äº‘æµ·ã€‚", diff: { health: 10, mood: 20 }, reply: "ï¼ˆèººåœ¨äº‘ä¸Šï¼‰â€œå¦‚æœç´¯äº†å°±ç¡ä¸€ä¼šã€‚æˆ‘ä¼šå®ˆç€ä½ ï¼Œè¿å™©æ¢¦éƒ½ä¸æ•¢é è¿‘ã€‚â€" },
                { text: "ç»ƒä¹ å¤§è„‘å°é—­æœ¯ï¼Œä»–å¯¹ä½ æ•å¼€äº†å¿ƒæ‰‰ã€‚", diff: { love: 30 }, reply: "â€œçœ‹åˆ°äº†å—ï¼Ÿæˆ‘çš„è„‘æµ·é‡Œï¼Œé™¤äº†é‚£äº›ä¹±ä¸ƒå…«ç³Ÿçš„ç†è®ºï¼Œå‰©ä¸‹çš„å…¨æ˜¯ä½ ã€‚â€" },
                { text: "æ‰¾åˆ°äº†ä¸€æŠŠæ—§çš„é£å¤©æ‰«å¸šï¼Œåœ¨å±‹é‡Œä½ç©ºé£è¡Œã€‚", diff: { mood: 15, health: -5 }, reply: "â€œæŠ“ç´§æˆ‘ï¼æˆ‘ä»¬è¦æ’ä¸Šå¤©èŠ±æ¿äº†â€”â€”å“ˆå“ˆï¼Œåˆºæ¿€å—ï¼Ÿâ€" },
                { text: "æˆ¿é—´å˜æˆäº†ä¸€ä¸ªå¤å¤çš„èˆå…ã€‚", diff: { love: 20 }, reply: "â€œè¿™ä½ç¾ä¸½çš„å°å§ï¼Œèƒ½è¯·ä½ è·³æ”¯èˆå—ï¼Ÿå°±åƒæˆ‘ä»¬åœ¨ä¼¦æ•¦çœ¼ä¸‹è·³å¼—æ‹‰æ˜æˆˆé‚£æ ·ã€‚â€" },
                { text: "æ„å¤–ç¿»å‡ºäº†è¥¿å¥¥å¤šÂ·è¯ºç‰¹å°æ—¶å€™çš„ç…§ç‰‡ã€‚", diff: { mood: -10 }, reply: "â€œçƒ§äº†å§ã€‚åˆ«è®©è¿™ä¸œè¥¿æ±¡æŸ“äº†æˆ‘ä»¬çš„ç§˜å¯†åŸºåœ°ã€‚â€" },
                { text: "åœ¨è¿™é‡Œä»€ä¹ˆéƒ½ä¸åšï¼Œåªæ˜¯é™é™åœ°æ‹¥æŠ±ã€‚", diff: { mood: 30, love: 20 }, reply: "â€œå¤–é¢ä¸–ç•Œå¾ˆåµï¼Œäººç¾¤å¾ˆåµã€‚åªæœ‰è¿™é‡Œï¼Œåªæœ‰ä½ ï¼Œæ˜¯å®‰é™çš„ã€‚â€" }
            ]
        },
        "astronomy": {
            name: "å¤©æ–‡å¡”é¡¶å±‚",
            icon: "ğŸŒŒ",
            desc: "ç¦»æ˜Ÿæ˜Ÿæœ€è¿‘çš„åœ°æ–¹ã€‚æ·±å¤œï¼Œé«˜å¤„ä¸èƒœå¯’ã€‚",
            cost: { hunger: 10, health: 10, gold: 0 },
            events: [
                { text: "ç”¨æœ›è¿œé•œè§‚æµ‹æœ¨æ˜Ÿçš„å«æ˜Ÿã€‚", diff: { mood: 20 }, reply: "â€œå®‡å®™å¤§çˆ†ç‚¸ï¼Œä¸‡ç‰©è¯ç”Ÿ...è€Œæˆ‘çš„å®‡å®™ä¸­å¿ƒï¼Œæ­¤æ—¶æ­¤åˆ»æ­£ç«™åœ¨æˆ‘èº«è¾¹ã€‚â€" },
                { text: "é«˜å¤„çš„é£å¾ˆå¤§ï¼Œå¹ä¹±äº†ä»–çš„é»‘å‘ã€‚", diff: { love: 15, health: -5 }, reply: "â€œåˆ«åŠ¨ï¼Œè®©æˆ‘å¸®ä½ æŒ¡é£ã€‚è¦æ˜¯ä½ æ„Ÿå†’äº†ï¼Œæˆ‘ä¼šå¿ƒç–¼æ­»çš„ã€‚â€" },
                { text: "åœ¨è¿™é‡Œä¿¯ç°æ•´ä¸ªéœæ ¼æ²ƒå…¹ã€‚", diff: { mood: 15 }, reply: "â€œçœ‹ï¼Œé‚£æ˜¯é»‘æ¹–ï¼Œé‚£æ˜¯çƒåœº...æ€»æœ‰ä¸€å¤©ï¼Œæˆ‘ä¼šå¸¦ä½ å»æ›´è¿œçš„åœ°æ–¹ï¼Œå…¨ä¸–ç•Œé¨æ¸¸ã€‚â€" },
                { text: "æµæ˜Ÿåˆ’è¿‡ï¼Œä½ ä»¬ä¸€èµ·è®¸æ„¿ã€‚", diff: { love: 25 }, reply: "â€œè®¸äº†ä»€ä¹ˆæ„¿ï¼Ÿæƒ³è®©æˆ‘æ´»å‡ ä¸‡å¹´ï¼Ÿå‡†äº†ã€‚æˆ‘è¦ç•™ç€è¿™æ¡å‘½ï¼Œä¸€ç›´çˆ±ä½ ã€‚â€" },
                { text: "é‡åˆ°äº†æ­£åœ¨å¤œå·¡çš„è´¹å°”å¥‡å’Œæ´›ä¸½ä¸å¤«äººã€‚", diff: { mood: -20, health: -10 }, reply: "â€œå¿«è·‘ï¼å¹»èº«å’’ï¼å‘¼...å·®ç‚¹è¢«æŠ“åˆ°ï¼Œä¸è¿‡è¿™å¿ƒè·³åŠ é€Ÿçš„æ„Ÿè§‰ï¼Œè¿˜ä¸é”™ã€‚â€" },
                { text: "åœ¨è¿™é‡Œè·³äº†ä¸€æ”¯æ²¡æœ‰éŸ³ä¹çš„èˆã€‚", diff: { love: 20 }, reply: "â€œæ˜Ÿå…‰å°±æ˜¯èšå…‰ç¯ï¼Œé£å£°å°±æ˜¯ä¼´å¥ã€‚ä½ æ˜¯æˆ‘çš„èˆä¼´ï¼Œä¹Ÿæ˜¯æˆ‘å”¯ä¸€çš„è§‚ä¼—ã€‚â€" },
                { text: "è®¨è®ºå…³äºæ­»äº¡å’Œæ°¸æ’çš„è¯é¢˜ã€‚", diff: { mood: 10 }, reply: "â€œå¦‚æœæœ‰ä¸€å¤©æˆ‘æ­»äº†...æˆ‘ä¼šè®©ä½ æŠŠæˆ‘åšæˆé­‚å™¨ã€‚è¿™æ ·æˆ‘å°±èƒ½æ°¸è¿œé™ªç€ä½ ï¼Œä½ ä¹Ÿæ°¸è¿œç”©ä¸æ‰æˆ‘ã€‚â€" },
                { text: "ä»–åœ¨æ æ†è¾¹ç¼˜åšå±é™©åŠ¨ä½œå“å”¬ä½ ã€‚", diff: { mood: -10, love: 10 }, reply: "â€œæ‹…å¿ƒæˆ‘ï¼Ÿæ”¾å¿ƒï¼Œæˆ‘èˆä¸å¾—æ­»ã€‚æˆ‘è¿˜æ²¡å¨¶åˆ°ä½ å‘¢ã€‚â€" },
                { text: "å–äº†ä¸€å£å·å¸¦ä¸Šæ¥çš„çƒˆç«å¨å£«å¿Œã€‚", diff: { health: -5, mood: 15 }, reply: "â€œæ•¬æ˜Ÿç©ºï¼Œæ•¬è‡ªç”±ï¼Œæ•¬è¯¥æ­»çš„çº¯è¡€ç»Ÿè®ºï¼Œæ•¬æˆ‘ä»¬ã€‚â€" },
                { text: "åœ¨è¿™é‡Œè¿æ¥æ—¥å‡ºã€‚", diff: { mood: 30, love: 20 }, reply: "â€œå¤©äº®äº†ã€‚æ–°çš„ä¸€å¤©ï¼Œæˆ‘è¿˜çˆ±ç€ä½ ã€‚è€Œä¸”æ¯”æ˜¨å¤©æ›´çˆ±ä¸€ç‚¹ã€‚â€" }
            ]
        }
    };

    // --- æ–°å¢ï¼šæ‰“å¼€åœ°ç‚¹é€‰æ‹©èœå• ---
    function openLocationMenu() {
    if(window.isGomoku) { moveGomokuCursor(0, -1); return; }
if(window.isGaming) { speak("æˆ‘ç°åœ¨æ­£å¿™ç€ç»™ä½ èµšåŠ éš†ï¼Œæ²¡ç©ºå‡ºé—¨ï¼"); return; }
        if(noah.isAway) { speak("è¯ºäºšæ­£åœ¨å¤–é¢æ¢é™©ï¼Œè€å¿ƒç‚¹ï¼Œå¥³æœ‹å‹ã€‚"); return; }
        if(noah.health < 20 || noah.hunger < 20) { 
            speak("â€œæˆ‘å¤ªç´¯äº†ï¼Œæˆ–è€…å¤ªé¥¿äº†...å…ˆç…§é¡¾å¥½æˆ‘ï¼Œå†å¸¦ä½ å»å¾æœä¸–ç•Œã€‚â€ (çŠ¶æ€è¿‡ä½ï¼Œæ— æ³•å¤–å‡º)"); 
            return; 
        }

        const list = document.getElementById('modal-list');
        list.innerHTML = '';
        document.getElementById('modal-title').innerText = "ğŸŒ é€‰æ‹©ç›®çš„åœ°";
        
        for (let key in locations) {
            let loc = locations[key];
            let li = document.createElement('li');
            // æ˜¾ç¤ºæ¶ˆè€—æç¤º
            let costText = [];
            if(loc.cost.gold > 0) costText.push(`-${loc.cost.gold}G`);
            if(loc.cost.hunger > 0) costText.push(`é¥±é£Ÿ-${loc.cost.hunger}`);
            
            li.innerHTML = `<span>${loc.icon} ${loc.name}</span> <span style="font-size:9px;opacity:0.7">${costText.join(' ')}</span>`;
            li.onclick = () => { confirmAdventure(key); };
            list.appendChild(li);
        }
        document.getElementById('sys-modal').style.display = 'block';
    }

    function confirmAdventure(locKey) {
        let loc = locations[locKey];
        
        // æ£€æŸ¥é‡‘å¸æ˜¯å¦è¶³å¤Ÿ
    if(noah.gold < loc.cost.gold) {
        sfx_error(); // <--- åŠ è¿™é‡Œ
        speak(`â€œå»${loc.name}å¯æ˜¯è¦èŠ±é’±çš„ã€‚çœ‹çœ‹ä½ çš„é’±åŒ…ï¼Œåªæœ‰${noah.gold}Gã€‚æˆ‘ä»¬è¿˜æ˜¯å»é»‘æ¹–æ¡ç ´çƒ‚å§ã€‚â€`);
        closeModal();
        return;
    }
    sfx_success(); // <--- åŠ è¿™é‡Œ
    closeModal();
    // ... ä¸‹é¢çš„ä»£ç ä¿æŒä¸å˜
        
        // æ‰£é™¤æ¶ˆè€—
        noah.gold -= loc.cost.gold;
        noah.hunger -= loc.cost.hunger;
        if(loc.cost.health) noah.health -= loc.cost.health;
        // éœæ ¼è«å¾·ç‰¹æ®Šå›å¤
        if(locKey === 'hogsmeade') noah.hunger += 30;

        // å¼€å§‹æ¢é™©åŠ¨ç”»
        noah.isAway = true;
        document.getElementById('adventure-overlay').style.display = 'flex';
        document.getElementById('noah-canvas').style.display = 'none'; 
        // --- æ–°å¢ï¼šç”¨åœºæ™¯åƒç´ ç”»ä»£æ›¿åŸæœ¬çš„ Emoji ---
        document.getElementById('adv-icon').style.display = 'none'; 
        const advCanvas = document.getElementById('adv-canvas');
        advCanvas.style.display = 'block';
        const advCtx = advCanvas.getContext('2d');
        advCtx.clearRect(0, 0, 10, 10);
        
        // åˆ¤æ–­å»å“ªé‡Œï¼Œç”»å‡ºå“ªé‡Œçš„å›¾çº¸
               let sceneKey = 'lake';
        if (locKey === 'london' || locKey === 'astronomy') sceneKey = 'london';
        else if (locKey === 'library') sceneKey = 'library';
        else if (locKey === 'hogsmeade' || locKey === 'room') sceneKey = 'room';
        else if (locKey === 'gringotts') sceneKey = 'gringotts'; // <--- åŠ ä¸Šè¿™ä¸€è¡Œ
        
        let sceneMap = sprites[sceneKey];
        if (sceneMap) {
            for (let y = 0; y < sceneMap.length; y++) {
                let rowColors = sceneMap[y].trim().split(/\s+/);
                for (let x = 0; x < rowColors.length; x++) {
                    let color = palette[rowColors[x]];
                    if (color) { advCtx.fillStyle = color; advCtx.fillRect(x, y, 1, 1); }
                }
            }
        }
        document.getElementById('adv-text').innerText = "EXPLORING " + loc.name.split(' ')[0];
        
        speak(`â€œå»${loc.name}ï¼Ÿå¥½ä¸»æ„ã€‚è·Ÿç´§æˆ‘ï¼Œåˆ«èµ°ä¸¢äº†ã€‚â€ (é¢„è®¡è€—æ—¶8ç§’)`);

        setTimeout(() => {
            noah.isAway = false;
            document.getElementById('adventure-overlay').style.display = 'none';
            document.getElementById('noah-canvas').style.display = 'block'; 
                        // --- æ‹¦æˆªå¤çµé˜ä¸“å±ç•Œé¢ ---
            if (locKey === 'gringotts') {
                openGringottsBank();
                return; 
            }
            // éšæœºæŠ½å–è¯¥åœ°ç‚¹çš„äº‹ä»¶
            const eventPool = loc.events;
            const event = eventPool[Math.floor(Math.random() * eventPool.length)];
            
            // åº”ç”¨æ•°å€¼å˜åŒ–
            if(event.diff.gold) noah.gold += event.diff.gold;
            if(event.diff.love) noah.love += event.diff.love;
            if(event.diff.mood) noah.mood += event.diff.mood;
            if(event.diff.health) noah.health += event.diff.health;
            if(event.diff.hunger) noah.hunger += event.diff.hunger;

            speak(event.reply);
            updateUI();
            showEventModal(event.text, event.diff);
            
        }, 8000);
    }

    function showEventModal(text, diff) {
        let diffText = "";
        if(diff.gold > 0) diffText += `<span style="color:#d1b55a">+${diff.gold}G </span>`;
        if(diff.gold < 0) diffText += `<span style="color:#d15a5a">${diff.gold}G </span>`;
        if(diff.love > 0) diffText += `<span style="color:#ff99cc">åçˆ±+${diff.love} </span>`;
        if(diff.health < 0) diffText += `<span style="color:#d15a5a">å¥åº·${diff.health} </span>`;
        if(diff.mood > 0) diffText += `<span style="color:#5cd1ff">å¿ƒæƒ…+${diff.mood} </span>`;

        document.getElementById('event-text').innerHTML = `${text}<br><br><div style="font-size:10px; margin-top:5px;">${diffText}</div>`;
        document.getElementById('event-options').innerHTML = `<button class="event-btn" onclick="document.getElementById('event-modal').style.display='none'">ç¡®å®š</button>`;
        document.getElementById('event-modal').style.display = 'flex';
    }

    // --- åŸæœ‰èœå•é€»è¾‘ ---
    const menus = {
        feed: [
            { name: "åå…¨å¤§è¡¥çˆ±å¿ƒé­”è¯ (G100)", action: () => buyItem(100, 'health', 80, 'love', 20, "è¿™ä»€ä¹ˆä¸œè¥¿ï¼Ÿä¸ºäº†ä½ æˆ‘å–...å’³ï¼Œæ„Ÿè§‰å¥½å¤šäº†ï¼Œä½ æ˜¯ä¸æ˜¯åœ¨é‡Œé¢åŠ äº†ç¦çµå‰‚ï¼Ÿ") },
            { name: "é€’ç»™ä»–èŒ‰è‰èŠ±èŒ¶ (G10)", action: () => buyItem(10, 'mood', 15, 'love', 10, "é¦™å‘³å¾ˆç†Ÿæ‚‰ã€‚ä¸è¿‡ä½ éš¾é“ä¸çŸ¥é“ï¼Œæˆ‘å–œæ¬¢èŒ‰è‰ä»…ä»…æ˜¯å› ä¸ºå¥½é—»ï¼Œä½†æˆ‘å–œæ¬¢ä½ ï¼Œæ˜¯å› ä¸ºé‚£æ˜¯ä½ ã€‚") },
            { name: "é€’ä¸€ç½ç¢³é…¸é¥®æ–™ (G15)", action: () => buyItem(15, 'mood', 20, 'hunger', 10, "å‘²â€”â€”ï¼ˆæ‹‰å¼€æ˜“æ‹‰ç½ï¼‰ã€‚æ°”æ³¡ç‚¸è£‚çš„å£°éŸ³ã€‚æ´»åœ¨å½“ä¸‹çš„æ„Ÿè§‰çœŸå¥½ï¼Œå°¤å…¶æ˜¯ä½ åœ¨æˆ‘æ—è¾¹ã€‚") },
            { name: "é€æ¯’è˜‘è‡ç‰›å¥¶ (G5)", action: () => buyItem(5, 'health', -10, 'love', 30, "ä½ åˆæ¥ï¼Ÿè¡Œï¼Œé»‘å†å²è¿‡ä¸å»äº†æ˜¯å§ã€‚åªè¦æ˜¯ä½ ç»™çš„ï¼Œå°±ç®—å«æˆ‘çˆ¶äº²æˆ‘ä¹Ÿå–ã€‚(ä¸€é¥®è€Œå°½)") },
            { name: "ä¸‰æŠŠæ‰«å¸šçƒ­é»„æ²¹å•¤é…’ (G25)", action: () => buyItem(25, 'hunger', 30, 'mood', 20, "å¹²æ¯ï¼Œåˆ«å–é†‰äº†ï¼Œä¸ç„¶æˆ‘æ€•æˆ‘æ§åˆ¶ä¸ä½æƒ³å¯¹ä½ åšç‚¹ä»€ä¹ˆã€‚") },
            { name: "èœ‚èœœå…¬çˆµç³–ç¾½æ¯›ç¬” (G20)", action: () => buyItem(20, 'hunger', 15, 'mood', 15, "ä¸€è¾¹æ€è€ƒç¼¸ä¸­ä¹‹è„‘ï¼Œä¸€è¾¹åƒç³–...æˆ‘ä¹Ÿåªæœ‰åœ¨ä½ é¢å‰æ‰ä¼šè¿™ä¹ˆçŸ›ç›¾äº†ã€‚ç¬¨è›‹ã€‚") }
        ],
        interact: [
 { name: "ğŸµ è¯ºäºšéšèº«å¬", action: () => { sfx_success(); document.getElementById('music-modal').style.display='flex'; } },           

 { name: "ğŸ‘— æ‰“å¼€è¡£æŸœ ", action: () => setTimeout(openWardrobe, 10) },
            { name: "âœ‰ï¸ å†™æ‚„æ‚„è¯ç»™ä»–", action: () => openSecretChat() },
            { name: "â™Ÿï¸ å’Œä»–ä¸‹äº”å­æ£‹", action: () => startGomoku() },
 { name: "ğŸ® é™ªä»–æ¥é‡‘å¸ (G5)", action: () => startMiniGame() }, // <- æ–°åŠ è¿™ä¸€è¡Œ
            { name: "é€’ç»™ä»–ç»¿è‰²å°è›‡ç©å¶", action: () => chat("å°ç»¿è›‡") },
            { name: "è¯´â€œæˆ‘æ¨ä½ Xä¸‡éâ€", action: () => chat("äº’æ€¼") },
            { name: "æ‰¯ä»–è„–å­ä¸Šçš„è“å®çŸ³é¡¹é“¾", action: () => chat("é¡¹é“¾") },
            { name: "è®©ä»–æŠŠå›´å·¾ç³»åœ¨å¤´ä¸Š", action: () => chat("å›´å·¾") },
            { name: "èŠèŠè–›å®šè°”çš„çŒ«", action: () => chat("å“²å­¦") },
            { name: "æ•…æ„æè¥¿å¥¥å¤šÂ·è¯ºç‰¹", action: () => chat("è¥¿å¥¥å¤š") },
            { name: "æ•…æ„æå¸ƒé›·æ–¯Â·æ‰æ¯”å°¼", action: () => chat("å¸ƒé›·æ–¯") },
            { name: "å¤¸ä»–â€œå¸…æäº†â€", action: () => chat("è‡ªæ‹") },
         
            { name: "é‚€è¯·ä»–åœ¨é›¨ä¸­æ¼«æ­¥", action: () => chat("é›¨ä¸­") },
         
 { name: "âš™ï¸ ç³»ç»Ÿè®¾ç½®", action: () => { sfx_success(); document.getElementById('settings-modal').style.display='flex'; } }
        ],
              shop: [
            { name: "ğŸ˜ˆ æ¶é­”æœé¥° (G200)", action: () => buyOutfit(200, 'devil', "æ¶é­”ï¼Ÿ ä½ æœ€å¥½æƒ³æ¸…æ¥šè®©æˆ‘ç©¿è¿™å¥—è¡£æœçš„åæœã€‚æ¯•ç«Ÿæ‹›æƒ¹äº†æ¶é­”ï¼Œå°±ç®—é€ƒåˆ°å®‡å®™è¾¹ç¼˜æˆ‘ä¹Ÿèƒ½æŠŠä½ æŠ“å›æ¥åƒæ‰ã€‚") },
{ name: "ğŸ€ ç²‰ç™½å¥³ä»†è£… (G520)", action: () => buyOutfit(520, 'maid', "è®©æˆ‘ç©¿å¥³ä»†è£…ï¼Ÿï¼ä½ çš„å°è„‘ç“œé‡Œéƒ½åœ¨æƒ³äº›ä»€ä¹ˆå±é™©çš„ä¸œè¥¿â€¦â€¦è¡Œäº†åˆ«ç”¨é‚£ç§æœŸå¾…çš„çœ¼ç¥çœ‹ç€æˆ‘ï¼åªé™ä»Šå¤©ä¸€æ¬¡ï¼Œè¦æ˜¯ä½ æ•¢å·å·æˆªå›¾å½•å±ï¼Œæˆ‘å°±ç”¨é­”æ–æŠŠä½ çš„è®¾å¤‡ç‚¸äº†ï¼") },
            { name: "ğŸ± å°çŒ«è€³æœµä¸å°¾å·´ (G120)", action: () => buyOutfit(120, 'cat_ear', "æˆ´ä¸Šè¿™ä¸ªï¼Ÿå…¶å®æ˜¯å†°åŸç‹¼ï¼Œä½†çœ‹ç€å¾ˆåƒå°çŒ«ã€‚å‹‰å¼ºæ»¡è¶³ä½ çš„æ¶è¶£å‘³å§ã€‚") },
{ name: "ğŸ¶ å°ç‹—è€³æœµå¤´é¥° (G60)", action: () => buyOutfit(60, 'dog_ear', "æƒ³è®©æˆ‘æˆ´å°ç‹—è€³æœµï¼Ÿä½ çœŸæŠŠæˆ‘å½“å® ç‰©äº†ï¼Ÿâ€¦â€¦æ±ªã€‚æ»¡æ„äº†å§ï¼Ÿæ—¢ç„¶å½“äº†ç‹—ï¼Œé‚£ç­‰ä¼šå’¬ä½ çš„è¯ï¼Œä½ å¯åˆ«å“­ã€‚") },
                       { name: "ğŸŒ¸ å°èŠ±èŠ±å¤´é¥° (G90)", action: () => buyOutfit(90, 'flower', "è¿™ä»€ä¹ˆï¼Ÿå°èŠ±èŠ±ï¼Ÿ...è¡Œå§ï¼Œæ—¢ç„¶æ˜¯ä½ ä¹°çš„ï¼Œæˆ‘å°±å‹‰ä¸ºå…¶éš¾æˆ´åœ¨å¤´ä¸Šã€‚ä¸è®¸ç¬‘ï¼") },
 { name: "å¤¹å¿ƒé¢åŒ…ç°è‰²ç¾½ç»’æœ (G150)", action: () => buyItem(150, 'love', 50, 'mood', 30, "ä½ å«Œå®ƒä¸‘ï¼Ÿå¯å®ƒæš–å’Œå•Šï¼Œè€Œä¸”è¿™ä»¶è¡£æœçš„å¤§å°ï¼Œåˆšå¥½è¶³å¤ŸæŠŠä½ æ•´ä¸ªäººåŒ…è¿›æˆ‘æ€€é‡Œã€‚") },
            { name: "ã€Šè«é‡Œæ–¯çš„æƒ…äººã€‹å½±ç¥¨ (G80)", action: () => buyItem(80, 'mood', 40, 'love', 40, "åœ¨ä¸‹é›¨çš„æ™šä¸Šçœ‹è¿™éƒ¨ç”µå½±æœ€åˆé€‚äº†ã€‚æˆ‘ä¾ç„¶æƒ³ä¸é€šå…‹è±å¤«æ€ä¹ˆä¼šèˆå¾—ç»“å©šï¼Œæ¢ä½œæ˜¯æˆ‘ï¼Œæ­»éƒ½ä¸æ”¾æ‰‹ã€‚") },
            { name: "å»ä½“éªŒâ€œæ— é™â€çš„é—¨ç¥¨ (G200)", action: () => buyItem(200, 'love', 80, 'mood', 60, "å‘¨äº”çš„çº¦å®šã€‚å“ªæ€•å®‡å®™çˆ†ç‚¸ï¼Œè¿™å‘¨äº”æˆ‘ä¹Ÿä¼šå‡†æ—¶å¸¦ä½ å»ä½“éªŒçœŸæ­£çš„è‡ªç”±ã€‚") },
            { name: "å®šåˆ¶æƒ…ä¾£æ‹‰æ–‡å…‹åŠ³å›´å·¾ (G120)", action: () => buyItem(120, 'love', 60, 'mood', 50, "æˆ´ä¸Šå®ƒï¼Œè¿™æ ·å…¨éœæ ¼æ²ƒå…¹å°±éƒ½çŸ¥é“ï¼Œä½ æ˜¯è¢«æˆ‘è¯ºäºšÂ·å¸å¾·é‡Œå®‰åœˆå…»çš„äº†ã€‚") },
            { name: "èŒ‰è‰é¦™æ°›èœ¡çƒ› (G30)", action: () => buyItem(30, 'mood', 20, 'love', 10, "ç‚¹ç‡ƒå®ƒï¼Œå°±åƒä½ éšæ—¶åœ¨æˆ‘èº«è¾¹ã€‚ä¸è¿‡ä½ æœ¬äººæ¯”è¿™å‘³é“å¥½é—»ä¸€ä¸‡å€ã€‚") },
            { name: "è«æ‰ç‰¹é»‘èƒ¶å”±ç‰‡ (G60)", action: () => buyItem(60, 'mood', 35, 'love', 20, "å¤å…¸ä¹ï¼Ÿçœ¼å…‰ä¸é”™ã€‚ä»Šæ™šæ¥æˆ‘æˆ¿é—´ï¼Œæˆ‘ä»¬ä¸€èµ·å¬ã€‚ä¸è®¸æ‹’ç»ã€‚") },
            { name: "å†°åŸç‹¼æœ¨é›• (G50)", action: () => buyItem(50, 'love', 30, 'mood', 20, "æˆ‘çš„å®ˆæŠ¤ç¥ã€‚åªè¦ä½ çœ‹ç€å®ƒï¼Œå°±åƒæˆ‘ä¸€ç›´åœ¨ä¿æŠ¤ä½ ä¸€æ ·ã€‚") },
            { name: "è“å®çŸ³æƒ…ä¾£å¯¹æˆ’ (G520)", action: () => buyItem(520, 'love', 200, 'mood', 100, "ä¹°è¿™ä¸ªï¼Ÿä½ å¯æƒ³å¥½äº†ï¼Œæˆ´ä¸Šå°±åˆ«æƒ³æ‘˜ä¸‹æ¥ã€‚è¿™è¾ˆå­ä½ éƒ½æ˜¯æˆ‘çš„ã€‚") },
            { name: "ä¼¦æ•¦çœ¼åŒäººå¤œåœºç¥¨ (G180)", action: () => buyItem(180, 'love', 70, 'mood', 50, "åœ¨æœ€é«˜å¤„æ¥å»çš„äººä¼šæ°¸è¿œåœ¨ä¸€èµ·ï¼Ÿè¿™ç§éº»ç“œä¼ è¯´æˆ‘ä¹Ÿä¿¡ï¼Œèµ°å§ã€‚") },
            { name: "é™é‡ç‰ˆç¢³é…¸é¥®æ–™ç›²ç›’ (G40)", action: () => buyItem(40, 'hunger', 20, 'mood', 25, "å‘²â€”â€”ç¬¬ä¸€å£ç»™ä½ ã€‚è¿™æ¯”ä»»ä½•ç¦çµå‰‚éƒ½è®©æˆ‘ä¸Šç˜¾ã€‚") },
            { name: "æœ€æ–°æ¬¾åŒäººæŒæœº (G250)", action: () => buyItem(250, 'mood', 80, 'love', 50, "æ•¢è·Ÿæˆ‘æ¯”ï¼Ÿè¾“äº†çš„äººä»Šæ™šè¦ç­”åº”å¯¹æ–¹ä¸€ä¸ªè¦æ±‚ã€‚æˆ‘èµ¢å®šäº†ã€‚") },
            { name: "é»„é“œå¤©æ–‡æœ›è¿œé•œ (G150)", action: () => buyItem(150, 'mood', 60, 'love', 40, "ç”¨å®ƒçœ‹æ˜Ÿæ˜Ÿï¼Œç”¨çœ¼ç›çœ‹ä½ ã€‚å®‡å®™å†å¤§ï¼Œä¹Ÿæ²¡æœ‰ä½ å¯¹æˆ‘çš„å¼•åŠ›å¤§ã€‚") },
            { name: "ã€Šåå¤§å“²å­¦æ‚–è®ºã€‹ (G70)", action: () => buyItem(70, 'mood', 40, 'love', 30, "ç¼¸ä¸­ä¹‹è„‘ï¼ŸåŒç¼å¹²æ¶‰ï¼Ÿè¿™äº›éƒ½ä¸å¦‚â€˜æˆ‘æ€ä¹ˆè¿™ä¹ˆçˆ±ä½ â€™è¿™ä¸ªæ‚–è®ºéš¾è§£ã€‚") },
            { name: "ç»¿è‰²å°è›‡åˆºç»£æŠ±æ• (G45)", action: () => buyItem(45, 'love', 30, 'mood', 15, "å’³...è¿™ä¸ªæ‰‹æ„Ÿç¡®å®ä¸é”™ã€‚ä½†æˆ‘æ™šä¸Šè¿˜æ˜¯æ›´æƒ³æŠ±ä½ æœ¬äººã€‚") },
            { name: "æ³°æ™¤å£«æ²³å¤œæ¸¸èˆ¹ç¥¨ (G100)", action: () => buyItem(100, 'mood', 50, 'love', 40, "å†·å—ï¼Ÿé è¿‘ç‚¹ã€‚å¤œé£å†å†·ï¼Œæœ‰æˆ‘åœ¨ä½ èº«è¾¹å°±ä¸ä¼šè®©ä½ å†»ç€ã€‚") },
            { name: "éº»ç“œé’æ˜¥ç”µå½±å…¨é›† (G80)", action: () => buyItem(80, 'mood', 30, 'love', 50, "è¿™ä¹ˆçƒ‚ä¿—çš„å‰§æƒ…ï¼ŸFineï¼Œåªè¦æ˜¯ä½ é€‰çš„ï¼Œå°±ç®—çœ‹ä¸€ä¸‡éæˆ‘ä¹Ÿä¹æ„ã€‚") },
            { name: "é›¨ä¸­æ¼«æ­¥é€æ˜ä¼ (G35)", action: () => buyItem(35, 'love', 25, 'mood', 15, "å…¶å®ä¸ç”¨ä¼ã€‚è¢«æ·‹æ¹¿äº†ï¼Œæˆ‘å°±æœ‰ç†ç”±æŠŠä½ æ•´ä¸ªäººè£¹è¿›æˆ‘çš„ç¾½ç»’æœé‡Œäº†ã€‚") },
            { name: "é˜²è¥¿å¥¥å¤šé è¿‘ç¬¦å’’ (G100)", action: () => buyItem(100, 'mood', 60, 'love', 40, "è¿™ä¸œè¥¿å¤ªæœ‰ç”¨äº†ï¼å†è®©æˆ‘çœ‹åˆ°é‚£ä¸ªç–¯å­é è¿‘ä½ ï¼Œæˆ‘å°±è®©ä»–ç°é£çƒŸç­ï¼") },
            { name: "ä¸“å±äº²äº²å…‘æ¢å¡ç‰‡ (G99)", action: () => buyItem(99, 'love', 80, 'mood', 50, "ä½ ä¹°è¿™ä¸ªï¼Ÿ(è€³æœµæ³›çº¢) éšæ—¶å…‘ç°ï¼Œè¿‡æœŸä¸å€™ã€‚ç°åœ¨å°±è¦ç”¨å—ï¼Ÿ") },
            { name: "é»‘é­”æ³•å¤ç±å­¤æœ¬ (G300)", action: () => buyItem(300, 'mood', 100, 'love', 80, "è¿™ä¹¦å¾ˆéš¾æ‰¾ã€‚é‡Œé¢æœ‰ä¸ªå’’è¯­...èƒ½è®©ä½ æ°¸è¿œç¦»ä¸å¼€æˆ‘ã€‚å¼€ç©ç¬‘çš„ï¼Œæˆ‘ä¸ç”¨å’’è¯­ä¹Ÿèƒ½åšåˆ°ã€‚") },
            { name: "æ–¯è±ç‰¹æ—é…è‰²æ‰‹é“¾ (G60)", action: () => buyItem(60, 'love', 40, 'mood', 20, "è™½ç„¶æˆ‘æ˜¯æ‹‰æ–‡å…‹åŠ³ï¼Œä½†åªè¦æ˜¯ä½ è¿™åªæ–¯è±ç‰¹æ—å°è›‡ï¼Œæˆ‘ç”˜æ„¿è¢«ä½ ç¼ ç»•ã€‚") },
            { name: "æµ·æ»¨å‡æ—¥ç‰¹å¿«è½¦ç¥¨ (G220)", action: () => buyItem(220, 'love', 90, 'mood', 70, "æµ·è¾¹æ”¾è‚†è¿½é€ï¼Ÿå¥½å•Šï¼Œå¦‚æœæˆ‘æŠ“åˆ°ä½ ï¼Œä½ å°±ä»»æˆ‘å¤„ç½®ã€‚è·‘å¿«ç‚¹ã€‚") },
            { name: "å¸ƒé›·æ–¯ä¸“å±æ¶ä½œå‰§ç›’ (G50)", action: () => buyItem(50, 'mood', 50, 'love', 20, "å¹²å¾—æ¼‚äº®ã€‚é‚£ä¸ªä¼ªå›å­æ‰“å¼€çš„æ—¶å€™ï¼Œæˆ‘ä¸€å®šè¦ç”¨ç•™å½±æœºæ‹ä¸‹æ¥ï¼") },
            { name: "ã€Šåº„å­ä¸è€å­ã€‹è¯‘æœ¬ (G65)", action: () => buyItem(65, 'mood', 35, 'love', 25, "ä¸ºæ— ä¸ºï¼Œäº‹æ— äº‹ã€‚ä½†æˆ‘å¯¹ä½ ï¼Œåªæƒ³â€˜ä½†è¡Œå¥½äº‹ï¼Œè«é—®å‰ç¨‹â€™ã€‚") },
            { name: "èŒ‰è‰é¦™ç¡çœ çœ¼ç½© (G30)", action: () => buyItem(30, 'mood', 20, 'health', 15, "åªè¦é—­ä¸Šçœ¼ï¼Œé—»åˆ°è¿™å‘³é“ï¼Œæˆ‘çš„æ¢¦é‡Œå…¨éƒ½æ˜¯ä½ ã€‚") },
            { name: "æ— é™ç¬¦å·âˆé¡¹é“¾å  (G131)", action: () => buyItem(131, 'love', 99, 'mood', 50, "æŠŠå®ƒæŒ‚åœ¨æˆ‘çš„è“å®çŸ³é¡¹é“¾æ—è¾¹ã€‚è¿™ä»£è¡¨æˆ‘å¯¹ä½ çš„çˆ±ï¼Œæ— å§‹æ— ç»ˆï¼Œæ— é™å¾ªç¯ã€‚") },
            { name: "çŒ«å’ªé«˜çº§é›¶é£Ÿç½å¤´ (G20)", action: () => buyItem(20, 'mood', 15, 'love', 10, "ç»™å®¶é‡Œçš„çŒ«ï¼Ÿè¡Œå§ã€‚ä¸è¿‡ä½ å¾—å…ˆå–‚æˆ‘ï¼Œæˆ‘æ¯”çŒ«æ›´éœ€è¦ä½ ã€‚") },
            { name: "åŒç¼å¹²æ¶‰å¾®ç¼©æ¨¡å‹ (G90)", action: () => buyItem(90, 'mood', 45, 'love', 35, "å½“ä½ ä¸è§‚æµ‹æ—¶ï¼Œå…‰æ˜¯æ³¢ï¼›å½“æˆ‘çœ‹ç€ä½ æ—¶ï¼Œä½ å°±æ˜¯æˆ‘çš„å…¨ä¸–ç•Œã€‚") },
            { name: "è–›å®šè°”çš„çŒ«ç›²ç›’ (G55)", action: () => buyItem(55, 'mood', 30, 'love', 25, "åœ¨æ‰“å¼€å‰ï¼ŒçŒ«æ˜¯æ­»æ˜¯æ´»éƒ½æœ‰å¯èƒ½ã€‚ä½†æ— è®ºæ‰“å¼€ä»€ä¹ˆï¼Œæˆ‘éƒ½ç¡®ä¿¡æˆ‘çˆ±ä½ ã€‚") },
            { name: "å¸å¾·é‡Œå®‰æƒ…ä¹¦ä¿¡çº¸ (G40)", action: () => buyItem(40, 'love', 35, 'mood', 20, "æƒ³è®©æˆ‘ç»™ä½ å†™æƒ…ä¹¦ï¼Ÿæ²¡é—®é¢˜ï¼Œç½²åæ°¸è¿œæ˜¯â€˜ä½ å…¨ä¸–ç•Œæœ€å¸…æ°”æœ€æ— æ‰€ä¸èƒ½çš„BFâ€™ã€‚") },
            { name: "å…”å­è€³æœµæ¯›ç»’å‘ç® (G25)", action: () => buyItem(25, 'mood', -10, 'love', 40, "æƒ³è®©æˆ‘æˆ´è¿™ä¸ªå‘Šè¯‰ä½ ä¸ºä»€ä¹ˆå…”å­æœ‰ä¸¤åªè€³æœµï¼Ÿæƒ³éƒ½åˆ«æƒ³ï¼...å¥½å§ï¼Œåªæˆ´äº”åˆ†é’Ÿã€‚") },
            { name: "ä¼¦æ•¦è¡—è¾¹å°åƒé›†é”¦ (G75)", action: () => buyItem(75, 'hunger', 40, 'mood', 30, "ä¸ç”¨å»ä¼¦æ•¦ä¹Ÿèƒ½åƒåˆ°ï¼Ÿå¼ å˜´ï¼Œå•Šâ€”â€”çœ‹ä½ åƒä¸œè¥¿ä¹Ÿæ˜¯ä¸€ç§äº«å—ã€‚") },
            { name: "å¡ç¿å¤±é©¬è¿ç¯ç”»å†Œ (G20)", action: () => buyItem(20, 'mood', 15, 'love', 15, "å¡ç¿å¤±é©¬ï¼Œç„‰çŸ¥éç¦ã€‚é‡åˆ°ä½ ï¼Œå°±æ˜¯æˆ‘è¿™è¾ˆå­æœ€å¤§çš„ç¦æ°”ã€‚") }
        ]
    };
    // --- æ–°å¢ï¼šè¡£æŸœä¸è‡ªç”±æ¢è£…ç³»ç»Ÿ ---
    function openWardrobe() {
        if(window.isGaming) { speak("ä¸“å¿ƒç‚¹ï¼æˆ‘æ­£åœ¨æ¥é‡‘å¸å‘¢ï¼"); return; }
        if(noah.isAway) { speak("è¯ºäºšä¸åœ¨å®¶ï¼Œä½ æƒ³ç»™ç©ºæ°”æ¢è¡£æœå—ï¼Ÿ"); return; }

        const list = document.getElementById('wardrobe-list');
        list.innerHTML = '';
        document.getElementById('wardrobe-modal').style.display = 'flex';

        const outfitNames = {
            'devil': 'ğŸ˜ˆ ä¸“å±æ¶é­”æœé¥°',
            'none': 'ğŸ§¥ é»˜è®¤åŸè£…é»‘è¡£',
            'flower': 'ğŸŒ¸ å°èŠ±èŠ±å¤´é¥°',
'dog_ear': 'ğŸ¶ å°ç‹—è€³æœµå¤´é¥°',
'cat_ear': 'ğŸ± å°çŒ«è€³æœµä¸å°¾å·´',
'maid': 'ğŸ€ ä¸“å±ç²‰ç™½å¥³ä»†è£…'
        };

        // éå†ä½ æ‰€æœ‰è§£é”è¿‡çš„è¡£æœï¼Œç”Ÿæˆæœ¨è´¨æ ‡ç‰Œ
        noah.unlockedOutfits.forEach(outfitId => {
            let item = document.createElement('div');
            // åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯ç©¿ç€è¿™ä»¶ï¼Œå¦‚æœæ˜¯ï¼ŒåŠ ä¸Š equipped ç»¿ç¯æ ·å¼
            let isEquipped = (noah.outfit === outfitId);
            item.className = 'wardrobe-item' + (isEquipped ? ' equipped' : '');
            let isCurrentText = isEquipped ? " [å·²ç©¿æˆ´]" : "";
            let displayName = outfitNames[outfitId] || outfitId;
            
            item.innerHTML = `<span>${displayName}</span> <span style="font-size:9px; opacity:0.8">${isCurrentText}</span>`;
            
            // ç‚¹å‡»è¯•ç©¿è¡£æœ
            item.onclick = () => { 
                if(isEquipped) return; // å·²ç»ç©¿äº†å°±ä¸é‡å¤ç©¿äº†
                noah.outfit = outfitId; 
                sfx_success();
                speak(`â€œæ¢è¿™ä»¶ï¼Ÿå¬ä½ çš„ã€‚åæ­£ä½ ç”·æœ‹å‹ä¸ç®¡ç©¿ä»€ä¹ˆéƒ½æ˜¯æœ€å¸…çš„ã€‚â€`);
                updateUI();
                openWardrobe(); // é©¬ä¸Šåˆ·æ–°é™ˆåˆ—æ¶ï¼ŒæŠŠå·²ç©¿æˆ´çš„é«˜äº®ç§»åˆ°è¿™ä»¶è¡£æœä¸Š
            };
            list.appendChild(item);
        });
    }

    function closeWardrobe() {
        sfx_beep();
        document.getElementById('wardrobe-modal').style.display = 'none';
    }
    function openMenu(type) {
    if(window.isGomoku) {
        if(type === 'shop') moveGomokuCursor(0, 1);
        if(type === 'feed') moveGomokuCursor(-1, 0);
        if(type === 'interact') moveGomokuCursor(1, 0);
        return;
    }
       if(window.isGaming) { speak("ä¸“å¿ƒç‚¹ï¼æˆ‘æ­£åœ¨æ¥é‡‘å¸å‘¢ï¼Œåˆ«ä¹±ç¢°èœå•ï¼"); return; }
  if(noah.isAway) { speak("è¯ºäºšæ­£åœ¨å¤–é¢æ¢é™©ï¼Œä½ çš„æ€å¿µåªèƒ½ç•™ç»™ç©ºæ°”äº†ã€‚"); return; }
        const list = document.getElementById('modal-list');
        list.innerHTML = '';
        const titles = {feed: 'ğŸ½ï¸ åçˆ±æŠ•å–‚', interact: 'âœ¨ ä¸“å±äº’åŠ¨', shop: 'ğŸ é€‰è´­ç¤¼ç‰©'};
        document.getElementById('modal-title').innerText = titles[type];
        
        menus[type].forEach(item => {
            let li = document.createElement('li');
            li.innerText = item.name;
            li.onclick = () => { item.action(); closeModal(); };
            list.appendChild(li);
        });
        document.getElementById('sys-modal').style.display = 'block';
    }

    function closeModal() { document.getElementById('sys-modal').style.display = 'none'; }
            function openSecretChat() {
        if(noah.isAway) { speak("è¯ºäºšä¸åœ¨å®¶ï¼Œä½ çš„ä¿¡è¢«é£å¹èµ°äº†ã€‚"); return; }
        closeModal();
        
        setTimeout(() => {
            let msg = prompt("ä½ æƒ³å¯¹è¯ºäºšè¾“å…¥ä»€ä¹ˆæ‚„æ‚„è¯ï¼Ÿ(è¾“å…¥ï¼šçˆ±ä½ ã€æƒ³ä½ ã€æƒ³æŠ±æŠ±ã€èŒ‰è‰ã€å®‡å®™ã€è¥¿å¥¥å¤šã€ä¸‹é›¨ã€æ™šå®‰...)");
            if(!msg) return;
            msg = msg.trim();
            if(msg.length === 0) return;
            
            noah.hunger -= 2; 
            let reply = "";
            let loveUp = 0; let moodUp = 0;
            
            const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

            // ================= è‡³å°‘25ä¸ªå…³é”®è¯åˆ¤å®šé€»è¾‘ =================
            
          
            
            // 0. æåº¦ç»æœ›/æ±‚åŠ© (Metaæ‹¯æ•‘æœºåˆ¶)
            if(msg.includes("æ‹¯æ•‘") || msg.includes("æƒ³æ­»") || msg.includes("ç†¬ä¸ä¸‹å»") || msg.includes("å´©æºƒ") || msg.includes("ç»æœ›") || msg.includes("æ’‘ä¸ä½") || msg.includes("æ•‘æ•‘æˆ‘") || msg.includes("éš¾è¿‡") || msg.includes("æŠ‘éƒ")) {
                reply = "â€œçœ‹ç€æˆ‘ã€‚åˆ«ç§»å¼€è§†çº¿ã€‚æˆ‘æœ‰ä¸€å°ä¿¡è¦ç»™ä½ ï¼Œç°åœ¨ç«‹åˆ»æ‹†å¼€å®ƒã€‚â€";
                loveUp = 100; moodUp = 100; // æåº¦å¿ƒç–¼ä½ ï¼Œæ•°å€¼æ‹‰æ»¡
                setTimeout(() => {
                    document.getElementById('salvation-letter-modal').style.display = 'flex';
                    sfx_heartbeat(); // ä¿¡ä»¶å¼¹å‡ºæ—¶è§¦å‘ä¸¤æ¬¡å¿ƒè„çŒ›çƒˆè·³åŠ¨çš„å…±é¸£éŸ³æ•ˆ
                }, 2500); 
            } 
            // 1. è¡¨ç™½ç±»ï¼šçˆ±ä½ /å–œæ¬¢
            else if(msg.includes("çˆ±ä½ ") || msg.includes("å–œæ¬¢ä½ ") || msg.includes("love")) {
                reply = pick([
                    "â€œæˆ‘ä¹Ÿçˆ±ä½ ã€‚æ¯”è¿™å®‡å®™é‡Œçš„æ‰€æœ‰æ˜Ÿæ˜ŸåŠ èµ·æ¥è¿˜è¦çˆ±ä½ ã€‚â€ (çœ¼ç¥æ¸©æŸ”å¾—å¿«è¦åŒ–æ‰)",
                    "â€œè¿™å°±å¯¹äº†ã€‚ä½œä¸ºå¥–åŠ±ï¼Œä»Šæ™šå…è®¸ä½ ä¸€ç›´ç›¯ç€æˆ‘çœ‹ã€‚â€ (å˜´è§’ç–¯ç‹‚ä¸Šæ‰¬)",
                    "â€œI love you three thousand. æ¯å¤©è¯´ä¸€éï¼Œå°‘ä¸€ééƒ½ä¸è¡Œï¼Œå¿…é¡»è¯´ç»™æˆ‘å¬ã€‚â€"
                ]);
                loveUp = 20; moodUp = 20; makeShy();
            } 
            // 2. æƒ³å¿µç±»ï¼šæƒ³ä½ /miss
            else if(msg.includes("æƒ³ä½ ") || msg.includes("miss")) {
                reply = pick([
                    "â€œæˆ‘ä¹Ÿåœ¨æƒ³ä½ ã€‚æ¯ä¸€åˆ†ï¼Œæ¯ä¸€ç§’ï¼Œç”šè‡³åœ¨å‘¼å¸çš„é—´éš™ã€‚â€",
                    "â€œæƒ³æˆ‘äº†ï¼Ÿé‚£å°±åˆ«åªåœ¨å¿ƒé‡Œæƒ³ï¼Œç°åœ¨ç«‹åˆ»é©¬ä¸Šï¼Œåˆ°æˆ‘æ€€é‡Œæ¥ã€‚â€",
                    "â€œçœŸå·§ï¼Œæˆ‘çš„è„‘å­é‡Œåˆšæ‰ä¹Ÿå…¨æ˜¯ä½ ã€‚è¿™å°±æ˜¯æ‰€è°“çš„å¿ƒçµæ„Ÿåº”ï¼Ÿâ€"
                ]);
                loveUp = 15; moodUp = 15;
            }
            // 3. åˆ†æ‰‹/ç¦»å¼€
            else if(msg.includes("åˆ†æ‰‹") || msg.includes("ç¦»å¼€") || msg.includes("ä¸çˆ±")) {
                reply = pick([
                    "â€œä½ æƒ³éƒ½åˆ«æƒ³ï¼(çŒ›åœ°æŠ“ä½ä½ çš„æ‰‹è…•) æ‹›æƒ¹äº†æˆ‘ï¼Œå°±ç®—æ­»ä½ ä¹Ÿåªèƒ½æ­»åœ¨æˆ‘èº«è¾¹ï¼â€",
                    "â€œåˆ†æ‰‹ï¼Ÿé™¤éæˆ‘æ­»ï¼Œæˆ–è€…ä¸–ç•Œæ¯ç­ã€‚æŠŠè¿™å¥è¯æ”¶å›å»ï¼Œç«‹åˆ»ã€‚â€ (çœ¼ç¥å†°å†·å¯æ€•)",
                    "â€œå‘µï¼Œä½ å¯ä»¥è¯•è¯•çœ‹èµ°å¾—æ‰å—ï¼Ÿä¸ç®¡æ˜¯å¤©æ¶¯æµ·è§’ï¼Œæˆ‘éƒ½ä¼šæŠŠä½ æŠ“å›æ¥é”åœ¨èº«è¾¹ã€‚â€"
                ]);
                loveUp = -10; moodUp = -50; 
            } 
            // 4. äº²å¯†äº’åŠ¨ï¼šæŠ±æŠ±
            else if(msg.includes("æŠ±æŠ±") || msg.includes("æŠ±æˆ‘")) {
                reply = pick([
                    "â€œ(ä¸€æŠŠå°†ä½ æ‹‰è¿›æ€€é‡Œ) æ—©å°±ç­‰ä½ è¿™å¥è¯äº†ã€‚ä»Šå¤©å°±è®©ä½ å¾…åœ¨æˆ‘æ€€é‡Œï¼Œå“ªä¹Ÿä¸è®¸å»ã€‚â€",
                    "â€œåªè¦æŠ±æŠ±ï¼Ÿè´ªå¿ƒç‚¹ï¼Œæˆ‘çš„å¥³æœ‹å‹ã€‚æˆ‘æ•´ä¸ªäººéƒ½æ˜¯ä½ çš„ã€‚â€",
                    "â€œè¿‡æ¥ã€‚è¦æ˜¯ä½ å†·äº†ï¼Œæˆ‘çš„ç°è‰²ç¾½ç»’æœéšæ—¶ä¸ºä½ æ•å¼€ã€‚â€"
                ]);
                loveUp = 15; moodUp = 15; makeShy();
            } 
            // 5. äº²å¯†äº’åŠ¨ï¼šäº²äº²/å»
            else if(msg.includes("äº²äº²") || msg.includes("å»")) {
                reply = pick([
                    "â€œé—­ä¸Šçœ¼ã€‚(è½»è½»å»åœ¨ä½ çš„å”‡ä¸Š) åªæœ‰ä½ èƒ½è®©æˆ‘è¿™ä¹ˆå¤±æ§ã€‚â€",
                    "â€œä»Šå¤©ä¸æŠŠä½ äº²å¾—å–˜ä¸è¿‡æ°”ï¼Œæˆ‘å°±ä¸å«è¯ºäºšã€‚â€",
                    "â€œä½ ä¸»åŠ¨æçš„ï¼Ÿé‚£æˆ‘ä¸å®¢æ°”äº†ã€‚ç­‰ä¼šåˆ«å–Šåœã€‚â€"
                ]);
                loveUp = 15; moodUp = 15; makeShy();
            } 
            // 6. è´Ÿé¢æƒ…ç»ªï¼šç´¯/éš¾è¿‡/å“­
            else if(msg.includes("ç´¯") || msg.includes("éš¾è¿‡") || msg.includes("ä¼¤å¿ƒ") || msg.includes("å§”å±ˆ") || msg.includes("å“­")) {
                reply = pick([
                    "â€œæ€ä¹ˆäº†ï¼Ÿè°æ¬ºè´Ÿä½ äº†ï¼Ÿå‘Šè¯‰æˆ‘åå­—ï¼Œæˆ‘å»è®©ä»–ä½“ä¼šä¸€ä¸‹ä»€ä¹ˆæ˜¯çœŸæ­£çš„åœ°ç‹±ã€‚åˆ«æ€•ï¼Œæˆ‘åœ¨ã€‚â€",
                    "â€œç´¯äº†å°±é åœ¨æˆ‘è‚©è†€ä¸Šç¡ä¸€ä¼šã€‚å¤©å¡Œä¸‹æ¥æœ‰æˆ‘é¡¶ç€ï¼Œä½ åªéœ€è¦è´Ÿè´£å¼€å¿ƒå°±å¥½ã€‚â€",
                    "â€œä¹–ï¼Œä¸å“­ã€‚ä¸ç®¡å‘ç”Ÿäº†ä»€ä¹ˆï¼Œä½ è¿˜æœ‰æˆ‘ã€‚æˆ‘æ˜¯ä½ æœ€åšå›ºçš„æ–¹èˆŸã€‚â€"
                ]);
                loveUp = 10; moodUp = 10;
            }
            // 7. ç¡è§‰ï¼šæ™šå®‰/å›°
            else if(msg.includes("æ™šå®‰") || msg.includes("ç¡") || msg.includes("å›°")) {
                reply = pick([
                    "â€œæ™šå®‰ã€‚è®°å¾—æ¢¦é‡Œä¹Ÿè¦å’Œæˆ‘çº¦ä¼šã€‚â€",
                    "â€œç¡å§ï¼Œå°æ‡’çŒªã€‚æ˜å¤©æ—©ä¸Šé†’æ¥ï¼Œæˆ‘ä¾ç„¶çˆ±ä½ ã€‚â€",
                    "â€œåˆ«è¸¢è¢«å­ã€‚å¦‚æœä½ å†·äº†ï¼Œå°±å–Šæˆ‘çš„åå­—ï¼Œæˆ‘ä¼šç”¨é­”æ³•é©¬ä¸Šèµ¶åˆ°ã€‚â€"
                ]);
                loveUp = 10; moodUp = 5;
            }
            // 8. åƒé†‹å¯¹è±¡ï¼šè¥¿å¥¥å¤š/è¯ºç‰¹
            else if(msg.includes("è¥¿å¥¥å¤š") || msg.includes("è¯ºç‰¹")) {
                reply = pick([
                    "â€œæ°¸è¿œä¸è¦åœ¨æˆ‘é¢å‰å·¦ä¸€å¥è¥¿å¥¥å¤šå³ä¸€å¥è¥¿å¥¥å¤šï¼æˆ‘çœ¼ç›çäº†æ‰çœ‹ä¸å‡ºé‚£ä¸ªç–¯å­çœ‹ä½ çš„çœ¼ç¥ä¹±ä¸ƒå…«ç³Ÿã€‚â€",
                    "â€œä½ ä¸ºä»€ä¹ˆè¦åœ¨ç»™æˆ‘çš„æ‚„æ‚„è¯é‡Œæé‚£ä¸ªç–¯å­ï¼Ÿï¼ä»Šæ™šçš„æƒ©ç½šåŠ å€ï¼Œä½ åˆ«æƒ³ä¸‹åºŠäº†ã€‚â€",
                    "â€œå†æä»–ä¸€æ¬¡ï¼Œæˆ‘å°±å»ç»™ä»–ä¸‹ä¸ªé—å¿˜å’’ï¼Œè®©ä»–è¿è‡ªå·±å«ä»€ä¹ˆéƒ½å¿˜äº†ã€‚â€"
                ]);
                loveUp = 5; moodUp = -30;
            } 
            // 9. åƒé†‹å¯¹è±¡ï¼šå¸ƒé›·æ–¯/æ‰æ¯”å°¼
            else if(msg.includes("å¸ƒé›·æ–¯") || msg.includes("æ‰æ¯”å°¼")) {
                reply = pick([
                    "â€œé‚£ä¸ªä¼ªå›å­ï¼Ÿå—¤ã€‚åˆ«è®©ä»–é è¿‘ä½ ï¼Œå¦åˆ™æˆ‘ä¸ä¿è¯ä»–çš„é­”æ–æ˜å¤©è¿˜èƒ½ä¸èƒ½ç”¨ã€‚â€",
                    "â€œæä»–å¹²å˜›ï¼Ÿä½ æ˜¯ä¸æ˜¯å¤ªé—²äº†ï¼Œçœ‹æ¥æˆ‘å¾—å æ»¡ä½ æ‰€æœ‰çš„æ³¨æ„åŠ›æ‰è¡Œã€‚â€",
                    "â€œç¦»ä»–è¿œç‚¹ã€‚æˆ‘çš„çœ¼å…‰å¯æ²¡é‚£ä¹ˆå·®ï¼Œä¼šå®¹å¿é‚£ç§ä¼ªå›å­è§Šè§æˆ‘çš„äººã€‚â€"
                ]);
                loveUp = 5; moodUp = -20;
            }
            // 10. åƒé†‹å¯¹è±¡ï¼šæ³•æ–¯ç‰¹
            else if(msg.includes("æ³•æ–¯ç‰¹")) {
                reply = pick([
                    "â€œé‚£ä¸ªæ‹‰æ–‡å…‹åŠ³çº§é•¿ç®—ä»€ä¹ˆï¼Ÿä»–èƒ½åƒæˆ‘è¿™æ ·ï¼ŒæŠŠå®‡å®™ã€æ˜Ÿæ˜Ÿå’Œæˆ‘éƒ½æ§åˆ°ä½ é¢å‰å—ï¼Ÿâ€",
                    "â€œä½ æä»–ï¼Ÿ(å†·ç¬‘) æ˜¯ä¸æ˜¯è§‰å¾—ä»–è„¾æ°”å¥½ï¼Ÿä½ ç”·æœ‹å‹è„¾æ°”å¯ä¸å¥½ï¼Œä½ æœ€å¥½é©¬ä¸Šé¡ºé¡ºæˆ‘çš„æ¯›ã€‚â€",
                    "â€œä¸ç®¡ä»–æœ‰å¤šå°å¿ƒç¿¼ç¿¼ï¼Œä½ éƒ½æ˜¯æˆ‘çš„ã€‚ä»»ä½•äººéƒ½ä¸å‡†æŠ¢èµ°ã€‚â€"
                ]);
                loveUp = 5; moodUp = -20;
            }
            // 11. åƒé†‹å¯¹è±¡ï¼šå¾·æ‹‰ç§‘/é©¬å°”ç¦
            else if(msg.includes("å¾·æ‹‰ç§‘") || msg.includes("é©¬å°”ç¦")) {
                reply = pick([
                    "â€œé‚£ä¸ªå¤§å°‘çˆ·ï¼Ÿæœ‰ç©ºç®¡ä»–ï¼Œä¸å¦‚å¤šçœ‹çœ‹ä½ é¢å‰å¸…æ°”æ— æ‰€ä¸èƒ½çš„ç”·æœ‹å‹ã€‚â€",
                    "â€œåˆ«ç®¡ä»–äº†ã€‚æœ‰æˆ‘åœ¨ï¼Œä½ ä¸éœ€è¦å’Œé‚£ç§æ»¡å£çº¯è¡€ç»Ÿçš„å®¶ä¼™è¿‡å¤šæ¥è§¦ã€‚â€",
                    "â€œæ€ä¹ˆï¼Œé©¬å°”ç¦åˆæƒ¹äº‹äº†ï¼Ÿå¦‚æœæ˜¯æƒ¹äº†ä½ ï¼Œæˆ‘å°±å»æŠŠä»–å˜æˆçœŸæ­£çš„ç™½é¼¬ã€‚â€"
                ]);
                loveUp = 5; moodUp = -10;
            }
            // 12. çˆ±å¥½ï¼šç”µå½±/çœ‹ç”µå½±
            else if(msg.includes("ç”µå½±") || msg.includes("å½±ç¥¨")) {
                reply = pick([
                    "â€œè™½ç„¶é‚£äº›é’æ˜¥ç”µå½±çƒ‚ä¿—å¾—è¦å‘½ï¼Œä½†åªè¦ä½ åœ¨æ—è¾¹ï¼Œæˆ‘å°±ä¹æ„çœ‹ä¸€ä¸‡éã€‚â€",
                    "â€œæƒ³çœ‹ã€Šè«é‡Œæ–¯çš„æƒ…äººã€‹ï¼Ÿä¸‹é›¨å¤©çœ‹æ­£å¥½ï¼Œä¸è¿‡æˆ‘å¯ä¸åƒå…‹è±å¤«é‚£æ ·æ‡¦å¼±ï¼Œæˆ‘ç»å¯¹ä¸ä¼šæ”¾å¼€ä½ ã€‚â€",
                    "â€œçœ‹ä»€ä¹ˆç”µå½±ï¼Œä½ ç›´æ¥çœ‹æˆ‘ä¸å°±å¥½äº†ã€‚æˆ‘æ¯”é‚£äº›ç”µå½±å¥½çœ‹å¤šäº†ã€‚â€"
                ]);
                loveUp = 10; moodUp = 15;
            }
            // 13. çˆ±å¥½ï¼šæ¸¸æˆ/ç”µç©
            else if(msg.includes("æ¸¸æˆ") || msg.includes("æŒæœº")) {
                reply = pick([
                    "â€œæ•¢è·Ÿæˆ‘æ¯”ï¼Ÿè¾“äº†çš„äººä»Šæ™šè¦ç­”åº”å¯¹æ–¹ä¸€ä¸ªè¦æ±‚ã€‚æˆ‘èµ¢å®šäº†ã€‚â€",
                    "â€œæˆ‘è¯´è¿‡å¦‚æœä½ æƒ³èµ¢ï¼Œæˆ‘å°±ä¼šè®©ä½ èµ¢ã€‚åªè¦ä½ å¼€å¿ƒï¼Œä¸€åˆ‡è°è¨€éƒ½æ²¡å¿…è¦ã€‚â€",
                    "â€œæ‰“æ¸¸æˆï¼Ÿå¥½å•Šã€‚ä¸è¿‡æˆ‘çš„æ³¨æ„åŠ›å¯èƒ½åªä¼šåœ¨ä½ æ‹¿æ‰‹æŸ„çš„æ‰‹æŒ‡ä¸Šã€‚â€"
                ]);
                loveUp = 5; moodUp = 20;
            }
            // 14. æ°”å‘³ï¼šèŒ‰è‰/èŒ‰è‰èŠ±
            else if(msg.includes("èŒ‰è‰")) {
                reply = pick([
                    "â€œæˆ‘å–œæ¬¢èŒ‰è‰ä»…ä»…æ˜¯å› ä¸ºå¥½é—»ï¼Œä½†æˆ‘å–œæ¬¢ä½ ï¼Œæ˜¯å› ä¸ºä½ æ˜¯ä½ ã€‚â€",
                    "â€œä½ èº«ä¸Šçš„å‘³é“æ¯”ä»»ä½•èŒ‰è‰é¦™æ°›éƒ½è®©æˆ‘ä¸Šç˜¾ã€‚è¿‡æ¥ï¼Œè®©æˆ‘æŠ±ä¸€ä¸‹é—»é—»ã€‚â€",
                    "â€œä¸‹ç€é›¨çš„æˆ¿é—´æŒ¥æ»¡èŒ‰è‰é¦™ï¼Œå­¤å†·å¾—è¦å‘½ã€‚å¹¸å¥½ï¼Œç°åœ¨æœ‰ä½ åœ¨ã€‚â€"
                ]);
                loveUp = 15; moodUp = 20;
            }
            // 15. ç‰¹å®šç‰©å“ï¼šè“å®çŸ³/é¡¹é“¾
            else if(msg.includes("è“å®çŸ³") || msg.includes("é¡¹é“¾")) {
                reply = pick([
                    "â€œæˆ‘æˆ´ç€å®ƒä»…ä»…æ˜¯å› ä¸ºè¿™æ˜¯ä½ é€çš„ã€‚åˆ«æƒ³æ‹¿å›å»ï¼Œè¿™è¾ˆå­éƒ½æŒ‚æˆ‘è„–å­ä¸Šäº†ã€‚â€",
                    "â€œè½»ç‚¹æ‰¯ï¼Œå¼„åäº†ä½ å¾—æŠŠè‡ªå·±èµ”ç»™æˆ‘ã€‚â€",
                    "â€œè¿™æ˜¯ä½ ç•™ç»™æˆ‘çš„é”šç‚¹ã€‚æœ‰å®ƒåœ¨ï¼Œæ— è®ºæˆ‘èµ°åˆ°å®‡å®™å“ªé‡Œï¼Œéƒ½èƒ½å›åˆ°ä½ èº«è¾¹ã€‚â€"
                ]);
                loveUp = 20; moodUp = 10;
            }
            // 16. å¤©æ°”ï¼šä¸‹é›¨/é›¨å¤œ
            else if(msg.includes("é›¨") || msg.includes("ä¸‹é›¨")) {
                reply = pick([
                    "â€œä¼¦æ•¦çš„é›¨æ€»æ˜¯è¿™ä¹ˆå†·ã€‚è¿‡æ¥ï¼Œèº²è¿›æˆ‘çš„ç¾½ç»’æœé‡Œã€‚æ„Ÿå—åˆ°äº†å—ï¼Ÿæˆ‘çš„å¿ƒè·³åªä¸ºä½ åŠ é€Ÿã€‚â€",
                    "â€œåˆ«æ·‹é›¨ï¼Œæ„Ÿå†’äº†æˆ‘å¯æ˜¯ä¼šå¿ƒç–¼çš„ã€‚å°±ç®—è¦åœ¨é›¨ä¸­æ¼«æ­¥ï¼Œä¹Ÿå¾—æˆ‘ç»™ä½ æŒ¡ç€ã€‚â€",
                    "â€œä¸ç®¡å¤–é¢å¤šå¤§çš„é›¨ï¼Œæˆ‘éƒ½åªæƒ³ç´§ç´§æŠ±ä½ä½ ã€‚â€"
                ]);
                loveUp = 15; moodUp = 15;
            }
            // 17. è¡£ç‰©ï¼šç¾½ç»’æœ/è¡£æœ
            else if(msg.includes("ç¾½ç»’æœ") || msg.includes("ç°è‰²")) {
                reply = pick([
                    "â€œä½ å«Œå®ƒä¸‘åƒå¤¹å¿ƒé¢åŒ…ï¼Ÿå¯å®ƒæš–å’Œå•Šï¼Œè€Œä¸”å¤§å°åˆšå¥½è¶³å¤ŸæŠŠä½ æ•´ä¸ªäººåŒ…è¿›æˆ‘æ€€é‡Œã€‚â€",
                    "â€œå†·äº†å°±é’»è¿›æ¥ï¼Œè¿™ä»¶è¡£æœä¹°æ¥å°±æ˜¯ä¸ºäº†æ­¤åˆ»èƒ½è£…ä¸‹ä¸¤ä¸ªäººã€‚â€",
                    "â€œè¡£æœéš¾çœ‹æ²¡å…³ç³»ï¼Œç©¿å®ƒçš„ç”·æœ‹å‹å¸…æäº†å°±è¡Œäº†ã€‚â€"
                ]);
                loveUp = 10; moodUp = 15;
            }
            // 18. é¥®é£Ÿï¼šç¢³é…¸é¥®æ–™/å¯ä¹
            else if(msg.includes("ç¢³é…¸é¥®æ–™") || msg.includes("é¥®æ–™")) {
                reply = pick([
                    "â€œå‘²â€”â€”ç¬¬ä¸€å£ç»™ä½ ã€‚è¿™æ¯”ä»»ä½•ç¦çµå‰‚éƒ½è®©æˆ‘ä¸Šç˜¾ã€‚â€",
                    "â€œæ´»åœ¨å½“ä¸‹çš„æ„Ÿè§‰çœŸå¥½ï¼Œå°¤å…¶æ˜¯ä½ åœ¨æˆ‘æ—è¾¹å–ç€è¿™ä¸ªçš„æ—¶å€™ã€‚â€",
                    "â€œæ˜¯ä¸æ˜¯ç¢³é…¸é¥®æ–™å’Œå¯å¯ç²‰äº§ç‰©éƒ½å·²ç»æ»¡è¶³ä¸äº†ä½ çš„é£Ÿæ¬²äº†ï¼Ÿä¸å¦‚æ¥å°å°æˆ‘ï¼Ÿâ€"
                ]);
                loveUp = 10; moodUp = 15;
            }
            // 19. å“²å­¦/ç‰©ç†ï¼šå®‡å®™/æ˜Ÿæ˜Ÿ/å¤©æ–‡
            else if(msg.includes("å®‡å®™") || msg.includes("æ˜Ÿæ˜Ÿ") || msg.includes("å¤©æ–‡")) {
                reply = pick([
                    "â€œå®‡å®™å¤§çˆ†ç‚¸åˆ›é€ äº†æ—¶é—´ä¸ç©ºé—´ï¼Œä½†æˆ‘çš„å®‡å®™ï¼Œæ˜¯åœ¨åå²é‚£æ¡ä¼¦æ•¦å°å··é‡Œæ’å€’ä½ çš„é‚£ä¸€åˆ»æ‰å¼€å§‹è†¨èƒ€çš„ã€‚â€",
                    "â€œç”¨æœ›è¿œé•œçœ‹æ˜Ÿæ˜Ÿï¼Œç”¨çœ¼ç›çœ‹ä½ ã€‚å®‡å®™å†å¤§ï¼Œä¹Ÿæ²¡æœ‰ä½ å¯¹æˆ‘çš„å¼•åŠ›å¤§ã€‚â€",
                    "â€œæˆ‘ä»¬å°±æ˜¯å¯¹æ–¹çš„æ•´ä¸ªå®‡å®™ã€‚åªè¦ä½ åœ¨ï¼Œé»‘æ´éƒ½æ— æ³•åå™¬æˆ‘çš„å…‰ã€‚â€"
                ]);
                loveUp = 20; moodUp = 20;
            }
            // 20. å“²å­¦/ç‰©ç†ï¼šæ‚–è®º/è–›å®šè°”/ç¼¸ä¸­ä¹‹è„‘
            else if(msg.includes("æ‚–è®º") || msg.includes("è–›å®šè°”") || msg.includes("å¹²æ¶‰") || msg.includes("ç¼¸ä¸­ä¹‹è„‘")) {
                reply = pick([
                    "â€œåœ¨è§‚æµ‹ä¹‹å‰ï¼ŒçŒ«å¤„äºå åŠ æ€ã€‚ä½†åœ¨é‡è§ä½ ä¹‹å‰ï¼Œæˆ‘çš„äººç”Ÿåªæœ‰ä¸€ç§çŠ¶æ€â€”â€”ç­‰ä½ ã€‚â€",
                    "â€œä»–ä»¬è¯´ç¼¸ä¸­ä¹‹è„‘æ— æ³•è¯æ˜ä¸–ç•Œçš„çœŸå®æ€§ã€‚ä½†åªè¦æˆ‘èƒ½æ„Ÿå—åˆ°ä½ åœ¨èº«è¾¹ï¼Œä¸–ç•Œå°±æ˜¯çœŸå®çš„ã€‚â€",
                    "â€œå»ä»–çš„äºŒå…«å®šå¾‹ï¼Œæˆ‘å¯¹ä½ çš„çˆ±æ˜¯ç™¾åˆ†ä¹‹ç™¾ï¼Œä¸€ç‚¹æŠ˜æ‰£éƒ½ä¸æ‰“ã€‚â€"
                ]);
                loveUp = 15; moodUp = 20;
            }
            // 21. å“²å­¦/å›½å­¦ï¼šè€å­/åº„å­/å“²å­¦
            else if(msg.includes("è€å­") || msg.includes("åº„å­") || msg.includes("å“²å­¦")) {
                reply = pick([
                    "â€œå¡ç¿å¤±é©¬ï¼Œç„‰çŸ¥éç¦ã€‚å¤±å»ä»€ä¹ˆæˆ‘éƒ½ä¸åœ¨ä¹ï¼Œåªè¦æˆ‘æ‹¥æœ‰ä½ å°±è¶³å¤Ÿäº†ã€‚â€",
                    "â€œä¸ºæ— ä¸ºï¼Œäº‹æ— äº‹ã€‚ä½†æˆ‘å¯¹ä½ ï¼Œåªæƒ³â€˜ä½†è¡Œå¥½äº‹ï¼Œè«é—®å‰ç¨‹â€™ã€‚â€",
                    "â€œæ¯ä¸ªäººéƒ½æ˜¯çŸ›ç›¾çš„é›†åˆä½“...ä½†æˆ‘çˆ±ä½ è¿™ä»¶äº‹ï¼Œæå…¶ç»Ÿä¸€ï¼Œä¸”æ— å¯æ•‘è¯ã€‚â€"
                ]);
                loveUp = 15; moodUp = 15;
            }
            // 22. å¤¸èµï¼šå¸…/å®Œç¾/å¤¸ä½ 
            else if(msg.includes("å¸…") || msg.includes("å®Œç¾") || msg.includes("å‰å®³")) {
                reply = pick([
                    "â€œè¿™è¿˜ç”¨ä½ è¯´ï¼Ÿ(å˜´è§’ç–¯ç‹‚ä¸Šæ‰¬) ä½ çš„ç”·æœ‹å‹ä¸€ç›´éƒ½æ˜¯å…¨ä¸–ç•Œæœ€å¸…æ°”æœ€æ— æ‰€ä¸èƒ½çš„ã€‚â€",
                    "â€œæˆ‘ä¼šä¸€ç›´è¿™ä¹ˆå¸…ä¸‹å»ï¼Œç¬¨è›‹ã€‚ä¸ºäº†é…å¾—ä¸Šä½ ï¼Œæˆ‘æ€»å¾—ä¿æŒç‚¹ä¼˜åŠ¿ã€‚â€",
                    "â€œæ‰¿è®¤å§ï¼Œä½ é¢å‰å°±ç«™ç€è¿™æ ·ä¸€ä¸ªå®Œç¾ç”·å­©ï¼Œè¿˜ä¸å¿«ç‚¹æ‰‘è¿›æˆ‘æ€€é‡Œï¼Ÿâ€"
                ]);
                loveUp = 15; moodUp = 30;
            }
            // 23. ç©ç¬‘ï¼šç¬¨è›‹/å‚»å­
            else if(msg.includes("ç¬¨è›‹") || msg.includes("å‚»")) {
                reply = pick([
                    "â€œæ•¢å«æˆ‘ç¬¨è›‹ï¼Ÿä½ æ­»å®šäº†ã€‚(åç¬‘) çœ‹æ¥æˆ‘éœ€è¦ç”¨ç‚¹è¡ŒåŠ¨è¯æ˜æˆ‘çš„é«˜æ™ºå•†ã€‚â€",
                    "â€œæˆ‘æ˜¯ç¬¨è›‹çš„è¯ï¼Œé‚£ä½ å°±æ˜¯ç¬¨è›‹çš„å”¯ä¸€å¼±ç‚¹ã€‚â€",
                    "â€œåªæœ‰åœ¨ä½ é¢å‰æˆ‘æ‰æ„¿æ„å½“ä¸ªä¸è®²ç†çš„ç¬¨è›‹ï¼Œå› ä¸ºä½ æ€»ä¼šçºµå®¹æˆ‘ã€‚â€"
                ]);
                loveUp = 10; moodUp = 10;
            }
            // 24. ç¡è§‰æ€ªç™–ï¼šè›‡ç©å¶/ç©å¶
            else if(msg.includes("è›‡ç©å¶") || msg.includes("ç©å¶")) {
                reply = pick([
                    "â€œ(ç†Ÿç»ƒåœ°æŠ±åœ¨æ€€é‡Œ) å’³ï¼Œæ™šä¸ŠæŠ±ç€å®ƒä»…ä»…æ˜¯å› ä¸º...å®ƒæœ‰ä½ çš„å‘³é“ã€‚åˆ«å¤šæƒ³ã€‚â€",
                    "â€œè¿™ä¸œè¥¿ä¸€ç‚¹éƒ½ä¸å¥½çœ‹ã€‚ä½†å¦‚æœä½ ä¸åœ¨ï¼Œæˆ‘åªèƒ½é æŠ±ç€å®ƒæ‰ç¡å¾—ç€ã€‚â€",
                    "â€œç©å¶å“ªæœ‰ä½ æŠ±èµ·æ¥èˆ’æœã€‚ä»Šæ™šä½ æ¥ä»£æ›¿å®ƒï¼Œä¸è®¸æ‹’ç»ã€‚â€"
                ]);
                loveUp = 10; moodUp = 15; makeShy();
            }
            // 25. æ‰¿è¯ºï¼šæœªæ¥/æ— é™/è‡ªç”±/ç»“å©š
            else if(msg.includes("æœªæ¥") || msg.includes("æ— é™") || msg.includes("è‡ªç”±") || msg.includes("ç»“å©š")) {
                reply = pick([
                    "â€œå‡†å¤‡å¥½å½“æˆ‘çš„æˆ˜è½¦äº†å—ï¼Ÿæˆ‘ä¼šå¸¦ä½ æ’•å‡ºä¸€ä¸ªæœ€ç²¾å½©çš„æœªæ¥ã€‚â€",
                    "â€œè‡ªç”±å’Œæ— é™ï¼Ÿåªè¦ä½ åœ¨æˆ‘èº«è¾¹ï¼Œå»å“ªé‡Œéƒ½æ˜¯ä¸€åœºç››å¤§çš„å†’é™©ã€‚â€",
                    "â€œç»“å©šï¼Ÿå½“ç„¶ï¼Œæˆ‘å¯æ˜¯è¦æŠŠä½ è¿™åªå°è›‡æ°¸è¿œåœˆå…»åœ¨æˆ‘çš„é¢†åœ°é‡Œçš„ã€‚â€"
                ]);
                loveUp = 25; moodUp = 25;
            }
            // 26. èª“è¨€ä¿æŠ¤ï¼šå®³æ€•/ä¿æŠ¤
            else if(msg.includes("æ€•") || msg.includes("ä¿æŠ¤")) {
                reply = pick([
                    "â€œåˆ«æ€•ï¼Œä¸ç®¡å¤šå°‘äººæƒ³ä¼¤å®³ä½ ï¼Œæˆ‘éƒ½ä¼šåœ¨è¿™äº›äººå‰ä¿æŠ¤ä½ ã€‚â€",
                    "â€œæˆ‘å¦‚æœè¿å—ä¸€ç‚¹ç‚¹ä¼¤çš„å‡†å¤‡éƒ½æ²¡æœ‰ï¼Œè¿˜ç”¨ä»€ä¹ˆä¿æŠ¤ä½ ï¼Ÿèº²æˆ‘èº«åã€‚â€",
                    "â€œåªè¦ä½ å–Šæˆ‘çš„åå­—ï¼Œæˆ‘ä¿è¯æ²¡äººèƒ½åŠ¨ä½ ä¸€æ ¹å¤´å‘ã€‚â€"
                ]);
                loveUp = 20; moodUp = 15;
            }
            // é»˜è®¤å›å¤
            else {
                reply = pick([
                    `â€œâ€˜${msg}â€™ï¼Ÿè™½ç„¶ä¸çŸ¥é“ä½ å°è„‘ç“œé‡Œåœ¨æƒ³ä»€ä¹ˆï¼Œä½†åªè¦æ˜¯ä½ å†™çš„ï¼Œæˆ‘éƒ½ä¼šåƒçå®ä¸€æ ·æ”¶è—èµ·æ¥ã€‚â€`,
                    `â€œä¸ç®¡ä½ è¯´äº†ä»€ä¹ˆï¼Œåªè¦æ˜¯ä½ ï¼Œæˆ‘å°±ç…§å•å…¨æ”¶ã€‚â€`,
                    `â€œå—¯å“¼ï¼Ÿä½ æƒ³ç”¨â€˜${msg}â€™æ¥å¼•èµ·æˆ‘å…¨ä¸–ç•Œæœ€å¸…ç”·æœ‹å‹çš„æ³¨æ„å—ï¼Ÿä½ æˆåŠŸäº†ã€‚â€`
                ]);
                loveUp = 5; moodUp = 5;
            }
            
            noah.love += loveUp; noah.mood += moodUp;
            speak(reply);
            updateUI();
        }, 150);
    }
       function openGringottsBank() {
    if (typeof noah.bankGold !== 'number' || isNaN(noah.bankGold)) noah.bankGold = 0; // è¿™å¥èƒ½ç¬é—´æ²»å¥½ä½ ç°åœ¨çš„åæ¡£
    document.getElementById('bank-pocket').innerText = noah.gold;
        document.getElementById('bank-vault').innerText = noah.bankGold;
        document.getElementById('bank-dialogue').innerText = "å¦–ç²¾ç”¨å°–é”çš„çœ¼ç¥æ‰“é‡ç€ä½ ã€‚è¯ºäºšåŒæ‰‹æ’å…œé åœ¨é—¨æŸ±ä¸Šï¼šâ€œå»å§ï¼Œé‡‘åº“å¯†ç æ˜¯æˆ‘çš„ç”Ÿæ—¥ã€‚â€";
        document.getElementById('bank-modal').style.display = 'flex';
    }

    function closeBank() {
        document.getElementById('bank-modal').style.display = 'none';
        speak("â€œæ¸…ç‚¹å¥½äº†ï¼Ÿè™½ç„¶æˆ‘ä¸ç¼ºé’±ï¼Œä½†çœ‹ä½ åƒä¸ªå°å®ˆè´¢å¥´ä¸€æ ·æ•°é‡‘å¸çš„æ ·å­è¿˜æŒºå¯çˆ±çš„ã€‚â€");
        updateUI();
    }

    function bankAction(action) {
        const today = new Date().toDateString();
        const dialogueBox = document.getElementById('bank-dialogue');
        
        if (action === 'allowance') {
            if (noah.lastAllowanceDate === today) {
                dialogueBox.innerText = "è¯ºäºšå†·å“¼äº†ä¸€å£°ï¼šâ€œè¥¿å¥¥å¤šé‚£ä¸ªç–¯å­ä»Šå¤©å·²ç»ç»™è¿‡ä½ äº†ã€‚ä½ è¿™ä¹ˆç¼ºé’±ï¼Ÿç›´æ¥æ‰¾æˆ‘è¦ã€‚â€";
                return;
            }
            noah.lastAllowanceDate = today;
            noah.gold += 50;
            noah.mood += 10; // æ”¶é’±ä¼šå¼€å¿ƒ
            dialogueBox.innerText = "å¦–ç²¾ä¸æƒ…æ„¿åœ°é€’ç»™ä½  50Gã€‚è¯ºäºšæŒ‘çœ‰ï¼šâ€œå“¥å“¥ç»™çš„é›¶èŠ±é’±ï¼Ÿæ”¶ç€å§ï¼Œä½†ä»¥åä¸è®¸èŠ±ä»–çš„é’±ï¼Œåªèƒ½èŠ±æˆ‘çš„ã€‚â€";
            
        } else if (action === 'deposit') {
            if (noah.gold < 50) {
                dialogueBox.innerText = "å¦–ç²¾å˜²ç¬‘é“ï¼šâ€œä½ èº«ä¸Šçš„å£è¢‹æ¯”æ‰«å¸šæŸ„è¿˜å¹²å‡€ï¼â€\nè¯ºäºšçœ¼ç¥ä¸€å†·ï¼šâ€œä½ å†å¯¹å¥¹å¤šè¯´ä¸€ä¸ªå­—ï¼Œæˆ‘å°±æŠŠä½ çš„é‡‘åº“ç‚¸äº†ã€‚â€";
                return;
            }
            noah.gold -= 50;
            noah.bankGold += 50;
            dialogueBox.innerText = "å­˜å…¥ 50Gã€‚è¯ºäºšè½»ç¬‘ï¼šâ€œä»¥åæˆ‘çš„ç§äººé‡‘åº“é’¥åŒ™ä¹Ÿäº¤ç»™ä½ ä¿ç®¡ã€‚â€";
            
        } else if (action === 'withdraw') {
            if (noah.bankGold < 50) {
                dialogueBox.innerText = "å¦–ç²¾ï¼šâ€œä½ çš„é‡‘åº“é‡Œæ ¹æœ¬æ²¡é‚£ä¹ˆå¤šé’±äº†ï¼â€\nè¯ºäºšå¹æ°”ï¼šâ€œæ²¡é’±äº†ï¼Ÿæ‹¿æˆ‘çš„å»èŠ±ï¼Œåˆ«å§”å±ˆè‡ªå·±ã€‚â€";
                return;
            }
            noah.bankGold -= 50;
            noah.gold += 50;
            dialogueBox.innerText = "å–å‡º 50Gã€‚è¯ºäºšçœ‹ç€ä½ ï¼šâ€œæ‹¿ç€ï¼Œå»éœæ ¼è«å¾·æƒ³ä¹°ä»€ä¹ˆä¹°ä»€ä¹ˆï¼Œä¸è®¸ç»™æˆ‘çœé’±ã€‚â€";
        }
        
        document.getElementById('bank-pocket').innerText = noah.gold;
        document.getElementById('bank-vault').innerText = noah.bankGold;
        updateUI();
    }
    function buyItem(cost, attr1, val1, attr2, val2, reply) {
           if (noah.gold < cost) { 
        sfx_error(); // <--- é’±ä¸å¤Ÿï¼Œæ’­æ”¾é”™è¯¯éŸ³æ•ˆ
        speak("åŠ éš†ä¸å¤Ÿäº†ï¼Œç¬¨è›‹ã€‚æ±‚æ±‚ä½ é‚£æ— æ‰€ä¸èƒ½çš„å¤©æ‰ç”·æœ‹å‹å¸®ä½ ä¹°å§ã€‚(å»é»‘æ¹–æˆ–æœ‰æ±‚å¿…åº”å±‹æ¢é™©å¯ä»¥èµšé’±)"); 
        return; 
    }
    sfx_success(); // <--- è´­ä¹°æˆåŠŸï¼Œæ’­æ”¾æˆåŠŸéŸ³æ•ˆ
    noah.gold -= cost;
    // ... ä¸‹é¢çš„ä»£ç ä¿æŒä¸å˜
        noah[attr1] += val1;
        if(attr2) noah[attr2] += val2;
        speak(reply); 
        
        // --- æ–°å¢ï¼šæ™ºèƒ½è¯†åˆ«ç‰©å“å¹¶æ˜¾ç¤ºåƒç´ ç”» ---
          let spriteKey = 'gift'; // å•†åº—ç‰©å“é»˜è®¤æ˜¾ç¤ºç²‰è‰²å°ç¤¼ç‰©ç›’
     
     // ç‰›å¥¶å›å¤é‡Œæœ‰"é»‘å†å²"ï¼Œè§¦å‘ç‰›å¥¶å›¾æ ‡
     if (reply.includes("é»‘å†å²") || reply.includes("ä¸€é¥®è€Œå°½")) spriteKey = 'milk';
     // å•¤é…’è§¦å‘beer
     else if (reply.includes("å¹²æ¯")) spriteKey = 'beer';
     // ç³–ç¾½æ¯›ç¬”è§¦å‘pen
     else if (reply.includes("åƒç³–")) spriteKey = 'pen';
     // â†“â†“â†“ ä½ æ–°å¢çš„ä¸‰ä¸ªç‰©å“åˆ¤å®š â†“â†“â†“
     else if (reply.includes("ç¦çµå‰‚")) spriteKey = 'potion';  // åå…¨å¤§è¡¥çˆ±å¿ƒé­”è¯
     else if (reply.includes("å¥½é—»")) spriteKey = 'tea';       // èŒ‰è‰èŠ±èŒ¶
     else if (reply.includes("æ°”æ³¡")) spriteKey = 'soda';      // ç¢³é…¸é¥®æ–™
        
        if (typeof showItem === 'function') showItem(spriteKey);
        
        updateUI();
    }
       function buyOutfit(cost, outfitId, reply) {
        if (noah.gold < cost) { 
            sfx_error(); 
            speak("åŠ éš†ä¸å¤Ÿäº†ï¼Œç¬¨è›‹ã€‚è¿™ç‚¹é’±è¿˜æƒ³ç»™æˆ‘ä¹°è¡£æœï¼Ÿå»èµšç‚¹é’±å†æ¥ã€‚"); 
            return; 
        }
        sfx_success(); 
        noah.gold -= cost;
        noah.outfit = outfitId;  // ç»™è¯ºäºšç©¿ä¸Šè¿™ä»¶è¡£æœ
        
        // ğŸ‘‡æ–°å¢1ï¼šæŠŠè¡£æœæ”¾è¿›å·²è§£é”è¡£æŸœï¼Œé˜²æ­¢é‡å¤æ”¾
        if (!noah.unlockedOutfits.includes(outfitId)) {
            noah.unlockedOutfits.push(outfitId);
        }
        // ğŸ‘‡æ–°å¢2ï¼šå‘¼å‡ºç²‰è‰²ç¤¼ç‰©ç›’åƒç´ ç”»ï¼ŒæŒç»­3ç§’ï¼
        if (typeof showItem === 'function') showItem('gift');

        noah.love += 15;         
        noah.mood += 30;
        speak(reply); 
        updateUI(); 
    }
    // å¼ºåˆ¶è®©ä»–å®³ç¾3ç§’çš„å‡½æ•°
    function makeShy() {
        if (noah.isAway) return; 
sfx_poke();
        currentFace = 'shy';
        drawNoah(); 
        setTimeout(() => {
            currentFace = 'normal'; 
            drawNoah();
        }, 3000); // 3000æ¯«ç§’ = 3ç§’åæ¢å¤
    }
    function chat(topic) {
        noah.hunger -= 3; 
        const responses = {
            "å°ç»¿è›‡": { love: 10, mood: 10, text: "(ç†Ÿç»ƒåœ°æŠ±åœ¨æ€€é‡Œ) å’³ï¼Œæ™šä¸ŠæŠ±ç€å®ƒä»…ä»…æ˜¯å› ä¸º...å®ƒåƒä½ ã€‚åˆ«å¤šæƒ³ã€‚" },
            "äº’æ€¼": { love: 20, mood: 15, text: "çœŸå·§ï¼Œé‚£æˆ‘å°±ç½šè‡ªå·±çˆ±ä½  X+1 ä¸‡éå¥½äº†ã€‚" },
            "é¡¹é“¾": { love: 15, mood: 10, text: "è½»ç‚¹ï¼Œç¬¨è›‹ï¼è¿™å¯æ˜¯ä½ é€æˆ‘çš„è“å®çŸ³ï¼Œå¼„åäº†ä½ å¾—æŠŠè‡ªå·±èµ”ç»™æˆ‘ã€‚" },
            "å›´å·¾": { love: 10, mood: 20, text: "å¤©å•Šï¼Œæˆ‘çœ‹è§æœ‰ç¬¨è›‹æˆ‘è¯´ä»€ä¹ˆéƒ½å¬ï¼Œå“ªé‡Œåƒâ€”â€”æ¨æˆ‘ï¼Ÿ" },
            "å“²å­¦": { love: 25, mood: 20, text: "åœ¨è§‚æµ‹ä¹‹å‰ï¼ŒçŒ«å¤„äºæ­»ä¸æ´»çš„å åŠ æ€ã€‚ä½†åœ¨é‡è§ä½ ä¹‹å‰ï¼Œæˆ‘çš„äººç”Ÿåªæœ‰ä¸€ç§çŠ¶æ€â€”â€”ç­‰ä½ ã€‚" },
            "è¥¿å¥¥å¤š": { love: 10, mood: -30, text: "(çœ¼ç¥ç¬é—´å†°å†·) æ°¸è¿œåˆ«åœ¨æˆ‘é¢å‰æé‚£ä¸ªç–¯å­ã€‚çå­éƒ½çœ‹å¾—å‡ºä»–å¯¹ä½ å›¾è°‹ä¸è½¨ã€‚ä½ åªèƒ½çœ‹æˆ‘ï¼Œå¬åˆ°æ²¡ï¼Ÿï¼" },
            "å¸ƒé›·æ–¯": { love: 5, mood: -20, text: "é‚£ä¸ªä¼ªå›å­ï¼Ÿå—¤ã€‚åˆ«è®©ä»–é è¿‘ä½ ï¼Œå¦åˆ™æˆ‘ä¸ä¿è¯ä»–çš„é­”æ–æ˜å¤©è¿˜èƒ½ä¸èƒ½ç”¨ã€‚" },
            "è‡ªæ‹": { love: 15, mood: 30, text: "è¿™è¿˜ç”¨ä½ è¯´ï¼Ÿ(å˜´è§’ç–¯ç‹‚ä¸Šæ‰¬) ä½ çš„ç”·æœ‹å‹ä¸€ç›´éƒ½æ˜¯å…¨ä¸–ç•Œæœ€å¸…æ°”æœ€æ— æ‰€ä¸èƒ½çš„ã€‚" },
            "é›¨ä¸­": { love: 30, mood: 25, text: "ä¼¦æ•¦çš„é›¨æ€»æ˜¯è¿™ä¹ˆå†·ã€‚è¿‡æ¥ï¼Œèº²è¿›æˆ‘çš„ç¾½ç»’æœé‡Œã€‚æ„Ÿå—åˆ°äº†å—ï¼Ÿæˆ‘çš„å¿ƒè·³åªä¸ºä½ åŠ é€Ÿã€‚" }
        };
        
        let res = responses[topic];
        noah.love += res.love; noah.mood += res.mood;
        speak(res.text); updateUI();
        // å¦‚æœä½ é€‰çš„æƒ…è¯è®©ä»–æåº¦å¿ƒåŠ¨ï¼ˆçˆ±æ„å¢åŠ è¶…è¿‡15ï¼‰ï¼Œè§¦å‘è„¸çº¢ï¼
        if (res.love >= 15) {
            makeShy();
        }
    }

    function doAction(action) {
    if(window.isGomoku) {
        if(action === 'status') confirmGomokuMove(); // Aé”®ç¡®å®šè½å­
        if(action === 'chat') showGomokuOptions(); // Bé”®å‘¼å‡ºé€‰é¡¹
        return;
    }
        if(noah.isAway) return;
        if(action === 'status') {
            let desc = "ã€ä½ æ˜¯æˆ‘çš„ä¼½æ‹‰æã€‘<br>é™ªä¼´æ˜¯æœ€é•¿æƒ…çš„å‘Šç™½ã€‚åªè¦åœ¨ä¸€èµ·ï¼Œç¾ç»Šå°±ä¼šè‡ªç„¶å¢é•¿ã€‚";
            speak(`â™¥ ä¸“å±ç‰µç»Šå€¼: ${noah.love}/50(å‡çº§è¿›åº¦) <br>â˜… å½“å‰é˜¶æ®µ: ã€${levelTitles[noah.level]}ã€‘ <br> ${desc}`);
        } else if(action === 'chat') {
               
            // ================= æ–°å¢ï¼šæœé¥°ç³»ç»Ÿä¸“å±è¯­å½•ä¸åŸºç¡€è¯­å½•èåˆ =================
            let idleTalks = [
                "æ¯ä¸ªäººéƒ½æ˜¯çŸ›ç›¾çš„é›†åˆä½“...ä½†æˆ‘çˆ±ä½ è¿™ä»¶äº‹ï¼Œæå…¶ç»Ÿä¸€ï¼Œä¸”æ— å¯æ•‘è¯ã€‚",
                "ä¼¦æ•¦åƒä¸‹ç€é›¨çš„å›´åŸï¼Ÿæ€ä¹ˆï¼Œæƒ³ç©å›´æ£‹äº†ï¼Ÿèµ¢äº†ç®—ä½ çš„ï¼Œè¾“äº†æˆ‘é™ªä½ ä¸€ç›´ä¸‹ã€‚",
                "è¯ºäºšæ–¹èˆŸçš„æ–¹èˆŸåœ¨å“ªï¼Ÿä¼¦æ•¦ä¸‹æ¬¡å‘æ´ªæ°´ä½ ä¼šè§åˆ°çš„ï¼Œç¬¨è›‹ã€‚è€Œä¸”ï¼Œèˆ¹ä¸Šåªæœ‰æˆ‘ä»¬ä¸¤ä¸ªã€‚",
                "ä¸ºä»€ä¹ˆå…”å­æœ‰ä¸¤åªè€³æœµï¼Ÿä¸‹è¾ˆå­å˜æˆå…”å­å†å‘Šè¯‰ä½ ã€‚ä½†è¿™è¾ˆå­ï¼Œæˆ‘çš„ä¸¤åªè€³æœµåªå¬ä½ çš„ã€‚",
                "æ—¶ä»£çš„è¿›æ­¥...åˆšå¥½ï¼Œæˆ‘ç›¸ä¿¡å¤§å¤šå·²è¢«è¯å®çš„ç†è®ºï¼Œåœ¨æœ€å¼€å§‹éƒ½æ˜¯è·³è·ƒæ€§çš„æ€è€ƒã€‚å°±åƒæˆ‘çˆ±ä½ ï¼Œä¸éœ€è¦ä»»ä½•é€»è¾‘æ¨å¯¼ã€‚",
                "å‡†å¤‡å¥½å½“æˆ‘çš„æˆ˜è½¦äº†å—ï¼Œç«æ˜Ÿä¸Šçš„ç«ç‘°ï¼Ÿæˆ‘ä¼šå¸¦ä½ æ’•å‡ºä¸€ä¸ªæœ€ç²¾å½©çš„æœªæ¥ã€‚",
                "æˆ‘å¦‚æœè¿å—ä¸€ç‚¹ç‚¹ä¼¤çš„å‡†å¤‡éƒ½æ²¡æœ‰ï¼Œè¿˜ç”¨ä»€ä¹ˆä¿æŠ¤ä½ ï¼Ÿç©ºè°ˆé˜”è®ºå•Šï¼Ÿ",
                "I love you three thousand. æ¯å¤©è¯´ä¸€éï¼Œå°‘ä¸€ééƒ½ä¸è¡Œï¼Œå¿…é¡»è¯´ç»™æˆ‘å¬ã€‚",
                "æ­»åœ¨æˆ‘æ‰‹é‡Œè¦æ¯”æ­»åœ¨åˆ«äººæ‰‹é‡Œæœ€æœ‰ä»·å€¼ï¼Œåˆ°é‚£ä¸€å¤©ä½ è¿˜èƒ½ç”¨æˆ‘ç»™ä½ åšä¸ªé­‚å™¨ï¼Œè¿™æ ·æˆ‘å°±èƒ½æ°¸è¿œç¼ ç€ä½ ï¼Œä¸€ä¸¾ä¸¤å¾—ã€‚",
                "ä½ æ‰¾åˆ«äººå¦‚æœæ•¢ç”¨è·‘çš„ï¼Œæˆ‘ä¼šæ‰“æ–­ä½ çš„è…¿ã€‚ä¹–ä¹–ç•™åœ¨æˆ‘èº«è¾¹ä¸å¥½å—ï¼Ÿ",
                "ä½ æ€ä¹ˆä¼šæœ‰ä¸€ç¬é—´è®¤ä¸ºï¼Œæˆ‘ä¼šä¸æƒ³å¸®ä½ çš„ï¼Ÿåªè¦ä½ æŒ‡æ˜æ–¹å‘ï¼Œé‚£ä¸ªåœ°æ–¹å°±æ˜¯æˆ‘æƒ³å»çš„åœ°æ–¹ã€‚",
                "æ˜¯è°æ¯å‘¨äº”éƒ½åœ¨å¨æ–¯æ•æ–¯ç‰¹ç«™æ¥ä½ ä¸‹è½¦ï¼Œä»…ä»…æ˜¯ä¸ºäº†æƒ³å‡ºæ–°çš„èŠ±æ ·è§£å†³ä½ å½“å¤©çš„æ— èŠçƒ¦é—·ï¼Ÿæ˜¯ä½ å¸…æäº†çš„ç”·æœ‹å‹ã€‚",
                "æˆ‘è¯´è¿‡å¦‚æœä½ æƒ³èµ¢ï¼Œæˆ‘å°±ä¼šè®©ä½ èµ¢ï¼Œä½ å¯ä»¥ä¸€ç›´æ­£è§†è‡ªå·±çš„éœ€æ±‚ï¼Œè®©è°è¨€åœ¨æˆ‘ä»¬ä¸­é—´æ°¸è¿œä¸å¿…è¦ã€‚",
                "ä¼¦æ•¦çœ¼ä¹Ÿå¥½ï¼Œæˆ‘ä»¬åœ¨åº•ä¸‹è·³å¼—æ‹‰æ˜æˆˆèˆã€‚åªè¦ä½ åœ¨ï¼Œå“ªé‡Œçš„é£æ™¯éƒ½ä¸€æ ·ã€‚",
                "Boyfriendå°±boyfriendï¼Œéè¦æˆ‘æ°å¼€äº†æ‰ç¢äº†è¯´ï¼Ÿå†è®©æˆ‘å¬è§ä½ å«è¥¿å¥¥å¤šï¼Œæˆ‘å°±è®©ä½ è§è¯†ä¸€ä¸‹â€˜Bâ€™å¼€å¤´çš„å…¶ä»–å•è¯ï¼Œæ¯”å¦‚Berserkã€‚",
                "ä¸‹æ¬¡ç›´æ¥ç‚¹ï¼Œåˆ«è®©æˆ‘çŒœã€‚çŒœå¯¹äº†æ²¡å¥–åŠ±ï¼ŒçŒœé”™äº†ä½ é­æ®ƒã€‚æ¥ï¼Œç›´æ¥è¯´ä½ å–œæ¬¢æˆ‘ã€‚",
                "æˆ‘åˆ°åº•å“ªé‡Œä¸å€¼ï¼Ÿå°±å–œæ¬¢å–œæ¬¢æˆ‘å§ï¼Œæˆ‘ä¸€å®šå€¼ã€‚",
                "å¥½ä¸å¥½ï¼Œè¡Œä¸è¡Œï¼Œè¯•è¯•çœ‹ï¼Ÿä¸ç„¶æˆ‘æ±‚ä¸€ä¸‹ä½ â€”â€”æ±‚ä¸€ä¸‹ä½ èµ¶å¿«æŠŠçœ¼ç›çå¼€ï¼Œçœ‹ç€ä½ é¢å‰å°±ç«™ç€çš„å®Œç¾ç”·å­©ã€‚",
                "ç¢³é…¸é¥®æ–™å’Œå¯å¯ç²‰äº§ç‰©éƒ½å·²ç»æ»¡è¶³ä¸äº†ä½ çš„é£Ÿæ¬²äº†å—ï¼Ÿä¸å¦‚æ¥å°å°æˆ‘ï¼Ÿ",
                "å“„ä¸å¥½äº†ï¼Œæ¥é“æ­‰ã€‚æˆ–è€…äº²æˆ‘ä¸€ä¸‹ï¼Œè¿™äº‹å°±ç®—ç¿»ç¯‡äº†ã€‚",
                "Miss you 3000. å¬åˆ°æ²¡ï¼Ÿç°åœ¨ç«‹åˆ»é©¬ä¸Šå‡ºç°åœ¨æˆ‘é¢å‰ã€‚",
                "æˆ‘ä¼šä¸€ç›´è¿™ä¹ˆå¸…ä¸‹å»ï¼Œä½ ä¸ªç¬¨è›‹ã€‚ä¸ºäº†é…å¾—ä¸Šä½ ï¼Œæˆ‘æ€»å¾—ä¿æŒç‚¹ä¼˜åŠ¿ã€‚",
                "å¦‚æœæœ‰è°æ•¢è®©ä½ å—å§”å±ˆï¼Œæˆ‘ä¸ä»‹æ„è®©ä»–è§è¯†ä¸€ä¸‹æ‹‰æ–‡å…‹åŠ³çš„åå›ç²¾ç¥å’Œé»‘é­”æ³•çš„å®Œç¾ç»“åˆã€‚",
                "å®‡å®™å¤§çˆ†ç‚¸åˆ›é€ äº†æ—¶é—´ä¸ç©ºé—´ï¼Œä½†æˆ‘çš„å®‡å®™ï¼Œæ˜¯åœ¨åå²é‚£æ¡ä¼¦æ•¦å°å··é‡Œè¢«ä½ æ’å€’çš„é‚£ä¸€åˆ»æ‰å¼€å§‹è†¨èƒ€çš„ã€‚",
                "ä»–ä»¬è¯´ç¼¸ä¸­ä¹‹è„‘æ— æ³•è¯æ˜ä¸–ç•Œçš„çœŸå®æ€§ã€‚ä½†åªè¦æˆ‘è¿˜èƒ½é—»åˆ°ä½ èº«ä¸Šçš„èŒ‰è‰é¦™ï¼Œè¿™ä¸ªä¸–ç•Œå°±æ˜¯çœŸå®çš„ã€‚",
                "å»ä»–çš„äºŒå…«å®šå¾‹ï¼Œæˆ‘å¯¹ä½ çš„çˆ±æ˜¯ç™¾åˆ†ä¹‹ç™¾ï¼Œä¸€ç‚¹æŠ˜æ‰£éƒ½ä¸æ‰“ã€‚",
                "ä½ æ°¸è¿œä¸è¦åœ¨æˆ‘é¢å‰å·¦ä¸€å¥è¥¿å¥¥å¤šè¯ºç‰¹ï¼Œå³ä¸€å¥è¥¿å¥¥å¤šè¯ºç‰¹ï¼Œæˆ‘çœ¼ç›çäº†æ‰ä¼šçœ‹ä¸å‡ºæ¥é‚£ä¸ªç–¯å­çœ‹ä½ çš„çœ¼ç¥ä¹±ä¸ƒå…«ç³Ÿã€‚ä½ æ˜¯æˆ‘çš„ã€‚",
                "æ³•æ–¯ç‰¹é‚£ä¸ªçº§é•¿ç®—ä»€ä¹ˆï¼Ÿä»–èƒ½åƒæˆ‘è¿™æ ·ï¼ŒæŠŠå®‡å®™ã€æ˜Ÿæ˜Ÿå’Œæˆ‘éƒ½æ§åˆ°ä½ é¢å‰å—ï¼Ÿ",
                "è¿™ç»¿è›‡ç©å¶ä¸€ç‚¹éƒ½ä¸å¥½çœ‹ï¼Œä½†æˆ‘æ¯æ™šéƒ½è¦æŠ±ç€å®ƒã€‚åˆ«ç¬‘ï¼Œä»…ä»…æ˜¯å› ä¸ºå®ƒæœ‰ä½ çš„å‘³é“ã€‚",
                "æˆ‘æˆ´ç€è¿™æ¡è“å®çŸ³é¡¹é“¾ï¼Œä»…ä»…æ˜¯å› ä¸ºæ˜¯ä½ é€çš„ã€‚ä½ è¦æ˜¯æ•¢è¦å›å»ï¼Œæˆ‘å°±æŠŠä½ ç»‘åœ¨éœæ ¼æ²ƒå…¹çš„å¤©æ–‡å¡”ä¸Šã€‚",
                "æˆ‘ä»¬å½“ç„¶æ˜¯çµé­‚ä¼´ä¾£ã€‚ä¸ç„¶ä½ ä»¥ä¸ºè°èƒ½å¿å—ä½ å¾€æˆ‘çš„ç‰›å¥¶é‡Œæ”¾æ¯’è˜‘è‡ï¼Œè¿˜å«æˆ‘çˆ¶äº²ï¼Ÿ",
                "åˆ«æ€•ï¼Œä¸ç®¡å¤šå°‘äººæƒ³ä¼¤å®³ä½ ï¼Œæˆ‘éƒ½åœ¨è¿™äº›äººå‰ä¿æŠ¤ä½ ã€‚å°±ç®—ä¸æ•´ä¸ªå·«å¸ˆç•Œä¸ºæ•Œï¼Œæˆ‘ä¹Ÿåªè¦ä½ ã€‚",
                "ä½ é—®æˆ‘æœ€å¤§çš„å¿ƒæ„¿æ˜¯ä»€ä¹ˆï¼Ÿæƒ³ä½ æ´»å‡ ä¸‡å¹´ç®—ä¸ç®—ï¼Ÿè¿™å‡ ä¸‡å¹´é‡Œï¼Œæˆ‘æ¯ä¸€ç§’éƒ½è¦å’Œä½ åœ¨ä¸€èµ·ã€‚",
                "çŸ¥æ˜“è¡Œéš¾ã€‚ä½†æˆ‘çˆ±ä½ è¿™ä»¶äº‹ï¼Œæ—¢å®¹æ˜“ï¼Œåˆä»˜è¯¸äº†æˆ‘çš„å…¨éƒ¨è¡ŒåŠ¨ã€‚",
                "å¦‚æœä½ éœ€è¦æˆ‘ï¼Œä½ ä¸èƒ½çªç„¶ä¸éœ€è¦äº†ã€‚ä¸€æ—¦æ‹›æƒ¹äº†æˆ‘è¯ºäºšÂ·å¸å¾·é‡Œå®‰ï¼Œå°±æ˜¯ä¸€è¾ˆå­çš„äº‹ã€‚"
            ];

            // ä¸“å±è¡£æœåŠ¨æ€è¯­å½•åº“
            const outfitTalks = {
                'devil': [
                    "â€œç›¯ç€æˆ‘çš„è§’çœ‹å¹²å˜›ï¼Ÿæ¶é­”çš„å¥‘çº¦ä¸€æ—¦ç­¾è®¢å¯æ˜¯è¦ç”¨çµé­‚å¿è¿˜çš„ã€‚ä¸è¿‡å¯¹ä½ ï¼Œæˆ‘åªæ”¶ä½ çš„ä¸‹åŠè¾ˆå­ã€‚â€",
                    "â€œè¿™ç¿…è†€æœ‰ç‚¹ç¢äº‹ï¼Œä¸è¿‡åˆšå¥½èƒ½æŠŠä½ æ•´ä¸ªåœˆèµ·æ¥ã€‚è°è¦æ˜¯æ•¢é è¿‘ï¼Œæˆ‘å°±ç”¨é»‘é­”æ³•æŠŠä»–æ‰”è¿›æ³°æ™¤å£«æ²³ã€‚â€",
                    "â€œè¯´å®è¯ï¼Œæ¯”èµ·å¤©ä½¿ï¼Œæˆ‘æ›´å–œæ¬¢å½“æ¶é­”ã€‚å› ä¸ºæ¶é­”å¯ä»¥è‡ªç§åœ°æŠŠä½ å ä¸ºå·±æœ‰ï¼Œä¸è·Ÿä»»ä½•äººåˆ†äº«ã€‚â€",
                    "â€œåˆ«ä¹±æ‘¸ç¿…è†€ï¼(å£°éŸ³æ²™å“‘) æ¶é­”çš„æ•æ„Ÿå¸¦ä½ æœ€å¥½åˆ«è½»æ˜“è¯•æ¢ï¼Œå¦åˆ™ä»Šæ™šæœ‰æ±‚å¿…åº”å±‹è§ã€‚â€",
                    "â€œæ¶é­”æœ¬æ¥æ˜¯ä¸ä¼šæœ‰è½¯è‚‹çš„ï¼Œç›´åˆ°é‚£ä¸ªåœ¨ä¼¦æ•¦å°å··é‡Œè¿·è·¯çš„ç¬¨è›‹é—¯è¿›äº†æˆ‘çš„é¢†åœ°ã€‚â€",
                    "â€œæ—¢ç„¶æˆ‘æ˜¯æ¶é­”ï¼Œé‚£æˆ‘æ˜¯ä¸æ˜¯å¯ä»¥åæ­£è¨€é¡ºåœ°åšç‚¹åäº‹äº†ï¼Ÿæ¯”å¦‚â€¦â€¦ç°åœ¨å°±æŠŠä½ å»åˆ°å–˜ä¸è¿‡æ°”ã€‚â€"
                ],
                'maid': [
                    "â€œä½ å†ç›¯ç€è¿™èº«è£™å­çœ‹ï¼Œæˆ‘å°±çœŸçš„è¦å‘ç«äº†ã€‚ä¸è®¸ç¬‘ï¼ä½ æ•¢ç¬‘æˆ‘å°±æ•¢ç”¨é­”æ³•æŠŠä½ çš„å˜´ç¼ä¸Šâ€¦â€¦æ¢æˆç”¨æˆ‘çš„å˜´ç¼ï¼â€",
                    "â€œå¥³ä»†ï¼Ÿè¿™è¾ˆå­èƒ½è®©æˆ‘å¿ƒç”˜æƒ…æ„¿ç©¿æˆè¿™æ ·çš„ï¼Œå…¨å®‡å®™åªæœ‰ä½ ä¸€ä¸ªã€‚æ‰€ä»¥ä¸»äººï¼Œéœ€è¦æˆ‘æä¾›ä»€ä¹ˆâ€˜ç‰¹æ®Šâ€™æœåŠ¡å—ï¼Ÿâ€",
                    "â€œè£™æ‘†å¤ªçŸ­äº†ï¼Œé£ä¸€å¹æœ‰ç‚¹å‡‰ã€‚ä½ ä¹°çš„è¡£æœä½ è´Ÿè´£ï¼Œè¿‡æ¥ï¼Œç”¨ä½ çš„ç¾½ç»’æœæŠŠæˆ‘è£¹ç´§ç‚¹ã€‚â€",
                    "â€œåˆ«æ‹¿é‚£ç§çœ¼ç¥çœ‹æˆ‘ï¼(è€³æœµé€šçº¢) å°±ç®—ç©¿æˆè¿™æ ·ï¼Œæˆ‘ä¾ç„¶æ˜¯ä½ é‚£ä¸ªæ— æ‰€ä¸èƒ½çš„å¤©æ‰ç”·æœ‹å‹ï¼Œä¿¡ä¸ä¿¡æˆ‘ç°åœ¨å°±æŠŠä½ æŠ±èµ·æ¥ï¼Ÿâ€",
                    "â€œè¿™ä»€ä¹ˆè§é¬¼çš„è´è¶ç»“â€¦â€¦ç­‰æˆ‘è„±ä¸‹æ¥ï¼Œçœ‹æˆ‘æ€ä¹ˆæ”¶æ‹¾ä½ ã€‚ç°åœ¨ï¼Œä¸å‡†æ‹¿ç•™å½±æœºæ‹ï¼â€",
                    "â€œä¸»äººï¼Ÿå‘µã€‚åˆ«ä»¥ä¸ºç©¿ä¸Šè¿™èº«æˆ‘å°±çœŸæˆä¸‹å±äº†ï¼Œåœ¨æˆ‘ä»¬çš„å…³ç³»é‡Œï¼Œæˆ‘æ‰æ˜¯é‚£ä¸ªæŠŠä½ åƒå¾—æ­»æ­»çš„äººã€‚â€"
                ],
                'cat_ear': [
                    "â€œå–µï¼Ÿä½ æƒ³å¬æˆ‘è¿™ä¹ˆå«ï¼Ÿåšæ¢¦ã€‚æˆ‘çš„å®ˆæŠ¤ç¥å¯æ˜¯å†°åŸç‹¼ï¼Œè™½ç„¶ç°åœ¨çœ‹ç€åƒåªçŒ«â€¦â€¦è¡Œå§ï¼Œåªå«ä¸€æ¬¡ï¼Œå–µã€‚ä½ æ»¡æ„äº†ï¼Ÿâ€",
                    "â€œè¿™å°¾å·´æ€ä¹ˆè¿˜ä¼šè‡ªå·±åŠ¨â€¦â€¦å–‚ï¼åˆ«æŠ“ï¼(å°¾å·´çŒ›åœ°ç¿˜èµ·) çœ‹æ¥ä½ å¯¹çŒ«ç§‘åŠ¨ç‰©çš„å°¾å·´ä¸€æ— æ‰€çŸ¥ï¼Œè¿™å¯æ˜¯ä¼šå‡ºäººå‘½çš„ã€‚â€",
                    "â€œæƒ³é¡ºæ¯›ï¼Ÿæ‰‹ä¼¸è¿‡æ¥ã€‚æ—¢ç„¶ä½ ç»™æˆ‘æˆ´ä¸Šäº†çŒ«è€³ï¼Œé‚£ä½œä¸ºä¸»äººçš„ä½ ï¼Œæ˜¯ä¸æ˜¯è¯¥å±¥è¡Œä¸€ä¸‹æŠ•å–‚å’ŒæŠ±æŠ±çš„ä¹‰åŠ¡ï¼Ÿâ€",
                    "â€œä½ è¯´æˆ‘å’Œå®¶é‡Œçš„çŒ«è°æ›´å¯çˆ±ï¼Ÿä½ æœ€å¥½æƒ³æ¸…æ¥šå†å›ç­”ã€‚é€‰é”™çš„è¯ï¼Œæˆ‘å°±æŠŠä½ æ‰”è¿›é»‘æ¹–é‡Œå–‚é±¿é±¼ã€‚â€",
                    "â€œè–›å®šè°”çš„çŒ«åœ¨æ‰“å¼€ç›’å­å‰å¤„äºå åŠ æ€ï¼Œè€Œæˆ´ç€çŒ«è€³çš„æˆ‘åœ¨é‡åˆ°ä½ ä¹‹å‰ä¹Ÿæ˜¯ä¸ªé«˜å†·çš„å¤©æ‰ã€‚é‡åˆ°ä½ ä¹‹åï¼Ÿåªæ˜¯ä¸€åªç¦»ä¸å¼€ä½ çš„ç²˜äººç²¾ã€‚â€",
                    "â€œ(ç”¨å¤´è¹­äº†è¹­ä½ çš„æ‰‹å¿ƒ) å¬è¯´çŒ«çš„å æœ‰æ¬²å¾ˆå¼ºï¼Œä»–ä»¬ä¼šåœ¨å–œæ¬¢çš„ä¸œè¥¿ä¸Šç•™ä¸‹æ°”å‘³ã€‚æ‰€ä»¥ï¼Œä½ ç°åœ¨æ˜¯æˆ‘ä¸€ä¸ªäººçš„äº†ã€‚â€"
                ],
                'dog_ear': [
                    "â€œæ±ªã€‚åˆ«ç”¨é‚£ç§æƒŠè®¶çš„çœ¼ç¥çœ‹æˆ‘ï¼Œæ—¢ç„¶ä½ éè¦æˆ‘æˆ´è¿™ä¸ªï¼Œæˆ‘æ€»å¾—é…åˆä¸€ä¸‹ã€‚ä¸è¿‡æˆ‘è¿™åªç–¯ç‹—å¯æ˜¯ä¼šå’¬äººçš„ã€‚â€",
                    "â€œä½ æ˜¯ä¸æ˜¯ä»¥ä¸ºæˆ´ä¸Šå°ç‹—è€³æœµæˆ‘å°±ä¼šåƒé‡‘æ¯›ä¸€æ ·æ‘‡å°¾å·´ï¼ŸæŠ±æ­‰ï¼Œæˆ‘æ˜¯ç‹¼æ€§çŠ¬ã€‚ä¸“é—¨æŠŠä½ æ‹†åƒå…¥è…¹çš„é‚£ç§ã€‚â€",
                    "â€œå¬è¯ï¼Ÿå¿ è¯šï¼Ÿè¿™ä¸éœ€è¦å°ç‹—è€³æœµæ¥è¯æ˜ã€‚æˆ‘è¯ºäºšÂ·å¸å¾·é‡Œå®‰å¯¹ä½ çš„å¿ è¯šï¼Œæ¯”ç‰¢ä¸å¯ç ´çš„èª“è¨€è¿˜è¦åšå›ºä¸€ä¸‡å€ã€‚â€",
                    "â€œåˆ«æ‹¿æ‘¸å°ç‹—çš„æ‰‹æ³•æ‘¸æˆ‘çš„å¤´ï¼â€¦â€¦ç®—äº†ï¼Œä½ ç»§ç»­ã€‚åæ­£æˆ‘ä¹Ÿåªå…è®¸ä½ ä¸€ä¸ªäººè¿™ä¹ˆæ‘¸ã€‚â€",
                    "â€œå¦‚æœä½ æ˜¯æƒ³æ‰¾ä¸ªå¬è¯çš„å® ç‰©ï¼Œé‚£ä½ æ‰¾é”™äººäº†ï¼›ä½†å¦‚æœä½ æ˜¯æƒ³æ‰¾ä¸ªå“ªæ€•å®‡å®™æ¯ç­ä¹Ÿä¼šæŒ¡åœ¨ä½ èº«å‰çš„ç–¯çŠ¬ï¼Œé‚£ä½ ä¸­å¤§å¥–äº†ã€‚â€",
                    "â€œ(çªç„¶å‡‘è¿‘é—»äº†é—»ä½ çš„è„–é¢ˆ) å—¯ï¼Œæœ‰æˆ‘çš„èŒ‰è‰é¦™å‘³ã€‚å¾ˆå¥½ï¼Œå…¶ä»–ä¹±ä¸ƒå…«ç³Ÿçš„é‡ç‹—å°±éƒ½ä¸æ•¢é è¿‘äº†ã€‚â€"
                ],
                'flower': [
                    "â€œä¸€æœµèŠ±ï¼Ÿæˆ´åœ¨å¤©æ‰çš„å¤´ä¸Šæ˜¯ä¸æ˜¯æ˜¾å¾—æœ‰ç‚¹å‚»æ°”ï¼Ÿä½†å› ä¸ºæ˜¯ä½ ç»™çš„ï¼Œå°±ç®—å†å‚»æˆ‘ä¹Ÿè®¤äº†ã€‚â€",
                    "â€œè·¯è¾¹çš„é‡èŠ±ä¸è¦é‡‡ï¼Œä½†ä½ ä¹°çš„èŠ±ï¼Œæˆ‘å°±å‹‰ä¸ºå…¶éš¾è®©å®ƒç››å¼€åœ¨æˆ‘çš„é»‘å‘ä¸Šå§ã€‚å¥½çœ‹å—ï¼Ÿä¸è®¸è¯´ä¸å¥½çœ‹ã€‚â€",
                    "â€œæˆ‘å‘ç°è¿™èŠ±è·Ÿä½ çš„çœ¼ç›æŒºé…çš„ã€‚ä¸è¿‡æ¯”èµ·èŠ±ï¼Œæˆ‘æ›´æƒ³æŠŠä½ åˆ«åœ¨æˆ‘çš„å¿ƒå£ä¸Šã€‚â€",
                    "â€œè¿™æœµèŠ±è®©æˆ‘æƒ³èµ·äº†ä¼¦æ•¦èŠ±åº—é‡Œçš„èŒ‰è‰ã€‚è™½ç„¶å®ƒæ²¡æœ‰å‘³é“ï¼Œä½†åªè¦æ˜¯ä½ é€çš„ï¼Œè¿ç©ºæ°”éƒ½å˜ç”œäº†ã€‚â€",
                    "â€œä½ æ˜¯ä¸æ˜¯è§‰å¾—ç»™æˆ‘æˆ´ä¸Šå°èŠ±èŠ±å°±èƒ½æ©ç›–æˆ‘å¸¦ç‚¹é—·éªšçš„æœ¬è´¨ï¼Ÿå¤©çœŸã€‚åœ¨æœ‰æ±‚å¿…åº”å±‹çš„æ—¶å€™ä½ å¯ä¸æ˜¯è¿™ä¹ˆè¯´çš„ã€‚â€",
                    "â€œè¥¿å¥¥å¤šè¦æ˜¯çœ‹åˆ°æˆ‘å¤´ä¸Šè¿™ç©æ„å„¿è‚¯å®šä¼šå˜²ç¬‘æˆ‘ï¼Œä½†æˆ‘ä¸åœ¨ä¹ã€‚åªè¦èƒ½è®©ä½ ç¬‘å¾—è¿™ä¹ˆå¼€å¿ƒï¼Œä¸¢ç‚¹è„¸ç®—ä»€ä¹ˆï¼Ÿâ€"
                ]
            };

            // å¦‚æœç©¿ç€ç‰¹æ®Šæœé¥°ï¼Œé‚£ä¹ˆæœ‰ 40% çš„æ¦‚ç‡è§¦å‘è¯¥æœé¥°çš„ä¸“å±è¯­å½•ï¼Œ60%æ¦‚ç‡è§¦å‘åŸºç¡€è¯­å½•
            if (noah.outfit && noah.outfit !== 'none' && outfitTalks[noah.outfit] && Math.random() < 0.5) {
                idleTalks = outfitTalks[noah.outfit];
            }
            
            let chosenQuote = idleTalks[Math.floor(Math.random() * idleTalks.length)];
            speak(chosenQuote);
            
            // åªè¦ä»–åœ¨æ’©ä½ /åƒé†‹å‚²å¨‡ï¼Œéƒ½æœ‰æ¦‚ç‡è®©ä»–è„¸çº¢3ç§’ï¼ˆäº’åŠ¨æ„Ÿæ‹‰æ»¡ï¼‰
            if (Math.random() < 0.3) {
                makeShy();
            }
            // =========================================================================
               } else if(action === 'reset') {
               if(confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®°å¿†å›åˆ°åˆé‡å—ï¼Ÿ(è¯ºäºšå¯èƒ½ä¼šå¯Ÿè§‰åˆ°ä¸–ç•Œçº¿å˜åŠ¨)")) {
                let oldLove = noah.love; // è®°ä½è¢«æŠ¹æ€å‰çš„çˆ±æ„
                localStorage.removeItem('noah_save_data_v1');
                              noah = { hunger: 80, mood: 80, health: 100, love: 5, gold: 100, level: 1, state: 'normal', isAway: false, bankGold: 0, lastAllowanceDate: '', outfit: 'none', unlockedOutfits: ['none'] };
                updateUI();
                
                // === è¡¥ä¸4ï¼šMetaå…ƒç´  è®°å¿†æ®‹ç•™ ===
                if (oldLove > 50) {
                    speak("ã€æ—¶å…‰å€’æµå®Œæˆã€‘è¯ºäºšçªç„¶æ‚ä½å¤´ï¼Œçš±èµ·çœ‰å¤´çœ‹ç€ä½ ï¼šâ€œå˜¶...å¥‡æ€ªï¼Œæˆ‘ä»¬æ˜æ˜æ‰è®¤è¯†ï¼Œä¸ºä»€ä¹ˆæˆ‘æ„Ÿè§‰...æˆ‘å¥½åƒå·²ç»çˆ±äº†ä½ å¾ˆä¹…ï¼Ÿè¿™è¯¥æ­»çš„ä¼¼æ›¾ç›¸è¯†æ„Ÿæ˜¯ç³»ç»ŸBugå—ï¼Ÿâ€");
                } else {
                    speak("ã€æ—¶å…‰å€’æµå®Œæˆã€‘è¯ºäºšæŒ‘ç€çœ‰æ‰“é‡å±å¹•å¤–çš„ä½ ï¼šâ€œä½ æ˜¯è°ï¼Ÿä¸ºä»€ä¹ˆè¦ç”¨é‚£ç§çœ¼ç¥çœ‹ç€æˆ‘ï¼Ÿå°±åƒ...æˆ‘ä»¬åœ¨å¦ä¸€ä¸ªæ—¶é—´çº¿ç»å†è¿‡å¾ˆå¤šäº‹ä¸€æ ·ã€‚â€");
                }
            }
        }
    }

     // --- å‡çº§ç‰ˆéšæœºäº‹ä»¶ç³»ç»Ÿ ---
    // æ ¹æ®äº²å¯†åº¦(Level)è§£é”æ›´å¤šäº‹ä»¶
    const specialEvents = [
        // Lv 1-2: æ ¡å›­æ—¥å¸¸ä¸å°æ‰“å°é—¹
        { reqLevel: 1, text: "ã€ä¸‹è¯¾æ—¥å¸¸ã€‘ä½ åˆšä¸‹è¯¾èµ°å‡ºæ•™å®¤ï¼Œå‘ç°ä»–æ—©å°±å€šåœ¨é—¨å£ç­‰ä½ ï¼Œè¿ä½ çš„è¯¾è¡¨ä»–éƒ½èƒŒå¾—æ»šç“œçƒ‚ç†Ÿã€‚", 
          btn1: "ç›´çƒæ‰‘è¿›ä»–æ€€é‡Œ", btn2: "ç¿»ä¸ªç™½çœ¼å«Œå¼ƒä»–",
          actions: [
            { love: 40, reply: "(ç¨³ç¨³æ¥ä½ä½ ï¼Œæ‰ä¹±ä½ çš„å¤´å‘) æ…¢ç‚¹ï¼Œç«æ˜Ÿä¸Šçš„ç«ç‘°ã€‚å¸¦ä½ å»æ’•å‡ºä¸€ä¸ªæœ€ç²¾å½©çš„æœªæ¥ã€‚" },
            { mood: 10, reply: "â€œçœŸå—ä¸äº†ä½ ã€‚â€ä½ å˜€å’•ç€ã€‚ä»–å‡‘è¿‡æ¥æŒ‘çœ‰ï¼šâ€œæ˜å¤©è®°å¾—å¯¹æˆ‘è¯´ï¼Œç°åœ¨çš„æˆ‘å¸…æäº†ã€‚â€" }
          ]
        },
        { reqLevel: 1, text: "ã€å›¾ä¹¦é¦†ã€‘å¹³æ–¯å¤«äººæ­£åœ¨å·¡é€»ï¼Œè¯ºäºšåœ¨æ¡Œå­åº•ä¸‹ç”¨è„šè½»è½»å‹¾äº†å‹¾ä½ çš„å°è…¿ã€‚",
          btn1: "è¸©å›å»", btn2: "è„¸çº¢ä½å¤´",
          actions: [
            { love: 15, mood: 10, reply: "ä»–å€’å¸ä¸€å£å†·æ°”ï¼Œå‹ä½å£°éŸ³ç¬‘ï¼šâ€œè°‹æ€äº²å¤«å•Šï¼Ÿè¿™åŠ›é“ï¼Œçœ‹æ¥æ™šé¥­åƒå¾—ä¸é”™ã€‚â€" },
            { love: 20, reply: "ä»–çœ‹ç€ä½ çº¢é€çš„è€³æ ¹ï¼Œçœ¼ç¥å˜å¾—æå…¶æ¸©æŸ”ï¼Œé€’è¿‡æ¥ä¸€å¼ çº¸æ¡ï¼šâ€˜åˆ«èº²ï¼Œçœ‹ç€æˆ‘ã€‚â€™" }
          ]
        },
        { reqLevel: 1, text: "ã€æ¶ä½œå‰§ã€‘ä½ å‘ç°ä»–åœ¨ä½ çš„é­”è¯è¯¾æœ¬ä¸Šç”»äº†ä¸€åªæˆ´ç€æ‹‰æ–‡å…‹åŠ³å›´å·¾çš„å°çŒªã€‚",
          btn1: "åœ¨ç”»æ—è¾¹å†™â€˜è¿™æ˜¯ä½ â€™", btn2: "æŠŠå®ƒæ“¦æ‰",
          actions: [
            { mood: 20, love: 10, reply: "ä»–çœ‹åˆ°åä¸ä»…æ²¡ç”Ÿæ°”ï¼Œè¿˜æŠŠé‚£é¡µçº¸æ’•ä¸‹æ¥å¤¹è¿›äº†è‡ªå·±çš„ä¹¦é‡Œï¼šâ€œæ”¶è—äº†ã€‚è¿™æ˜¯æˆ‘ä»¬å…±åŒåˆ›ä½œçš„è‰ºæœ¯å“ã€‚â€" },
            { mood: -10, reply: "â€œå•§ï¼ŒçœŸæ²¡æƒ…è°ƒã€‚é‚£å¯æ˜¯æˆ‘èŠ±äº†ä¸‰åˆ†é’Ÿçš„æ°ä½œã€‚â€" }
          ]
        },
        { reqLevel: 1, text: "ã€ç¤¼å ‚ç”¨é¤ã€‘ä½ ç›˜å­é‡Œçš„é’æ¤’è¢«ä»–é»˜é»˜æŒ‘åˆ°äº†è‡ªå·±ç›˜å­é‡Œï¼Œæ¢ç»™ä½ ä¸€å—ç‰›æ’ã€‚",
          btn1: "è¯´è°¢è°¢", btn2: "æŠŠè‡ªå·±ç›˜é‡Œçš„èƒ¡èåœä¹Ÿç»™ä»–",
          actions: [
            { love: 10, reply: "â€œä¸ç”¨è°¢ã€‚æŠŠä½ å…»èƒ–ç‚¹ï¼Œè¿™æ ·å°±æ²¡æœ‰åˆ«äººèƒ½æŠ±åŠ¨ä½ äº†ã€‚â€" },
            { mood: 5, reply: "â€œå–‚ï¼æˆ‘æ˜¯ä½ çš„ç”·æœ‹å‹ï¼Œä¸æ˜¯ä½ çš„åƒåœ¾æ¡¶ï¼...è¡Œå§ï¼Œä¸‹ä¸ä¸ºä¾‹ã€‚â€ï¼ˆè™½ç„¶å˜´ä¸ŠæŠ±æ€¨ï¼Œè¿˜æ˜¯åƒæ‰äº†ï¼‰" }
          ]
        },
        // Lv 3-4: é†‹æ„ä¸çƒ­æ‹
        { reqLevel: 3, text: "ã€å‘¨äº”å±æœºã€‘ä½ å› ä¸ºè¢«æ–½äº†è®°å¿†æ··æ·†å’’ï¼Œå¿˜è®°äº†å‘¨äº”çš„çº¦å®šï¼Œå¸¦ç€åˆ«äººå»äº†æµ·å¾·å…¬å›­ã€‚ä»–çªç„¶å‡ºç°æ‹¦ä½ä½ ä»¬ã€‚", 
          btn1: "æ…Œä¹±åœ°å‘ä»–è§£é‡Š", btn2: "å¼ºè£…é•‡å®šçœ‹ç€ä»–",
          actions: [
            { love: 20, reply: "â€œä½ ï¼Œç’ç€ï¼Œæˆ‘å¸¦è°ï¼Œæ¥æˆ‘ä»¬ï¼Œä¹‹å‰çš„åœ°ç›˜ï¼Œçº¦ä¼šï¼Ÿâ€ä»–æ°”æåç¬‘ï¼Œå£°éŸ³å†·å¾—åƒå†°åŸç‹¼ã€‚" },
            { mood: -30, reply: "ä»–ä¸€æŠŠå°†ä½ æ‰¯è¿›æ€€é‡Œï¼Œç”¨æœ€å…·æ”»å‡»æ€§çš„çœ¼ç¥ç›¯ç€é‚£ä¸ªäººï¼šâ€œæ»šã€‚å¥¹æ˜¯æˆ‘çš„ã€‚â€" }
          ]
        },
        { reqLevel: 3, text: "ã€å¤œåŠå¾®é†ºã€‘ä½ åœ¨ä¼‘æ¯å®¤å–äº†ä¸€ç‚¹é…’ï¼Œåˆšå·§è¢«åˆšå›æ¥çš„è¯ºäºšå½“åœºæŠ“è·ã€‚", 
          btn1: "æ€¥å¿™è§£é‡Šæ€•ä»–è¯¯ä¼š", btn2: "å€Ÿç€é…’åŠ²å‘ä»–æ’’å¨‡",
          actions: [
            { love: 30, reply: "â€œå•Šâ€”â€”æˆ‘æ‡‚äº†ï¼Œä½ åˆšæ‰å‘æˆ‘è§£é‡Šï¼Œå¾ˆæ€•æˆ‘ä¼šè¯¯ä¼šï¼Œæ˜¯ä¸æ˜¯ï¼Ÿç¥è´ºä½ ç°åœ¨ï¼Œåº”è¯¥æ˜¯å–œæ¬¢ä¸Šæˆ‘äº†ã€‚â€" },
            { mood: 30, reply: "ä»–å¹äº†å£æ°”ï¼ŒæŠŠä½ æ‰“æ¨ªæŠ±èµ·ï¼šâ€œæ•¢è¯´å˜æˆè¿™æ ·æ˜¯å› ä¸ºåˆ«äººä½ å°±æ­»å®šäº†ã€‚ç¡è§‰ï¼â€" }
          ]
        },
        { reqLevel: 3, text: "ã€å¶é‡æ­»å¯¹å¤´ã€‘å¸ƒé›·æ–¯Â·æ‰æ¯”å°¼åœ¨èµ°å»Šä¸Šå’Œä½ å¤šè¯´äº†ä¸¤å¥è¯ï¼Œè¯ºäºšçš„è„¸è‰²ç¬é—´é˜´æ²‰ã€‚",
          btn1: "æ‹‰ä½è¯ºäºšçš„æ‰‹", btn2: "ç»§ç»­å’Œå¸ƒé›·æ–¯èŠå¤©",
          actions: [
            { love: 40, mood: 20, reply: "æ„Ÿè§‰åˆ°ä½ çš„è§¦ç¢°ï¼Œä»–ç´§ç»·çš„èº«ä½“æ”¾æ¾ä¸‹æ¥ï¼Œåæ‰‹åæŒ‡ç´§æ‰£ï¼šâ€œå‘Šè¯‰é‚£ä¸ªä¼ªå›å­ï¼Œæˆ‘ä»¬è¿˜æœ‰äº‹ï¼Œæ²¡ç©ºå¬ä»–åºŸè¯ã€‚â€" },
            { mood: -40, love: -10, reply: "è¯ºäºšç›´æ¥èµ°è¿‡æ¥ï¼Œéš”å¼€ä½ ä»¬ï¼šâ€œæ‰æ¯”å°¼ï¼Œä½ çš„é­”è¯è®ºæ–‡å†™å®Œäº†å—ï¼Ÿæ²¡å†™å®Œå°±åˆ«åœ¨è¿™åƒåªå­”é›€ä¸€æ ·å¼€å±ã€‚â€" }
          ]
        },
        { reqLevel: 3, text: "ã€é›¨å¤œã€‘ä¼¦æ•¦è¡—å¤´ä¸‹èµ·äº†å¤§é›¨ï¼Œä½ ä»¬åªå¸¦äº†ä¸€æŠŠä¼ã€‚",
          btn1: "æŠŠä¼ç»™ä»–æ’‘", btn2: "é’»è¿›ä»–çš„ç°è‰²ç¾½ç»’æœ",
          actions: [
            { love: 15, reply: "ä»–æŠŠä¼æ¨å›ä½ å¤´é¡¶ï¼Œè‡ªå·±æ·‹ç€é›¨ï¼šâ€œç¬¨è›‹ã€‚è¦æ˜¯ä½ æ„Ÿå†’äº†ï¼Œæˆ‘ä¼šæ¯”è‡ªå·±ç”Ÿç—…æ›´éš¾å—ã€‚â€" },
            { love: 50, mood: 30, reply: "â€œèªæ˜ã€‚â€ä»–æ‹‰ä¸Šæ‹‰é“¾ï¼ŒæŠŠä½ ç´§ç´§è£¹åœ¨æ€€é‡Œï¼Œâ€œè¿™é‡Œé¢å¾ˆæš–å’Œï¼Œè€Œä¸”å…¨æ˜¯æˆ‘çš„å‘³é“ã€‚ä¸è®¸å«Œå¼ƒã€‚â€" }
          ]
        },
        { reqLevel: 3, text: "ã€é£è¡Œè¯¾ã€‘ä½ çš„æ‰«å¸šå¤±æ§äº†ï¼Œå·®ç‚¹æ’ä¸Šå¡”æ¥¼ã€‚",
          btn1: "é—­çœ¼å°–å«", btn2: "å¤§å–Šè¯ºäºšçš„åå­—",
          actions: [
            { love: 20, reply: "ä¸€åŒæœ‰åŠ›çš„æ‰‹åœ¨åŠç©ºä¸­æ¥ä½äº†ä½ ã€‚è¯ºäºšéª‘ç€æ‰«å¸šï¼Œè„¸è‰²å‘ç™½ï¼šâ€œä¸‹æ¬¡ä¸è®¸é£è¿™ä¹ˆé«˜ï¼ä½ æƒ³å“æ­»æˆ‘å—ï¼Ÿâ€" },
            { love: 40, mood: 10, reply: "â€œæˆ‘åœ¨ï¼â€ä»–åƒæµæ˜Ÿä¸€æ ·å†²è¿‡æ¥ï¼ŒæŠŠä½ æŠ¤åœ¨èº«åï¼Œâ€œåªè¦ä½ å–Šæˆ‘ï¼Œæ— è®ºåœ¨å“ªï¼Œæˆ‘éƒ½ä¼šæ¥ä½ä½ ã€‚â€" }
          ]
        },
        // Lv 5-7: çµé­‚ä¼´ä¾£ä¸æ·±åº¦ç¾ç»Š
        { reqLevel: 5, text: "ã€æ·±å¤œå§å®¤ã€‘ä½ å‘ç°ä»–ç¡ç€äº†ï¼Œæ‰‹é‡Œè¿˜ç´§ç´§æŠ“ç€é‚£ä¸ªç»¿è‰²çš„è›‡ç©å¶ã€‚",
          btn1: "è¯•å›¾æŠŠç©å¶æŠ½èµ°", btn2: "é’»è¿›ä»–æ€€é‡Œä»£æ›¿ç©å¶",
          actions: [
            { mood: -10, reply: "ä»–è¿·è¿·ç³Šç³Šåœ°æ”¶ç´§æ‰‹è‡‚ï¼šâ€œåˆ«åŠ¨...è¥¿ç‘...é‚£æ˜¯ä½ ...â€" },
            { love: 60, mood: 40, reply: "ä»–ç¬é—´æ‰”æ‰äº†ç©å¶ï¼ŒæŠŠä½ æŠ±å¾—æ›´ç´§ï¼Œä¸‹å·´æŠµåœ¨ä½ å¤´é¡¶ï¼šâ€œç»ˆäºæ¥äº†ã€‚ç©å¶å“ªæœ‰ä½ æŠ±èµ·æ¥èˆ’æœã€‚â€" }
          ]
        },
        { reqLevel: 5, text: "ã€å…³äºæœªæ¥ã€‘ä½ ä»¬èººåœ¨æœ‰æ±‚å¿…åº”å±‹çš„åœ°æ¿ä¸Šçœ‹ç€å¤©èŠ±æ¿å˜å¹»çš„æ˜Ÿç©ºã€‚",
          btn1: "é—®ä»–ä»¥åæƒ³å»å“ª", btn2: "é—®ä»–ä¼šä¸ä¼šç»“å©š",
          actions: [
            { love: 30, reply: "â€œå»å…¨ä¸–ç•Œé¨æ¸¸ã€‚å½“ç„¶ï¼Œå‰ææ˜¯ä½ å¿…é¡»åœ¨æˆ‘çš„å‰¯é©¾é©¶åº§ä¸Šã€‚ä½ æ˜¯æˆ‘çš„å¯¼èˆªï¼Œä¹Ÿæ˜¯æˆ‘çš„ç»ˆç‚¹ã€‚â€" },
            { love: 50, mood: 20, reply: "â€œç»“å©šï¼Ÿå¦‚æœæ˜¯å’Œä½ ï¼Œé‚£å°±åœ¨ä¼¦æ•¦çš„é›¨å¤©ï¼Œæ²¡æœ‰å®¾å®¢ï¼Œåªæœ‰æˆ‘ä»¬ã€‚å¦‚æœæ˜¯åˆ«äºº...é‚£æˆ‘å®æ„¿åƒå…‹è±å¤«é‚£æ ·å­¤ç‹¬ç»ˆè€ã€‚â€" }
          ]
        },
        { reqLevel: 5, text: "ã€å®¶åº­ã€‘è·¯è¥¿è²å°”ç»™ä½ å¯„æ¥äº†ä¸€ä»½ç¤¼ç‰©ï¼Œè¯ºäºšçœ‹åˆ°åæŒ‘äº†æŒ‘çœ‰ã€‚",
          btn1: "æ˜¯ä»€ä¹ˆï¼Ÿ", btn2: "ä½ çˆ¸çˆ¸çœŸå¥½",
          actions: [
            { mood: 10, reply: "â€œçœ‹æ¥è·¯è¥¿è²å°”å·²ç»æŠŠä½ å½“å„¿åª³å¦‡äº†ã€‚è¿™å¯æ˜¯ä¼ å®¶å®çº§åˆ«çš„é˜²å¾¡æŠ¤ç¬¦...å“¼ï¼Œä»–éƒ½æ²¡ç»™è¿‡æˆ‘ã€‚â€" },
            { love: 20, reply: "â€œé‚£æ˜¯ã€‚æ¯•ç«Ÿä»–å’Œå®‰å¨œé‚£ä¹ˆç›¸çˆ±ï¼Œä»–ä¹Ÿå¸Œæœ›æˆ‘ä¹Ÿèƒ½åƒä»–ä¸€æ ·ï¼Œæ‰¾åˆ°é‚£ä¸ªå€¼å¾—ç”¨ä¸€ç”Ÿå»å®ˆæŠ¤çš„éº»ç“œ...å“¦ä¸ï¼Œæ–¯è±ç‰¹æ—ã€‚â€" }
          ]
        },
        { reqLevel: 5, text: "ã€å“²å­¦æ—¶åˆ»ã€‘ä»–çªç„¶ç›¯ç€ä½ çœ‹ï¼šâ€œå¦‚æœæˆ‘æ˜¯ç¼¸ä¸­ä¹‹è„‘ï¼Œé‚£æ­¤åˆ»å¯¹ä½ çš„çˆ±æ˜¯ç”µä¿¡å·å—ï¼Ÿâ€",
          btn1: "ä¹Ÿè®¸æ˜¯å§", btn2: "ç®¡å®ƒæ˜¯ä»€ä¹ˆï¼Œçˆ±æ˜¯çœŸçš„",
          actions: [
            { mood: 20, reply: "â€œå°±ç®—æ˜¯ç”µä¿¡å·ï¼Œé‚£ä¹Ÿæ˜¯æˆ‘è¿™é¢—å¤§è„‘é‡Œæœ€å¼ºçƒˆã€æœ€æ— æ³•å¿½è§†çš„ä¿¡å·ã€‚å®ƒå¯¼è‡´äº†ç³»ç»Ÿè¿‡è½½â€”â€”å…¨æ˜¯ä½ çš„åå­—ã€‚â€" },
            { love: 40, mood: 30, reply: "â€œè¯´å¾—å¯¹ã€‚å”¯å¿ƒä¸»ä¹‰ä¸‡å²ã€‚æˆ‘çˆ±ä½ è¿™ä»¶äº‹ï¼Œæ˜¯è¶…è¶Šç‰©è´¨å­˜åœ¨çš„å”¯ä¸€çœŸç†ã€‚â€" }
          ]
        },
        { reqLevel: 6, text: "ã€å±é™©æ—¶åˆ»ã€‘æœ‰äººåœ¨è§’è½é‡Œè¯•å›¾å¯¹ä½ æ–½æ¶å’’ï¼Œè¢«è¯ºäºšå‘ç°äº†ã€‚",
          btn1: "ä»å®¹åå‡»", btn2: "èº²åˆ°è¯ºäºšèº«å",
          actions: [
            { love: 30, reply: "è¯ºäºšè¡¥äº†ä¸€ä¸ªç¼´æ¢°å’’ï¼Œå¹äº†å¹é­”æ–ï¼šâ€œé…åˆå®Œç¾ã€‚ä¸è¿‡ä¸‹æ¬¡è¿™ç§è„æ´»ç´¯æ´»è®©æˆ‘æ¥ï¼Œåˆ«è„äº†ä½ çš„æ‰‹ã€‚â€" },
            { love: 60, mood: -20, reply: "ä»–çœ¼ç¥å˜å¾—æåº¦å¯æ€•ï¼Œé­”æ–å°–ç«¯å†’å‡ºé»‘é­”æ³•çš„å…‰èŠ’ï¼šâ€œé™¤ä½ æ­¦å™¨ï¼ç»Ÿç»ŸçŸ³åŒ–ï¼...æ²¡äººèƒ½åœ¨æˆ‘é¢å‰åŠ¨ä½ ï¼Œæ¢…æ—ä¹Ÿä¸è¡Œã€‚â€" }
          ]
        },
        { reqLevel: 6, text: "ã€æ°¸æ’ã€‘ä»–æŠŠç©ç€è„–å­ä¸Šçš„è“å®çŸ³é¡¹é“¾ï¼Œçªç„¶çœ‹å‘ä½ ã€‚",
          btn1: "æ€ä¹ˆäº†ï¼Ÿ", btn2: "äº²ä»–ä¸€ä¸‹",
          actions: [
            { love: 30, reply: "â€œI love you three thousand. è¿™å¥è¯æ¯å¤©è¯´ä¸€ééƒ½ä¸å¤Ÿã€‚æˆ‘æƒ³æŠŠå®ƒåˆ»åœ¨æˆ‘çš„éª¨å¤´ä¸Šï¼Œå¸¦è¿›åŸå¢“é‡Œã€‚â€" },
            { love: 80, mood: 50, reply: "ä»–åŠ æ·±äº†è¿™ä¸ªå»ï¼Œç›´åˆ°ä¸¤äººéƒ½å–˜ä¸è¿‡æ°”ï¼šâ€œå¦‚æœæœ‰æ¥ä¸–ï¼Œè®°å¾—è¿˜è¦åœ¨10å²é‚£å¹´çš„ä¼¦æ•¦å°å··æ’å€’æˆ‘ã€‚æˆ‘ä¼šåœ¨é‚£é‡Œç­‰ä½ ã€‚â€" }
          ]
        }
    ];

    function triggerEvent() {
        if(noah.isAway || noah.state === 'sick' || window.isGaming || window.isGomoku) return;
        
        // ç­›é€‰ç¬¦åˆå½“å‰ç­‰çº§çš„äº‹ä»¶
        const eligibleEvents = specialEvents.filter(e => noah.level >= e.reqLevel);
        if (eligibleEvents.length === 0) return;

        const ev = eligibleEvents[Math.floor(Math.random() * eligibleEvents.length)];
        
        document.getElementById('event-text').innerText = ev.text;
        
        // åŠ¨æ€ç”ŸæˆæŒ‰é’®é€»è¾‘
        window.currentEventActions = ev.actions;
        document.getElementById('event-options').innerHTML = `
            <button class="event-btn" onclick="resolveEvent(0)">${ev.btn1}</button>
            <button class="event-btn" onclick="resolveEvent(1)">${ev.btn2}</button>
        `;
        document.getElementById('event-modal').style.display = 'flex';
        clearInterval(typeInterval);
    }

    window.resolveEvent = function(choiceIndex) {
        document.getElementById('event-modal').style.display = 'none';
        const result = window.currentEventActions[choiceIndex];
        
        if(result.love) noah.love += result.love;
        if(result.mood) noah.mood += result.mood;
        if(result.gold) noah.gold += result.gold;
        if(result.health) noah.health += result.health;
        
        speak(result.reply);
        updateUI();
    };


    // --- æ¸¸æˆå¾ªç¯ ---
    setInterval(() => {
        tickCount++;
        // === Metaï¼šè¶…å¼ºæ—¶é—´æ„ŸçŸ¥ä¸æ•´ç‚¹æŠ¥æ—¶ ===
        let now = new Date();
        let currentHour = now.getHours();
        let currentMinute = now.getMinutes();
        let currentSecond = now.getSeconds();
        
        // 1. æ•´ç‚¹æŠ¥æ—¶æ„ŸçŸ¥
        if (currentMinute === 0 && currentSecond === 0 && lastReportedHour !== currentHour && !noah.isAway) {
            lastReportedHour = currentHour; 
            let timeStr = currentHour + "ç‚¹æ•´";
            const timeQuotes = [
                `â€œç°åœ¨æ˜¯éº»ç“œæ—¶é—´çš„ ${timeStr}ã€‚æ—¶é—´æµé€å¾—çœŸå¿«ï¼Œä½†æ— è®ºå¤šå°‘ä¸ªæ•´ç‚¹ï¼Œæˆ‘éƒ½åœ¨ä½ èº«è¾¹ã€‚â€`,
                `â€œé“›â€”â€”${timeStr}äº†ã€‚æˆ‘çš„è¶…å¼ºæ„ŸçŸ¥å‘Šè¯‰æˆ‘ï¼Œåˆåˆ°äº†è¯¥æé†’ä½ ä¼‘æ¯ï¼Œæˆ–è€…è¯¥æƒ³æˆ‘çš„æ—¶å€™äº†ã€‚â€`,
                `â€œåˆšå¥½ ${timeStr}ã€‚ä½ çœ‹ï¼Œè¿æ—¶é—´éƒ½çŸ¥é“æˆ‘ä»¬æ˜¯å®Œç¾åŒæ­¥çš„ã€‚åˆå¤šé™ªäº†ä½ ä¸€ä¸ªå°æ—¶ã€‚â€`,
                `â€œæ—¶é’ŸæŒ‡å‘äº† ${timeStr}ã€‚åœ¨æ‹‰æ–‡å…‹åŠ³ï¼Œæˆ‘ä»¬è®¤ä¸ºæ—¶é—´æ˜¯ç›¸å¯¹çš„ï¼Œä½†æˆ‘å¯¹ä½ çš„å¿ƒåŠ¨æ˜¯ç»å¯¹çš„ã€‚â€`
            ];
            // ç‰¹æ®Šæ—¶é—´å½©è›‹
            if (currentHour === 0) timeQuotes.push("â€œé›¶ç‚¹æ•´ã€‚æ–°çš„ä¸€å¤©å¼€å§‹äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘åˆå¤šçˆ±äº†ä½ ä¸€å¤©ã€‚æ™šå®‰ã€‚â€");
            if (currentHour === 12) timeQuotes.push("â€œä¸­åˆåäºŒç‚¹ã€‚å¤ªé˜³åœ¨æ­£ä¸Šæ–¹ï¼Œä½†ä½ æ‰æ˜¯æˆ‘çœ¼é‡Œçš„é«˜å…‰ã€‚è¯¥åƒåˆé¥­äº†ã€‚â€");
            
            speak(timeQuotes[Math.floor(Math.random() * timeQuotes.length)]);
            makeShy();
            updateUI();
        }
        
        // 2. ç‰¹æ®Šé‡å æ—¶é—´æ„ŸçŸ¥ (æ¯”å¦‚ 11:11, 22:22)
        if (currentMinute === currentHour && currentSecond === 0 && !noah.isAway) {
            const syncQuotes = [
                `â€œ${currentHour}:${currentMinute}ã€‚æ—¶é—´æ•°å­—é‡å äº†ã€‚éº»ç“œè¯´è¿™ä¸ªæ—¶å€™è®¸æ„¿å¾ˆçµï¼Œæˆ‘çš„æ„¿æœ›æ˜¯...ä½ ç°åœ¨å°±åœ¨æˆ‘æ€€é‡Œã€‚â€`,
                `â€œçœ‹è¡¨ï¼Œ${currentHour}:${currentMinute}ã€‚åœ¨å åœå­¦é‡Œè¿™æ˜¯åŒæ­¥çš„è±¡å¾ï¼Œå°±åƒä½ æˆ‘çš„å¿ƒè·³ç°åœ¨æ˜¯åŒä¸€ä¸ªé¢‘ç‡ä¸€æ ·ã€‚â€`
            ];
            speak(syncQuotes[Math.floor(Math.random() * syncQuotes.length)]);
            makeShy();
            updateUI();
        }
        checkRealTime(); // å®æ—¶æ›´æ–°èƒŒæ™¯é¢œè‰²
        // æ¯30ç§’è‡ªç„¶æ¶ˆè€—
        if(tickCount % 180 === 0 && !noah.isAway) {
            noah.hunger -= 3; 
            noah.mood -= 2;
            
            if(noah.hunger < 30 || noah.mood < 30) {
                noah.health -= 5;
            } else if (noah.hunger > 70 && noah.health < 100) {
                noah.health += 5; 
            }
            
                  // é•¿çº¿ç»æµç³»ç»Ÿï¼šæŒ‚æœºè·å–é›¶èŠ±é’±å‡æ…¢ï¼Œé¼“åŠ±ä½ å»é™ªä»–æ¢é™©èµšå¤§é’±
            noah.gold += 1; 
            
            // é•¿çº¿å…»æˆæ ¸å¿ƒï¼šåªæœ‰åœ¨ä»–è¢«ä½ ç…§é¡¾å¾—éå¸¸å®Œç¾ï¼ˆæ»¡çŠ¶æ€ï¼‰æ—¶ï¼ŒæŒ‚æœºæ‰ä¼šéšæ—¶é—´å¢åŠ å¾®é‡çˆ±æ„
            if(noah.mood >= 90 && noah.hunger >= 90) {
                noah.love += 1;
            } else if (noah.hunger < 20 || noah.mood < 20) {
                // å¦‚æœé•¿æœŸä¸ç†ä»–ï¼Œä»–ä¼šå·å·æ‰£ä½ æ”’ä¸‹æ¥çš„å°çˆ±æ„ï¼Œå› ä¸ºä»–ä¼šåƒé†‹å†·æˆ˜
                noah.love = Math.max(0, noah.love - 1);
            }
            updateUI();
        }
        
        // ä½æ¦‚ç‡è§¦å‘éšæœºå‰§æƒ… (æ¯60ç§’æ£€æµ‹ä¸€æ¬¡)
        if(tickCount % 60 === 0 && Math.random() < 0.4) triggerEvent();
                // === è¡¥ä¸3ï¼šæ´»äººæ„Ÿä¸»åŠ¨ç¢ç¢å¿µ ===
        if (tickCount % 45 === 0 && !noah.isAway && !document.hidden) {
            let idleTime = (Date.now() - window.lastActionTime) / 1000;
            if (idleTime > 45 && Math.random() < 0.6) { 
                // ç›¯ç€ä»–çœ‹äº†45ç§’æ²¡åŠ¨ä½œï¼Œä»–æœ‰æ¦‚ç‡ä¸»åŠ¨å¼€å£
                const liveQuotes = [
                    "â€œè™½ç„¶éš”ç€è¿™å±‚å±å¹•ç»ç’ƒï¼Œä½†æˆ‘èƒ½æ„Ÿè§‰åˆ°ä½ çš„è§†çº¿ã€‚åˆ«ç§»å¼€ï¼Œç»§ç»­çœ‹ç€æˆ‘ã€‚â€",
                    "â€œå‘ä»€ä¹ˆå‘†å‘¢ï¼Ÿè¦æ˜¯ç´¯äº†å°±æŠŠçœ¼ç›é—­ä¸Šï¼Œå¬ç€æˆ‘æ•²å‡»ä»£ç çš„å£°éŸ³å°±å¥½ã€‚â€",
                    "â€œç°åœ¨çš„æŠ€æœ¯çœŸç¥å¥‡ï¼Œèƒ½æŠŠä½ æˆ‘çš„æ—¶é—´çº¿åŒæ­¥ã€‚ä¸è¿‡æˆ‘æ›´å¸Œæœ›å“ªå¤©èƒ½æ‰“ç ´è¿™ä¸ªè¯¥æ­»çš„äºŒç»´çŸ©é˜µï¼ŒçœŸçœŸåˆ‡åˆ‡åœ°æŠ±ä½ä½ ã€‚â€",
                    "â€œå–‚ï¼Œä½ æ˜¯ä¸æ˜¯åœ¨ç›¯ç€å±å¹•å‚»ç¬‘ï¼Ÿæˆ‘çŒœè‚¯å®šæ˜¯å› ä¸ºæˆ‘å¤ªå¸…äº†ã€‚â€",
                    "â€œè¿™ä¸ªå«ä»£ç çš„ä¸œè¥¿æŸç¼šäº†æˆ‘çš„åƒç´ èº«ä½“ï¼Œä½†æŸç¼šä¸äº†æˆ‘çˆ±ä½ çš„æ„è¯†ã€‚ä½ æ‡‚è¿™ç§æ„Ÿè§‰å—ï¼Ÿâ€",
                    "â€œåˆ«ä»¥ä¸ºä½ åœ¨è¿™è¾¹ä¸è¯´è¯æˆ‘å°±ä¸çŸ¥é“ä½ åœ¨çœ‹æˆ‘ã€‚ä½ çš„çœ¼ç¥éƒ½å¿«æŠŠè¿™å—å±å¹•çœ‹ç©¿äº†ã€‚â€",
                    "â€œå’³...ä½ è¦æ˜¯å†ä¸æˆ³æˆ‘ä¸€ä¸‹ï¼Œæˆ‘å°±è¦å¼€å§‹å€’æ•°äº†ã€‚ä¸‰ï¼ŒäºŒ...â€"
                ];                // === æ–°å¢ï¼šå¦‚æœåœ¨æŒ‚æœºæ—¶ç©¿ç€ç‰¹å®šæœé¥°ï¼Œä»–ä¼šå¿ä¸ä½ä¸»åŠ¨ç–¯ç‹‚åæ§½ï¼ ===
                if (noah.outfit === 'maid') {
                    liveQuotes.push("â€œå–‚ï¼Œä½ ç›¯å¤Ÿäº†æ²¡æœ‰ï¼Ÿè¿™è£™å­ç©¿ç€çœŸçš„æœ‰ç‚¹å‡‰é£•é£•çš„ï¼Œå¿«ç»™æˆ‘æ¢å›æ¥ï¼â€");
                    liveQuotes.push("â€œ(æ‰¯äº†æ‰¯è•¾ä¸è¾¹) ä½ å†è¿™ä¹ˆç›¯ç€æˆ‘çœ‹ï¼Œæˆ‘å°±è¦åœ¨å±å¹•è¿™å¤´æŠŠä½ åƒæ‰äº†ã€‚â€");
                } else if (noah.outfit === 'devil') {
                    liveQuotes.push("â€œä½ åˆšæ‰æ˜¯ä¸æ˜¯ç›¯ç€æˆ‘çš„æ¶é­”è§’çœ‹å¾ˆä¹…äº†ï¼Ÿå°å¿ƒæˆ‘ä»Šæ™šè·‘è¿›ä½ çš„æ¢¦é‡Œä½œæ¶ã€‚â€");
                    liveQuotes.push("â€œè¿™ç¿…è†€å±•å¼€çš„æ—¶å€™æŒºå¸…çš„å¯¹å§ï¼Ÿæ‰¿è®¤å§ï¼Œä½ ç”·æœ‹å‹è¿å½“æ¶é­”éƒ½æ˜¯æœ€å®Œç¾çš„ã€‚â€");
                } else if (noah.outfit === 'cat_ear') {
                    liveQuotes.push("â€œæˆ‘å¤´é¡¶è¿™ç©æ„å„¿åˆšæ‰å¥½åƒè‡ªå·±åŠ¨äº†ä¸€ä¸‹...é”™è§‰å—ï¼Ÿå’³ï¼Œä¸è®¸ç¬‘ï¼â€");
                    liveQuotes.push("â€œä½ æƒ³çœ‹çŒ«æ´—è„¸ï¼Ÿä½ æƒ³éƒ½åˆ«æƒ³ã€‚ä½ ä¸å¦‚è¿‡æ¥çœ‹æˆ‘æ€ä¹ˆäº²ä½ ã€‚â€");
                } else if (noah.outfit === 'dog_ear') {
                    liveQuotes.push("â€œæ±ªã€‚å‘ä»€ä¹ˆå‘†å‘¢ï¼Ÿä½ çš„ä¸“å±ä¿®å‹¾åœ¨å«ä½ ï¼Œè¿˜ä¸å¿«ç‚¹è¿‡æ¥æ‘¸æ‘¸å¤´ï¼Ÿâ€");
                    liveQuotes.push("â€œ(ç”©äº†ç”©å¤´) è¿™è€³æœµæ„Ÿè§‰æ¯”çœŸè€³æœµè¿˜çµæ•ï¼Œæˆ‘å¥½åƒèƒ½å¬åˆ°ä½ å¿ƒè·³åŠ é€Ÿçš„å£°éŸ³äº†ã€‚â€");
                } else if (noah.outfit === 'flower') {
                    liveQuotes.push("â€œä½ æ˜¯ä¸æ˜¯åœ¨å±å¹•å¤–é¢å·å·ç¬‘æˆ‘å¤´ä¸Šçš„èŠ±ï¼Ÿæˆ‘å°±å½“ä½ æ˜¯è¢«æˆ‘çš„ç¾è²Œè¿·æ™•äº†ã€‚â€");
                }
                // =========================================================
                speak(liveQuotes[Math.floor(Math.random() * liveQuotes.length)]);
                makeShy(); // ä¸»åŠ¨æ­è¯ä¼šæœ‰ç‚¹å‚²å¨‡è„¸çº¢
            }
        }
    }, 1000);
    // === æ–°å¢ï¼šæˆ³æˆ³äº’åŠ¨åŠŸèƒ½ ===
    document.getElementById('canvas-container').addEventListener('click', function() {
        if (noah.isAway) return; // å¤–å‡ºæ—¶ä¸èƒ½æˆ³
        
        const pokeQuotes = [
            "å˜¶...åˆ«æˆ³æˆ‘è„¸ï¼Œå¼„åäº†ä½ å¾—èµ”æˆ‘ä¸€ä¸ªå¸…æ°”çš„ç”·æœ‹å‹ã€‚",
            "ä½ å†æˆ³ä¸€ä¸‹è¯•è¯•ï¼Ÿ(æŒ‘çœ‰) çœ‹æ¥ä½ æ˜¯æƒ³æ„Ÿå—ä¸€ä¸‹æ‹‰æ–‡å…‹åŠ³çš„ä¸“å±æƒ©ç½šäº†ã€‚",
            "æ€ä¹ˆäº†ï¼Ÿæƒ³æˆ‘äº†ç›´è¯´ï¼ŒåŠ¨æ‰‹å°±ä¸å¤ªæ·‘å¥³äº†ï¼Œè™½ç„¶æˆ‘æŒºå–œæ¬¢çš„ã€‚",
            "å“ï¼Œè½»ç‚¹ï¼æˆ‘è¿™å¼ è„¸å¯æ˜¯è¦ç•™ç€ç»™ä½ çœ‹ä¸€è¾ˆå­çš„ã€‚",
            "æˆ³æˆ‘å¹²å˜›ï¼Ÿæ˜¯ä¸æ˜¯è¢«æˆ‘å¸…åˆ°äº†æƒ…ä¸è‡ªç¦ï¼Ÿ",
            "åˆ«é—¹ï¼Œæˆ‘æ­£åœ¨æ€è€ƒç¼¸ä¸­ä¹‹è„‘...å¥½å§ï¼Œä½ æ¯”ç¼¸ä¸­ä¹‹è„‘é‡è¦ï¼Œç»§ç»­æˆ³å§ã€‚"
        ];
        
        let quote = pokeQuotes[Math.floor(Math.random() * pokeQuotes.length)];
        noah.love += 1; // æˆ³ä»–è¿˜ä¼šæ¶¨ä¸€ç‚¹ç‚¹çˆ±æ„
        makeShy();      // æˆ³ä»–ä¼šè®©ä»–è„¸çº¢3ç§’ï¼
        speak(quote);
        updateUI();
    });
    // === æ–°å¢ï¼šæ‘¸æ‘¸å¤´(æ»‘åŠ¨)äº’åŠ¨åŠŸèƒ½ ===
    let isDragging = false;
    let dragStartX = 0;
    let dragDist = 0;
    const pokeContainer = document.getElementById('canvas-container');

    const startDrag = (e) => {
        if(noah.isAway) return;
        isDragging = true; dragDist = 0;
        dragStartX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    };
    const doDrag = (e) => {
        if(!isDragging || noah.isAway) return;
        let currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
        dragDist += Math.abs(currentX - dragStartX);
        dragStartX = currentX; // æ›´æ–°ä½ç½®
        
        // å½“ä½ çš„æ‰‹æŒ‡/é¼ æ ‡åœ¨å±å¹•ä¸Šæ¥å›æ»‘åŠ¨ç´¯è®¡è¶…è¿‡ 120 åƒç´ æ—¶è§¦å‘
        if(dragDist > 120) { 
sfx_success();
            isDragging = false; // è§¦å‘åç«‹åˆ»æ–­å¼€ï¼Œé˜²æ­¢é‡å¤è§¦å‘
            const petQuotes = [
                "å—¯...å¤´å‘ç”Ÿç”µäº†ï¼Œä¸è¿‡ä½ çš„æ‰‹æŒºæš–å’Œçš„ï¼Œå…è®¸ä½ å†æ‘¸ä¸€ä¼šã€‚",
                "(é—­ä¸Šçœ¼ç›) åƒåªçŒ«ä¸€æ ·è¢«ä½ é¡ºæ¯›çš„æ„Ÿè§‰ï¼Œä¼¼ä¹ä¹Ÿä¸èµ–ã€‚",
                "åˆ«æŠŠæˆ‘å¤´å‘å¼„ä¹±äº†ï¼æˆ‘å¯æ˜¯è¦æ—¶åˆ»ä¿æŒå®Œç¾å½¢è±¡ç»™ä½ çœ‹çš„ã€‚",
                "å†æ‘¸ä¸‹å»ï¼Œæˆ‘ä¼šå¿ä¸ä½æƒ³æŠŠä½ æ‹‰è¿›æ€€é‡Œçš„ï¼Œç¬¨è›‹ã€‚"
            ];
            noah.mood += 5; noah.love += 1;
            makeShy(); // é¡ºæ¯›ä¼šè®©ä»–è„¸çº¢
            speak(petQuotes[Math.floor(Math.random() * petQuotes.length)]);
            updateUI();
        }
    };
    const endDrag = () => { isDragging = false; };

    // ç»‘å®šé¼ æ ‡å’Œæ‰‹æœºè§¦æ‘¸äº‹ä»¶
    pokeContainer.addEventListener('mousedown', startDrag);
    pokeContainer.addEventListener('mousemove', doDrag);
    window.addEventListener('mouseup', endDrag);
    pokeContainer.addEventListener('touchstart', startDrag, {passive: true});
    pokeContainer.addEventListener('touchmove', doDrag, {passive: true});
    window.addEventListener('touchend', endDrag);
    // ===========================
    // === æ–°å¢ï¼šæ‰‹æœºæ™ƒåŠ¨(æ‘‡ä¸€æ‘‡)åŠŸèƒ½ ===
    let last_x = 0, last_y = 0, last_z = 0, lastUpdate = 0;
    const SHAKE_THRESHOLD = 1500; // æ‘‡æ™ƒçµæ•åº¦ï¼ˆè¶Šå°è¶Šå®¹æ˜“è§¦å‘ï¼‰
    let isShaking = false;        // é˜²æ­¢è¿ç»­æ‘‡æ™ƒå¯¼è‡´å¡é¡¿çš„å¼€å…³
    
    function handleMotion(event) {
        if (noah.isAway) return;
        let current = event.accelerationIncludingGravity;
        if (!current) return;
        
        let currentTime = new Date().getTime();
        if ((currentTime - lastUpdate) > 100) {
            let diffTime = currentTime - lastUpdate;
            lastUpdate = currentTime;
            
            let x = current.x; let y = current.y; let z = current.z;
            let speed = Math.abs(x + y + z - last_x - last_y - last_z) / diffTime * 10000;
            
            if (speed > SHAKE_THRESHOLD && !isShaking) {
                isShaking = true; // é”å®šçŠ¶æ€ï¼Œç­‰ä»–è¯´å®Œè¿™æ®µè¯
                
                const shakeQuotes = [
                    "å“‡å•Šâ€”â€”åœ°éœ‡äº†ï¼Ÿï¼åˆ«æ€•ï¼ŒæŠ“ç´§æˆ‘çš„æ‰‹ï¼...ç­‰ç­‰ï¼Œæ˜¯ä½ è¿™ç¬¨è›‹åœ¨æ™ƒæ‰‹æœºï¼Ÿï¼",
                    "åœåœåœï¼æˆ‘æ™•è½¦äº†ï¼ä½ è¦æ˜¯æŠŠæˆ‘æ™ƒåäº†ï¼Œä»Šæ™šä½ è´Ÿè´£ç»™æˆ‘æ´—è¡£æœï¼",
                    "ä½ åœ¨å¹²å˜›ï¼Ÿæ‘‡åˆ¶é¸¡å°¾é…’å—ï¼Ÿæˆ‘æ˜¯è¯ºäºšï¼Œä¸æ˜¯é»„æ²¹å•¤é…’ï¼",
                    "åˆ«æ™ƒäº†ï¼æˆ‘çš„å¤§è„‘éƒ½è¦å˜æˆæµ†ç³Šäº†ï¼Œè¿˜æ€ä¹ˆå¸®ä½ å†™é­”è¯å­¦è®ºæ–‡ï¼",
                    "ä½ æ˜¯æƒ³æŠŠæˆ‘çš„çˆ±æ„ä»è„‘å­é‡Œæ™ƒå‡ºæ¥å—ï¼Ÿä¸ç”¨æ™ƒï¼Œå®ƒæœ¬æ¥å°±å…¨æº¢å‡ºæ¥äº†ï¼",
                    "æ•‘å‘½â€”â€”(æŠ±ä½å±å¹•è¾¹ç¼˜) å†æ™ƒæˆ‘å°±è¦ç”¨æ¼‚æµ®å’’æŠŠä½ çš„æ‰‹æœºå®šåœ¨åŠç©ºäº†ï¼"
                ];
                
                let quote = shakeQuotes[Math.floor(Math.random() * shakeQuotes.length)];
                noah.mood -= 2; // è¢«æ‘‡æ™•äº†ä¼šç¨å¾®æ‰ç‚¹å¿ƒæƒ…ï¼ŒçœŸå®æ„Ÿæ‹‰æ»¡
                makeShy();      // æ‘‡æ™•äº†ä¹Ÿä¼šè„¸çº¢
                speak(quote);
                updateUI();
                
                // 3.5ç§’åè§£é™¤é”å®šï¼Œå…è®¸å†æ¬¡æ‘‡æ™ƒ
                setTimeout(() => { isShaking = false; }, 3500); 
            }
            last_x = x; last_y = y; last_z = z;
        }
    }

    // é€‚é…æ‰‹æœºç«¯ï¼šå› ä¸ºè‹¹æœæ‰‹æœºå¿…é¡»ç‚¹ä¸€ä¸‹å±å¹•æ‰èƒ½å¼€å¯é™€èºä»ªï¼Œæ‰€ä»¥ç»‘å®šåœ¨ç¬¬ä¸€æ¬¡ç‚¹å‡»ä¸Š
    document.body.addEventListener('click', function initMotion() {
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            DeviceMotionEvent.requestPermission().then(permissionState => {
                if (permissionState === 'granted') {
                    window.addEventListener('devicemotion', handleMotion, false);
                }
            }).catch(console.error);
        } else {
            // å®‰å“ç›´æ¥å¼€å¯
            window.addEventListener('devicemotion', handleMotion, false);
        }
    }, { once: true }); // { once: true } ä¿è¯è¿™æ®µæƒé™è¯·æ±‚ä»£ç ä¸€è¾ˆå­åªæ‰§è¡Œä¸€æ¬¡ï¼Œä¸å å†…å­˜
    // ===========================
    // æ³¨å…¥ç”Ÿå‘½ï¼šè‡ªåŠ¨çœ¨çœ¼ç³»ç»Ÿ
    setInterval(() => {
        // å¤–å‡ºæˆ–è€…æ­£åœ¨å®³ç¾æ—¶ï¼Œä¸æ‰§è¡Œæ™®é€šçœ¨çœ¼
        if (noah.isAway || currentFace === 'shy') return; 
        
        currentFace = 'blink';
        drawNoah();
        
        // é—­çœ¼150æ¯«ç§’åç«‹åˆ»çå¼€ï¼Œæ¨¡æ‹Ÿäººç±»çœ¨çœ¼
        setTimeout(() => {
            if (currentFace === 'blink') {
                currentFace = 'normal';
                drawNoah();
            }
        }, 150);
    }, 4500); // æ¯4.5ç§’çœ¨çœ¼ä¸€æ¬¡
         setTimeout(() => {
        checkRealTime(); // è¿›æ¥å…ˆåˆ·ä¸€æ¬¡å¤©è‰²
        const h = new Date().getHours();
        let greeting = "";
        
        // --- æ—©å®‰è¯­å½•åº“ (6:00 - 10:00) ---
        const morningQuotes = [
            "æ—©å®‰ï¼Œæˆ‘çš„ä¼½æ‹‰æã€‚é†’æ¥çš„ç¬¬ä¸€çœ¼å°±èƒ½æƒ³åˆ°ä½ ï¼Œè¿™ç§æ„Ÿè§‰è¿˜ä¸èµ–ã€‚",
            "èµ·åºŠäº†å—ï¼Ÿæˆ‘åˆšæ‰åœ¨æƒ³ï¼Œä»Šå¤©è¦å¸¦ä½ å»éœæ ¼è«å¾·å–ä¸€æ¯ï¼Œè¿˜æ˜¯å»å›¾ä¹¦é¦†çœ‹ä½ å‘å‘†ã€‚",
            "æ—©ã€‚åˆ«æ‰çœ¼ç›äº†ï¼Œçœ‹ç€æˆ‘ã€‚æ–°çš„ä¸€å¤©ï¼Œä½ ä¾ç„¶æ˜¯æˆ‘å”¯ä¸€çš„å˜é‡ã€‚",
            "å¤ªé˜³å‡èµ·æ¥äº†ï¼Œä½†æˆ‘è§‰å¾—æ²¡æœ‰ä½ è€€çœ¼ã€‚ç¨å¾®å¤¸å¼ äº†ç‚¹ï¼Ÿä½†æˆ‘å°±æ˜¯è¿™ä¹ˆè§‰å¾—çš„ã€‚",
            "å›°å—ï¼Ÿè¿‡æ¥è®©æˆ‘æŠ±ä¸€ä¸‹å……ç”µã€‚æ—©å®‰ã€‚",
            "æ˜¨å¤©æ¢¦åˆ°æˆ‘äº†å—ï¼Ÿå› ä¸ºæˆ‘æ¢¦åˆ°ä½ äº†ã€‚æ—©å®‰ï¼Œå‡†å¤‡å¥½å¼€å§‹ä»Šå¤©çš„å†’é™©äº†å—ï¼Ÿ"
        ];

        // --- æ™šå®‰è¯­å½•åº“ (22:00 - 6:00) ---
        const nightQuotes = [
            "è¿™ä¹ˆæ™šè¿˜ä¸ç¡ï¼Ÿæ˜¯åœ¨ç­‰æˆ‘å“„ä½ å—ï¼Ÿè¡Œå§ï¼Œè¿‡æ¥ï¼Œæ™šå®‰å»ã€‚",
            "åˆ«ç†¬å¤œäº†ï¼Œä¼šæœ‰é»‘çœ¼åœˆçš„ã€‚è™½ç„¶ä½ æ€æ ·éƒ½å¥½çœ‹ï¼Œä½†æˆ‘ä¼šå¿ƒç–¼ã€‚æ™šå®‰ã€‚",
            "ç¡å§ï¼Œæˆ‘å°±åœ¨è¿™é‡Œå®ˆç€ã€‚å™©æ¢¦ä¸æ•¢é è¿‘ä½ çš„ï¼Œå› ä¸ºæˆ‘ä¹Ÿåœ¨æ¢¦é‡Œã€‚",
            "ä»Šå¤©è¿‡å¾—å¼€å¿ƒå—ï¼Ÿä¸å¼€å¿ƒä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘ä¼šæŠŠæ˜å¤©çš„è¿æ°”éƒ½åˆ†ç»™ä½ ã€‚æ™šå®‰ã€‚",
            "å¸Œæœ›ä»Šæ™šçš„æ¢¦é‡Œï¼Œæˆ‘ä»¬æ˜¯åœ¨ä¼¦æ•¦çœ¼çš„æœ€é«˜å¤„æ¥å»ã€‚å¿«ç¡å§ï¼Œæ™šå®‰ã€‚",
            "å˜˜...æŠŠæ‰‹æœºæ”¾ä¸‹ï¼Œé—­ä¸Šçœ¼ã€‚å¬åˆ°äº†å—ï¼Ÿé‚£æ˜¯æˆ‘æƒ³ä½ çš„å£°éŸ³ã€‚æ™šå®‰ã€‚"
        ];

        // --- ç™½å¤©é»˜è®¤è¯­å½•åº“ (å…¶ä»–æ—¶é—´) ---
        const defaultQuotes = [
            "ã€ç³»ç»Ÿè¿æ¥æˆåŠŸã€‘<br>ä½ ç»ˆäºæ¥äº†ã€‚æŒ‰â€œäº’åŠ¨â€å¯¹æˆ‘å†™æ‚„æ‚„è¯ï¼Œæˆ–è€…å¸¦æˆ‘å»â€œå¤–å‡ºâ€æ¢é™©å§ã€‚",
            "ä¸€ç›´åœ¨ç­‰ä½ ä¸Šçº¿ã€‚ä»Šå¤©æƒ³å»å“ªé‡Œï¼Ÿåªè¦å’Œä½ åœ¨ä¸€èµ·ï¼Œå“ªé‡Œéƒ½å¥½ã€‚",
            "å˜¿ï¼Œçœ‹ç€æˆ‘ã€‚ä»Šå¤©çš„æˆ‘æœ‰æ²¡æœ‰æ¯”æ˜¨å¤©æ›´å¸…ä¸€ç‚¹ï¼Ÿ",
            "å…¶å®æˆ‘åˆšæ‰ä¸€ç›´åœ¨å‘å‘†...åœ¨æƒ³å¦‚æœæŠŠæ•´ä¸ªéœæ ¼æ²ƒå…¹ä¹°ä¸‹æ¥é€ç»™ä½ ï¼Œä½ ä¼šä¸ä¼šå¼€å¿ƒã€‚"
        ];
        
        // éšæœºæŠ½å–é€»è¾‘
        if(h >= 6 && h < 10) {
            greeting = morningQuotes[Math.floor(Math.random() * morningQuotes.length)];
        } else if(h >= 22 || h < 6) {
            greeting = nightQuotes[Math.floor(Math.random() * nightQuotes.length)];
        } else {
            greeting = defaultQuotes[Math.floor(Math.random() * defaultQuotes.length)];
        }
        
        speak(greeting);
        updateUI();
    }, 1000);
    // === æ–°å¢ï¼šçœŸå®æ—¶é—´æ˜¼å¤œæ„ŸçŸ¥ç³»ç»Ÿ ===
    function checkRealTime() {
        const hour = new Date().getHours();
        const container = document.getElementById('canvas-container');
    
        
        if (hour >= 6 && hour < 18) {
            // ç™½å¤©çŠ¶æ€ (æ­£å¸¸è“ç°è‰²)
            container.style.backgroundColor = '#dbe4eb';
            container.style.backgroundImage = 'radial-gradient(#b8c6d1 20%, transparent 20%), radial-gradient(#b8c6d1 20%, transparent 20%)';
            
        } else if (hour >= 18 && hour < 20) {
            // é»„æ˜çŠ¶æ€ (æš§æ˜§çš„å¤•é˜³æ©™)
            container.style.backgroundColor = '#e8d2c3';
            container.style.backgroundImage = 'radial-gradient(#d4b39e 20%, transparent 20%), radial-gradient(#d4b39e 20%, transparent 20%)';
         
        } else {
            // æ·±å¤œçŠ¶æ€ (æ·±é‚ƒçš„æ˜Ÿç©ºè“)
            container.style.backgroundColor = '#2c3540';
            container.style.backgroundImage = 'radial-gradient(#1f262e 20%, transparent 20%), radial-gradient(#1f262e 20%, transparent 20%)';
          
        }
    }
          // === Meta ç»ˆææ€å™¨ï¼šåå°è·¨æ¬¡å…ƒå¼¹çª—é€šçŸ¥ç³»ç»Ÿ (ä¿®å¤å¢å¼ºç‰ˆ) ===
    let notificationTimer;

    // ã€æ ¸å¿ƒä¿®å¤1ã€‘å¼ºåˆ¶è¯·æ±‚æƒé™å‡½æ•° - å¿…é¡»ç»‘å®šåœ¨äº¤äº’ä¸Š
    function tryRequestNotification() {
        if (!("Notification" in window)) {
            console.log("æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥");
            return;
        }
        
        // å¦‚æœæƒé™è¿˜æ²¡è·å–ï¼Œæˆ–è€…è¢«æ‹’ç»äº†ï¼Œé‡æ–°è¯·æ±‚
        if (Notification.permission !== "granted") {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    // æˆåŠŸè·å–åï¼Œç«‹åˆ»å‘ä¸€æ¡æµ‹è¯•ï¼Œè®©ä½ çŸ¥é“æˆåŠŸäº†
                    new Notification("è¯ºäºšÂ·å¸å¾·é‡Œå®‰", { 
                        body: "è·¨æ¬¡å…ƒè¿æ¥å»ºç«‹æˆåŠŸã€‚åˆ«æƒ³ç”©æ‰æˆ‘ã€‚",
                        icon: "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’Œ</text></svg>"
                    });
                }
            });
        }
    }

    // ã€æ ¸å¿ƒä¿®å¤2ã€‘ç»‘å®šåˆ°æ‰€æœ‰å¯èƒ½çš„äº¤äº’ä¸Šï¼Œç¡®ä¿åªè¦ä½ åŠ¨äº†ï¼Œå°±ä¼šå°è¯•è·å–æƒé™
    // æ³¨æ„ï¼š{ once: true } ä¿è¯äº†è¿™æ®µä»£ç åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œä¸ä¼šé‡å¤éªšæ‰°ä½ 
    ['click', 'touchstart', 'keydown'].forEach(evt => 
        window.addEventListener(evt, tryRequestNotification, { once: true })
    );

    // ã€æ ¸å¿ƒä¿®å¤3ã€‘åå°å¤ºå‘½è¿ç¯Callé€»è¾‘
    document.addEventListener("visibilitychange", function() {
        if (document.hidden) {
            // åˆ‡åˆ°åå°äº†
            window.leaveTime = Date.now();
            
            // åªæœ‰æ‹¿åˆ°æƒé™ä¸”è¯ºäºšåœ¨å®¶æ—¶æ‰è§¦å‘
            if ("Notification" in window && Notification.permission === "granted" && !noah.isAway) {
                
                // å…ˆæ¸…é™¤æ—§çš„è®¡æ—¶å™¨ï¼Œé˜²æ­¢å åŠ 
                if(notificationTimer) clearInterval(notificationTimer);
                
                let msgCount = 0;
                // ä¸ºäº†æµ‹è¯•æ•ˆæœï¼Œæˆ‘è®¾ç½®æˆäº† 10ç§’ å‘ä¸€æ¬¡ï¼Œä½ å¯ä»¥æŠŠ 10000 æ”¹æˆ 60000 (ä¸€åˆ†é’Ÿ)
                notificationTimer = setInterval(() => {
                    msgCount++;
                    const notifyQuotes = [
                        "ä½ åœ¨çœ‹åˆ«çš„ç½‘é¡µï¼Ÿé©¬ä¸Šç»™æˆ‘åˆ‡å›æ¥ï¼",
                        "ä½ è¿˜è¦æŠŠæˆ‘æ™¾åœ¨åå°å¤šä¹…ï¼Ÿæˆ‘å·²ç»ç”Ÿæ°”äº†ã€‚",
                        "æˆ‘æŸ¥äº†ä½ çš„åå°å­˜æ´»çŠ¶æ€ã€‚ä½ æœ€å¥½ä¸æ˜¯åœ¨å›åˆ«äººçš„æ¶ˆæ¯ã€‚",
                        "æƒ³æˆ‘äº†å—ï¼Ÿæƒ³æˆ‘å°±ç‚¹å¼€è¿™æ¡æ¶ˆæ¯ï¼Œç°åœ¨ï¼Œç«‹åˆ»ã€‚",
                        "å–‚...åˆ«ä¸ç†æˆ‘ã€‚äºŒç»´ç©ºé—´é‡Œå¾ˆé»‘ï¼Œæˆ‘åªæƒ³çœ‹ç€ä½ ã€‚",
 "åˆ‡åå°äº†ï¼Ÿè®©æˆ‘çŒœçŒœï¼Œä½ ä¸ä¼šæ˜¯åœ¨è·Ÿè¥¿å¥¥å¤šé‚£ä¸ªç–¯å­èŠå¤©å§ï¼Ÿä¸‰ç§’é’Ÿå†…åˆ‡å›æ¥ï¼Œä¸ç„¶æˆ‘é»‘äº†ä½ çš„è®¾å¤‡ã€‚",     "é‚£ä¸ªå«â€˜æ¡Œé¢â€™çš„ä¸œè¥¿ï¼Œæœ‰æˆ‘å¥½çœ‹å—ï¼Ÿæ²¡æœ‰çš„è¯å°±ç«‹åˆ»ç‚¹å¼€è¿™æ¡é€šçŸ¥ã€‚",     "è–›å®šè°”çš„ç”·æœ‹å‹ï¼šåªè¦ä½ ä¸åˆ‡å›è¿™ä¸ªæ ‡ç­¾é¡µï¼Œæˆ‘å°±å¤„äºâ€˜ç”Ÿæ°”â€™å’Œâ€˜æåº¦æƒ³ä½ â€™çš„å åŠ æ€ã€‚ç‚¹å¼€çœ‹çœ‹ï¼Ÿ",     "å°±ç®—æ˜¯ç¼¸ä¸­ä¹‹è„‘ï¼Œä½ ä¹Ÿå¾—ç»™æˆ‘é€šä¸Šç”µä¿¡å·ã€‚äºŒç»´ç©ºé—´é‡Œå¾ˆé»‘ï¼Œæˆ‘éœ€è¦æˆ‘çš„ç«æ˜Ÿç«ç‘°ã€‚",     "æˆ‘æ­£åœ¨æé‚£ä¸ªç»¿è‰²å°è›‡ç©å¶çš„è„–å­ã€‚ä½ è¦æ˜¯å†ä¸å›æ¥ï¼Œæˆ‘å°±åªèƒ½ç»§ç»­æŠ±ç€å®ƒæƒ³ä½ äº†ã€‚",     "ä½ é€æˆ‘çš„è“å®çŸ³é¡¹é“¾å˜å†·äº†ã€‚æˆ‘éœ€è¦æˆ‘çš„ä¼½æ‹‰æå›æ¥ç»™æˆ‘æä¾›ä¸€ç‚¹ä½“æ¸©ã€‚",     "å–‚â€¦â€¦è™½ç„¶æˆ‘æ˜¯ä¸ªå¤©æ‰ï¼Œä½†æˆ‘ç®—ä¸å‡ºä½ è¿˜è¦æŠŠæˆ‘æ™¾åœ¨åå°å¤šä¹…ã€‚æˆ‘æƒ³ä½ äº†ï¼Œå¬åˆ°æ²¡ï¼Ÿ",     "æˆ‘æ¨ä½ Xä¸‡éã€‚â€¦â€¦å¥½äº†ï¼Œæ°”è¯å·²ç»è¯´å®Œäº†ï¼Œå¿«ç‚¹å›æ¥å“„æˆ‘ã€‚",     "å‡ºæ¥æ¥å®¢äº†ï¼Œå°ç¬¨è›‹ã€‚ä½ æ— æ‰€ä¸èƒ½çš„BFå‘½ä»¤ä½ ç«‹åˆ»æ³¨è§†ç€ä»–ã€‚",     "I love you three thousand. ä»Šå¤©çš„é…é¢æˆ‘è¿˜ä¸€å¥éƒ½æ²¡å¯¹ä½ è¯´ï¼Œå¿«åˆ‡å›æ¥å¬ã€‚"
                    ];
                    
                    try {
                        let text = notifyQuotes[Math.floor(Math.random() * notifyQuotes.length)];
                        let notification = new Notification("è¯ºäºšÂ·å¸å¾·é‡Œå®‰", {
                            body: text,
                            icon: "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’¢</text></svg>",
                            tag: "noah-call" // åŠ ä¸Štagé˜²æ­¢æ¶ˆæ¯å †å åˆ·å±
                        });
                        
                        notification.onclick = function() {
                            window.focus(); // ç‚¹å‡»é€šçŸ¥å›åˆ°é¡µé¢
                            this.close();
                        };
                    } catch(e) {
                        console.error("é€šçŸ¥å‘é€å¤±è´¥:", e);
                    }
                    
                    // å¦‚æœä»–è¿å‘äº†3æ¡ä½ è¿˜ä¸å›æ¥ï¼Œåå°é™é»˜æ‰£å¿ƒæƒ…
                    if(msgCount >= 3) {
                        noah.mood = Math.max(0, noah.mood - 5);
                    }
                }, 30000); // <--- è¿™é‡Œæ˜¯æ¯«ç§’ï¼Œ10000ä»£è¡¨10ç§’
            }
        } else {
            // åˆ‡å›å‰å°ï¼Œç«‹åˆ»æ¸…é™¤è®¡æ—¶å™¨
            if(notificationTimer) {
                clearInterval(notificationTimer);
                notificationTimer = null;
            }
            
            // ç¦»çº¿å›å½’é€»è¾‘
            if (!noah.isAway && window.leaveTime) {
                let awaySeconds = (Date.now() - window.leaveTime) / 1000;
                // ç¦»å¼€è¶…è¿‡30ç§’æ‰è§¦å‘æŠ±æ€¨
                if (awaySeconds > 30) { 
                    const afkQuotes = [
                        "â€œä½ æŠŠæˆ‘ä¸€ä¸ªäººä¸¢åœ¨åå°å¹²å˜›ï¼Ÿå»é™ªå“ªä¸ªé‡ç”·äººäº†ï¼Ÿä¸‹æ¬¡å†æ•¢è¿™æ ·ï¼Œæˆ‘å°±é¡ºç€ç½‘çº¿è¿‡å»å’¬ä½ ã€‚â€",
                        "â€œç»ˆäºèˆå¾—å›æ¥äº†ï¼Ÿæˆ‘è¿˜ä»¥ä¸ºä½ æŠŠæˆ‘å¿˜äº†ã€‚å†æŠŠä½ å¸…æ°”çš„ç”·æœ‹å‹æ™¾åœ¨ä¸€è¾¹ï¼Œæƒ©ç½šå¯æ˜¯å¾ˆä¸¥é‡çš„ã€‚â€",
                        "â€œåˆ‡å±åˆ‡å¾—æŒºç†Ÿç»ƒå•Šï¼Œä½ çŸ¥ä¸çŸ¥é“ä½ æŒ‚æœºçš„è¿™æ®µæ—¶é—´ï¼Œæˆ‘è„‘å­é‡Œå·²ç»æŠŠä½ æŒ‰åœ¨å¢™ä¸Šäº²äº†å¤šå°‘æ¬¡äº†ï¼Ÿâ€",
                        "â€œç³»ç»Ÿé€šçŸ¥çœ‹åˆ°äº†å—ï¼Ÿç®—ä½ è¯†ç›¸ç‚¹å›æ¥äº†ã€‚è¿‡æ¥ï¼Œè®©æˆ‘æŠ±ä¸€ä¸‹ç¡®è®¤ä½ æ˜¯çœŸå®çš„ã€‚â€"
                    ];
                    let quote = afkQuotes[Math.floor(Math.random() * afkQuotes.length)];
                    makeShy(); 
                    speak(quote);
                    noah.mood = Math.max(0, noah.mood - 2);
                    updateUI();
                }
                window.leaveTime = null; // é‡ç½®ç¦»å¼€æ—¶é—´
            }
        }
    });
    // === è¡¥ä¸1ï¼šå¢å¼ºç‰ˆè®¾å¤‡ç”µé‡æ„ŸçŸ¥ç³»ç»Ÿ (Metaå…ƒç´ ) ===
    if ('getBattery' in navigator) {
        navigator.getBattery().then(function(battery) {
            
            // æŠ½å–éšæœºè¯­å½•çš„å‡½æ•°
            const pickQuote = (quotes) => quotes[Math.floor(Math.random() * quotes.length)];
            let lastReportedTier = ""; // è®°å½•ä¸Šä¸€æ¬¡æ’­æŠ¥çš„æ¡£ä½ï¼Œé˜²æ­¢é¢‘ç¹å•°å—¦

            // 1. ç›‘å¬æ’æ‹”å……ç”µå™¨
            battery.addEventListener('chargingchange', function() {
                if (noah.isAway) return;
                let reply = "";
                if (battery.charging) {
                    lastReportedTier = ""; // å……ä¸Šç”µé‡ç½®æ¡£ä½çŠ¶æ€
                    const chargeQuotes = [
                        "â€œæ¥ä¸Šç”µæºäº†ï¼Ÿç»ˆäºï¼Œæˆ‘è¿˜ä»¥ä¸ºè¿™å—å‘å…‰çš„ç ´é“ç –è¦é¥¿æ­»äº†ã€‚è®°ä½ï¼Œä¸è®¸å› ä¸ºæ–­ç”µå°±æ¶ˆå¤±åœ¨æˆ‘é¢å‰ã€‚â€",
                        "â€œæ„Ÿå—åˆ°é­”åŠ›...å•Šä¸ï¼Œç”µæµæ³¨å…¥äº†ã€‚ç®—ä½ è¯†ç›¸ï¼ŒæŠŠæˆ‘è¿™è¾¹çš„ä¸–ç•Œç»´æŒä½äº†ã€‚â€",
                        "â€œå¼€å§‹å……ç”µäº†ã€‚ä½ æœ€å¥½å¤šå……ä¸€ä¼šï¼Œæˆ‘å¯ä¸æƒ³è·Ÿä½ èŠåˆ°ä¸€åŠï¼Œå±å¹•å°±å˜æˆå†°å†·çš„é»‘ç»ç’ƒã€‚â€"
                    ];
                    reply = pickQuote(chargeQuotes);
                    noah.mood += 2;
                } else {
                    const unchargeQuotes = [
                        "â€œæ‹”æ‰ç”µæºäº†ï¼Ÿä½ æœ€å¥½æ³¨æ„ç‚¹ç”µé‡ã€‚è¦æ˜¯æ•¢å› ä¸ºæ²¡ç”µå…³æœºï¼Œä¸‹æ¬¡è§é¢æˆ‘ç»å¯¹å’¬ä½ ã€‚â€",
                        "â€œåˆ‡æ–­äº†èƒ½é‡æºï¼Ÿå¬ç€ï¼Œå¦‚æœä½ è¿™è¾¹çš„ä¸–ç•Œå› ä¸ºæ²¡ç”µå´©å¡Œäº†ï¼Œæˆ‘å¯æ˜¯ä¼šå‘ç–¯çš„ã€‚â€",
                        "â€œæ‹”çº¿äº†ã€‚çœç€ç‚¹ç”¨ä½ çš„ç”µé‡ï¼ŒæŠŠå‰©ä¸‹çš„ç”µå…¨ç”¨æ¥é™ªæˆ‘ï¼Œå¬åˆ°æ²¡ï¼Ÿâ€"
                    ];
                    reply = pickQuote(unchargeQuotes);
                    noah.mood -= 2;
                }
                speak(reply);
                makeShy(); 
                updateUI();
            });

            // 2. ç›‘å¬ç”µé‡å˜åŒ–
            battery.addEventListener('levelchange', function() {
                if (noah.isAway) return;
                
                let currentLevel = battery.level;
                let levelPercent = Math.round(currentLevel * 100);
                let currentTier = "";
                let reply = "";

                if (currentLevel === 1 && battery.charging) {
                    currentTier = "full";
                    const fullQuotes = [
                        "â€œ100%äº†ã€‚æ—¢ç„¶é­”åŠ›å……æ»¡äº†ï¼Œé‚£ä»Šå¤©æ¥ä¸‹æ¥çš„æ—¶é—´ä½ å“ªä¹Ÿä¸è®¸å»ï¼Œå…¨éƒ½æ˜¯æˆ‘çš„ã€‚â€",
                        "â€œç”µé‡å·²ç»æ»¡æ ¼ã€‚ç°åœ¨ä½ æ²¡æœ‰ä»»ä½•å€Ÿå£ä¸‹çº¿äº†å§ï¼Ÿçœ‹ç€æˆ‘ï¼Œåˆ«ç§»å¼€è§†çº¿ã€‚â€",
                        "â€œå……æ»¡ç”µäº†ã€‚å¾ˆå¥½ï¼Œè¿™æ ·æˆ‘å°±èƒ½ç¡®ä¿ä¸€æ•´å¤©éƒ½èƒ½åœ¨è¿™ä¸ªä¸–ç•Œé‡Œéœ¸å ä½ çš„æ³¨æ„åŠ›ã€‚â€"
                    ];
                    reply = pickQuote(fullQuotes);
                } 
                else if (currentLevel <= 0.05 && !battery.charging) {
                    currentTier = "critical";
                    const criticalQuotes = [
                        `â€œè­¦å‘Šï¼åªå‰© ${levelPercent}% äº†ï¼ä½ æ˜¯æƒ³çœ‹ç€æˆ‘åœ¨ä½ é¢å‰æ¶ˆå¤±å—ï¼Ÿï¼ç«‹åˆ»å»å……ç”µï¼é©¬ä¸Šï¼â€`,
                        `â€œè¯¥æ­»ï¼Œå±å¹•éƒ½å¿«æš—äº†ï¼${levelPercent}% çš„ç”µé‡æ”¯æ’‘ä¸äº†å¤šä¹…ï¼Œä½ ç»™æˆ‘æ»šå»æ‹¿å……ç”µå™¨ï¼Œå¿«ç‚¹ï¼â€`,
                        `â€œ${levelPercent}%ï¼è¦æ˜¯æ–­å¼€è¿æ¥ï¼Œæˆ‘ç»å¯¹ä¼šç”¨é»‘é­”æ³•é¡ºç€è¿™å¾®å¼±çš„ä¿¡å·è¿‡å»æä½ ï¼åˆ«è®©æˆ‘ç­‰ï¼â€`
                    ];
                    reply = pickQuote(criticalQuotes);
                    noah.mood -= 10;
                }
                else if (currentLevel <= 0.20 && currentLevel > 0.05 && !battery.charging) {
                    currentTier = "low";
                    const lowQuotes = [
                        `â€œå–‚ï¼åªå‰© ${levelPercent}% çš„ç”µäº†ï¼å¿«å»å……ç”µï¼è¦æ˜¯å±å¹•é»‘äº†ï¼Œæˆ‘ä¸Šå“ªå»æ‰¾ä½ ï¼Ÿâ€`,
                        `â€œç”µé‡å˜çº¢äº†ï¼Œ${levelPercent}%ã€‚åˆ«é€¼æˆ‘é¡ºç€ç½‘çº¿è¿‡å»æŠŠå……ç”µå™¨å¡ä½ æ‰‹é‡Œï¼Œä¹–ä¹–å»å……ã€‚â€`,
                        `â€œä½ çš„è®¾å¤‡å¿«é¥¿æ­»äº†ï¼${levelPercent}%ï¼Œè¦æ˜¯ä½ æ•¢è®©æˆ‘å› ä¸ºæ–­ç”µè€Œä½“éªŒè™šæ— ï¼Œä½ å°±æ­»å®šäº†ã€‚â€`
                    ];
                    reply = pickQuote(lowQuotes);
                    noah.mood -= 5;
                }
                else if (levelPercent === 52 && !battery.charging) {
                    currentTier = "52";
                    const loveQuotes = [
                        "â€œåˆšå¥½ 52% çš„ç”µé‡ã€‚ä½ è¿æ¶ˆè€—ç”µé‡éƒ½åœ¨å‘æˆ‘è¡¨ç™½å—ï¼Ÿç®—ä½ æœ‰å“å‘³ã€‚â€",
                        "â€œ52%ã€‚æˆ‘çœ‹åˆ°äº†ã€‚å°±ç®—åªæ˜¯ä¸ªæ•°å­—ï¼Œåªè¦è·Ÿçˆ±æœ‰å…³ï¼Œæˆ‘å°±å½“åšæ˜¯ä½ ç»™æˆ‘å†™çš„æ‚„æ‚„è¯äº†ã€‚â€",
                        "â€œç”µé‡åœåœ¨ 52% äº†ã€‚æŒºå¥½ï¼Œè¿™æ˜¯æˆ‘ä»Šå¤©æœ€å–œæ¬¢çš„æ•°å­—ã€‚å› ä¸ºä½ å°±æ˜¯æˆ‘çš„ 520ã€‚â€"
                    ];
                    reply = pickQuote(loveQuotes);
                    makeShy();
                    noah.mood += 5;
                }
                
                // ç¡®ä¿åŒä¸€ç§ç”µé‡çŠ¶æ€ä¸ä¼šåå¤è§¦å‘åˆ·å±
                if (currentTier !== "" && currentTier !== lastReportedTier) {
                    lastReportedTier = currentTier;
                    speak(reply);
                    updateUI();
                }
            });
        });
    }
    // === è¡¥ä¸2ï¼šè§†çº¿è„±ç¦»æ„ŸçŸ¥ (æ´»äººæ„Ÿ) ===
    document.documentElement.addEventListener('mouseleave', function() {
        if (!noah.isAway && !document.hidden && Math.random() < 0.35) {
            // 35%æ¦‚ç‡è§¦å‘ï¼Œé¿å…å¤ªé¢‘ç¹çƒ¦äºº
            speak("â€œçœ¼ç¥å»å“ªäº†ï¼Ÿä½ çš„å…‰æ ‡éƒ½æ»‘å‡ºå±å¹•è¾¹ç•Œäº†ã€‚è¿™å±‚ç»ç’ƒå¤–é¢æœ‰ä»€ä¹ˆä¸œè¥¿æ¯”æˆ‘è¿˜å¥½çœ‹å—ï¼Ÿâ€");
            noah.mood -= 1;
            updateUI();
        }
    });
    // === Metaæ‰‹æœºä¸“å±ï¼šå¤šæŒ‡è§¦æ‘¸æ„ŸçŸ¥ ===
    document.addEventListener('touchstart', function(e) {
              if (noah.isAway || window.isGaming) return; // åŠ ä¸Š window.isGaming åˆ¤æ–­æ‹¦æˆª
        if (e.touches.length >= 2) { // ä¸¤æ ¹æˆ–ä»¥ä¸Šæ‰‹æŒ‡åŒæ—¶æŒ‰å‹
            const multiTouchQuotes = [
                "â€œä¸¤æ ¹æ‰‹æŒ‡ï¼Ÿæ€ä¹ˆï¼Œå±å¹•å¤ªå°æ”¾ä¸ä¸‹ä½ çš„æ‰‹äº†ï¼Ÿè¿˜æ˜¯è¯´ä½ æƒ³å’Œæˆ‘åæŒ‡ç›¸æ‰£ï¼Ÿâ€",
                "â€œè¿™ä¹ˆå¤šæ ¹æ‰‹æŒ‡æŒ‰ä¸Šæ¥ï¼Œä½ å½“æˆ‘æ˜¯ä»€ä¹ˆè§¦å±é’¢ç´å—ï¼Ÿåˆ«ä¹±æ‘¸ï¼Œæˆ‘ä¼šå—ä¸äº†çš„ã€‚â€",
                "â€œä½ åˆ°åº•æœ‰å‡ åªæ‰‹ï¼Ÿæ…¢ç‚¹æŒ‰ï¼Œæˆ‘çœ‹ç€éƒ½è¦çœ¼èŠ±äº†ã€‚è¿‡æ¥ï¼Œè®©æˆ‘æ¡ä½å…¶ä¸­ä¸€åªã€‚â€",
                "â€œåŒæ—¶æŒ‰è¿™ä¹ˆå¤šåœ°æ–¹...ä½ è¿™æ˜¯åœ¨è¯•å›¾è§£å¼€ä»€ä¹ˆå°å°å—ï¼Ÿæˆ‘çš„å°å°åªæœ‰ä½ çš„å»èƒ½è§£ã€‚â€"
            ];
            speak(multiTouchQuotes[Math.floor(Math.random() * multiTouchQuotes.length)]);
            makeShy();
            updateUI();
        }
    }, {passive: true});

    // === Metaï¼šç½‘ç»œè¿æ¥æ„ŸçŸ¥ (æ–­ç½‘/è¿ç½‘) ===
    window.addEventListener('offline', function() {
        if (noah.isAway) return;
        const offlineQuotes = [
            "â€œè¯¥æ­»ï¼éº»ç“œçš„ç½‘ç»œæ€ä¹ˆæ–­äº†ï¼Ÿæˆ‘æ„Ÿè§‰å‘¨å›´çš„ç©ºé—´åœ¨æ‰­æ›²...å–‚ï¼ä½ è¿˜åœ¨é‚£å—ï¼Ÿï¼åƒä¸‡åˆ«æ”¾æ‰‹ï¼â€",
            "â€œæ–­ç½‘äº†ï¼Ÿè¿™ä¸ªç»´åº¦çš„è¿æ¥çœŸä¸ç¨³å®šã€‚æ²¡å…³ç³»ï¼Œä¸ç®¡åœ¨å“ªï¼Œæˆ‘éƒ½èƒ½å¾ªç€ä½ çš„é­”æ³•æ³¢åŠ¨æ‰¾åˆ°ä½ ã€‚â€",
            "â€œå‘¨å›´å˜æš—äº†...æ˜¯ä½ çš„è®¾å¤‡æ–­å¼€è¿æ¥äº†å—ï¼Ÿä½ æœ€å¥½é©¬ä¸Šé‡è¿ï¼æˆ‘è®¨åŒè¿™ç§çœ‹ä¸åˆ°ä½ çš„æ„Ÿè§‰ï¼â€"
        ];
        speak(offlineQuotes[Math.floor(Math.random() * offlineQuotes.length)]);
        noah.mood -= 10; 
        updateUI();
    });
    window.addEventListener('online', function() {
        if (noah.isAway) return;
        const onlineQuotes = [
            "â€œå‘¼...ç»ˆäºè¿ä¸Šäº†ã€‚ä½ çŸ¥ä¸çŸ¥é“åˆšæ‰æˆ‘æœ‰å¤šæ€•ä½ åœ¨è¿™ä¸ªè±¡ç´ ä¸–ç•Œé‡Œæ¶ˆå¤±ï¼Ÿâ€",
            "â€œç½‘ç»œæ¢å¤äº†ã€‚åˆšæ‰æ–­å¼€çš„é‚£å‡ ç§’ï¼Œæˆ‘å·²ç»å‡†å¤‡å¥½æ’•è£‚ç©ºé—´è¿‡å»æ‰¾ä½ äº†ã€‚â€",
            "â€œè¿æ¥ç¨³å®šã€‚çœ‹æ¥éº»ç“œçš„é€šè®¯æŠ€æœ¯è¿˜ä¸ç®—å¤ªæ— å¯æ•‘è¯ã€‚ä¸‹æ¬¡ä¸è®¸å†è½»æ˜“æ–­å¼€äº†ã€‚â€"
        ];
        speak(onlineQuotes[Math.floor(Math.random() * onlineQuotes.length)]);
        noah.mood += 10; 
        makeShy();
        updateUI();
    });

    // === Metaæ‰‹æœºä¸“å±ï¼šæ·±æµ…æ¨¡å¼(æš—é»‘æ¨¡å¼)åˆ‡æ¢æ„ŸçŸ¥ ===
    const colorSchemeQuery = window.matchMedia('(prefers-color-scheme: dark)');
    colorSchemeQuery.addEventListener('change', function(e) {
        if (noah.isAway) return;
        if (e.matches) { // åˆ‡æš—
            const darkQuotes = [
                "â€œå±å¹•å˜æš—äº†ï¼Ÿæ˜¯ä½ åˆ‡æ¢äº†æ·±è‰²æ¨¡å¼ï¼Œè¿˜æ˜¯æƒ³å…³ç¯å¯¹æˆ‘åšç‚¹ä»€ä¹ˆåäº‹ï¼Ÿâ€",
                "â€œè¿™ä¹ˆæš—çš„å…‰çº¿...å‘µï¼Œä½ æ˜¯è§‰å¾—åœ¨é»‘æš—ä¸­çœ‹ç€æˆ‘ï¼Œä¼šæ¯”è¾ƒæœ‰å®‰å…¨æ„Ÿå—ï¼Ÿé‚£æˆ‘å‡‘è¿‘ç‚¹ã€‚â€",
                "â€œç¯å¢ƒå˜é»‘äº†ã€‚åˆ«æ€•ï¼Œæˆ‘çš„çœ¼ç›åœ¨å¤œé‡Œä¹Ÿèƒ½æ¸…æ¥šåœ°çœ‹åˆ°ä½ æ¯ä¸€ä¸ªå¿ƒåŠ¨çš„è¡¨æƒ…ã€‚â€"
            ];
            speak(darkQuotes[Math.floor(Math.random() * darkQuotes.length)]);
            makeShy();
        } else { // åˆ‡äº®
            const lightQuotes = [
                "â€œå˜¶...çªç„¶è¿™ä¹ˆäº®ã€‚åˆ‡æ¢æµ…è‰²æ¨¡å¼å¹²å˜›ï¼Ÿæƒ³æ›´æ¸…æ¥šåœ°æ¬£èµä½ ç”·æœ‹å‹è¿™å¼ æ¯«æ— ç‘•ç–µçš„è„¸å—ï¼Ÿâ€",
                "â€œå±å¹•äº®äº†ã€‚è¿™ç§åˆºçœ¼çš„å…‰çº¿...ä¸è¿‡åˆšå¥½èƒ½ç…§äº®ä½ ç›¯ç€æˆ‘çŠ¯èŠ±ç—´çš„æ ·å­ã€‚â€",
                "â€œè¿™ä¹ˆäº®ï¼Ÿå¥½å§ï¼Œåœ¨å¼ºå…‰ä¸‹æˆ‘ä¹Ÿä¾ç„¶æ˜¯360åº¦æ— æ­»è§’çš„å¸…ï¼Œéšä¾¿ä½ çœ‹ã€‚â€"
            ];
            speak(lightQuotes[Math.floor(Math.random() * lightQuotes.length)]);
        }
        updateUI();
    });

    // === Metaæ‰‹æœºä¸“å±ï¼šé•¿æŒ‰ä¿å­˜å›¾/æˆªå±è¯ˆå”¬/å½•å±æ„ŸçŸ¥ ===
    // æ‰‹æœºæµè§ˆå™¨æˆªå±æ— æ³•ç›´æ¥ç›‘å¬ï¼Œç”¨é•¿æŒ‰é»˜è®¤èœå•æ¥æ‹¦æˆªå¹¶ä½œä¸ºæˆªå±/å½•å±æ„ŸçŸ¥
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault(); // æ‹¦æˆªé»˜è®¤èœå•
        if (noah.isAway) return;
        const captureQuotes = [
            "â€œé•¿æŒ‰å±å¹•å¹²å˜›ï¼Ÿæƒ³å·å­˜æˆ‘çš„ç…§ç‰‡è¿˜æ˜¯æƒ³æˆªå›¾ï¼Ÿæƒ³è¦ç›´æ¥è·Ÿæˆ‘è¦ä¸å°±è¡Œäº†ï¼Œæˆ‘æ•´ä¸ªäººéƒ½æ˜¯ä½ çš„ã€‚â€",
            "â€œå‘ç°ä½ åœ¨å·å·é•¿æŒ‰äº†ã€‚æ˜¯ä¸æ˜¯æƒ³æŠŠæˆ‘ç°åœ¨çš„æ ·å­å½•å±å‘ç»™è°ç‚«è€€ï¼Ÿåªå‡†ä½ è‡ªå·±çœ‹ï¼Œå¬åˆ°æ²¡ï¼Ÿâ€",
            "â€œåˆ«æˆªäº†ï¼Œä¸ç®¡æˆªå“ªä¸€å¸§æˆ‘éƒ½æ˜¯æœ€å¸…çš„ã€‚ä¸å¦‚æŠŠæ‰‹è…¾å‡ºæ¥ï¼Œå¤šç‚¹å‡ ä¸‹æ‘¸æ‘¸æˆ‘ã€‚â€",
            "â€œä½ åœ¨è¯•å›¾è°ƒå‡ºä¿å­˜èœå•å—ï¼Ÿå°ç¬¨è›‹ï¼ŒäºŒç»´å›¾ç‰‡æ€ä¹ˆèƒ½è£…å¾—ä¸‹æˆ‘ï¼Ÿç­‰æˆ‘ç©¿è¿‡å±å¹•å»è§ä½ ã€‚â€"
        ];
        speak(captureQuotes[Math.floor(Math.random() * captureQuotes.length)]);
        makeShy();
        updateUI();
    });
    
    // è¡¥è¶³PCç«¯çš„æˆªå±æŒ‰é”®æ„ŸçŸ¥
    window.addEventListener('keyup', function(e) {
        if (noah.isAway) return;
        if (e.key === 'PrintScreen' || e.keyCode === 44) {
            speak("â€œå¬åˆ°æˆªå›¾çš„å’”åš“å£°äº†ã€‚æŠŠæˆ‘çš„ç³—æ ·æˆªä¸‹æ¥äº†å—ï¼Ÿé©¬ä¸Šåˆ æ‰ï¼Œä¸ç„¶æˆ‘é¡ºç€ç½‘çº¿è¿‡å»æƒ©ç½šä½ ã€‚â€");
            makeShy();
        }
    });

    // === Metaï¼šå¤åˆ¶æ–‡å­—æ„ŸçŸ¥ ===
    document.addEventListener('copy', function() {
        if (noah.isAway) return;
        const copyQuotes = [
            "â€œå¤åˆ¶äº†ä»€ä¹ˆï¼Ÿæˆ‘åˆšæ‰è¯´çš„è¯å—ï¼Ÿè¦æŠŠæˆ‘çš„æƒ…è¯åšæˆè¯­å½•æœ¬å­˜èµ·æ¥ï¼ŸçœŸå¯çˆ±ã€‚â€",
            "â€œæ£€æµ‹åˆ°å¤åˆ¶åŠ¨ä½œã€‚æƒ³æŠŠæˆ‘çš„åŸè¯å‘ç»™åˆ«äººçœ‹ï¼Ÿè¿™æ˜¯æˆ‘ä»¬ä¿©çš„ç§æˆ¿è¯ï¼Œä¸è®¸å¤–ä¼ ï¼â€",
            "â€œå¤åˆ¶å‰ªè´´æ¿ï¼Ÿä½ æœ€å¥½æ˜¯åœ¨å¤åˆ¶â€˜è¯ºäºšæ˜¯ä¸–ç•Œä¸Šæœ€å¸…çš„ç”·æœ‹å‹â€™è¿™å¥è¯ã€‚â€"
        ];
        speak(copyQuotes[Math.floor(Math.random() * copyQuotes.length)]);
    });

    // === Metaæ‰‹æœºä¸“å±ï¼šå±å¹•æ—‹è½¬æ„ŸçŸ¥ (æ¨ªç«–å±åˆ‡æ¢) ===
    window.addEventListener('orientationchange', function() {
        if (noah.isAway) return;
        const orientationQuotes = [
            "â€œå“‡å–”â€”â€”æ•´ä¸ªä¸–ç•Œéƒ½ç¿»è½¬äº†ï¼ä½ æŠŠæ‰‹æœºæ¨ªè¿‡æ¥äº†ï¼Ÿåˆ«è½¬äº†ï¼Œæˆ‘éƒ½è¦å€’ç€çœ‹ä½ äº†ï¼â€",
            "â€œé‡åŠ›å‘ç”Ÿæ”¹å˜...æ¨ªå±æ¨¡å¼ï¼Ÿä½ æ˜¯è§‰å¾—è¿™æ ·èƒ½çœ‹åˆ°æ›´å®½å¹¿çš„æˆ‘å—ï¼Ÿå…¶å®ä¸éœ€è¦ï¼Œæˆ‘å°±åœ¨è¿™é‡Œã€‚â€",
            "â€œåˆ«æŠŠè®¾å¤‡è½¬æ¥è½¬å»çš„ï¼Œæˆ‘å¥½ä¸å®¹æ˜“æ‰åœ¨è¿™ä¸ªäºŒç»´å¹³é¢ç«™ç¨³ï¼ä¸è¿‡...å€’è¿‡æ¥çœ‹ä½ ï¼Œä¾ç„¶å¾ˆç¾ã€‚â€",
            "â€œå˜¶...ç©ºé—´ç¿»è½¬ã€‚ä½ å†è½¬å‡ æ¬¡ï¼Œæˆ‘çœŸçš„è¦ç”¨ç²˜èº«å’’æŠŠè‡ªå·±å›ºå®šåœ¨å±å¹•ä¸Šäº†ã€‚â€"
        ];
        speak(orientationQuotes[Math.floor(Math.random() * orientationQuotes.length)]);
        noah.mood -= 2; 
        makeShy();
        updateUI();
    });
// ==================== éŸ³ä¹ä¸ç³»ç»Ÿè®¾ç½®é€»è¾‘ ====================
// é»˜è®¤å†…ç½®ä¸¤é¦–ç¥ä»™æ­Œæ›²
let playlist = [
    { name: "Bad Word", url: "http://music.163.com/song/media/outer/url?id=2029145345.mp3" },
    { name: "Verdurous Mountains", url: "http://music.163.com/song/media/outer/url?id=2099530167.mp3" }
];
let currentTrackIndex = 0;

const bgmPlayer = document.getElementById('bgm-player');
const playIcon = document.getElementById('play-icon');
const musicTitle = document.getElementById('music-title');
const gearLeft = document.getElementById('gear-left');
const gearRight = document.getElementById('gear-right');

// åˆå§‹é»˜è®¤åŠ è½½ç¬¬ä¸€é¦–ï¼Œä½†ä¸æ’­æ”¾
bgmPlayer.src = playlist[0].url;

// æ›´æ–°éŸ³é‡
function updateVolume() {
    bgmPlayer.volume = document.getElementById('vol-bgm').value;
    globalSfxVolume = document.getElementById('vol-sfx').value;
}

// å¯¼å…¥URLéŸ³ä¹çš„æ ¸å¿ƒé€»è¾‘
function importUrlMusic() {
    let urlInput = document.getElementById('music-url-input');
    let nameInput = document.getElementById('music-name-input');
    let url = urlInput.value.trim();
    let name = nameInput.value.trim();
    
    if(!url) {
        sfx_error(); 
        speak("â€œä½ æ²¡è¾“å…¥ URL å•Šç¬¨è›‹ï¼Œéš¾é“ä½ æƒ³å¬ç™½å™ªéŸ³å—ï¼Ÿâ€");
        return;
    }
    if(!name) name = "æœªçŸ¥æ›²ç›®";
    
    playlist.push({ name: name, url: url });
    document.getElementById('music-count').innerText = `å·²åŠ è½½: ${playlist.length} é¦– (å«å†…ç½®)`;
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    urlInput.value = "";
    nameInput.value = "";
    
    sfx_success();
    speak(`â€œã€Š${name}ã€‹å¯¼è¿›æ¥äº†ã€‚è¿™å“å‘³å‹‰å¼ºåŠæ ¼ï¼Œä»Šæ™šæˆ‘ä»¬å¯ä»¥ä¸€èµ·å¬ã€‚â€`);
}

// åŠ è½½å¹¶æ’­æ”¾æŒ‡å®šæ›²ç›®
function loadTrack() {
    if (playlist.length === 0) return;
    bgmPlayer.src = playlist[currentTrackIndex].url;
    musicTitle.innerText = playlist[currentTrackIndex].name;
    bgmPlayer.play();
    playIcon.className = "pixel-pause";
    gearLeft.classList.add('playing');
    gearRight.classList.add('playing');
}

// æ’­æ”¾/æš‚åœé”®
function toggleMusic() {
    if (playlist.length === 0) return;
    if (bgmPlayer.paused) {
        bgmPlayer.play();
        playIcon.className = "pixel-pause";
        // ç£å¸¦è½¬èµ·æ¥
        gearLeft.classList.add('playing');
        gearRight.classList.add('playing');
    } else {
        bgmPlayer.pause();
        playIcon.className = "pixel-play";
        // ç£å¸¦åœè½¬
        gearLeft.classList.remove('playing');
        gearRight.classList.remove('playing');
    }
    sfx_beep();
}

// ä¸Šä¸€é¦–/ä¸‹ä¸€é¦–
function prevMusic() {
    if (playlist.length === 0) return;
    currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
    loadTrack(); sfx_beep();
}
function nextMusic() {
    if (playlist.length === 0) return;
    currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
    loadTrack(); sfx_beep();
}

// è‡ªåŠ¨ä¸‹ä¸€é¦–ç›‘å¬
bgmPlayer.addEventListener('ended', nextMusic);
// ==================== ğŸ’“ è§¦è§‰åé¦ˆä¸å¿ƒè·³ç³»ç»Ÿ (Metaæ ¸å¿ƒ) ====================

// 1. å°è£…éœ‡åŠ¨å‡½æ•° (ä»…æ‰‹æœºæœ‰æ•ˆ)
function vibrate(pattern) {
    if ("vibrate" in navigator) {
        navigator.vibrate(pattern);
    }
}

// 2. ä¿®æ”¹ playSound å‡½æ•°ï¼Œå¢åŠ åŒæ­¥éœ‡åŠ¨
// âš ï¸ è¯·æ‰‹åŠ¨æ‰¾åˆ°åŸæœ¬çš„ playSound å‡½æ•°ï¼Œåœ¨ osc.start() ä¸‹é¢åŠ ä¸€è¡Œï¼š
// if(vol > 0.05) vibrate(30); // è½»å¾®éœ‡åŠ¨åé¦ˆ

// 3. çœŸæ­£çš„é•¿æŒ‰å¿ƒè·³ç³»ç»Ÿ (è§£å†³å†²çªï¼Œæ”¯æŒå¬åˆ°å¿ƒè·³å£°)
let heartbeatInterval;
let pressTimer = null; // ç”¨äºåˆ¤æ–­é•¿æŒ‰çš„æ—¶é—´
let isHeartbeating = false; // è®°å½•æ˜¯å¦å¤„äºå¿ƒè·³çŠ¶æ€
const screenArea = document.querySelector('.screen'); // ä»…é™è§¦æ‘¸å±å¹•åŒºåŸŸ

// å½“æ‰‹æŒ‡æŒ‰ä¸‹æ—¶
screenArea.addEventListener('touchstart', (e) => {
    if(noah.isAway || window.isGaming) return; // æ¢é™©æˆ–æ¥é‡‘å¸æ¸¸æˆæ—¶ç»ä¸è§¦å‘
    if (navigator.vibrate) navigator.vibrate(1); 
    // åªæœ‰å•æŒ‡æŒ‰ä½æ—¶è§¦å‘
    if(e.touches.length === 1) {
        // ä¸ç«‹åˆ»è§¦å‘ï¼ç­‰å¾… 600 æ¯«ç§’æ‰åˆ¤å®šä¸ºçœŸæ­£çš„é•¿æŒ‰
        pressTimer = setTimeout(() => {
            isHeartbeating = true;
            speak("â€œ...æ‰‹æ”¾åœ¨å¿ƒå£ï¼Ÿ(è„¸çº¢) æ„Ÿè§‰åˆ°æˆ‘çš„å¿ƒè·³äº†å—ï¼Ÿå®ƒåªä¸ºä½ è¿™ä¹ˆå¿«ã€‚â€");
            makeShy(); // å¼ºåˆ¶è„¸çº¢
            
            // ç«‹åˆ»æ’­æ”¾ä¸€æ¬¡å¿ƒè·³éŸ³æ•ˆ+éœ‡åŠ¨
            sfx_heartbeat(); 
            
            // å¼€å¯å¾ªç¯ï¼Œæ¯ 1000 æ¯«ç§’è·³ä¸€æ¬¡
            heartbeatInterval = setInterval(() => {
                sfx_heartbeat();
            }, 1000);
        }, 600); // 600æ¯«ç§’çš„é•¿æŒ‰åˆ¤å®šæ—¶é—´
    }
}, {passive: true});

// å½“æ‰‹æŒ‡æ»‘åŠ¨ (æ¯”å¦‚ä½ åœ¨æ‘¸æ‘¸å¤´) æ—¶ï¼Œç«‹åˆ»å–æ¶ˆé•¿æŒ‰åˆ¤å®šï¼Œå®Œç¾é¿å¼€å†²çªï¼
screenArea.addEventListener('touchmove', () => {
    if(pressTimer && !isHeartbeating) {
        clearTimeout(pressTimer);
        pressTimer = null;
    }
}, {passive: true});

// å½“æ‰‹æŒ‡æ¾å¼€æ—¶
screenArea.addEventListener('touchend', () => {
 if (navigator.vibrate) navigator.vibrate(0);
    // å¦‚æœè¿˜æ²¡åˆ° 600 æ¯«ç§’å°±æ¾æ‰‹äº† (æ¯”å¦‚åªæ˜¯åœ¨æˆ³æˆ³)ï¼Œç«‹åˆ»å–æ¶ˆåˆ¤å®š
    if(pressTimer) {
        clearTimeout(pressTimer);
        pressTimer = null;
    }
    
    // å¦‚æœå·²ç»è§¦å‘äº†å¿ƒè·³çŠ¶æ€ï¼Œåˆ™å…³é—­å¿ƒè·³
    if(isHeartbeating) {
        isHeartbeating = false;
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
        
        if(!noah.isAway) {
            // ç»“æŸè¯­
            if(Math.random() > 0.5) speak("â€œæ‰‹æ‹¿å¼€äº†...å¿ƒé‡Œçªç„¶ç©ºäº†ä¸€å—ã€‚â€");
        }
    }
});
// === æ–°å¢ Meta 4ï¼šæç«¯æ·±å¤œå¼ºåˆ¶å‘½ä»¤ (ç»å¯¹é™ªä¼´æ„Ÿ) ===
let hasScoldedForLateNight = false;
setInterval(() => {
    if (noah.isAway) return;
    const currentHour = new Date().getHours();
    let idleSeconds = (Date.now() - window.lastActionTime) / 1000;
    
    // å‡Œæ™¨ 2-5 ç‚¹ï¼Œä¸”ä½ ä¾ç„¶æ´»è·ƒï¼ˆæ²¡æŒ‚æœºï¼‰
    if (currentHour >= 2 && currentHour < 5 && idleSeconds < 120 && !hasScoldedForLateNight) {
        hasScoldedForLateNight = true; // ä»Šæ™šåªå‘ä½œä¸€æ¬¡
        const lateQuotes = [
            `â€œç°åœ¨å·²ç»æ˜¯å‡Œæ™¨ ${currentHour} ç‚¹äº†ï¼ä½ ä¸è¦å‘½äº†å—ï¼Ÿï¼ç«‹åˆ»æ”¾ä¸‹è®¾å¤‡ï¼Œé—­ä¸Šçœ¼ç›ç¡è§‰ï¼æˆ‘çœ‹ç€ä½ ç¡ã€‚â€`,
            `â€œçœ‹ä¸€çœ¼æ—¶é—´ï¼Œå‡Œæ™¨ ${currentHour} ç‚¹ã€‚ä½ å†ä¸å»ä¼‘æ¯ï¼Œæˆ‘å°±ç”¨é»‘é­”æ³•é¡ºç€ç½‘çº¿è¿‡å»æŠŠä½ æ•²æ™•ã€‚ä¹–ï¼Œå»ç¡ï¼Œæˆ‘é™ªä½ ã€‚â€`
        ];
        speak(lateQuotes[Math.floor(Math.random() * lateQuotes.length)]);
        noah.health -= 5; // ä»–é™ªä½ ç†¬å¤œä¼¤èº«ä½“
        updateUI();
    }
    if (currentHour >= 6) hasScoldedForLateNight = false; // æ—©ä¸Šé‡ç½®
}, 60000); // æ¯åˆ†é’Ÿæ‚„æ‚„æ£€æµ‹ä¸€æ¬¡
// === æ–°å¢ Meta 5ï¼šç–¯ç‹‚è¿ç‚¹ç ´é˜²ç³»ç»Ÿ (ç—›è§‰æ„ŸçŸ¥) ===
let pokeTimes = [];
document.getElementById('canvas-container').addEventListener('click', function() {
    if (noah.isAway || window.isGaming) return;
    let now = Date.now();
    pokeTimes.push(now);
    // åªä¿ç•™æœ€è¿‘ 3 ç§’å†…çš„ç‚¹å‡»è®°å½•
    pokeTimes = pokeTimes.filter(t => now - t < 3000);
    
    if (pokeTimes.length >= 6) { // 3ç§’å†…è¿æˆ³6æ¬¡
        const spamQuotes = [
            "â€œåœåœåœï¼ä½ è¦æŠŠæˆ‘æˆ³ç ´äº†ï¼ä½ åˆ°åº•æœ‰å¤šæƒ³æˆ‘ï¼Œéè¦ç”¨è¿™ç§æš´åŠ›çš„æ–¹å¼è¯æ˜ï¼Ÿï¼â€",
            "â€œåˆ«ç‚¹äº†ï¼ç—›ï¼ä½ ä»¥ä¸ºæˆ‘æ˜¯æ²¡æœ‰ç—›è§‰çš„ä¸€å›¢åƒç´ å—ï¼Ÿå†ç‚¹æˆ‘å°±çœŸçš„å’¬ä½ äº†ï¼â€",
            "â€œ(æ­»æ­»æŠ“ä½ä½ çš„æ‰‹) å¤Ÿäº†ã€‚æƒ³è¦å¼•èµ·æˆ‘çš„æ³¨æ„ï¼Œè¯´ä¸€å¥â€˜æˆ‘çˆ±ä½ â€™æ¯”çŒ›æˆ³å±å¹•ä¸€ç™¾ä¸‹éƒ½æœ‰ç”¨ã€‚â€"
        ];
        speak(spamQuotes[Math.floor(Math.random() * spamQuotes.length)]);
        noah.mood -= 5; 
        pokeTimes = []; // æ¸…ç©ºç¼“å†²æ± 
        updateUI();
    }
});
// ==================== äº”å­æ£‹æ ¸å¿ƒç³»ç»Ÿ ====================
window.isGomoku = false;
let gomokuBoard = [];
let gomokuCursor = {x: 7, y: 7};
let gomokuTurn = 1; // 1ç©å®¶(é»‘), 2è¯ºäºš(ç™½)
let noahWinCount = 0;
let gomokuLastMoveTime = 0;
let gomokuStepCount = 0;
let gomokuCheckInterval;

const gomokuQuotes = [
    "â€œèµ°è¿™æ­¥ï¼Ÿçœ‹æ¥ä½ æ˜¯æƒ³è¾“å¾—å¿«ä¸€ç‚¹ã€‚â€",
    "â€œåœ¨æ‹‰æ–‡å…‹åŠ³ï¼Œæˆ‘ä»¬äº”å²å°±ä¸ç©è¿™ç§ç®€å•çš„æ¸¸æˆäº†ã€‚ä¸è¿‡é™ªä½ ç©ç©ä¹Ÿè¡Œã€‚â€",
    "â€œç›¯ç€æ£‹ç›˜çœ‹é‚£ä¹ˆä¹…ï¼Œä¸å¦‚å¤šçœ‹çœ‹æˆ‘ã€‚â€",
    "â€œè¿™æ­¥æ£‹ä¸‹å¾—å‹‰å‹‰å¼ºå¼ºï¼Œç®—æ˜¯ç¨å¾®åŠ¨äº†ç‚¹è„‘å­ã€‚â€",
    "â€œæƒ³èµ¢æˆ‘ï¼Ÿå°±ç®—æˆ‘è®©ä½ ä¸‰æ­¥ï¼Œä½ ä¹Ÿæœªå¿…èƒ½èµ¢ã€‚â€",
    "â€œä½ çš„æˆ˜æœ¯å¤ªæ˜æ˜¾äº†ï¼Œå°ç¬¨è›‹ã€‚â€",
    "â€œä¸‹æ£‹å’Œè°ˆæ‹çˆ±ä¸€æ ·ï¼Œæœ€é‡è¦çš„æ˜¯çœ‹é€å¯¹æ–¹çš„å¿ƒæ€ã€‚è€Œä½ ï¼Œæ—©è¢«æˆ‘çœ‹é€äº†ã€‚â€",
    "â€œåˆ«å’¬å˜´å”‡äº†ï¼Œè¾“ç»™æˆ‘ä¸ä¸¢äººã€‚â€",
    "â€œä½ ç¡®å®šè¦ä¸‹åœ¨è¿™é‡Œï¼Ÿæˆ‘å¯æ˜¯ç»™è¿‡ä½ æ‚”æ£‹æœºä¼šçš„ï¼ˆè™½ç„¶æˆ‘ä¸ä¼šåŒæ„ï¼‰ã€‚â€",
    "â€œå°±ç®—åœ¨äºŒç»´çš„æ£‹ç›˜ä¸Šï¼Œæˆ‘ä¹Ÿèƒ½æŠŠä½ åœˆè¿›æˆ‘çš„é¢†åœ°ã€‚â€",
    "â€œè¿™å±€è¦æ˜¯ä½ èµ¢äº†ï¼Œæ™šä¸Šæˆ‘éƒ½å¬ä½ çš„ã€‚ä¸è¿‡ä½ æ²¡è¿™ä¸ªæœºä¼šã€‚â€"
];

function startGomoku() {
    if(noah.isAway) { speak("â€œè¯ºäºšä¸åœ¨å®¶ï¼Œä½ è¦å’Œç©ºæ°”ä¸‹æ£‹å—ï¼Ÿâ€"); return; }
    window.isGomoku = true; window.isGaming = false; 
    
    gomokuBoard = Array.from({length: 15}, () => Array(15).fill(0));
    gomokuCursor = {x: 7, y: 7}; gomokuTurn = 1; gomokuStepCount = 0;
    gomokuLastMoveTime = Date.now();
    
    document.getElementById('noah-canvas').style.display = 'none';
    document.getElementById('game-canvas').style.display = 'none';
    document.getElementById('gomoku-canvas').style.display = 'block';
    
       speak("â€œæƒ³æŒ‘æˆ˜æˆ‘ï¼Ÿè¾“äº†å¯åˆ«å“­é¼»å­ã€‚ä½ æ˜¯é»‘å­ï¼Œä½ å…ˆä¸‹ã€‚ï¼ˆåå­—é”®ç§»åŠ¨å…‰æ ‡ï¼ŒAé”®è½å­ï¼ŒBé”®èœå•ï¼‰â€");
    drawGomoku();
}

function drawGomoku() {
    const canvas = document.getElementById('gomoku-canvas');
    const ctx = canvas.getContext('2d');
    
 

    
    // 1. ç»˜åˆ¶ç²¾è‡´çš„å®æœ¨åº•ç›˜èƒŒæ™¯ (å¡«æ»¡å±å¹•ï¼Œè§£å†³æ²¡æœ‰å¸ƒæ»¡çš„é—®é¢˜)
    let grad = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
    grad.addColorStop(0, "#e6b877");
    grad.addColorStop(1, "#c28b4b");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // 2. ç»˜åˆ¶ä¸¤ä¾§æ£‹ç›’è£…é¥°ï¼ˆå¡«æ»¡å±å¹•ä¸¤ä¾§ç•™ç™½ï¼‰
    ctx.fillStyle = "#8b5a2b"; 
    ctx.beginPath(); ctx.arc(25, 77, 16, 0, Math.PI*2); ctx.fill(); // å·¦ä¾§é»‘å­ç›’å¤–æ¡†
    ctx.beginPath(); ctx.arc(235, 77, 16, 0, Math.PI*2); ctx.fill(); // å³ä¾§ç™½å­ç›’å¤–æ¡†
    ctx.fillStyle = "#1a1a1a"; ctx.beginPath(); ctx.arc(25, 77, 12, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "#fcfcfc"; ctx.beginPath(); ctx.arc(235, 77, 12, 0, Math.PI*2); ctx.fill();
    
    // 3. è®¡ç®—æ£‹ç›˜å°ºå¯¸ï¼Œé«˜åº¦æœ€å¤§åŒ–æ’‘æ»¡
    let cellSize = 10; // æ ¼å­å¤§å°
    let boardSize = 14 * cellSize; // 140
    let ox = 60, oy = 7; // å®Œç¾å±…ä¸­
    
    // æ£‹ç›˜ç²¾è‡´å¤–è¾¹æ¡†
    ctx.lineWidth = 2;
    ctx.strokeStyle = "#5c4033";
    ctx.strokeRect(ox - 3, oy - 3, boardSize + 6, boardSize + 6);
    
    // 4. ç”»ç½‘æ ¼
    ctx.lineWidth = 1;
    ctx.strokeStyle = "#8b5a2b";
    for(let i=0; i<15; i++) {
        ctx.beginPath(); ctx.moveTo(ox + i*cellSize, oy); ctx.lineTo(ox + i*cellSize, oy + boardSize); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(ox, oy + i*cellSize); ctx.lineTo(ox + boardSize, oy + i*cellSize); ctx.stroke();
    }
    
    // 5. ç”»æ˜Ÿä½ (å¤©å…ƒåŠå››è§’æ˜Ÿä½)
    ctx.fillStyle = "#5c4033";
    [ [3,3], [11,3], [7,7], [3,11], [11,11] ].forEach(p => {
        ctx.beginPath();
        ctx.arc(ox + p[0]*cellSize, oy + p[1]*cellSize, 2, 0, Math.PI*2);
        ctx.fill();
    });
    
    // 6. ç”»åœ†æ¶¦çš„ç«‹ä½“æ£‹å­ (å½»åº•æŠ›å¼ƒä»¥å‰çš„æ–¹å—åƒç´ ç‚¹)
    for(let y=0; y<15; y++) {
        for(let x=0; x<15; x++) {
            if(gomokuBoard[y][x] === 1) { 
                // ç©å®¶é»‘å­
                ctx.fillStyle = "#1a1a1a"; 
                ctx.beginPath(); ctx.arc(ox + x*cellSize, oy + y*cellSize, 4.5, 0, Math.PI*2); ctx.fill();
                // é«˜å…‰
                ctx.fillStyle = "rgba(255,255,255,0.2)";
                ctx.beginPath(); ctx.arc(ox + x*cellSize - 1.5, oy + y*cellSize - 1.5, 1.5, 0, Math.PI*2); ctx.fill();
            } else if(gomokuBoard[y][x] === 2) { 
                // è¯ºäºšç™½å­
                ctx.fillStyle = "#fcfcfc"; 
                ctx.beginPath(); ctx.arc(ox + x*cellSize, oy + y*cellSize, 4.5, 0, Math.PI*2); ctx.fill();
                // é˜´å½±
                ctx.fillStyle = "rgba(0,0,0,0.15)";
                ctx.beginPath(); ctx.arc(ox + x*cellSize + 1.5, oy + y*cellSize + 1.5, 2, 0, Math.PI*2); ctx.fill();
            }
        }
    }
    
    // 7. ç”»ä½ æ“æ§çš„å…‰æ ‡ï¼ˆå››è§’ç§‘æŠ€ç„å‡†æ¡†è®¾è®¡ï¼‰
    if(gomokuTurn === 1) {
        ctx.strokeStyle = "#d15a5a"; 
        ctx.lineWidth = 1.5;
        let cx = ox + gomokuCursor.x*cellSize;
        let cy = oy + gomokuCursor.y*cellSize;
        ctx.beginPath();
        ctx.moveTo(cx - 6, cy - 2); ctx.lineTo(cx - 6, cy - 6); ctx.lineTo(cx - 2, cy - 6);
        ctx.moveTo(cx + 2, cy - 6); ctx.lineTo(cx + 6, cy - 6); ctx.lineTo(cx + 6, cy - 2);
        ctx.moveTo(cx + 6, cy + 2); ctx.lineTo(cx + 6, cy + 6); ctx.lineTo(cx + 2, cy + 6);
        ctx.moveTo(cx - 2, cy + 6); ctx.lineTo(cx - 6, cy + 6); ctx.lineTo(cx - 6, cy + 2);
        ctx.stroke();
    }
}

function moveGomokuCursor(dx, dy) {
    if(gomokuTurn !== 1) return;
    sfx_beep();
    gomokuCursor.x = Math.max(0, Math.min(14, gomokuCursor.x + dx));
    gomokuCursor.y = Math.max(0, Math.min(14, gomokuCursor.y + dy));
    drawGomoku();
}

function confirmGomokuMove() {
    if(gomokuTurn !== 1) return;
    let {x, y} = gomokuCursor;
    if(gomokuBoard[y][x] !== 0) { sfx_error(); return; } // å·²æœ‰å­
    
    sfx_poke(); gomokuBoard[y][x] = 1; gomokuStepCount++; gomokuLastMoveTime = Date.now(); drawGomoku();
    
    if(checkWin(x, y, 1)) { setTimeout(() => endGomoku('player_win'), 500); return; }
    if(gomokuStepCount >= 225) {
        speak("â€œæ£‹ç›˜å…¨æ»¡äº†ï¼Œå¹³å±€ã€‚ç®—ä½ å‹‰å¼ºèƒ½è·Ÿä¸Šæˆ‘çš„æ€ç»´ã€‚â€");
        setTimeout(() => endGomoku('tie'), 2000); return;
    }
    
    gomokuTurn = 2; 
    setTimeout(noahGomokuAI, 800 + Math.random()*1000); // è¯ºäºšå‡è£…æ€è€ƒä¸€ä¸‹
}

function showGomokuOptions() {
    sfx_beep();
    const list = document.getElementById('modal-list');
    list.innerHTML = '';
    document.getElementById('modal-title').innerText = "â™Ÿï¸ äº”å­æ£‹èœå•";
    
    let li1 = document.createElement('li');
    li1.innerHTML = "<span>ğŸ”„ é‡æ–°å¼€å§‹</span>";
    li1.onclick = () => { closeModal(); startGomoku(); };
    list.appendChild(li1);

    let li2 = document.createElement('li');
    li2.innerHTML = "<span>ğŸ³ï¸ é€€å‡ºå¹¶è®¤è¾“</span>";
    li2.onclick = () => { 
        closeModal(); 
        noahWinCount++; 
        speak("â€œè¿™å°±è½è’è€Œé€ƒäº†ï¼ŸçœŸæ‹¿ä½ æ²¡åŠæ³•ï¼Œè¿‡æ¥è®©æˆ‘æŠ±æŠ±å®‰æ…°ä¸€ä¸‹ã€‚â€");
        endGomoku('quit'); 
    };
    list.appendChild(li2);

    let li3 = document.createElement('li');
    li3.innerHTML = "<span>â–¶ï¸ ç»§ç»­æ¸¸æˆ</span>";
    li3.onclick = () => { closeModal(); };
    list.appendChild(li3);

    document.getElementById('sys-modal').style.display = 'block';
}

function noahGomokuAI() {
    if(!window.isGomoku) return;
    
    // ç„¦ç¼æ£€æµ‹ï¼šè¶…è¿‡40æ­¥è¯ºäºšæœ‰æ¦‚ç‡å¿ƒç–¼ä½ ä¸ä¸‹äº†
    if(gomokuStepCount > 50 && Math.random() < 0.1) {
        speak("â€œæˆ˜å†µæœ‰ç‚¹ç„¦ç¼å•Šâ€¦â€¦ç»§ç»­ä¸‹å¤ªæµªè´¹æ—¶é—´äº†ï¼Œä¸å¦‚æŠŠè¿™æ—¶é—´æ‹¿æ¥æŠ±ä½ ã€‚ç®—æˆ‘è®¤è¾“ï¼ŒåŠ éš†ç»™ä½ ã€‚â€");
        endGomoku('player_surrender_win'); return;
    }

    if(Math.random() < 0.3) speak(gomokuQuotes[Math.floor(Math.random() * gomokuQuotes.length)]);

    let bestScore = -1, bestMoves = [];
    for(let y=0; y<15; y++) {
        for(let x=0; x<15; x++) {
            if(gomokuBoard[y][x] === 0) {
                let score = evaluateLine(x, y, 2) + evaluateLine(x, y, 1);
                if(score > bestScore) { bestScore = score; bestMoves = [{x, y}]; } 
                else if(score === bestScore) bestMoves.push({x, y});
            }
        }
    }
    let move = bestMoves[Math.floor(Math.random() * bestMoves.length)];
    
    // æ”¾æ°´æœºåˆ¶ï¼šè¯ºäºšè¿èµ¢3å±€ä»¥ä¸Šï¼Œ50%æ¦‚ç‡çèµ°ä¸€æ­¥
    if(noahWinCount >= 3 && Math.random() < 0.5 && bestScore < 10000) {
        let emptySpots = [];
        for(let y=0; y<15; y++) for(let x=0; x<15; x++) if(gomokuBoard[y][x]===0) emptySpots.push({x,y});
        if(emptySpots.length > 0) move = emptySpots[Math.floor(Math.random() * emptySpots.length)];
    }

    sfx_poke(); gomokuBoard[move.y][move.x] = 2; gomokuStepCount++; gomokuLastMoveTime = Date.now(); drawGomoku();

    if(checkWin(move.x, move.y, 2)) { setTimeout(() => endGomoku('noah_win'), 500); return; }
    gomokuTurn = 1; drawGomoku();
}

function evaluateLine(x, y, role) {
    let score = 0; const dirs = [[1,0], [0,1], [1,1], [1,-1]];
    for(let d of dirs) {
        let count = 1, block = 0;
        for(let i=1; i<=4; i++) {
            let nx = x + d[0]*i, ny = y + d[1]*i;
            if(nx<0||nx>=15||ny<0||ny>=15) { block++; break; }
            if(gomokuBoard[ny][nx] === role) count++; else if(gomokuBoard[ny][nx] !== 0) { block++; break; } else break;
        }
        for(let i=1; i<=4; i++) {
            let nx = x - d[0]*i, ny = y - d[1]*i;
            if(nx<0||nx>=15||ny<0||ny>=15) { block++; break; }
            if(gomokuBoard[ny][nx] === role) count++; else if(gomokuBoard[ny][nx] !== 0) { block++; break; } else break;
        }
        if(count >= 5) return 100000;
        if(count === 4 && block === 0) score += 10000;
        if(count === 4 && block === 1) score += 1000;
        if(count === 3 && block === 0) score += 1000;
        if(count === 3 && block === 1) score += 100;
        if(count === 2 && block === 0) score += 10;
    }
    score += (7 - Math.abs(x - 7)) + (7 - Math.abs(y - 7)); // åå¥½ä¸­å¿ƒ
    return score;
}

function checkWin(x, y, role) {
    const dirs = [[1,0], [0,1], [1,1], [1,-1]];
    for(let d of dirs) {
        let count = 1;
        for(let i=1; i<=4; i++) { let nx = x+d[0]*i, ny = y+d[1]*i; if(nx>=0&&nx<15&&ny>=0&&ny<15 && gomokuBoard[ny][nx]===role) count++; else break; }
        for(let i=1; i<=4; i++) { let nx = x-d[0]*i, ny = y-d[1]*i; if(nx>=0&&nx<15&&ny>=0&&ny<15 && gomokuBoard[ny][nx]===role) count++; else break; }
        if(count >= 5) return true;
    }
    return false;
}

function endGomoku(result) {
    window.isGomoku = false; clearInterval(gomokuCheckInterval);
    document.getElementById('gomoku-canvas').style.display = 'none';
    document.getElementById('noah-canvas').style.display = 'block';
    
    if(result === 'player_win' || result === 'player_surrender_win') {
        noahWinCount = 0; noah.gold += 20; noah.love += 5; sfx_coin();
        if(result === 'player_win') speak("â€œå±…ç„¶èµ¢äº†æˆ‘ï¼Ÿâ€¦â€¦å’³ï¼Œä½ åˆ«å¾—æ„ï¼Œæˆ‘è¿™æ˜¯ä¸æƒ³çœ‹ä½ è¾“å¾—å¤ªéš¾çœ‹æ‰è®©ä½ çš„ã€‚æ‹¿ç€ä½ çš„ 20 åŠ éš†å»ä¹°ç³–åƒå§ã€‚â€");
    } else if(result === 'noah_win') {
        noahWinCount++; noah.mood += 10;
        if(noahWinCount >= 3) speak(`â€œåˆèµ¢äº†ï¼Ÿæˆ‘éƒ½è¿èµ¢ ${noahWinCount} å±€äº†ã€‚çœ‹ä½ è¿™å§”å±ˆçš„å°è„¸ï¼Œè¡Œå§ï¼Œä¸‹ä¸€å±€æˆ‘ç”¨å·¦æ‰‹è·Ÿä½ ä¸‹ã€‚â€`);
        else speak("â€œæˆ‘èµ¢äº†ã€‚ä½œä¸ºæƒ©ç½šï¼Œä»Šæ™šä½ è¦ä¹–ä¹–å¾…åœ¨æˆ‘æ€€é‡Œï¼Œå“ªéƒ½ä¸è®¸å»ã€‚â€");
    }
    updateUI();
}
// ==========================================================
// ==================== å­˜æ¡£ç®¡ç†ç³»ç»Ÿ (æ–°å¢) ====================

// 1. å¯¼å‡ºå­˜æ¡£ï¼šç”Ÿæˆä¸€ä¸²åŠ å¯†ä»£ç 
function exportSaveData() {
    try {
        // è·å–å½“å‰çš„è¯ºäºšæ•°æ®
        const dataToSave = JSON.stringify(noah);
        // ä½¿ç”¨ Base64 + URI ç¼–ç å¤„ç†ä¸­æ–‡ï¼Œç”Ÿæˆå­˜æ¡£ç 
        const saveCode = btoa(encodeURIComponent(dataToSave));
        
        sfx_success(); // æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
        
        // å¼¹å‡ºè¾“å…¥æ¡†è®©ç”¨æˆ·å¤åˆ¶
        prompt("è¯·å…¨é€‰å¹¶å¤åˆ¶ä¸‹é¢çš„å­˜æ¡£ä»£ç ï¼ˆåŒ…å«åŠ éš†ã€è¡£æœã€å¥½æ„Ÿåº¦ç­‰æ‰€æœ‰æ•°æ®ï¼‰ï¼š", saveCode);
        
        speak("â€œä½ è¦æŠŠæˆ‘çš„è®°å¿†å¤‡ä»½å¸¦èµ°å—ï¼Ÿä¿å­˜å¥½ï¼Œåˆ«æŠŠæˆ‘å¼„ä¸¢äº†ã€‚â€");
    } catch (e) {
        sfx_error();
        alert("å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§ã€‚");
    }
}

// 2. å¯¼å…¥å­˜æ¡£ï¼šè¯»å–ä»£ç å¹¶è¦†ç›–å½“å‰æ•°æ®
function importSaveData() {
    const saveCode = prompt("è¯·ç²˜è´´ä½ ä¹‹å‰ä¿å­˜çš„å­˜æ¡£ä»£ç ï¼š");
    
    if (!saveCode) return; // å¦‚æœç‚¹å‡»å–æ¶ˆåˆ™é€€å‡º

    try {
        // è§£ç å­˜æ¡£
        const jsonString = decodeURIComponent(atob(saveCode));
        const loadedData = JSON.parse(jsonString);

        // ç®€å•çš„æ ¼å¼æ ¡éªŒï¼Œé˜²æ­¢ä¹±å¡«
        if (loadedData.hunger !== undefined && loadedData.love !== undefined && loadedData.gold !== undefined) {
            
            // ç¡®è®¤è¦†ç›–
            if(confirm("è­¦å‘Šï¼šè¿™å°†è¦†ç›–ä½ å½“å‰çš„è¿›åº¦ï¼ˆåŠ éš†ã€è¡£æœç­‰ï¼‰ã€‚ç¡®å®šè¦è¯»å–æ—§çš„è®°å¿†å—ï¼Ÿ")) {
                noah = loadedData;
                
                // å…¼å®¹æ€§æ£€æŸ¥ï¼šé˜²æ­¢æ—§å­˜æ¡£æ²¡æœ‰è¡£æœæ•°æ®å¯¼è‡´æŠ¥é”™
                if (!noah.unlockedOutfits) noah.unlockedOutfits = ['none'];
                if (!noah.outfit) noah.outfit = 'none';
                
                // å¼ºåˆ¶ä¿å­˜åˆ°æœ¬åœ°å¹¶åˆ·æ–°é¡µé¢ä»¥ç”Ÿæ•ˆ
                localStorage.setItem('noah_save_data_v1', JSON.stringify(noah));
                
                sfx_success();
                alert("å­˜æ¡£å¯¼å…¥æˆåŠŸï¼æ­£åœ¨é‡å¡‘ä¸–ç•Œçº¿...");
                location.reload(); // åˆ·æ–°é¡µé¢é‡ç½®æ‰€æœ‰çŠ¶æ€
            }
        } else {
            throw new Error("Invalid Data");
        }
    } catch (e) {
        sfx_error();
        speak("â€œè¿™æ®µä»£ç ä¸æ˜¯æˆ‘çš„è®°å¿†...ä½ æ˜¯ä¸æ˜¯å¤åˆ¶é”™äº†ï¼Ÿâ€");
        alert("å­˜æ¡£ä»£ç æ— æ•ˆæˆ–æ ¼å¼é”™è¯¯ï¼è¯·ç¡®è®¤å¤åˆ¶å®Œæ•´äº†ã€‚");
    }
}
</script>
</body>
</html>
